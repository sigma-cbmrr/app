<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Conferência</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif;
background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box;
}
        .container { background-color: #fff; padding: 20px; border-radius: 10px;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box;
}
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold;
} 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px;
border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666;
margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333;
text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee;
}

        /* SETORES E ITENS */
        .setor-header { background-color: #800020;
color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between;
align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;
}
        .setor-info { display: flex; align-items: center; gap: 10px;
}
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px;
border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e;
}
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden;
transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0;
} .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px;
}
        .arrow { font-size: 1.2em; transition: transform 0.4s;
}

        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px;
padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease;
}
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0;
}
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0;
}
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1;
}
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD;
} 

        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start;
margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1;
margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em;
color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold;
font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px;
vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none;
} .status-icon.ok:after { content: '✓'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center;
}
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A';
font-size: 10px; line-height: 18px; color: white; display: block; text-align: center;
}

        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px;
border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px;
border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s;
background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e;
} .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }

        /* ESTILOS PENDÊNCIAS */
        .pendencia-alert-box { font-size: 0.85em;
margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s;
}
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd;
}
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9;
}

        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0;
}
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left;
line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none;
}

        .texto-admin { font-weight: bold; color: #0d47a1;
}
        .linha-obs { color: #333; font-weight: 500;
}

        .pendencia-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;
border-top: 1px dotted #ccc; padding-top: 5px; }
        .btn-manter { background-color: #e0e0e0;
border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px;
} 
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333;
font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        .historico-fixo { background-color: #eeeeee;
border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none;
}
        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left;
padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;
}
        .tombamento-options { display: flex; gap: 5px;
} .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0;
}
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23;
display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block;
margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%;
padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px;
}
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none;
padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em;
}
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px;
border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px;
}

        #btn-finalizar { background-color: #d90f23; color: white; font-weight: bold; border: none;
padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease; margin-top: 30px; font-size: 1.1em;
box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4); }
        #btn-finalizar:disabled { background-color: #999;
cursor: not-allowed; box-shadow: none; }

        .draft-badge { background-color: #fff3cd; color: #856404;
border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none;
}
    </style>
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Conferência de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><strong>Rascunho recuperado:</strong> Você está continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Inicializando sistema...</div>
        <div id="main-content" style="display: none;">
            <button id="btn-finalizar" onclick="finalizarConferencia()" disabled>FINALIZAR CONFERÊNCIA 
(0/X ITENS)</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const LISTA_ID = urlParams.get('id'); 
        const COLECAO_LISTAS = 'listas_conferencia';
let dadosConferencia = []; let infoLocal = { nome: '', posto: '' }; window.itemStatus = {};
function getUrlParameter(n) { return (new URLSearchParams(window.location.search)).get(n) || ''; }
        const userInfo = { postoGraduacao: getUrlParameter('posto_grad') ||
"ND", quadro: getUrlParameter('quadro_mil') || "ND", nomeGuerra: getUrlParameter('nome_guerra') || "ND" };
function formatarDataSimples(timestamp) {
            if (!timestamp) return "";
const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR');
}

        function updateHeaderInfo() { 
            const el = document.getElementById('militar-info');
if(el) el.innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`; 
        }

        function updateOverallStatus() { 
            let total = 0, completed = 0;
document.querySelectorAll('.setor').forEach(s => { 
                total += parseInt(s.dataset.totalItems || 0); 
                completed += parseInt(s.querySelector('.setor-status').dataset.completed || 0); 
            });
const btn = document.getElementById('btn-finalizar'); 
            if(btn) {
                btn.textContent = `FINALIZAR CONFERÊNCIA (${completed}/${total} ITENS)`;
if (total > 0 && completed >= total) {
                    btn.disabled = false;
btn.style.backgroundColor = '#1b8a3e'; 
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
btn.style.backgroundColor = '#d90f23'; 
                    btn.style.cursor = 'not-allowed';
                }
            }
        }

        function updateSetorStatus(setorEl) { 
            const items = setorEl.querySelectorAll('.item-conferencia');
let completed = 0, total = 0; 
            items.forEach(item => { 
                if (item.dataset.type === 'single') { 
                    total++; const s = window.itemStatus[item.dataset.id]?.status; 
                    if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
            
} else { 
                    const tombs = item.querySelectorAll('.tombamento-container'); 
                    tombs.forEach(t => { 
                        total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                 
if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                    }); 
                } 
            });
setorEl.dataset.totalItems = total; 
            const st = setorEl.querySelector('.setor-status'); 
            st.dataset.completed = completed;
if (completed === total && total > 0) { st.textContent = 'OK'; st.classList.add('ok');
} 
            else { st.textContent = `${completed}/${total}`; st.classList.remove('ok');
} 
        }

        function updateItemMainStatusDisplay(item) { 
            if (item.dataset.type === 'single') return;
const tombs = item.querySelectorAll('.tombamento-container'); let conf = 0, alt = 0;
tombs.forEach(t => { 
                const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                if (s === 'S/A' || s === 'C/A' || s === 'KEEP') { conf++; if (s === 'C/A' || s === 'KEEP') alt++; } 
            });
const icon = item.querySelector('.status-icon'); item.className = 'item-conferencia item-has-tombamentos'; icon.className = 'status-icon';
if (conf === tombs.length) { 
                if (alt > 0) { icon.classList.add('alert');
item.classList.add('status-alert'); } 
                else { icon.classList.add('ok');
item.classList.add('status-ok'); } 
            } 
        }

        function toggleSetor(header) { 
            const content = header.nextElementSibling;
const arrow = header.querySelector('.arrow'); 
            if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '►';
} 
            else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='►';}); content.classList.add('expanded');
arrow.textContent = '▼'; } 
        }

        function checkSetorCompletion(currentSetor, currentItemId) { 
            const total = parseInt(currentSetor.dataset.totalItems);
const comp = parseInt(currentSetor.querySelector('.setor-status').dataset.completed); 
            if (comp >= total) { autoAdvanceSetor(currentSetor.dataset.id); } else { focusNextItem(currentItemId);
}
        }

        function focusNextItem(currentItemId) { 
            const allItems = Array.from(document.querySelectorAll('.item-conferencia'));
let baseId = currentItemId.split('-')[0]; 
            const idx = allItems.findIndex(i => i.dataset.id === baseId);
for (let i = idx; i < allItems.length; i++) { 
                const item = allItems[i];
if (!item) continue; const id = item.dataset.id; 
                if (item.dataset.type === 'single') { 
                    const st = window.itemStatus[id];
if (!st || st.status === 'pending' || st.status === 'PENDING_CA') { 
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
if (st && st.status === 'PENDING_CA') item.querySelector('textarea').focus(); return; 
                    } 
                } 
                if (item.dataset.type === 'multi') { 
                    const pendingTomb = Array.from(item.querySelectorAll('.tombamento-container')).find(t => { 
                        const uid = 
`${id}-${t.dataset.tomb}`; const s = window.itemStatus[uid]?.status; return s === 'pending' || s === 'PENDING_CA'; 
                    });
if (pendingTomb) { 
                        pendingTomb.scrollIntoView({ behavior: 'smooth', block: 'center' });
const uid = `${id}-${pendingTomb.dataset.tomb}`; 
                        if (window.itemStatus[uid]?.status === 'PENDING_CA') pendingTomb.querySelector('textarea').focus(); return;
} 
                } 
            } 
        }

        function autoAdvanceSetor(sid) { 
            const s = document.querySelector(`.setor[data-id="${sid}"]`);
if (s) toggleSetor(s.querySelector('.setor-header')); 
            const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1];
if (nextId) { 
                const next = document.querySelector(`.setor[data-id="${nextId}"]`);
if (next) { const h = next.querySelector('.setor-header'); toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' });
} 
            } 
        }
        function isElementInViewport(el) { const rect = el.getBoundingClientRect();
return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth));
}
        function getStorageKey() { return `sigma_draft_${LISTA_ID}_${userInfo.nomeGuerra}`;
}
        function salvarRascunho() { try { localStorage.setItem(getStorageKey(), JSON.stringify({ timestamp: Date.now(), status: window.itemStatus }));
} catch (e) {} }
        function limparRascunho() { try { localStorage.removeItem(getStorageKey());
} catch (e) {} }

        const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            // [CORREÇÃO DE ESTABILIDADE] Adiciona verificação para evitar falha ao carregar pendencia.obs nula
            [span_0](start_span)if (!textoBruto || textoBruto.trim() === '') { //[span_0](end_span)
                // Se não há texto bruto, retorna um array vazio.
                return []; 
            }
            const linhas = [];
if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`); [span_1](start_span)//[span_1](end_span)
            const separator = ' | + NOVA: '; [span_2](start_span)//[span_2](end_span)
[span_3](start_span)if (textoBruto.includes(separator)) { //[span_3](end_span)
                const partes = textoBruto.split(separator); [span_4](start_span)//[span_4](end_span)
[span_5](start_span)partes.forEach(p => { //[span_5](end_span)
                    p = p.trim(); [span_6](start_span)//[span_6](end_span)
                    const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; [span_7](start_span)//[span_7](end_span)
                    const match = p.match(regex); [span_8](start_span)//[span_8](end_span)
                    if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`); [span_9](start_span)//[span_9](end_span)
                   
else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`); [span_10](start_span)//[span_10](end_span)
                });
[span_11](start_span)} else { //[span_11](end_span)
                // Caso seja uma única observação (nova ou legacy)
                const p = textoBruto.trim(); [span_12](start_span)//[span_12](end_span)
                const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; [span_13](start_span)//[span_13](end_span)
                const match = p.match(regex); [span_14](start_span)//[span_14](end_span)
                // Se já estiver carimbada (vinda de um KEEP), usa o carimbo.
                if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`); [span_15](start_span)//[span_15](end_span)
                // Senão, usa os dados do conferente atual como fallback para visualização.
                else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`); [span_16](start_span)//[span_16](end_span)
            }
            return linhas; [span_17](start_span)//[span_17](end_span)
};
        const gerarHtmlVisual = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            // [CORREÇÃO DE ESTABILIDADE] Adiciona verificação para evitar falha ao carregar pendencia.obs nula
            [span_18](start_span)if (!textoBruto || textoBruto.trim() === '') { //[span_18](end_span)
                return ''; [span_19](start_span)//[span_19](end_span)
            }
            const linhas = gerarLinhasFormatadas(textoBruto, autorAtual, dataAtual, adminStatus, adminObs); [span_20](start_span)//[span_20](end_span)
let html = '<ul class="lista-pendencias">'; [span_21](start_span)//[span_21](end_span)
            linhas.forEach(l => { if (l.includes('(Admin):')) { const parts = l.split('): '); [span_22](start_span)//[span_22](end_span)
html += `<li><span class="texto-admin">⚠️ ${parts[0]}):</span> Resp: ${parts[1]}</li>`; } else { html += `<li class="linha-obs">• ${l}</li>`; } }); [span_23](start_span)//[span_23](end_span)
            html += '</ul>'; [span_24](start_span)//[span_24](end_span)
return html; [span_25](start_span)//[span_25](end_span)
        };
        const montarHistoricoLinear = (obsAnterior, novoTexto, autorAnterior, dataAnterior) => {
            const separator = ' |
+ NOVA: '; [span_26](start_span)//[span_26](end_span)
            // Se o obsAnterior já contém o separador, é um histórico que está sendo acrescentado.
            [span_27](start_span)if (obsAnterior && obsAnterior.includes(separator)) { //[span_27](end_span)
                let partes = obsAnterior.split(separator); [span_28](start_span)//[span_28](end_span)
let ultimaParte = partes.pop(); let resto = partes.join(separator); let ultimaAssinada = `"${ultimaParte}" (Por: ${autorAnterior} em ${dataAnterior})`; return `${resto}${separator}${ultimaAssinada}${separator}${novoTexto}`; [span_29](start_span)//[span_29](end_span)
            // Se obsAnterior existe, mas não tem o separador, é a primeira adição ao histórico.
            [span_30](start_span)} else if (obsAnterior) { //[span_30](end_span)
                let anteriorAssinado = `"${obsAnterior}" (Por: ${autorAnterior} em ${dataAnterior})`; return `${anteriorAssinado}${separator}${novoTexto}`; [span_31](start_span)//[span_31](end_span)
            }
            // Se obsAnterior for nula ou vazia, retorna apenas o novo texto (é o primeiro item)
            return novoTexto; 
        };

        function renderizarConferencia() {
            const mainContent = document.getElementById('main-content'); [span_32](start_span)//[span_32](end_span)
const antigos = mainContent.querySelectorAll('.setor'); antigos.forEach(el => el.remove()); [span_33](start_span)//[span_33](end_span)
            let htmlSetores = ''; const setorIds = []; dadosConferencia.forEach(s => setorIds.push(s.id)); [span_34](start_span)//[span_34](end_span)
window.setorIds = setorIds; [span_35](start_span)//[span_35](end_span)

            dadosConferencia.forEach((setor, index) => {
                const isFirstSetor = (index === 0); let htmlItens = ''; let totalItensNoSetor = 0;
                setor.itens.forEach(item => {
                    const montarPendenciaHtml = (uid, pendenciaObj) => {
                     
[span_36](start_span)if (!pendenciaObj) return ''; //[span_36](end_span)
                        const obs = pendenciaObj.obs ? pendenciaObj.obs.replace(/'/g, "\\'") : ''; const quem = pendenciaObj.quem || 'Anônimo'; const dataPend = formatarDataSimples(pendenciaObj.data); [span_37](start_span)//[span_37](end_span)
                        const dadosHistorico = JSON.stringify({ obs: obs, autor: quem, data: dataPend }); const safeHistorico = encodeURIComponent(dadosHistorico); [span_38](start_span)//[span_38](end_span)
              
const htmlFormatado = gerarHtmlVisual(obs, quem, dataPend, pendenciaObj.statusAdmin, pendenciaObj.adminObs); [span_39](start_span)//[span_39](end_span)
                        let classAdmin = pendenciaObj.statusAdmin ? "admin-reply" : "";
                        return `<div class="pendencia-alert-box ${classAdmin}">${htmlFormatado}<div class="pendencia-actions"><button class="btn-manter" onclick="manterPendencia(this, '${uid}')">✅ Concordo (Manter)</button><button class="btn-acrescentar" onclick="acrescentarPendencia(this, '${uid}', '${safeHistorico}')">➕ Acrescentar</button></div></div>`; [span_40](start_span)//[span_40](end_span)
};
                    if (item.tipo === 'multi' && item.tombamentos) {
                        let htmlTombamentos = '';
[span_41](start_span)item.tombamentos.forEach(tomb => { //[span_41](end_span)
                            const uid = `${item.id}-${tomb.tomb}`; const pendenciaHtml = montarPendenciaHtml(uid, tomb.pendencia); [span_42](start_span)//[span_42](end_span)
                            htmlTombamentos += `<div class="tombamento-container" data-tomb="${tomb.tomb}" data-item-id="${item.id}"><div class="tombamento-controls"><span>Tomb.: ${tomb.tomb}</span><div class="tombamento-options"><button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button></div></div>${pendenciaHtml}<p class="tombamento-descricao-salva"></p><div class="tombamento-obs-container"><div class="historico-fixo" style="display:none;"></div><label>Descreva a alteração:</label><textarea placeholder="Detalhe a alteração."></textarea><button type="button" class="btn-salvar-alteracao" onclick="salvarTombamento(this)">SALVAR OBSERVAÇÃO</button></div></div>`; [span_43](start_span)//[span_43](end_span)
     
totalItensNoSetor++; [span_44](start_span)//[span_44](end_span)
window.itemStatus[uid] = { status: 'pending', obs: '' }; [span_45](start_span)//[span_45](end_span)
                        });
                        htmlItens += `<div class="item-conferencia item-has-tombamentos" data-type="multi" data-total-tombamentos="${item.tombamentos.length}" data-status="pending" data-id="${item.id}"><div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span><span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span></div>${htmlTombamentos}</div>`; [span_46](start_span)//[span_46](end_span)
} else {
                        let classExtra = '';
if (item.pendencia) { if (item.pendencia.statusAdmin) classExtra = 'status-admin-response'; else classExtra = 'status-existing-alert'; [span_47](start_span)//[span_47](end_span)
}
                        const pendenciaHtml = montarPendenciaHtml(item.id, item.pendencia); [span_48](start_span)//[span_48](end_span)
htmlItens += `<div class="item-conferencia ${classExtra}" data-type="single" data-status="pending" data-id="${item.id}"><div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span><span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span></div><div class="item-options"><button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button></div>${pendenciaHtml}<p class="descricao-salva"></p><div class="alteracao-container"><div class="historico-fixo" style="display:none;"></div><label>Descreva a alteração:</label><textarea data-id="${item.id}" placeholder="Descreva a alteração."></textarea><button type="button" class="btn-salvar-alteracao" onclick="salvarItem(this)">SALVAR</button></div></div>`; [span_49](start_span)//[span_49](end_span)
totalItensNoSetor++; window.itemStatus[item.id] = { status: 'pending', obs: '' }; [span_50](start_span)//[span_50](end_span)
                    }
                });
const expandedClass = isFirstSetor ? 'expanded' : ''; const arrowChar = isFirstSetor ? '▼' : '►'; [span_51](start_span)//[span_51](end_span)
htmlSetores += `<div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id}"><div class="setor-header" onclick="toggleSetor(this)"><div class="setor-info"><span>${setor.nome}</span><div class="setor-status" data-completed="0">0/${totalItensNoSetor}</div></div><span class="arrow">${arrowChar}</span></div><div class="setor-content ${expandedClass}">${htmlItens}</div></div>`; [span_52](start_span)//[span_52](end_span)
            });
            mainContent.querySelector('#btn-finalizar').insertAdjacentHTML('beforebegin', htmlSetores);
            updateOverallStatus(); [span_53](start_span)//[span_53](end_span)
}

        function setItemStatus(btn, status) { 
            const item = btn.closest('.item-conferencia'); [span_54](start_span)//[span_54](end_span)
const setor = btn.closest('.setor'); [span_55](start_span)//[span_55](end_span)
            item.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); [span_56](start_span)//[span_56](end_span)
            item.querySelector('.descricao-salva').style.display='none'; item.querySelector('.alteracao-container').style.display='none'; [span_57](start_span)//[span_57](end_span)
            const pb=item.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if(status==='ok'){item.className='item-conferencia status-ok'; item.querySelector('.status-icon').className='status-icon ok'; [span_58](start_span)//[span_58](end_span)
[span_59](start_span)window.itemStatus[item.dataset.id]={status:'S/A',obs:''};} //[span_59](end_span)
            else {item.className='item-conferencia status-alert'; item.querySelector('.status-icon').className='status-icon alert'; item.querySelector('.alteracao-container').style.display='block'; window.itemStatus[item.dataset.id]={status:'PENDING_CA',obs:''}; [span_60](start_span)//[span_60](end_span)
[span_61](start_span)item.querySelector('textarea').focus();} //[span_61](end_span)
            salvarRascunho(); updateSetorStatus(setor); updateOverallStatus(); if(status==='ok')checkSetorCompletion(setor,item.dataset.id); [span_62](start_span)//[span_62](end_span)
}

        function setTombamentoStatus(btn, status) { 
            const tomb = btn.closest('.tombamento-container'); [span_63](start_span)//[span_63](end_span)
const item = btn.closest('.item-conferencia'); const setor = btn.closest('.setor'); const uid=`${item.dataset.id}-${tomb.dataset.tomb}`; [span_64](start_span)//[span_64](end_span)
            tomb.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); [span_65](start_span)//[span_65](end_span)
            tomb.querySelector('.tombamento-obs-container').style.display='none'; tomb.querySelector('.tombamento-descricao-salva').style.display='none'; [span_66](start_span)//[span_66](end_span)
            const pb=tomb.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if(status==='ok'){window.itemStatus[uid]={status:'S/A',obs:''}; [span_67](start_span)//[span_67](end_span)
[span_68](start_span)updateItemMainStatusDisplay(item);} //[span_68](end_span)
            else {tomb.querySelector('.tombamento-obs-container').style.display='block'; window.itemStatus[uid]={status:'PENDING_CA',obs:''}; tomb.querySelector('textarea').focus(); [span_69](start_span)//[span_69](end_span)
[span_70](start_span)updateItemMainStatusDisplay(item);} //[span_70](end_span)
            salvarRascunho(); updateSetorStatus(setor); updateOverallStatus(); if(status==='ok')checkSetorCompletion(setor,item.dataset.id); [span_71](start_span)//[span_71](end_span)
}

        function manterPendencia(btn, uid) { 
            const box = btn.closest('.pendencia-alert-box'); [span_72](start_span)//[span_72](end_span)
if(box) { 
                box.querySelector('.pendencia-actions').style.display='none'; box.classList.add('kept'); [span_73](start_span)//[span_73](end_span)
box.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e;font-weight:bold;font-size:0.9em;margin-top:5px;border-top:1px dashed #ccc;padding-top:3px;">✔ Mantido</div>'); [span_74](start_span)//[span_74](end_span)
                window.itemStatus[uid]={status:'KEEP',obs:''}; salvarRascunho(); 
                const c = box.closest('.tombamento-container')||box.closest('.item-conferencia'); 
                const btnCA=c.querySelector('.ca-alert'); if(btnCA)btnCA.classList.add('active'); 
                const item = c.classList.contains('item-conferencia')?c:c.closest('.item-conferencia'); 
                if(c.classList.contains('tombamento-container'))updateItemMainStatusDisplay(item);
const setor=c.closest('.setor'); updateSetorStatus(setor); updateOverallStatus(); checkSetorCompletion(setor, item.dataset.id); [span_75](start_span)//[span_75](end_span)
            } 
        }

        function acrescentarPendencia(btn, uid, encodedData) { 
            const box = btn.closest('.pendencia-alert-box'); [span_76](start_span)//[span_76](end_span)
const container = box.closest('.tombamento-container')||box.closest('.item-conferencia'); box.style.display='none'; [span_77](start_span)//[span_77](end_span)
            if(container){ 
                const btnCA=container.querySelector('.ca-alert'); [span_78](start_span)//[span_78](end_span)
[span_79](start_span)if(btnCA){btnCA.classList.add('active'); container.querySelector('.sa-ok').classList.remove('active');} //[span_79](end_span)
                const edit=container.querySelector('.tombamento-obs-container')||container.querySelector('.alteracao-container'); [span_80](start_span)//[span_80](end_span)
edit.style.display='block'; [span_81](start_span)//[span_81](end_span)
                const hist=edit.querySelector('.historico-fixo'); hist.dataset.meta=encodedData; hist.style.display='none'; 
                edit.querySelector('textarea').value=''; edit.querySelector('textarea').focus(); window.itemStatus[uid]={status:'PENDING_CA',obs:''}; salvarRascunho(); 
            } 
        }

        function salvarItem(btn) { 
            const item=btn.closest('.item-conferencia'); [span_82](start_span)//[span_82](end_span)
const obs=item.querySelector('textarea').value.trim(); const hist=item.querySelector('.historico-fixo'); [span_83](start_span)//[span_83](end_span)
            let final=obs; if(hist&&hist.dataset.meta){if(obs.length<3)return alert("Digite a alteração."); const meta=JSON.parse(decodeURIComponent(hist.dataset.meta)); [span_84](start_span)//[span_84](end_span)
[span_85](start_span)final=montarHistoricoLinear(meta.obs,obs,meta.autor,meta.data);} else {if(obs.length<3)return alert("Descreva.");} //[span_85](end_span)
            window.itemStatus[item.dataset.id]={status:'C/A',obs:final}; item.querySelector('.alteracao-container').style.display='none'; [span_86](start_span)//[span_86](end_span)
            const d=item.querySelector('.descricao-salva'); [span_87](start_span)//[span_87](end_span)
const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`; const now=formatarDataSimples(new Date()); [span_88](start_span)//[span_88](end_span)
            d.innerHTML=gerarHtmlVisual(final,conf,now,null,null); d.style.display='block'; salvarRascunho(); [span_89](start_span)//[span_89](end_span)
            updateSetorStatus(btn.closest('.setor')); updateOverallStatus(); checkSetorCompletion(btn.closest('.setor'), item.dataset.id); [span_90](start_span)//[span_90](end_span)
}

        function salvarTombamento(btn) { 
            const tomb=btn.closest('.tombamento-container'); [span_91](start_span)//[span_91](end_span)
const item=btn.closest('.item-conferencia'); const obs=tomb.querySelector('textarea').value.trim(); const hist=tomb.querySelector('.historico-fixo'); [span_92](start_span)//[span_92](end_span)
            let final=obs; if(hist&&hist.dataset.meta){if(obs.length<3)return alert("Digite a alteração."); const meta=JSON.parse(decodeURIComponent(hist.dataset.meta)); [span_93](start_span)//[span_93](end_span)
[span_94](start_span)final=montarHistoricoLinear(meta.obs,obs,meta.autor,meta.data);} else {if(obs.length<3)return alert("Descreva.");} //[span_94](end_span)
            window.itemStatus[`${item.dataset.id}-${tomb.dataset.tomb}`]={status:'C/A',obs:final}; tomb.querySelector('.tombamento-obs-container').style.display='none'; [span_95](start_span)//[span_95](end_span)
            const d=tomb.querySelector('.tombamento-descricao-salva'); [span_96](start_span)//[span_96](end_span)
const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`; const now=formatarDataSimples(new Date()); [span_97](start_span)//[span_97](end_span)
            d.innerHTML=gerarHtmlVisual(final,conf,now,null,null); d.style.display='block'; salvarRascunho(); [span_98](start_span)//[span_98](end_span)
            updateItemMainStatusDisplay(item); updateSetorStatus(btn.closest('.setor')); updateOverallStatus(); checkSetorCompletion(btn.closest('.setor'), item.dataset.id); [span_99](start_span)//[span_99](end_span)
}

        function restaurarRascunho() {
            const saved = localStorage.getItem(getStorageKey()); [span_100](start_span)//[span_100](end_span)
if (!saved) return; [span_101](start_span)//[span_101](end_span)
            try {
                const parsed = JSON.parse(saved); [span_102](start_span)//[span_102](end_span)
window.itemStatus = parsed.status; [span_103](start_span)//[span_103](end_span)
                document.getElementById('draft-message').style.display = 'block';
                Object.keys(window.itemStatus).forEach(uid => {
                    const st = window.itemStatus[uid]; let container, isTombamento=false;
                    container = document.querySelector(`.item-conferencia[data-id="${uid}"]`);
                    if (!container) {
                      
[span_104](start_span)const allTombs = document.querySelectorAll('.tombamento-container'); //[span_104](end_span)
                        for (let t of allTombs) { if (`${t.closest('.item-conferencia').dataset.id}-${t.dataset.tomb}` === uid) { container = t; isTombamento = true; break; [span_105](start_span)} } //[span_105](end_span)
                    }
                    if (container) {
          
const btnSA=container.querySelector('.sa-ok'), btnCA=container.querySelector('.ca-alert'); [span_106](start_span)//[span_106](end_span)
                        if(btnSA)btnSA.classList.remove('active'); if(btnCA)btnCA.classList.remove('active');
                        const descEl = container.querySelector('.descricao-salva') || container.querySelector('.tombamento-descricao-salva');

                        if (st.status === 'S/A') { if(btnSA)btnSA.classList.add('active'); [span_107](start_span)//[span_107](end_span)
if(!isTombamento) container.querySelector('.status-icon').className='status-icon ok'; [span_108](start_span)} //[span_108](end_span)
                        else if (st.status === 'C/A' || st.status === 'KEEP') { 
                            if(btnCA)btnCA.classList.add('active'); [span_109](start_span)//[span_109](end_span)
if(!isTombamento) container.querySelector('.status-icon').className='status-icon alert'; [span_110](start_span)//[span_110](end_span)
                            if(descEl && st.status === 'C/A') {
                                const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`; [span_111](start_span)//[span_111](end_span)
const now=formatarDataSimples(new Date()); [span_112](start_span)//[span_112](end_span)
                                descEl.innerHTML=gerarHtmlVisual(st.obs,conf,now,null,null); 
                                descEl.style.display='block';
                                const pendBox = container.querySelector('.pendencia-alert-box'); if(pendBox) pendBox.style.display = 'none';
[span_113](start_span)} else if(st.status === 'KEEP') { //[span_113](end_span)
                                const pendBox = container.querySelector('.pendencia-alert-box'); [span_114](start_span)//[span_114](end_span)
[span_115](start_span)if(pendBox) { //[span_115](end_span)
                                    pendBox.classList.add('kept'); [span_116](start_span)//[span_116](end_span)
pendBox.querySelector('.pendencia-actions').style.display='none'; [span_117](start_span)//[span_117](end_span)
                                    if(!pendBox.innerHTML.includes('✔ Mantido')) pendBox.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e;font-weight:bold;font-size:0.9em;margin-top:5px;border-top:1px dashed #ccc;padding-top:3px;">✔ Mantido</div>');
                                }
                            }
                        }
                        else if (st.status === 'PENDING_CA') {
          
const edit = container.querySelector('.tombamento-obs-container')||container.querySelector('.alteracao-container'); [span_118](start_span)//[span_118](end_span)
if(edit) edit.style.display='block'; [span_119](start_span)//[span_119](end_span)
                            if(btnCA) btnCA.classList.add('active');
                        }
                        if(isTombamento) updateItemMainStatusDisplay(container.closest('.item-conferencia')); [span_120](start_span)//[span_120](end_span)
}
                });
                document.querySelectorAll('.setor').forEach(s => updateSetorStatus(s)); [span_121](start_span)//[span_121](end_span)
updateOverallStatus(); [span_122](start_span)//[span_122](end_span)
            } catch (e) { console.error("Erro restore", e); }
        }

        async function carregarDadosRemotos() {
            if (!LISTA_ID) { document.getElementById('loading-message').innerHTML = "<span style='color:red'>Erro: ID não encontrado.</span>"; [span_123](start_span)//[span_123](end_span)
return; [span_124](start_span)} //[span_124](end_span)
            document.getElementById('loading-message').innerHTML = "Conectando..."; [span_125](start_span)//[span_125](end_span)
try {
                const doc = await db.collection(COLECAO_LISTAS).doc(LISTA_ID).get(); [span_126](start_span)//[span_126](end_span)
if (!doc.exists) throw new Error("Lista não encontrada."); [span_127](start_span)//[span_127](end_span)
                const data = doc.data(); dadosConferencia = data.list || []; [span_128](start_span)//[span_128](end_span)
infoLocal = { nome: data.nome_local || "DESCONHECIDO", posto: data.posto || "Geral" }; [span_129](start_span)//[span_129](end_span)
                document.getElementById('local-posto-info').innerHTML = `<span style="color:blue;font-weight:bold">${infoLocal.posto} - ${infoLocal.nome}</span>`; [span_130](start_span)//[span_130](end_span)
document.title = `Conferência - ${infoLocal.posto} ${infoLocal.nome}`; [span_131](start_span)//[span_131](end_span)
                document.getElementById('loading-message').innerHTML = "Renderizando...";
                renderizarConferencia(); updateHeaderInfo(); updateOverallStatus(); restaurarRascunho(); [span_132](start_span)//[span_132](end_span)
                document.getElementById('loading-message').style.display='none'; document.getElementById('main-content').style.display='block'; [span_133](start_span)//[span_133](end_span)
} catch (e) { document.getElementById('loading-message').innerHTML = "Erro: " + e.message; [span_134](start_span)//[span_134](end_span)
}
        }

        async function finalizarConferencia() {
            const btn = document.getElementById('btn-finalizar'); [span_135](start_span)//[span_135](end_span)
if (btn.disabled) return; [span_136](start_span)//[span_136](end_span)
            btn.textContent = "Salvando..."; [span_137](start_span)//[span_137](end_span)
            btn.disabled = true; [span_138](start_span)//[span_138](end_span)
            
            try {
                const p = userInfo; [span_139](start_span)//[span_139](end_span)
const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`; [span_140](start_span)//[span_140](end_span)
                const localNome = `${infoLocal.posto} - ${infoLocal.nome}`; [span_141](start_span)//[span_141](end_span)
const clean = (val) => val === undefined ? null : val; [span_142](start_span)//[span_142](end_span)
                
                let updated = false; [span_143](start_span)//[span_143](end_span)
                let itensRelatorio = []; [span_144](start_span)//[span_144](end_span)
let itensCaa = []; [span_145](start_span)//[span_145](end_span)
                let itemsCount = 0; [span_146](start_span)//[span_146](end_span)
let cA_count = 0; [span_147](start_span)//[span_147](end_span)

                // Função de Processamento Unificada (Substitui o loop incompleto e a função atualizarListaDB)
                [span_148](start_span)const processItem = (id, nome, pend) => { //[span_148](end_span)
                    const s = window.itemStatus[id]; [span_149](start_span)//[span_149](end_span)
                    if(!s) return; [span_150](start_span)//[span_150](end_span)

                    // 1. Encontra o Item ou Tombamento que será atualizado na lista principal
                    let itemOuTomb; [span_151](start_span)//[span_151](end_span)
                    let setorItem = dadosConferencia.find(s => s.itens.some(i => i.id === id.split('-')[0])); [span_152](start_span)//[span_152](end_span)
                    
                    [span_153](start_span)if (setorItem) { //[span_153](end_span)
                        let item = setorItem.itens.find(i => i.id === id.split('-')[0]); [span_154](start_span)//[span_154](end_span)
                        [span_155](start_span)if (item.tipo === 'multi' && item.tombamentos) { //[span_155](end_span)
                            itemOuTomb = item.tombamentos.find(t => `${item.id}-${t.tomb}` === id); [span_156](start_span)//[span_156](end_span)
                        } else {
                            itemOuTomb = item; [span_157](start_span)//[span_157](end_span)
                        }
                    }
                    if (!itemOuTomb) return; [span_158](start_span)//[span_158](end_span)
                    
                    itemsCount++; [span_159](start_span)// Conta todos os itens conferidos[span_159](end_span)
                    
                    // 2. Determina o Status Final e o Histórico de Observações
                    let finalStatus = s.status; [span_160](start_span)//[span_160](end_span)
let oldPend = pend || {}; [span_161](start_span)//[span_161](end_span)
                    let finalObs = null; [span_162](start_span)//[span_162](end_span)
                    
                    [span_163](start_span)// Variável para armazenar o autor da última alteração (para o carimbo)[span_163](end_span)
                    const autorCarimbo = oldPend.quem || conferente; [span_164](start_span)//[span_164](end_span)
                    const dataCarimbo = oldPend.data ? formatarDataSimples(oldPend.data) : formatarDataSimples(firebase.firestore.Timestamp.now()); [span_165](start_span)//[span_165](end_span)

                    // 3. ATUALIZA A PENDÊNCIA (LISTA PRINCIPAL)
                    if (finalStatus === 'C/A' || finalStatus === 'KEEP') {
                        
                        [span_166](start_span)// CORREÇÃO CRÍTICA: Monta a string de histórico completo.[span_166](end_span)
                        [span_167](start_span)// Isso garante o carimbo padronizado e a concatenação.[span_167](end_span)
                        finalObs = montarHistoricoLinear(
                            oldPend.obs || '', // Histórico anterior (vazio se novo C/A)
                            s.obs, // Nova observação
                            autorCarimbo, // Autor da última alteração
                    
                    [span_168](start_span)dataCarimbo // Data da última alteração[span_168](end_span)
                        );
                        [span_169](start_span)// Atualiza o objeto de pendência do item/tombamento (Persistência)[span_169](end_span)
                        itemOuTomb.pendencia = { 
                            [span_170](start_span)obs: finalObs, // <-- HISTÓRICO COMPLETO[span_170](end_span)
                            quem: conferente, 
                            data: firebase.firestore.Timestamp.now(), 
            
                            [span_171](start_span)statusAdmin: clean(oldPend.statusAdmin), //[span_171](end_span)
                            adminObs: clean(oldPend.adminObs) 
                        };
                        updated = true; [span_172](start_span)//[span_172](end_span)
                        cA_count++;
                    } else if (finalStatus === 'S/A' && itemOuTomb.pendencia) { 
                        [span_173](start_span)// Remove pendência se foi marcada S/A[span_173](end_span)
                        delete itemOuTomb.pendencia; [span_174](start_span)//[span_174](end_span)
updated=true; [span_175](start_span)//[span_175](end_span)
                    }

                    // 4. CONSTRÓI O OBJETO DE RELATÓRIO (itensRelatorio/itensCaa)
                    const dadosItem = { 
                        [span_176](start_span)nomeCompleto: nome, //[span_176](end_span)
                        status: finalStatus, 
                        obs: finalObs || s.obs || [span_177](start_span)'', // Garante que a observação seja a string de histórico[span_177](end_span)
                        quantidade: itemOuTomb.quantidadeEsperada || [span_178](start_span)1, //[span_178](end_span)
                        id: id,
                        statusAdmin: clean(oldPend.statusAdmin), 
                        adminObs: clean(oldPend.adminObs),
                        setor: setorItem.nome
                    };
                    itensRelatorio.push(dadosItem); [span_179](start_span)//[span_179](end_span)
                    if (finalStatus === 'C/A' || finalStatus === 'KEEP') itensCaa.push(dadosItem); [span_180](start_span)//[span_180](end_span)
                };

                [span_181](start_span)// === LOOP PRINCIPAL COM AS CHAMADAS CORRIGIDAS ===[span_181](end_span)
                dadosConferencia.forEach(setor => {
                    setor.itens.forEach(item => {
                        if (item.tipo === 'multi' && item.tombamentos) {
                            item.tombamentos.forEach(t => processItem(`${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`, t.pendencia));
                        } else {
   
                    [span_182](start_span)processItem(item.id, item.nome, item.pendencia); //[span_182](end_span)
                        }
                    });
                });
                [span_183](start_span)// === FIM DO LOOP PRINCIPAL ===[span_183](end_span)

                // [CÓDIGO DE SALVAMENTO ORIGINAL]
                if(updated) await db.collection(COLECAO_LISTAS).doc(LISTA_ID).update({ list: dadosConferencia }); [span_184](start_span)//[span_184](end_span)
await db.collection('resultados_conferencias').add({ local: localNome, lista_id: LISTA_ID, conferente, timestamp: firebase.firestore.Timestamp.now(), totalItensConferidos: itemsCount, totalCaa: cA_count, itensCaa, itensRelatorio }); [span_185](start_span)//[span_185](end_span)

                limparRascunho(); [span_186](start_span)//[span_186](end_span)
window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*'); [span_187](start_span)//[span_187](end_span)
                if (window.self === window.top) { alert("Salvo! Redirecionando..."); window.location.href = "operacional.html"; [span_188](start_span)//[span_188](end_span)
[span_189](start_span)} //[span_189](end_span)

            } catch (e) { 
                console.error(e); [span_190](start_span)//[span_190](end_span)
alert("Erro: " + e.message); [span_191](start_span)//[span_191](end_span)
                btn.disabled = false; 
            }
        }

        window.onload = carregarDadosRemotos;
</script>
</body>
</html>