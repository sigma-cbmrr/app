<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Conferência</title>
    <style>
        /* ESTILOS GERAIS */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box; }
        .main-header { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background-color: #800020; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 100; display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; }
        .header-icon { height: 40px; width: auto; vertical-align: middle; }
        .header-title-desktop, .header-title-mobile { font-weight: bold; font-size: 1.1em; line-height: 1.2; margin-left: 10px; }
        .text-white { color: white; } .text-red { color: #FF3B3B; } .header-title-desktop { display: none; } .header-title-mobile { display: block; }
        @media (min-width: 768px) { .header-title-desktop { display: block; font-size: 1.2em; } .header-title-mobile { display: none; } }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold; } 
        .logo { width: 80px; height: auto; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333; text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        
        .setor-header { background-color: #800020; color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s; }
        .setor-info { display: flex; align-items: center; gap: 10px; }
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px; border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e; }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .arrow { font-size: 1.2em; transition: transform 0.4s; }
        
        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease; }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0; }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0; }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1; }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD; } 
        
        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        
        .status-icon { font-weight: bold; font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '✓'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center; }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A'; font-size: 10px; line-height: 18px; color: white; display: block; text-align: center; }
        
        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e; } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        /* ESTILOS PENDÊNCIAS */
        .pendencia-alert-box { font-size: 0.85em; margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s; }
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd; }
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9; }
        
        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0; }
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left; line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none; }
        
        .texto-admin { font-weight: bold; color: #0d47a1; }
        .linha-obs { color: #333; font-weight: 500; }
        
        .pendencia-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px; }
        .btn-manter { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; } .btn-manter:hover { background-color: #1b8a3e; color: white; }
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; } .btn-acrescentar:hover { background-color: #d90f23; color: white; }

        /* ÁREA DE HISTÓRICO TRAVADA */
        .historico-fixo { background-color: #eeeeee; border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none; }
        .historico-fixo::before { content: "Histórico (Não editável): "; font-weight: bold; color: #888; display: block; font-size: 0.8em; }

        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left; padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .tombamento-options { display: flex; gap: 5px; } .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23; display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block; margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px; }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em; }
        
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px; border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px; }
        .obs-texto { color: #d90f23; font-weight: bold; } .obs-titulo { color: #333; font-weight: bold; }
        
        #btn-finalizar { background-color: #d90f23; color: white; font-weight: bold; border: none; padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease; margin-top: 30px; font-size: 1.1em; box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4); }
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; }
        
        .footer-central { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 5px 0 5px; background-color: #f4f4f9; color: #555; font-size: 0.65em; line-height: 1.3; z-index: 99; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); }
        .footer-central strong, .footer-autor { display: block; width: 100%; text-align: center; } .footer-central strong { font-weight: bold; } .footer-autor { margin-top: 5px; color: #888; font-size: 0.9em; }
        
        /* Badge de rascunho recuperado */
        .draft-badge { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none; }
    </style>
</head>
<body>
    <header class="main-header"><img src="cbmrr.png" alt="CBM-RR" class="header-icon" onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=CBM'"><div class="header-title-desktop"><span class="text-white">CORPO DE BOMBEIROS MILITAR </span><span class="text-red">RORAIMA</span></div><div class="header-title-mobile"><span class="text-white">CBM</span><span class="text-red">RR</span></div></header>
    <div class="container">
        <img id="logo-sigma" src="logo_sigma.png" alt="Logo do Sistema SIGMA" class="logo" onerror="this.onerror=null; this.src='https://placehold.co/80x80/d90f23/ffffff?text=SIGMA'">
        <h1 id="titulo-conferencia">Conferência de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><i class="fas fa-history"></i> <strong>Rascunho recuperado:</strong> Você está continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Buscando lista...</div>
        <div id="main-content" style="display: none;"><button id="btn-finalizar" onclick="finalizarConferencia()" disabled>FINALIZAR CONFERÊNCIA (0/X ITENS)</button></div>
    </div>
    <div class="footer-central"><strong>GOVERNO DE RORAIMA</strong><strong>CORPO DE BOMBEIROS MILITAR DE RORAIMA</strong><em>“Amazônia: patrimônio dos brasileiros”</em><br><span class="footer-autor">Elaborado por: 3º SGT QPCBM JHONATH</span></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        
        const urlParams = new URLSearchParams(window.location.search);
        const LISTA_ID = urlParams.get('id'); 
        let db; const COLECAO_LISTAS = 'listas_conferencia'; 
        let dadosConferencia = []; let infoLocal = { nome: '', posto: '' }; window.itemStatus = {};

        // --- 1. FUNÇÕES UTILITÁRIAS ---
        function getUrlParameter(n) { return (new URLSearchParams(window.location.search)).get(n) || ''; }
        
        const userInfo = { 
            postoGraduacao: getUrlParameter('posto_grad') || "ND", 
            quadro: getUrlParameter('quadro_mil') || "ND", 
            nomeGuerra: getUrlParameter('nome_guerra') || "ND" 
        };

        function formatarDataSimples(timestamp) {
            if (!timestamp) return "";
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR'); 
        }

        function updateHeaderInfo() { 
            document.getElementById('militar-info').innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`; 
        }

        function updateOverallStatus() { 
            let total = 0, completed = 0; 
            document.querySelectorAll('.setor').forEach(s => { 
                total += parseInt(s.dataset.totalItems); 
                completed += parseInt(s.querySelector('.setor-status').dataset.completed); 
            }); 
            const btn = document.getElementById('btn-finalizar'); 
            btn.textContent = `FINALIZAR CONFERÊNCIA (${completed}/${total} ITENS)`; 
            btn.disabled = (completed !== total); 
        }

        // --- 2. LÓGICA DO RASCUNHO (LOCAL STORAGE) ---
        function getStorageKey() {
            return `sigma_draft_${LISTA_ID}_${userInfo.nomeGuerra}`;
        }

        function salvarRascunho() {
            try {
                const key = getStorageKey();
                const data = JSON.stringify({ timestamp: Date.now(), status: window.itemStatus });
                localStorage.setItem(key, data);
            } catch (e) { console.error("Erro rascunho", e); }
        }

        function limparRascunho() {
            try { localStorage.removeItem(getStorageKey()); } catch (e) { console.error("Erro limpar", e); }
        }

        // --- 3. FORMATAÇÃO UNIFICADA ---
        const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            const linhas = [];
            if (adminStatus) {
                linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
            }

            const separator = ' | + NOVA: ';
            if (textoBruto.includes(separator)) {
                const partes = textoBruto.split(separator);
                partes.forEach(p => {
                    p = p.trim();
                    const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
                    const match = p.match(regex);
                    if (match) {
                        linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
                    } else {
                        linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
                    }
                });
            } else {
                const p = textoBruto.trim();
                const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
                const match = p.match(regex);
                if (match) {
                     linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
                } else {
                     linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
                }
            }
            return linhas;
        };

        const gerarHtmlVisual = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            const linhas = gerarLinhasFormatadas(textoBruto, autorAtual, dataAtual, adminStatus, adminObs);
            let html = '<ul class="lista-pendencias">';
            linhas.forEach(l => {
                if (l.includes('(Admin):')) {
                    const parts = l.split('): ');
                    html += `<li><span class="texto-admin">⚠️ ${parts[0]}):</span> Resp: ${parts[1]}</li>`;
                } else {
                    html += `<li class="linha-obs">• ${l}</li>`;
                }
            });
            html += '</ul>';
            return html;
        };
        
        const montarHistoricoLinear = (obsAnterior, novoTexto, autorAnterior, dataAnterior) => {
            const separator = ' | + NOVA: ';
            let novoHistorico = "";
            if (obsAnterior.includes(separator)) {
                let partes = obsAnterior.split(separator);
                let ultimaParte = partes.pop(); 
                let resto = partes.join(separator); 
                let ultimaAssinada = `"${ultimaParte}" (Por: ${autorAnterior} em ${dataAnterior})`;
                novoHistorico = `${resto}${separator}${ultimaAssinada}${separator}${novoTexto}`;
            } else {
                let anteriorAssinado = `"${obsAnterior}" (Por: ${autorAnterior} em ${dataAnterior})`;
                novoHistorico = `${anteriorAssinado}${separator}${novoTexto}`;
            }
            return novoHistorico;
        };

        // --- 4. RESTAURAÇÃO DE RASCUNHO ---
        function restaurarRascunho() {
            const key = getStorageKey();
            const saved = localStorage.getItem(key);
            if (!saved) return;

            try {
                const parsed = JSON.parse(saved);
                window.itemStatus = parsed.status;
                document.getElementById('draft-message').style.display = 'block';

                Object.keys(window.itemStatus).forEach(uid => {
                    const st = window.itemStatus[uid];
                    let container;
                    let isTombamento = false;
                    
                    container = document.querySelector(`.item-conferencia[data-id="${uid}"]`);
                    if (!container) {
                        const allTombs = document.querySelectorAll('.tombamento-container');
                        for (let t of allTombs) {
                             const pItem = t.closest('.item-conferencia');
                             const checkId = `${pItem.dataset.id}-${t.dataset.tomb}`;
                             if (checkId === uid) { container = t; isTombamento = true; break; }
                        }
                    }

                    if (container) {
                        const btnSA = container.querySelector('.sa-ok');
                        const btnCA = container.querySelector('.ca-alert');
                        const descEl = container.querySelector('.descricao-salva') || container.querySelector('.tombamento-descricao-salva');
                        
                        if(btnSA) btnSA.classList.remove('active');
                        if(btnCA) btnCA.classList.remove('active');

                        if (st.status === 'S/A') {
                            if(btnSA) btnSA.classList.add('active');
                            if(!isTombamento) { container.className = 'item-conferencia status-ok'; container.querySelector('.status-icon').className = 'status-icon ok'; } 
                            else { updateItemMainStatusDisplay(container.closest('.item-conferencia')); }
                        } 
                        else if (st.status === 'C/A' || st.status === 'KEEP') {
                            if(btnCA) btnCA.classList.add('active');
                            if(!isTombamento) { container.className = 'item-conferencia status-alert'; container.querySelector('.status-icon').className = 'status-icon alert'; }
                            
                            if(descEl) {
                                const dataAgora = new Date().toLocaleDateString('pt-BR'); 
                                const conferente = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
                                
                                if (st.status === 'C/A') {
                                    descEl.innerHTML = gerarHtmlVisual(st.obs, conferente, dataAgora, null, null); 
                                    descEl.style.display = 'block';
                                    const pendBox = container.querySelector('.pendencia-alert-box');
                                    if(pendBox) pendBox.style.display = 'none';
                                } else if (st.status === 'KEEP') {
                                    const pendBox = container.querySelector('.pendencia-alert-box');
                                    if(pendBox) {
                                        pendBox.classList.add('kept');
                                        const actions = pendBox.querySelector('.pendencia-actions');
                                        if(actions) actions.style.display = 'none';
                                        if(!pendBox.innerHTML.includes('✔ Mantido')) { pendBox.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e; font-weight:bold; font-size:0.9em; margin-top:5px; border-top:1px dashed #ccc; padding-top:3px;">✔ Mantido</div>'); }
                                    }
                                }
                            }
                            if(isTombamento) updateItemMainStatusDisplay(container.closest('.item-conferencia'));
                        }
                        else if (st.status === 'PENDING_CA') {
                             const editArea = container.querySelector('.tombamento-obs-container') || container.querySelector('.alteracao-container');
                             if(editArea) editArea.style.display = 'block';
                             if(btnCA) btnCA.classList.add('active');
                        }
                    }
                });
                const setores = document.querySelectorAll('.setor');
                setores.forEach(s => updateSetorStatus(s));
                updateOverallStatus();
            } catch (e) { console.error("Erro restore", e); }
        }

        // --- 5. CARREGAMENTO INICIAL ---
        async function carregarDadosRemotos() {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            if (!LISTA_ID) { document.getElementById('loading-message').innerHTML = "<span style='color:red'>Erro: Nenhum local especificado no link.<br>Volte ao menu principal.</span>"; return; }
            try {
                const doc = await db.collection(COLECAO_LISTAS).doc(LISTA_ID).get();
                if (!doc.exists) throw new Error("Lista não encontrada.");
                const data = doc.data();
                dadosConferencia = data.list || [];
                infoLocal = { nome: data.nome_local || "DESCONHECIDO", posto: data.posto || "Geral" };
                document.getElementById('local-posto-info').innerHTML = `<span style="color:blue;font-weight:bold">${infoLocal.posto} - ${infoLocal.nome}</span>`;
                document.title = `Conferência - ${infoLocal.posto} ${infoLocal.nome}`;
                
                renderizarConferencia();
                updateHeaderInfo();
                restaurarRascunho();

                document.getElementById('loading-message').style.display='none'; 
                document.getElementById('main-content').style.display='block';
            } catch (e) { document.getElementById('loading-message').innerHTML = "Erro ao carregar: " + e.message; }
        }

        // --- 6. RENDERIZAÇÃO ---
        function renderizarConferencia() {
            const mainContent = document.getElementById('main-content');
            let htmlSetores = '';
            const setorIds = [];
            dadosConferencia.forEach(s => setorIds.push(s.id));
            window.setorIds = setorIds;

            dadosConferencia.forEach(setor => {
                let htmlItens = ''; let totalItensNoSetor = 0;
                const isFirstSetor = setor.id === setorIds[0];
                
                setor.itens.forEach(item => {
                    const montarPendenciaHtml = (uid, pendenciaObj) => {
                        if (!pendenciaObj) return '';
                        const obs = pendenciaObj.obs ? pendenciaObj.obs.replace(/'/g, "\\'") : '';
                        const quem = pendenciaObj.quem || 'Anônimo';
                        const dataPend = formatarDataSimples(pendenciaObj.data);
                        const dadosHistorico = JSON.stringify({ obs: obs, autor: quem, data: dataPend });
                        const safeHistorico = encodeURIComponent(dadosHistorico);
                        const htmlFormatado = gerarHtmlVisual(obs, quem, dataPend, pendenciaObj.statusAdmin, pendenciaObj.adminObs);
                        let classAdmin = pendenciaObj.statusAdmin ? "admin-reply" : "";
                        return `<div class="pendencia-alert-box ${classAdmin}">${htmlFormatado}<div class="pendencia-actions"><button class="btn-manter" onclick="manterPendencia(this, '${uid}')">✅ Concordo (Manter)</button><button class="btn-acrescentar" onclick="acrescentarPendencia(this, '${uid}', '${safeHistorico}')">➕ Acrescentar</button></div></div>`;
                    };
                    if (item.tipo === 'multi' && item.tombamentos) {
                        let htmlTombamentos = '';
                        item.tombamentos.forEach(tomb => {
                            const uid = `${item.id}-${tomb.tomb}`;
                            const pendenciaHtml = montarPendenciaHtml(uid, tomb.pendencia);
                            htmlTombamentos += `<div class="tombamento-container" data-tomb="${tomb.tomb}" data-item-id="${item.id}"><div class="tombamento-controls"><span>Tomb.: ${tomb.tomb}</span><div class="tombamento-options"><button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button></div></div>${pendenciaHtml}<p class="tombamento-descricao-salva"></p><div class="tombamento-obs-container"><div class="historico-fixo" style="display:none;"></div><label>Descreva a alteração:</label><textarea placeholder="Detalhe a alteração."></textarea><button type="button" class="btn-salvar-alteracao" onclick="salvarTombamento(this)">SALVAR OBSERVAÇÃO</button></div></div>`;
                            totalItensNoSetor++;
                            window.itemStatus[uid] = { status: 'pending', obs: '' };
                        });
                        htmlItens += `<div class="item-conferencia item-has-tombamentos" data-type="multi" data-total-tombamentos="${item.tombamentos.length}" data-status="pending" data-id="${item.id}"><div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span><span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span></div>${htmlTombamentos}</div>`;
                    } else {
                        let classExtra = '';
                        if (item.pendencia) {
                             if (item.pendencia.statusAdmin) classExtra = 'status-admin-response';
                             else classExtra = 'status-existing-alert';
                        }
                        const pendenciaHtml = montarPendenciaHtml(item.id, item.pendencia);
                        htmlItens += `<div class="item-conferencia ${classExtra}" data-type="single" data-status="pending" data-id="${item.id}"><div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span><span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span></div><div class="item-options"><button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button></div>${pendenciaHtml}<p class="descricao-salva"></p><div class="alteracao-container"><div class="historico-fixo" style="display:none;"></div><label>Descreva a alteração:</label><textarea data-id="${item.id}" placeholder="Descreva a alteração."></textarea><button type="button" class="btn-salvar-alteracao" onclick="salvarItem(this)">SALVAR</button></div></div>`;
                        totalItensNoSetor++;
                        window.itemStatus[item.id] = { status: 'pending', obs: '' };
                    }
                });
                htmlSetores += `<div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id}"><div class="setor-header" onclick="toggleSetor(this)"><div class="setor-info"><span>${setor.nome}</span><div class="setor-status" data-completed="0">0/${totalItensNoSetor}</div></div><span class="arrow">${isFirstSetor?'▼':'►'}</span></div><div class="setor-content ${isFirstSetor?'expanded':''}">${htmlItens}</div></div>`;
            });
            mainContent.querySelector('#btn-finalizar').insertAdjacentHTML('beforebegin', htmlSetores);
        }

        function toggleSetor(header) { const content = header.nextElementSibling; const arrow = header.querySelector('.arrow'); if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '►'; } else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='►'}); content.classList.add('expanded'); arrow.textContent = '▼'; } }
        function checkSetorCompletion(currentSetor, currentItemId) { const total = parseInt(currentSetor.dataset.totalItems); const comp = parseInt(currentSetor.querySelector('.setor-status').dataset.completed); if (comp === total) autoAdvanceSetor(currentSetor.dataset.id); else focusNextItem(currentItemId); }
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        function focusNextItem(currentItemId) { const allItems = Array.from(document.querySelectorAll('.item-conferencia')); let baseId = currentItemId.split('-')[0]; const idx = allItems.findIndex(i => i.dataset.id === baseId); for (let i = idx; i < allItems.length; i++) { const item = allItems[i]; if (!item) continue; const id = item.dataset.id; if (item.dataset.type === 'single') { const st = window.itemStatus[id]; if (!st || st.status === 'pending' || st.status === 'PENDING_CA') { if (!isElementInViewport(item)) item.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (st && st.status === 'PENDING_CA') item.querySelector('textarea').focus(); return; } } if (item.dataset.type === 'multi') { const pendingTomb = Array.from(item.querySelectorAll('.tombamento-container')).find(t => { const uid = `${id}-${t.dataset.tomb}`; const s = window.itemStatus[uid]?.status; return s === 'pending' || s === 'PENDING_CA'; }); if (pendingTomb) { if (!isElementInViewport(pendingTomb)) pendingTomb.scrollIntoView({ behavior: 'smooth', block: 'center' }); const uid = `${id}-${pendingTomb.dataset.tomb}`; if (window.itemStatus[uid]?.status === 'PENDING_CA') pendingTomb.querySelector('textarea').focus(); return; } } } }
        function autoAdvanceSetor(sid) { const s = document.querySelector(`.setor[data-id="${sid}"]`); if (s) toggleSetor(s.querySelector('.setor-header')); const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1]; if (nextId) { const next = document.querySelector(`.setor[data-id="${nextId}"]`); if (next) { const h = next.querySelector('.setor-header'); const c = next.querySelector('.setor-content'); if(!c.classList.contains('expanded')) toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' }); } } }

        function manterPendencia(btnElement, uid) {
            const box = btnElement.closest('.pendencia-alert-box');
            if(box) {
                const actions = box.querySelector('.pendencia-actions');
                if(actions) actions.style.display = 'none'; 
                box.classList.add('kept'); 
                box.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e; font-weight:bold; font-size:0.9em; margin-top:5px; border-top:1px dashed #ccc; padding-top:3px;">✔ Mantido</div>');

                window.itemStatus[uid] = { status: 'KEEP', obs: '' };
                salvarRascunho();
                
                const container = box.closest('.tombamento-container') || box.closest('.item-conferencia');
                const btnCA = container.querySelector('.ca-alert');
                if(btnCA) btnCA.classList.add('active');
                const item = container.classList.contains('item-conferencia') ? container : container.closest('.item-conferencia');
                if(container.classList.contains('tombamento-container')) updateItemMainStatusDisplay(item);
                const setor = container.closest('.setor'); 
                updateSetorStatus(setor); updateOverallStatus(); checkSetorCompletion(setor, item.dataset.id);
            }
        }

        function acrescentarPendencia(btnElement, uid, encodedData) {
            let container; 
            const alertBox = btnElement.closest('.pendencia-alert-box');
            if(alertBox) { container = alertBox.closest('.tombamento-container') || alertBox.closest('.item-conferencia'); alertBox.style.display = 'none'; }
            if (container) {
                const btnCA = container.querySelector('.ca-alert');
                if(btnCA) { btnCA.classList.add('active'); const btnSA = container.querySelector('.sa-ok'); if(btnSA) btnSA.classList.remove('active'); }
                const editArea = container.querySelector('.tombamento-obs-container') || container.querySelector('.alteracao-container');
                if(editArea) {
                    editArea.style.display = 'block';
                    const histDiv = editArea.querySelector('.historico-fixo');
                    if(histDiv) { histDiv.dataset.meta = encodedData; histDiv.style.display = 'none'; }
                    const textarea = editArea.querySelector('textarea');
                    if(textarea) { textarea.value = ""; textarea.placeholder = "Digite APENAS o acréscimo aqui..."; textarea.focus(); }
                    window.itemStatus[uid] = { status: 'PENDING_CA', obs: '' }; 
                    salvarRascunho();
                }
            }
        }

        function setItemStatus(button, status) { 
            const item = button.closest('.item-conferencia'); const setor = button.closest('.setor'); item.querySelectorAll('.item-options .action-button').forEach(b => b.classList.remove('active')); button.classList.add('active'); item.querySelector('.descricao-salva').style.display = 'none'; item.querySelector('.alteracao-container').style.display = 'none'; const pb=item.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if (status === 'ok') { item.className = 'item-conferencia status-ok'; item.querySelector('.status-icon').className = 'status-icon ok'; window.itemStatus[item.dataset.id] = { status: 'S/A', obs: '' }; } else { item.className = 'item-conferencia status-alert'; item.querySelector('.status-icon').className = 'status-icon alert'; item.querySelector('.alteracao-container').style.display = 'block'; window.itemStatus[item.dataset.id] = { status: 'PENDING_CA', obs: '' }; item.querySelector('textarea').focus(); } 
            salvarRascunho();
            updateSetorStatus(setor); updateOverallStatus(); if(status === 'ok') checkSetorCompletion(setor, item.dataset.id); 
        }

        function setTombamentoStatus(button, status) { 
            const tombEl = button.closest('.tombamento-container'); const item = button.closest('.item-conferencia'); const setor = button.closest('.setor'); const uid = `${item.dataset.id}-${tombEl.dataset.tomb}`; tombEl.querySelectorAll('.action-button').forEach(b => b.classList.remove('active')); button.classList.add('active'); tombEl.querySelector('.tombamento-obs-container').style.display = 'none'; tombEl.querySelector('.tombamento-descricao-salva').style.display = 'none'; const pb=tombEl.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if (status === 'ok') { window.itemStatus[uid] = { status: 'S/A', obs: '' }; updateItemMainStatusDisplay(item); } else { tombEl.querySelector('.tombamento-obs-container').style.display = 'block'; window.itemStatus[uid] = { status: 'PENDING_CA', obs: '' }; tombEl.querySelector('textarea').focus(); updateItemMainStatusDisplay(item); } 
            salvarRascunho();
            updateSetorStatus(setor); updateOverallStatus(); if(status === 'ok') checkSetorCompletion(setor, item.dataset.id); 
        }
        
        function salvarItem(button) { 
            const item = button.closest('.item-conferencia'); 
            const obs = item.querySelector('textarea').value.trim();
            const histFixo = item.querySelector('.historico-fixo');
            let obsFinal = obs;
            if(histFixo && histFixo.dataset.meta) {
                if(obs.length < 3) return alert("Digite a nova alteração.");
                const meta = JSON.parse(decodeURIComponent(histFixo.dataset.meta));
                obsFinal = montarHistoricoLinear(meta.obs, obs, meta.autor, meta.data);
            } else {
                if (obs.length < 3) return alert("Descreva a alteração.");
            }
            window.itemStatus[item.dataset.id] = { status: 'C/A', obs: obsFinal }; 
            item.querySelector('.alteracao-container').style.display = 'none'; 
            const d = item.querySelector('.descricao-salva'); 
            const conferente = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
            const dataAgora = formatarDataSimples(new Date());
            d.innerHTML = gerarHtmlVisual(obsFinal, conferente, dataAgora, null, null);
            d.style.display = 'block'; 
            salvarRascunho();
            updateSetorStatus(button.closest('.setor')); updateOverallStatus(); checkSetorCompletion(button.closest('.setor'), item.dataset.id); 
        }

        function salvarTombamento(button) { 
            const tombEl = button.closest('.tombamento-container'); 
            const item = button.closest('.item-conferencia'); 
            const obs = tombEl.querySelector('textarea').value.trim(); 
            const histFixo = tombEl.querySelector('.historico-fixo');
            let obsFinal = obs;
            if(histFixo && histFixo.dataset.meta) {
                if(obs.length < 3) return alert("Digite a nova alteração.");
                const meta = JSON.parse(decodeURIComponent(histFixo.dataset.meta));
                obsFinal = montarHistoricoLinear(meta.obs, obs, meta.autor, meta.data);
            } else {
                if (obs.length < 3) return alert("Descreva a alteração.");
            }
            window.itemStatus[`${item.dataset.id}-${tombEl.dataset.tomb}`] = { status: 'C/A', obs: obsFinal }; 
            tombEl.querySelector('.tombamento-obs-container').style.display = 'none'; 
            const d = tombEl.querySelector('.tombamento-descricao-salva'); 
            const conferente = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
            const dataAgora = formatarDataSimples(new Date());
            d.innerHTML = gerarHtmlVisual(obsFinal, conferente, dataAgora, null, null);
            d.style.display = 'block'; 
            salvarRascunho();
            updateItemMainStatusDisplay(item); updateSetorStatus(button.closest('.setor')); updateOverallStatus(); checkSetorCompletion(button.closest('.setor'), item.dataset.id); 
        }

        function updateItemMainStatusDisplay(item) { if (item.dataset.type === 'single') return; const tombs = item.querySelectorAll('.tombamento-container'); let conf = 0, alt = 0; tombs.forEach(t => { const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; if (s === 'S/A' || s === 'C/A' || s === 'KEEP') { conf++; if (s === 'C/A' || s === 'KEEP') alt++; } }); const icon = item.querySelector('.status-icon'); item.className = 'item-conferencia item-has-tombamentos'; icon.className = 'status-icon'; if (conf === tombs.length) { if (alt > 0) { icon.classList.add('alert'); item.classList.add('status-alert'); } else { icon.classList.add('ok'); item.classList.add('status-ok'); } } }
        function updateSetorStatus(setor) { const items = setor.querySelectorAll('.item-conferencia'); let completed = 0, altered = 0, total = 0; items.forEach(item => { if (item.dataset.type === 'single') { total++; const s = window.itemStatus[item.dataset.id]?.status; if (s === 'S/A') completed++; else if (s === 'C/A' || s === 'KEEP') { completed++; altered++; } } else { const tombs = item.querySelectorAll('.tombamento-container'); tombs.forEach(t => { total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; if (s === 'S/A') completed++; else if (s === 'C/A' || s === 'KEEP') { completed++; altered++; } }); } }); setor.dataset.totalItems = total; const st = setor.querySelector('.setor-status'); st.dataset.completed = completed; if (completed === total && altered === 0) { st.textContent = 'S/A'; st.classList.add('ok'); } else if (altered > 0) { st.textContent = `${altered} C/A`; st.classList.remove('ok'); } else { st.textContent = `${completed}/${total}`; st.classList.remove('ok'); } }

        async function finalizarConferencia() {
            const dataHora = new Date();
            const dataHoraStr = dataHora.toLocaleString('pt-BR');
            const btn = document.getElementById('btn-finalizar'); if (btn.disabled) return;
            btn.textContent = "Salvando..."; btn.disabled = true;
            try {
                const p = userInfo; const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
                const localNome = `${infoLocal.posto} - ${infoLocal.nome}`; 
                const clean = (val) => val === undefined ? null : val;

                let updated = false;
                
                const atualizarListaDB = (itemOuTomb, uid) => {
                    const s = window.itemStatus[uid];
                    if(!s) return;
                    
                    if(s.status === 'C/A') { 
                        let old = itemOuTomb.pendencia || {};
                        itemOuTomb.pendencia = { obs: s.obs, quem: conferente, data: firebase.firestore.Timestamp.now(), statusAdmin: clean(old.statusAdmin), adminObs: clean(old.adminObs) }; 
                        updated=true; 
                    } else if(s.status === 'S/A' && itemOuTomb.pendencia) { 
                        delete itemOuTomb.pendencia; updated=true; 
                    }
                };

                dadosConferencia.forEach(setor => {
                    setor.itens.forEach(item => {
                        if(item.tipo === 'single') atualizarListaDB(item, item.id);
                        else if(item.tombamentos) item.tombamentos.forEach(t => atualizarListaDB(t, `${item.id}-${t.tomb}`));
                    });
                });
                
                let itensCaa = []; let itemsCount = 0; let cA_count = 0; let tableData = [];
                const RED='#D90F23', GREEN='#1B8A3E';
                
                dadosConferencia.forEach(setor => {
                    tableData.push([{ content: setor.nome.toUpperCase(), colSpan: 4, styles: { fillColor: [128, 0, 32], textColor: 255, fontStyle: 'bold' } }]);
                    setor.itens.forEach(item => {
                        let itemsToProcess = [];
                        
                        const processItemData = (id, nome, originalPendencia, qtd) => {
                            const s = window.itemStatus[id];
                            if (s && s.status !== 'pending') {
                                let finalObs = s.obs; 
                                let statusFinal = s.status;
                                
                                let linhas = gerarLinhasFormatadas(
                                    statusFinal === 'KEEP' ? originalPendencia.obs : s.obs,
                                    statusFinal === 'KEEP' ? (originalPendencia.quem||'Anônimo') : conferente,
                                    statusFinal === 'KEEP' ? formatarDataSimples(originalPendencia.data) : dataHoraStr,
                                    originalPendencia ? originalPendencia.statusAdmin : null,
                                    originalPendencia ? originalPendencia.adminObs : null
                                );
                                
                                if (linhas.length > 0) { finalObs = linhas.map(l => `• ${l}`).join('\n'); }

                                itemsToProcess.push({ nomeCompleto: nome, status: statusFinal === 'KEEP' ? 'C/A' : statusFinal, obs: finalObs, quantidade: qtd, id: id });
                            }
                        };

                        if (item.tipo === 'multi' && item.tombamentos) {
                            item.tombamentos.forEach(t => processItemData(`${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`, t.pendencia, 1));
                        } else {
                            processItemData(item.id, item.nome, item.pendencia, item.quantidadeEsperada);
                        }

                        itemsToProcess.forEach(d => {
                            itemsCount++;
                            if (d.status === 'C/A') { cA_count++; itensCaa.push({...d, local: setor.nome}); }
                            tableData.push([ d.nomeCompleto, `QTD: ${d.quantidade}`, { content: d.status, styles: { fillColor: (d.status==='S/A'?GREEN:RED), textColor: 255 }, valign: 'middle' }, d.obs||'-' ]);
                        });
                    });
                });

                if(updated) await db.collection(COLECAO_LISTAS).doc(LISTA_ID).update({ list: dadosConferencia });
                
                await db.collection('resultados_conferencias').add({ local: localNome, lista_id: LISTA_ID, conferente, timestamp: firebase.firestore.Timestamp.now(), totalItensConferidos: itemsCount, totalCaa: cA_count, itensCaa });

                const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
                const MARGIN=14, PG_W=210, LOGO_S=15; 
                const logoDraw = (id, x) => { const el = document.getElementById(id) || document.querySelector(`img[src*="${id}"]`); if(el && el.src) { try { const c = document.createElement('canvas'); c.width=160; c.height=160; c.getContext('2d').drawImage(el,0,0,160,160); doc.addImage(c.toDataURL('image/png'), 'PNG', x, 10, LOGO_S, LOGO_S); } catch(e){} } };
                logoDraw('cbmrr', MARGIN); logoDraw('logo-sigma', PG_W-MARGIN-LOGO_S);

                doc.setFontSize(10); doc.setTextColor(51); doc.setFont('helvetica','bold'); doc.text('GOVERNO DE RORAIMA', PG_W/2, 15, {align:'center'}); doc.setTextColor(217,15,35); doc.text('CORPO DE BOMBEIROS MILITAR DE RORAIMA', PG_W/2, 20, {align:'center'}); doc.setTextColor(51); doc.setFont('helvetica','italic'); doc.text('"Amazônia: patrimônio dos brasileiros"', PG_W/2, 25, {align:'center'});
                doc.setFontSize(14); doc.setTextColor(0); doc.setFont('helvetica','bold'); doc.text("CONFERÊNCIA DE MATERIAIS", PG_W/2, 35, {align:'center'});
                doc.setFillColor(240, 240, 240); doc.setDrawColor(200, 200, 200); doc.roundedRect(MARGIN, 40, PG_W - (MARGIN*2), 25, 2, 2, 'FD');
                doc.setFontSize(10); doc.setTextColor(50);
                let y = 46; const X_LABEL = MARGIN + 5; const X_VAL = MARGIN + 30;
                doc.setFont('helvetica','bold'); doc.text('Local:', X_LABEL, y); doc.setFont('helvetica','normal'); doc.text(localNome, X_VAL, y); y+=6; 
                doc.setFont('helvetica','bold'); doc.text('Conferente:', X_LABEL, y); doc.setFont('helvetica','normal'); doc.text(conferente, X_VAL, y); y+=6; 
                doc.setFont('helvetica','bold'); doc.text('Data/Hora:', X_LABEL, y); doc.setFont('helvetica','normal'); doc.text(dataHora.toLocaleString(), X_VAL, y);
                doc.setFont('helvetica','bold'); doc.setTextColor(128, 0, 32); doc.text(`TOTAL: ${itemsCount} | C/A: ${cA_count}`, PG_W - MARGIN - 5, 46, {align:'right'});

                doc.autoTable({ startY: 70, body: tableData, theme: 'striped', styles: { fontSize: 8, halign: 'left', valign: 'middle', textColor: 51, cellPadding: 1.5 }, columnStyles: { 0:{cellWidth:70}, 1:{cellWidth:20,halign:'center'}, 2:{cellWidth:20,halign:'center'} } });
                
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150);
                    doc.text('SIGMA - Sistema Integrado de Gestão de Materiais', MARGIN, doc.internal.pageSize.height-10);
                    doc.text(`Pág. ${i} de ${totalPages}`, PG_W-MARGIN, doc.internal.pageSize.height-10, {align:'right'});
                }
                
                doc.save(`Conferencia_${localNome.replace(/[^a-zA-Z0-9]/g,'')}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                limparRascunho(); 
                alert("Salvo com sucesso!"); 
                // Redirecionamento Inteligente (Corrigido)
                const perfil = sessionStorage.getItem('sigma_user_perfil');
                if (perfil === 'admin' || perfil === 'gestor') {
                    window.location.href = "cci_dashboard.html";
                } else if (perfil === 'operacional') {
                    window.location.href = "operacional.html";
                } else {
                    window.location.href = "index.html";
                }
            } catch (e) { console.error(e); alert("Erro: " + e.message); btn.disabled = false; }
        }
        window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
