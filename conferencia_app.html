<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="sigma-comum.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box; }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold; } 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333; text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        
        /* SETORES E ITENS */
        .setor-header { background-color: #800020; color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s; }
        .setor-info { display: flex; align-items: center; gap: 10px; }
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px; border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e; }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .arrow { font-size: 1.2em; transition: transform 0.4s; }
        
        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease; }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0; }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0; }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1; }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD; } 
        
        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold; font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '‚úì'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center; }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A'; font-size: 10px; line-height: 18px; color: white; display: block; text-align: center; }
        
        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e; } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        /* ESTILOS PEND√äNCIAS */
        .pendencia-alert-box { font-size: 0.85em; margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s; }
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd; }
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9; }
        
        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0; }
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left; line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none; }
        
        .texto-admin { font-weight: bold; color: #0d47a1; }
        .linha-obs { color: #333; font-weight: 500; }
        .btn-manter, .btn-resolver { flex: 1; border: none; padding: 10px 5px; border-radius: 6px; font-weight: bold; text-transform: uppercase; font-size: 0.75em; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: filter 0.2s; }
        .btn-manter { background-color: #5d6d7e; color: white; }
        .pendencia-actions { display: flex; gap: 8px; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 8px; }
        .btn-manter:active, .btn-resolver:active { filter: brightness(1.2); }
        .btn-manter:hover { background-color: #34495e !important; }
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        span[onclick] { min-width: 35px; min-height: 35px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(0,0,0,0.02); }
        .btn-resolver { background-color: #1b8a3e; color: white; }
        .historico-fixo { background-color: #eeeeee; border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none; }
        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left; padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .tombamento-options { display: flex; gap: 5px; } .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23; display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block; margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px; }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em; }
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px; border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 20000; overflow-y: auto; }
        #btn-finalizar { background-color: #d90f23; color: white; font-weight: bold; border: none; padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease; margin-top: 30px; font-size: 1.1em; box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4); }
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; }
        
        .draft-badge { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Confer√™ncia de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><strong>Rascunho recuperado:</strong> Voc√™ est√° continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Inicializando sistema...</div>
        <div id="main-content" style="display: none;">
            <button id="btn-finalizar" onclick="finalizarConferencia()" disabled>
    FINALIZAR CONFER√äNCIA (0/X ITENS)
</button>
        </div>
    </div>
    <div id="modal-nova-pendencia" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 20000;">
    <div class="modal-content" style="background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); position: relative; border-top: 5px solid #d90f23; font-family: Arial, sans-serif;">
        
        <h2 id="modal-titulo-item" style="margin-top: 0; color: #800020; font-size: 1.3em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; text-align: left;">Relatar Altera√ß√£o</h2>
        <p id="modal-subtitulo-detalhe" style="font-size: 0.85em; color: #666; margin-bottom: 20px; text-align: left;"></p>

        <input type="hidden" id="modal-uid">
        <input type="hidden" id="modal-tipo">
        <input type="hidden" id="modal-acao-objetivo" value="incluir"> <div id="modal-grupo-qtd" style="display:none; margin-top: 15px; margin-bottom: 20px; padding: 12px; background: #fdf2f2; border-radius: 8px; border: 1px solid #ffdada;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="flex: 1;">
                    <label id="modal-label-qtd" style="display: block; font-weight: bold; font-size: 0.9em; color: #d90f23; font-family: sans-serif;">Quantidade Alterada:</label>
                    <small id="modal-info-max" style="display: block; color: #888; font-size: 0.75em; font-family: sans-serif;"></small>
                </div>
                <input type="number" id="modal-input-qtd" min="1" value="1" 
                       style="width: 80px; padding: 10px; border: 2px solid #d90f23; border-radius: 6px; box-sizing: border-box; font-size: 1.2em; text-align: center; font-weight: bold; background: white;">
            </div>
        </div>

        <div style="margin-top: 15px; text-align: left;">
            <label id="modal-label-obs" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;">Descri√ß√£o do Problema:</label>
            <textarea id="modal-input-obs" placeholder="Descreva o problema..." style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; min-height: 100px; resize: vertical; font-family: inherit;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" onclick="fecharModalPendencia()" style="flex: 1; background: #eee; border: 1px solid #ccc; color: #333; cursor: pointer; padding: 12px; border-radius: 6px; font-weight: bold;">Cancelar</button>
            <button id="modal-btn-confirmar" type="button" onclick="processarAcaoFinalModal()" style="flex: 2; background: #800020; color: white; border: none; cursor: pointer; padding: 12px; border-radius: 6px; font-weight: bold;">INCLUIR</button>
        </div>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", 
        authDomain: "sigma-cbmrr.firebaseapp.com", 
        projectId: "sigma-cbmrr", 
        storageBucket: "sigma-cbmrr.firebasestorage.app", 
        messagingSenderId: "378026276038", 
        appId: "1:378026276038:web:620dd6ff57501b1a8313c7" 
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const LISTA_ID = urlParams.get('id');
    const COLECAO_LISTAS = 'listas_conferencia';
    const COLECAO_CAUTELAS = 'cautelas_abertas';
    
    let MODO_OPERACAO = 'recebimento'; 
    let DESTINATARIO_DEVOLUCAO = null; 
    
    const CAUTELA_ID = urlParams.get('cautelaId');
    const modoParam = urlParams.get('modo');
    const USER_UID = urlParams.get('user_uid');

    if (modoParam === 'devolucao') {
        MODO_OPERACAO = 'devolucao';
        DESTINATARIO_DEVOLUCAO = urlParams.get('destinatarioDevolucao');
    } else if (modoParam === 'devolucao_final') {
        MODO_OPERACAO = 'devolucao_final';
    }

    let dadosConferencia = [];
    let isCautela = !!CAUTELA_ID;
    let infoLocal = { nome: '', posto: '' }; 
    window.itemStatus = {};

    function getUrlParameter(n) { 
        return (new URLSearchParams(window.location.search)).get(n) || ''; 
    }
    
    const userInfo = { 
        postoGraduacao: getUrlParameter('posto_grad') || "ND", 
        quadro: getUrlParameter('quadro_mil') || "ND", 
        nomeGuerra: getUrlParameter('nome_guerra') || "ND",
        uid: USER_UID || "ND"
    };

    function formatarDataSimples(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('pt-BR');
    }

    function updateHeaderInfo() {
        const el = document.getElementById('militar-info');
        if (el) { el.innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`;
        }
    }

    function updateOverallStatus() {
    const blocosConferencia = document.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]');
    const totalGeral = blocosConferencia.length;
    let concluidosGeral = 0;

    blocosConferencia.forEach(bloco => {
        const uid = bloco.getAttribute('data-tomb') 
            ? `${bloco.closest('.item-conferencia').getAttribute('data-id')}-${bloco.getAttribute('data-tomb')}`
            : bloco.getAttribute('data-id');

        // MELHORIA AQUI: Verifica se existe status E se ele n√£o √© pendente
        const registro = window.itemStatus[uid];
        if (registro && registro.status && registro.status !== 'pending') {
            concluidosGeral++;
        }
    });

    const btn = document.getElementById('btn-finalizar');
    if (btn) {
        let buttonPrefix = MODO_OPERACAO === 'devolucao' ? 'FINALIZAR DEVOLU√á√ÉO' : 'FINALIZAR CONFER√äNCIA';
        btn.textContent = `${buttonPrefix} (${concluidosGeral}/${totalGeral} ITENS)`;

        if (totalGeral > 0 && concluidosGeral >= totalGeral) {
            btn.disabled = false;
            btn.style.backgroundColor = '#1b8a3e';
            btn.style.cursor = 'pointer';
            btn.style.opacity = '1';
        } else {
            btn.disabled = true;
            btn.style.backgroundColor = '#d90f23';
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.6';
        }
    }

    // Sincroniza setores
    document.querySelectorAll('.setor').forEach(s => {
        const itensSetor = s.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]');
        let setorComp = 0;
        itensSetor.forEach(i => {
            const iUid = i.getAttribute('data-tomb') 
                ? `${i.closest('.item-conferencia').getAttribute('data-id')}-${i.getAttribute('data-tomb')}`
                : i.getAttribute('data-id');
            const reg = window.itemStatus[iUid];
            if (reg && reg.status && reg.status !== 'pending') setorComp++;
        });
        const statusDiv = s.querySelector('.setor-status');
        if (statusDiv) {
            statusDiv.innerText = `${setorComp}/${itensSetor.length}`;
            statusDiv.dataset.completed = setorComp;
        }
    });
}

        function updateSetorStatus(setorEl) { 
            const items = setorEl.querySelectorAll('.item-conferencia'); 
            let completed = 0, total = 0; 
            items.forEach(item => { 
                if (item.dataset.type === 'single') { 
                    total++; const s = window.itemStatus[item.dataset.id]?.status; 
                    if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                } else { 
                    const tombs = item.querySelectorAll('.tombamento-container'); 
                    tombs.forEach(t => { 
                        total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                        if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                    }); 
                } 
            }); 
            setorEl.dataset.totalItems = total; 
            const st = setorEl.querySelector('.setor-status'); 
            st.dataset.completed = completed; 
            if (completed === total && total > 0) { st.textContent = 'OK'; st.classList.add('ok'); } 
            else { st.textContent = `${completed}/${total}`; st.classList.remove('ok'); } 
        }

        function updateItemMainStatusDisplay(item) { 
    if (item.dataset.type === 'single') return; 
    const tombs = item.querySelectorAll('.tombamento-container'); 
    let conf = 0, alt = 0; 

    tombs.forEach(t => { 
        const uidOriginal = `${item.dataset.id}-${t.dataset.tomb}`;
        const uidCautela = `CAUTELA-${uidOriginal}`; // O novo endere√ßo que criamos

        const s = window.itemStatus[uidOriginal]?.status; 
        const sCautela = window.itemStatus[uidCautela]?.status; // Busca a ci√™ncia isolada

        // Agora validamos: o tombamento est√° conferido se estiver S/A, C/A, KEEP OU se tiver Ciente da Cautela
        if (s === 'S/A' || s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente') { 
            conf++; 
            // Se for altera√ß√£o f√≠sica (C/A/KEEP) ou cautela ativa, conta como alerta visual (laranja/vermelho)
            if (s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente') alt++; 
        } 
    }); 

    const icon = item.querySelector('.status-icon'); 
    item.className = 'item-conferencia item-has-tombamentos'; 
    icon.className = 'status-icon'; 

    if (conf === tombs.length) { 
        if (alt > 0) { 
            icon.classList.add('alert'); 
            item.classList.add('status-alert'); 
        } else { 
            icon.classList.add('ok'); 
            item.classList.add('status-ok'); 
        } 
    } 
}

        function toggleSetor(header) { 
            const content = header.nextElementSibling; const arrow = header.querySelector('.arrow'); 
            if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '‚ñ∫'; } 
            else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='‚ñ∫';}); content.classList.add('expanded'); arrow.textContent = '‚ñº'; } 
        }

        function checkSetorCompletion(currentSetor, currentItemId) {
    if (!currentSetor) return;

    // 1. Contagem de progresso (Mantive sua l√≥gica que est√° correta)
    const blocosConferencia = currentSetor.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]');
    const total = blocosConferencia.length;
    let concluidos = 0;

    blocosConferencia.forEach(bloco => {
        let uid = bloco.classList.contains('tombamento-container') 
            ? `${bloco.closest('.item-conferencia').getAttribute('data-id')}-${bloco.getAttribute('data-tomb')}`
            : bloco.getAttribute('data-id');

        if (window.itemStatus[uid] && window.itemStatus[uid].status !== 'pending') {
            concluidos++;
        }
    });

    const statusDiv = currentSetor.querySelector('.setor-status');
    if (statusDiv) {
        statusDiv.innerText = `${concluidos}/${total}`;
        statusDiv.dataset.completed = concluidos;
    }

    // 2. L√ìGICA DE FOCO INTELIGENTE
    if (concluidos === total && total > 0) {
        // Se o setor fechou, avan√ßa para o pr√≥ximo setor
        setTimeout(() => {
            autoAdvanceSetor(currentSetor.dataset.id);
        }, 300);
    } else {
        // Se ainda h√° itens, busca o PR√ìXIMO ITEM PENDENTE na p√°gina inteira
        const todosAlvos = Array.from(document.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]'));
        
        // Encontra a posi√ß√£o do item que acabamos de conferir
        const indexAtual = todosAlvos.findIndex(el => {
            const id = el.classList.contains('tombamento-container') 
                ? `${el.closest('.item-conferencia').getAttribute('data-id')}-${el.getAttribute('data-tomb')}`
                : el.getAttribute('data-id');
            return id === currentItemId;
        });

        // Procura o primeiro item com status 'pending' que venha DEPOIS do atual
        const proximoAlvo = todosAlvos.slice(indexAtual + 1).find(el => {
            const id = el.classList.contains('tombamento-container') 
                ? `${el.closest('.item-conferencia').getAttribute('data-id')}-${el.getAttribute('data-tomb')}`
                : el.getAttribute('data-id');
            return !window.itemStatus[id] || window.itemStatus[id].status === 'pending';
        });

        if (proximoAlvo) {
            setTimeout(() => {
                // block: 'center' garante que o item fique no meio da tela
                proximoAlvo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Feedback visual sutil (borda tempor√°ria) para guiar o olho do conferente
                proximoAlvo.style.transition = "box-shadow 0.3s";
                proximoAlvo.style.boxShadow = "0 0 10px rgba(27, 138, 62, 0.5)";
                setTimeout(() => proximoAlvo.style.boxShadow = "none", 800);
            }, 300);
        }
    }
}
        function injetarCautelasNaLista() {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    // Aqui simulamos a leitura da sua cole√ß√£o cautelas_abertas
    // No seu c√≥digo real, voc√™ deve garantir que window.cautelasAbertas contenha os itens que voc√™ me enviou
    const cautelas = window.cautelasAbertas || []; 

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            cautelas.forEach(cautelaDoc => {
                cautelaDoc.itens.forEach(itemCautelado => {
                    // Se o ID base coincide (Ex: 56911524-64012364)
                    if (item.id === itemCautelado.id_base) {
                        
                        if (item.tipo === 'multi' && item.tombamentos) {
                            // Procura o tombamento espec√≠fico (Ex: 511.524 ou 511.527)
                            const t = item.tombamentos.find(tomb => tomb.tomb === itemCautelado.tombamento);
                            if (t) {
                                t.cautela = {
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: 1,
                                    id_cautela: cautelaDoc.cautela_id
                                };
                            }
                        } else if (item.tipo === 'single') {
                            if (!item.cautelas) item.cautelas = [];
                            // Evita duplicados
                            if (!item.cautelas.find(c => c.id_cautela === cautelaDoc.cautela_id)) {
                                item.cautelas.push({
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: itemCautelado.quantidade,
                                    id_cautela: cautelaDoc.cautela_id
                                });
                            }
                        }
                    }
                });
            });
        });
    });
}

        function autoAdvanceSetor(sid) { 
            const s = document.querySelector(`.setor[data-id="${sid}"]`); 
            if (s) toggleSetor(s.querySelector('.setor-header')); 
            const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1]; 
            if (nextId) { 
                const next = document.querySelector(`.setor[data-id="${nextId}"]`); 
                if (next) { const h = next.querySelector('.setor-header'); toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' }); } 
            } 
        }
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        
        
        function limparRascunho() {
            localStorage.removeItem('sigma_active_conf');
            const listId = CAUTELA_ID || LISTA_ID; // Pega o ID da lista ou cautela
            const userId = (userInfo && userInfo.nomeGuerra) 
            ? userInfo.nomeGuerra.toUpperCase() 
            : null;

            if (listId && userId) {
                // Esta chave DEVE ser a mesma usada na fun√ß√£o salvarRascunho()
                const draftKey = `sigma_draft_${userId}_${listId}`; 
                localStorage.removeItem(draftKey);
                console.log(`Rascunho local (${draftKey}) limpo com sucesso.`);
            }
        }

       // --- 1. FUN√á√ÉO PARA LER DADOS ANTIGOS (LEGADOS) ---
const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
    const separator = ' | + NOVA: ';
    if (typeof textoBruto !== 'string') return [];
    
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
            if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
        if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
    }
    return linhas;
};

// --- 2. FUN√á√ÉO VISUAL √öNICA (SEM HORAS VIA REGEX) ---
const gerarHtmlVisualApp = (pendencia, autorAtual, dataAtual) => {
    let html = '<ul class="lista-pendencias" style="list-style: none; padding: 0; margin: 5px 0;">';
    
    // 1. EXTRA√á√ÉO SEGURA DA LISTA
    // Tenta pegar o array de pend√™ncias acumuladas (Nova Estrutura)
    const lista = (pendencia && pendencia.pendencias_ca) ? pendencia.pendencias_ca : 
                  (Array.isArray(pendencia) ? pendencia : null);

    // üõ°Ô∏è 2. REGRA DE PRIORIDADE (MATA O FANTASMA)
    // Se a lista existir e tiver itens, usamos APENAS ela e ignoramos o campo 'obs'
    if (lista && Array.isArray(lista) && lista.length > 0) {
        lista.forEach(p => {
            const militar = p.quem || 'Militar';
            const dataFull = p.data || '';
            
            // Extrai apenas a data (DD/MM/AAAA) usando regex
            const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
            const dataApenas = matchData ? matchData[0] : dataFull;

            html += `
                <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px;">
                    <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                    <b>Por </b>
                    <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                    <span> em <b>${dataApenas}</b>:</span>
                    <i style="margin-left: 5px; color: #333; font-weight: normal; display: block; padding-left: 25px;">${p.obs}</i>
                </li>`;
        });
    } 
    // 3. FALLBACK PARA DADOS ANTIGOS (S√≥ entra aqui se N√ÉO houver lista)
    else if (pendencia && pendencia.obs && typeof pendencia.obs === 'string') {
        const militar = pendencia.quem || autorAtual || 'Militar';
        const dataFull = pendencia.data || dataAtual || '';
        const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
        const dataApenas = matchData ? matchData[0] : dataFull;

        html += `
            <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem;">
                <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                <b>Por </b>
                <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                <span> em <b>${dataApenas}</b>:</span>
                <i style="margin-left: 5px; color: #333; font-weight: normal;">${pendencia.obs}</i>
            </li>`;
    }

    html += '</ul>';
    return html;
};
    
// --- 3. FUN√á√ÉO DE RENDERIZA√á√ÉO DA TELA ---
function renderizarConferencia() {
    const mainContent = document.getElementById('main-content');
    const antigos = mainContent.querySelectorAll('.setor'); 
    antigos.forEach(el => el.remove());

    let htmlSetores = ''; 
    const fonteDados = window.dadosConferencia || dadosConferencia;

    const montarPendenciaHtml = (uid, itemOuTomb) => {
        let htmlAcumulado = '';
        const cautelaUid = `CAUTELA-${uid}`;
        const statusLocal = window.itemStatus[uid] || {};
        const statusCautela = window.itemStatus[cautelaUid] || {};
        const isCiente = statusCautela.status === 'cautela_ciente' || statusCautela.cautela_confirmada === true;

        let listaDeCautelas = [];
        if (itemOuTomb.cautela) {
            listaDeCautelas = [itemOuTomb.cautela];
        } else if (itemOuTomb.cautelas && Array.isArray(itemOuTomb.cautelas)) {
            listaDeCautelas = itemOuTomb.cautelas;
        }

        listaDeCautelas.forEach(c => {
            const dataExibicao = c.data || "Data N/D";
            htmlAcumulado += `
                <div class="pendencia-id-card status-cautela" style="border-left: 4px solid #f57c00; background-color: #fff8e0; padding: 12px; margin-bottom: 8px; border-radius: 5px; text-align: left;">
                    <div style="font-weight: bold; color: #f57c00; font-size: 0.8em; margin-bottom: 8px; border-bottom: 1px solid rgba(245, 124, 0, 0.2); padding-bottom: 4px;">
                        <i class="fas fa-lock"></i> ${c.id || 'CAUTELA'} em ${dataExibicao}
                    </div>
                    <div style="font-size: 0.85em; color: #333; margin-bottom: 4px;">
                        <i class="fas fa-boxes" style="width: 18px; color: #666;"></i> Quantidade: <b>${c.quantidade || 1} un.</b>
                    </div>
                    <div style="font-size: 0.85em; color: #333; margin-bottom: 8px;">
                        <i class="fas fa-user" style="width: 18px; color: #666;"></i> Detentor: <b>${c.destinatario}</b>
                    </div>
                    ${isCiente ? `
                        <div style="color: #1b8a3e; font-size: 0.75em; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 6px; margin-top: 4px; font-style: italic;">
                            <i class="fas fa-check-double"></i> Ciente nesta confer√™ncia
                        </div>
                    ` : `
                        <button type="button" class="action-button ca-alert active" style="width: 100%; margin-top: 5px; height: 30px; font-size: 0.8em;" onclick="setItemStatusID(this, 'cautela_ciente', '${cautelaUid}')">Ciente</button>
                    `}
                </div>`;
        });

        if (itemOuTomb.pendencias_ids && Array.isArray(itemOuTomb.pendencias_ids)) {
            itemOuTomb.pendencias_ids.forEach(p => {
                const isTemp = String(p.id).startsWith('TEMP-');
                const jaFoiMantido = statusLocal.ids_mantidos && statusLocal.ids_mantidos.includes(p.id);
                let acoesHtml = '';
                let botoesGestaoHtml = '';

                if (isTemp) {
                    botoesGestaoHtml = `
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span onclick="abrirModalEditar('${p.id}', '${uid}', ${p.quantidade}, '${p.descricao.replace(/'/g, "\\'")}')" style="cursor:pointer; color:#2196F3; font-size:1.1em; padding:5px;"><i class="fas fa-edit"></i></span>
                            <span onclick="confirmarExclusaoRelato('${p.id}', '${uid}')" style="cursor:pointer; color:#d90f23; font-size:1.1em; padding:5px;"><i class="fas fa-trash-alt"></i></span>
                        </div>`;
                    acoesHtml = `<div style="color:#2196F3; font-size:0.75em; font-weight:bold; text-align:center; width:100%; border-top:1px solid #eee; padding-top:5px; font-style:italic;">Aguardando finaliza√ß√£o...</div>`;
                } else if (jaFoiMantido) {
                    acoesHtml = `
                        <div style="color: #1b8a3e; font-size: 0.75em; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 8px; margin-top: 4px; font-style: italic;">
                            <i class="fas fa-check-double"></i> MANTIDO NESTA CONFER√äNCIA
                        </div>`;
                } else {
                    acoesHtml = `
                        <div class="pendencia-actions" style="display: flex; gap: 8px; margin-top: 10px;">
                            <button type="button" class="btn-manter" style="flex:1" onclick="manterID('${p.id}', '${uid}')"><i class="fas fa-check-double"></i> Manter</button>
                            <button type="button" class="btn-resolver" style="flex:1" onclick="abrirModalResolver('${p.id}', '${uid}', ${p.quantidade}, '${p.descricao.replace(/'/g, "\\'")}')"><i class="fas fa-magic"></i> Resolvido</button>
                        </div>`;
                }

                htmlAcumulado += `
                    <div class="pendencia-id-card" id="card-${p.id}" style="position:relative; border: 1px solid ${isTemp ? '#2196F3' : (jaFoiMantido ? '#1b8a3e' : '#d90f23')}; border-radius: 8px; padding: 12px; margin-bottom: 10px; background-color: #fff; text-align: left;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #666; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">
                            <span><i class="fas ${isTemp ? 'fa-pen-nib' : 'fa-history'}"></i> ${isTemp ? '<b>LAN√áAMENTO ATUAL</b>' : '<b>Relatado por:</b> ' + p.autor_nome}</span>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span>${p.data_criacao}</span>
                                ${botoesGestaoHtml}
                            </div>
                        </div>
                        <div style="font-size: 0.85em; color: #333; margin-bottom: 4px;">
                            <i class="fas fa-boxes" style="width: 18px; color: #666;"></i> Quantidade: <strong style="color: #d90f23;">${p.quantidade} un.</strong>
                        </div>
                        <div style="font-size: 0.85em; color: #333; margin-bottom: 8px;">
                            <i class="fas fa-comment-dots" style="width: 18px; color: #666;"></i> Descri√ß√£o: <b>${p.descricao}</b>
                        </div>
                        ${acoesHtml}
                    </div>`;
            });
        }
        return htmlAcumulado;
    };

    fonteDados.forEach((setor, index) => {
        const isFirstSetor = (index === 0); 
        let htmlItens = ''; 
        
        // CORRE√á√ÉO 1: Contagem por Material (Setor 1 agora ser√° 0/3)
        let totalItensNoSetor = setor.itens.length; 
        
        setor.itens.forEach(item => {
            const nomeEscapado = item.nome.replace(/'/g, "\\'");
            const itemId = item.id;

            if (item.tipo === 'multi' && item.tombamentos) {
                let htmlTombamentos = '';
                let confCount = 0, altCount = 0;

                item.tombamentos.forEach(t => {
                    const uid = `${itemId}-${t.tomb}`;
                    const hasPendencia = t.pendencias_ids && t.pendencias_ids.length > 0;
                    const statusU = window.itemStatus[uid]?.status;
                    const statusC = window.itemStatus[`CAUTELA-${uid}`]?.status;
                    const isCiente = statusC === 'cautela_ciente';

                    if (statusU === 'S/A' || statusU === 'C/A' || statusU === 'KEEP' || isCiente) {
                        confCount++;
                        if (statusU === 'C/A' || statusU === 'KEEP' || isCiente) altCount++;
                    }

                    let botoesTombamento = t.cautela ? '' : `
                        <div class="tombamento-options" style="display: flex; gap: 5px;">
                            ${!hasPendencia ? `<button type="button" class="action-button sa-ok ${(statusU === 'S/A' || statusU === 'ok') ? 'active' : ''}" onclick="setItemStatusID(this, 'ok', '${uid}')">S/A</button>` : ''}
                            <button type="button" class="action-button ca-alert ${hasPendencia ? 'active' : ''}" onclick="abrirFormNovoID('${uid}', 'multi', '${nomeEscapado}', 1, '${t.tomb}')">+ Altera√ß√£o</button>
                        </div>`;

                    htmlTombamentos += `
                        <div class="tombamento-container" data-id="${uid}" data-tomb="${t.tomb}" style="border: 1px solid #eee; padding: 10px; margin-bottom: 5px; border-radius: 8px; ${isCiente ? 'background-color: #f0fff4; border-color: #1b8a3e;' : ''}">
                            <div class="tombamento-controls" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Tomb.: <b>${t.tomb}</b></span>
                                ${botoesTombamento}
                            </div>
                            <div class="alerts-wrapper">${montarPendenciaHtml(uid, t)}</div>
                        </div>`;
                });

                let classeMulti = '';
                if (confCount === item.tombamentos.length) {
                    classeMulti = altCount > 0 ? 'status-alert' : 'status-ok';
                }

                htmlItens += `<div class="item-conferencia item-has-tombamentos ${classeMulti}" data-id="${itemId}">
                    <div class="item-header">
                        <span class="status-icon ${classeMulti === 'status-ok' ? 'ok' : (classeMulti === 'status-alert' ? 'alert' : '')}"></span>
                        <span class="item-label">${item.nome}</span>
                    </div>
                    ${htmlTombamentos}
                </div>`;

            } else {
                const totalEsp = Number(item.quantidadeEsperada) || 0;
                const totalCaut = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                const totalPend = (item.pendencias_ids || []).reduce((sum, p) => sum + (Number(p.quantidade) || 0), 0);
                const saldoReal = totalEsp - totalCaut - totalPend;
                const corSaldo = saldoReal < totalEsp ? '#d90f23' : '#1b8a3e';
                const hasPendencia = item.pendencias_ids && item.pendencias_ids.length > 0;
                
                const currentStatus = window.itemStatus[itemId]?.status;
                const cautStatus = window.itemStatus[`CAUTELA-${itemId}`]?.status;
                
                let classeSingle = '';
                if (currentStatus === 'S/A') classeSingle = 'status-ok';
                else if (cautStatus === 'cautela_ciente' || hasPendencia) classeSingle = 'status-alert';

                htmlItens += `
                    <div class="item-conferencia ${classeSingle}" data-type="single" data-id="${itemId}">
                        <div class="item-header">
                            <span class="status-icon ${classeSingle === 'status-ok' ? 'ok' : (classeSingle === 'status-alert' ? 'alert' : '')}"></span>
                            <div style="display:flex; flex-direction:column"><span class="item-label">${item.nome}</span><span style="font-size:0.85em; color:${corSaldo}; font-weight:bold;">DISPON√çVEL: ${saldoReal} de ${totalEsp}</span></div>
                        </div>
                        <div class="item-options" style="margin-top:10px; display: flex; gap: 5px;">
                            ${!hasPendencia ? `<button type="button" class="action-button sa-ok ${currentStatus === 'S/A' ? 'active' : ''}" onclick="setItemStatusID(this, 'ok', '${itemId}')">S/A</button>` : ''}
                            <button type="button" class="action-button ca-alert ${hasPendencia ? 'active' : ''}" onclick="abrirFormNovoID('${itemId}', 'single', '${nomeEscapado}', ${saldoReal})">+ Altera√ß√£o</button>
                        </div>
                        <div class="alerts-wrapper" style="margin-top:10px">${montarPendenciaHtml(itemId, item)}</div>
                    </div>`;
            }
        });
        
        htmlSetores += `<div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id || setor.nome}"><div class="setor-header" onclick="toggleSetor(this)"><div class="setor-info"><span>${setor.nome}</span><div class="setor-status">0/${totalItensNoSetor}</div></div><span class="arrow">${isFirstSetor ? '‚ñº' : '‚ñ∫'}</span></div><div class="setor-content ${isFirstSetor ? 'expanded' : ''}">${htmlItens}</div></div>`;
    });

    const btnFin = document.getElementById('btn-finalizar');
    if (btnFin) btnFin.insertAdjacentHTML('beforebegin', htmlSetores);
    updateOverallStatus();
}
    function abrirModalEditar(pendenciaId, uid, qtdAtual, descricaoAtual) {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');

    // 1. Configura para Modo Edi√ß√£o
    document.getElementById('modal-acao-objetivo').value = "editar";
    document.getElementById('modal-uid').value = uid;
    document.getElementById('modal-tipo').value = pendenciaId; 

    // 2. Preenche os dados
    document.getElementById('modal-titulo-item').innerText = "Editar Relato";
    document.getElementById('modal-subtitulo-detalhe').innerText = "Ajuste os detalhes da altera√ß√£o selecionada.";
    document.getElementById('modal-label-obs').innerText = "Nova Descri√ß√£o:";
    inputObs.value = descricaoAtual;

    // 3. For√ßa a exibi√ß√£o da quantidade (importante para mobile)
    const grupoQtd = document.getElementById('modal-grupo-qtd');
    if (grupoQtd) {
        grupoQtd.style.display = 'block'; // Remove o 'important' via JS para evitar conflitos
    }
    inputQtd.value = qtdAtual;

    // 4. Ajuste Visual para Edi√ß√£o (Azul)
    btnConfirmar.innerText = "SALVAR ALTERA√á√ïES";
    btnConfirmar.style.backgroundColor = "#2196F3"; 
    document.querySelector('.modal-content').style.borderTopColor = "#2196F3";

    // 5. ACIONAMENTO MOBILE (Garante que o modal suba acima de tudo)
    modal.style.zIndex = "99999";
    modal.style.display = 'flex';

    // 6. Scroll para o topo (Evita que o modal abra "escondido" se a p√°gina estiver longa)
    window.scrollTo(0, 0);

    // Foco no input com delay maior para mobile (espera o teclado subir)
    setTimeout(() => {
        if (inputObs) {
            inputObs.focus();
            inputObs.setSelectionRange(inputObs.value.length, inputObs.value.length);
        }
    }, 300);
}
    
      function adaptarCautelaParaRender(cautelaData) {
          if (!cautelaData.itens || cautelaData.itens.length === 0) return [];

            const setorCautela = {
            id: cautelaData.cautela_id,
            nome: "ITENS CAUTELADOS",
            itens: cautelaData.itens.map(cItem => {
            
            let tipo = cItem.tombamento ? 'multi' : 'single';
            let tombamentos = null;

            if (tipo === 'multi') {
                tombamentos = [{
                    tomb: cItem.tombamento,
                    id_completo: cItem.id_completo || `${cItem.id_base || cItem.id}-${cItem.tombamento}`,
                    // O item da cautela j√° carrega seu pr√≥prio estado (JSON) se houver
                    cautela: cItem.cautela || {
                        id: cautelaData.cautela_id,
                        destinatario: cautelaData.destinatario || cautelaData.destinatario_original_nome,
                        data: cautelaData.timestamp_emissao ? new Date(cautelaData.timestamp_emissao.seconds * 1000).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR')
                    },
                    pendencia: cItem.pendencia || null
                }];
                cItem.quantidade = 1; 
            }

            return {
                id: cItem.id_base || cItem.id,
                nome: cItem.nome,
                quantidadeEsperada: cItem.quantidade || 1,
                tipo: tipo,
                tombamentos: tombamentos,
                // Preserva o carimbo JSON para itens de quantidade (Single)
                cautelas: cItem.cautelas || [],
                pendencia: cItem.pendencia || null
            };
        })
    };

    return [setorCautela];
}
        async function carregarDadosRemotos() {
    const ID_ALVO = isCautela ? CAUTELA_ID : LISTA_ID;
    const COLECAO_ALVO = isCautela ? COLECAO_CAUTELAS : COLECAO_LISTAS;
    
    if (!ID_ALVO) { 
        console.error("ID n√£o encontrado para carregamento.");
        return; 
    }
        
    const loadingMsg = document.getElementById('loading-message');
    if (loadingMsg) loadingMsg.innerHTML = "Conectando...";

    try {
        const doc = await db.collection(COLECAO_ALVO).doc(ID_ALVO).get();
        if (!doc.exists) throw new Error("Documento n√£o encontrado no banco de dados.");
        
        const data = doc.data();
        
        // üõë PROCESSAMENTO DOS DADOS üõë
        if (isCautela) {
            dadosConferencia = adaptarCautelaParaRender(data);
        } else {
            const listaBruta = data.list || [];
            dadosConferencia = listaBruta.map(setor => ({
                ...setor,
                itens: (setor.itens || []).map(item => {
                    if (item.tipo === 'single') {
                        // C√°lculo de saldo para confer√™ncia visual
                        const totalCautelado = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                        // O saldo real √© calculado dinamicamente na renderiza√ß√£o usando quantidadeEsperada e totalCautelado
                    }
                    return item;
                })
            }));
        }

        // --- V√çNCULO GLOBAL (CR√çTICO PARA O SIMULADOR) ---
        window.dadosConferencia = dadosConferencia;
        
        const nomeLocal = isCautela ? `CAUTELA: ${CAUTELA_ID}` : (data.nome_local || "Lista de Confer√™ncia");
        const postoLocal = isCautela ? `Destinat√°rio: ${data.destinatario || data.destinatario_original_nome}` : (data.posto || "Geral");
        
        infoLocal = { nome: nomeLocal, posto: postoLocal };
        
        const infoElement = document.getElementById('local-posto-info');
        if (infoElement) {
            infoElement.innerHTML = `<span style="color:blue;font-weight:bold">${infoLocal.posto} - ${infoLocal.nome}</span>`;
        }

        document.title = isCautela ? `Cautela - ${CAUTELA_ID}` : `Confer√™ncia - ${infoLocal.nome}`;

        if (isCautela) {
            const h1Element = document.querySelector('h1');
            const subtituloElement = document.querySelector('.subtitulo');
            const btnFinalizar = document.getElementById('btn-finalizar');

            if (h1Element) {
                if (MODO_OPERACAO === 'devolucao_final') h1Element.textContent = 'RECEBIMENTO DE DEVOLU√á√ÉO';
                else if (MODO_OPERACAO === 'devolucao') h1Element.textContent = 'DEVOLU√á√ÉO (TRANSI√á√ÉO)';
                else h1Element.textContent = 'RECEBIMENTO DE CAUTELA';
            }

            if (subtituloElement) {
                if (MODO_OPERACAO === 'devolucao_final') {
                    const reversor = data.militar_completo_reversor || 'Militar Anterior';
                    subtituloElement.innerHTML = `Recebendo Cautela <strong>${CAUTELA_ID}</strong> de: <br> ${reversor}`;
                } else {
                    subtituloElement.textContent = `Processando Cautela ${CAUTELA_ID}`;
                }
            }

            if (btnFinalizar) {
                if (MODO_OPERACAO === 'devolucao_final') {
                    btnFinalizar.textContent = 'FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO';
                    btnFinalizar.onclick = () => finalizarRecebimentoDevolucao(data);
                } else {
                    btnFinalizar.onclick = () => finalizarRecebimentoCautela(data);
                }
            }
        }
        
        if (loadingMsg) loadingMsg.innerHTML = "Renderizando itens...";
        
        // Dispara a renderiza√ß√£o com os dados globais sincronizados
        renderizarConferencia(); 

        if (typeof updateHeaderInfo === "function") try { updateHeaderInfo(); } catch(e) {}
        if (typeof updateOverallStatus === "function") try { updateOverallStatus(); } catch(e) {}
        
        if (loadingMsg) loadingMsg.style.display = 'none'; 
        const mainContent = document.getElementById('main-content');
        if (mainContent) mainContent.style.display = 'block';

    } catch (e) { 
        console.error("Erro Cr√≠tico no Carregamento:", e);
        if (loadingMsg) loadingMsg.innerHTML = `<span style='color:red'>Erro ao carregar dados: ${e.message}</span>`;
    }
}
     
        async function finalizarConferencia() {
    const btn = document.getElementById('btn-finalizar');
    if (btn.disabled) return;
    
    // Feedback visual imediato
    btn.textContent = "SALVANDO SUA CONFER√äNCIA..."; 
    btn.disabled = true;

    try {
        const p = userInfo;
        
        // Busca o nome institucional completo (igual ao carimbo)
        const militarInfoEl = document.getElementById('militar-info');
        const conferenteCompleto = militarInfoEl ? 
            militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim() : 
            `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;

        const localNome = `${infoLocal.posto} - ${infoLocal.nome}`;
        const timestampAgora = firebase.firestore.Timestamp.now();
        
        let itensRelatorio = [];
        let itensCaa = []; 
        let totalCaa = 0;

        // --- REFER√äNCIA √Ä FONTE DE DADOS GLOBAL ---
        const fonteDeDados = window.dadosConferencia || dadosConferencia;

        const novaListaMestra = fonteDeDados.map(setor => {
            return {
                ...setor,
                itens: setor.itens.map(item => {
                    
                    const processarEntidade = (entidade, uid, nomeParaRelatorio) => {
                        const statusLocal = window.itemStatus[uid];
                        
                        // Se n√£o houve a√ß√£o neste item, retorna ele como est√°
                        if (!statusLocal || statusLocal.status === 'pending') return entidade;

                        if (!entidade.pendencias_ids) entidade.pendencias_ids = [];
                        if (!entidade.historico_vida) entidade.historico_vida = [];

                        // --- 1. TRATAMENTO DE RESOLVIDOS ---
                        if (statusLocal.ids_resolvidos) {
                            statusLocal.ids_resolvidos.forEach(res => {
                                const idx = entidade.pendencias_ids.findIndex(p => p.id === res.id);
                                if (idx > -1) {
                                    const pendenciaMorta = entidade.pendencias_ids[idx];
                                    entidade.historico_vida.push({
                                        evento: res.qtd_remanescente > 0 ? "SOLUCAO_PARCIAL" : "SOLUCAO_TOTAL",
                                        id_pendencia_origem: pendenciaMorta.id,
                                        quem: res.resolvido_por,
                                        data: res.data_solucao,
                                        detalhes: `Resolvido ${res.qtd_resolvida} de ${pendenciaMorta.quantidade}. Desc: ${pendenciaMorta.descricao}`
                                    });
                                    entidade.pendencias_ids.splice(idx, 1);

                                    if (res.qtd_remanescente > 0) {
                                        entidade.pendencias_ids.push({
                                            ...pendenciaMorta,
                                            id: "PEND_" + Date.now() + "_RES",
                                            quantidade: res.qtd_remanescente,
                                            descricao: pendenciaMorta.descricao + " (SALDO REMANESCENTE)",
                                            herdado_de: pendenciaMorta.id
                                        });
                                    }
                                }
                            });
                        }

                        // --- 2. TRATAMENTO DE NOVOS (IMPORTANTE) ---
                        // Como a fun√ß√£o 'salvarNovoID' j√° injetou o objeto TEMP- no dadosConferencia, 
                        // aqui n√≥s apenas limpamos o prefixo TEMP- para virar um ID definitivo PEND-
                        entidade.pendencias_ids = entidade.pendencias_ids.map(p => {
                            if (p.id.startsWith('TEMP-')) {
                                const novoIdDefinitivo = p.id.replace('TEMP-', 'PEND-');
                                
                                // Registra no hist√≥rico de vida
                                entidade.historico_vida.push({
                                    evento: "NOVA_PENDENCIA",
                                    id_pendencia: novoIdDefinitivo,
                                    quem: p.autor_nome,
                                    data: p.data_criacao,
                                    detalhes: `${p.quantidade}un - ${p.descricao}`
                                });
                                
                                return { ...p, id: novoIdDefinitivo };
                            }
                            return p;
                        });

                        // --- 3. PREPARA√á√ÉO PARA RELAT√ìRIO ---
                        const temAlteracao = entidade.pendencias_ids.length > 0;
                        const statusFinal = temAlteracao ? 'C/A' : 'S/A';
                        
                        const dadosRelatorio = {
                            id: uid,
                            nomeCompleto: nomeParaRelatorio,
                            status: statusFinal,
                            pendencias_ids: [...entidade.pendencias_ids],
                            quantidade: entidade.quantidadeEsperada || 1,
                            setor: setor.nome,
                            obs: entidade.pendencias_ids.map(p => `${p.quantidade}un: ${p.descricao}`).join(' | ')
                        };

                        itensRelatorio.push(dadosRelatorio);
                        if (temAlteracao) {
                            itensCaa.push(dadosRelatorio);
                            totalCaa++;
                        }

                        return entidade;
                    };

                    if (item.tipo === 'multi' && item.tombamentos) {
                        item.tombamentos = item.tombamentos.map(t => processarEntidade(t, `${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`));
                    } else {
                        item = processarEntidade(item, item.id, item.nome);
                    }
                    return item;
                })
            };
        });

        // --- GRAVA√á√ÉO NO FIREBASE ---
        // 1. Atualiza a Lista Mestra (Onde vivem os itens e tombamentos)
        await db.collection(COLECAO_LISTAS).doc(LISTA_ID).update({ list: novaListaMestra });

        // 2. Registra o Relat√≥rio de Confer√™ncia (O hist√≥rico que o gestor consulta)
        await db.collection('resultados_conferencias').add({
            local: localNome,
            lista_id: LISTA_ID,
            conferente_uid: p.uid,
            conferente: conferenteCompleto,
            timestamp: timestampAgora,
            totalItensConferidos: itensRelatorio.length,
            totalCaa: totalCaa,
            itensCaa: itensCaa,
            itensRelatorio: itensRelatorio
        });

        // 3. Atualiza a Cust√≥dia (Quem √© o atual respons√°vel pelo local)
        await db.collection('custodia_atual').doc(LISTA_ID).set({
            lista_id: LISTA_ID,
            local_nome: localNome,
            conferente_uid: p.uid,
            conferente_completo: conferenteCompleto,
            timestamp_ultima_conferencia: timestampAgora
        });

        alert("‚úÖ Confer√™ncia Finalizada!\nConfira seu dashboard.");
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (e) {
        console.error("Erro fatal na grava√ß√£o:", e);
        alert("Erro ao gravar dados: " + e.message);
        btn.disabled = false;
        btn.textContent = "FINALIZAR CONFER√äNCIA";
    }
}
        async function finalizarRecebimentoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();
            if (cData.destinatario_original_uid !== meuUid) {
                throw new Error("Apenas o destinat√°rio original pode assinar este recebimento.");
            }

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensConferidos = [];

            cautela.itens.forEach(cItem => {
                const statusSelect = document.getElementById(`status-${cItem.id}-${cItem.tombamento || 'single'}`);
                const obsInput = document.getElementById(`obs-${cItem.id}-${cItem.tombamento || 'single'}`);
                
                const statusFinal = statusSelect ? statusSelect.value : 'S/A';
                const obsFinal = obsInput ? obsInput.value.trim() : '';

                itensConferidos.push({
                    ...cItem,
                    status_recebimento: statusFinal,
                    obs_recebimento: obsFinal
                });

                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            const logHistorico = {
                                evento: "CONFIRMA√á√ÉO_RECEBIMENTO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                estado: statusFinal,
                                detalhes: statusFinal === 'C/A' ? `Avaria detectada no recebimento: ${obsFinal}` : "Recebido em perfeito estado (S/A)."
                            };

                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push(logHistorico);

                            const objetoCautelaAtualizado = {
                                id: CAUTELA_ID,
                                emitente: cData.emitente,
                                destinatario: meuNomeCompleto,
                                data: dataAtual,
                                status_item: statusFinal,
                                obs_item: obsFinal
                            };

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        t.cautela = objetoCautelaAtualizado;
                                    }
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = mItem.cautelas.map(c => {
                                    if (c.id === CAUTELA_ID) {
                                        return objetoCautelaAtualizado;
                                    }
                                    return c;
                                });
                            }
                        }
                        return mItem;
                    })
                }));
            });

            transaction.update(cautelaRef, {
                status: 'RECEBIDA',
                timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
                itens: itensConferidos,
                militar_completo_receptor: meuNomeCompleto
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Recebimento confirmado!`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (error) {
        console.error("Erro ao receber cautela:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO";
        btn.disabled = false;
    }
}
      async function finalizarDevolucaoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = 'Processando...';
    btn.disabled = true;

    try {
        // Pega as informa√ß√µes do militar logado (quem est√° devolvendo)
        const userInfo = await getLoggedUser(); 
        
        if (!userInfo) {
            alert("Erro: Dados do militar logado n√£o encontrados.");
            btn.textContent = 'ERRO AO FINALIZAR';
            btn.disabled = false;
            return;
        }

        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);

        // üõë CR√çTICO: Executa a Transa√ß√£o no Firebase üõë
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(cautelaRef);

            if (!doc.exists || doc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela n√£o encontrada ou n√£o est√° no status 'RECEBIDA'.");
            }
            
            // 1. A√ß√£o: Mudar o status da cautela para CONCLUIDA.
            transaction.update(cautelaRef, { 
                status: 'CONCLUIDA', // Status final
                timestamp_devolucao: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem est√° devolvendo (Militar Logado)
                reversor: userInfo.nomeGuerra, 
                militar_completo_reversor: `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`,
                
                // Quem est√° recebendo de volta (√öltimo Conferente)
                destinatario_final_devolucao: DESTINATARIO_DEVOLUCAO,
            });
            
            // 2. A√ß√£o: Registrar o hist√≥rico de confer√™ncia final (opcional, mas recomendado)
            // Se necess√°rio, voc√™ pode adicionar um novo documento na sua cole√ß√£o de hist√≥rico.
        }); // Fim da Transa√ß√£o

        alert(`‚úÖ Devolu√ß√£o da Cautela ${CAUTELA_ID} conclu√≠da e status atualizado para \"CONCLUIDA\".`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro CR√çTICO ao finalizar devolu√ß√£o:", error);
        alert(`Erro ao finalizar devolu√ß√£o. Nenhum dado foi alterado. Erro: ${error.message}`);
        btn.textContent = "ERRO AO FINALIZAR";
        btn.disabled = false;
    }
}
        async function finalizarRecebimentoDevolucao(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada. Fa√ßa login novamente.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra original n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensDevolvidos = [];

            cautela.itens.forEach(cItem => {
                const statusSelect = document.getElementById(`status-${cItem.id}-${cItem.tombamento || 'single'}`);
                const obsInput = document.getElementById(`obs-${cItem.id}-${cItem.tombamento || 'single'}`);
                
                const statusFinal = statusSelect ? statusSelect.value : 'S/A';
                const obsFinal = obsInput ? obsInput.value.trim() : '';

                itensDevolvidos.push({
                    ...cItem,
                    status_devolucao: statusFinal,
                    obs_devolucao: obsFinal
                });

                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            const logHistorico = {
                                evento: "RETORNO_DEVOLUCAO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                estado_retorno: statusFinal,
                                detalhes: statusFinal === 'C/A' ? `Item devolvido com altera√ß√£o: ${obsFinal}` : "Item devolvido em perfeito estado (S/A)."
                            };

                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push(logHistorico);

                            if (statusFinal === 'C/A') {
                                mItem.pendencia = {
                                    tipo: "C/A",
                                    obs: `[DEVOLU√á√ÉO ${CAUTELA_ID}] ${obsFinal}`,
                                    quem: meuNomeCompleto,
                                    data: dataAtual
                                };
                            } else {
                                delete mItem.pendencia;
                            }

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        delete t.cautela;
                                    }
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = (mItem.cautelas || []).filter(c => 
                                    (c.id !== CAUTELA_ID && c.cautela_id !== CAUTELA_ID)
                                );
                            }
                        }
                        return mItem;
                    })
                }));
            });

            transaction.update(cautelaRef, { 
                status: 'CONCLU√çDA',
                timestamp_conclusao: firebase.firestore.FieldValue.serverTimestamp(),
                receptor_final_completo: meuNomeCompleto,
                destinatario_uid: meuUid,
                itens: itensDevolvidos
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Devolu√ß√£o finalizada! Material reintegrado ao estoque e hist√≥rico atualizado.`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro ao finalizar devolu√ß√£o:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
        btn.disabled = false;
    }
}
    // --- NOVAS FUN√á√ïES DE CONTROLE DE IDS √öNICOS ---

// --- NOVAS FUN√á√ïES DE CONTROLE DE IDS √öNICOS ---

function abrirFormNovoID(uid, tipo, nomeItem, saldo, tombReal = "") {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const grupoQtd = document.getElementById('modal-grupo-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const infoMax = document.getElementById('modal-info-max');
    const subtitulo = document.getElementById('modal-subtitulo-detalhe');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');
    
    document.getElementById('modal-acao-objetivo').value = "incluir";
    inputObs.value = '';
    document.getElementById('modal-uid').value = uid;
    document.getElementById('modal-tipo').value = tipo;
    
    const nomeLimpo = nomeItem.replace(/\\'/g, "'");
    document.getElementById('modal-titulo-item').innerText = nomeLimpo;
    document.getElementById('modal-label-obs').innerText = "Descri√ß√£o do Problema:";
    document.getElementById('modal-label-qtd').innerText = "Quantidade Alterada:";
    inputObs.placeholder = "Descreva o problema...";

    btnConfirmar.innerText = "INCLUIR";
    btnConfirmar.style.backgroundColor = "#800020";
    document.querySelector('.modal-content').style.borderTopColor = "#d90f23";

    if (tipo === 'multi') {
        subtitulo.innerHTML = `Refer√™ncia Tomb.: <span style="color:#d90f23; font-weight:bold;">${tombReal}</span>`;
        grupoQtd.style.setProperty('display', 'none', 'important');
        inputQtd.value = 1;
        inputQtd.max = 1;
    } else {
        subtitulo.innerHTML = ""; 
        grupoQtd.style.setProperty('display', 'block', 'important');
        const saldoReal = parseInt(saldo) || 0;
        inputQtd.max = saldoReal;
        inputQtd.value = 1;
        infoMax.innerText = `Saldo total dispon√≠vel: ${saldoReal}`;
        
        if (saldoReal <= 0) {
            alert("Este item n√£o possui saldo dispon√≠vel para altera√ß√£o.");
            return;
        }
    }

    modal.style.display = 'flex';
    setTimeout(() => { if(inputObs) inputObs.focus(); }, 150);
}

function fecharModalPendencia() {
    const modal = document.getElementById('modal-nova-pendencia');
    if (modal) {
        modal.style.display = 'none';
        document.getElementById('modal-input-obs').value = '';
    }
}

function abrirModalResolver(pendenciaId, uid, qtdOriginal, descricaoOriginal) {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');
    
    if (!modal) return console.error("Modal n√£o encontrado no DOM");

    // Configura√ß√£o de Identidade para RESOLU√á√ÉO
    document.getElementById('modal-acao-objetivo').value = "resolver";
    document.getElementById('modal-uid').value = uid;
    document.getElementById('modal-tipo').value = pendenciaId; 

    // Ajuste de Textos
    document.getElementById('modal-titulo-item').innerText = "Resolver Altera√ß√£o";
    document.getElementById('modal-subtitulo-detalhe').innerHTML = `Relato original: <b>"${descricaoOriginal}"</b>`;
    document.getElementById('modal-label-obs').innerText = "Justificativa da Resolu√ß√£o:";
    document.getElementById('modal-label-qtd').innerText = "Unidades Resolvidas:";
    inputObs.placeholder = "Diga como foi resolvido (ex: reposto, consertado)...";
    inputObs.value = '';

    // Ajuste de Quantidade
    document.getElementById('modal-grupo-qtd').style.setProperty('display', 'block', 'important');
    inputQtd.max = qtdOriginal;
    inputQtd.value = qtdOriginal;
    document.getElementById('modal-info-max').innerText = `Total que estava pendente: ${qtdOriginal} un.`;

    // Est√©tica Verde
    btnConfirmar.innerText = "CONFIRMAR SOLU√á√ÉO";
    btnConfirmar.style.backgroundColor = "#1b8a3e"; 
    document.querySelector('.modal-content').style.borderTopColor = "#1b8a3e";

    modal.style.display = 'flex';
    setTimeout(() => { if(inputObs) inputObs.focus(); }, 150);
}

function processarAcaoFinalModal() {
    const objetivo = document.getElementById('modal-acao-objetivo').value;
    const uid = document.getElementById('modal-uid').value;
    const qtd = document.getElementById('modal-input-qtd').value;
    const obs = document.getElementById('modal-input-obs').value;
    const tipoOuPendenciaId = document.getElementById('modal-tipo').value;

    if (obs.trim().length < 5) {
        return alert("Descri√ß√£o muito curta.");
    }

    if (objetivo === "editar") {
        executarEdicaoRelato(tipoOuPendenciaId, uid, qtd, obs);
    } else if (objetivo === "resolver") {
        resolverID(tipoOuPendenciaId, uid, qtd, obs);
    } else {
        salvarNovoID(uid, qtd, tipoOuPendenciaId, obs);
    }
    
    fecharModalPendencia();
}
    function executarEdicaoRelato(pendenciaId, uid, novaQtd, novaObs) {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    let editado = false;

    // Garantimos que estamos comparando Strings para evitar erro de tipo
    const idProcurado = String(pendenciaId);

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            // Criamos uma lista de alvos (o pr√≥prio item ou a lista de tombamentos dele)
            let alvosParaVerificar = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            
            alvosParaVerificar.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    // Tenta encontrar a pend√™ncia exata dentro do array do item/tombamento
                    const p = alvo.pendencias_ids.find(pend => String(pend.id) === idProcurado);
                    
                    if (p) {
                        p.descricao = novaObs;
                        p.quantidade = parseInt(novaQtd) || 0;
                        editado = true;
                    }
                }
            });
        });
    });

    if (editado) {
        // ESSENCIAL: Redesenha a tela para refletir a mudan√ßa no "carimbo"
        renderizarConferencia(); 
        
        // Feedback visual para o usu√°rio localizar onde editou
        setTimeout(() => {
            const el = document.getElementById(`card-${pendenciaId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.backgroundColor = "#e3f2fd"; // Pisca em azul claro
                setTimeout(() => { el.style.backgroundColor = "#fff"; }, 1000);
            }
        }, 300);
    } else {
        console.error("Erro: Pend√™ncia " + idProcurado + " n√£o encontrada nos dados.");
        alert("Erro ao salvar: N√£o foi poss√≠vel localizar o registro original para altera√ß√£o.");
    }
}
   function confirmarExclusaoRelato(pendenciaId, uid) {
    if (!confirm("Deseja realmente apagar esta pend√™ncia?")) return;

    const fonteDados = window.dadosConferencia || dadosConferencia;
    let excluido = false;
    
    // Convertemos para String para garantir que "TEMP-123" seja comparado corretamente
    const idProcurado = String(pendenciaId);

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            // Define os alvos (item ou lista de tombamentos)
            let alvos = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            
            alvos.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    // Buscamos o √≠ndice comparando as Strings brutas
                    const index = alvo.pendencias_ids.findIndex(p => String(p.id) === idProcurado);
                    
                    if (index > -1) {
                        alvo.pendencias_ids.splice(index, 1);
                        excluido = true;
                        
                        // Se n√£o houver mais nada relatado, o item volta a ser "pendente" (cinza)
                        if (alvo.pendencias_ids.length === 0) {
                            delete window.itemStatus[uid]; 
                        }
                    }
                }
            });
        });
    });

    if (excluido) {
        // ESSENCIAL: Redesenha a tela. Como o item sumiu do Array, 
        // a renderiza√ß√£o n√£o vai mais criar o carimbo.
        renderizarConferencia(); 
        updateOverallStatus();
        console.log("Sucesso: Relato tempor√°rio removido:", idProcurado);
    } else {
        console.error("N√£o localizei o ID:", idProcurado);
        alert("Erro: N√£o foi poss√≠vel localizar este carimbo para exclus√£o.");
    }
}
    
function salvarNovoID(uid, qtd, tipo, obsModal = null) {
    const obsDigitada = obsModal ? obsModal.trim() : "";
    const qtdInformada = parseInt(qtd) || 1;

    const militarInfoEl = document.getElementById('militar-info');
    let nomeAssinatura = "";
    if (militarInfoEl) {
        nomeAssinatura = militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim();
    }
    if (!nomeAssinatura) {
        nomeAssinatura = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    }

    const novoID = {
        id: "TEMP-" + Date.now(),
        tipo: "PENDENCIA",
        data_criacao: new Date().toLocaleDateString('pt-BR'),
        autor_uid: userInfo.uid,
        autor_nome: nomeAssinatura,
        descricao: obsDigitada,
        quantidade: qtdInformada,
        status_gestao: "PENDENTE"
    };

    let itemEncontrado = false;
    const fonteDados = window.dadosConferencia || dadosConferencia;

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            if (tipo === 'single' && String(item.id) === String(uid)) {
                if (!item.pendencias_ids) item.pendencias_ids = [];
                item.pendencias_ids.push(novoID);
                itemEncontrado = true;
            } else if (tipo === 'multi' && item.tombamentos) {
                item.tombamentos.forEach(t => {
                    if (String(`${item.id}-${t.tomb}`) === String(uid)) {
                        if (!t.pendencias_ids) t.pendencias_ids = [];
                        t.pendencias_ids.push(novoID);
                        itemEncontrado = true;
                    }
                });
            }
        });
    });

    if (itemEncontrado) {
        window.itemStatus[uid] = { status: 'C/A' };
        renderizarConferencia();
        setTimeout(() => {
            let el = document.querySelector(`[data-id="${uid}"]`) || document.querySelector(`.tombamento-container[data-tomb="${uid.split('-')[1]}"]`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.backgroundColor = "#fff9c4";
                setTimeout(() => { el.style.backgroundColor = ""; }, 1000);
            }
        }, 300);
    }
}

function manterID(pendenciaId, uid) {
    // 1. Inicializa o status do item na mem√≥ria se n√£o existir
    if (!window.itemStatus[uid]) {
        window.itemStatus[uid] = { status: 'pending' };
    }
    
    // 2. Inicializa o array de IDs mantidos
    if (!window.itemStatus[uid].ids_mantidos) {
        window.itemStatus[uid].ids_mantidos = [];
    }
    
    // 3. Adiciona o ID se ele ainda n√£o estiver na lista (evita duplicatas)
    if (!window.itemStatus[uid].ids_mantidos.includes(pendenciaId)) {
        window.itemStatus[uid].ids_mantidos.push(pendenciaId);
    }
    
    // 4. Marca o item como Conferido com Altera√ß√£o (C/A)
    window.itemStatus[uid].status = 'C/A';

    // 5. ESSENCIAL: Dispara a re-renderiza√ß√£o completa da tela
    // Isso far√° com que o montarPendenciaHtml veja o ID no array 'ids_mantidos'
    renderizarConferencia();
    
    // 6. Atualiza contadores globais e avan√ßos autom√°ticos
    updateOverallStatus();
    
    // Opcional: Feedback visual de scroll
    setTimeout(() => {
        const el = document.getElementById(`card-${pendenciaId}`);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function resolverID(pendenciaId, uid, qtdResolvidaModal, justificativaModal) {
    const qtdResolvida = parseInt(qtdResolvidaModal) || 1;
    const justificativa = justificativaModal ? justificativaModal.trim() : "";
    const nomeResolutor = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;

    const fonteDados = window.dadosConferencia || dadosConferencia;
    let acaoConcluida = false;

    function executarBaixaNoObjeto(obj) {
        if (!obj.pendencias_ids) return false;
        const index = obj.pendencias_ids.findIndex(p => p.id === pendenciaId);
        if (index === -1) return false;

        const pOriginal = obj.pendencias_ids[index];
        const qtdAnterior = pOriginal.quantidade;

        if (!obj.historico_vida) obj.historico_vida = [];
        
        const registroHistorico = {
            ...pOriginal,
            id_referencia: pOriginal.id,
            id: pOriginal.id + "-RES-" + Date.now(),
            quantidade: qtdResolvida,
            data_resolucao: new Date().toLocaleDateString('pt-BR'),
            resolvido_por: nomeResolutor,
            justificativa_resolucao: justificativa,
            status_final: "RESOLVIDO"
        };

        if (qtdResolvida >= qtdAnterior) {
            obj.pendencias_ids.splice(index, 1);
        } else {
            pOriginal.quantidade -= qtdResolvida;
            registroHistorico.justificativa_resolucao += " (Resolu√ß√£o Parcial)";
        }

        obj.historico_vida.push(registroHistorico);
        return true;
    }

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            if (String(item.id) === String(uid)) {
                acaoConcluida = executarBaixaNoObjeto(item);
            } else if (item.tombamentos) {
                item.tombamentos.forEach(t => {
                    if (String(`${item.id}-${t.tomb}`) === String(uid)) {
                        acaoConcluida = executarBaixaNoObjeto(t);
                    }
                });
            }
        });
    });

    if (acaoConcluida) {
        if (!window.itemStatus[uid]) window.itemStatus[uid] = {};
        window.itemStatus[uid].status = 'C/A';
        renderizarConferencia();
        updateOverallStatus();
        // --- ADICIONANDO O FOCO E SCROLL ---
        setTimeout(() => {
            // Procura o elemento pelo UID (ID do item ou ID-TOMB)
            let elItem = document.querySelector(`[data-id="${uid}"]`);
            
            // Se n√£o achou e for tombamento, procura pelo container do tombamento
            if (!elItem && uid.includes('-')) {
                elItem = document.querySelector(`.tombamento-container[data-id="${uid}"]`);
            }

            if (elItem) {
                elItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Destaque visual r√°pido
                elItem.style.backgroundColor = "#e8f5e9"; // Verde bem clarinho
                setTimeout(() => { elItem.style.backgroundColor = ""; }, 1000);
            }
        }, 300);
    }
}

function setItemStatusID(btn, status, uid) {
    const container = btn.closest('.tombamento-container') || btn.closest('.item-conferencia');
    const setor = btn.closest('.setor');

    // Inicializa o objeto se n√£o existir para evitar erros
    if (!window.itemStatus[uid]) window.itemStatus[uid] = {};

    if (status === 'ok') {
        window.itemStatus[uid] = { 
            ...window.itemStatus[uid], 
            status: 'S/A' 
        };

        container.querySelectorAll('.action-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const itemPai = btn.closest('.item-conferencia');
        const icon = container.querySelector('.status-icon');

        if (itemPai && itemPai.classList.contains('item-has-tombamentos')) {
            updateItemMainStatusDisplay(itemPai);
        } else if (icon) {
            icon.className = 'status-icon ok'; 
        }
    } else if (status === 'cautela_ciente') {
        window.itemStatus[uid] = { 
            ...window.itemStatus[uid], 
            status: 'cautela_ciente' 
        };
        
        btn.innerHTML = '<i class="fas fa-check"></i> Ciente registrado';
        btn.disabled = true;
        btn.style.backgroundColor = "#1b8a3e";
        
        setTimeout(() => {
            // SALVA SCROLL ANTES DE REDESENHAR
            const scrollPos = window.scrollY;
            renderizarConferencia();
            // RESTAURA SCROLL AP√ìS REDESENHAR
            window.scrollTo(0, scrollPos);
            updateOverallStatus();
        }, 400);
    }

    updateOverallStatus();

    if (setor) { 
        checkSetorCompletion(setor, uid);
    }
}
    window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
