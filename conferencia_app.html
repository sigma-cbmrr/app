    <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Confer√™ncia</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box; }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold; } 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333; text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        
        /* SETORES E ITENS */
        .setor-header { background-color: #800020; color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s; }
        .setor-info { display: flex; align-items: center; gap: 10px; }
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px; border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e; }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .arrow { font-size: 1.2em; transition: transform 0.4s; }
        
        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease; }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0; }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0; }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1; }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD; } 
        
        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold; font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '‚úì'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center; }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A'; font-size: 10px; line-height: 18px; color: white; display: block; text-align: center; }
        
        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e; } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        /* ESTILOS PEND√äNCIAS */
        .pendencia-alert-box { font-size: 0.85em; margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s; }
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd; }
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9; }
        
        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0; }
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left; line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none; }
        
        .texto-admin { font-weight: bold; color: #0d47a1; }
        .linha-obs { color: #333; font-weight: 500; }
        
        .pendencia-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px; }
        .btn-manter { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; } 
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        .historico-fixo { background-color: #eeeeee; border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none; }
        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left; padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .tombamento-options { display: flex; gap: 5px; } .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23; display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block; margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px; }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em; }
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px; border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px; }
        #finalizar-btn { 
            background-color: #d90f23;
            color: white; 
            font-weight: bold; 
            border: none; 
            padding: 15px 10px; 
            border-radius: 6px; 
            width: 100%; 
            cursor: pointer; 
            transition: background-color 0.3s ease;
            margin-top: 30px; 
            font-size: 1.1em; 
            box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4);
}
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; }
        
        .draft-badge { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Confer√™ncia de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><strong>Rascunho recuperado:</strong> Voc√™ est√° continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Inicializando sistema...</div>
        <div id="main-content" style="display: none;">
            <button id="finalizar-btn" onclick="isCautela ? finalizarCautela() : finalizarConferencia()">
                FINALIZAR CONFER√äNCIA
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const LISTA_ID = urlParams.get('id'); 
        const COLECAO_LISTAS = 'listas_conferencia';
        const CAUTELA_ID = urlParams.get('cautelaId');
        const COLECAO_CAUTELAS = 'cautelas_abertas';
        let dadosConferencia = [];
        let isCautela = !!CAUTELA_ID;
        let infoLocal = { nome: '', posto: '' }; window.itemStatus = {};

        function getUrlParameter(n) { return (new URLSearchParams(window.location.search)).get(n) || ''; }
        const userInfo = { postoGraduacao: getUrlParameter('posto_grad') || "ND", quadro: getUrlParameter('quadro_mil') || "ND", nomeGuerra: getUrlParameter('nome_guerra') || "ND" };

        function formatarDataSimples(timestamp) {
            if (!timestamp) return "";
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR'); 
        }

        function updateHeaderInfo() { 
            const el = document.getElementById('militar-info');
            if(el) el.innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`; 
        }

        function updateOverallStatus() { 
            let total = 0, completed = 0; 
            document.querySelectorAll('.setor').forEach(s => { 
                total += parseInt(s.dataset.totalItems || 0); 
                completed += parseInt(s.querySelector('.setor-status').dataset.completed || 0); 
            }); 
            const btn = document.getElementById('btn-finalizar'); 
            if(btn) {
                btn.textContent = `FINALIZAR CONFER√äNCIA (${completed}/${total} ITENS)`; 
                if (total > 0 && completed >= total) {
                    btn.disabled = false;
                    btn.style.backgroundColor = '#1b8a3e'; 
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.backgroundColor = '#d90f23'; 
                    btn.style.cursor = 'not-allowed';
                }
            }
        }

        function updateSetorStatus(setorEl) { 
            const items = setorEl.querySelectorAll('.item-conferencia'); 
            let completed = 0, total = 0; 
            items.forEach(item => { 
                if (item.dataset.type === 'single') { 
                    total++; const s = window.itemStatus[item.dataset.id]?.status; 
                    if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                } else { 
                    const tombs = item.querySelectorAll('.tombamento-container'); 
                    tombs.forEach(t => { 
                        total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                        if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                    }); 
                } 
            }); 
            setorEl.dataset.totalItems = total; 
            const st = setorEl.querySelector('.setor-status'); 
            st.dataset.completed = completed; 
            if (completed === total && total > 0) { st.textContent = 'OK'; st.classList.add('ok'); } 
            else { st.textContent = `${completed}/${total}`; st.classList.remove('ok'); } 
        }

        function updateItemMainStatusDisplay(item) { 
            if (item.dataset.type === 'single') return; 
            const tombs = item.querySelectorAll('.tombamento-container'); let conf = 0, alt = 0; 
            tombs.forEach(t => { 
                const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                if (s === 'S/A' || s === 'C/A' || s === 'KEEP') { conf++; if (s === 'C/A' || s === 'KEEP') alt++; } 
            }); 
            const icon = item.querySelector('.status-icon'); item.className = 'item-conferencia item-has-tombamentos'; icon.className = 'status-icon'; 
            if (conf === tombs.length) { 
                if (alt > 0) { icon.classList.add('alert'); item.classList.add('status-alert'); } 
                else { icon.classList.add('ok'); item.classList.add('status-ok'); } 
            } 
        }

        function toggleSetor(header) { 
            const content = header.nextElementSibling; const arrow = header.querySelector('.arrow'); 
            if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '‚ñ∫'; } 
            else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='‚ñ∫';}); content.classList.add('expanded'); arrow.textContent = '‚ñº'; } 
        }

        function checkSetorCompletion(currentSetor, currentItemId) { 
            const total = parseInt(currentSetor.dataset.totalItems); const comp = parseInt(currentSetor.querySelector('.setor-status').dataset.completed); 
            if (comp >= total) { autoAdvanceSetor(currentSetor.dataset.id); } else { focusNextItem(currentItemId); }
        }

        function focusNextItem(currentItemId) { 
            const allItems = Array.from(document.querySelectorAll('.item-conferencia')); 
            let baseId = currentItemId.split('-')[0]; 
            const idx = allItems.findIndex(i => i.dataset.id === baseId); 
            for (let i = idx; i < allItems.length; i++) { 
                const item = allItems[i]; if (!item) continue; const id = item.dataset.id; 
                if (item.dataset.type === 'single') { 
                    const st = window.itemStatus[id]; 
                    if (!st || st.status === 'pending' || st.status === 'PENDING_CA') { 
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        if (st && st.status === 'PENDING_CA') item.querySelector('textarea').focus(); return; 
                    } 
                } 
                if (item.dataset.type === 'multi') { 
                    const pendingTomb = Array.from(item.querySelectorAll('.tombamento-container')).find(t => { 
                        const uid = `${id}-${t.dataset.tomb}`; const s = window.itemStatus[uid]?.status; return s === 'pending' || s === 'PENDING_CA'; 
                    }); 
                    if (pendingTomb) { 
                        pendingTomb.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        const uid = `${id}-${pendingTomb.dataset.tomb}`; 
                        if (window.itemStatus[uid]?.status === 'PENDING_CA') pendingTomb.querySelector('textarea').focus(); return; 
                    } 
                } 
            } 
        }

        function autoAdvanceSetor(sid) { 
            const s = document.querySelector(`.setor[data-id="${sid}"]`); 
            if (s) toggleSetor(s.querySelector('.setor-header')); 
            const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1]; 
            if (nextId) { 
                const next = document.querySelector(`.setor[data-id="${nextId}"]`); 
                if (next) { const h = next.querySelector('.setor-header'); toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' }); } 
            } 
        }
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        function getStorageKey() { return `sigma_draft_${LISTA_ID}_${userInfo.nomeGuerra}`; }
        function salvarRascunho() { try { localStorage.setItem(getStorageKey(), JSON.stringify({ timestamp: Date.now(), status: window.itemStatus })); } catch (e) {} }
        function limparRascunho() { try { localStorage.removeItem(getStorageKey()); } catch (e) {} }

        const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            const linhas = [];
            if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
            const separator = ' | + NOVA: ';
            if (textoBruto.includes(separator)) {
                const partes = textoBruto.split(separator);
                partes.forEach(p => {
                    p = p.trim();
                    const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
                    if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
                    else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
                });
            } else {
                const p = textoBruto.trim();
                const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
                if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
                else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
            }
            return linhas;
        };
        const gerarHtmlVisual = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            const linhas = gerarLinhasFormatadas(textoBruto, autorAtual, dataAtual, adminStatus, adminObs);
            let html = '<ul class="lista-pendencias">';
            linhas.forEach(l => { if (l.includes('(Admin):')) { const parts = l.split('): '); html += `<li><span class="texto-admin">‚ö†Ô∏è ${parts[0]}):</span> Resp: ${parts[1]}</li>`; } else { html += `<li class="linha-obs">‚Ä¢ ${l}</li>`; } });
            html += '</ul>'; return html;
        };
        const montarHistoricoLinear = (obsAnterior, novoTexto, autorAnterior, dataAnterior) => {
    const separator = ' | + NOVA: ';
    
    // Este bloco lida com a adi√ß√£o a uma cadeia de observa√ß√µes
    if (obsAnterior.includes(separator)) {
        let partes = obsAnterior.split(separator); 
        let ultimaParte = partes.pop(); 
        let resto = partes.join(separator); 
        // Assina a √∫ltima parte n√£o assinada (o texto puro)
        let ultimaAssinada = `"${ultimaParte}" (Por: ${autorAnterior} em ${dataAnterior})`; 
        return `${resto}${separator}${ultimaAssinada}${separator}${novoTexto}`;
    } else { 
        // CORRE√á√ÉO: Este bloco √© ativado na primeira adi√ß√£o. 
        // Como 'obsAnterior' j√° est√° assinado pela fun√ß√£o salvarItem/salvarTombamento, 
        // apenas anexamos o novo texto com o separador, sem re-assinar.
        return `${obsAnterior}${separator}${novoTexto}`; 
    }
};

        function renderizarConferencia() {
    const mainContent = document.getElementById('main-content'); 
    const antigos = mainContent.querySelectorAll('.setor'); 
    antigos.forEach(el => el.remove());
    
    let htmlSetores = ''; 
    const setorIds = []; 
    dadosConferencia.forEach(s => setorIds.push(s.id)); 
    window.setorIds = setorIds;

    dadosConferencia.forEach((setor, index) => {
        const isFirstSetor = (index === 0); 
        let htmlItens = ''; 
        let totalItensNoSetor = 0;
        
        setor.itens.forEach(item => {
            
            // --- NOVO: L√ìGICA DE DETEC√á√ÉO DE CAUTELA ---
            const isCautelado = item.cautelas && item.cautelas.length > 0;
            
            const montarCarimboCautela = (cautelaInfo) => {
                if (!cautelaInfo) return '';
                // Se for array (itens single), pega o √∫ltimo carimbo
                const info = Array.isArray(cautelaInfo) ? cautelaInfo[cautelaInfo.length - 1] : cautelaInfo;
                if (!info || !info.destinatario) return '';
                
                return `<div class="historico-fixo" style="display:block; background-color:#ffccb2;">
                            <i class="fas fa-box-open" style="color:#d90f23;"></i> CAUTELADO para ${info.destinatario} em ${info.data}. Qtd: ${info.quantidade || 1}.
                        </div>`;
            };
            // ------------------------------------------

            const montarPendenciaHtml = (uid, pendenciaObj) => {
                if (!pendenciaObj) return '';
                const obs = pendenciaObj.obs ? pendenciaObj.obs.replace(/'/g, "\\'") : ''; 
                const quem = pendenciaObj.quem || 'An√¥nimo'; 
                const dataPend = formatarDataSimples(pendenciaObj.data);
                const dadosHistorico = JSON.stringify({ obs: obs, autor: quem, data: dataPend }); 
                const safeHistorico = encodeURIComponent(dadosHistorico);
                const htmlFormatado = gerarHtmlVisual(obs, quem, dataPend, pendenciaObj.statusAdmin, pendenciaObj.adminObs);
                let classAdmin = pendenciaObj.statusAdmin ? "admin-reply" : "";
                return `<div class="pendencia-alert-box ${classAdmin}">${htmlFormatado}<div class="pendencia-actions"><button class="btn-manter" onclick="manterPendencia(this, '${uid}')">‚úÖ Concordo (Manter)</button><button class="btn-acrescentar" onclick="acrescentarPendencia(this, '${uid}', '${safeHistorico}')">‚ûï Acrescentar</button></div></div>`;
            };
            
            if (item.tipo === 'multi' && item.tombamentos) {
                let htmlTombamentos = '';
                item.tombamentos.forEach(tomb => {
                    // Cautela para Tombamento (l√≥gica mais simples)
                    const tombCauteladoHtml = montarCarimboCautela(tomb.cautela);

                    const uid = `${item.id}-${tomb.tomb}`; 
                    const pendenciaHtml = montarPendenciaHtml(uid, tomb.pendencia);
                    
                    htmlTombamentos += `<div class="tombamento-container" data-tomb="${tomb.tomb}" data-item-id="${item.id}">
                        ${tombCauteladoHtml}
                        <div class="tombamento-controls">
                            <span>Tomb.: ${tomb.tomb}</span>
                            <div class="tombamento-options">
                                <button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button>
                                <button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button>
                            </div>
                        </div>
                        ${pendenciaHtml}
                        <p class="tombamento-descricao-salva"></p>
                        <div class="tombamento-obs-container">
                            <div class="historico-fixo" style="display:none;"></div>
                            <label>Descreva a altera√ß√£o:</label>
                            <textarea placeholder="Detalhe a altera√ß√£o."></textarea>
                            <button type="button" class="btn-salvar-alteracao" onclick="salvarTombamento(this)">SALVAR OBSERVA√á√ÉO</button>
                        </div>
                    </div>`;
                    totalItensNoSetor++; 
                    window.itemStatus[uid] = { status: 'pending', obs: '' };
                });
                
                htmlItens += `<div class="item-conferencia item-has-tombamentos" data-type="multi" data-total-tombamentos="${item.tombamentos.length}" data-status="pending" data-id="${item.id}">
                    <div class="item-header">
                        <span class="status-icon"></span>
                        <span class="item-label">${item.nome}</span>
                        <span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span>
                    </div>
                    ${htmlTombamentos}
                </div>`;
                
            } else {
                // Item Single
                let classExtra = ''; 
                if (item.pendencia) { 
                    if (item.pendencia.statusAdmin) classExtra = 'status-admin-response'; 
                    else classExtra = 'status-existing-alert'; 
                }
                const pendenciaHtml = montarPendenciaHtml(item.id, item.pendencia);
                
                // NOVO: Carimbo para item √∫nico (l√™ o array .cautelas)
                const cauteladoHtml = montarCarimboCautela(item.cautelas);
                
                htmlItens += `<div class="item-conferencia ${classExtra}" data-type="single" data-status="pending" data-id="${item.id}">
                    ${cauteladoHtml}
                    <div class="item-header">
                        <span class="status-icon"></span>
                        <span class="item-label">${item.nome}</span>
                        <span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span>
                    </div>
                    <div class="item-options">
                        <button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button>
                        <button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button>
                    </div>
                    ${pendenciaHtml}
                    <p class="descricao-salva"></p>
                    <div class="alteracao-container">
                        <div class="historico-fixo" style="display:none;"></div>
                        <label>Descreva a altera√ß√£o:</label>
                        <textarea data-id="${item.id}" placeholder="Descreva a altera√ß√£o."></textarea>
                        <button type="button" class="btn-salvar-alteracao" onclick="salvarItem(this)">SALVAR</button>
                    </div>
                </div>`;
                totalItensNoSetor++; 
                window.itemStatus[item.id] = { status: 'pending', obs: '' };
            }
        });
        
        const expandedClass = isFirstSetor ? 'expanded' : ''; 
        const arrowChar = isFirstSetor ? '‚ñº' : '‚ñ∫';
        
        htmlSetores += `<div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id}"><div class="setor-header" onclick="toggleSetor(this)"><div class="setor-info"><span>${setor.nome}</span><div class="setor-status" data-completed="0">0/${totalItensNoSetor}</div></div><span class="arrow">${arrowChar}</span></div><div class="setor-content ${expandedClass}">${htmlItens}</div></div>`;
    });
    
    // --- CORRE√á√ÉO DE ROBUSTEZ (RESOLVE O ERRO 'Cannot read properties of null') ---
    const targetEl = mainContent.querySelector('#finalizar-btn');

    if (targetEl) {
        // Se o bot√£o for encontrado, injeta os setores antes dele (padr√£o)
        targetEl.insertAdjacentHTML('beforebegin', htmlSetores);
    } else {
        // Fallback: anexa ao main-content se o bot√£o for nulo (evita crash)
        mainContent.insertAdjacentHTML('beforeend', htmlSetores);
        console.error("Erro de renderiza√ß√£o: Bot√£o FINALIZAR n√£o encontrado. Inserindo setores no final.");
    }
    // -----------------------------------------------------------------------------

    updateOverallStatus();
}

        function setItemStatus(btn, status) { 
            const item = btn.closest('.item-conferencia'); const setor = btn.closest('.setor'); 
            item.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
            item.querySelector('.descricao-salva').style.display='none'; item.querySelector('.alteracao-container').style.display='none'; 
            const pb=item.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if(status==='ok'){item.className='item-conferencia status-ok'; item.querySelector('.status-icon').className='status-icon ok'; window.itemStatus[item.dataset.id]={status:'S/A',obs:''};} 
            else {item.className='item-conferencia status-alert'; item.querySelector('.status-icon').className='status-icon alert'; item.querySelector('.alteracao-container').style.display='block'; window.itemStatus[item.dataset.id]={status:'PENDING_CA',obs:''}; item.querySelector('textarea').focus();} 
            salvarRascunho(); updateSetorStatus(setor); updateOverallStatus(); if(status==='ok')checkSetorCompletion(setor,item.dataset.id); 
        }

        function setTombamentoStatus(btn, status) { 
            const tomb = btn.closest('.tombamento-container'); const item = btn.closest('.item-conferencia'); const setor = btn.closest('.setor'); const uid=`${item.dataset.id}-${tomb.dataset.tomb}`; 
            tomb.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
            tomb.querySelector('.tombamento-obs-container').style.display='none'; tomb.querySelector('.tombamento-descricao-salva').style.display='none'; 
            const pb=tomb.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if(status==='ok'){window.itemStatus[uid]={status:'S/A',obs:''}; updateItemMainStatusDisplay(item);} 
            else {tomb.querySelector('.tombamento-obs-container').style.display='block'; window.itemStatus[uid]={status:'PENDING_CA',obs:''}; tomb.querySelector('textarea').focus(); updateItemMainStatusDisplay(item);} 
            salvarRascunho(); updateSetorStatus(setor); updateOverallStatus(); if(status==='ok')checkSetorCompletion(setor,item.dataset.id); 
        }

        function manterPendencia(btn, uid) { 
            const box = btn.closest('.pendencia-alert-box'); 
            if(box) { 
                box.querySelector('.pendencia-actions').style.display='none'; box.classList.add('kept'); 
                box.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e;font-weight:bold;font-size:0.9em;margin-top:5px;border-top:1px dashed #ccc;padding-top:3px;">‚úî Mantido</div>'); 
                window.itemStatus[uid]={status:'KEEP',obs:''}; salvarRascunho(); 
                const c = box.closest('.tombamento-container')||box.closest('.item-conferencia'); 
                const btnCA=c.querySelector('.ca-alert'); if(btnCA)btnCA.classList.add('active'); 
                const item = c.classList.contains('item-conferencia')?c:c.closest('.item-conferencia'); 
                if(c.classList.contains('tombamento-container'))updateItemMainStatusDisplay(item); 
                const setor=c.closest('.setor'); updateSetorStatus(setor); updateOverallStatus(); checkSetorCompletion(setor, item.dataset.id); 
            } 
        }

        function acrescentarPendencia(btn, uid, encodedData) { 
            const box = btn.closest('.pendencia-alert-box'); const container = box.closest('.tombamento-container')||box.closest('.item-conferencia'); box.style.display='none'; 
            if(container){ 
                const btnCA=container.querySelector('.ca-alert'); if(btnCA){btnCA.classList.add('active'); container.querySelector('.sa-ok').classList.remove('active');} 
                const edit=container.querySelector('.tombamento-obs-container')||container.querySelector('.alteracao-container'); edit.style.display='block'; 
                const hist=edit.querySelector('.historico-fixo'); hist.dataset.meta=encodedData; hist.style.display='none'; 
                edit.querySelector('textarea').value=''; edit.querySelector('textarea').focus(); window.itemStatus[uid]={status:'PENDING_CA',obs:''}; salvarRascunho(); 
            } 
        }

        function salvarItem(btn) { 
    const item=btn.closest('.item-conferencia'); 
    const obs=item.querySelector('textarea').value.trim(); 
    const hist=item.querySelector('.historico-fixo'); 
    let final=obs; 

    // Dados do usu√°rio e data atual para padroniza√ß√£o
    const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`; 
    const now=formatarDataSimples(new Date()); 

    if(hist && hist.dataset.meta) {
        // L√≥gica de Acrescentar (Quando h√° uma pend√™ncia anterior)
        if(obs.length < 3) return alert("Digite a altera√ß√£o."); 
        const meta=JSON.parse(decodeURIComponent(hist.dataset.meta)); 
        // Usa montarHistoricoLinear para manter o hist√≥rico formatado
        final=montarHistoricoLinear(meta.obs, obs, meta.autor, meta.data);
    } else {
        // L√≥gica de Nova Altera√ß√£o (Primeira ocorr√™ncia)
        if(obs.length < 3) return alert("Descreva a altera√ß√£o em detalhes (m√≠nimo 3 caracteres).");
        // üí° NOVO: Formata a PRIMEIRA observa√ß√£o com o padr√£o completo
        final = `"${obs}" (Por: ${conf} em ${now})`; 
    } 

    window.itemStatus[item.dataset.id]={status:'C/A',obs:final}; 
    item.querySelector('.alteracao-container').style.display='none'; 

    const d=item.querySelector('.descricao-salva'); 
    
    // O gerarHtmlVisual agora recebe a string 'final' j√° formatada.
    // Passamos 'null' para autor e data, pois o nome e data j√° est√£o embutidos em 'final'.
    d.innerHTML=gerarHtmlVisual(final, conf, now, null, null); 
    d.style.display='block'; 
    salvarRascunho(); 

    updateSetorStatus(btn.closest('.setor')); 
    updateOverallStatus(); 
    checkSetorCompletion(btn.closest('.setor'), item.dataset.id);
}

        function salvarTombamento(btn) { 
    const tomb=btn.closest('.tombamento-container'); 
    const item=btn.closest('.item-conferencia'); 
    const obs=tomb.querySelector('textarea').value.trim(); 
    const hist=tomb.querySelector('.historico-fixo'); 
    let final=obs; 

    [cite_start]// Dados do usu√°rio e data atual para padroniza√ß√£o [cite: 178]
    const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`; 
    const now=formatarDataSimples(new Date()); 

    if(hist && hist.dataset.meta) {
        [cite_start]// L√≥gica de Acrescentar (Quando h√° uma pend√™ncia anterior) [cite: 176]
        if(obs.length < 3) return alert("Digite a altera√ß√£o."); 
        const meta=JSON.parse(decodeURIComponent(hist.dataset.meta));
        [cite_start]// Usa montarHistoricoLinear para concatenar a nova observa√ß√£o [cite: 177]
        final=montarHistoricoLinear(meta.obs, obs, meta.autor, meta.data);
    } else {
        [cite_start]// L√≥gica de Nova Altera√ß√£o (Primeira ocorr√™ncia) [cite: 177]
        if(obs.length < 3) return alert("Descreva a altera√ß√£o em detalhes (m√≠nimo 3 caracteres).");
        // üí° NOVO: Formata a PRIMEIRA observa√ß√£o com o padr√£o completo
        final = `"${obs}" (Por: ${conf} em ${now})`; 
    } 

    window.itemStatus[`${item.dataset.id}-${tomb.dataset.tomb}`]={status:'C/A',obs:final}; 
    tomb.querySelector('.tombamento-obs-container').style.display='none'; 

    const d=tomb.querySelector('.tombamento-descricao-salva');
    
    [cite_start]// O gerarHtmlVisual agora recebe a string 'final' j√° formatada. [cite: 178]
    d.innerHTML=gerarHtmlVisual(final, conf, now, null, null); 
    d.style.display='block'; 
    salvarRascunho(); 

    updateItemMainStatusDisplay(item); 
    updateSetorStatus(btn.closest('.setor')); 
    updateOverallStatus(); 
    checkSetorCompletion(btn.closest('.setor'), item.dataset.id); 
}

        function restaurarRascunho() {
            const saved = localStorage.getItem(getStorageKey()); if (!saved) return;
            try {
                const parsed = JSON.parse(saved); window.itemStatus = parsed.status; 
                document.getElementById('draft-message').style.display = 'block';
                Object.keys(window.itemStatus).forEach(uid => {
                    const st = window.itemStatus[uid]; let container, isTombamento=false;
                    container = document.querySelector(`.item-conferencia[data-id="${uid}"]`);
                    if (!container) {
                        const allTombs = document.querySelectorAll('.tombamento-container');
                        for (let t of allTombs) { if (`${t.closest('.item-conferencia').dataset.id}-${t.dataset.tomb}` === uid) { container = t; isTombamento = true; break; } }
                    }
                    if (container) {
                        const btnSA=container.querySelector('.sa-ok'), btnCA=container.querySelector('.ca-alert');
                        if(btnSA)btnSA.classList.remove('active'); if(btnCA)btnCA.classList.remove('active');
                        const descEl = container.querySelector('.descricao-salva') || container.querySelector('.tombamento-descricao-salva');
                        
                        if (st.status === 'S/A') { if(btnSA)btnSA.classList.add('active'); if(!isTombamento) container.querySelector('.status-icon').className='status-icon ok'; }
                        else if (st.status === 'C/A' || st.status === 'KEEP') { 
                            if(btnCA)btnCA.classList.add('active'); 
                            if(!isTombamento) container.querySelector('.status-icon').className='status-icon alert'; 
                            if(descEl && st.status === 'C/A') {
                                const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
                                const now=formatarDataSimples(new Date());
                                descEl.innerHTML=gerarHtmlVisual(st.obs,conf,now,null,null); 
                                descEl.style.display='block';
                                const pendBox = container.querySelector('.pendencia-alert-box'); if(pendBox) pendBox.style.display = 'none';
                            } else if(st.status === 'KEEP') {
                                const pendBox = container.querySelector('.pendencia-alert-box');
                                if(pendBox) {
                                    pendBox.classList.add('kept'); pendBox.querySelector('.pendencia-actions').style.display='none';
                                    if(!pendBox.innerHTML.includes('‚úî Mantido')) pendBox.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e;font-weight:bold;font-size:0.9em;margin-top:5px;border-top:1px dashed #ccc;padding-top:3px;">‚úî Mantido</div>');
                                }
                            }
                        }
                        else if (st.status === 'PENDING_CA') {
                            const edit = container.querySelector('.tombamento-obs-container')||container.querySelector('.alteracao-container');
                            if(edit) edit.style.display='block';
                            if(btnCA) btnCA.classList.add('active');
                        }
                        if(isTombamento) updateItemMainStatusDisplay(container.closest('.item-conferencia'));
                    }
                });
                document.querySelectorAll('.setor').forEach(s => updateSetorStatus(s)); updateOverallStatus();
            } catch (e) { console.error("Erro restore", e); }
        }
        function adaptarCautelaParaRender(cautelaData) {
            if (!cautelaData.itens || cautelaData.itens.length === 0) return [];

            // Cria um setor √∫nico chamado "ITENS DA CAUTELA"
            const setorCautela = {
                id: cautelaData.cautela_id,
                nome: "ITENS CAUTELADOS",
                itens: cautelaData.itens.map(cItem => {
                    // Mapeia os dados da cautela para o formato esperado de um item de confer√™ncia
                    return {
                        id: cItem.id_completo || cItem.id_base, // Usa o ID completo (incluindo tombamento se multi)
                        nome: cItem.nome_completo,
                        quantidadeEsperada: cItem.quantidade,
                        // Define como 'single' ou 'multi' dependendo se tem um tombamento ID ou se a quantidade √© 1
                        tipo: cItem.tipo, 
                        // A cautela √© tratada como um item novo, ent√£o n√£o h√° 'pendencia' inicial.
                    };
                })
            };

            return [setorCautela]; // Retorna a lista encapsulada em um array de setores.
        }
        async function carregarDadosRemotos() {
            // Se for uma cautela, o ID base √© o CAUTELA_ID. Caso contr√°rio, √© o LISTA_ID.
            const ID_ALVO = isCautela ? CAUTELA_ID : LISTA_ID;
            const COLECAO_ALVO = isCautela ? COLECAO_CAUTELAS : COLECAO_LISTAS;
            
            if (!ID_ALVO) { document.getElementById('loading-message').innerHTML = "<span style='color:red'>Erro: ID n√£o encontrado.</span>";
                return; }
                
            document.getElementById('loading-message').innerHTML = "Conectando...";
            try {
                const doc = await db.collection(COLECAO_ALVO).doc(ID_ALVO).get();
                if (!doc.exists) throw new Error("Documento n√£o encontrado.");
                
                const data = doc.data(); 
                
                // Estrutura de dados: 
                // Se for Lista Mestra, usa data.list. 
                // Se for Cautela, a estrutura √© diferente e precisa ser adaptada para o renderizador.
                dadosConferencia = isCautela ? adaptarCautelaParaRender(data) : (data.list || []);
                
                // Informa√ß√µes do Local/T√≠tulo:
                const nomeLocal = isCautela ? `CAUTELA: ${CAUTELA_ID}` : (data.nome_local || "DESCONHECIDO");
                const postoLocal = isCautela ? `Destinat√°rio: ${data.destinatario}` : (data.posto || "Geral");
                
                infoLocal = { nome: nomeLocal, posto: postoLocal };
                
                document.getElementById('local-posto-info').innerHTML = `<span style="color:blue;font-weight:bold">${infoLocal.posto} - ${infoLocal.nome}</span>`;
                document.title = isCautela ? `Cautela - ${CAUTELA_ID}` : `Confer√™ncia - ${infoLocal.posto} ${infoLocal.nome}`;
                
                document.getElementById('loading-message').innerHTML = "Renderizando...";
                renderizarConferencia(); updateHeaderInfo(); updateOverallStatus(); restaurarRascunho();
                document.getElementById('loading-message').style.display='none'; document.getElementById('main-content').style.display='block';
            } catch (e) { document.getElementById('loading-message').innerHTML = "Erro: " + e.message;
            }
        }
        async function finalizarCautela() {
    const btn = document.getElementById('finalizar-btn');
    btn.disabled = true;
    btn.textContent = 'Finalizando Cautela...';

    const ID_ALVO = CAUTELA_ID; // CAUTELA-00000X
    const COLECAO_FINAL = COLECAO_CAUTELAS; // 'cautelas_abertas'

    if (!ID_ALVO) {
        alert("Erro: ID da Cautela n√£o encontrado.");
        btn.disabled = false;
        btn.textContent = 'FINALIZAR CONFER√äNCIA';
        return;
    }

    try {
        // 1. Processar os resultados da confer√™ncia
        const resultados = processarResultadosConferencia();
        if (resultados.itemsCount === 0) {
            alert("Nenhum item foi conferido. Por favor, confira os itens antes de finalizar.");
            btn.disabled = false;
            btn.textContent = 'FINALIZAR CONFER√äNCIA';
            return;
        }

        const cautelaRef = db.collection(COLECAO_FINAL).doc(ID_ALVO);

        // 2. Atualizar o documento da Cautela com os resultados (ESCRITA NO FIRESTORE)
        await cautelaRef.update({
            itens: resultados.itensRelatorio.map(item => ({
                id_completo: item.id_completo,
                id_base: item.id_base,
                nome: item.nomeCompleto, 
                quantidade: item.quantidadeEsperada,
                tipo: item.tipo,
                // Inclui o resultado da confer√™ncia
                status_conferido: item.status, 
                obs_conferido: item.observacoes,
                timestamp_conferencia: firebase.firestore.Timestamp.now(),
            })),
            totalItensConferidos: resultados.itemsCount,
            totalCaa: resultados.cA_count,
            conferente_destino: userInfo.nome_militar_completo, 
            status: 'CONCLU√çDA',
            timestamp_finalizacao: firebase.firestore.Timestamp.now()
        });
        
        // 3. Conclus√£o e Redirecionamento
        limparRascunho();
        
        alert(`‚úÖ Cautela ${ID_ALVO} finalizada com sucesso. Gerando PDF...`);
        
        // Redireciona para o Dashboard com o par√¢metro especial para gera√ß√£o de PDF
        const pdfUrl = `sigma_dashboard.html?pdfCautelaId=${ID_ALVO}`;
        window.location.href = pdfUrl;


    } catch (e) {
        console.error("Erro ao finalizar a Cautela:", e);
        alert(`Erro ao finalizar a cautela: ${e.message}`);
        btn.disabled = false;
        btn.textContent = 'FINALIZAR CONFER√äNCIA';
    }
}
        function processarResultadosConferencia() {
    let itensRelatorio = [];
    let itemsCount = 0;
    let cA_count = 0;
    
    // Vari√°veis de contexto para a confer√™ncia
    const p = userInfo;
    const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
    const clean = (val) => val === undefined ? null : val;

    dadosConferencia.forEach(setor => {
        setor.itens.forEach(item => {
            const process = (id, nome, pend) => {
                const s = window.itemStatus[id];
                if (s && s.status !== 'pending') {
                    itemsCount++;
                    
                    let finalStatus = s.status === 'KEEP' ? 'C/A' : s.status;
                    if (s.status === 'C/A' || s.status === 'KEEP') cA_count++;
                    let finalObs = s.obs;
                    
                    if (s.status === 'KEEP' && pend) finalObs = pend.obs;
                    if (s.status === 'S/A') finalObs = null;

                    const dadosItem = { 
                        nomeCompleto: nome, 
                        status: finalStatus, 
                        observacoes: finalObs, // Campo usado para salvar no Firestore
                        quantidadeEsperada: item.quantidadeEsperada || 1, 
                        id_completo: id,
                        id_base: id.split('-')[0], // Base para itens com tombamento
                        tipo: item.tipo,
                        
                        // Campos de Admin (se existirem)
                        statusAdmin: pend ? clean(pend.statusAdmin) : null,
                        adminObs: pend ? clean(pend.adminObs) : null,
                        setor: setor.nome
                    };
                    
                    itensRelatorio.push(dadosItem);
                }
            };
            
            // Processa itens multi e single
            if (item.tipo === 'multi' && item.tombamentos) item.tombamentos.forEach(t => process(`${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`, t.pendencia));
            else process(item.id, item.nome, item.pendencia);
        });
    });

    return {
        itemsCount,
        cA_count,
        itensRelatorio // Esta √© a lista detalhada para atualiza√ß√£o da cautela
    };
}
        function processarResultadosConferencia() {
    let itensRelatorio = [];
    let itemsCount = 0;
    let cA_count = 0;
    
    // Vari√°veis de contexto para a confer√™ncia
    const p = userInfo;
    const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
    const clean = (val) => val === undefined ? null : val;

    dadosConferencia.forEach(setor => {
        setor.itens.forEach(item => {
            const process = (id, nome, pend) => {
                const s = window.itemStatus[id];
                if (s && s.status !== 'pending') {
                    itemsCount++;
                    
                    let finalStatus = s.status === 'KEEP' ? 'C/A' : s.status;
                    if (s.status === 'C/A' || s.status === 'KEEP') cA_count++;
                    let finalObs = s.obs;
                    
                    if (s.status === 'KEEP' && pend) finalObs = pend.obs;
                    if (s.status === 'S/A') finalObs = null;

                    const dadosItem = { 
                        nomeCompleto: nome, 
                        status: finalStatus, 
                        observacoes: finalObs, // Campo usado para salvar no Firestore
                        quantidadeEsperada: item.quantidadeEsperada || 1, 
                        id_completo: id,
                        id_base: id.split('-')[0], // Base para itens com tombamento
                        tipo: item.tipo,
                        
                        // Campos de Admin (se existirem)
                        statusAdmin: pend ? clean(pend.statusAdmin) : null,
                        adminObs: pend ? clean(pend.adminObs) : null,
                        setor: setor.nome
                    };
                    
                    itensRelatorio.push(dadosItem);
                }
            };
            
            // Processa itens multi e single
            if (item.tipo === 'multi' && item.tombamentos) item.tombamentos.forEach(t => process(`${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`, t.pendencia));
            else process(item.id, item.nome, item.pendencia);
        });
    });

    return {
        itemsCount,
        cA_count,
        itensRelatorio // Esta √© a lista detalhada para atualiza√ß√£o da cautela
    };
}
        async function finalizarConferencia() {
    const btn = document.getElementById('finalizar-btn');
    const localNome = infoLocal.nome;
    
    // Constr√≥i a string de identifica√ß√£o do conferente
    const p = userInfo;
    const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
    
    let updated = false;

    if (!confirm(`Confirmar a finaliza√ß√£o da confer√™ncia para ${localNome}?`)) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Processando...';

    try {
        // 1. CHAMA A FUN√á√ÉO AUXILIAR PARA PROCESSAR OS RESULTADOS DA CONFER√äNCIA
        const resultados = processarResultadosConferencia();
        const { itemsCount, cA_count, itensRelatorio } = resultados;
        
        // Filtra o relat√≥rio para os itens C/A para o campo espec√≠fico do hist√≥rico
        let itensCaa = itensRelatorio.filter(i => i.status === 'C/A' || i.status === 'KEEP');

        if (itemsCount === 0) {
            alert("Nenhum item foi conferido. Por favor, confira os itens antes de finalizar.");
            btn.disabled = false;
            btn.textContent = 'FINALIZAR CONFER√äNCIA';
            return;
        }

        // 2. ATUALIZA√á√ÉO DO ESTADO DA LISTA MESTRA (dadosConferencia)
        // Este loop √© NECESS√ÅRIO para garantir que o campo 'pendencia' de CADA ITEM
        // da lista mestra seja atualizado em mem√≥ria antes de salvar no Firestore.
        
        dadosConferencia.forEach(setor => {
            setor.itens.forEach(item => {
                const clean = (val) => val === undefined ? null : val;
                
                const applyStatus = (id, pend) => {
                    const s = window.itemStatus[id];
                    if (s && s.status !== 'pending') {
                        updated = true;
                        
                        // Determina o status final para o campo 'pendencia' da lista mestra
                        const finalStatus = s.status === 'KEEP' ? 'C/A' : s.status;
                        let finalObs = s.obs;
                        
                        // Garante que a observa√ß√£o de KEEP (manter cautela) seja preservada
                        if (s.status === 'KEEP' && pend) finalObs = pend.obs;
                        if (s.status === 'S/A') finalObs = null;

                        pend = pend || {}; // Garante que pend√™ncia existe

                        // Aplica os dados da nova pend√™ncia
                        pend.status = finalStatus;
                        pend.obs = finalObs;
                        pend.conferente = conferente;
                        pend.timestamp = firebase.firestore.Timestamp.now();
                        pend.data = new Date().toISOString().split('T')[0];
                        
                        // Mant√©m os campos de Admin, se existirem
                        pend.statusAdmin = clean(pend.statusAdmin);
                        pend.adminObs = clean(pend.adminObs);
                    }
                };
                
                // Aplica o status de pend√™ncia (que modifica dadosConferencia)
                if (item.tipo === 'multi' && item.tombamentos) {
                    item.tombamentos.forEach(t => applyStatus(`${item.id}-${t.tomb}`, t.pendencia = t.pendencia || {}));
                } else {
                    applyStatus(item.id, item.pendencia = item.pendencia || {});
                }
            });
        });

        // 3. SALVAMENTO NO FIRESTORE
        
        // 3.1. Atualiza o ESTADO DA LISTA MESTRA (se houve mudan√ßa)
        if(updated) {
             await db.collection(COLECAO_LISTAS).doc(LISTA_ID).update({ 
                list: dadosConferencia,
                timestamp_ultima_conferencia: firebase.firestore.Timestamp.now(), 
             });
        }
        
        // 3.2. Cria o DOCUMENTO DE RESULTADO/RELAT√ìRIO (Hist√≥rico)
        // Mapeia o relat√≥rio final, adaptando o nome do campo 'observacoes' de volta para 'obs'
        await db.collection('resultados_conferencias').add({ 
            local: localNome, 
            lista_id: LISTA_ID, 
            conferente, 
            timestamp: firebase.firestore.Timestamp.now(), 
            totalItensConferidos: itemsCount, 
            totalCaa: cA_count, 
            itensCaa, 
            itensRelatorio: itensRelatorio.map(i => ({ 
                nomeCompleto: i.nomeCompleto, 
                status: i.status, 
                obs: i.observacoes, // Usa o campo que criamos no auxiliar
                quantidade: i.quantidadeEsperada, 
                id: i.id_completo,
                statusAdmin: i.statusAdmin,
                adminObs: i.adminObs,
                setor: i.setor
            }))
        });

        // 4. CONCLUS√ÉO E REDIRECIONAMENTO
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
        if (window.self === window.top) { 
            alert("‚úÖ Confer√™ncia finalizada com sucesso! Redirecionando..."); 
            window.location.href = "operacional.html"; 
        }

    } catch (e) {
        console.error("Erro ao finalizar a confer√™ncia:", e);
        alert(`Erro ao finalizar a confer√™ncia: ${e.message}`);
        btn.disabled = false;
        btn.textContent = 'FINALIZAR CONFER√äNCIA';
    }
}

        window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
