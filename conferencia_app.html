<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="sigma-comum.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box; }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold; } 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333; text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        
        /* SETORES E ITENS */
        .setor-header { background-color: #800020; color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s; }
        .setor-info { display: flex; align-items: center; gap: 10px; }
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px; border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e; }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .arrow { font-size: 1.2em; transition: transform 0.4s; }
        
        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease; }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0; }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0; }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1; }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD; } 
        
        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold; font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '‚úì'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center; }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A'; font-size: 10px; line-height: 18px; color: white; display: block; text-align: center; }
        
        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e; } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        /* ESTILOS PEND√äNCIAS */
        .pendencia-alert-box { font-size: 0.85em; margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s; }
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd; }
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9; }
        
        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0; }
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left; line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none; }
        
        .texto-admin { font-weight: bold; color: #0d47a1; }
        .linha-obs { color: #333; font-weight: 500; }
        .linha-obs i {display: block; padding-left: 20px; color: #444; font-style: italic; border-left: 2px solid #ddd; margin-top: 3px; }

        .pendencia-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px; }
        .btn-manter { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; } 
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        .historico-fixo { background-color: #eeeeee; border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none; }
        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left; padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .tombamento-options { display: flex; gap: 5px; } .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23; display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block; margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px; }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em; }
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px; border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px; }
        
        #btn-finalizar { background-color: #d90f23; color: white; font-weight: bold; border: none; padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease; margin-top: 30px; font-size: 1.1em; box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4); }
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; }
        .draft-badge { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Confer√™ncia de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><strong>Rascunho recuperado:</strong> Voc√™ est√° continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Inicializando sistema...</div>
        <div id="main-content" style="display: none;">
            <button id="btn-finalizar" onclick="finalizarConferencia()" disabled>
    FINALIZAR CONFER√äNCIA (0/X ITENS)
</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", 
        authDomain: "sigma-cbmrr.firebaseapp.com", 
        projectId: "sigma-cbmrr", 
        storageBucket: "sigma-cbmrr.firebasestorage.app", 
        messagingSenderId: "378026276038", 
        appId: "1:378026276038:web:620dd6ff57501b1a8313c7" 
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const LISTA_ID = urlParams.get('id');
    const COLECAO_LISTAS = 'listas_conferencia';
    const COLECAO_CAUTELAS = 'cautelas_abertas';
    
    let MODO_OPERACAO = 'recebimento'; 
    let DESTINATARIO_DEVOLUCAO = null; 
    
    const CAUTELA_ID = urlParams.get('cautelaId');
    const modoParam = urlParams.get('modo');
    const USER_UID = urlParams.get('user_uid');

    if (modoParam === 'devolucao') {
        MODO_OPERACAO = 'devolucao';
        DESTINATARIO_DEVOLUCAO = urlParams.get('destinatarioDevolucao');
    } else if (modoParam === 'devolucao_final') {
        MODO_OPERACAO = 'devolucao_final';
    }

    let dadosConferencia = [];
    let isCautela = !!CAUTELA_ID;
    let infoLocal = { nome: '', posto: '' }; 
    window.itemStatus = {};

    function getUrlParameter(n) { 
        return (new URLSearchParams(window.location.search)).get(n) || ''; 
    }
    
    const userInfo = { 
        postoGraduacao: getUrlParameter('posto_grad') || "ND", 
        quadro: getUrlParameter('quadro_mil') || "ND", 
        nomeGuerra: getUrlParameter('nome_guerra') || "ND",
        uid: USER_UID || "ND"
    };

    function formatarDataSimples(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('pt-BR');
    }

    function updateHeaderInfo() {
        const el = document.getElementById('militar-info');
        if(el) el.innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`;
    }

    function updateOverallStatus() {
        let total = 0, completed = 0;
        document.querySelectorAll('.setor').forEach(s => {
            total += parseInt(s.dataset.totalItems || 0);
            completed += parseInt(s.querySelector('.setor-status').dataset.completed || 0);
        });
        const btn = document.getElementById('btn-finalizar');
        
        let buttonPrefix = 'FINALIZAR CONFER√äNCIA';
        if (typeof MODO_OPERACAO !== 'undefined' && MODO_OPERACAO === 'devolucao') {
            buttonPrefix = 'FINALIZAR DEVOLU√á√ÉO';
        }
        
        if(btn) {
            btn.textContent = `${buttonPrefix} (${completed}/${total} ITENS)`;
            if (total > 0 && completed >= total) {
                btn.disabled = false;
                btn.style.backgroundColor = '#1b8a3e';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.backgroundColor = '#d90f23';
                btn.style.cursor = 'not-allowed';
            }
        }
    }

    function updateSetorStatus(setorEl) { 
        const items = setorEl.querySelectorAll('.item-conferencia'); 
        let completed = 0, total = 0; 
        items.forEach(item => { 
            if (item.dataset.type === 'single') { 
                total++; const s = window.itemStatus[item.dataset.id]?.status; 
                if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
            } else { 
                const tombs = item.querySelectorAll('.tombamento-container'); 
                tombs.forEach(t => { 
                    total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                    if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                }); 
            } 
        }); 
        setorEl.dataset.totalItems = total; 
        const st = setorEl.querySelector('.setor-status'); 
        st.dataset.completed = completed; 
        if (completed === total && total > 0) { st.textContent = 'OK'; st.classList.add('ok'); } 
        else { st.textContent = `${completed}/${total}`; st.classList.remove('ok'); } 
    }

    function updateItemMainStatusDisplay(item) { 
        if (item.dataset.type === 'single') return; 
        const tombs = item.querySelectorAll('.tombamento-container'); let conf = 0, alt = 0; 
        tombs.forEach(t => { 
            const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
            if (s === 'S/A' || s === 'C/A' || s === 'KEEP') { conf++; if (s === 'C/A' || s === 'KEEP') alt++; } 
        }); 
        const icon = item.querySelector('.status-icon'); item.className = 'item-conferencia item-has-tombamentos'; icon.className = 'status-icon'; 
        if (conf === tombs.length) { 
            if (alt > 0) { icon.classList.add('alert'); item.classList.add('status-alert'); } 
            else { icon.classList.add('ok'); item.classList.add('status-ok'); } 
        } 
    }

    function toggleSetor(header) { 
        const content = header.nextElementSibling; const arrow = header.querySelector('.arrow'); 
        if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '‚ñ∫'; } 
        else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='‚ñ∫';}); content.classList.add('expanded'); arrow.textContent = '‚ñº'; } 
    }

    function checkSetorCompletion(currentSetor, currentItemId) { 
        const total = parseInt(currentSetor.dataset.totalItems); const comp = parseInt(currentSetor.querySelector('.setor-status').dataset.completed); 
        if (comp >= total) { autoAdvanceSetor(currentSetor.dataset.id); } else { focusNextItem(currentItemId); }
    }

    function focusNextItem(currentItemId) { 
        const allItems = Array.from(document.querySelectorAll('.item-conferencia')); 
        let baseId = currentItemId.split('-')[0]; 
        const idx = allItems.findIndex(i => i.dataset.id === baseId); 
        for (let i = idx; i < allItems.length; i++) { 
            const item = allItems[i]; if (!item) continue; const id = item.dataset.id; 
            if (item.dataset.type === 'single') { 
                const st = window.itemStatus[id]; 
                if (!st || st.status === 'pending' || st.status === 'PENDING_CA') { 
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                    if (st && st.status === 'PENDING_CA') item.querySelector('textarea').focus(); return; 
                } 
            } 
            if (item.dataset.type === 'multi') { 
                const pendingTomb = Array.from(item.querySelectorAll('.tombamento-container')).find(t => { 
                    const uid = `${id}-${t.dataset.tomb}`; const s = window.itemStatus[uid]?.status; return s === 'pending' || s === 'PENDING_CA'; 
                }); 
                if (pendingTomb) { 
                    pendingTomb.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                    const uid = `${id}-${pendingTomb.dataset.tomb}`; 
                    if (window.itemStatus[uid]?.status === 'PENDING_CA') pendingTomb.querySelector('textarea').focus(); return; 
                } 
            } 
        } 
    }

    function autoAdvanceSetor(sid) { 
        const s = document.querySelector(`.setor[data-id="${sid}"]`); 
        if (s) toggleSetor(s.querySelector('.setor-header')); 
        const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1]; 
        if (nextId) { 
            const next = document.querySelector(`.setor[data-id="${nextId}"]`); 
            if (next) { const h = next.querySelector('.setor-header'); toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' }); } 
        } 
    }

    function getStorageKey() { return `sigma_draft_${LISTA_ID}_${userInfo.nomeGuerra}`; }
    function salvarRascunho() { try { localStorage.setItem(getStorageKey(), JSON.stringify({ timestamp: Date.now(), status: window.itemStatus })); } catch (e) {} }
    function limparRascunho() {
        localStorage.removeItem('sigma_active_conf');
        const listId = CAUTELA_ID || LISTA_ID;
        const userId = (userInfo && userInfo.nomeGuerra) ? userInfo.nomeGuerra.toUpperCase() : null;
        if (listId && userId) {
            const draftKey = `sigma_draft_${userId}_${listId}`; 
            localStorage.removeItem(draftKey);
        }
    }

    const gerarHtmlVisualApp = (pendencia, autorAtual, dataAtual) => {
        let html = '<ul class="lista-pendencias" style="list-style: none; padding: 0; margin: 5px 0;">';
        const lista = (pendencia && pendencia.pendencias_ca) ? pendencia.pendencias_ca : (Array.isArray(pendencia) ? pendencia : null);
        if (lista && Array.isArray(lista) && lista.length > 0) {
            lista.forEach(p => {
                const matchData = p.data ? p.data.match(/\d{2}\/\d{2}\/\d{4}/) : null;
                const dataApenas = matchData ? matchData[0] : (p.data || '');
                html += `<li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px;">
                            <span style="margin-right: 8px;">‚ö†Ô∏è</span><b>Por </b><span style="color: #d90f23; font-weight: bold;">${p.quem}</span><span> em <b>${dataApenas}</b>:</span>
                            <i style="margin-left: 5px; color: #333; font-weight: normal; display: block; padding-left: 25px;">${p.obs}</i></li>`;
            });
        } else if (pendencia && pendencia.obs && typeof pendencia.obs === 'string') {
            const militar = pendencia.quem || autorAtual || 'Militar';
            const dataFull = pendencia.data || dataAtual || '';
            const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
            const dataApenas = matchData ? matchData[0] : dataFull;
            html += `<li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem;">
                        <span style="margin-right: 8px;">‚ö†Ô∏è</span><b>Por </b><span style="color: #d90f23; font-weight: bold;">${militar}</span><span> em <b>${dataApenas}</b>:</span>
                        <i style="margin-left: 5px; color: #333; font-weight: normal;">${pendencia.obs}</i></li>`;
        }
        html += '</ul>'; return html;
    };

    function renderizarConferencia() {
        const mainContent = document.getElementById('main-content');
        const antigos = mainContent.querySelectorAll('.setor'); 
        antigos.forEach(el => el.remove());
        let htmlSetores = ''; const setorIds = []; 
        dadosConferencia.forEach(s => setorIds.push(s.id || s.nome));
        window.setorIds = setorIds;

        const montarPendenciaHtml = (uid, pendenciaObj) => {
            if (!pendenciaObj) return '';
            if (pendenciaObj.status === "CAUTELA_ATV") {
                return `<div class="pendencia-alert-box status-cautela" style="border-left: 3px solid #f57c00; background-color: #fff8e0; text-align: left;" data-status-type="cautela">
                            <div style="font-weight: bold; color: #f57c00; margin-bottom: 5px;"><i class="fas fa-boxes"></i> ${pendenciaObj.quem}</div>
                            <p style="margin: 0; font-size: 0.9em; white-space: pre-wrap;"><i class="fas fa-dot-circle" style="color: #f57c00; margin-right: 5px;"></i>${pendenciaObj.obs}</p></div>`;
            }
            const htmlFormatado = gerarHtmlVisualApp(pendenciaObj);
            const safeHistorico = encodeURIComponent(JSON.stringify(pendenciaObj));
            if (pendenciaObj.isReadOnly) {
                return `<div class="pendencia-alert-box" style="border-left: 3px solid #d32f2f; margin-top: 10px;">
                            <div style="font-weight: bold; color: #d32f2f; margin-bottom: 5px;"><i class="fas fa-history"></i> C/A ANTERIOR</div>${htmlFormatado}</div>`;
            } else {
                return `<div class="pendencia-alert-box">${htmlFormatado}<div class="pendencia-actions">
                            <button class="btn-manter" onclick="manterPendencia(this, '${uid}')">‚úÖ Concordo (Manter)</button>
                            <button class="btn-acrescentar" onclick="acrescentarPendencia(this, '${uid}', '${safeHistorico}')">‚ûï Acrescentar</button></div></div>`;
            }
        };

        dadosConferencia.forEach((setor, index) => {
            const isFirstSetor = (index === 0); let htmlItens = ''; let totalItensNoSetor = 0;
            setor.itens.forEach(item => {
                if (item.tipo === 'multi' && item.tombamentos) {
                    let htmlTombamentos = '';
                    item.tombamentos.forEach(tomb => {
                        const uid = `${item.id}-${tomb.tomb}`; let isCautelado = !!tomb.cautela;
                        let tombBtnHtml = isCautela ? `<button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button>` : 
                            (isCautelado ? `<button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'cautela_ciente')">Ciente</button>` : `<button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button>`);
                        let alertaCautelaHtml = (isCautelado && !isCautela) ? montarPendenciaHtml(uid, {obs: `CAUTELADO para ${tomb.cautela.destinatario} em ${tomb.cautela.data}`, quem: "Sistema/Cautela", status: "CAUTELA_ATV"}) : '';
                        htmlTombamentos += `<div class="tombamento-container" data-tomb="${tomb.tomb}"><div class="tombamento-controls"><span>Tomb.: ${tomb.tomb} ${isCautelado ? 'üîí' : ''}</span><div class="tombamento-options">${tombBtnHtml}</div></div>${alertaCautelaHtml}${montarPendenciaHtml(uid, tomb.pendencia)}<p class="tombamento-descricao-salva"></p>
                                            <div class="tombamento-obs-container"><div class="historico-fixo" style="display:none"></div><label>Descreva a NOVA altera√ß√£o:</label><textarea placeholder="Detalhe..."></textarea><button type="button" class="btn-salvar-alteracao" onclick="salvarTombamento(this)">SALVAR</button></div></div>`;
                        totalItensNoSetor++; window.itemStatus[uid] = { status: 'pending', obs: '' };
                    });
                    htmlItens += `<div class="item-conferencia" data-type="multi" data-id="${item.id}"><div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span></div>${htmlTombamentos}</div>`;
                } else {
                    let hasCautela = (item.cautelas && item.cautelas.length > 0);
                    let singleBtnHtml = isCautela ? `<button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button>` : 
                        (hasCautela ? `<button class="action-button sa-ok" onclick="setItemStatus(this, 'cautela_ciente')">Ciente</button><button class="action-button btn-acrescentar" onclick="setItemStatus(this, 'alert')">+ Altera√ß√£o</button>` : `<button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button>`);
                    htmlItens += `<div class="item-conferencia" data-type="single" data-id="${item.id}"><div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome} ${hasCautela ? 'üîí' : ''}</span><span class="item-quantidade">QTD: ${item.quantidadeEsperada || 1}</span></div><div class="item-options">${singleBtnHtml}</div>${montarPendenciaHtml(item.id, item.pendencia)}<p class="descricao-salva"></p>
                                    <div class="alteracao-container"><div class="historico-fixo" style="display:none"></div><label>Descreva a NOVA altera√ß√£o:</label><textarea placeholder="Detalhe..."></textarea><button type="button" class="btn-salvar-alteracao" onclick="salvarItem(this)">SALVAR</button></div></div>`;
                    totalItensNoSetor++; window.itemStatus[item.id] = { status: 'pending', obs: '' };
                }
            });
            const exp = isFirstSetor ? 'expanded' : ''; const arr = isFirstSetor ? '‚ñº' : '‚ñ∫';
            htmlSetores += `<div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id || setor.nome}"><div class="setor-header" onclick="toggleSetor(this)"><div class="setor-info"><span>${setor.nome}</span><div class="setor-status">0/${totalItensNoSetor}</div></div><span class="arrow">${arr}</span></div><div class="setor-content ${exp}">${htmlItens}</div></div>`;
        });
        const btnFin = document.getElementById('btn-finalizar');
        if (btnFin) btnFin.insertAdjacentHTML('beforebegin', htmlSetores);
        updateOverallStatus();
    }

    function setItemStatus(btn, status) { 
        const item = btn.closest('.item-conferencia'); const setor = btn.closest('.setor'); const uid = item.dataset.id;
        item.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
        item.querySelector('.descricao-salva').style.display='none'; item.querySelector('.alteracao-container').style.display='none';
        const pb = item.querySelector('.pendencia-alert-box'); 
        if (pb && pb.getAttribute('data-status-type') !== 'cautela') pb.style.display='none';
        if (status === 'cautela_ciente') {
            item.className = 'item-conferencia status-alert'; item.querySelector('.status-icon').className = 'status-icon alert';
            window.itemStatus[uid] = { status: 'KEEP', obs: '' }; if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
        } else if(status==='ok'){
            item.className='item-conferencia status-ok'; item.querySelector('.status-icon').className='status-icon ok';
            window.itemStatus[uid]={status:'S/A',obs:''}; if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'none';
        } else { 
            item.className='item-conferencia status-alert'; item.querySelector('.status-icon').className='status-icon alert'; 
            item.querySelector('.alteracao-container').style.display='block'; window.itemStatus[uid]={status:'PENDING_CA',obs:''};
            item.querySelector('textarea').focus(); if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
        } 
        salvarRascunho(); if(setor) updateSetorStatus(setor); updateOverallStatus(); 
        if((status==='ok' || status==='cautela_ciente') && setor) checkSetorCompletion(setor, uid);
    }

    function setTombamentoStatus(btn, status) { 
        const tomb = btn.closest('.tombamento-container'); const item = btn.closest('.item-conferencia'); const setor = btn.closest('.setor'); 
        const uid = `${item.dataset.id}-${tomb.dataset.tomb}`;
        tomb.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
        tomb.querySelector('.tombamento-obs-container').style.display='none'; tomb.querySelector('.tombamento-descricao-salva').style.display='none';
        const pb = tomb.querySelector('.pendencia-alert-box'); if (pb && pb.getAttribute('data-status-type') !== 'cautela') pb.style.display='none';
        if (status === 'cautela_ciente') {
            window.itemStatus[uid] = { status: 'KEEP', obs: '' }; if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
            updateItemMainStatusDisplay(item);
        } else if(status==='ok'){
            window.itemStatus[uid]={status:'S/A',obs:''}; if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'none';
            updateItemMainStatusDisplay(item);
        } else { 
            tomb.querySelector('.tombamento-obs-container').style.display='block'; window.itemStatus[uid]={status:'PENDING_CA',obs:''}; 
            tomb.querySelector('textarea').focus(); if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
            updateItemMainStatusDisplay(item);
        } 
        salvarRascunho(); updateSetorStatus(setor); updateOverallStatus(); 
        if(status==='ok' || status==='cautela_ciente') checkSetorCompletion(setor, item.dataset.id);
    }

    function manterPendencia(btn, uid) { 
        const box = btn.closest('.pendencia-alert-box');
        if(box) { 
            box.querySelector('.pendencia-actions').style.display='none'; box.classList.add('kept');
            box.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e;font-weight:bold;font-size:0.9em;margin-top:5px;border-top:1px dashed #ccc;padding-top:3px;">‚úî Mantido</div>'); 
            window.itemStatus[uid]={status:'KEEP',obs:''}; salvarRascunho(); 
            const c = box.closest('.tombamento-container')||box.closest('.item-conferencia'); 
            const btnCA=c.querySelector('.ca-alert'); if(btnCA)btnCA.classList.add('active'); 
            const item = c.classList.contains('item-conferencia')?c:c.closest('.item-conferencia'); 
            if(c.classList.contains('tombamento-container'))updateItemMainStatusDisplay(item);
            const setor=c.closest('.setor'); updateSetorStatus(setor); updateOverallStatus(); checkSetorCompletion(setor, item.dataset.id); 
        } 
    }

    function acrescentarPendencia(btn, uid, encodedData) { 
        const box = btn.closest('.pendencia-alert-box'); const container = box.closest('.tombamento-container') || box.closest('.item-conferencia'); 
        box.style.display = 'none'; 
        if (container) { 
            const edit = container.querySelector('.tombamento-obs-container') || container.querySelector('.alteracao-container'); edit.style.display = 'block'; 
            const hist = edit.querySelector('.historico-fixo'); if (hist) hist.dataset.meta = encodedData; 
            const textarea = edit.querySelector('textarea'); textarea.value = ''; textarea.focus(); 
            window.itemStatus[uid] = { status: 'PENDING_CA', meta_origem: encodedData }; salvarRascunho(); 
        } 
    }

    function salvarItem(btn) { 
        const item = btn.closest('.item-conferencia'); const containerEdit = item.querySelector('.alteracao-container');
        const obsDigitada = containerEdit.querySelector('textarea').value.trim(); const dataAtual = new Date().toLocaleDateString('pt-BR');
        const conferente = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`; const uid = item.dataset.id;
        if(obsDigitada.length < 3) return alert("Descreva a altera√ß√£o.");
        let listaAcumulada = []; const histFixo = containerEdit.querySelector('.historico-fixo'); const metaData = histFixo ? histFixo.dataset.meta : null;
        if (metaData && metaData !== "undefined" && metaData !== "") {
            try { const passado = JSON.parse(decodeURIComponent(metaData)); if (passado.pendencias_ca) listaAcumulada = [...passado.pendencias_ca];
            else if (passado.obs) listaAcumulada.push({ quem: passado.quem, data: passado.data, obs: passado.obs }); } catch (e) {}
        } 
        if (listaAcumulada.length === 0) {
            const itemOriginal = dadosConferencia.flatMap(s => s.itens).find(i => i.id === uid);
            if (itemOriginal && itemOriginal.pendencia) {
                if (itemOriginal.pendencia.pendencias_ca) listaAcumulada = [...itemOriginal.pendencia.pendencias_ca];
                else if (itemOriginal.pendencia.obs) listaAcumulada.push({ quem: itemOriginal.pendencia.quem, data: itemOriginal.pendencia.data, obs: itemOriginal.pendencia.obs });
            }
        }
        listaAcumulada.push({ quem: conferente, data: dataAtual, obs: obsDigitada });
        const novoObjeto = { status: 'C/A', pendencias_ca: listaAcumulada, obs: listaAcumulada.map(p => p.obs).join(' | ') };
        window.itemStatus[uid] = novoObjeto; containerEdit.style.display = 'none'; 
        const d = item.querySelector('.descricao-salva'); d.innerHTML = gerarHtmlVisualApp(novoObjeto); d.style.display = 'block'; 
        salvarRascunho(); updateSetorStatus(btn.closest('.setor')); updateOverallStatus(); 
    }

    function salvarTombamento(btn) { 
        const tomb = btn.closest('.tombamento-container'); const item = btn.closest('.item-conferencia'); const containerEdit = tomb.querySelector('.tombamento-obs-container');
        const obsDigitada = containerEdit.querySelector('textarea').value.trim(); const dataAtual = new Date().toLocaleDateString('pt-BR');
        const conferente = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`; const uid = `${item.dataset.id}-${tomb.dataset.tomb}`;
        if(obsDigitada.length < 3) return alert("Descreva a altera√ß√£o.");
        let listaAcumulada = []; const histFixo = containerEdit.querySelector('.historico-fixo'); const metaData = histFixo ? histFixo.dataset.meta : null;
        if (metaData && metaData !== "undefined" && metaData !== "") {
            try { const passado = JSON.parse(decodeURIComponent(metaData)); if (passado.pendencias_ca && Array.isArray(passado.pendencias_ca)) listaAcumulada = [...passado.pendencias_ca];
            else if (passado.obs) listaAcumulada.push({ quem: passado.quem, data: passado.data, obs: passado.obs }); } catch (e) {}
        } 
        if (listaAcumulada.length === 0) {
            const itemPai = dadosConferencia.flatMap(s => s.itens).find(i => i.id === item.dataset.id);
            if (itemPai && itemPai.tombamentos) {
                const tombOriginal = itemPai.tombamentos.find(t => t.tomb === tomb.dataset.tomb);
                if (tombOriginal && tombOriginal.pendencia) {
                    if (tombOriginal.pendencia.pendencias_ca) listaAcumulada = [...tombOriginal.pendencia.pendencias_ca];
                    else if (tombOriginal.pendencia.obs) listaAcumulada.push({ quem: tombOriginal.pendencia.quem, data: tombOriginal.pendencia.data, obs: tombOriginal.pendencia.obs });
                }
            }
        }
        listaAcumulada.push({ quem: conferente, data: dataAtual, obs: obsDigitada });
        const novoObjeto = { status: 'C/A', obs: listaAcumulada.map(p => p.obs).join(' | '), pendencias_ca: listaAcumulada };
        window.itemStatus[uid] = novoObjeto; containerEdit.style.display = 'none'; 
        const d = tomb.querySelector('.tombamento-descricao-salva'); if (d) { d.innerHTML = gerarHtmlVisualApp(novoObjeto); d.style.display = 'block'; }
        salvarRascunho(); updateItemMainStatusDisplay(item); updateSetorStatus(btn.closest('.setor')); updateOverallStatus();
    }

    async function finalizarConferencia() {
        const CURRENT_LIST_ID = LISTA_ID || CAUTELA_ID;
        const CONFERENTE_UID = userInfo.uid || ''; 
        if (isCautela) {
            if (MODO_OPERACAO === 'devolucao_final') { await finalizarRecebimentoDevolucao(); }
            else { await finalizarRecebimentoCautela(); } return;
        }
        const btn = document.getElementById('btn-finalizar'); if (btn.disabled) return;
        btn.textContent = "Salvando..."; btn.disabled = true;
        try {
            const p = userInfo; const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`; const localNome = `${infoLocal.posto} - ${infoLocal.nome}`;
            const dataAtualCompleta = new Date().toLocaleString('pt-BR'); const dataSomenteDia = dataAtualCompleta.split(',')[0];
            let updated = false; let itensRelatorio = []; let itensCaa = []; 
            dadosConferencia.forEach(setor => {
                setor.itens.forEach(item => {
                    const processarItemUnico = (itemOuTomb, id, nome) => {
                        const s = window.itemStatus[id]; if (!s || s.status === 'pending') return; 
                        if (!itemOuTomb.historico_vida) itemOuTomb.historico_vida = [];
                        let finalStatus = (s.status === 'KEEP' || s.status === 'C/A' || s.status === 'PENDING_CA') ? 'C/A' : 'S/A';
                        let listaPendenciasAtivas = [];
                        if (finalStatus === 'C/A') {
                            if (s.pendencias_ca && Array.isArray(s.pendencias_ca)) { listaPendenciasAtivas = [...s.pendencias_ca]; } 
                            else if (itemOuTomb.pendencia && itemOuTomb.pendencia.pendencias_ca) { listaPendenciasAtivas = [...itemOuTomb.pendencia.pendencias_ca]; } 
                            else if (itemOuTomb.pendencia && itemOuTomb.pendencia.obs) { listaPendenciasAtivas.push({ quem: itemOuTomb.pendencia.quem, data: itemOuTomb.pendencia.data, obs: itemOuTomb.pendencia.obs }); }
                            let obsRascunho = (s.obs && typeof s.obs === 'string') ? s.obs.trim() : "";
                            const textoAcumuladoNaLista = listaPendenciasAtivas.map(p => p.obs).join(' | ');
                            if (obsRascunho === textoAcumuladoNaLista || (listaPendenciasAtivas.length > 0 && obsRascunho === listaPendenciasAtivas[listaPendenciasAtivas.length -1].obs)) { obsRascunho = ""; }
                            if (obsRascunho !== "") {
                                listaPendenciasAtivas.push({ quem: conferente, data: dataSomenteDia, obs: obsRascunho });
                                itemOuTomb.historico_vida.push({ evento: "ALTERACAO_DETECTADA", quem: conferente, data: dataAtualCompleta, detalhes: obsRascunho });
                            }
                            const textoJoinFinal = listaPendenciasAtivas.map(p => p.obs).filter(o => o).join(' | ');
                            itemOuTomb.pendencia = { tipo: "C/A", pendencias_ca: listaPendenciasAtivas, obs: textoJoinFinal, quem: listaPendenciasAtivas[0]?.quem || conferente, data: listaPendenciasAtivas[0]?.data || dataSomenteDia };
                            updated = true;
                        } else if (s.status === 'S/A' && itemOuTomb.pendencia) {
                            itemOuTomb.historico_vida.push({ evento: "SANEAMENTO_ALTERACAO", quem: conferente, data: dataAtualCompleta, detalhes: "Item conferido como S/A." });
                            delete itemOuTomb.pendencia; updated = true;
                        }
                        const dadosParaRelatorio = { id: id, nomeCompleto: nome, status: finalStatus, pendencias_ca: listaPendenciasAtivas, obs: itemOuTomb.pendencia?.obs || '', quem: itemOuTomb.pendencia?.quem || '', data: itemOuTomb.pendencia?.data || '', quantidade: itemOuTomb.quantidade || (item.quantidadeEsperada || 1), setor: setor.nome };
                        itensRelatorio.push(dadosParaRelatorio); if (finalStatus === 'C/A') itensCaa.push(dadosParaRelatorio);
                    };
                    if (item.tipo === 'multi' && item.tombamentos) { item.tombamentos.forEach(t => processarItemUnico(t, `${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`)); }
                    else { processarItemUnico(item, item.id, item.nome); }
                });
            });
            if(updated) { await db.collection(COLECAO_LISTAS).doc(LISTA_ID).update({ list: dadosConferencia }); }
            await db.collection('resultados_conferencias').add({ local: localNome, lista_id: LISTA_ID, conferente_uid: CONFERENTE_UID, conferente: conferente, timestamp: firebase.firestore.Timestamp.now(), totalItensConferidos: itensRelatorio.length, totalCaa: itensCaa.length, itensCaa, itensRelatorio });
            const custodiaRef = db.collection('custodia_atual').doc(LISTA_ID);
            await custodiaRef.set({ lista_id: LISTA_ID, local_nome: localNome, conferente_uid: CONFERENTE_UID, conferente_completo: conferente, timestamp_ultima_conferencia: firebase.firestore.FieldValue.serverTimestamp() });
            limparRascunho(); window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
            if (window.self === window.top) { alert("Confer√™ncia finalizada!"); window.location.href = "operacional.html"; }
        } catch (e) { alert("Erro ao finalizar: " + e.message); btn.disabled = false; btn.textContent = "Finalizar Confer√™ncia"; }
    }

    async function finalizarRecebimentoCautela(cautelaData) {
    const btn = document.getElementById('btn-finalizar'); 
    btn.textContent = "PROCESSANDO..."; 
    btn.disabled = true;

    const meuUid = firebase.auth().currentUser.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    
    // üìÖ PADRONIZA√á√ÉO DE DATA DD/MM/AAAA
    const dataAtualCompleta = new Date().toLocaleString('pt-BR', { timeZone: 'America/Boa_Vista' });
    const dataSomenteDia = dataAtualCompleta.split(',')[0]; 
    
    const cautelaAtiva = cautelaData || { local_origem_id: urlParams.get('cautelaId') };

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(cautelaData.local_origem_id);

        await db.runTransaction(async (transaction) => {
            const cDoc = await transaction.get(cautelaRef);
            const lDoc = await transaction.get(listaMestraRef);
            if (!cDoc.exists || !lDoc.exists) throw new Error("Documentos n√£o encontrados.");
            
            const cData = cDoc.data(); 
            let listaMestra = lDoc.data().list; 
            const itensConferidos = [];

            cautelaData.itens.forEach(cItem => {
                const uidNaTela = `${cItem.id}-${cItem.tombamento || 'single'}`;
                const statusSelect = document.getElementById(`status-${uidNaTela}`);
                const obsFinal = document.getElementById(`obs-${uidNaTela}`)?.value.trim() || '';
                const statusFinal = statusSelect ? statusSelect.value : 'S/A';
                itensConferidos.push({ ...cItem, status_recebimento: statusFinal, obs_recebimento: obsFinal });

                listaMestra = listaMestra.map(setor => ({
                    ...setor, itens: setor.itens.map(mItem => {
                        if ((mItem.id_base || mItem.id) === (cItem.id_base || cItem.id)) {
                            // üõ°Ô∏è HERAN√áA DE DNA
                            let listaAcumulada = mItem.pendencia?.pendencias_ca ? [...mItem.pendencia.pendencias_ca] : [];
                            if (listaAcumulada.length === 0 && mItem.pendencia?.obs) { 
                                listaAcumulada.push({ quem: mItem.pendencia.quem || "Anterior", data: mItem.pendencia.data || "", obs: mItem.pendencia.obs }); 
                            }

                            if (statusFinal === 'C/A' && obsFinal !== '') { 
                                listaAcumulada.push({ quem: meuNomeCompleto, data: dataSomenteDia, obs: `[RECEBIMENTO] ${obsFinal}` }); 
                            }

                            if (listaAcumulada.length > 0) { 
                                mItem.pendencia = { tipo: "C/A", pendencias_ca: listaAcumulada, obs: listaAcumulada.map(p => p.obs).join(' | '), quem: listaAcumulada[0].quem, data: listaAcumulada[0].data }; 
                            }

                            const carimboPosse = { id: CAUTELA_ID, emitente: cData.emitente, destinatario: meuNomeCompleto, data: dataSomenteDia, status_item: statusFinal, obs_item: obsFinal };
                            if (cItem.tombamento) { 
                                mItem.tombamentos = mItem.tombamentos.map(t => t.tomb === cItem.tombamento ? { ...t, cautela: carimboPosse } : t); 
                            } else { 
                                if (!mItem.cautelas) mItem.cautelas = []; 
                                mItem.cautelas.push(carimboPosse); 
                            }
                        } return mItem;
                    })
                }));
            });
            transaction.update(cautelaRef, { status: 'RECEBIDA', timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(), itens: itensConferidos, militar_completo_receptor: meuNomeCompleto, destinatario: meuNomeCompleto, destinatario_uid: meuUid });
            transaction.update(listaMestraRef, { list: listaMestra });
        });
        alert(`‚úÖ Recebimento confirmado!`); 
        limparRascunho(); 
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
    } catch (e) { alert(`Erro: ${e.message}`); btn.disabled = false; }
}
    async function finalizarRecebimentoDevolucao(cautelaData) {
    const btn = document.getElementById('btn-finalizar'); 
    btn.textContent = "PROCESSANDO RETORNO..."; 
    btn.disabled = true;

    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    
    // üìÖ PADRONIZA√á√ÉO DE DATA DD/MM/AAAA (Igual √† anterior)
    const dataAtualCompleta = new Date().toLocaleString('pt-BR', { timeZone: 'America/Boa_Vista' });
    const dataSomenteDia = dataAtualCompleta.split(',')[0]; 

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(cautelaData.local_origem_id);

        await db.runTransaction(async (transaction) => {
            const cSnap = await transaction.get(cautelaRef); 
            const lSnap = await transaction.get(listaMestraRef);
            if (!cSnap.exists || !lSnap.exists) throw new Error("Documentos n√£o encontrados.");

            let listaMestra = lSnap.data().list; 
            const itensDevolvidos = [];

            cautelaData.itens.forEach(cItem => {
                const uidNaTela = `${cItem.id}-${cItem.tombamento || 'single'}`;
                const obsFinal = document.getElementById(`obs-${uidNaTela}`)?.value.trim() || '';
                const statusFinal = document.getElementById(`status-${uidNaTela}`)?.value || 'S/A';
                itensDevolvidos.push({ ...cItem, status_devolucao: statusFinal, obs_devolucao: obsFinal });

                listaMestra = listaMestra.map(setor => ({
                    ...setor, itens: setor.itens.map(mItem => {
                        if ((mItem.id_base || mItem.id) === (cItem.id_base || cItem.id)) {
                            // üõ°Ô∏è L√ìGICA ACUMULATIVA NO RETORNO
                            if (statusFinal === 'C/A') {
                                let listaAcumulada = mItem.pendencia?.pendencias_ca ? [...mItem.pendencia.pendencias_ca] : [];
                                listaAcumulada.push({ quem: meuNomeCompleto, data: dataSomenteDia, obs: `[RETORNO DEVOLU√á√ÉO] ${obsFinal}` });
                                mItem.pendencia = { tipo: "C/A", pendencias_ca: listaAcumulada, obs: listaAcumulada.map(p => p.obs).join(' | '), quem: listaAcumulada[0].quem, data: listaAcumulada[0].data };
                            } else { 
                                delete mItem.pendencia; 
                            }
                            
                            // üîì REMO√á√ÉO DO CADEADO
                            if (cItem.tombamento) { 
                                mItem.tombamentos = mItem.tombamentos.map(t => { if(t.tomb === cItem.tombamento) delete t.cautela; return t; }); 
                            } else { 
                                mItem.cautelas = (mItem.cautelas || []).filter(c => c.id !== CAUTELA_ID); 
                            }
                        } return mItem;
                    })
                }));
            });
            transaction.update(cautelaRef, { status: 'CONCLU√çDA', timestamp_conclusao: firebase.firestore.FieldValue.serverTimestamp(), receptor_final_completo: meuNomeCompleto, itens: itensDevolvidos });
            transaction.update(listaMestraRef, { list: listaMestra });
        });
        alert(`‚úÖ Devolu√ß√£o conclu√≠da! Material reintegrado.`); 
        limparRascunho(); 
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
    } catch (e) { alert(`Erro: ${e.message}`); btn.disabled = false; }
}

    window.onload = carregarDadosRemotos;
</script>
</body>
</html>
