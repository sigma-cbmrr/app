<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="sigma-comum.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
   /* 1. VARI√ÅVEIS E RESET MODERNO */
    :root {
        --vinho: #800020;
        --petroleo: #2c3e50;
        --sucesso: #1b8a3e;
        --alerta: #d90f23;
        --header-h: 70px;
        --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body { 
        font-family: 'Inter', sans-serif; 
        background: #f1f5f9; 
        margin: 0; padding: 0;
        height: 100vh; width: 100vw;
        overflow: hidden; /* Trava o scroll global para o slider funcionar */
    }

    /* 2. HEADER HUD (DISCRETO E FIXO NO TOPO) */
    .v3-header-hud {
        position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
        background: white; border-bottom: 1px solid #e2e8f0;
        display: flex; align-items: center; padding: 0 15px;
        z-index: 1000; box-sizing: border-box;
    }

    .v3-hud-content { display: flex; align-items: center; gap: 12px; flex: 1; }
    .v3-hud-avatar { 
        width: 40px; height: 40px; border-radius: 10px; 
        background: var(--vinho); color: white;
        display: flex; align-items: center; justify-content: center; font-size: 1.2em;
    }
    .v3-hud-data { line-height: 1.2; }
    .v3-hud-data strong { display: block; font-size: 0.85em; color: #1e293b; text-transform: uppercase; }
    .v3-hud-data small { font-size: 0.7em; color: #64748b; font-weight: 600; }

    /* Barra de Progresso Neon Fina */
    .v3-hud-progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: #f1f5f9; }
    .v3-hud-progress-fill { height: 100%; width: 0%; background: var(--sucesso); box-shadow: 0 0 10px var(--sucesso); transition: width 0.5s ease; }

    /* 3. SISTEMA DE SLIDER (M√ÅQUINA DE ESTADOS) */
    .main-viewport {
        display: flex;
        width: 200vw; /* Duas telas de largura */
        height: calc(100vh - var(--header-h));
        margin-top: var(--header-h);
        transition: transform var(--transition);
    }

    /* TELA 1: LISTA DE SETORES */
    #tela-setores { width: 100vw; height: 100%; overflow-y: auto; padding: 15px; box-sizing: border-box; }
    
    /* TELA 2: LISTA DE ITENS */
    #tela-itens { width: 100vw; height: 100%; overflow-y: auto; padding: 15px; box-sizing: border-box; background: #f8fafc; }

    /* ESTADO: Quando um setor √© clicado, o viewport desliza */
    body.modo-inspecao .main-viewport { transform: translateX(-100vw); }

    /* 4. CARDS FINOS DE SETOR (TELA 1) */
    .v3-setor-row {
        background: white; border-radius: 12px; padding: 16px;
        margin-bottom: 10px; border: 1px solid #e2e8f0;
        display: flex; align-items: center; justify-content: space-between;
        cursor: pointer; transition: 0.2s;
    }
    .v3-setor-row:active { transform: scale(0.97); background: #f8fafc; }
    .v3-setor-label { display: flex; flex-direction: column; gap: 4px; }
    .v3-setor-label strong { font-size: 0.95em; color: #1e293b; letter-spacing: -0.3px; }
    .v3-setor-badges { display: flex; gap: 6px; }
    .badge-mini { font-size: 0.6em; font-weight: 900; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
    .badge-total { background: #f1f5f9; color: #64748b; }
    .badge-alerta { background: #fff1f2; color: var(--alerta); }
    .v3-setor-row i { color: #cbd5e1; font-size: 0.8em; }

    /* 5. BOT√ÉO VOLTAR FLUTUANTE (TELA 2) */
    .v3-btn-voltar {
        position: fixed; bottom: 25px; left: 20px;
        background: var(--petroleo); color: white;
        border: none; padding: 12px 20px; border-radius: 50px;
        font-weight: 800; font-size: 0.8em; z-index: 1100;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        display: none; align-items: center; gap: 8px;
    }
    body.modo-inspecao .v3-btn-voltar { display: flex; }

    /* 6. BOT√ÉO FINALIZAR (TELA 1) */
    #btn-finalizar-v3 {
        width: calc(100% - 30px); margin: 20px 15px;
        padding: 18px; border-radius: 15px; border: none;
        background: var(--sucesso); color: white; font-weight: 900;
        box-shadow: 0 10px 20px rgba(27, 138, 62, 0.3);
        cursor: pointer; text-transform: uppercase;
    }
    #btn-finalizar-v3:disabled { background: #cbd5e1; box-shadow: none; opacity: 0.7; }
   /* 1. CONTAINER DE ITENS (TELA 2) */
    .v3-item-row {
        background: white;
        border-radius: 14px;
        padding: 12px 16px;
        margin-bottom: 8px;
        border: 1px solid #e2e8f0;
        display: grid;
        grid-template-columns: 1fr 100px; /* Coluna 1 (Maior) | Coluna 2 (Bot√µes) */
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
    }

    /* Feedback de Status no Card */
    .v3-item-row.status-ok { border-left: 6px solid var(--sucesso); background: #f0fdf4; }
    .v3-item-row.status-alert { border-left: 6px solid var(--alerta); background: #fff1f2; }

    /* 2. COLUNA 1: IDENTIFICA√á√ÉO */
    .v3-item-main-info { display: flex; flex-direction: column; gap: 2px; }
    .v3-item-name { 
        font-weight: 800; color: #0f172a; font-size: 0.9em; 
        text-transform: uppercase; letter-spacing: -0.3px; 
    }
    .v3-item-subtext { 
        font-size: 0.75em; color: #64748b; font-weight: 600; 
    }
    .v3-item-subtext b { color: var(--vinho); }

    /* 3. COLUNA 2: BOT√ïES DE A√á√ÉO (ESTILO FAB CIRCULAR) */
    .v3-item-actions { 
        display: flex; flex-direction: column; gap: 8px; align-items: flex-end; 
    }

    .v3-btn-circle {
        width: 42px; height: 42px; border-radius: 50%; border: none;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1em; cursor: pointer; transition: 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    /* Bot√£o S/A (Check) */
    .btn-check { background: #f1f5f9; color: #94a3b8; }
    .btn-check.active { background: var(--sucesso); color: white; }

    /* Bot√£o Alerta (+ALT) */
    .btn-alert { background: #f1f5f9; color: #94a3b8; }
    .btn-alert.active { background: var(--alerta); color: white; animation: pulse-red 2s infinite; }

   /*bo√µes do modal de altera√ß√µes*/
   .v3-btn-sheet {
    width: 100%; margin-bottom: 10px; padding: 15px;
    border-radius: 10px; border: none; color: white;
    font-weight: 800; font-size: 0.85em; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    transition: 0.2s;
   }
   .v3-btn-sheet:active { transform: scale(0.96); opacity: 0.8; }
   .swal2-container {
      z-index: 30000 !important;
   }

   /* Corrige o vazamento horizontal do textarea no mobile */
   .swal2-textarea {
       box-sizing: border-box !important;
       max-width: 100% !important;
       margin: 10px 0 !important;
   }

   /* Oculta o scroll horizontal do body quando o modal estiver aberto (opcional, mas recomendado) */
   body.swal2-shown {
      overflow: hidden !important;
   }

   /*carimbos na sess√£o atual*/
   .v3-carimbos-container {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
   }

   .v3-mini-carimbo {
      font-size: 0.7em;
      padding: 4px 8px;
      border-radius: 6px;
      line-height: 1.3;
      display: block;
      border-left: 3px solid transparent;
   }

   /* Cor para rascunhos da sess√£o atual (Azul) */
   .v3-mini-carimbo.cor-temp {
      background: #f0f9ff;
      color: #0369a1;
      border-color: #0ea5e9;
   }

   /* Cor para pend√™ncias vindas do banco (Vermelho) */
   .v3-mini-carimbo.cor-pend {
      background: #fff1f2;
      color: #9f1239;
      border-color: #f43f5e;
   }

   .v3-mini-carimbo b { font-weight: 800; text-transform: uppercase; }
   .v3-mini-carimbo .badge-qtd { 
      font-weight: 900; 
      float: right; 
      background: rgba(0,0,0,0.05); 
      padding: 0 4px; 
      border-radius: 4px; 
   }
   
   /* 4. MODAIS E ANIMA√á√ïES */
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(217, 15, 35, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(217, 15, 35, 0); }
        100% { box-shadow: 0 0 0 0 rgba(217, 15, 35, 0); }
    }

    /* Ajuste para o bot√£o de alerta √∫nico (quando h√° carimbo) */
    .v3-item-row.has-carimbo .btn-check { display: none; }
    .v3-item-row.has-carimbo .v3-item-actions { justify-content: center; }
</style>
</head>
<body>
<body>
   <header class="v3-header-hud">
    <div class="v3-hud-content">
        <div class="v3-hud-avatar" id="militar-avatar">
            <i class="fas fa-user-shield"></i>
        </div>
        <div class="v3-hud-data">
            <strong id="militar-nome-hud">Carregando...</strong>
            <small id="local-titulo-hud">Sincronizando Data/Hora...</small>
        </div>
    </div>
    <div class="v3-hud-progress-container">
        <div id="overall-progress-bar" class="v3-hud-progress-fill"></div>
    </div>
</header>

<div id="main-viewport" class="main-viewport" style="display: none;">
    
    <section id="tela-setores" class="tela-setores">
        <div class="v3-info-extra" style="margin-bottom: 20px; padding: 10px; background: #fff; border-radius: 10px; font-size: 0.8em; color: #64748b;">
             <i class="fas fa-info-circle"></i> Selecione um setor para iniciar a confer√™ncia.
        </div>
        
        <div id="lista-setores-container"></div>

        <button id="btn-finalizar" class="v3-btn-main" style="margin-top: 30px; width: 100%;" disabled>
            <i class="fas fa-lock"></i> AGUARDANDO ITENS
        </button>
    </section>

    <section id="tela-itens" class="tela-itens">
        <div id="header-setor-ativo" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <h2 id="nome-setor-atual" style="margin:0; font-size: 1.2em; color: var(--vinho);">Setor</h2>
            <span id="progresso-setor-atual" class="badge-mini badge-total">0/0</span>
        </div>

        <div id="lista-itens-container"></div>
    </section>

</div>

<button class="v3-btn-voltar" id="btn-voltar-setores" onclick="navegarParaSetores()">
    <i class="fas fa-chevron-left"></i> VOLTAR AOS SETORES
</button>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
   
   const firebaseConfig = { 
        apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", 
        authDomain: "sigma-cbmrr.firebaseapp.com", 
        projectId: "sigma-cbmrr", 
        storageBucket: "sigma-cbmrr.firebasestorage.app", 
        messagingSenderId: "378026276038", 
        appId: "1:378026276038:web:620dd6ff57501b1a8313c7" 
    };
   
   window.infoLocal = { nome: "Sincronizando...", posto: "" };
   window.userInfo = window.userInfo || {};
   window.isModoChecklist = false;
   window.itemStatus = {};
   
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- INICIALIZA√á√ÉO DE VARI√ÅVEIS E PAR√ÇMETROS DA URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const listaId = urlParams.get('id');
    
    // ‚úÖ CORRE√á√ÉO: Captura o ID e verifica se precisa do prefixo CHECKLIST_VTR_
    let rawID = urlParams.get('id');
    const modoUrl = urlParams.get('modo');
    if (modoUrl === 'checklist_vtr' && rawID && !rawID.startsWith('CHECKLIST_VTR_')) {
        rawID = 'CHECKLIST_VTR_' + rawID;
    }

    const LISTA_ID = rawID;
    const CAUTELA_ID = urlParams.get('cautelaId');
    const COLECAO_CAUTELAS = 'cautelas_abertas';
    
    // ‚úÖ DEFINI√á√ÉO DIN√ÇMICA DA COLE√á√ÉO DE LISTAS
    window.isModoChecklist = (modoUrl === 'checklist_vtr') || (LISTA_ID && LISTA_ID.startsWith('CHECKLIST_VTR_'));
    const COLECAO_LISTAS = window.isModoChecklist ? 'listas_checklist' : 'listas_conferencia';
    
    let MODO_OPERACAO = modoUrl || 'recebimento'; 
    let DESTINATARIO_DEVOLUCAO = urlParams.get('destinatarioDevolucao'); 

    // ‚úÖ CORRE√á√ÉO: Captura Posto/Gradua√ß√£o e Quadro direto da URL para evitar o "ND"
   window.userInfo = { 
    postoGraduacao: urlParams.get('posto_grad') || "ND", 
    quadro: urlParams.get('quadro') || "ND", 
    nomeGuerra: urlParams.get('nome_guerra') || "ND",
    uid: urlParams.get('user_uid') || "ND"
};
   function navegarParaItens() {
    document.body.classList.add('modo-inspecao');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function navegarParaSetores() {
    document.body.classList.remove('modo-inspecao');
    // Recarrega a confer√™ncia para atualizar os badges de progresso na Tela 1
    renderizarConferencia();
}

// --- REDIRECIONAMENTO DE DADOS PARA O HUD ---

function updateHeaderInfo() {
    const elListaNome = document.getElementById('militar-nome-hud'); // Destaque (Linha 1)
    const elApoioInfo = document.getElementById('local-titulo-hud'); // Apoio (Linha 2)
    const elAvatar = document.getElementById('militar-avatar');
    
    if (!elListaNome || !elApoioInfo) return;

    // 1. DEFINI√á√ÉO DE CORES E √çCONE POR MODO
    const isChecklist = window.isModoChecklist;
    const isCarga = (new URLSearchParams(window.location.search)).get('modo') === 'recebimento_carga';
    
    let corHUD = "#800020"; // Bord√¥ (Padr√£o)
    let iconeHUD = "fa-clipboard-list";

    if (isChecklist) {
        corHUD = "#2c3e50"; // Azul Petr√≥leo (Vistoria)
        iconeHUD = "fa-truck-moving";
    } else if (isCarga) {
        corHUD = "#000000"; // Preto (Carga)
        iconeHUD = "fa-exchange-alt";
    }

    // 2. FORMATA√á√ÉO DOS DADOS DE EXIBI√á√ÉO
    // Destaque: ABT-18 | BRAVO
    const nomeLista = infoLocal.nome || "LISTA";
    const nomePosto = infoLocal.posto ? ` | ${infoLocal.posto}` : "";
    const destaquePrincipal = `${nomeLista}${nomePosto}`;

    // Apoio: Data e Hora atual da sess√£o
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR');
    const horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    const apoioTexto = `${dataFormatada} √†s ${horaFormatada}`;

    // 3. ATUALIZA√á√ÉO DA INTERFACE (HUD)
    elListaNome.textContent = destaquePrincipal; 
    elApoioInfo.textContent = apoioTexto;       
    
    // Atualiza √≠cone e cores institucionais no Avatar lateral
    if (elAvatar) {
        elAvatar.style.background = corHUD;
        elAvatar.innerHTML = `<i class="fas ${iconeHUD}"></i>`;
    }

    // Mant√©m a barra neon de progresso no topo sincronizada com o modo
    const progressFill = document.getElementById('overall-progress-bar');
    if (progressFill) {
        progressFill.style.background = corHUD;
        progressFill.style.boxShadow = `0 0 10px ${corHUD}`;
    }
}
// --- VERIFICADOR M√ÅGICO DE FLUXO (AUTO-NEXT) ---

function verificarFluxoSetor(uidAtual) {
    const rows = Array.from(document.querySelectorAll('.v3-item-row'));
    const index = rows.findIndex(r => r.id === `item-row-${uidAtual}`);
    const nextRow = rows[index + 1];

    if (nextRow) {
        // Se houver pr√≥ximo item, rola suavemente
        setTimeout(() => {
            nextRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            nextRow.style.background = "#f0f9ff"; // Destaque azul claro moment√¢neo
            setTimeout(() => nextRow.style.background = "", 800);
        }, 400);
    } else {
        // Se for o √∫ltimo, avisa e volta para a vis√£o geral
        const Toast = Swal.mixin({
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'success',
            title: 'Setor Finalizado!'
        });

        setTimeout(() => {
            navegarParaSetores();
        }, 1500);
    }
}

    let dadosConferencia = [];
    let isCautela = !!CAUTELA_ID;
    let infoLocal = { nome: '', posto: '' }; 
    window.itemStatus = {};

   // ‚úÖ AJUSTE V3: Captura limpa e decodificada de par√¢metros da URL
function getUrlParameter(n) { 
    const params = new URLSearchParams(window.location.search);
    const value = params.get(n);
    // Retorna o valor decodificado ou uma string vazia, evitando "null" na interface
    return value ? decodeURIComponent(value) : ''; 
}

    function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    // Retorna no padr√£o Brasileiro sem horas, conforme exigido em relat√≥rios de carga
    return date.toLocaleDateString('pt-BR');
}

    function updateOverallStatus() {
    // 1. MAPEAMENTO DE DADOS (INDEPENDENTE DA TELA ATIVA)
    const fonteDados = window.dadosConferencia || [];
    const isChecklist = window.isModoChecklist; 
    let totalItensObrigatorios = 0; // Itens que PRECISAM de confer√™ncia
    let concluidosGeral = 0;

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            // ‚úÖ EXCE√á√ÉO: Ignora o item de foto na contagem de obrigatoriedade global
            if (item.tipo === 'upload_foto') return;

            const uid = isChecklist ? item.id : (item.uid_global || item.id);
            const status = window.itemStatus[uid];
            
            totalItensObrigatorios++;
            
            if (status && (status.status === 'ok' || status.status === 'C/A' || status.cautela_confirmada)) {
                concluidosGeral++;
            }
        });
    });

    const todosConcluidos = totalItensObrigatorios > 0 && concluidosGeral === totalItensObrigatorios;

    // 2. ATUALIZA√á√ÉO DA BARRA NEON (HEADER HUD)
    const progBar = document.getElementById('overall-progress-bar');
    if (progBar) {
        const percentual = totalItensObrigatorios > 0 ? (concluidosGeral / totalItensObrigatorios) * 100 : 0;
        progBar.style.width = `${percentual}%`;
        
        if (percentual === 100) {
            progBar.style.background = "#1b8a3e";
            progBar.style.boxShadow = "0 0 10px #1b8a3e";
        } else {
            const corModo = isChecklist ? "#2c3e50" : "#800020";
            progBar.style.background = corModo;
            progBar.style.boxShadow = `0 0 10px ${corModo}`;
        }
    }

    // 3. ATUALIZA√á√ÉO DO BOT√ÉO FINALIZAR (TELA 1)
    const btn = document.getElementById('btn-finalizar');
    if (btn) {
        const corV3 = isChecklist ? '#2c3e50' : '#800020';
        const buttonPrefix = isChecklist ? 'FINALIZAR VISTORIA' : 'FINALIZAR CONFER√äNCIA';
        
        btn.disabled = !todosConcluidos;
        btn.style.transition = "all 0.4s cubic-bezier(0.4, 0, 0.2, 1)";

        if (btn.disabled) {
            btn.innerHTML = `<i class="fas fa-tasks"></i> PENDENTE (${concluidosGeral}/${totalItensObrigatorios})`;
            btn.style.background = '#94a3b8';
            btn.style.transform = 'scale(1)';
            btn.style.animation = 'none';
        } else {
            btn.innerHTML = `<i class="fas fa-paper-plane"></i> ${buttonPrefix}`;
            btn.style.background = corV3;
            btn.style.boxShadow = `0 10px 20px rgba(0,0,0,0.2)`;
            btn.style.animation = "v3-pulse 2s infinite";
        }
    }

    // 4. ATUALIZA√á√ÉO DAS LINHAS DE SETOR (TELA 1)
    document.querySelectorAll('.v3-setor-row').forEach((row, index) => {
        const setor = fonteDados[index];
        if (!setor) return;

        let totalSetorObrigatorio = 0;
        let concluidosSetor = 0;
        let alertasSetor = 0;

        setor.itens.forEach(it => {
            // ‚úÖ EXCE√á√ÉO: Ignora fotos no c√°lculo do badge do setor
            if (it.tipo === 'upload_foto') return;

            totalSetorObrigatorio++;
            const uidSetor = isChecklist ? it.id : (it.uid_global || it.id);
            const st = window.itemStatus[uidSetor];
            if (st && (st.status === 'ok' || st.status === 'C/A')) {
                concluidosSetor++;
                if (st.status === 'C/A') alertasSetor++;
            }
        });

        // Atualiza os badges de texto dentro da linha do setor
        const badgeTotal = row.querySelector('.badge-total');
        if (badgeTotal) {
            if (totalSetorObrigatorio === 0) {
                // Se for um setor puramente de fotos
                badgeTotal.innerText = "REGISTRO OPCIONAL";
            } else {
                badgeTotal.innerText = `${concluidosSetor}/${totalSetorObrigatorio} CONFERIDOS`;
            }
        }

        // Gerencia badge de alertas
        let badgeAlt = row.querySelector('.badge-alerta');
        if (alertasSetor > 0) {
            if (!badgeAlt) {
                const containerBadges = row.querySelector('.v3-setor-badges');
                badgeAlt = document.createElement('span');
                badgeAlt.className = 'badge-mini badge-alerta';
                containerBadges.appendChild(badgeAlt);
            }
            badgeAlt.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${alertasSetor} ALT`;
        } else if (badgeAlt) {
            badgeAlt.remove();
        }

        // Status de Conclu√≠do (Fica verde se os itens OBRIGAT√ìRIOS estiverem OK)
        if (concluidosSetor === totalSetorObrigatorio && totalSetorObrigatorio > 0) {
            row.classList.add('concluido');
            const icon = row.querySelector('i.fas');
            if (icon) icon.className = 'fas fa-check-circle';
        } else if (totalSetorObrigatorio === 0) {
            // Setor de fotos nunca fica "verde" automaticamente, mas n√£o impede o final
            row.classList.remove('concluido');
            const icon = row.querySelector('i.fas');
            if (icon) icon.className = 'fas fa-camera';
        } else {
            row.classList.remove('concluido');
            const icon = row.querySelector('i.fas');
            if (icon) icon.className = 'fas fa-chevron-right';
        }
    });
}
function updateSetorStatus(setorEl) { 
    if (!setorEl) return;

    const itensPai = setorEl.querySelectorAll('.item-conferencia'); 
    let concluidos = 0;
    let total = itensPai.length; 

    itensPai.forEach(item => { 
        if (item.classList.contains('status-ok') || item.classList.contains('status-alert')) {
            concluidos++;
        }
    }); 

    setorEl.dataset.totalItems = total; 
    
    const st = setorEl.querySelector('.setor-status'); 
    if (st) {
        st.dataset.completed = concluidos; 
        st.style.color = "#ffffff"; 
        st.style.transition = "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
        
        if (concluidos === total && total > 0) { 
            const temAlerta = setorEl.querySelectorAll('.item-conferencia.status-alert').length > 0;
            
            // ‚úÖ UX V3: Texto mais curto com √≠cone para n√£o quebrar o layout no mobile
            if (temAlerta) {
                st.innerHTML = '<i class="fas fa-exclamation-triangle"></i> C/ ALT';
                st.style.backgroundColor = "#d90f23";
                st.style.boxShadow = "0 0 12px rgba(217, 15, 35, 0.4)";
            } else {
                st.innerHTML = '<i class="fas fa-check-circle"></i> S/A';
                st.style.backgroundColor = "#1b8a3e";
                st.style.boxShadow = "0 0 12px rgba(27, 138, 62, 0.4)";
            }
            st.classList.add('ok'); 
            st.style.minWidth = "70px"; // Largura ajustada para o √≠cone
        } else { 
            // Estado de Progresso (Andamento)
            st.innerHTML = `<i class="fas fa-spinner fa-spin" style="font-size: 0.8em; margin-right: 4px;"></i> ${concluidos}/${total}`; 
            st.classList.remove('ok');
            st.style.backgroundColor = "rgba(0,0,0,0.4)"; // Efeito de transpar√™ncia V3
            st.style.boxShadow = "none";
            st.style.minWidth = "55px";
        } 
    }
}
        function updateItemMainStatusDisplay(item) { 
    if (!item || item.dataset.type === 'single') return; 
    
    const tombs = item.querySelectorAll('.tombamento-container'); 
    let concluidos = 0; 
    let temAlteracao = false; 

    // ‚úÖ AJUSTE V3: Identidade Visual Din√¢mica
    const isChecklist = window.isModoChecklist;
    const corV3 = isChecklist ? '#2c3e50' : '#800020';

    tombs.forEach(t => { 
        const uidOriginal = t.getAttribute('data-id'); 
        const uidCautela = `CAUTELA-${uidOriginal}`;

        const statusObj = window.itemStatus[uidOriginal];
        const statusCautelaObj = window.itemStatus[uidCautela];

        const s = statusObj ? statusObj.status : null; 
        const sCautela = statusCautelaObj ? statusCautelaObj.status : null; 

        // L√≥gica de Preenchimento: OK, Altera√ß√£o, Mantido ou Ciente
        const preenchido = (s === 'ok' || s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente');
        
        if (preenchido) {
            concluidos++;
            if (s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente') {
                temAlteracao = true;
            }
        }
    }); 

    const icon = item.querySelector('.status-icon'); 
    
    // Reseta classes e estilos para aplica√ß√£o limpa
    item.classList.remove('status-ok', 'status-alert');
    item.style.backgroundColor = "";
    if (icon) {
        icon.className = 'status-icon'; 
        icon.style.backgroundColor = "";
    }

    // ‚úÖ L√ìGICA DE ATIVA√á√ÉO V3: Feedback Visual do Item Pai
    if (concluidos === tombs.length && tombs.length > 0) { 
        if (temAlteracao) { 
            item.classList.add('status-alert'); 
            if (icon) {
                icon.classList.add('alert');
                icon.style.backgroundColor = "#d90f23"; // Vermelho Alerta
            }
        } else { 
            item.classList.add('status-ok'); 
            if (icon) {
                icon.classList.add('ok');
                icon.style.backgroundColor = corV3; // Cor Institucional (Bord√¥/Azul)
            }
            // Efeito sutil de preenchimento no card pai para indicar "Setor Resolvido"
            item.style.backgroundColor = "rgba(40, 167, 69, 0.03)"; 
        } 
    } 
    
    // Atualiza o contador do setor (badge) l√° no topo
    const setorEl = item.closest('.setor');
    if (setorEl) updateSetorStatus(setorEl);
}
      function toggleSetor(header) { 
    const content = header.nextElementSibling; 
    const arrow = header.querySelector('.arrow'); 
    
    // Verifica se j√° est√° expandido
    const isExpanded = content.classList.contains('expanded');

    if (isExpanded) { 
        // Fechamento simples
        content.classList.remove('expanded'); 
        arrow.innerHTML = '<i class="fas fa-chevron-right"></i>'; 
        header.style.borderRadius = "12px"; // Retorna ao arredondado total
    } else { 
        // L√ìGICA V3: Fecha outros setores para manter o foco (Modo Sanfona)
        document.querySelectorAll('.setor-content.expanded').forEach(c => {
            c.classList.remove('expanded'); 
            const otherHeader = c.previousElementSibling;
            otherHeader.querySelector('.arrow').innerHTML = '<i class="fas fa-chevron-right"></i>';
            otherHeader.style.borderRadius = "12px";
        }); 

        // Expans√£o do setor atual
        content.classList.add('expanded'); 
        arrow.innerHTML = '<i class="fas fa-chevron-down"></i>'; 
        header.style.borderRadius = "12px 12px 0 0"; // Ajusta quina para conectar ao conte√∫do

        // ‚úÖ UX V3: Scroll Autom√°tico para o topo do setor aberto
        setTimeout(() => {
            header.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Feedback t√°til visual: leve pulso no cabe√ßalho
            header.style.transform = "scale(1.01)";
            setTimeout(() => header.style.transform = "scale(1)", 200);
        }, 300);
    } 
}
    // ‚úÖ PASSO 2: FUN√á√ÉO DE FEEDBACK PARA O M√ìDULO DE FOTOS
function handlePhotoUploadClick() {
    // Usamos um alerta simples, mas informativo
    alert("üì∑ M√≥dulo de Registro Fotogr√°fico\n\n" +
          "Esta funcionalidade est√° em fase de integra√ß√£o com o servidor de arquivos (Storage).\n\n" +
          "Em breve, voc√™ poder√° anexar at√© 5 fotos diretamente da c√¢mera ou galeria para evidenciar o estado da viatura.");
}
        function checkSetorCompletion(currentSetor, currentItemId) {
    if (!currentSetor) return;

    updateOverallStatus();

    const totalItensNoSetor = parseInt(currentSetor.getAttribute('data-total-items')) || 0;
    const itensNoSetor = currentSetor.querySelectorAll('.item-conferencia');
    let concluidos = 0;

    itensNoSetor.forEach(item => {
        const id = item.getAttribute('data-id');
        const isSingle = item.getAttribute('data-type') === 'single';
        const temStatusVisual = item.classList.contains('status-ok') || item.classList.contains('status-alert');
        
        if (isSingle) {
            // L√ìGICA V3: Verifica√ß√£o rigorosa de intera√ß√£o humana para garantir validade
            const statusMemoria = window.itemStatus[id];
            if (temStatusVisual && statusMemoria && statusMemoria.interacao_humana === true) {
                concluidos++;
            }
        } else {
            if (temStatusVisual) concluidos++;
        }
    });

    // ‚úÖ FLUXO V3: Avan√ßo de Setor ou busca do pr√≥ximo item pendente
    if (concluidos >= totalItensNoSetor && totalItensNoSetor > 0) {
        // Setor finalizado: Feedback visual de "Check" antes de fechar
        currentSetor.style.transition = "opacity 0.3s";
        currentSetor.style.opacity = "0.7";
        
        setTimeout(() => {
            currentSetor.style.opacity = "1";
            autoAdvanceSetor(currentSetor); 
        }, 550);
    } else {
        // Busca inteligente do pr√≥ximo alvo (Single ou Tombamento) dentro da lista geral
        const todosAlvos = Array.from(document.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]'));
        const indexAtual = todosAlvos.findIndex(el => el.getAttribute('data-id') === currentItemId);

        const proximoAlvo = todosAlvos.slice(indexAtual + 1).find(el => {
            const id = el.getAttribute('data-id');
            const type = el.getAttribute('data-type');
            const stNormal = window.itemStatus[id]?.status;
            const stCautela = window.itemStatus[`CAUTELA-${id}`]?.status;
            const interacao = window.itemStatus[id]?.interacao_humana;
            
            const jaResolvido = (type === 'single') 
                ? (interacao === true && (stNormal === 'ok' || stNormal === 'C/A'))
                : (stNormal === 'ok' || stNormal === 'C/A' || stNormal === 'KEEP' || stCautela === 'cautela_ciente');
                
            return !jaResolvido;
        });

        if (proximoAlvo) {
            setTimeout(() => {
                // ‚úÖ UX V3: Scroll com efeito Spotlight (brilho de foco)
                proximoAlvo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Aplica um "alerta visual" suave de que este √© o novo foco
                const isChecklist = window.isModoChecklist;
                const glowColor = isChecklist ? "rgba(44, 62, 80, 0.4)" : "rgba(245, 124, 0, 0.4)";
                
                proximoAlvo.style.transition = "box-shadow 0.4s ease";
                proximoAlvo.style.boxShadow = `0 0 20px ${glowColor}`;
                
                setTimeout(() => proximoAlvo.style.boxShadow = "none", 1200);
            }, 350);
        }
    }
}
        function injetarCautelasNaLista() {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    // Aqui simulamos a leitura da sua cole√ß√£o cautelas_abertas
    // No seu c√≥digo real, voc√™ deve garantir que window.cautelasAbertas contenha os itens que voc√™ me enviou
    const cautelas = window.cautelasAbertas || []; 

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            cautelas.forEach(cautelaDoc => {
                cautelaDoc.itens.forEach(itemCautelado => {
                    // Se o ID base coincide (Ex: 56911524-64012364)
                    if (item.id === itemCautelado.id_base) {
                        
                        if (item.tipo === 'multi' && item.tombamentos) {
                            // Procura o tombamento espec√≠fico (Ex: 511.524 ou 511.527)
                            const t = item.tombamentos.find(tomb => tomb.tomb === itemCautelado.tombamento);
                            if (t) {
                                t.cautela = {
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: 1,
                                    id_cautela: cautelaDoc.cautela_id
                                };
                            }
                        } else if (item.tipo === 'single') {
                            if (!item.cautelas) item.cautelas = [];
                            // Evita duplicados
                            if (!item.cautelas.find(c => c.id_cautela === cautelaDoc.cautela_id)) {
                                item.cautelas.push({
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: itemCautelado.quantidade,
                                    id_cautela: cautelaDoc.cautela_id
                                });
                            }
                        }
                    }
                });
            });
        });
    });
}

        function autoAdvanceSetor(currentSetorElement) {
    const todosSetores = Array.from(document.querySelectorAll('.setor'));
    const currentIndex = todosSetores.indexOf(currentSetorElement);
    
    const currentContent = currentSetorElement.querySelector('.setor-content');
    const currentArrow = currentSetorElement.querySelector('.arrow');
    const currentHeader = currentSetorElement.querySelector('.setor-header');
    
    // ‚úÖ UX V3: Fechamento elegante com reset de bordas
    if (currentContent) currentContent.classList.remove('expanded');
    if (currentArrow) currentArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
    if (currentHeader) currentHeader.style.borderRadius = "12px";

    // Verifica se existe um pr√≥ximo setor
    if (currentIndex !== -1 && currentIndex < todosSetores.length - 1) {
        const nextSetorEl = todosSetores[currentIndex + 1];
        const nextContent = nextSetorEl.querySelector('.setor-content');
        const nextArrow = nextSetorEl.querySelector('.arrow');
        const nextHeader = nextSetorEl.querySelector('.setor-header');
        
        // ‚úÖ Transi√ß√£o V3: Pequena pausa para o olho humano processar o fechamento
        setTimeout(() => {
            if (nextContent) nextContent.classList.add('expanded');
            if (nextArrow) nextArrow.innerHTML = '<i class="fas fa-chevron-down"></i>';
            if (nextHeader) nextHeader.style.borderRadius = "12px 12px 0 0";
            
            // Scroll suave focado no in√≠cio do novo setor
            nextSetorEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Feedback visual: Brilho tempor√°rio no cabe√ßalho do novo setor
            if (nextHeader) {
                const isChecklist = window.isModoChecklist;
                const activeColor = isChecklist ? "rgba(44, 62, 80, 0.2)" : "rgba(128, 0, 32, 0.2)";
                nextHeader.style.boxShadow = `0 0 20px ${activeColor}`;
                setTimeout(() => { nextHeader.style.boxShadow = ""; }, 1000);
            }
        }, 300);

    } else {
        // ‚úÖ FINAL DO FLUXO: Guia o usu√°rio diretamente ao bot√£o de a√ß√£o final
        const btnFin = document.getElementById('btn-finalizar');
        if (btnFin) {
            setTimeout(() => {
                btnFin.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Anima√ß√£o de pulso no bot√£o para indicar prontid√£o
                btnFin.style.transform = "translateX(-50%) scale(1.1)";
                setTimeout(() => { btnFin.style.transform = "translateX(-50%) scale(1)"; }, 400);
            }, 400);
        }
    }
}
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }

       // --- 1. FUN√á√ÉO PARA LER DADOS ANTIGOS (LEGADOS) ---
const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
    const separator = ' | + NOVA: ';
    if (typeof textoBruto !== 'string') return [];
    
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
            if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
        if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
    }
    return linhas;
};

// --- 2. FUN√á√ÉO VISUAL √öNICA (SEM HORAS VIA REGEX) ---
const gerarHtmlVisualApp = (pendencia, autorAtual, dataAtual) => {
    let html = '<ul class="lista-pendencias" style="list-style: none; padding: 0; margin: 5px 0;">';
    const lista = (pendencia && pendencia.pendencias_ca) ? pendencia.pendencias_ca : 
                  (Array.isArray(pendencia) ? pendencia : null);
    if (lista && Array.isArray(lista) && lista.length > 0) {
        lista.forEach(p => {
            const militar = p.quem || 'Militar';
            const dataFull = p.data || '';
            
            // Extrai apenas a data (DD/MM/AAAA) usando regex
            const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
            const dataApenas = matchData ? matchData[0] : dataFull;

            html += `
                <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px;">
                    <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                    <b>Por </b>
                    <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                    <span> em <b>${dataApenas}</b>:</span>
                    <i style="margin-left: 5px; color: #333; font-weight: normal; display: block; padding-left: 25px;">${p.obs}</i>
                </li>`;
        });
    } 
    // 3. FALLBACK PARA DADOS ANTIGOS (S√≥ entra aqui se N√ÉO houver lista)
    else if (pendencia && pendencia.obs && typeof pendencia.obs === 'string') {
        const militar = pendencia.quem || autorAtual || 'Militar';
        const dataFull = pendencia.data || dataAtual || '';
        const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
        const dataApenas = matchData ? matchData[0] : dataFull;

        html += `
            <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem;">
                <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                <b>Por </b>
                <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                <span> em <b>${dataApenas}</b>:</span>
                <i style="margin-left: 5px; color: #333; font-weight: normal;">${pendencia.obs}</i>
            </li>`;
    }

    html += '</ul>';
    return html;
};
    
function renderizarConferencia() {
    // 1. MAPEAMENTO E LIMPEZA DE CONTAINERS V3
    const containerSetores = document.getElementById('lista-setores-container');
    const containerItens = document.getElementById('lista-itens-container');
    
    if (!containerSetores || !containerItens) return;

    // Limpa os containers antes de renderizar para evitar duplicidade
    containerSetores.innerHTML = ''; 
    containerItens.innerHTML = ''; 

    const fonteDados = window.dadosConferencia || dadosConferencia;
    const isChecklist = window.isModoChecklist || false;
    const isRecebimentoCarga = (new URLSearchParams(window.location.search)).get('modo') === 'recebimento_carga';

    // --- CONFIGURA√á√ÉO DE CORES V3 ---
    let corTema = isChecklist ? '#2c3e50' : (isRecebimentoCarga ? '#000000' : '#800020'); 

    // 2. RENDERIZA√á√ÉO DA TELA 1: LINHAS DE SETORES (Vis√£o Macro)
    let htmlSetores = ''; 
    fonteDados.forEach((setor, index) => {
        const totalItens = setor.itens.length;
        
        let concluidosSetor = 0;
        let alertasSetor = 0;
        setor.itens.forEach(it => {
            const uid = it.uid_global || it.id;
            const status = window.itemStatus[uid];
            // Um item √© considerado processado se tiver intera√ß√£o humana ou status definido
            if (status && status.interacao_humana) {
                concluidosSetor++;
                if (status.status === 'C/A') alertasSetor++;
            } else if (it.pendencias_ids && it.pendencias_ids.length > 0) {
                // Itens que j√° vem com pend√™ncia do banco tamb√©m contam para o badge de alerta
                alertasSetor++;
            }
        });

        const setorCompleto = (concluidosSetor === totalItens && totalItens > 0);

        htmlSetores += `
            <div class="v3-setor-row ${setorCompleto ? 'concluido' : ''}" onclick="entrarNoSetor(${index})">
                <div class="v3-setor-label">
                    <strong>${setor.nome}</strong>
                    <div class="v3-setor-badges">
                        <span class="badge-mini badge-total">${concluidosSetor}/${totalItens} CONFERIDOS</span>
                        ${alertasSetor > 0 ? `<span class="badge-mini badge-alerta"><i class="fas fa-exclamation-triangle"></i> ${alertasSetor} ALT</span>` : ''}
                    </div>
                </div>
                <i class="fas ${setorCompleto ? 'fa-check-circle' : 'fa-chevron-right'}"></i>
            </div>`;
    });

    containerSetores.innerHTML = htmlSetores;

    // 3. FUN√á√ÉO DE NAVEGA√á√ÉO (Com Desvio Inteligente para Fotos)
    window.entrarNoSetor = function(index) {
        const setor = fonteDados[index];
        const containerItens = document.getElementById('lista-itens-container');
        
        // Atualiza cabe√ßalho da Tela 2
        document.getElementById('nome-setor-atual').innerText = setor.nome;
        document.getElementById('nome-setor-atual').style.color = corTema;

        // ‚úÖ DESVIO PARA M√ìDULO FOTOGR√ÅFICO
        if (setor.nome.toUpperCase().includes("FOTOGR√ÅFICO")) {
            renderizarPainelFotos(containerItens);
        } else {
            // Renderiza√ß√£o padr√£o de itens
            renderizarLinhasItens(setor.itens, index);
        }
        
        document.body.classList.add('modo-inspecao');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // 4. RENDERIZA√á√ÉO DA TELA 2: LINHAS ELEGANTES DE ITENS (Vis√£o Micro)
   function renderizarLinhasItens(itens, setorIndex) {
    const container = document.getElementById('lista-itens-container');
    const isChecklist = window.isModoChecklist;
    let htmlItens = '';

    itens.forEach((item) => {
        const uid = isChecklist ? item.id : (item.uid_global || item.id);
        const statusLocal = window.itemStatus[uid] || {};
        const st = statusLocal.status;

        // --- L√ìGICA DE SALDO ATUALIZADA ---
        const totalEsperado = Number(item.quantidadeEsperada || item.quantidade || 0);
        const totalCautelado = (item.cautelas || []).reduce((s, c) => s + (Number(c.quantidade) || 0), 0);
        const pendencias = item.pendencias_ids || [];
        const totalPendente = pendencias.reduce((s, p) => s + (Number(p.quantidade) || 0), 0);
        const saldoDisponivel = totalEsperado - totalCautelado - totalPendente;

        const temCarimbo = pendencias.length > 0 || (item.cautelas && item.cautelas.length > 0);
        const classeStatus = (st === 'ok') ? 'status-ok' : (st === 'C/A' ? 'status-alert' : '');
        const classeCarimbo = temCarimbo ? 'has-carimbo' : '';

        // --- CONSTRU√á√ÉO DOS MINI-CARIMBOS (Ponto 1 e 2) ---
        let htmlCarimbos = '';
        pendencias.forEach(p => {
            const isTemp = String(p.id).startsWith('TEMP-');
            htmlCarimbos += `
                <div class="v3-mini-carimbo ${isTemp ? 'cor-temp' : 'cor-pend'}">
                    <i class="fas ${isTemp ? 'fa-pen-nib' : 'fa-history'}"></i>
                    <b>${p.autor_nome}:</b> "${p.descricao}" 
                    <span class="badge-qtd">${p.quantidade} UN</span>
                </div>`;
        });

        const nomeSanitizado = item.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');

        htmlItens += `
            <div class="v3-item-row ${classeStatus} ${classeCarimbo}" id="item-row-${uid}">
                <div class="v3-item-main-info">
                    <span class="v3-item-name">${item.nome}</span>
                    
                    ${!isChecklist ? `<span class="v3-item-subtext">DISPON√çVEL: <b>${saldoDisponivel}/${totalEsperado}</b></span>` : ''}
                    
                    ${item.tipo === 'multi' && item.tombamentos ? 
                        `<span class="v3-item-subtext">TOMB: <b>${item.tombamentos.map(t=>t.tomb).join(', ')}</b></span>` : ''}

                    <div class="v3-carimbos-container">
                        ${htmlCarimbos}
                    </div>
                </div>

                <div class="v3-item-actions">
                    <button class="v3-btn-circle btn-check ${st === 'ok' ? 'active' : ''}" 
                            onclick="registrarCheckRapido(this, '${uid}', ${setorIndex})">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="v3-btn-circle btn-alert ${st === 'C/A' ? 'active' : ''}" 
                            onclick="abrirModalPendenciaV3('${uid}', '${item.tipo}', '${nomeSanitizado}', ${saldoDisponivel})">
                        <i class="fas fa-exclamation"></i>
                    </button>
                </div>
            </div>`;
    });

    container.innerHTML = htmlItens;
    atualizarContadorSetorInterno(itens);
}

function atualizarContadorSetorInterno(itens) {
    let feitos = 0;
    itens.forEach(it => {
        const st = window.itemStatus[it.uid_global || it.id]?.status;
        if (st === 'ok' || st === 'C/A' || st === 'cautela_ciente') feitos++;
    });
    document.getElementById('progresso-setor-atual').innerText = `${feitos}/${itens.length}`;
}
   function renderizarPainelFotos(container) {
        container.innerHTML = `
            <div class="v3-foto-panel" style="text-align: center; padding: 10px;">
                <div style="background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; text-align: left;">
                    <strong style="color: var(--petroleo); font-size: 0.85em; display: block; margin-bottom: 10px;">
                        <i class="fas fa-lightbulb"></i> SUGEST√ïES DE REGISTRO:
                    </strong>
                    <ul style="margin: 0; padding-left: 20px; font-size: 0.8em; color: #64748b; line-height: 1.6;">
                        <li>Frente e Traseira (Placa vis√≠vel)</li>
                        <li>Laterais (Direita e Esquerda)</li>
                        <li>Painel (Hod√¥metro e Combust√≠vel)</li>
                        <li style="color: var(--vinho); font-weight: bold; margin-top: 5px;">
                            <i class="fas fa-mobile-alt" style="transform: rotate(90deg);"></i> PREFIRA FOTOS NA HORIZONTAL
                        </li>
                    </ul>
                </div>

                <div id="container-camera-v3">
                    <button class="v3-btn-main" style="background: #64748b; width: 100%; height: 80px; border-radius: 15px; font-size: 1em;" 
                            onclick="Swal.fire('Em breve', 'O m√≥dulo de upload para o Firebase Storage est√° sendo preparado.', 'info')">
                        <i class="fas fa-camera" style="font-size: 1.5em; display: block; margin-bottom: 5px;"></i>
                        ANEXAR FOTOS (EM BREVE)
                    </button>
                    <small style="color: #94a3b8; display: block; margin-top: 10px; font-weight: 600;">
                        M√ÅXIMO: 5 FOTOS | AT√â 10MB CADA
                    </small>
                </div>

                <div id="galeria-miniaturas" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 25px;">
                    </div>
            </div>
        `;
    }
    
async function carregarDadosRemotos() {
    // 1. CAPTURA IMEDIATA E HIGIENIZA√á√ÉO DE PAR√ÇMETROS
    const urlParamsLocal = new URLSearchParams(window.location.search);
    const idUrl = urlParamsLocal.get('id');
    const cautelaIdUrl = urlParamsLocal.get('cautelaId');
    const modoUrl = urlParamsLocal.get('modo');
    const transferenciaIdUrl = urlParamsLocal.get('transferenciaId'); 

    // 2. DEFINI√á√ÉO DO MODO E ID ALVO
    let ID_ALVO = transferenciaIdUrl || cautelaIdUrl || idUrl; 
    
    if (modoUrl === 'checklist_vtr' && ID_ALVO && !ID_ALVO.startsWith('CHECKLIST_VTR_')) {
        ID_ALVO = 'CHECKLIST_VTR_' + ID_ALVO;
    }

    if (!ID_ALVO || ID_ALVO === "null") {
        console.error("SIGMA: ID_ALVO inv√°lido.");
        return;
    }

    const loadingMsg = document.getElementById('loading-message');
    const btnFinalizar = document.getElementById('btn-finalizar');

    try {
        let docData = null;
        let colecaoEncontrada = "";

        // --- 3. MOTOR DE BUSCA AUT√îNOMO (DNA V3) ---
        const colecoesParaTestar = ['listas_checklist', 'listas_conferencia', 'cautelas_abertas', 'transferencias_pendentes'];
        
        for (const colecao of colecoesParaTestar) {
            const doc = await db.collection(colecao).doc(ID_ALVO).get();
            if (doc.exists) {
                docData = doc.data();
                colecaoEncontrada = colecao;
                break; 
            }
        }

        if (!docData) throw new Error(`Documento ${ID_ALVO} n√£o localizado no banco.`);

        // --- 4. IDENTIFICA√á√ÉO AUTOM√ÅTICA DE MODO ---
        window.isModoChecklist = (colecaoEncontrada === 'listas_checklist' || docData.tipo === 'checklist_viatura');
        const isRecebimentoCarga = (colecaoEncontrada === 'transferencias_pendentes');
        const isCautelaLocal = (colecaoEncontrada === 'cautelas_abertas');
        const isDevolucaoFinal = modoUrl === 'devolucao_final';

        if (isRecebimentoCarga) window.dadosTransferencia = docData;

        // --- 5. IDENTIDADE DO CONFERENTE (BACK-END) ---
        // ‚úÖ AJUSTE: Mapeia corretamente independente do formato da URL
        userInfo.postoGraduacao = urlParamsLocal.get('posto_grad') || "ND";
        userInfo.quadro = urlParamsLocal.get('quadro') || "ND";
        userInfo.nomeGuerra = urlParamsLocal.get('nome_guerra') || "ND";
        userInfo.uid = urlParamsLocal.get('user_uid') || "ND";

        // --- 6. BUSCA REVERSA: HERAN√áA DE PEND√äNCIAS (CR√çTICO) ---
        let pendenciasHerdadas = {};
        if (!isCautelaLocal && !isRecebimentoCarga) {
            const colecaoResultados = window.isModoChecklist ? 'resultados_checklist' : 'resultados_conferencias';
            const ultimaConfQuery = await db.collection(colecaoResultados)
                .where('lista_id', '==', ID_ALVO)
                .orderBy('timestamp', 'desc')
                .limit(1)
                .get();

            if (!ultimaConfQuery.empty) {
                const ultimoResultado = ultimaConfQuery.docs[0].data();
                (ultimoResultado.itensRelatorio || []).forEach(itemRel => {
                    const idBusca = itemRel.id || itemRel.uid_global;
                    if (itemRel.status === 'C/A' && itemRel.pendencias_ids && idBusca) {
                        pendenciasHerdadas[idBusca] = itemRel.pendencias_ids;
                    }
                });
            }
        }

        // --- 7. PROCESSAMENTO E MAPEAMENTO DA √ÅRVORE DE DADOS ---
        if (isCautelaLocal || isRecebimentoCarga) {
            dadosConferencia = adaptarCautelaParaRender(docData);
        } else {
            const listaBruta = docData.list || [];
            dadosConferencia = listaBruta.map(setor => ({
                ...setor,
                itens: (setor.itens || []).map(item => {
                    // ‚úÖ AJUSTE V3: Mant√©m a regra de UID para Checklist vs Materiais
                    if (!item.id) item.id = item.uid_global;
                    const uidBase = window.isModoChecklist ? item.id : (item.uid_global || item.id);
                    
                    // Injeta pend√™ncias do banco no item pai
                    item.pendencias_ids = pendenciasHerdadas[uidBase] || [];

                    // ‚úÖ AJUSTE CR√çTICO: Heran√ßa para sub-itens (Tombamentos)
                    if (item.tipo === 'multi' && item.tombamentos) {
                        item.tombamentos.forEach(t => {
                            const uidComposto = `${item.uid_global || item.id}-${t.tomb}`;
                            if (pendenciasHerdadas[uidComposto]) {
                                t.pendencias_ids = pendenciasHerdadas[uidComposto];
                            }
                        });
                    }

                    item.quantidadeEsperada = Number(item.quantidadeEsperada || item.quantidade || 0);
                    item._ocultarCarimbo = isDevolucaoFinal;
                    return item;
                })
            }));
        }

        window.dadosConferencia = dadosConferencia;

        // --- 8. CONFIGURA√á√ÉO DO HUD PROFISSIONAL ---
        const localNome = isCautelaLocal ? `CAUTELA: ${ID_ALVO}` : (docData.ativo_nome || docData.nome_local || "Lista");
        const postoNome = isCautelaLocal ? "" : (docData.posto_nome || docData.unidade_sigla || "Geral");
        infoLocal = { nome: localNome, posto: postoNome };
        
        if (typeof updateHeaderInfo === "function") updateHeaderInfo();

        // --- 9. CONFIGURA√á√ÉO VISUAL DO T√çTULO E BOT√ÉO FINALIZAR ---
        const tituloPrincipal = document.getElementById('titulo-conferencia');
        if (tituloPrincipal) {
            if (window.isModoChecklist) {
                tituloPrincipal.innerText = "Vistoria de Viatura";
                tituloPrincipal.style.color = "#2c3e50";
            } else if (isRecebimentoCarga) {
                tituloPrincipal.innerText = "Recebimento de Carga";
                tituloPrincipal.style.color = "#000000";
            } else {
                tituloPrincipal.innerText = isCautelaLocal ? "Recebimento de Cautela" : "Confer√™ncia de Materiais";
                tituloPrincipal.style.color = "#800020";
            }
        }

        if (btnFinalizar) {
            btnFinalizar.disabled = false;
            const corBotao = window.isModoChecklist ? "#2c3e50" : (isRecebimentoCarga ? "#000000" : "#800020");
            btnFinalizar.style.backgroundColor = corBotao;

            if (isDevolucaoFinal) {
                btnFinalizar.innerText = "FINALIZAR DEVOLU√á√ÉO";
                btnFinalizar.onclick = () => finalizarRecebimentoDevolucao(docData);
            } else if (isRecebimentoCarga) {
                btnFinalizar.innerText = "CONFIRMAR RECEBIMENTO";
                btnFinalizar.onclick = () => finalizarRecebimentoCarga(docData);
            } else if (isCautelaLocal) {
                btnFinalizar.innerText = "CONFIRMAR RECEBIMENTO";
                btnFinalizar.onclick = () => finalizarRecebimentoCautela(docData);
            } else {
                btnFinalizar.innerText = window.isModoChecklist ? "FINALIZAR VISTORIA" : "FINALIZAR CONFER√äNCIA";
                btnFinalizar.onclick = () => finalizarConferencia();
            }
        }

        // --- 10. ATIVA√á√ÉO DA INTERFACE V3 ---
        renderizarConferencia(); 
        if (typeof updateOverallStatus === "function") updateOverallStatus();
        
        if (loadingMsg) loadingMsg.style.display = 'none'; 
        const mainViewport = document.getElementById('main-viewport');
        if (mainViewport) mainViewport.style.display = 'flex';

    } catch (e) { 
        console.error("V3 Critical Error:", e);
        if (loadingMsg) loadingMsg.innerHTML = `<span style='color:red'>Erro ao carregar dados: ${e.message}</span>`;
    }
}
   async function abrirModalEditar(pendenciaId, uid, qtdAtual, descricaoAtual) {
    const corEdicao = "#2196F3";
    const uidString = String(uid);
    const isChecklist = window.isModoChecklist;

    const { value: formValues } = await Swal.fire({
        title: `<span style="color: ${corEdicao}; font-size: 0.9em; font-weight: bold;"><i class="fas fa-edit"></i> Editar Relato</span>`,
        width: '95%', // ‚úÖ Responsivo para mobile
        padding: '1em',
        html: `
            <div style="text-align: left; font-family: sans-serif; width: 100%; box-sizing: border-box;">
                <p style="margin-bottom: 15px; font-size: 0.85em; color: #666;">Ajuste os detalhes da altera√ß√£o selecionada abaixo.</p>
                
                ${!isChecklist ? `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Quantidade:</label>
                    <input id="swal-input-qtd" type="number" class="swal2-input" value="${qtdAtual}" min="1" 
                           style="width: 100%; margin: 5px 0 0 0; height: 40px; box-sizing: border-box;">
                </div>
                ` : ''}

                <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Nova Descri√ß√£o:</label>
                <textarea id="swal-input-obs" class="swal2-textarea" placeholder="Descreva a altera√ß√£o..." 
                          style="width: 100%; margin: 5px 0 0 0; min-height: 100px; text-transform: uppercase; font-size: 0.9em; box-sizing: border-box;">${descricaoAtual}</textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'SALVAR ALTERA√á√ïES',
        cancelButtonText: 'CANCELAR',
        confirmButtonColor: corEdicao,
        reverseButtons: true,
        backdrop: `rgba(15, 23, 42, 0.5)`, // ‚úÖ Fundo mais denso para isolar o modal
        didOpen: () => {
            const input = document.getElementById('swal-input-obs');
            if (input) {
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
            }
        },
        preConfirm: () => {
            const obs = document.getElementById('swal-input-obs').value;
            const qtdInput = document.getElementById('swal-input-qtd');
            const qtd = isChecklist ? 1 : (qtdInput ? qtdInput.value : 1);

            if (!obs || obs.trim().length < 5) {
                Swal.showValidationMessage('A descri√ß√£o deve ter pelo menos 5 caracteres');
                return false;
            }
            return { qtd: parseInt(qtd), obs: obs.trim().toUpperCase() };
        }
    });

    if (formValues) {
        executarEdicaoRelato(pendenciaId, uidString, formValues.qtd, formValues.obs);
    }
}
    
      function adaptarCautelaParaRender(cautelaData) {
    if (!cautelaData.itens || cautelaData.itens.length === 0) return [];

    const setorCautela = {
        id: cautelaData.cautela_id,
        nome: "ITENS PARA CONFER√äNCIA",
        itens: cautelaData.itens.map(cItem => {
            
            const qtdReal = Number(cItem.quantidade || cItem.quantidadeEsperada || 1);

            // Verifica se √© erro de cadastro ou item sem tombamento
            const tombInvalido = (cItem.tombamento === cItem.nome || cItem.tombamento === "S/T" || !cItem.tombamento);
            let tipo = tombInvalido ? 'single' : 'multi';
            
            // ‚úÖ AJUSTE CIR√öRGICO: Se o item veio com avaria na cautela, transforma em pend√™ncia visual
            let pendenciasIniciais = [];
            if (cItem.status_emissao === 'C/A' || cItem.obs_emissao) {
                pendenciasIniciais.push({
                    id: "HIST-EMISSAO-" + Date.now(),
                    autor_nome: cautelaData.emitente || "EMITENTE",
                    descricao: cItem.obs_emissao || "AVARIA REGISTRADA NA EMISS√ÉO",
                    quantidade: qtdReal,
                    data_criacao: cautelaData.data_emissao || new Date().toLocaleDateString('pt-BR')
                });
            }

            let tombamentos = null;
            if (tipo === 'multi') {
                tombamentos = [{
                    tomb: cItem.tombamento,
                    id_completo: `${cItem.id_base || cItem.id}-${cItem.tombamento}`,
                    pendencias_ids: pendenciasIniciais, // Injeta avaria no tombamento
                    cautela: { id: cautelaData.cautela_id, destinatario: cautelaData.destinatario || "N/D" }
                }];
            }

            return {
                id: cItem.id_base || cItem.id,
                nome: cItem.nome,
                quantidadeEsperada: qtdReal,
                tipo: tipo,
                tombamentos: tombamentos,
                pendencias_ids: tipo === 'single' ? pendenciasIniciais : [], // Injeta avaria se for item single
                cautelas: [], 
                situacao: cItem.status_emissao === 'C/A' ? "AVARIADO" : "DISPON√çVEL"
            };
        })
    };
    return [setorCautela];
}
        
async function finalizarConferencia() {
    const btn = document.getElementById('btn-finalizar');
    if (btn.disabled && btn.textContent.includes("SALVANDO")) return;

    if (!LISTA_ID) {
        console.warn("Redirecionando fluxo: LISTA_ID ausente.");
        if (typeof finalizarRecebimentoDevolucao === 'function' && CAUTELA_ID) {
            return finalizarRecebimentoDevolucao(window._dadosCautelaOriginal || dadosConferencia[0]);
        }
        alert("Erro: Identificador da lista n√£o encontrado.");
        return;
    }
    
    const isChecklist = window.isModoChecklist || false;
    
    // ‚úÖ UX V3: Feedback visual imediato
    btn.innerHTML = `<i class="fas fa-sync fa-spin"></i> ${isChecklist ? "SALVANDO VISTORIA..." : "SALVANDO CONFER√äNCIA..."}`; 
    btn.disabled = true;
    btn.style.opacity = "0.7";

    try {
        // ‚úÖ AJUSTE CIR√öRGICO: Assinatura extra√≠da da global userInfo (independente do HUD)
        const p = {
            uid: userInfo?.uid || "S_UID",
            postoGraduacao: userInfo?.postoGraduacao || "ND",
            quadro: userInfo?.quadro || "ND",
            nomeGuerra: userInfo?.nomeGuerra || "ND"
        };

        const conferenteCompleto = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
     
        const localNome = isChecklist ? `VISTORIA: ${infoLocal.nome}` : `${infoLocal.posto} - ${infoLocal.nome}`;
        const timestampAgora = firebase.firestore.Timestamp.now();
        const dataAtualLog = new Date().toLocaleString('pt-BR');
        
        const urlParams = new URLSearchParams(window.location.search);
        const unidadeId = urlParams.get('unidade_id') || userInfo?.unidadeId || "UNID-GERAL";
        const unidadeNome = urlParams.get('unidade_nome') || userInfo?.unidade || "GERAL";
        const kmEntrada = urlParams.get('km') || "0";
        const combustivelEntrada = urlParams.get('combustivel') || "N/D";
        
        // Em vistorias, as observa√ß√µes podem vir de um campo espec√≠fico se houver
        const obsGeraisEl = document.getElementById('obs-geral-vistoria');
        const obsGeraisTexto = obsGeraisEl ? obsGeraisEl.value.trim() : "";

        let itensRelatorio = [];
        let itensCaa = []; 
        let totalCaa = 0;
        const fonteDeDados = window.dadosConferencia || dadosConferencia;

        // --- PROCESSAMENTO DA √ÅRVORE DE DADOS (Mantendo suas regras de saldo/hist√≥rico) ---
        const novaListaMestra = fonteDeDados.map(setor => {
            return {
                ...setor,
                itens: setor.itens.map(item => {
                    const processarEntidade = (entidade, uid, nomeParaRelatorio) => {
                        const statusLocal = window.itemStatus[uid];
                        if (!entidade.pendencias_ids) entidade.pendencias_ids = [];
                        if (!entidade.historico_vida) entidade.historico_vida = [];

                        if (entidade.situacao === 'AVARIADO' && statusLocal?.status === 'ok') {
                            entidade.situacao = 'DISPON√çVEL';
                            delete entidade.id_cautela_origem;
                            delete entidade.motivo_avaria;
                        }

                        // Se n√£o houve intera√ß√£o, assume o estado atual (visto como OK se n√£o houver pend√™ncia)
                        if (!statusLocal || statusLocal.status === 'pending') {
                            const qtdFix = entidade.quantidadeEsperada || entidade.quantidade || 1;
                            itensRelatorio.push({
                                id: String(uid || entidade.uid_global || ""), 
                                uid_global: String(item.uid_global || ""),
                                nomeCompleto: String(nomeParaRelatorio || ""), 
                                status: 'S/A',
                                situacao_patrimonial: entidade.situacao || 'DISPON√çVEL',
                                quantidade: qtdFix, 
                                setor: String(setor.nome || ""), 
                                obs: ""
                            });
                            return entidade;
                        }

                        // L√≥gica de Resolu√ß√£o de Pend√™ncias
                        if (statusLocal.ids_resolvidos) {
                            statusLocal.ids_resolvidos.forEach(res => {
                                const idx = entidade.pendencias_ids.findIndex(pnd => String(pnd.id) === String(res.id));
                                if (idx > -1) {
                                    const pendenciaMorta = entidade.pendencias_ids[idx];
                                    entidade.historico_vida.push({
                                        evento: res.qtd_remanescente > 0 ? "SOLUCAO_PARCIAL" : "SOLUCAO_TOTAL",
                                        id_pendencia_origem: String(pendenciaMorta.id || ""), 
                                        quem: conferenteCompleto,
                                        data: dataAtualLog, 
                                        detalhes: `Resolvido ${res.qtd_resolvida}. Justificativa: ${res.obs}`
                                    });
                                    entidade.pendencias_ids.splice(idx, 1);
                                    if (res.qtd_remanescente > 0) {
                                        entidade.pendencias_ids.push({
                                            ...pendenciaMorta, 
                                            id: "PEND_" + Date.now() + "_RES",
                                            quantidade: res.qtd_remanescente, 
                                            descricao: pendenciaMorta.descricao + " (SALDO)",
                                            herdado_de: pendenciaMorta.id
                                        });
                                    }
                                }
                            });
                        }

                        // Convers√£o de TEMP para PEND (DNA Permanente)
                        entidade.pendencias_ids = entidade.pendencias_ids.map(p => {
                            if (p.id && String(p.id).startsWith('TEMP-')) {
                                const novoId = p.id.replace('TEMP-', 'PEND-');
                                entidade.historico_vida.push({
                                    evento: isChecklist ? "ALTERACAO_VISTORIA" : "NOVA_PENDENCIA", 
                                    id_pendencia: novoId, 
                                    quem: conferenteCompleto,
                                    data: dataAtualLog, 
                                    detalhes: `${p.quantidade}un - ${p.descricao || ""}`
                                });
                                return { ...p, id: novoId };
                            }
                            return p;
                        });

                        // Consolida alertas para o Relat√≥rio Final
                        let pendenciasParaRelatorio = [...entidade.pendencias_ids];
                        
                        if (entidade.cautelas && Array.isArray(entidade.cautelas)) {
                            entidade.cautelas.forEach(c => {
                                pendenciasParaRelatorio.push({
                                    autor_nome: String(c.emitente || "SISTEMA"),
                                    data_criacao: String(c.data || ""),
                                    quantidade: c.quantidade || 0,
                                    descricao: `Cautelado para ${c.destinatario} (ID: ${c.id}).`,
                                    status_gestao: "CAUTELADO"
                                });
                            });
                        }

                        const temAlteracao = pendenciasParaRelatorio.length > 0 || entidade.situacao === 'AVARIADO' || statusLocal.status === 'C/A';
                        const statusFinal = temAlteracao ? 'C/A' : 'S/A';
                        const quantidadeReal = entidade.quantidade || entidade.quantidadeEsperada || 1;

                        const dRel = {
                            id: String(uid || entidade.uid_global || ""), 
                            uid_global: String(item.uid_global || ""),
                            nomeCompleto: String(nomeParaRelatorio || ""), 
                            status: statusFinal,
                            situacao_patrimonial: entidade.situacao || 'DISPON√çVEL',
                            pendencias_ids: pendenciasParaRelatorio,
                            quantidade: quantidadeReal,
                            setor: String(setor.nome || ""), 
                            obs: pendenciasParaRelatorio.map(p => `${p.quantidade}un: ${p.descricao}`).join(' | ')
                        };

                        itensRelatorio.push(dRel);
                        if (temAlteracao) { itensCaa.push(dRel); totalCaa++; }
                        return entidade;
                    };

                    if (item.tipo === 'multi' && item.tombamentos) {
                        item.tombamentos = item.tombamentos.map(t => processarEntidade(t, `${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`));
                    } else {
                        item = processarEntidade(item, item.id, item.nome);
                    }
                    return item;
                })
            };
        });

        // ‚úÖ INICIO DO BATCH (OPERA√á√ÉO AT√îMICA NO FIREBASE)
        const batch = db.batch();
        
        // Limpeza de campos tempor√°rios para salvar na lista mestra
        const listaLimpaParaArquitetura = novaListaMestra.map(setor => ({
            ...setor,
            itens: setor.itens.map(item => {
                const i = { ...item };
                delete i.pendencias_ids; 
                delete i.historico_vida; 
                if (item.tombamentos) {
                    i.tombamentos = item.tombamentos.map(t => {
                        const tt = { ...t };
                        delete tt.pendencias_ids;
                        delete tt.historico_vida;
                        return tt;
                    });
                }
                return i;
            })
        }));

        const colecaoListaOrigem = isChecklist ? 'listas_checklist' : COLECAO_LISTAS;
        const colecaoResultadosDestino = isChecklist ? 'resultados_checklist' : 'resultados_conferencias';

        batch.update(db.collection(colecaoListaOrigem).doc(LISTA_ID), { list: listaLimpaParaArquitetura });

        const resRef = db.collection(colecaoResultadosDestino).doc();
        batch.set(resRef, {
            local: String(localNome || ""),
            unidade: String(unidadeNome || ""),
            unidade_id: String(unidadeId || ""),
            lista_id: String(LISTA_ID || ""), 
            conferente_uid: String(p.uid || ""), 
            conferente: String(conferenteCompleto || ""),
            timestamp: timestampAgora, 
            totalItensConferidos: itensRelatorio.length,
            totalCaa: totalCaa, 
            itensCaa: itensCaa || [], 
            itensRelatorio: itensRelatorio || [],
            modo: isChecklist ? 'CHECKLIST_VISTORIA' : 'CONFERENCIA_PADRAO',
            km_entrada: String(kmEntrada || "0"),
            combustivel_entrada: String(combustivelEntrada || "N/D"),
            obs_gerais_vistoria: String(obsGeraisTexto || "")
        });

        // ‚úÖ ATUALIZA√á√ÉO DE INVENT√ÅRIO (Saldos e Hist√≥ricos)
        for (const itemAlterado of itensCaa) {
            const uidGlobal = itemAlterado.uid_global;
            if (!uidGlobal) continue;

            const itemRef = db.collection('inventario').doc(uidGlobal);
            const ehMulti = itemAlterado.id.includes('-') && itemAlterado.id !== uidGlobal;
            
            if (ehMulti) {
                const partesId = itemAlterado.id.split('-');
                const tombamentoAlvo = partesId[partesId.length - 1];
                const tombRef = itemRef.collection('tombamentos').doc(tombamentoAlvo);
                
                const novosLogs = (itemAlterado.pendencias_ids || [])
                    .filter(pend => pend.id && String(pend.id).startsWith('PEND-'))
                    .map(pend => ({
                        data: dataAtualLog,
                        evento: isChecklist ? "ALERTA_VISTORIA" : "ALERTA_CONFERENCIA",
                        quem: conferenteCompleto,
                        detalhes: `‚ö†Ô∏è Altera√ß√£o em ${localNome}: ${pend.descricao}`,
                        uid_pendencia: pend.id,
                        lista_origem_id: LISTA_ID 
                    }));

                novosLogs.forEach((log, idx) => {
                    batch.set(tombRef.collection('historico_vida').doc("EVT-P-" + Date.now() + idx), log);
                });
                batch.update(tombRef, { situacao_atual: "PENDENTE" });
            } else {
                const saldoRef = itemRef.collection('saldos_unidades').doc(unidadeId);
                const novasPendencias = (itemAlterado.pendencias_ids || []).filter(pend => pend.id && String(pend.id).startsWith('PEND-'));
                
                if (novasPendencias.length > 0) {
                    const qtdPendenteTotal = novasPendencias.reduce((sum, pend) => sum + (Number(pend.quantidade) || 0), 0);
                    
                    // Blindagem de Saldo F√≠sico: Se n√£o for checklist, move de DISP para PEND
                    if (!isChecklist) {
                        batch.update(saldoRef, {
                            qtd_disp: firebase.firestore.FieldValue.increment(-qtdPendenteTotal),
                            qtd_pend: firebase.firestore.FieldValue.increment(qtdPendenteTotal),
                            last_update: dataAtualLog
                        });
                    } else {
                        batch.update(saldoRef, {
                            qtd_pend: firebase.firestore.FieldValue.increment(qtdPendenteTotal),
                            last_update: dataAtualLog
                        });
                    }

                    novasPendencias.forEach((pend, idx) => {
                        batch.set(saldoRef.collection('historico_vida').doc("EVT-S-P-" + Date.now() + idx), {
                            data: dataAtualLog,
                            evento: "PENDENCIA_RELATADA",
                            quem: conferenteCompleto,
                            detalhes: `‚ö†Ô∏è Altera√ß√£o em ${localNome}: ${pend.descricao}`,
                            quantidade: pend.quantidade,
                            uid_pendencia: pend.id,
                            lista_origem_id: LISTA_ID, 
                            local_sigla: infoLocal.nome || "N/D" 
                        });
                    });
                }
            }
        }
        
        await batch.commit();
        
        alert(isChecklist ? "‚úÖ Vistoria Finalizada com Sucesso!" : "‚úÖ Confer√™ncia Finalizada com Sucesso!");
        window.top.location.href = "sigma_dashboard.html";

    } catch (e) {
        console.error("V3 Critical Error:", e);
        alert("‚ùå Erro fatal ao gravar dados: " + e.message);
        btn.disabled = false;
        btn.innerHTML = isChecklist ? "FINALIZAR VISTORIA" : "FINALIZAR CONFER√äNCIA";
    }
}
        async function finalizarRecebimentoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();
            if (cData.destinatario_original_uid !== meuUid) {
                throw new Error("Apenas o destinat√°rio original pode assinar este recebimento.");
            }

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensConferidos = [];
            
            let temQualquerAlteracao = false;
            let linhasExtrato = [];

            cautela.itens.forEach((cItem, index) => {
                const uidBusca = cItem.tombamento ? `${cItem.id_base || cItem.id}-${cItem.tombamento}` : (cItem.id_base || cItem.id);
                const statusLocal = window.itemStatus[uidBusca] || {};
                
                const isItemOk = (statusLocal.status === 'ok' || statusLocal.status === 'S/A');
                const statusFinal = isItemOk ? 'S/A' : 'C/A';
                const obsFinal = statusLocal.obs || "";
                
                if (statusFinal === 'C/A') temQualquerAlteracao = true;

                itensConferidos.push({
                    ...cItem,
                    status_recebimento: statusFinal,
                    obs_recebimento: obsFinal
                });

                const identificador = cItem.tombamento ? `(Tomb.: ${cItem.tombamento})` : `(QTD: ${cItem.quantidade}UN)`;
                const relatoItem = isItemOk ? 'S/A' : (obsFinal || 'C/A sem obs.');
                linhasExtrato.push(`${index + 1}. ${cItem.nome} ${identificador}: ${relatoItem}`);

                // --- ATUALIZA√á√ÉO DA LISTA MESTRA ---
                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            // Registro no hist√≥rico de vida do item
                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push({
                                evento: "CONFIRMA√á√ÉO_RECEBIMENTO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                detalhes: statusFinal === 'C/A' ? `Avaria: ${obsFinal}` : "Recebido S/A."
                            });

                            const objetoCautelaAtualizado = {
                                id: CAUTELA_ID,
                                emitente: cData.emitente || "N/D",
                                destinatario: meuNomeCompleto,
                                data: cData.timestamp_emissao ? cData.timestamp_emissao.toDate().toLocaleDateString('pt-BR') : dataAtual,
                                status_item: statusFinal,
                                obs_item: obsFinal,
                                quantidade: Number(cItem.quantidade) || 1
                            };

                            // üõë CORRE√á√ÉO PARA ITEM SINGLE: Atualiza o existente em vez de dar push
                            if (mItem.tipo === 'single' && mItem.cautelas) {
                                const idxExistente = mItem.cautelas.findIndex(c => c.id === CAUTELA_ID);
                                if (idxExistente !== -1) {
                                    // Se j√° existe (carimbo de emiss√£o), apenas atualizamos os dados
                                    mItem.cautelas[idxExistente] = objetoCautelaAtualizado;
                                } else {
                                    // Se por algum motivo n√£o existia, a√≠ sim adicionamos
                                    mItem.cautelas.push(objetoCautelaAtualizado);
                                }
                            } 
                            // PARA ITEM MULTI: A sobrescrita j√° √© segura por natureza
                            else if (mItem.tipo === 'multi' && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        t.cautela = objetoCautelaAtualizado;
                                    }
                                    return t;
                                });
                            }
                        }
                        return mItem;
                    })
                }));
            });

            const icone = temQualquerAlteracao ? '‚ö†Ô∏è' : '‚úÖ';
            const tituloLog = `${icone} Recebido ${temQualquerAlteracao ? 'C/A' : 'S/A'} pelo destinat√°rio: ${meuNomeCompleto}`;
            const descricaoCompleta = `${tituloLog}\n${linhasExtrato.join('\n')}`;

            const logMovimentacao = {
                data: dataAtual,
                descricao: descricaoCompleta,
                militar: meuNomeCompleto
            };

            transaction.update(cautelaRef, {
                status: 'RECEBIDA',
                timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
                itens: itensConferidos,
                militar_completo_receptor: meuNomeCompleto,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(logMovimentacao)
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Recebimento confirmado!`);
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (error) {
        console.error("Erro ao receber cautela:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO";
        btn.disabled = false;
    }
}
      async function finalizarDevolucaoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = 'Processando...';
    btn.disabled = true;

    try {
        // Pega as informa√ß√µes do militar logado (quem est√° devolvendo)
        const userInfo = await getLoggedUser(); 
        
        if (!userInfo) {
            alert("Erro: Dados do militar logado n√£o encontrados.");
            btn.textContent = 'ERRO AO FINALIZAR';
            btn.disabled = false;
            return;
        }

        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);

        // üõë CR√çTICO: Executa a Transa√ß√£o no Firebase üõë
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(cautelaRef);

            if (!doc.exists || doc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela n√£o encontrada ou n√£o est√° no status 'RECEBIDA'.");
            }
            
            // 1. A√ß√£o: Mudar o status da cautela para CONCLUIDA.
            transaction.update(cautelaRef, { 
                status: 'CONCLUIDA', // Status final
                timestamp_devolucao: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem est√° devolvendo (Militar Logado)
                reversor: userInfo.nomeGuerra, 
                militar_completo_reversor: `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`,
                
                // Quem est√° recebendo de volta (√öltimo Conferente)
                destinatario_final_devolucao: DESTINATARIO_DEVOLUCAO,
            });
            
            // 2. A√ß√£o: Registrar o hist√≥rico de confer√™ncia final (opcional, mas recomendado)
            // Se necess√°rio, voc√™ pode adicionar um novo documento na sua cole√ß√£o de hist√≥rico.
        }); // Fim da Transa√ß√£o

        alert(`‚úÖ Devolu√ß√£o da Cautela ${CAUTELA_ID} conclu√≠da e status atualizado para \"CONCLUIDA\".`);
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro CR√çTICO ao finalizar devolu√ß√£o:", error);
        alert(`Erro ao finalizar devolu√ß√£o. Nenhum dado foi alterado. Erro: ${error.message}`);
        btn.textContent = "ERRO AO FINALIZAR";
        btn.disabled = false;
    }
}
       async function finalizarRecebimentoDevolucao(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    // üõ°Ô∏è CAPTURA CIR√öRGICA DO ID DA LISTA
    const listaId = cautela.local_origem_id || urlParams.get('lista_origem');

    if (!CAUTELA_ID || !listaId) {
        console.error("IDs ausentes:", { CAUTELA_ID, listaId });
        alert("Erro Cr√≠tico: N√£o foi poss√≠vel identificar a lista de origem para reintegrar o material.");
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) { alert("Sess√£o expirada."); btn.disabled = false; return; }

    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");
            
            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra original n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensDevolvidos = [];

            // --- üõë CONSTRU√á√ÉO DO EXTRATO DETALHADO DE DEVOLU√á√ÉO üõë ---
            let temQualquerAlteracao = false;
            let linhasExtrato = [];

            cautela.itens.forEach((cItem, index) => {
                const uidBusca = cItem.tombamento ? `${cItem.id_base || cItem.id}-${cItem.tombamento}` : (cItem.id_base || cItem.id);
                const statusLocal = window.itemStatus[uidBusca];
                
                const statusFinal = statusLocal?.status === 'ok' ? 'S/A' : 'C/A';
                const obsFinal = statusLocal?.obs || "";

                if (statusFinal === 'C/A') temQualquerAlteracao = true;

                itensDevolvidos.push({
                    ...cItem, status_devolucao: statusFinal, obs_devolucao: obsFinal
                });

                // Monta a linha do extrato para o hist√≥rico
                const identificador = cItem.tombamento ? `(Tomb.: ${cItem.tombamento})` : `(QTD: ${cItem.quantidade}UN)`;
                const relatoItem = statusFinal === 'S/A' ? 'S/A' : (obsFinal || 'C/A sem obs.');
                linhasExtrato.push(`${index + 1}. ${cItem.nome} ${identificador}: ${relatoItem}`);

                // Reinclui o material no Estoque (Lista Mestra)
                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        if ((mItem.id_base || mItem.id) === (cItem.id_base || cItem.id)) {
                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push({
                                evento: "RETORNO_DEVOLUCAO", 
                                id_doc: CAUTELA_ID, 
                                quem: meuNomeCompleto,
                                data: dataAtual, 
                                estado_retorno: statusFinal, 
                                detalhes: statusFinal === 'C/A' ? `Retorno com avaria: ${obsFinal}` : "Retorno em perfeito estado (S/A)."
                            });

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) delete t.cautela;
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = mItem.cautelas.filter(c => c.id !== CAUTELA_ID);
                            }
                        }
                        return mItem;
                    })
                }));
            });

            // Finaliza o T√≠tulo e o Corpo do Log de Movimenta√ß√£o
            const icone = temQualquerAlteracao ? '‚ö†Ô∏è' : '‚úÖ';
            const tituloLog = `${icone} Devolu√ß√£o recebida ${temQualquerAlteracao ? 'C/A' : 'S/A'} pelo detentor: ${meuNomeCompleto}`;
            const descricaoCompleta = `${tituloLog}\n${linhasExtrato.join('\n')}`;

            const logMovimentacao = {
                data: dataAtual,
                descricao: descricaoCompleta,
                militar: meuNomeCompleto
            };

            transaction.update(cautelaRef, { 
                status: 'CONCLU√çDA', 
                timestamp_conclusao: firebase.firestore.FieldValue.serverTimestamp(),
                receptor_final_completo: meuNomeCompleto, 
                itens: itensDevolvidos,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(logMovimentacao)
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert("‚úÖ Devolu√ß√£o finalizada e estoque atualizado!");
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
    } catch (error) {
        console.error("Erro na transa√ß√£o:", error);
        alert(`Erro: ${error.message}`);
        btn.disabled = false;
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
    }
}
// --- NOVAS FUN√á√ïES DE CONTROLE DE IDS √öNICOS ---
// ‚úÖ Adicione este trecho ao in√≠cio da sua fun√ß√£o carregarDadosRemotos
function aplicarCoresV3(modo) {
    const root = document.documentElement;
    if (modo === 'checklist_vtr') {
        document.body.style.setProperty('background', 'linear-gradient(135deg, #2c3e50 0%, #000000 100%)', 'important');
    } else if (modo === 'recebimento_carga') {
        document.body.style.setProperty('background', 'linear-gradient(135deg, #1a1a1a 0%, #333333 100%)', 'important');
    }
}

   async function abrirFormNovoID(uid, tipo, nomeItem, saldo, tombReal = "") {
    // ‚úÖ IDENTIDADE VISUAL DIN√ÇMICA V3
    const isChecklist = window.isModoChecklist;
    const corPrimaria = isChecklist ? "#2c3e50" : "#800020"; 
    const nomeLimpo = nomeItem.replace(/\\'/g, "'");
    const saldoReal = parseInt(saldo) || 0;

    // Valida√ß√£o de saldo inicial para itens que n√£o s√£o tombados
    if (tipo !== 'multi' && saldoReal <= 0) {
        return Swal.fire({
            icon: 'error',
            title: 'Saldo Insuficiente',
            text: 'Este item n√£o possui saldo dispon√≠vel para relatar nova altera√ß√£o.',
            confirmButtonColor: corPrimaria
        });
    }

    // ‚úÖ DISPARO DO MODAL ELEGANTE (Swal)
    const { value: formValues } = await Swal.fire({
        title: `<span style="color: ${corPrimaria}; font-size: 0.9em; font-weight: bold;">${nomeLimpo}</span>`,
        html: `
            <div style="text-align: left; font-family: sans-serif;">
                ${tipo === 'multi' 
                    ? `<p style="margin-bottom: 15px; font-size: 0.9em;">Refer√™ncia Tomb.: <b style="color: #d90f23;">${tombReal}</b></p>` 
                    : `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Quantidade Alterada (Dispon√≠vel: ${saldoReal}):</label>
                        <input id="swal-input-qtd" type="number" class="swal2-input" value="1" min="1" max="${saldoReal}" style="width: 100%; margin: 5px 0 0 0; height: 40px;">
                    </div>`
                }
                <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Descri√ß√£o do Problema:</label>
                <textarea id="swal-input-obs" class="swal2-textarea" placeholder="Descreva o problema detalhadamente..." style="width: 100%; margin: 5px 0 0 0; min-height: 100px; text-transform: uppercase; font-size: 0.9em;"></textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'INCLUIR ALTERA√á√ÉO',
        cancelButtonText: 'CANCELAR',
        confirmButtonColor: corPrimaria,
        reverseButtons: true,
        backdrop: `rgba(15, 23, 42, 0.4)`, // Backdrop suave V3
        didOpen: () => {
            // Foco autom√°tico no campo de observa√ß√£o ao abrir
            const input = document.getElementById('swal-input-obs');
            if (input) input.focus();
        },
        preConfirm: () => {
            const obs = document.getElementById('swal-input-obs').value;
            const qtd = tipo === 'multi' ? 1 : document.getElementById('swal-input-qtd').value;

            // Valida√ß√µes internas do modal
            if (!obs || obs.trim().length < 5) {
                Swal.showValidationMessage('Por favor, descreva o problema (m√≠nimo 5 caracteres)');
                return false;
            }
            if (tipo !== 'multi' && (parseInt(qtd) > saldoReal || parseInt(qtd) < 1)) {
                Swal.showValidationMessage(`Quantidade inv√°lida (M√°x: ${saldoReal})`);
                return false;
            }

            return { qtd: parseInt(qtd), obs: obs.trim().toUpperCase() };
        }
    });

    // ‚úÖ PROCESSAMENTO FINAL
    if (formValues) {
        // Envia para a fun√ß√£o de salvamento que j√° existe no seu c√≥digo
        salvarNovoID(uid, formValues.qtd, tipo, formValues.obs);
    }
}
// ‚úÖ AJUSTE V3: Fechamento de Modal Din√¢mico
function fecharModalPendencia() {
    // 1. Se estiver usando o sistema global do SIGMA:
    // sigmaModal.close(); 

    // 2. Se estiver usando a abordagem din√¢mica pura:
    const modal = document.getElementById('modal-nova-pendencia');
    if (modal) {
        modal.classList.add('v3-modal-out'); // Anima√ß√£o de sa√≠da
        setTimeout(() => {
            modal.style.display = 'none'; // Ou modal.remove() se for 100% din√¢mico
            // Limpa o scroll da p√°gina (caso tenha sido travado)
            document.body.style.overflow = 'auto';
        }, 300);
    }
}

async function abrirModalPendenciaV3(uid, tipo, nomeItem, saldoDisponivel) {
    const isChecklist = window.isModoChecklist;
    const corPrimaria = isChecklist ? "#2c3e50" : "#800020";
    
    const fonteDados = window.dadosConferencia || dadosConferencia;
    let pendenciaExistente = null;
    
    // Localiza a pend√™ncia na √°rvore de dados
    fonteDados.forEach(setor => {
        setor.itens.forEach(it => {
            const match = (it.uid_global === uid || it.id === uid);
            if (match && it.pendencias_ids?.length > 0) pendenciaExistente = it.pendencias_ids[0];
            if (it.tombamentos) {
                it.tombamentos.forEach(t => {
                    const uidComposto = `${it.uid_global || it.id}-${t.tomb}`;
                    if (uidComposto === uid && t.pendencias_ids?.length > 0) 
                        pendenciaExistente = t.pendencias_ids[0];
                });
            }
        });
    });

    if (pendenciaExistente) {
        // ‚úÖ Identifica se √© um rascunho da sess√£o atual para definir o layout
        const isTemp = String(pendenciaExistente.id).startsWith('TEMP-');
        const autor = pendenciaExistente.autor_nome || "SISTEMA";
        const data = pendenciaExistente.data_criacao || "";
        const qtdAvariada = pendenciaExistente.quantidade || 1;

        return Swal.fire({
            title: `<span style="color:${corPrimaria}; font-size:0.8em;">GERENCIAR ALTERA√á√ÉO</span>`,
            html: `
                <div style="text-align:left; font-size:0.9em;">
                    <div style="background:${isTemp ? '#f0f9ff' : '#fff5f5'}; padding:12px; border-radius:8px; margin-bottom:15px; border:1px solid ${isTemp ? '#bae6fd' : '#ffcccc'};">
                        
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; gap: 10px;">
                            <small style="color:#64748b; font-weight:800; text-transform:uppercase; flex: 1;">
                                ${isTemp ? '‚ú® Registro na Sess√£o' : 'üìú Relato de Auditoria'}
                            </small>
                            
                            ${isTemp ? `
                                <div style="display: flex; gap: 15px; white-space: nowrap;">
                                    <button onclick="Swal.close(); abrirModalEditar('${pendenciaExistente.id}', '${uid}', ${qtdAvariada}, '${pendenciaExistente.descricao.replace(/'/g, "\\'")}')" 
                                            style="background:none; border:none; color:#0369a1; cursor:pointer; font-size:1.1em; padding: 0 5px;">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button onclick="Swal.close(); confirmarExclusaoRelato('${pendenciaExistente.id}', '${uid}')" 
                                            style="background:none; border:none; color:#b91c1c; cursor:pointer; font-size:1.1em; padding: 0 5px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : `
                                ${!isChecklist ? `
                                    <span style="background:#d90f23; color:white; padding:2px 8px; border-radius:10px; font-size:0.75em; font-weight:bold;">
                                        ${qtdAvariada} UN
                                    </span>` : ''}
                            `}
                        </div>
                        
                        <span style="display:block; margin-bottom:8px; font-weight:bold; color:#1e293b; line-height: 1.4;">
                            "${pendenciaExistente.descricao}"
                        </span>
                        
                        <div style="border-top:1px solid ${isTemp ? '#bae6fd' : '#ffcccc'}; padding-top:5px; margin-top:5px;">
                            <small style="color:${isTemp ? '#0369a1' : '#d90f23'}; font-weight:700;">
                                ${isTemp ? '<i class="fas fa-clock"></i> Aguardando finalizar confer√™ncia' : `por: ${autor} em ${data}`}
                            </small>
                        </div>
                    </div>

                    ${!isTemp ? `
                        <button id="btn-v3-resolver" class="v3-btn-sheet" style="background:#1b8a3e; color:white; width:100%; padding:14px; border-radius:8px; border:none; margin-bottom:8px; font-weight:bold; cursor:pointer;">
                            <i class="fas fa-check"></i> RESOLVER ESTA AVARIA
                        </button>
                        <button id="btn-v3-manter" class="v3-btn-sheet" style="background:#f1f5f9; color:#475569; width:100%; padding:14px; border-radius:8px; border:1px solid #cbd5e1; margin-bottom:20px; font-weight:bold; cursor:pointer;">
                            <i class="fas fa-shield-alt"></i> MANTER COMO EST√Å
                        </button>
                    ` : ''}

                    ${(tipo === 'single' && (isChecklist || saldoDisponivel > 0)) ? `
                        <div style="border-top: 1px dashed #cbd5e1; padding-top: 15px; text-align:center;">
                            <button id="btn-v3-nova-alt" style="background:none; border:none; color:${corPrimaria}; font-weight:bold; text-decoration:underline; cursor:pointer; font-size:0.9em;">
                                <i class="fas fa-plus-circle"></i> RELATAR NOVA ALTERA√á√ÉO ${!isChecklist ? `NO SALDO (${saldoDisponivel} un.)` : ''}
                            </button>
                        </div>
                    ` : ''}
                </div>`,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'FECHAR',
            didOpen: () => {
                const btnManter = document.getElementById('btn-v3-manter');
                if(btnManter) btnManter.onclick = () => { manterID(pendenciaExistente.id, uid); Swal.close(); };
                
                const btnResolver = document.getElementById('btn-v3-resolver');
                if(btnResolver) btnResolver.onclick = () => { Swal.close(); abrirFormularioResolucaoV3(pendenciaExistente, uid); };
                
                const btnNova = document.getElementById('btn-v3-nova-alt');
                if(btnNova) btnNova.onclick = () => {
                    Swal.close();
                    setTimeout(() => { exibirModalInsercaoNovoRelato(uid, tipo, nomeItem, saldoDisponivel, corPrimaria); }, 300);
                };
            }
        });
    }

    // Se N√ÉO existe pend√™ncia, abre direto a inser√ß√£o limpa
    exibirModalInsercaoNovoRelato(uid, tipo, nomeItem, saldoDisponivel, corPrimaria);
}
   
// Fun√ß√£o auxiliar para isolar a l√≥gica de inser√ß√£o limpa
async function exibirModalInsercaoNovoRelato(uid, tipo, nomeItem, saldoDisponivel, corPrimaria) {
    const isChecklist = window.isModoChecklist;

    const { value: formValues } = await Swal.fire({
        title: `<span style="color:${corPrimaria}; font-size:0.8em;">RELATAR ALTERA√á√ÉO</span>`,
        width: '95%', // ‚úÖ Ocupa quase toda a largura no mobile
        padding: '1em',
        html: `
            <div style="text-align:left; width: 100%; box-sizing: border-box;">
                <p style="font-size:0.8em; color:#64748b; margin-bottom:10px;">Item: <b>${nomeItem}</b></p>
                ${(tipo === 'single' && !isChecklist) ? `
                    <label style="font-size:0.75em; font-weight:800; color:#666;">QUANTIDADE AFETADA (M√°x: ${saldoDisponivel}):</label>
                    <input id="swal-qtd" type="number" class="swal2-input" value="1" max="${saldoDisponivel}" min="1" style="width: 100%; box-sizing: border-box;">
                ` : ''}
                <label style="font-size:0.75em; font-weight:800; color:#666;">DESCRI√á√ÉO DO PROBLEMA:</label>
                <textarea id="swal-obs" class="swal2-textarea" placeholder="Descreva o problema encontrado..." 
                          style="height:120px; text-transform:uppercase; width: 100%; box-sizing: border-box; font-size: 0.9em;"></textarea>
            </div>`,
        showCancelButton: true,
        confirmButtonText: 'SALVAR RELATO',
        confirmButtonColor: corPrimaria,
        backdrop: `rgba(0,0,0,0.6)`, // ‚úÖ Escurece mais o fundo para destacar o modal
        preConfirm: () => {
            const obs = document.getElementById('swal-obs').value.trim();
            const qtd = isChecklist ? 1 : (document.getElementById('swal-qtd') ? parseInt(document.getElementById('swal-qtd').value) : 1);
            
            if (obs.length < 5) return Swal.showValidationMessage("Descreva o problema (m√≠n. 5 letras)");
            if (!isChecklist && tipo === 'single' && (qtd < 1 || qtd > saldoDisponivel)) return Swal.showValidationMessage("Quantidade inv√°lida");
            
            return { qtd, obs };
        }
    });

    if (formValues) {
        salvarNovoID(uid, formValues.qtd, tipo, formValues.obs);
    }
}
  async function abrirFormularioResolucaoV3(pendencia, uid) {
    const isChecklist = window.isModoChecklist;
    const corSucesso = "#1b8a3e"; // Verde Sucesso
    const nomeItem = pendencia.itemNome || "Material";

    const { value: resolucao } = await Swal.fire({
        title: `<span style="color:${corSucesso}; font-size:0.8em;">RESOLVER ALTERA√á√ÉO</span>`,
        html: `
            <div style="text-align:left; font-family:sans-serif;">
                <p style="font-size:0.85em; color:#64748b; margin-bottom:15px;">Item: <b>${nomeItem}</b></p>
                
                ${!isChecklist ? `
                <div style="margin-bottom:15px;">
                    <label style="font-weight:800; font-size:0.7em; color:#666; text-transform:uppercase;">Unidades Resolvidas:</label>
                    <input id="swal-res-qtd" type="number" class="swal2-input" value="${pendencia.quantidade}" max="${pendencia.quantidade}" min="1" style="width:100%; margin:5px 0 0 0;">
                </div>
                ` : ''}

                <label style="font-weight:800; font-size:0.7em; color:#666; text-transform:uppercase;">Justificativa da Solu√ß√£o:</label>
                <textarea id="swal-res-obs" class="swal2-textarea" placeholder="Descreva como o problema foi sanado..." style="height:100px; text-transform:uppercase; margin:5px 0 0 0; font-size:0.9em;"></textarea>
            </div>`,
        showCancelButton: true,
        confirmButtonText: 'CONFIRMAR SOLU√á√ÉO',
        confirmButtonColor: corSucesso,
        cancelButtonText: 'VOLTAR',
        reverseButtons: true,
        preConfirm: () => {
            const obs = document.getElementById('swal-res-obs').value.trim();
            // ‚úÖ Se for checklist, assume a quantidade total da pend√™ncia automaticamente
            const qtdInput = document.getElementById('swal-res-qtd');
            const qtd = isChecklist ? pendencia.quantidade : (qtdInput ? qtdInput.value : pendencia.quantidade);

            if (obs.length < 5) return Swal.showValidationMessage("Descreva a solu√ß√£o (m√≠n. 5 letras)");
            
            return { 
                qtd: parseInt(qtd), 
                obs: obs.toUpperCase() 
            };
        }
    });

    if (resolucao) {
        // ‚úÖ GATILHO DE SANEAMENTO: Chama a l√≥gica de banco e navega√ß√£o
        resolverID(pendencia.id, uid, resolucao.qtd, resolucao.obs);
    } else {
        // Se cancelar, volta para o menu de op√ß√£o (Manter/Resolver) com os par√¢metros corretos
        abrirModalPendenciaV3(uid, 'single', nomeItem); 
    }
}
    
function processarAcaoFinalModal() {
    // 1. CAPTURA DE DADOS
    const objetivo = document.getElementById('modal-acao-objetivo').value;
    const uid = document.getElementById('modal-uid').value; // Refer√™ncia do Item/Tombamento
    const qtdInput = document.getElementById('modal-input-qtd');
    const obs = document.getElementById('modal-input-obs').value;
    const tipoOuPendenciaId = document.getElementById('modal-tipo').value; 

    // 2. VALIDA√á√ÉO DE CONTE√öDO (UX V3)
    if (obs.trim().length < 5) {
        // Alerta visual no pr√≥prio campo antes do alert do navegador
        document.getElementById('modal-input-obs').style.borderColor = "#d90f23";
        return alert("‚ö†Ô∏è Detalhamento insuficiente! Por favor, descreva a situa√ß√£o com pelo menos 5 caracteres.");
    }

    // 3. NORMALIZA√á√ÉO E SEGURAN√áA
    const qtdNumerica = parseInt(qtdInput.value) || 1;
    const uidString = String(uid);
    const refIdString = String(tipoOuPendenciaId);

    // Valida√ß√£o de limite de quantidade (evita erros de digita√ß√£o)
    if (qtdInput.max && qtdNumerica > parseInt(qtdInput.max)) {
        return alert(`‚ö†Ô∏è Erro de Quantidade! O valor m√°ximo permitido para este item √© ${qtdInput.max}.`);
    }

    // 4. ORQUESTRA√á√ÉO LOG√çSTICA
    try {
        if (objetivo === "editar") {
            executarEdicaoRelato(refIdString, uidString, qtdNumerica, obs);
        } 
        else if (objetivo === "resolver") {
            resolverID(refIdString, uidString, qtdNumerica, obs);
        } 
        else {
            salvarNovoID(uidString, qtdNumerica, refIdString, obs);
        }

        // ‚úÖ FEEDBACK V3: Efeito visual de sucesso no elemento que originou a a√ß√£o
        const elAlvo = document.querySelector(`[data-id="${uidString}"]`);
        if (elAlvo) {
            elAlvo.style.transition = "all 0.5s ease";
            elAlvo.style.boxShadow = "0 0 15px rgba(27, 138, 62, 0.4)";
            setTimeout(() => elAlvo.style.boxShadow = "none", 1500);
        }

        // 5. FECHAMENTO E LIMPEZA
        fecharModalPendencia();
        
    } catch (error) {
        console.error("Erro ao processar a√ß√£o do modal:", error);
        alert("‚ùå Ocorreu um erro ao salvar esta altera√ß√£o. Verifique o console.");
    }
}
   function executarEdicaoRelato(pendenciaId, uid, novaQtd, novaObs) {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    let editado = false;
    const idProcurado = String(pendenciaId);
    const uidAlvo = String(uid);

    // Vari√°veis para garantir o retorno ao modal certo
    let nomeParaRetorno = "";
    let tipoParaRetorno = "single";
    let saldoParaRetorno = 0;

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            let alvosParaVerificar = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            
            alvosParaVerificar.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    const p = alvo.pendencias_ids.find(pend => String(pend.id) === idProcurado);
                    
                    if (p) {
                        p.descricao = novaObs.trim().toUpperCase();
                        p.quantidade = parseInt(novaQtd) || 0;
                        editado = true;

                        // Captura dados do item para a fun√ß√£o de volta
                        nomeParaRetorno = (item.tipo === 'multi') ? `${item.nome} (${alvo.tomb})` : item.nome;
                        tipoParaRetorno = item.tipo;
                        
                        // C√°lculo de saldo atualizado para o modal
                        const totalEsperado = Number(item.quantidadeEsperada || item.quantidade || 1);
                        const totalLancado = item.pendencias_ids.reduce((s, pnd) => s + (pnd.quantidade || 0), 0);
                        saldoParaRetorno = totalEsperado - totalLancado;
                        
                        if (window.itemStatus[uidAlvo]) {
                            window.itemStatus[uidAlvo].obs = p.descricao;
                            window.itemStatus[uidAlvo].quantidade = p.quantidade;
                            window.itemStatus[uidAlvo].interacao_humana = true;
                        }
                    }
                }
            });
        });
    });

    if (editado) {
        renderizarConferencia(); // Atualiza carimbos na tela de fundo
        updateOverallStatus();

        // ‚úÖ PONTO 3: RETORNO AUTOM√ÅTICO AO MODAL DE GERENCIAMENTO
        setTimeout(() => {
            abrirModalPendenciaV3(uidAlvo, tipoParaRetorno, nomeParaRetorno, saldoParaRetorno);
            
            // Notifica√ß√£o sutil de sucesso (Toast)
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ icon: 'success', title: 'Altera√ß√£o salva!' });
            
            // Efeito visual na linha (atr√°s do modal)
            const el = document.getElementById(`item-row-${uidAlvo}`);
            if (el) {
                el.style.backgroundColor = "#e3f2fd";
                setTimeout(() => el.style.backgroundColor = "", 1000);
            }
        }, 300);

    } else {
        console.error("V3 Error: Pend√™ncia " + idProcurado + " n√£o encontrada.");
        alert("‚ùå Erro ao salvar: O registro original sumiu da mem√≥ria.");
    }
}
async function confirmarExclusaoRelato(pendenciaId, uid) {
    const result = await Swal.fire({
        title: 'Apagar Altera√ß√£o?',
        text: "Esta a√ß√£o remover√° o relato tempor√°rio.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: '<i class="fas fa-trash-alt"></i> SIM, APAGAR',
        cancelButtonText: 'CANCELAR',
        reverseButtons: true
    });

    if (!result.isConfirmed) return;

    const fonteDados = window.dadosConferencia || dadosConferencia;
    let excluido = false;
    const idProcurado = String(pendenciaId);
    const uidAlvo = String(uid);

    // Vari√°veis para o retorno inteligente
    let nomeParaRetorno = "";
    let tipoParaRetorno = "single";
    let saldoParaRetorno = 0;
    let totalPendenciasRestantes = 0;

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            let alvos = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            alvos.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    const index = alvo.pendencias_ids.findIndex(p => String(p.id) === idProcurado);
                    
                    if (index > -1) {
                        alvo.pendencias_ids.splice(index, 1);
                        excluido = true;
                        totalPendenciasRestantes = alvo.pendencias_ids.length;

                        // Captura dados para reabrir o modal se n√£o estiver vazio
                        nomeParaRetorno = (item.tipo === 'multi') ? `${item.nome} (${alvo.tomb})` : item.nome;
                        tipoParaRetorno = item.tipo;
                        const totalEsperado = Number(item.quantidadeEsperada || item.quantidade || 1);
                        saldoParaRetorno = totalEsperado - alvo.pendencias_ids.reduce((s, pnd) => s + pnd.quantidade, 0);
                        
                        if (totalPendenciasRestantes === 0) {
                            delete window.itemStatus[uidAlvo];
                            const elItem = document.getElementById(`item-row-${uidAlvo}`);
                            if (elItem) {
                                elItem.classList.remove('status-alert', 'status-ok', 'has-carimbo');
                                const btnAlert = elItem.querySelector('.btn-alert');
                                if(btnAlert) btnAlert.classList.remove('active');
                            }
                        }
                    }
                }
            });
        });
    });

    if (excluido) {
        renderizarConferencia(); 
        updateOverallStatus();

        // ‚úÖ PONTO 3: RETORNO AO MODAL (Apenas se ainda houver o que gerenciar)
        if (totalPendenciasRestantes > 0) {
            setTimeout(() => {
                abrirModalPendenciaV3(uidAlvo, tipoParaRetorno, nomeParaRetorno, saldoParaRetorno);
                Swal.showValidationMessage("Relato removido com sucesso"); // Feedback dentro do modal
            }, 300);
        } else {
            // Se era o √∫nico relato, apenas mostra o Toast de sucesso na tela principal
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ icon: 'success', title: 'Relato removido' });
        }
    }
}
    
function salvarNovoID(uid, qtd, tipo, obsModal = null) {
    const obsDigitada = obsModal ? obsModal.trim().toUpperCase() : "";
    const qtdInformada = parseInt(qtd) || 1;
    
    // 1. CAPTURA DE ASSINATURA SEGURA
    let nomeAssinatura = `${userInfo.postoGraduacao} ${userInfo.nomeGuerra}`;

    // 2. CRIA√á√ÉO DO OBJETO DE PEND√äNCIA (Ponto 1: Id√™ntico ao Banco)
    const novoID = {
        id: "TEMP-" + Date.now(), 
        tipo: "PENDENCIA",
        data_criacao: new Date().toLocaleDateString('pt-BR'),
        autor_uid: String(userInfo.uid || "S_UID"),
        autor_nome: nomeAssinatura,
        descricao: obsDigitada,
        quantidade: qtdInformada,
        status_gestao: "PENDENTE"
    };

    let itemEncontrado = false;
    let nomeItemParaRetorno = ""; // Guardamos para o retorno do modal
    let saldoRestanteParaRetorno = 0;
    const fonteDados = window.dadosConferencia || dadosConferencia;

    // 3. BUSCA E INSER√á√ÉO (Ponto 2: Permite m√∫ltiplos via .push)
    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            const isChecklist = window.isModoChecklist;
            const idRealDoItem = isChecklist ? item.id : (item.uid_global || item.id);
            const matchesID = (String(idRealDoItem) === String(uid));

            if (['single', 'texto_livre', 'upload_foto'].includes(item.tipo) && matchesID) {
                if (!item.pendencias_ids) item.pendencias_ids = [];
                item.pendencias_ids.push(novoID); // Adiciona sem apagar o anterior
                itemEncontrado = true;
                nomeItemParaRetorno = item.nome;
                saldoRestanteParaRetorno = (item.quantidadeEsperada || 1) - item.pendencias_ids.reduce((s, p) => s + p.quantidade, 0);
            } 
            else if (item.tipo === 'multi' && item.tombamentos) {
                item.tombamentos.forEach(t => {
                    const uidComposto = `${item.uid_global || item.id}-${t.tomb}`;
                    if (String(uid) === uidComposto) {
                        if (!t.pendencias_ids) t.pendencias_ids = [];
                        t.pendencias_ids.push(novoID);
                        itemEncontrado = true;
                        nomeItemParaRetorno = `${item.nome} (${t.tomb})`;
                    }
                });
            }
        });
    });

    if (itemEncontrado) {
        // 4. ATUALIZA√á√ÉO DO STATUS (Ponto 2: N√£o sobrescreve, acumula)
        if (!window.itemStatus[uid]) window.itemStatus[uid] = {};
        
        const uidStr = String(uid);
        const uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0,4).join('-') : uidStr.split('-')[0];

        window.itemStatus[uid] = { 
            ...window.itemStatus[uid],
            status: 'C/A', 
            interacao_humana: true,
            uid_global_ref: uidGlobalFull
        };
        
        // 5. FEEDBACK VISUAL
        renderizarConferencia(); // Renderiza para o novo carimbo aparecer na linha
        updateOverallStatus();

        // ‚úÖ PONTO 3: RETORNO AO MODAL (O segredo do fluxo cont√≠nuo)
        // Em vez de pular para o pr√≥ximo, reabrimos o gerenciador para ele ver o carimbo azul
        setTimeout(() => {
            abrirModalPendenciaV3(uid, tipo, nomeItemParaRetorno, saldoRestanteParaRetorno);
            
            // Notifica√ß√£o discreta de sucesso
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ icon: 'success', title: 'Relato adicionado!' });
        }, 300);

    } else {
        console.error("V3 Error: Falha de v√≠nculo no salvamento.", { uid });
    }
}
   // ‚úÖ FUN√á√ÉO M√ÅGICA: VERIFICA CONCLUS√ÉO E VOLTA TELA
function verificarFluxoSetor(uidAtual) {
    const rowAtual = document.getElementById(`item-row-${uidAtual}`);
    const nextRow = rowAtual ? rowAtual.nextElementSibling : null;

    if (nextRow && nextRow.classList.contains('v3-item-row')) {
        // AINDA H√Å ITENS: Rola para o pr√≥ximo
        setTimeout(() => {
            nextRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Efeito visual de foco no pr√≥ximo
            nextRow.style.backgroundColor = "#f0f9ff";
            setTimeout(() => nextRow.style.backgroundColor = "", 1000);
        }, 300);
    } else {
        // FIM DO SETOR: Feedback de sucesso e volta para a Tela 1
        const Toast = Swal.mixin({
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'success',
            title: 'Setor Conclu√≠do!'
        });

        setTimeout(() => {
            navegarParaSetores(); // Volta para a lista de setores (Tela 1)
        }, 1500);
    }
}
function manterID(pendenciaId, uid) {
    // 1. GARANTE A EXIST√äNCIA DO OBJETO E DNA DO ITEM
    if (!window.itemStatus[uid]) {
        window.itemStatus[uid] = { 
            status: 'C/A', 
            ids_mantidos: [], 
            interacao_humana: true 
        };
    }
    
    if (!window.itemStatus[uid].ids_mantidos) {
        window.itemStatus[uid].ids_mantidos = [];
    }
    
    // 2. REGISTRO DO ID MANTIDO (DNA SEGURO)
    const idStr = String(pendenciaId);
    if (!window.itemStatus[uid].ids_mantidos.includes(idStr)) {
        window.itemStatus[uid].ids_mantidos.push(idStr);
    }
    
    // 3. ATUALIZA√á√ÉO DO ESTADO GLOBAL DO ITEM
    window.itemStatus[uid].status = 'C/A';
    window.itemStatus[uid].interacao_humana = true;

    // V√çNCULO COM O UID GLOBAL COMPLETO
    if (!window.itemStatus[uid].uid_global_ref) {
        const uidStr = String(uid);
        const uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0, 4).join('-') : uidStr.split('-')[0];
        window.itemStatus[uid].uid_global_ref = uidGlobalFull;
    }

    // 4. FEEDBACK VISUAL NA LINHA ELEGANTE V3
    const row = document.getElementById(`item-row-${uid}`);
    if (row) {
        row.classList.remove('status-ok');
        row.classList.add('status-alert');
        
        // Ativa visualmente o bot√£o de alerta na linha
        const btnAlert = row.querySelector('.btn-alert');
        if (btnAlert) btnAlert.classList.add('active');
        
        // Efeito sutil de confirma√ß√£o na linha
        row.style.transition = "transform 0.2s ease";
        row.style.transform = "scale(1.02)";
        setTimeout(() => row.style.transform = "scale(1)", 200);
    }

    // 5. ATUALIZA√á√ÉO DO PROGRESSO E GATILHO DE FLUXO
    updateOverallStatus();
    
    // ‚úÖ GATILHO M√ÅGICO V3: Verifica se pula para o pr√≥ximo item ou volta para os setores
    verificarFluxoSetor(uid);
}

function resolverID(pendenciaId, uid, qtdResolvidaModal, justificativaModal) {
    const qtdResolvida = parseInt(qtdResolvidaModal) || 1;
    const justificativa = justificativaModal ? justificativaModal.trim().toUpperCase() : "";
    const nomeResolutor = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const fonteDados = window.dadosConferencia || [];
    const isChecklist = window.isModoChecklist; // ‚úÖ Contexto Checklist
    let acaoConcluida = false;
    let pendenciasRestantes = 0;

    const idProcurado = String(pendenciaId);
    const isResolvendoAvaria = idProcurado.startsWith('AVARIA-');

    // --- L√ìGICA DE BAIXA NO OBJETO (N√öCLEO DO SISTEMA) ---
    function executarBaixaNoObjeto(obj) {
        if (isResolvendoAvaria) {
            if (!obj.historico_vida) obj.historico_vida = [];
            obj.historico_vida.push({
                evento: "RESOLU√á√ÉO_AVARIA_CAUTELA",
                data: new Date().toLocaleString('pt-BR'),
                quem: nomeResolutor,
                detalhes: `AVARIA RESOLVIDA. JUSTIFICATIVA: ${justificativa}`,
                cautela_origem: idProcurado.replace('AVARIA-', '')
            });
            obj.situacao = "DISPON√çVEL"; 
            obj.status = "OK";
            delete obj.id_cautela_origem;
            delete obj.motivo_avaria;
            return true;
        }

        if (!obj.pendencias_ids) return false;
        const index = obj.pendencias_ids.findIndex(p => String(p.id) === idProcurado);
        
        if (index === -1) return false;

        const pOriginal = obj.pendencias_ids[index];
        if (!obj.historico_vida) obj.historico_vida = [];
        
        const registroHistorico = {
            id_referencia: pOriginal.id,
            evento: qtdResolvida >= pOriginal.quantidade ? "SOLUCAO_TOTAL" : "SOLUCAO_PARCIAL",
            quantidade: qtdResolvida,
            data: new Date().toLocaleString('pt-BR'),
            quem: nomeResolutor,
            detalhes: `RESOLVIDO VIA CONFER√äNCIA. JUSTIFICATIVA: ${justificativa}. (REF: ${pOriginal.descricao})`
        };

        if (qtdResolvida >= pOriginal.quantidade) {
            obj.pendencias_ids.splice(index, 1);
        } else {
            pOriginal.quantidade -= qtdResolvida;
        }

        obj.historico_vida.push(registroHistorico);
        pendenciasRestantes = obj.pendencias_ids.length;
        return true;
    }

    // --- BUSCA E APLICA√á√ÉO ---
    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            // ‚úÖ AJUSTE: No checklist comparamos apenas o ID √∫nico
            const matchesSingle = isChecklist ? (String(item.id) === String(uid)) : (String(item.id) === String(uid) || String(item.uid_global) === String(uid));
            
            if (matchesSingle) {
                acaoConcluida = executarBaixaNoObjeto(item);
            } else if (item.tombamentos) {
                item.tombamentos.forEach(t => {
                    const uidCompostoGlobal = `${item.uid_global || item.id}-${t.tomb}`;
                    const uidCompostoLocal = `${item.id}-${t.tomb}`;
                    if (String(uid) === uidCompostoGlobal || String(uid) === uidCompostoLocal) {
                        acaoConcluida = executarBaixaNoObjeto(t);
                    }
                });
            }
        });
    });

    if (acaoConcluida) {
        if (!window.itemStatus[uid]) window.itemStatus[uid] = {};
        
        const uidStr = String(uid);

        // ‚úÖ AJUSTE DNA V3: Define a refer√™ncia global de forma protegida para Checklist
        let uidGlobalFull = "";
        if (isChecklist) {
            uidGlobalFull = "ITEM_VISTORIA_LIVRE";
        } else {
            uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0, 4).join('-') : uidStr.split('-')[0];
        }
        
        window.itemStatus[uid].status = (pendenciasRestantes > 0) ? 'C/A' : 'ok';
        window.itemStatus[uid].interacao_humana = true;
        window.itemStatus[uid].uid_global_ref = uidGlobalFull;
        
        if (window.itemStatus[uid].ids_mantidos) {
            window.itemStatus[uid].ids_mantidos = window.itemStatus[uid].ids_mantidos.filter(id => String(id) !== idProcurado);
        }

        const row = document.getElementById(`item-row-${uid}`);
        if (row) {
            if (pendenciasRestantes === 0) {
                row.classList.remove('status-alert');
                row.classList.add('status-ok');
                const btnCheck = row.querySelector('.btn-check');
                const btnAlert = row.querySelector('.btn-alert');
                if (btnCheck) btnCheck.classList.add('active');
                if (btnAlert) btnAlert.classList.remove('active');
            }
            
            row.style.transition = "all 0.5s ease";
            row.style.backgroundColor = "#e8f5e9";
            setTimeout(() => row.style.backgroundColor = "", 1500);
        }

        updateOverallStatus();
        verificarFluxoSetor(uid);

    } else {
        Swal.fire('Erro', 'N√£o foi poss√≠vel localizar o registro.', 'error');
    }
}
    function setItemStatusID(btn, status, uid) {
    // 1. GARANTIA DE OBJETO DE MEM√ìRIA
    if (!window.itemStatus[uid]) window.itemStatus[uid] = {};

    const isChecklist = window.isModoChecklist;
    const uidStr = String(uid);
    
    // ‚úÖ AJUSTE V3: Defini√ß√£o inteligente da refer√™ncia global
    // Se for checklist, a refer√™ncia global √© o ID gen√©rico. Se n√£o, extrai o ID do invent√°rio.
    let uidGlobalFull = "";
    if (isChecklist) {
        uidGlobalFull = "ITEM_VISTORIA_LIVRE";
    } else {
        uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0, 4).join('-') : uidStr.split('-')[0];
    }

    // 2. L√ìGICA DE ATUALIZA√á√ÉO POR STATUS
    if (status === 'ok') {
        window.itemStatus[uid] = { 
            ...window.itemStatus[uid], 
            status: 'ok', 
            interacao_humana: true,
            uid_global_ref: uidGlobalFull 
        };

        const row = document.getElementById(`item-row-${uid}`);
        if (row) {
            row.classList.remove('status-alert');
            row.classList.add('status-ok');
            
            const btnCheck = row.querySelector('.btn-check');
            const btnAlert = row.querySelector('.btn-alert');
            if (btnCheck) btnCheck.classList.add('active');
            if (btnAlert) btnAlert.classList.remove('active');
            
            // Remove o fundo de alerta caso existisse
            row.style.backgroundColor = "";
        }

        verificarFluxoSetor(uid);

    } else if (status === 'cautela_ciente') {
        window.itemStatus[uid] = { 
            ...window.itemStatus[uid], 
            status: 'cautela_ciente', 
            cautela_confirmada: true, 
            interacao_humana: true,
            uid_global_ref: uidGlobalFull
        };

        btn.innerHTML = '<i class="fas fa-check-double"></i> Ciente registrado';
        btn.disabled = true;
        btn.style.opacity = "0.8";

        setTimeout(() => {
            renderizarConferencia();
            updateOverallStatus();
            verificarFluxoSetor(uid);
        }, 400);
    }

    // 3. ATUALIZA√á√ÉO DO PROGRESSO (Barra Neon e Badges da Tela 1)
    updateOverallStatus();
}
    async function verExtratoCautela(cautelaId) {
    if (!cautelaId) return;
    try {
        const doc = await db.collection('cautelas_abertas').doc(cautelaId).get();
        if (!doc.exists) return alert("Cautela n√£o encontrada.");

        const data = doc.data();
        
        const html = `
            <div id="extrato-wrapper" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 29999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                <div style="position: relative; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 15px; z-index: 30000; width: 85%; max-width: 320px; border-top: 4px solid #f57c00; font-family: Arial, sans-serif;" onclick="event.stopPropagation()">
                    <h4 style="margin:0 0 10px 0; color:#800020; font-size:1em; border-bottom:1px solid #eee; padding-bottom:5px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-eye"></i> Detalhes da Cautela
                    </h4>
                    <p style="font-size:0.85em; margin:8px 0; color: #333;"><b>Emitente:</b><br>${data.emitente}</p>
                    
                    <p style="font-size:0.85em; margin:12px 0; color: #333; display: flex; align-items: center; gap: 8px;">
                        <b>Status:</b> 
                        <span style="background: #f57c00; color: white; padding: 3px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85em; text-transform: uppercase;">
                            ${data.status}
                        </span>
                    </p>

                    <p style="font-size:0.85em; margin:10px 0 5px 0; color: #333;"><b>Observa√ß√£o:</b></p>
                    <div style="font-size:0.8em; background:#f9f9f9; padding:8px; border-radius:4px; font-style:italic; color:#555; max-height:100px; overflow-y:auto; border: 1px solid #eee; line-height: 1.4;">
                        ${data.observacoes_emissao || 'Sem observa√ß√µes.'}
                    </div>
                    <button onclick="document.getElementById('extrato-wrapper').remove()" style="width:100%; margin-top:15px; padding:10px; background:#800020; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; text-transform: uppercase; font-size: 0.8em;">Fechar</button>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } catch (e) { console.error(e); }
}
async function finalizarRecebimentoCarga(transferenciaData) {
    const btn = document.getElementById('btn-finalizar');
    const originalText = btn.textContent;
    btn.textContent = "PROCESSANDO RECEBIMENTO...";
    btn.disabled = true;

    // ‚úÖ CIR√öRGICO: Garante a captura do ID da Guia (vinda do banco ou da URL)
    const urlParams = new URLSearchParams(window.location.search);
    const transferenciaId = transferenciaData.id || transferenciaData.transferencia_id || urlParams.get('transferenciaId');
    
    const unidadeDestinoId = transferenciaData.destino_id;
    const siglaDestino = transferenciaData.destino_sigla;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');

    if (!transferenciaId) {
        alert("Erro: ID da transfer√™ncia n√£o localizado.");
        btn.disabled = false;
        btn.textContent = "CONFIRMAR RECEBIMENTO";
        return;
    }

    try {
        const batch = db.batch();
        const transRef = db.collection('transferencias_pendentes').doc(transferenciaId);

        // 1. PROCESSAMENTO DOS ITENS NO INVENT√ÅRIO
        for (const item of transferenciaData.itens) {
            const uidGlobal = item.id_base || item.id;
            const uidBusca = item.tombamento ? `${uidGlobal}-${item.tombamento}` : uidGlobal;
            
            const statusLocal = window.itemStatus[uidBusca] || { status: 'ok' };
            const itemRef = db.collection('inventario').doc(uidGlobal);

            if (item.tombamento) {
                // ‚úÖ L√ìGICA MULTI: Atualiza o Prontu√°rio (Tombamento)
                const tombRef = itemRef.collection('tombamentos').doc(item.tombamento);
                
                batch.update(tombRef, {
                    situacao_atual: statusLocal.status === 'ok' ? "DISPON√çVEL" : "PENDENTE",
                    local_id: unidadeDestinoId,
                    unidade_sigla: siglaDestino,
                    sub_local: "ALMOXARIFADO SETORIAL",
                    recebido_por: meuNomeCompleto,
                    data_recebimento: dataAtual,
                    unidade_destino_id: firebase.firestore.FieldValue.delete(), 
                    unidade_destino_sigla: firebase.firestore.FieldValue.delete()
                });

                const idEvt = "REC-" + Date.now();
                batch.set(tombRef.collection('historico_vida').doc(idEvt), {
                    data: dataAtual,
                    evento: "RECEBIMENTO_CARGA",
                    quem: meuNomeCompleto,
                    detalhes: statusLocal.status === 'ok' 
                        ? `Material recebido e conferido S/A na unidade ${siglaDestino}.` 
                        : `Material recebido com ALTERA√á√ÉO: ${statusLocal.obs || 'N√£o descrita'}.`
                });

            } else {
                // ‚úÖ L√ìGICA SINGLE: Blindagem de quantidade e cria√ß√£o de saldo
                const qtdRecebida = Number(item.quantidade) || 0;
                const saldoRef = itemRef.collection('saldos_unidades').doc(unidadeDestinoId);

                batch.set(saldoRef, {
                    qtd_transito: firebase.firestore.FieldValue.increment(-qtdRecebida),
                    qtd_disp: firebase.firestore.FieldValue.increment(qtdRecebida),
                    qtd_total: firebase.firestore.FieldValue.increment(qtdRecebida),
                    unidade_sigla: siglaDestino,
                    last_update: dataAtual
                }, { merge: true });

                const idEvtS = "REC-S-" + Date.now();
                batch.set(saldoRef.collection('historico_vida').doc(idEvtS), {
                    data: dataAtual,
                    evento: "RECEBIMENTO_CARGA",
                    quem: meuNomeCompleto,
                    quantidade: qtdRecebida, // ‚úÖ Salva a quantidade espec√≠fica deste lote
                    guia_id: transferenciaId, // Para o link com a guia
                    detalhes: `Carga recebida (${qtdRecebida} un.). Guia: ${transferenciaData.id_amigavel || transferenciaId}. Status: ${statusLocal.status.toUpperCase()}.`
                });
            }
        }

        // 1.5 ‚úÖ PREPARA OS ITENS COM O STATUS DA CONFER√äNCIA PARA O PDF POSTERIOR
        // Isso garante que o hist√≥rico salve o que o CAP JOS√â MIGUEL conferiu de fato.
        const itensAtualizadosParaHistorico = transferenciaData.itens.map(item => {
            const uidBusca = item.tombamento ? `${item.id_base || item.id}-${item.tombamento}` : (item.id_base || item.id);
            const statusLocal = window.itemStatus[uidBusca] || { status: 'ok' };
            
            return {
                ...item,
                status_recebimento: statusLocal.status === 'ok' ? 'S/A' : 'C/A',
                observacao_recebimento: statusLocal.obs || ''
            };
        });

        // 2. ATUALIZA O STATUS DA TRANSFER√äNCIA NO BANCO
        batch.update(transRef, {
            status: "RECEBIDO",
            recebedor_nome: meuNomeCompleto,
            recebedor_uid: userInfo.uid, 
            timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
            modo: 'TRANSFERENCIA_CARGA',
            itens: itensAtualizadosParaHistorico // ‚úÖ Salva a confer√™ncia final na guia
        });

        await batch.commit();
        
        // Conforme solicitado, a impress√£o agora √© manual via "Minhas Atividades"
        alert(`‚úÖ Carga recebida com sucesso!\nO Termo de Recebimento j√° est√° dispon√≠vel em "Minhas Atividades".`);
        
        if (window.parent) {
            window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        }

    } catch (e) {
        console.error("Erro ao finalizar recebimento:", e);
        alert("Erro t√©cnico ao processar recebimento: " + e.message);
        btn.disabled = false;
        btn.textContent = originalText;
    }
}
    window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
