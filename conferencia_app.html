<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="sigma-comum.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box; }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold; } 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333; text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        
        /* SETORES E ITENS */
        .setor-header { background-color: #800020; color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s; }
        .setor-info { display: flex; align-items: center; gap: 10px; }
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px; border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e; }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .arrow { font-size: 1.2em; transition: transform 0.4s; }
        
        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease; }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0; }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0; }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1; }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD; } 
        
        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold; font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '‚úì'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center; }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A'; font-size: 10px; line-height: 18px; color: white; display: block; text-align: center; }
        
        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e; } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        /* ESTILOS PEND√äNCIAS */
        .pendencia-alert-box { font-size: 0.85em; margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s; }
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd; }
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9; }
        
        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0; }
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left; line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none; }
        
        .texto-admin { font-weight: bold; color: #0d47a1; }
        .linha-obs { color: #333; font-weight: 500; }
        
        .pendencia-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px; }
        .btn-manter { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; } 
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        .historico-fixo { background-color: #eeeeee; border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none; }
        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left; padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .tombamento-options { display: flex; gap: 5px; } .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23; display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block; margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px; }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em; }
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px; border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px; }
        
        #btn-finalizar { background-color: #d90f23; color: white; font-weight: bold; border: none; padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease; margin-top: 30px; font-size: 1.1em; box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4); }
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; }
        
        .draft-badge { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Confer√™ncia de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><strong>Rascunho recuperado:</strong> Voc√™ est√° continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Inicializando sistema...</div>
        <div id="main-content" style="display: none;">
            <button id="btn-finalizar" onclick="finalizarConferencia()" disabled>
    FINALIZAR CONFER√äNCIA (0/X ITENS)
</button>
        </div>
    </div>
    <div id="modal-nova-pendencia" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 20000;">
    <div class="modal-content" style="background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); position: relative; border-top: 5px solid #d90f23; font-family: Arial, sans-serif;">
        
        <h2 id="modal-titulo-item" style="margin-top: 0; color: #800020; font-size: 1.3em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; text-align: left;">Relatar Altera√ß√£o</h2>
        <p id="modal-subtitulo-detalhe" style="font-size: 0.85em; color: #666; margin-bottom: 20px; text-align: left;"></p>

        <input type="hidden" id="modal-uid">
        <input type="hidden" id="modal-tipo">

        <div id="modal-grupo-qtd" style="display:none; margin-top: 15px; margin-bottom: 15px; text-align: left;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #d90f23; font-family: sans-serif;">Unidades Afetadas:</label>
    
            <input type="number" id="modal-input-qtd" min="1" value="1" 
                   style="width: 100%; padding: 12px; border: 2px solid #d90f23; border-radius: 6px; box-sizing: border-box; font-size: 1.1em; text-align: center; font-weight: bold;">
    
            <small id="modal-info-max" style="display: block; color: #888; margin-top: 5px; font-size: 0.8em; font-style: italic; font-family: sans-serif;"></small>
        </div>

        <div style="margin-top: 15px; text-align: left;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;">Descri√ß√£o do Problema:</label>
            <textarea id="modal-input-obs" placeholder="Descreva o problema..." style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; min-height: 100px; resize: vertical; font-family: inherit;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" onclick="fecharModalPendencia()" style="flex: 1; background: #eee; border: 1px solid #ccc; color: #333; cursor: pointer; padding: 12px; border-radius: 6px; font-weight: bold;">Cancelar</button>
            <button type="button" onclick="confirmarInclusaoPendencia()" style="flex: 2; background: #800020; color: white; border: none; cursor: pointer; padding: 12px; border-radius: 6px; font-weight: bold;">INCLUIR</button>
        </div>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", 
        authDomain: "sigma-cbmrr.firebaseapp.com", 
        projectId: "sigma-cbmrr", 
        storageBucket: "sigma-cbmrr.firebasestorage.app", 
        messagingSenderId: "378026276038", 
        appId: "1:378026276038:web:620dd6ff57501b1a8313c7" 
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const LISTA_ID = urlParams.get('id');
    const COLECAO_LISTAS = 'listas_conferencia';
    const COLECAO_CAUTELAS = 'cautelas_abertas';
    
    let MODO_OPERACAO = 'recebimento'; 
    let DESTINATARIO_DEVOLUCAO = null; 
    
    const CAUTELA_ID = urlParams.get('cautelaId');
    const modoParam = urlParams.get('modo');
    const USER_UID = urlParams.get('user_uid');

    if (modoParam === 'devolucao') {
        MODO_OPERACAO = 'devolucao';
        DESTINATARIO_DEVOLUCAO = urlParams.get('destinatarioDevolucao');
    } else if (modoParam === 'devolucao_final') {
        MODO_OPERACAO = 'devolucao_final';
    }

    let dadosConferencia = [];
    let isCautela = !!CAUTELA_ID;
    let infoLocal = { nome: '', posto: '' }; 
    window.itemStatus = {};

    function getUrlParameter(n) { 
        return (new URLSearchParams(window.location.search)).get(n) || ''; 
    }
    
    const userInfo = { 
        postoGraduacao: getUrlParameter('posto_grad') || "ND", 
        quadro: getUrlParameter('quadro_mil') || "ND", 
        nomeGuerra: getUrlParameter('nome_guerra') || "ND",
        uid: USER_UID || "ND"
    };

    function formatarDataSimples(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('pt-BR');
    }

    function updateHeaderInfo() {
        const el = document.getElementById('militar-info');
        if(el) el.innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`;
    }

    function updateOverallStatus() {
    // 1. Seleciona todos os blocos que exigem confer√™ncia (Singles e cada Tombamento)
    const blocosConferencia = document.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]');
    const totalGeral = blocosConferencia.length;
    let concluidosGeral = 0;

    // 2. Percorre cada bloco e verifica se o status na mem√≥ria √© diferente de 'pending'
    blocosConferencia.forEach(bloco => {
        const uid = bloco.getAttribute('data-tomb') 
            ? `${bloco.closest('.item-conferencia').getAttribute('data-id')}-${bloco.getAttribute('data-tomb')}`
            : bloco.getAttribute('data-id');

        if (window.itemStatus[uid] && window.itemStatus[uid].status !== 'pending') {
            concluidosGeral++;
        }
    });

    // 3. Gerencia o visual do bot√£o
    const btn = document.getElementById('btn-finalizar');
    if (btn) {
        let buttonPrefix = 'FINALIZAR CONFER√äNCIA';
        
        // Mant√©m sua l√≥gica de modo devolu√ß√£o se existir
        if (typeof MODO_OPERACAO !== 'undefined' && MODO_OPERACAO === 'devolucao') {
            buttonPrefix = 'FINALIZAR DEVOLU√á√ÉO';
        }

        btn.textContent = `${buttonPrefix} (${concluidosGeral}/${totalGeral} ITENS)`;

        // 4. Habilita/Desabilita e troca cores baseado na conclus√£o real
        if (totalGeral > 0 && concluidosGeral >= totalGeral) {
            btn.disabled = false;
            btn.style.backgroundColor = '#1b8a3e'; // Verde Sucesso
            btn.style.cursor = 'pointer';
            btn.style.opacity = '1';
        } else {
            btn.disabled = true;
            btn.style.backgroundColor = '#d90f23'; // Vermelho Padr√£o
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.6';
        }
    }

    // 5. Sincroniza os contadores dos setores (opcional, para garantir consist√™ncia visual)
    document.querySelectorAll('.setor').forEach(s => {
        const itensSetor = s.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]');
        let setorComp = 0;
        itensSetor.forEach(i => {
            const iUid = i.getAttribute('data-tomb') 
                ? `${i.closest('.item-conferencia').getAttribute('data-id')}-${i.getAttribute('data-tomb')}`
                : i.getAttribute('data-id');
            if (window.itemStatus[iUid] && window.itemStatus[iUid].status !== 'pending') setorComp++;
        });
        const statusDiv = s.querySelector('.setor-status');
        if (statusDiv) {
            statusDiv.innerText = `${setorComp}/${itensSetor.length}`;
            statusDiv.dataset.completed = setorComp;
        }
    });
}

        function updateSetorStatus(setorEl) { 
            const items = setorEl.querySelectorAll('.item-conferencia'); 
            let completed = 0, total = 0; 
            items.forEach(item => { 
                if (item.dataset.type === 'single') { 
                    total++; const s = window.itemStatus[item.dataset.id]?.status; 
                    if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                } else { 
                    const tombs = item.querySelectorAll('.tombamento-container'); 
                    tombs.forEach(t => { 
                        total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                        if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                    }); 
                } 
            }); 
            setorEl.dataset.totalItems = total; 
            const st = setorEl.querySelector('.setor-status'); 
            st.dataset.completed = completed; 
            if (completed === total && total > 0) { st.textContent = 'OK'; st.classList.add('ok'); } 
            else { st.textContent = `${completed}/${total}`; st.classList.remove('ok'); } 
        }

        function updateItemMainStatusDisplay(item) { 
            if (item.dataset.type === 'single') return; 
            const tombs = item.querySelectorAll('.tombamento-container'); let conf = 0, alt = 0; 
            tombs.forEach(t => { 
                const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                if (s === 'S/A' || s === 'C/A' || s === 'KEEP') { conf++; if (s === 'C/A' || s === 'KEEP') alt++; } 
            }); 
            const icon = item.querySelector('.status-icon'); item.className = 'item-conferencia item-has-tombamentos'; icon.className = 'status-icon'; 
            if (conf === tombs.length) { 
                if (alt > 0) { icon.classList.add('alert'); item.classList.add('status-alert'); } 
                else { icon.classList.add('ok'); item.classList.add('status-ok'); } 
            } 
        }

        function toggleSetor(header) { 
            const content = header.nextElementSibling; const arrow = header.querySelector('.arrow'); 
            if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '‚ñ∫'; } 
            else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='‚ñ∫';}); content.classList.add('expanded'); arrow.textContent = '‚ñº'; } 
        }

        function checkSetorCompletion(currentSetor, currentItemId) {
    if (!currentSetor) return;

    // 1. CORRE√á√ÉO: Seleciona apenas os blocos que representam uma a√ß√£o de confer√™ncia
    // (tombamentos individuais OU itens single que n√£o t√™m tombamento)
    const blocosConferencia = currentSetor.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]');
    const total = blocosConferencia.length;
    let concluidos = 0;

    // 2. Conta os blocos conferidos no window.itemStatus
    blocosConferencia.forEach(bloco => {
        let uid;
        if (bloco.classList.contains('tombamento-container')) {
            const itemPaiId = bloco.closest('.item-conferencia').getAttribute('data-id');
            const tombNumero = bloco.getAttribute('data-tomb');
            uid = `${itemPaiId}-${tombNumero}`;
        } else {
            uid = bloco.getAttribute('data-id');
        }

        if (window.itemStatus[uid] && window.itemStatus[uid].status !== 'pending') {
            concluidos++;
        }
    });

    // 3. Atualiza o contador visual
    const statusDiv = currentSetor.querySelector('.setor-status');
    if (statusDiv) {
        statusDiv.innerText = `${concluidos}/${total}`;
        statusDiv.dataset.completed = concluidos;
    }

    // 4. L√ìGICA DE AVAN√áO: Agora baseada na contagem real e unificada
    if (concluidos === total && total > 0) {
        setTimeout(() => {
            autoAdvanceSetor(currentSetor.dataset.id);
        }, 300);
    } else {
        focusNextItem(currentItemId);
    }
}
        function focusNextItem(currentItemId) { 
            const allItems = Array.from(document.querySelectorAll('.item-conferencia')); 
            let baseId = currentItemId.split('-')[0]; 
            const idx = allItems.findIndex(i => i.dataset.id === baseId); 
            for (let i = idx; i < allItems.length; i++) { 
                const item = allItems[i]; if (!item) continue; const id = item.dataset.id; 
                if (item.dataset.type === 'single') { 
                    const st = window.itemStatus[id]; 
                    if (!st || st.status === 'pending' || st.status === 'PENDING_CA') { 
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        if (st && st.status === 'PENDING_CA') item.querySelector('textarea').focus(); return; 
                    } 
                } 
                if (item.dataset.type === 'multi') { 
                    const pendingTomb = Array.from(item.querySelectorAll('.tombamento-container')).find(t => { 
                        const uid = `${id}-${t.dataset.tomb}`; const s = window.itemStatus[uid]?.status; return s === 'pending' || s === 'PENDING_CA'; 
                    }); 
                    if (pendingTomb) { 
                        pendingTomb.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        const uid = `${id}-${pendingTomb.dataset.tomb}`; 
                        if (window.itemStatus[uid]?.status === 'PENDING_CA') pendingTomb.querySelector('textarea').focus(); return; 
                    } 
                } 
            } 
        }

        function autoAdvanceSetor(sid) { 
            const s = document.querySelector(`.setor[data-id="${sid}"]`); 
            if (s) toggleSetor(s.querySelector('.setor-header')); 
            const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1]; 
            if (nextId) { 
                const next = document.querySelector(`.setor[data-id="${nextId}"]`); 
                if (next) { const h = next.querySelector('.setor-header'); toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' }); } 
            } 
        }
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        
        
        function limparRascunho() {
            localStorage.removeItem('sigma_active_conf');
            const listId = CAUTELA_ID || LISTA_ID; // Pega o ID da lista ou cautela
            const userId = (userInfo && userInfo.nomeGuerra) 
            ? userInfo.nomeGuerra.toUpperCase() 
            : null;

            if (listId && userId) {
                // Esta chave DEVE ser a mesma usada na fun√ß√£o salvarRascunho()
                const draftKey = `sigma_draft_${userId}_${listId}`; 
                localStorage.removeItem(draftKey);
                console.log(`Rascunho local (${draftKey}) limpo com sucesso.`);
            }
        }

       // --- 1. FUN√á√ÉO PARA LER DADOS ANTIGOS (LEGADOS) ---
const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
    const separator = ' | + NOVA: ';
    if (typeof textoBruto !== 'string') return [];
    
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
            if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
        if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
    }
    return linhas;
};

// --- 2. FUN√á√ÉO VISUAL √öNICA (SEM HORAS VIA REGEX) ---
const gerarHtmlVisualApp = (pendencia, autorAtual, dataAtual) => {
    let html = '<ul class="lista-pendencias" style="list-style: none; padding: 0; margin: 5px 0;">';
    
    // 1. EXTRA√á√ÉO SEGURA DA LISTA
    // Tenta pegar o array de pend√™ncias acumuladas (Nova Estrutura)
    const lista = (pendencia && pendencia.pendencias_ca) ? pendencia.pendencias_ca : 
                  (Array.isArray(pendencia) ? pendencia : null);

    // üõ°Ô∏è 2. REGRA DE PRIORIDADE (MATA O FANTASMA)
    // Se a lista existir e tiver itens, usamos APENAS ela e ignoramos o campo 'obs'
    if (lista && Array.isArray(lista) && lista.length > 0) {
        lista.forEach(p => {
            const militar = p.quem || 'Militar';
            const dataFull = p.data || '';
            
            // Extrai apenas a data (DD/MM/AAAA) usando regex
            const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
            const dataApenas = matchData ? matchData[0] : dataFull;

            html += `
                <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px;">
                    <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                    <b>Por </b>
                    <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                    <span> em <b>${dataApenas}</b>:</span>
                    <i style="margin-left: 5px; color: #333; font-weight: normal; display: block; padding-left: 25px;">${p.obs}</i>
                </li>`;
        });
    } 
    // 3. FALLBACK PARA DADOS ANTIGOS (S√≥ entra aqui se N√ÉO houver lista)
    else if (pendencia && pendencia.obs && typeof pendencia.obs === 'string') {
        const militar = pendencia.quem || autorAtual || 'Militar';
        const dataFull = pendencia.data || dataAtual || '';
        const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
        const dataApenas = matchData ? matchData[0] : dataFull;

        html += `
            <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem;">
                <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                <b>Por </b>
                <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                <span> em <b>${dataApenas}</b>:</span>
                <i style="margin-left: 5px; color: #333; font-weight: normal;">${pendencia.obs}</i>
            </li>`;
    }

    html += '</ul>';
    return html;
};
    
// --- 3. FUN√á√ÉO DE RENDERIZA√á√ÉO DA TELA ---
function renderizarConferencia() {
    const mainContent = document.getElementById('main-content');
    const antigos = mainContent.querySelectorAll('.setor'); 
    antigos.forEach(el => el.remove());

    let htmlSetores = ''; 
    const setorIds = []; 
    
    // Garantimos o uso da fonte global sincronizada
    const fonteDados = window.dadosConferencia || dadosConferencia;
    
    fonteDados.forEach(s => setorIds.push(s.id || s.nome));
    window.setorIds = setorIds;

    const montarPendenciaHtml = (uid, itemOuTomb) => {
        let htmlAcumulado = '';
        
        // 1. Cautelas Ativas
        const cautelasAtivas = itemOuTomb.cautelas || (itemOuTomb.cautela ? [itemOuTomb.cautela] : []);
        cautelasAtivas.forEach(c => {
            htmlAcumulado += `
                <div class="pendencia-id-card status-cautela" style="border-left: 4px solid #f57c00; background-color: #fff8e0; padding: 10px; margin-bottom: 8px; border-radius: 5px;">
                    <div style="font-weight: bold; color: #f57c00; font-size: 0.85em; margin-bottom: 3px;"><i class="fas fa-lock"></i> CAUTELA ATIVA</div>
                    <div style="font-size: 0.9em; color: #333;">${c.quantidade ? c.quantidade + ' un. ' : ''} com <b>${c.destinatario}</b></div>
                    <button type="button" class="action-button ca-alert active" style="width: 100%; margin-top: 5px; height: 30px;" onclick="setItemStatusID(this, 'cautela_ciente', '${uid}')">Ciente</button>
                </div>`;
        });

        // 2. Pend√™ncias F√≠sicas (Carimbos)
        if (itemOuTomb.pendencias_ids && Array.isArray(itemOuTomb.pendencias_ids)) {
            itemOuTomb.pendencias_ids.forEach(p => {
                const isTemp = p.id.startsWith('TEMP-');
                
                // Se for nova (TEMP), exibe aviso. Se for antiga, exibe bot√µes Manter/Resolver.
                const acoesHtml = isTemp ? 
                    `<div style="color:#d90f23; font-size:0.8em; font-weight:bold; text-align:center; width:100%; border-top:1px solid #eee; padding-top:5px;">Aguardando finaliza√ß√£o...</div>` :
                    `<div class="pendencia-actions" style="display: flex; gap: 5px;">
                        <button type="button" class="btn-manter" style="flex: 1; padding: 6px; font-size: 0.8em;" onclick="manterID('${p.id}', '${uid}')">Manter</button>
                        <button type="button" class="btn-resolver" style="flex: 1; padding: 6px; font-size: 0.8em; background-color: #1b8a3e;" onclick="resolverID('${p.id}', '${uid}', ${p.quantidade})">Resolvido</button>
                    </div>`;

                htmlAcumulado += `
                    <div class="pendencia-id-card" id="card-${p.id}" style="border: 1px solid #d90f23; border-radius: 8px; padding: 10px; margin-bottom: 10px; background-color: #fff;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #666; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px;">
                            <span><b>Relatado por:</b> ${p.autor_nome}</span>
                            <span>${p.data_criacao}</span>
                        </div>
                        <div style="font-size: 0.85em; margin-bottom: 8px; color: #222;">
                            <strong>${p.quantidade > 1 ? p.quantidade + ' un. ' : ''}</strong> ${p.descricao}
                        </div>
                        ${acoesHtml}
                    </div>`;
            });
        }
        return htmlAcumulado;
    };

    fonteDados.forEach((setor, index) => {
        const isFirstSetor = (index === 0); 
        let htmlItens = ''; 
        let totalItensNoSetor = 0;
        
        setor.itens.forEach(item => {
            if (item.tipo === 'multi' && item.tombamentos) {
                totalItensNoSetor += item.tombamentos.length; 
                let htmlTombamentos = '';
                item.tombamentos.forEach(tomb => {
                    const uid = `${item.id}-${tomb.tomb}`;
                    const hasPendencia = tomb.pendencias_ids && tomb.pendencias_ids.length > 0;
                    
                    if (!window.itemStatus[uid]) window.itemStatus[uid] = { status: 'pending' };
                    const currentStatus = window.itemStatus[uid].status;
                    const isActiveOk = (currentStatus === 'S/A' || currentStatus === 'ok') ? 'active' : '';

                    htmlTombamentos += `
                        <div class="tombamento-container" data-tomb="${tomb.tomb}" style="border: 1px solid #eee; padding: 10px; margin-bottom: 5px; border-radius: 8px;">
                            <div class="tombamento-controls" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Tomb.: <b>${tomb.tomb}</b></span>
                                <div class="tombamento-options" style="display: flex; gap: 5px;">
                                    ${!hasPendencia ? `<button type="button" class="action-button sa-ok ${isActiveOk}" onclick="setItemStatusID(this, 'ok', '${uid}')">S/A</button>` : ''}
                                    <button type="button" class="action-button ca-alert ${hasPendencia ? 'active' : ''}" onclick="abrirFormNovoID('${uid}')">+ Altera√ß√£o</button>
                                </div>
                            </div>
                            <div class="alerts-wrapper">${montarPendenciaHtml(uid, tomb)}</div>
                            <div class="form-novo-id" id="form-${uid}" style="display:none; padding: 10px; background: #f9f9f9; border: 1px dashed #ccc; margin-top: 5px;">
                                <textarea id="obs-${uid}" placeholder="Descreva a altera√ß√£o..." style="width:100%; height: 60px; margin-bottom: 5px;"></textarea>
                                <button type="button" class="btn-salvar-alteracao" onclick="salvarNovoID('${uid}', 1, 'multi')">INCLUIR</button>
                            </div>
                        </div>`;
                });
                htmlItens += `<div class="item-conferencia item-has-tombamentos" data-id="${item.id}"><div class="item-header"><span class="status-icon ${window.itemStatus[item.id]?.status === 'ok' ? 'ok' : ''}"></span><span class="item-label">${item.nome}</span></div>${htmlTombamentos}</div>`;
            } 
            else {
                totalItensNoSetor += 1; 
                const totalCautelado = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                const saldoReal = (Number(item.quantidadeEsperada) || 0) - totalCautelado;
                const hasPendencia = item.pendencias_ids && item.pendencias_ids.length > 0;

                if (!window.itemStatus[item.id]) window.itemStatus[item.id] = { status: 'pending' };
                const currentStatus = window.itemStatus[item.id].status;

                htmlItens += `
                    <div class="item-conferencia" data-type="single" data-id="${item.id}">
                        <div class="item-header">
                            <span class="status-icon ${currentStatus === 'S/A' ? 'ok' : (currentStatus === 'C/A' ? 'alert' : '')}"></span>
                            <div style="display:flex; flex-direction:column">
                                <span class="item-label">${item.nome}</span>
                                <span style="font-size:0.8em; color:#666">QTD: ${saldoReal} de ${item.quantidadeEsperada}</span>
                            </div>
                        </div>
                        <div class="item-options" style="margin-top:10px; display: flex; gap: 5px;">
                            ${!hasPendencia ? `<button type="button" class="action-button sa-ok ${currentStatus === 'S/A' ? 'active' : ''}" onclick="setItemStatusID(this, 'ok', '${item.id}')">S/A</button>` : ''}
                            <button type="button" class="action-button ca-alert ${hasPendencia ? 'active' : ''}" onclick="abrirFormNovoID('${item.id}')">+ Altera√ß√£o</button>
                        </div>
                        <div class="alerts-wrapper" style="margin-top:10px">${montarPendenciaHtml(item.id, item)}</div>
                        <div class="form-novo-id" id="form-${item.id}" style="display:none; padding: 10px; background: #f9f9f9; border: 1px dashed #ccc; margin-top: 5px;">
                            <div style="margin-bottom: 5px;">
                                <label style="font-size: 0.8em;">Unidades afetadas:</label>
                                <input type="number" id="qtd-${item.id}" value="1" min="1" max="${saldoReal}" style="width: 50px;">
                            </div>
                            <textarea id="obs-${item.id}" placeholder="Descreva o problema..." style="width:100%; height: 60px; margin-bottom: 5px;"></textarea>
                            <button type="button" class="btn-salvar-alteracao" onclick="salvarNovoID('${item.id}', document.getElementById('qtd-${item.id}').value, 'single')">INCLUIR</button>
                        </div>
                    </div>`;
            }
        });
        
        htmlSetores += `
            <div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id || setor.nome}">
                <div class="setor-header" onclick="toggleSetor(this)">
                    <div class="setor-info">
                        <span>${setor.nome}</span>
                        <div class="setor-status">0/${totalItensNoSetor}</div>
                    </div>
                    <span class="arrow">${isFirstSetor ? '‚ñº' : '‚ñ∫'}</span>
                </div>
                <div class="setor-content ${isFirstSetor ? 'expanded' : ''}">${htmlItens}</div>
            </div>`;
    });

    const btnFin = document.getElementById('btn-finalizar');
    if (btnFin) btnFin.insertAdjacentHTML('beforebegin', htmlSetores);
    
    // Atualiza o contador geral do bot√£o e os status dos setores ap√≥s renderizar
    updateOverallStatus();
}    
      function adaptarCautelaParaRender(cautelaData) {
    if (!cautelaData.itens || cautelaData.itens.length === 0) return [];

    const setorCautela = {
        id: cautelaData.cautela_id,
        nome: "ITENS CAUTELADOS",
        itens: cautelaData.itens.map(cItem => {
            
            let tipo = cItem.tombamento ? 'multi' : 'single';
            let tombamentos = null;

            if (tipo === 'multi') {
                tombamentos = [{
                    tomb: cItem.tombamento,
                    id_completo: cItem.id_completo || `${cItem.id_base || cItem.id}-${cItem.tombamento}`,
                    // O item da cautela j√° carrega seu pr√≥prio estado (JSON) se houver
                    cautela: cItem.cautela || {
                        id: cautelaData.cautela_id,
                        destinatario: cautelaData.destinatario || cautelaData.destinatario_original_nome,
                        data: cautelaData.timestamp_emissao ? new Date(cautelaData.timestamp_emissao.seconds * 1000).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR')
                    },
                    pendencia: cItem.pendencia || null
                }];
                cItem.quantidade = 1; 
            }

            return {
                id: cItem.id_base || cItem.id,
                nome: cItem.nome,
                quantidadeEsperada: cItem.quantidade || 1,
                tipo: tipo,
                tombamentos: tombamentos,
                // Preserva o carimbo JSON para itens de quantidade (Single)
                cautelas: cItem.cautelas || [],
                pendencia: cItem.pendencia || null
            };
        })
    };

    return [setorCautela];
}
        async function carregarDadosRemotos() {
    const ID_ALVO = isCautela ? CAUTELA_ID : LISTA_ID;
    const COLECAO_ALVO = isCautela ? COLECAO_CAUTELAS : COLECAO_LISTAS;
    
    if (!ID_ALVO) { 
        console.error("ID n√£o encontrado para carregamento.");
        return; 
    }
        
    const loadingMsg = document.getElementById('loading-message');
    if (loadingMsg) loadingMsg.innerHTML = "Conectando...";

    try {
        const doc = await db.collection(COLECAO_ALVO).doc(ID_ALVO).get();
        if (!doc.exists) throw new Error("Documento n√£o encontrado no banco de dados.");
        
        const data = doc.data();
        
        // üõë PROCESSAMENTO DOS DADOS üõë
        if (isCautela) {
            dadosConferencia = adaptarCautelaParaRender(data);
        } else {
            const listaBruta = data.list || [];
            dadosConferencia = listaBruta.map(setor => ({
                ...setor,
                itens: (setor.itens || []).map(item => {
                    if (item.tipo === 'single') {
                        // C√°lculo de saldo para confer√™ncia visual
                        const totalCautelado = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                        // O saldo real √© calculado dinamicamente na renderiza√ß√£o usando quantidadeEsperada e totalCautelado
                    }
                    return item;
                })
            }));
        }

        // --- V√çNCULO GLOBAL (CR√çTICO PARA O SIMULADOR) ---
        window.dadosConferencia = dadosConferencia;
        
        const nomeLocal = isCautela ? `CAUTELA: ${CAUTELA_ID}` : (data.nome_local || "Lista de Confer√™ncia");
        const postoLocal = isCautela ? `Destinat√°rio: ${data.destinatario || data.destinatario_original_nome}` : (data.posto || "Geral");
        
        infoLocal = { nome: nomeLocal, posto: postoLocal };
        
        const infoElement = document.getElementById('local-posto-info');
        if (infoElement) {
            infoElement.innerHTML = `<span style="color:blue;font-weight:bold">${infoLocal.posto} - ${infoLocal.nome}</span>`;
        }

        document.title = isCautela ? `Cautela - ${CAUTELA_ID}` : `Confer√™ncia - ${infoLocal.nome}`;

        if (isCautela) {
            const h1Element = document.querySelector('h1');
            const subtituloElement = document.querySelector('.subtitulo');
            const btnFinalizar = document.getElementById('btn-finalizar');

            if (h1Element) {
                if (MODO_OPERACAO === 'devolucao_final') h1Element.textContent = 'RECEBIMENTO DE DEVOLU√á√ÉO';
                else if (MODO_OPERACAO === 'devolucao') h1Element.textContent = 'DEVOLU√á√ÉO (TRANSI√á√ÉO)';
                else h1Element.textContent = 'RECEBIMENTO DE CAUTELA';
            }

            if (subtituloElement) {
                if (MODO_OPERACAO === 'devolucao_final') {
                    const reversor = data.militar_completo_reversor || 'Militar Anterior';
                    subtituloElement.innerHTML = `Recebendo Cautela <strong>${CAUTELA_ID}</strong> de: <br> ${reversor}`;
                } else {
                    subtituloElement.textContent = `Processando Cautela ${CAUTELA_ID}`;
                }
            }

            if (btnFinalizar) {
                if (MODO_OPERACAO === 'devolucao_final') {
                    btnFinalizar.textContent = 'FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO';
                    btnFinalizar.onclick = () => finalizarRecebimentoDevolucao(data);
                } else {
                    btnFinalizar.onclick = () => finalizarRecebimentoCautela(data);
                }
            }
        }
        
        if (loadingMsg) loadingMsg.innerHTML = "Renderizando itens...";
        
        // Dispara a renderiza√ß√£o com os dados globais sincronizados
        renderizarConferencia(); 

        if (typeof updateHeaderInfo === "function") try { updateHeaderInfo(); } catch(e) {}
        if (typeof updateOverallStatus === "function") try { updateOverallStatus(); } catch(e) {}
        
        if (loadingMsg) loadingMsg.style.display = 'none'; 
        const mainContent = document.getElementById('main-content');
        if (mainContent) mainContent.style.display = 'block';

    } catch (e) { 
        console.error("Erro Cr√≠tico no Carregamento:", e);
        if (loadingMsg) loadingMsg.innerHTML = `<span style='color:red'>Erro ao carregar dados: ${e.message}</span>`;
    }
}
     
        async function finalizarConferencia() {
    const btn = document.getElementById('btn-finalizar');
    if (btn.disabled) return;
    
    // Feedback visual imediato
    btn.textContent = "PROCESSANDO CIRURGIA DE DADOS..."; 
    btn.disabled = true;

    try {
        const p = userInfo;
        
        // Busca o nome institucional completo (igual ao carimbo)
        const militarInfoEl = document.getElementById('militar-info');
        const conferenteCompleto = militarInfoEl ? 
            militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim() : 
            `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;

        const localNome = `${infoLocal.posto} - ${infoLocal.nome}`;
        const timestampAgora = firebase.firestore.Timestamp.now();
        
        let itensRelatorio = [];
        let itensCaa = []; 
        let totalCaa = 0;

        // --- REFER√äNCIA √Ä FONTE DE DADOS GLOBAL ---
        const fonteDeDados = window.dadosConferencia || dadosConferencia;

        const novaListaMestra = fonteDeDados.map(setor => {
            return {
                ...setor,
                itens: setor.itens.map(item => {
                    
                    const processarEntidade = (entidade, uid, nomeParaRelatorio) => {
                        const statusLocal = window.itemStatus[uid];
                        
                        // Se n√£o houve a√ß√£o neste item, retorna ele como est√°
                        if (!statusLocal || statusLocal.status === 'pending') return entidade;

                        if (!entidade.pendencias_ids) entidade.pendencias_ids = [];
                        if (!entidade.historico_vida) entidade.historico_vida = [];

                        // --- 1. TRATAMENTO DE RESOLVIDOS ---
                        if (statusLocal.ids_resolvidos) {
                            statusLocal.ids_resolvidos.forEach(res => {
                                const idx = entidade.pendencias_ids.findIndex(p => p.id === res.id);
                                if (idx > -1) {
                                    const pendenciaMorta = entidade.pendencias_ids[idx];
                                    entidade.historico_vida.push({
                                        evento: res.qtd_remanescente > 0 ? "SOLUCAO_PARCIAL" : "SOLUCAO_TOTAL",
                                        id_pendencia_origem: pendenciaMorta.id,
                                        quem: res.resolvido_por,
                                        data: res.data_solucao,
                                        detalhes: `Resolvido ${res.qtd_resolvida} de ${pendenciaMorta.quantidade}. Desc: ${pendenciaMorta.descricao}`
                                    });
                                    entidade.pendencias_ids.splice(idx, 1);

                                    if (res.qtd_remanescente > 0) {
                                        entidade.pendencias_ids.push({
                                            ...pendenciaMorta,
                                            id: "PEND_" + Date.now() + "_RES",
                                            quantidade: res.qtd_remanescente,
                                            descricao: pendenciaMorta.descricao + " (SALDO REMANESCENTE)",
                                            herdado_de: pendenciaMorta.id
                                        });
                                    }
                                }
                            });
                        }

                        // --- 2. TRATAMENTO DE NOVOS (IMPORTANTE) ---
                        // Como a fun√ß√£o 'salvarNovoID' j√° injetou o objeto TEMP- no dadosConferencia, 
                        // aqui n√≥s apenas limpamos o prefixo TEMP- para virar um ID definitivo PEND-
                        entidade.pendencias_ids = entidade.pendencias_ids.map(p => {
                            if (p.id.startsWith('TEMP-')) {
                                const novoIdDefinitivo = p.id.replace('TEMP-', 'PEND-');
                                
                                // Registra no hist√≥rico de vida
                                entidade.historico_vida.push({
                                    evento: "NOVA_PENDENCIA",
                                    id_pendencia: novoIdDefinitivo,
                                    quem: p.autor_nome,
                                    data: p.data_criacao,
                                    detalhes: `${p.quantidade}un - ${p.descricao}`
                                });
                                
                                return { ...p, id: novoIdDefinitivo };
                            }
                            return p;
                        });

                        // --- 3. PREPARA√á√ÉO PARA RELAT√ìRIO ---
                        const temAlteracao = entidade.pendencias_ids.length > 0;
                        const statusFinal = temAlteracao ? 'C/A' : 'S/A';
                        
                        const dadosRelatorio = {
                            id: uid,
                            nomeCompleto: nomeParaRelatorio,
                            status: statusFinal,
                            pendencias_ids: [...entidade.pendencias_ids],
                            quantidade: entidade.quantidadeEsperada || 1,
                            setor: setor.nome,
                            obs: entidade.pendencias_ids.map(p => `${p.quantidade}un: ${p.descricao}`).join(' | ')
                        };

                        itensRelatorio.push(dadosRelatorio);
                        if (temAlteracao) {
                            itensCaa.push(dadosRelatorio);
                            totalCaa++;
                        }

                        return entidade;
                    };

                    if (item.tipo === 'multi' && item.tombamentos) {
                        item.tombamentos = item.tombamentos.map(t => processarEntidade(t, `${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`));
                    } else {
                        item = processarEntidade(item, item.id, item.nome);
                    }
                    return item;
                })
            };
        });

        // --- GRAVA√á√ÉO NO FIREBASE ---
        // 1. Atualiza a Lista Mestra (Onde vivem os itens e tombamentos)
        await db.collection(COLECAO_LISTAS).doc(LISTA_ID).update({ list: novaListaMestra });

        // 2. Registra o Relat√≥rio de Confer√™ncia (O hist√≥rico que o gestor consulta)
        await db.collection('resultados_conferencias').add({
            local: localNome,
            lista_id: LISTA_ID,
            conferente_uid: p.uid,
            conferente: conferenteCompleto,
            timestamp: timestampAgora,
            totalItensConferidos: itensRelatorio.length,
            totalCaa: totalCaa,
            itensCaa: itensCaa,
            itensRelatorio: itensRelatorio
        });

        // 3. Atualiza a Cust√≥dia (Quem √© o atual respons√°vel pelo local)
        await db.collection('custodia_atual').doc(LISTA_ID).set({
            lista_id: LISTA_ID,
            local_nome: localNome,
            conferente_uid: p.uid,
            conferente_completo: conferenteCompleto,
            timestamp_ultima_conferencia: timestampAgora
        });

        alert("‚úÖ Confer√™ncia Finalizada!\nAs altera√ß√µes foram registradas permanentemente.");
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (e) {
        console.error("Erro fatal na grava√ß√£o:", e);
        alert("Erro ao gravar dados: " + e.message);
        btn.disabled = false;
        btn.textContent = "FINALIZAR CONFER√äNCIA";
    }
}
        async function finalizarRecebimentoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();
            if (cData.destinatario_original_uid !== meuUid) {
                throw new Error("Apenas o destinat√°rio original pode assinar este recebimento.");
            }

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensConferidos = [];

            cautela.itens.forEach(cItem => {
                const statusSelect = document.getElementById(`status-${cItem.id}-${cItem.tombamento || 'single'}`);
                const obsInput = document.getElementById(`obs-${cItem.id}-${cItem.tombamento || 'single'}`);
                
                const statusFinal = statusSelect ? statusSelect.value : 'S/A';
                const obsFinal = obsInput ? obsInput.value.trim() : '';

                itensConferidos.push({
                    ...cItem,
                    status_recebimento: statusFinal,
                    obs_recebimento: obsFinal
                });

                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            const logHistorico = {
                                evento: "CONFIRMA√á√ÉO_RECEBIMENTO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                estado: statusFinal,
                                detalhes: statusFinal === 'C/A' ? `Avaria detectada no recebimento: ${obsFinal}` : "Recebido em perfeito estado (S/A)."
                            };

                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push(logHistorico);

                            const objetoCautelaAtualizado = {
                                id: CAUTELA_ID,
                                emitente: cData.emitente,
                                destinatario: meuNomeCompleto,
                                data: dataAtual,
                                status_item: statusFinal,
                                obs_item: obsFinal
                            };

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        t.cautela = objetoCautelaAtualizado;
                                    }
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = mItem.cautelas.map(c => {
                                    if (c.id === CAUTELA_ID) {
                                        return objetoCautelaAtualizado;
                                    }
                                    return c;
                                });
                            }
                        }
                        return mItem;
                    })
                }));
            });

            transaction.update(cautelaRef, {
                status: 'RECEBIDA',
                timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
                itens: itensConferidos,
                militar_completo_receptor: meuNomeCompleto
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Recebimento confirmado!`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (error) {
        console.error("Erro ao receber cautela:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO";
        btn.disabled = false;
    }
}
      async function finalizarDevolucaoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = 'Processando...';
    btn.disabled = true;

    try {
        // Pega as informa√ß√µes do militar logado (quem est√° devolvendo)
        const userInfo = await getLoggedUser(); 
        
        if (!userInfo) {
            alert("Erro: Dados do militar logado n√£o encontrados.");
            btn.textContent = 'ERRO AO FINALIZAR';
            btn.disabled = false;
            return;
        }

        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);

        // üõë CR√çTICO: Executa a Transa√ß√£o no Firebase üõë
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(cautelaRef);

            if (!doc.exists || doc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela n√£o encontrada ou n√£o est√° no status 'RECEBIDA'.");
            }
            
            // 1. A√ß√£o: Mudar o status da cautela para CONCLUIDA.
            transaction.update(cautelaRef, { 
                status: 'CONCLUIDA', // Status final
                timestamp_devolucao: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem est√° devolvendo (Militar Logado)
                reversor: userInfo.nomeGuerra, 
                militar_completo_reversor: `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`,
                
                // Quem est√° recebendo de volta (√öltimo Conferente)
                destinatario_final_devolucao: DESTINATARIO_DEVOLUCAO,
            });
            
            // 2. A√ß√£o: Registrar o hist√≥rico de confer√™ncia final (opcional, mas recomendado)
            // Se necess√°rio, voc√™ pode adicionar um novo documento na sua cole√ß√£o de hist√≥rico.
        }); // Fim da Transa√ß√£o

        alert(`‚úÖ Devolu√ß√£o da Cautela ${CAUTELA_ID} conclu√≠da e status atualizado para \"CONCLUIDA\".`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro CR√çTICO ao finalizar devolu√ß√£o:", error);
        alert(`Erro ao finalizar devolu√ß√£o. Nenhum dado foi alterado. Erro: ${error.message}`);
        btn.textContent = "ERRO AO FINALIZAR";
        btn.disabled = false;
    }
}
        async function finalizarRecebimentoDevolucao(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada. Fa√ßa login novamente.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra original n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensDevolvidos = [];

            cautela.itens.forEach(cItem => {
                const statusSelect = document.getElementById(`status-${cItem.id}-${cItem.tombamento || 'single'}`);
                const obsInput = document.getElementById(`obs-${cItem.id}-${cItem.tombamento || 'single'}`);
                
                const statusFinal = statusSelect ? statusSelect.value : 'S/A';
                const obsFinal = obsInput ? obsInput.value.trim() : '';

                itensDevolvidos.push({
                    ...cItem,
                    status_devolucao: statusFinal,
                    obs_devolucao: obsFinal
                });

                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            const logHistorico = {
                                evento: "RETORNO_DEVOLUCAO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                estado_retorno: statusFinal,
                                detalhes: statusFinal === 'C/A' ? `Item devolvido com altera√ß√£o: ${obsFinal}` : "Item devolvido em perfeito estado (S/A)."
                            };

                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push(logHistorico);

                            if (statusFinal === 'C/A') {
                                mItem.pendencia = {
                                    tipo: "C/A",
                                    obs: `[DEVOLU√á√ÉO ${CAUTELA_ID}] ${obsFinal}`,
                                    quem: meuNomeCompleto,
                                    data: dataAtual
                                };
                            } else {
                                delete mItem.pendencia;
                            }

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        delete t.cautela;
                                    }
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = (mItem.cautelas || []).filter(c => 
                                    (c.id !== CAUTELA_ID && c.cautela_id !== CAUTELA_ID)
                                );
                            }
                        }
                        return mItem;
                    })
                }));
            });

            transaction.update(cautelaRef, { 
                status: 'CONCLU√çDA',
                timestamp_conclusao: firebase.firestore.FieldValue.serverTimestamp(),
                receptor_final_completo: meuNomeCompleto,
                destinatario_uid: meuUid,
                itens: itensDevolvidos
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Devolu√ß√£o finalizada! Material reintegrado ao estoque e hist√≥rico atualizado.`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro ao finalizar devolu√ß√£o:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
        btn.disabled = false;
    }
}
    // --- NOVAS FUN√á√ïES DE CONTROLE DE IDS √öNICOS ---

function abrirFormNovoID(uid) {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const grupoQtd = document.getElementById('modal-grupo-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const infoMax = document.getElementById('modal-info-max');
    
    // Reset de seguran√ßa
    inputObs.value = '';
    
    const isMulti = uid.includes('-');
    document.getElementById('modal-uid').value = uid;
    document.getElementById('modal-tipo').value = isMulti ? 'multi' : 'single';

    if (isMulti) {
        // --- CASO TOMBAMENTO ---
        let numeroTombamentoReal = "N√£o identificado";
        let nomeDoItem = "Equipamento";

        (window.dadosConferencia || dadosConferencia).forEach(setor => {
            setor.itens.forEach(item => {
                if (item.tipo === 'multi' && item.tombamentos) {
                    item.tombamentos.forEach(t => {
                        if (`${item.id}-${t.tomb}` === uid) {
                            numeroTombamentoReal = t.tomb;
                            nomeDoItem = item.nome;
                        }
                    });
                }
            });
        });

        document.getElementById('modal-titulo-item').innerText = "Relatar Altera√ß√£o";
        document.getElementById('modal-subtitulo-detalhe').innerHTML = `Item: <b>${nomeDoItem}</b><br>Refer√™ncia Tomb.: <span style="color:#d90f23; font-weight:bold;">${numeroTombamentoReal}</span>`;
        
        // ESCONDE o campo de quantidade (pois tombamento √© sempre 1 por 1)
        grupoQtd.style.display = 'none'; 
        inputQtd.value = 1;
        inputQtd.max = 1;

    } else {
        // --- CASO ITEM SEM TOMBAMENTO (QUANTIDADE) ---
        let saldoDisponivel = 0;
        let nomeItem = "Item n√£o localizado";

        (window.dadosConferencia || dadosConferencia).forEach(setor => {
            setor.itens.forEach(i => {
                if (String(i.id) === String(uid)) {
                    const totalCautelado = (i.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                    saldoDisponivel = (Number(i.quantidadeEsperada) || 0) - totalCautelado;
                    nomeItem = i.nome;
                }
            });
        });

        document.getElementById('modal-titulo-item').innerText = nomeItem;
        document.getElementById('modal-subtitulo-detalhe').innerText = "Informe a quantidade de itens com altera√ß√£o:";
        
        // MOSTRA o campo de quantidade obrigatoriamente
        grupoQtd.style.display = 'block';
        
        inputQtd.max = saldoDisponivel;
        inputQtd.value = 1;
        infoMax.innerText = `Saldo m√°ximo dispon√≠vel: ${saldoDisponivel} un.`;
        
        if(saldoDisponivel <= 0) {
            alert("Este item n√£o possui saldo dispon√≠vel para altera√ß√£o (todos cautelados).");
            return;
        }
    }

    modal.style.display = 'flex';
    setTimeout(() => inputObs.focus(), 150);
}
    function fecharModalPendencia() {
    const modal = document.getElementById('modal-nova-pendencia');
    if (modal) {
        modal.style.display = 'none';
        // Limpa a observa√ß√£o para o pr√≥ximo uso
        document.getElementById('modal-input-obs').value = '';
    }
}
    function confirmarInclusaoPendencia() {
    const uid = document.getElementById('modal-uid').value;
    const tipo = document.getElementById('modal-tipo').value;
    const inputQtd = document.getElementById('modal-input-qtd');
    const obs = document.getElementById('modal-input-obs').value.trim();

    // 1. Valida√ß√£o de Descri√ß√£o
    if (obs.length < 3) {
        return alert("Por favor, descreva o problema com mais detalhes.");
    }

    // 2. Valida√ß√£o Inteligente de Quantidade (Trava de Saldo)
    const qtdDigitada = parseInt(inputQtd.value) || 0;
    const maxPermitido = parseInt(inputQtd.max) || 1;

    if (tipo === 'single') {
        if (qtdDigitada < 1) {
            return alert("A quantidade deve ser pelo menos 1.");
        }
        if (qtdDigitada > maxPermitido) {
            return alert(`Quantidade inv√°lida! Existem apenas ${maxPermitido} unidades dispon√≠veis para este item (descontando cautelas).`);
        }
    }

    // 3. Chamada da Fun√ß√£o Principal de Salvamento
    // Passamos a observa√ß√£o e quantidade validadas para a fun√ß√£o que injeta no 'dadosConferencia'
    salvarNovoID(uid, qtdDigitada, tipo, obs);
    
    // 4. Fechamento do Modal e Feedback
    fecharModalPendencia();
}

/**
 * Salva uma nova pend√™ncia/altera√ß√£o injetando os dados no array global.
 * Esta vers√£o √© otimizada para trabalhar com o Modal Centralizado.
 */
function salvarNovoID(uid, qtd, tipo, obsModal = null) {
    // 1. Defini√ß√£o da Observa√ß√£o (se vier do modal ou do elemento fixo antigo)
    const obsDigitada = obsModal ? obsModal.trim() : (document.getElementById(`obs-${uid}`)?.value.trim() || "");
    const qtdInformada = parseInt(qtd) || 1;

    // 2. Valida√ß√£o B√°sica
    if (obsDigitada.length < 3) {
        return alert("Por favor, descreva o problema com mais detalhes.");
    }

    // 3. Captura do Nome Institucional para o Carimbo (Ex: 3¬∫ SGT QPCBM JHONATH)
    const militarInfoEl = document.getElementById('militar-info');
    let nomeAssinatura = "";
    if (militarInfoEl) {
        nomeAssinatura = militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim();
    }
    if (!nomeAssinatura) {
        nomeAssinatura = userInfo.nome_militar_completo || `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    }

    // 4. Cria√ß√£o do Objeto de Pend√™ncia com ID Tempor√°rio
    const novoID = {
        id: "TEMP-" + Date.now(),
        tipo: "PENDENCIA",
        data_criacao: new Date().toLocaleDateString('pt-BR'),
        autor_uid: userInfo.uid,
        autor_nome: nomeAssinatura,
        descricao: obsDigitada,
        quantidade: qtdInformada,
        status_gestao: "PENDENTE",
        id_conferencia_origem: "CONF_TEMP",
        herdado_de: null
    };

    // 5. Inje√ß√£o nos Dados em Mem√≥ria (Fonte Global)
    let itemEncontrado = false;
    const fonteDados = window.dadosConferencia || dadosConferencia;

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            const itemIdStr = String(item.id);
            const uidStr = String(uid);

            if (tipo === 'single' && itemIdStr === uidStr) {
                if (!item.pendencias_ids) item.pendencias_ids = [];
                item.pendencias_ids.push(novoID);
                itemEncontrado = true;
            } else if (tipo === 'multi' && item.tombamentos) {
                item.tombamentos.forEach(t => {
                    if (String(`${item.id}-${t.tomb}`) === uidStr) {
                        if (!t.pendencias_ids) t.pendencias_ids = [];
                        t.pendencias_ids.push(novoID);
                        itemEncontrado = true;
                    }
                });
            }
        });
    });

    // 6. Atualiza√ß√£o da Interface e Feedback
    if (itemEncontrado) {
        // Marca o item como C/A (Com Altera√ß√£o)
        if (!window.itemStatus) window.itemStatus = {};
        window.itemStatus[uid] = { status: 'C/A' };
        
        // Limpeza visual
        const obsFixa = document.getElementById(`obs-${uid}`);
        if (obsFixa) obsFixa.value = '';
        
        const formFixo = document.getElementById(`form-${uid}`);
        if (formFixo) formFixo.style.display = 'none';

        // Re-renderiza a tela para exibir o novo carimbo
        renderizarConferencia();
        
        // Mant√©m o scroll no item editado
        setTimeout(() => {
            const baseId = uid.split('-')[0];
            const el = document.querySelector(`[data-id="${baseId}"]`);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 150);
    } else {
        console.error("Erro: Item n√£o localizado para inje√ß√£o de dados.");
    }
}
function manterID(pendenciaId, uid) {
    const card = document.getElementById(`card-${pendenciaId}`);
    if (card) {
        card.style.borderColor = "#1b8a3e";
        card.style.backgroundColor = "#f0fff4";
        card.querySelector('.pendencia-actions').innerHTML = '<div style="color:#1b8a3e; font-weight:bold; text-align:center; width:100%">‚úî Mantido para esta confer√™ncia</div>';
        
        // Registra no itemStatus que este ID espec√≠fico foi conferido
        if (!window.itemStatus[uid].ids_mantidos) window.itemStatus[uid].ids_mantidos = [];
        window.itemStatus[uid].ids_mantidos.push(pendenciaId);
        window.itemStatus[uid].status = 'C/A';

        const setor = card.closest('.setor');
        updateSetorStatus(setor);
        updateOverallStatus();
        checkSetorCompletion(setor, uid);
    }
}

function resolverID(pendenciaId, uid, qtdOriginal) {
    let qtdResolvida = 1;

    if (qtdOriginal > 1) {
        const input = prompt(`Este problema afeta ${qtdOriginal} unidades. Quantas unidades foram resolvidas?`, qtdOriginal);
        if (input === null) return; // Cancelou
        qtdResolvida = parseInt(input);
        if (isNaN(qtdResolvida) || qtdResolvida < 1 || qtdResolvida > qtdOriginal) {
            return alert("Quantidade inv√°lida.");
        }
    }

    if (!window.itemStatus[uid].ids_resolvidos) window.itemStatus[uid].ids_resolvidos = [];
    
    window.itemStatus[uid].ids_resolvidos.push({
        id: pendenciaId,
        qtd_resolvida: qtdResolvida,
        qtd_remanescente: qtdOriginal - qtdResolvida,
        resolvido_por: `${userInfo.postoGraduacao} ${userInfo.nomeGuerra}`,
        data_solucao: new Date().toLocaleDateString('pt-BR')
    });

    const card = document.getElementById(`card-${pendenciaId}`);
    if (card) {
        card.style.opacity = "0.5";
        card.style.backgroundColor = "#e8f5e9";
        card.querySelector('.pendencia-actions').innerHTML = `<div style="color:#2e7d32; font-weight:bold; text-align:center; width:100%">‚úî Marcado como Resolvido (${qtdResolvida} un.)</div>`;
    }

    const setor = card.closest('.setor');
    updateSetorStatus(setor);
    updateOverallStatus();
    checkSetorCompletion(setor, uid);
}

function setItemStatusID(btn, status, uid) {
    // üõ°Ô∏è CORRE√á√ÉO: Busca o container IMEDIATO (Tombamento ou Item Single)
    // Isso impede que a limpeza de classes 'active' afete os vizinhos.
    const container = btn.closest('.tombamento-container') || btn.closest('.item-conferencia');
    const setor = btn.closest('.setor');

    if (status === 'ok') {
        window.itemStatus[uid] = { status: 'S/A' };
        
        // Limpa 'active' apenas dentro deste tombamento espec√≠fico
        container.querySelectorAll('.action-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Trata o √≠cone visual
        const icon = container.querySelector('.status-icon') || container.closest('.item-conferencia').querySelector('.status-icon');
        
        // Se for tombamento, chama a l√≥gica de verifica√ß√£o global do item pai
        const itemPai = btn.closest('.item-conferencia');
        if (itemPai && itemPai.classList.contains('item-has-tombamentos')) {
            updateItemMainStatusDisplay(itemPai);
        } else if (icon) {
            icon.className = 'status-icon ok';
        }
    }
    
    updateSetorStatus(setor);
    updateOverallStatus();
    checkSetorCompletion(setor, uid);
}
        window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
