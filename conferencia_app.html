<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="sigma-comum.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    /* 1. BASE E IDENTIDADE VISUAL V3 (Gradiente e Glassmorphism) */
    body { 
        font-family: 'Inter', sans-serif; 
        background: linear-gradient(135deg, #800020 0%, #2c3e50 100%) !important; 
        background-attachment: fixed; 
        color: #1e293b; 
        min-height: 100vh; 
        margin: 0; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding: 20px 0 120px 0; 
        box-sizing: border-box; 
    }

    /* Estrutura de Dashboard Operacional (Duas Colunas em Telas Grandes) */
    .main-wrapper {
        display: flex;
        flex-direction: column;
        width: 95%;
        max-width: 1200px;
        gap: 20px;
    }

    @media (min-width: 1024px) {
        .main-wrapper { flex-direction: row; align-items: flex-start; }
        .sidebar-v3 { position: sticky; top: 20px; width: 350px; flex-shrink: 0; }
        .content-v3 { flex-grow: 1; }
    }

    /* 2. CONTAINERS GLASSMORPISM */
    .container { 
        background: rgba(255, 255, 255, 0.92); 
        backdrop-filter: blur(15px); 
        -webkit-backdrop-filter: blur(15px);
        padding: 25px; 
        border-radius: 18px; 
        box-shadow: 0 15px 35px rgba(0,0,0,0.25); 
        width: 100%; 
        box-sizing: border-box; 
        border: 1px solid rgba(255,255,255,0.4); 
        margin-bottom: 20px;
    }

    h1 { color: #800020; font-size: 1.5em; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 15px; }
    
    /* 3. PAINEL DO CONFERENTE (Destaque V3) */
    .user-info-display { 
        font-size: 0.85em; 
        color: #334155; 
        text-align: left; 
        padding: 15px; 
        background: white; 
        border-radius: 12px; 
        border-left: 5px solid #800020; 
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        line-height: 1.6;
    }
    .user-info-display b { color: #800020; text-transform: uppercase; }

    /* 4. SETORES (Acorde√£o Modernizado) */
    .setor-header { 
        background: #800020; 
        color: white; 
        padding: 18px; 
        margin-top: 15px; 
        border-radius: 12px; 
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .setor-header:hover { filter: brightness(1.2); transform: scale(1.01); }

    .setor-status { 
        background: rgba(255,255,255,0.2); 
        padding: 4px 12px; 
        border-radius: 20px; 
        font-weight: 800; 
        font-size: 0.8em; 
        border: 1px solid rgba(255,255,255,0.3);
    }

    .setor-content { 
        max-height: 0; 
        overflow: hidden; 
        transition: all 0.5s ease-in-out; 
        background: rgba(255,255,255,0.05); 
        border-radius: 0 0 12px 12px; 
    }
    .setor-content.expanded { max-height: 10000px; padding: 10px 0; border: 1px solid rgba(255,255,255,0.2); border-top: none; }

    /* 5. CARDS DE ITENS (Micro-UX) */
    .item-conferencia { 
        background: #ffffff; 
        border-radius: 14px; 
        padding: 18px; 
        margin: 12px; 
        border: 1px solid #e2e8f0; 
        border-left: 8px solid #cbd5e1; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f8fafc; }
    .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fffafa; }
    
    /* Efeito de brilho (Glow) para itens conclu√≠dos */
    .item-conferencia.status-ok { box-shadow: 0 0 15px rgba(27, 138, 62, 0.1); }

    .item-label { font-weight: 800; color: #0f172a; font-size: 1em; letter-spacing: -0.3px; }

    /* 6. BOT√ïES DE A√á√ÉO (Padr√£o Operacional) */
    .item-options { display: flex; gap: 10px; margin-top: 15px; }
    
    .action-button { 
        flex: 1; 
        padding: 12px; 
        border-radius: 10px; 
        border: 1px solid #e2e8f0; 
        font-weight: 800; 
        font-size: 0.75em; 
        text-transform: uppercase; 
        transition: 0.2s; 
        background: #f8fafc;
        display: flex; align-items: center; justify-content: center; gap: 5px;
    }

    .action-button.active.sa-ok { background: #1b8a3e; color: white; border-color: #1b8a3e; box-shadow: 0 4px 10px rgba(27,138,62,0.3); }
    .action-button.ca-alert { border-color: #d90f23; color: #d90f23; }
    .action-button.active.ca-alert { background: #d90f23; color: white; box-shadow: 0 4px 10px rgba(217,15,35,0.3); }

    /* 7. PEND√äNCIAS (Cards Internos) */
    .pendencia-id-card { 
        background: #f1f5f9; 
        border-radius: 10px; 
        padding: 12px; 
        margin-top: 10px; 
        border: 1px solid #e2e8f0; 
    }

    /* 8. BOT√ÉO FINALIZAR (Sempre vis√≠vel no Desktop / Fixo no Mobile) */
    #btn-finalizar { 
        width: 100%; 
        background: #1b8a3e; 
        color: white; 
        font-weight: 900; 
        border: none; 
        padding: 20px; 
        border-radius: 15px; 
        font-size: 1em; 
        text-transform: uppercase;
        box-shadow: 0 10px 20px rgba(27, 138, 62, 0.4); 
        cursor: pointer; 
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    @media (max-width: 1023px) {
        #btn-finalizar { position: fixed; bottom: 20px; left: 5px; width: calc(100% - 10px); z-index: 1000; }
    }

    #btn-finalizar:hover { transform: translateY(-3px); filter: brightness(1.1); }
    #btn-finalizar:disabled { background: #64748b; box-shadow: none; transform: none; opacity: 0.6; }

    /* 9. UTILIT√ÅRIOS V3 */
    .spinner-v3 { width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.1); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Ocultar elementos para troca de labels PC/Mobile */
    .d-pc-none { display: inline; } .d-pc-inline { display: none; }
    @media (min-width: 768px) { .d-pc-none { display: none; } .d-pc-inline { display: inline; } }
</style>
</head>
<body>
<body>
    <div id="main-content" class="v3-main-wrapper" style="display: none;">
    
        <aside id="resumo-conferente-v3">
            <div class="v3-brand-area">
                <img src="logo_cci.png" alt="Logo CCI" class="v3-logo">
                <h3 id="titulo-conferencia">Confer√™ncia de Materiais</h3>
                <div id="local-posto-info" class="v3-location-badge">Carregando local...</div>
            </div>

            <div id="militar-info" class="user-info-display">
                </div>

            <div class="v3-stats-card">
                <span class="v3-stats-label">PROGRESSO DA MISS√ÉO</span>
                <div class="v3-progress-wrapper">
                    <div id="overall-progress-bar" class="v3-progress-fill"></div>
                </div>
                <div id="progress-text-detail" class="v3-progress-text">0 / 0 itens processados</div>
            </div>

            <button id="btn-finalizar" class="v3-btn-main" disabled>
                <i class="fas fa-lock"></i> AGUARDANDO ITENS
            </button>
            
            <p class="v3-help-text">Verifique todos os itens para liberar a finaliza√ß√£o.</p>
        </aside>

        <main id="lista-setores-conferencia">
             </main>

    </div>

    <div id="loading-message" class="v3-loading-overlay">
        <div class="spinner-v3"></div>
        <span>Sincronizando com Invent√°rio...</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
   const firebaseConfig = { 
        apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", 
        authDomain: "sigma-cbmrr.firebaseapp.com", 
        projectId: "sigma-cbmrr", 
        storageBucket: "sigma-cbmrr.firebasestorage.app", 
        messagingSenderId: "378026276038", 
        appId: "1:378026276038:web:620dd6ff57501b1a8313c7" 
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- INICIALIZA√á√ÉO DE VARI√ÅVEIS E PAR√ÇMETROS DA URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const listaId = urlParams.get('id');
    
    // ‚úÖ CORRE√á√ÉO: Captura o ID e verifica se precisa do prefixo CHECKLIST_VTR_
    let rawID = urlParams.get('id');
    const modoUrl = urlParams.get('modo');
    if (modoUrl === 'checklist_vtr' && rawID && !rawID.startsWith('CHECKLIST_VTR_')) {
        rawID = 'CHECKLIST_VTR_' + rawID;
    }

    const LISTA_ID = rawID;
    const CAUTELA_ID = urlParams.get('cautelaId');
    const COLECAO_CAUTELAS = 'cautelas_abertas';
    
    // ‚úÖ DEFINI√á√ÉO DIN√ÇMICA DA COLE√á√ÉO DE LISTAS
    window.isModoChecklist = (modoUrl === 'checklist_vtr') || (LISTA_ID && LISTA_ID.startsWith('CHECKLIST_VTR_'));
    const COLECAO_LISTAS = window.isModoChecklist ? 'listas_checklist' : 'listas_conferencia';
    
    let MODO_OPERACAO = modoUrl || 'recebimento'; 
    let DESTINATARIO_DEVOLUCAO = urlParams.get('destinatarioDevolucao'); 

    // ‚úÖ CORRE√á√ÉO: Captura Posto/Gradua√ß√£o e Quadro direto da URL para evitar o "ND"
    let userInfo = { 
        postoGraduacao: urlParams.get('posto_grad') || "ND", 
        quadro: urlParams.get('quadro') || "ND", 
        nomeGuerra: urlParams.get('nome_guerra') || "ND",
        uid: urlParams.get('user_uid') || "ND"
    };

    let dadosConferencia = [];
    let isCautela = !!CAUTELA_ID;
    let infoLocal = { nome: '', posto: '' }; 
    window.itemStatus = {};

   // ‚úÖ AJUSTE V3: Captura limpa e decodificada de par√¢metros da URL
function getUrlParameter(n) { 
    const params = new URLSearchParams(window.location.search);
    const value = params.get(n);
    // Retorna o valor decodificado ou uma string vazia, evitando "null" na interface
    return value ? decodeURIComponent(value) : ''; 
}

    function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    // Retorna no padr√£o Brasileiro sem horas, conforme exigido em relat√≥rios de carga
    return date.toLocaleDateString('pt-BR');
}

   function updateHeaderInfo() {
    const el = document.getElementById('militar-info');
    if (!el) return;
    
    // Prioriza userInfo, mas faz o fallback decodificado da URL para evitar o "ND"
    const p = (userInfo && userInfo.nomeGuerra !== "ND") ? userInfo : {
        postoGraduacao: getUrlParameter('posto_grad') || "POSTO",
        quadro: getUrlParameter('quadro') || "QUADRO",
        nomeGuerra: getUrlParameter('nome_guerra') || "NOME"
    };

    // Identidade Visual Din√¢mica baseada no modo
    const isChecklist = window.isModoChecklist;
    const accentColor = isChecklist ? "#2c3e50" : "#800020";

    // ‚úÖ DESIGN V3: Estrutura de Card Profissional
    el.innerHTML = `
        <div class="v3-militar-card" style="display: flex; align-items: center; gap: 15px; padding: 5px;">
            <div class="v3-militar-avatar" style="
                background: ${accentColor}; 
                color: white; 
                width: 45px; 
                height: 45px; 
                border-radius: 12px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-size: 1.4em;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            ">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="v3-militar-data" style="text-align: left; line-height: 1.2;">
                <small style="
                    display: block; 
                    font-size: 0.65em; 
                    font-weight: 800; 
                    letter-spacing: 1px; 
                    color: #64748b; 
                    margin-bottom: 2px;
                    text-transform: uppercase;
                ">Conferente Ativo</small>
                <strong style="
                    display: block; 
                    font-size: 1.05em; 
                    color: #1e293b;
                    text-transform: uppercase;
                ">${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}</strong>
                <span style="font-size: 0.8em; color: #94a3b8; font-weight: 500;">
                    <i class="far fa-clock" style="font-size: 0.9em;"></i> In√≠cio: ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                </span>
            </div>
        </div>
    `;
}
    function updateOverallStatus() {
    const itensPai = document.querySelectorAll('.item-conferencia');
    const totalGeral = itensPai.length;
    let concluidosGeral = 0;

    // 1. MAPEAMENTO DE PROGRESSO REAL
    itensPai.forEach(item => {
        if (item.classList.contains('status-ok') || item.classList.contains('status-alert')) {
            concluidosGeral++;
        }
    });

    const todosConcluidos = totalGeral > 0 && concluidosGeral === totalGeral;

    // 2. ATUALIZA√á√ÉO DA BARRA DE PROGRESSO (SIDEBAR V3)
    const progBar = document.getElementById('overall-progress-bar');
    const progText = document.getElementById('progress-text-detail');
    
    if (progBar) {
        const percentual = totalGeral > 0 ? (concluidosGeral / totalGeral) * 100 : 0;
        
        // Aplica o preenchimento com suavidade (Bezier curve)
        progBar.style.transition = "width 0.6s cubic-bezier(0.4, 0, 0.2, 1)";
        progBar.style.width = `${percentual}%`;
        
        // Muda a cor da barra quando completa 100%
        progBar.style.backgroundColor = percentual === 100 ? "#1b8a3e" : "";
        
        if (progText) {
            progText.innerHTML = todosConcluidos 
                ? `<i class="fas fa-check-circle"></i> Confer√™ncia 100% Conclu√≠da`
                : `<i class="fas fa-sync fa-spin" style="font-size:0.9em"></i> ${concluidosGeral} de ${totalGeral} itens processados`;
        }
    }

    // 3. CONFIGURA√á√ÉO DO BOT√ÉO FINALIZAR (A√á√ÉO OPERACIONAL)
    const btn = document.getElementById('btn-finalizar');
    if (btn) {
        const isChecklist = window.isModoChecklist;
        const corV3 = isChecklist ? '#2c3e50' : '#800020';
        const shadowV3 = isChecklist ? 'rgba(44, 62, 80, 0.4)' : 'rgba(128, 0, 32, 0.4)';
        
        let buttonPrefix = isChecklist ? 'FINALIZAR VISTORIA' : 'FINALIZAR CONFER√äNCIA';
        
        btn.disabled = !todosConcluidos;
        btn.style.transition = "all 0.4s ease";

        if (btn.disabled) {
            btn.innerHTML = `<i class="fas fa-tasks"></i> PENDENTE (${concluidosGeral}/${totalGeral})`;
            btn.style.backgroundColor = '#94a3b8'; // Cinza Slate moderno
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';
            btn.style.boxShadow = 'none';
            btn.style.transform = 'scale(0.98)';
        } else {
            btn.innerHTML = `<i class="fas fa-paper-plane"></i> ${buttonPrefix}`;
            btn.style.backgroundColor = corV3;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.style.boxShadow = `0 10px 25px ${shadowV3}`;
            btn.style.transform = 'scale(1)';
            
            // Efeito de pulso para chamar aten√ß√£o que est√° pronto para salvar
            btn.style.animation = "v3-pulse 2s infinite";
        }
    }

    // 4. ATUALIZA√á√ÉO DOS BADGES DE SETOR (0/X) - √çNTEGRA
    document.querySelectorAll('.setor').forEach(s => {
        const itensNoSetor = s.querySelectorAll('.item-conferencia');
        const totalNoSetor = itensNoSetor.length;
        const concluidosNoSetor = Array.from(itensNoSetor).filter(item => 
            item.classList.contains('status-ok') || item.classList.contains('status-alert')
        ).length;
        const numAlteracoes = s.querySelectorAll('.item-conferencia.status-alert').length;
        
        const statusDiv = s.querySelector('.setor-status');
        if (statusDiv) {
            statusDiv.style.transition = "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)";

            if (totalNoSetor > 0 && concluidosNoSetor === totalNoSetor) {
                if (numAlteracoes > 0) {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${numAlteracoes} ALT`;
                    statusDiv.style.backgroundColor = "#d90f23";
                    statusDiv.style.boxShadow = "0 0 10px rgba(217, 15, 35, 0.3)";
                } else {
                    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> S/A`;
                    statusDiv.style.backgroundColor = "#1b8a3e";
                    statusDiv.style.boxShadow = "0 0 10px rgba(27, 138, 62, 0.3)";
                }
            } else {
                statusDiv.innerText = `${concluidosNoSetor}/${totalNoSetor}`;
                statusDiv.style.backgroundColor = "rgba(0,0,0,0.2)"; 
                statusDiv.style.boxShadow = "none";
            }
            statusDiv.dataset.completed = concluidosNoSetor;
        }
    });
}

function updateSetorStatus(setorEl) { 
    if (!setorEl) return;

    const itensPai = setorEl.querySelectorAll('.item-conferencia'); 
    let concluidos = 0;
    let total = itensPai.length; 

    itensPai.forEach(item => { 
        if (item.classList.contains('status-ok') || item.classList.contains('status-alert')) {
            concluidos++;
        }
    }); 

    setorEl.dataset.totalItems = total; 
    
    const st = setorEl.querySelector('.setor-status'); 
    if (st) {
        st.dataset.completed = concluidos; 
        st.style.color = "#ffffff"; 
        st.style.transition = "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
        
        if (concluidos === total && total > 0) { 
            const temAlerta = setorEl.querySelectorAll('.item-conferencia.status-alert').length > 0;
            
            // ‚úÖ UX V3: Texto mais curto com √≠cone para n√£o quebrar o layout no mobile
            if (temAlerta) {
                st.innerHTML = '<i class="fas fa-exclamation-triangle"></i> C/ ALT';
                st.style.backgroundColor = "#d90f23";
                st.style.boxShadow = "0 0 12px rgba(217, 15, 35, 0.4)";
            } else {
                st.innerHTML = '<i class="fas fa-check-circle"></i> S/A';
                st.style.backgroundColor = "#1b8a3e";
                st.style.boxShadow = "0 0 12px rgba(27, 138, 62, 0.4)";
            }
            st.classList.add('ok'); 
            st.style.minWidth = "70px"; // Largura ajustada para o √≠cone
        } else { 
            // Estado de Progresso (Andamento)
            st.innerHTML = `<i class="fas fa-spinner fa-spin" style="font-size: 0.8em; margin-right: 4px;"></i> ${concluidos}/${total}`; 
            st.classList.remove('ok');
            st.style.backgroundColor = "rgba(0,0,0,0.4)"; // Efeito de transpar√™ncia V3
            st.style.boxShadow = "none";
            st.style.minWidth = "55px";
        } 
    }
}
        function updateItemMainStatusDisplay(item) { 
    if (!item || item.dataset.type === 'single') return; 
    
    const tombs = item.querySelectorAll('.tombamento-container'); 
    let concluidos = 0; 
    let temAlteracao = false; 

    // ‚úÖ AJUSTE V3: Identidade Visual Din√¢mica
    const isChecklist = window.isModoChecklist;
    const corV3 = isChecklist ? '#2c3e50' : '#800020';

    tombs.forEach(t => { 
        const uidOriginal = t.getAttribute('data-id'); 
        const uidCautela = `CAUTELA-${uidOriginal}`;

        const statusObj = window.itemStatus[uidOriginal];
        const statusCautelaObj = window.itemStatus[uidCautela];

        const s = statusObj ? statusObj.status : null; 
        const sCautela = statusCautelaObj ? statusCautelaObj.status : null; 

        // L√≥gica de Preenchimento: OK, Altera√ß√£o, Mantido ou Ciente
        const preenchido = (s === 'ok' || s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente');
        
        if (preenchido) {
            concluidos++;
            if (s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente') {
                temAlteracao = true;
            }
        }
    }); 

    const icon = item.querySelector('.status-icon'); 
    
    // Reseta classes e estilos para aplica√ß√£o limpa
    item.classList.remove('status-ok', 'status-alert');
    item.style.backgroundColor = "";
    if (icon) {
        icon.className = 'status-icon'; 
        icon.style.backgroundColor = "";
    }

    // ‚úÖ L√ìGICA DE ATIVA√á√ÉO V3: Feedback Visual do Item Pai
    if (concluidos === tombs.length && tombs.length > 0) { 
        if (temAlteracao) { 
            item.classList.add('status-alert'); 
            if (icon) {
                icon.classList.add('alert');
                icon.style.backgroundColor = "#d90f23"; // Vermelho Alerta
            }
        } else { 
            item.classList.add('status-ok'); 
            if (icon) {
                icon.classList.add('ok');
                icon.style.backgroundColor = corV3; // Cor Institucional (Bord√¥/Azul)
            }
            // Efeito sutil de preenchimento no card pai para indicar "Setor Resolvido"
            item.style.backgroundColor = "rgba(40, 167, 69, 0.03)"; 
        } 
    } 
    
    // Atualiza o contador do setor (badge) l√° no topo
    const setorEl = item.closest('.setor');
    if (setorEl) updateSetorStatus(setorEl);
}
      function toggleSetor(header) { 
    const content = header.nextElementSibling; 
    const arrow = header.querySelector('.arrow'); 
    
    // Verifica se j√° est√° expandido
    const isExpanded = content.classList.contains('expanded');

    if (isExpanded) { 
        // Fechamento simples
        content.classList.remove('expanded'); 
        arrow.innerHTML = '<i class="fas fa-chevron-right"></i>'; 
        header.style.borderRadius = "12px"; // Retorna ao arredondado total
    } else { 
        // L√ìGICA V3: Fecha outros setores para manter o foco (Modo Sanfona)
        document.querySelectorAll('.setor-content.expanded').forEach(c => {
            c.classList.remove('expanded'); 
            const otherHeader = c.previousElementSibling;
            otherHeader.querySelector('.arrow').innerHTML = '<i class="fas fa-chevron-right"></i>';
            otherHeader.style.borderRadius = "12px";
        }); 

        // Expans√£o do setor atual
        content.classList.add('expanded'); 
        arrow.innerHTML = '<i class="fas fa-chevron-down"></i>'; 
        header.style.borderRadius = "12px 12px 0 0"; // Ajusta quina para conectar ao conte√∫do

        // ‚úÖ UX V3: Scroll Autom√°tico para o topo do setor aberto
        setTimeout(() => {
            header.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Feedback t√°til visual: leve pulso no cabe√ßalho
            header.style.transform = "scale(1.01)";
            setTimeout(() => header.style.transform = "scale(1)", 200);
        }, 300);
    } 
}
    // ‚úÖ PASSO 2: FUN√á√ÉO DE FEEDBACK PARA O M√ìDULO DE FOTOS
function handlePhotoUploadClick() {
    // Usamos um alerta simples, mas informativo
    alert("üì∑ M√≥dulo de Registro Fotogr√°fico\n\n" +
          "Esta funcionalidade est√° em fase de integra√ß√£o com o servidor de arquivos (Storage).\n\n" +
          "Em breve, voc√™ poder√° anexar at√© 5 fotos diretamente da c√¢mera ou galeria para evidenciar o estado da viatura.");
}
        function checkSetorCompletion(currentSetor, currentItemId) {
    if (!currentSetor) return;

    updateOverallStatus();

    const totalItensNoSetor = parseInt(currentSetor.getAttribute('data-total-items')) || 0;
    const itensNoSetor = currentSetor.querySelectorAll('.item-conferencia');
    let concluidos = 0;

    itensNoSetor.forEach(item => {
        const id = item.getAttribute('data-id');
        const isSingle = item.getAttribute('data-type') === 'single';
        const temStatusVisual = item.classList.contains('status-ok') || item.classList.contains('status-alert');
        
        if (isSingle) {
            // L√ìGICA V3: Verifica√ß√£o rigorosa de intera√ß√£o humana para garantir validade
            const statusMemoria = window.itemStatus[id];
            if (temStatusVisual && statusMemoria && statusMemoria.interacao_humana === true) {
                concluidos++;
            }
        } else {
            if (temStatusVisual) concluidos++;
        }
    });

    // ‚úÖ FLUXO V3: Avan√ßo de Setor ou busca do pr√≥ximo item pendente
    if (concluidos >= totalItensNoSetor && totalItensNoSetor > 0) {
        // Setor finalizado: Feedback visual de "Check" antes de fechar
        currentSetor.style.transition = "opacity 0.3s";
        currentSetor.style.opacity = "0.7";
        
        setTimeout(() => {
            currentSetor.style.opacity = "1";
            autoAdvanceSetor(currentSetor); 
        }, 550);
    } else {
        // Busca inteligente do pr√≥ximo alvo (Single ou Tombamento) dentro da lista geral
        const todosAlvos = Array.from(document.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]'));
        const indexAtual = todosAlvos.findIndex(el => el.getAttribute('data-id') === currentItemId);

        const proximoAlvo = todosAlvos.slice(indexAtual + 1).find(el => {
            const id = el.getAttribute('data-id');
            const type = el.getAttribute('data-type');
            const stNormal = window.itemStatus[id]?.status;
            const stCautela = window.itemStatus[`CAUTELA-${id}`]?.status;
            const interacao = window.itemStatus[id]?.interacao_humana;
            
            const jaResolvido = (type === 'single') 
                ? (interacao === true && (stNormal === 'ok' || stNormal === 'C/A'))
                : (stNormal === 'ok' || stNormal === 'C/A' || stNormal === 'KEEP' || stCautela === 'cautela_ciente');
                
            return !jaResolvido;
        });

        if (proximoAlvo) {
            setTimeout(() => {
                // ‚úÖ UX V3: Scroll com efeito Spotlight (brilho de foco)
                proximoAlvo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Aplica um "alerta visual" suave de que este √© o novo foco
                const isChecklist = window.isModoChecklist;
                const glowColor = isChecklist ? "rgba(44, 62, 80, 0.4)" : "rgba(245, 124, 0, 0.4)";
                
                proximoAlvo.style.transition = "box-shadow 0.4s ease";
                proximoAlvo.style.boxShadow = `0 0 20px ${glowColor}`;
                
                setTimeout(() => proximoAlvo.style.boxShadow = "none", 1200);
            }, 350);
        }
    }
}
        function injetarCautelasNaLista() {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    // Aqui simulamos a leitura da sua cole√ß√£o cautelas_abertas
    // No seu c√≥digo real, voc√™ deve garantir que window.cautelasAbertas contenha os itens que voc√™ me enviou
    const cautelas = window.cautelasAbertas || []; 

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            cautelas.forEach(cautelaDoc => {
                cautelaDoc.itens.forEach(itemCautelado => {
                    // Se o ID base coincide (Ex: 56911524-64012364)
                    if (item.id === itemCautelado.id_base) {
                        
                        if (item.tipo === 'multi' && item.tombamentos) {
                            // Procura o tombamento espec√≠fico (Ex: 511.524 ou 511.527)
                            const t = item.tombamentos.find(tomb => tomb.tomb === itemCautelado.tombamento);
                            if (t) {
                                t.cautela = {
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: 1,
                                    id_cautela: cautelaDoc.cautela_id
                                };
                            }
                        } else if (item.tipo === 'single') {
                            if (!item.cautelas) item.cautelas = [];
                            // Evita duplicados
                            if (!item.cautelas.find(c => c.id_cautela === cautelaDoc.cautela_id)) {
                                item.cautelas.push({
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: itemCautelado.quantidade,
                                    id_cautela: cautelaDoc.cautela_id
                                });
                            }
                        }
                    }
                });
            });
        });
    });
}

        function autoAdvanceSetor(currentSetorElement) {
    const todosSetores = Array.from(document.querySelectorAll('.setor'));
    const currentIndex = todosSetores.indexOf(currentSetorElement);
    
    const currentContent = currentSetorElement.querySelector('.setor-content');
    const currentArrow = currentSetorElement.querySelector('.arrow');
    const currentHeader = currentSetorElement.querySelector('.setor-header');
    
    // ‚úÖ UX V3: Fechamento elegante com reset de bordas
    if (currentContent) currentContent.classList.remove('expanded');
    if (currentArrow) currentArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
    if (currentHeader) currentHeader.style.borderRadius = "12px";

    // Verifica se existe um pr√≥ximo setor
    if (currentIndex !== -1 && currentIndex < todosSetores.length - 1) {
        const nextSetorEl = todosSetores[currentIndex + 1];
        const nextContent = nextSetorEl.querySelector('.setor-content');
        const nextArrow = nextSetorEl.querySelector('.arrow');
        const nextHeader = nextSetorEl.querySelector('.setor-header');
        
        // ‚úÖ Transi√ß√£o V3: Pequena pausa para o olho humano processar o fechamento
        setTimeout(() => {
            if (nextContent) nextContent.classList.add('expanded');
            if (nextArrow) nextArrow.innerHTML = '<i class="fas fa-chevron-down"></i>';
            if (nextHeader) nextHeader.style.borderRadius = "12px 12px 0 0";
            
            // Scroll suave focado no in√≠cio do novo setor
            nextSetorEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Feedback visual: Brilho tempor√°rio no cabe√ßalho do novo setor
            if (nextHeader) {
                const isChecklist = window.isModoChecklist;
                const activeColor = isChecklist ? "rgba(44, 62, 80, 0.2)" : "rgba(128, 0, 32, 0.2)";
                nextHeader.style.boxShadow = `0 0 20px ${activeColor}`;
                setTimeout(() => { nextHeader.style.boxShadow = ""; }, 1000);
            }
        }, 300);

    } else {
        // ‚úÖ FINAL DO FLUXO: Guia o usu√°rio diretamente ao bot√£o de a√ß√£o final
        const btnFin = document.getElementById('btn-finalizar');
        if (btnFin) {
            setTimeout(() => {
                btnFin.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Anima√ß√£o de pulso no bot√£o para indicar prontid√£o
                btnFin.style.transform = "translateX(-50%) scale(1.1)";
                setTimeout(() => { btnFin.style.transform = "translateX(-50%) scale(1)"; }, 400);
            }, 400);
        }
    }
}
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }

       // --- 1. FUN√á√ÉO PARA LER DADOS ANTIGOS (LEGADOS) ---
const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
    const separator = ' | + NOVA: ';
    if (typeof textoBruto !== 'string') return [];
    
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
            if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
        if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
    }
    return linhas;
};

// --- 2. FUN√á√ÉO VISUAL √öNICA (SEM HORAS VIA REGEX) ---
const gerarHtmlVisualApp = (pendencia, autorAtual, dataAtual) => {
    let html = '<ul class="lista-pendencias" style="list-style: none; padding: 0; margin: 5px 0;">';
    const lista = (pendencia && pendencia.pendencias_ca) ? pendencia.pendencias_ca : 
                  (Array.isArray(pendencia) ? pendencia : null);
    if (lista && Array.isArray(lista) && lista.length > 0) {
        lista.forEach(p => {
            const militar = p.quem || 'Militar';
            const dataFull = p.data || '';
            
            // Extrai apenas a data (DD/MM/AAAA) usando regex
            const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
            const dataApenas = matchData ? matchData[0] : dataFull;

            html += `
                <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px;">
                    <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                    <b>Por </b>
                    <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                    <span> em <b>${dataApenas}</b>:</span>
                    <i style="margin-left: 5px; color: #333; font-weight: normal; display: block; padding-left: 25px;">${p.obs}</i>
                </li>`;
        });
    } 
    // 3. FALLBACK PARA DADOS ANTIGOS (S√≥ entra aqui se N√ÉO houver lista)
    else if (pendencia && pendencia.obs && typeof pendencia.obs === 'string') {
        const militar = pendencia.quem || autorAtual || 'Militar';
        const dataFull = pendencia.data || dataAtual || '';
        const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
        const dataApenas = matchData ? matchData[0] : dataFull;

        html += `
            <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem;">
                <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                <b>Por </b>
                <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                <span> em <b>${dataApenas}</b>:</span>
                <i style="margin-left: 5px; color: #333; font-weight: normal;">${pendencia.obs}</i>
            </li>`;
    }

    html += '</ul>';
    return html;
};
    
function renderizarConferencia() {
    const mainContent = document.getElementById('lista-setores-conferencia'); // Direcionado para a coluna da direita do Dashboard
    const antigos = document.querySelectorAll('.setor'); 
    antigos.forEach(el => el.remove());

    let htmlSetores = ''; 
    const fonteDados = window.dadosConferencia || dadosConferencia;
    
    const urlParams = new URLSearchParams(window.location.search);
    const isConferenciaDeCautela = !!urlParams.get('cautelaId');
    const isChecklist = window.isModoChecklist || false;
    const isRecebimentoCarga = urlParams.get('modo') === 'recebimento_carga';

    // --- CONFIGURA√á√ÉO DE IDENTIDADE VISUAL V3 ---
    let corTema = '#800020'; 
    if (isChecklist) corTema = '#2c3e50'; 
    if (isRecebimentoCarga) corTema = '#000000'; 

    // ‚úÖ MANUTEN√á√ÉO INTEGRAL: Cabe√ßalho de Transfer√™ncia (Dashboard Style)
    if (isRecebimentoCarga && window.dadosTransferencia) {
        const tr = window.dadosTransferencia;
        const totalVolumes = (tr.itens || []).reduce((acc, item) => acc + (Number(item.quantidade) || 0), 0);
        const htmlHeaderTr = `
            <div id="extrato-transferencia-card" style="margin-bottom: 25px; border: 1px solid #343a40; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #fff;">
                <div style="background-color: #343a40; color: white; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exchange-alt"></i> 
                        <span style="letter-spacing: 1px; font-weight: 800; font-size: 0.9em; text-transform: uppercase;">Extrato de Movimenta√ß√£o</span>
                    </div>
                    <span style="font-size: 0.75em; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; color: #fff; font-weight: bold;">
                        ${totalVolumes} VOLUMES
                    </span>
                </div>
                <div style="padding: 20px; text-align: left; font-size: 0.85em;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1; padding: 12px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0; border-top: 4px solid #64748b;">
                            <small style="color:#64748b; font-weight:800; font-size: 0.7em; text-transform: uppercase;">Origem</small><br>
                            <div style="margin-top: 6px; line-height: 1.5;">
                                <i class="fas fa-building" style="color: #475569; width: 18px;"></i> <b>${tr.origem_sigla || 'DLOG'}</b><br>
                                <i class="fas fa-user-tie" style="color: #94a3b8; width: 18px;"></i> <span style="color: #475569;">${tr.emitente || 'N/D'}</span>
                            </div>
                        </div>
                        <div style="color: #cbd5e1; font-size: 1.2em;"><i class="fas fa-arrow-right"></i></div>
                        <div style="flex: 1; padding: 12px; background: #fff; border-radius: 10px; border: 1px solid #000; border-top: 4px solid #000;">
                            <small style="color:#000; font-weight:800; font-size: 0.7em; text-transform: uppercase;">Destinat√°rio</small><br>
                            <div style="margin-top: 6px; line-height: 1.5;">
                                <i class="fas fa-map-marker-alt" style="color: #000; width: 18px;"></i> <b>${tr.destino_sigla || 'CCI'}</b><br>
                                <i class="fas fa-user-check" style="color: #000; width: 18px;"></i> <span style="color: #000;">${userInfo.postoGraduacao} ${userInfo.nomeGuerra}</span>
                            </div>
                        </div>
                    </div>
                    <div style="padding-top: 12px; border-top: 1px dashed #e2e8f0; display: flex; justify-content: space-between; color: #64748b; font-size: 0.85em;">
                         <span><i class="far fa-calendar-alt"></i> Enviado: ${tr.timestamp_envio?.toDate().toLocaleDateString('pt-BR')}</span>
                         <span><i class="fas fa-clipboard-list"></i> Itens: <b>${tr.itens.length}</b></span>
                    </div>
                </div>
            </div>`;
        mainContent.insertAdjacentHTML('afterbegin', htmlHeaderTr);
    }

    // ‚úÖ FUN√á√ÉO INTERNA PRESERVADA COM LOGICA DE CAUTELA (CARIMBO LARANJA)
    const montarPendenciaHtml = (uid, itemOuTomb) => {
        let htmlAcumulado = '';
        const statusLocal = window.itemStatus[uid] || {};
        const cautelaUid = `CAUTELA-${uid}`;
        const statusCautela = window.itemStatus[cautelaUid] || {};
        const isCiente = statusCautela.status === 'cautela_ciente' || statusCautela.cautela_confirmada === true;

        if (!isConferenciaDeCautela) {
            let listaDeCautelas = [];
            if (itemOuTomb.cautela) listaDeCautelas = [itemOuTomb.cautela];
            else if (itemOuTomb.cautelas && Array.isArray(itemOuTomb.cautelas)) listaDeCautelas = itemOuTomb.cautelas;

            listaDeCautelas.forEach(c => {
                const dataExibicao = c.data || "Data N/D";
                htmlAcumulado += `
                    <div class="pendencia-id-card status-cautela" style="border-left: 5px solid #f57c00; background-color: #fffaf0; padding: 12px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(245,124,0,0.1); text-align: left;">
                        <div style="font-weight: 800; color: #f57c00; font-size: 0.75em; margin-bottom: 8px; border-bottom: 1px solid rgba(245, 124, 0, 0.1); padding-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 6px;" onclick="verExtratoCautela('${c.id}')">
                            <i class="fas fa-external-link-alt"></i> ID: ${c.id || 'CAUTELA'} (${dataExibicao})
                        </div>
                        <div style="font-size: 0.85em; color: #444; margin-bottom: 4px;"><i class="fas fa-tag" style="width: 18px; opacity:0.5;"></i> Detentor: <b>${c.destinatario}</b></div>
                        <div style="font-size: 0.85em; color: #444; margin-bottom: 10px;"><i class="fas fa-layer-group" style="width: 18px; opacity:0.5;"></i> Quantidade: <b>${c.quantidade || 1} un.</b></div>
                        ${isCiente ? `
                            <div style="color: #1b8a3e; font-size: 0.75em; font-weight: 800; border-top: 1px solid #eee; padding-top: 8px; margin-top: 5px; font-style: italic;">
                                <i class="fas fa-check-double"></i> CIENTE NESTA CONFER√äNCIA
                            </div>` : `
                            <button type="button" class="action-button active ca-alert" style="width: 100%; border-radius: 8px; height: 35px; font-weight:800; cursor:pointer;" onclick="setItemStatusID(this, 'cautela_ciente', '${cautelaUid}')">
                                <i class="fas fa-user-check"></i> CONFIRMAR CI√äNCIA
                            </button>`}
                    </div>`;
            });
        }

        // ‚úÖ LOGICA DE PEND√äNCIAS (MANTER / RESOLVER) PRESERVADA
        if (itemOuTomb.pendencias_ids && Array.isArray(itemOuTomb.pendencias_ids)) {
            itemOuTomb.pendencias_ids.forEach(p => {
                const isTemp = String(p.id).startsWith('TEMP-');
                const jaFoiMantido = statusLocal.ids_mantidos && statusLocal.ids_mantidos.map(String).includes(String(p.id));
                const nomeExibicao = p.autor_nome || "Conferente";
                
                let acoesHtml = '';
                let botoesGestaoHtml = '';

                if (isTemp) {
                    botoesGestaoHtml = `<div style="display:flex; gap:8px;"><span onclick="abrirModalEditar('${p.id}', '${uid}', ${p.quantidade}, '${p.descricao.replace(/'/g, "\\'")}')" style="color:#2196F3; cursor:pointer;"><i class="fas fa-edit"></i></span><span onclick="confirmarExclusaoRelato('${p.id}', '${uid}')" style="color:#d90f23; cursor:pointer;"><i class="fas fa-trash-alt"></i></span></div>`;
                    acoesHtml = `<div style="color:#2196F3; font-size:0.7em; font-weight:800; text-align:center; padding-top:8px; border-top:1px solid #f0f7ff;">AGUARDANDO FINALIZA√á√ÉO...</div>`;
                } else if (jaFoiMantido) {
                    acoesHtml = `<div style="color: #1b8a3e; font-size: 0.7em; font-weight: 800; border-top: 1px solid #eee; padding-top: 8px; margin-top: 5px;"><i class="fas fa-check-circle"></i> MANTIDO NESTA SESS√ÉO</div>`;
                } else {
                    acoesHtml = `
                        <div class="pendencia-actions" style="display: flex; gap: 8px; margin-top: 12px;">
                            <button type="button" class="btn-manter" onclick="manterID('${p.id}', '${uid}')"><i class="fas fa-shield-alt"></i> MANTER</button>
                            <button type="button" class="btn-resolver" onclick="abrirModalResolver('${p.id}', '${uid}', ${p.quantidade}, '${p.descricao.replace(/'/g, "\\'")}')"><i class="fas fa-check"></i> RESOLVIDO</button>
                        </div>`;
                }

                htmlAcumulado += `
                    <div class="pendencia-id-card" id="card-${p.id}" style="border: 1px solid ${isTemp ? '#2196F3' : (jaFoiMantido ? '#1b8a3e' : '#d90f23')}; border-radius: 10px; padding: 12px; margin-bottom: 10px; background: #fff; text-align: left;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #64748b; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px;">
                            <span><i class="fas fa-user-edit"></i> ${nomeExibicao}</span>
                            <div style="display:flex; align-items:center; gap:10px;"><span>${p.data_criacao}</span>${botoesGestaoHtml}</div>
                        </div>
                        <div style="font-size: 0.85em; color: #1e293b; margin-bottom: 5px;"><b>${p.quantidade} un.</b>: ${p.descricao}</div>
                        ${acoesHtml}
                    </div>`;
            });
        }
        return htmlAcumulado;
    };

    fonteDados.forEach((setor, index) => {
        const isFirstSetor = (index === 0);
        const nomeSetorUpper = setor.nome.toUpperCase();
        let htmlConteudoSetor = '';

        // ‚úÖ LOGICA DE FOTOS INTEGRAL
        if (isChecklist && (nomeSetorUpper.includes("FOTOGR√ÅFICO") || nomeSetorUpper.includes("FOTOS"))) {
            htmlConteudoSetor = `<div class="photo-module" style="padding: 20px; text-align: center; background: #f8fafc; border-radius: 12px; margin: 15px; border: 2px dashed ${corTema};"><button type="button" onclick="handlePhotoUploadClick()" style="background:${corTema}; color:white; border:none; padding:15px; border-radius:10px; font-weight:800; width:100%; cursor:pointer;"><i class="fas fa-camera"></i> ADICIONAR FOTOS (AT√â 5)</button><div id="photo-preview-grid" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:15px;"></div></div>`;
            window.itemStatus[setor.id || setor.nome] = { status: 'ok', interacao_humana: true };
        }
        else {
            setor.itens.forEach(item => {
                const itemId = item.uid_global || item.id || item.id_base || ("TEMP_" + index);
                const nomeEscapado = item.nome.replace(/'/g, "\\'");
                const isObsSetor = nomeSetorUpper.includes("OBSERVA√á√ïES");

                // ‚úÖ ITEM TIPO MULTI (TOMBAMENTOS) - PRESERVA√á√ÉO TOTAL
                if (item.tipo === 'multi' && item.tombamentos) {
                    let htmlTombamentos = '';
                    let confCount = 0;
                    let temAlertaNoGrupo = false;

                    item.tombamentos.forEach(t => {
                        const uid = `${itemId}-${t.tomb}`;
                        const pndHtml = montarPendenciaHtml(uid, t);
                        const statusU = window.itemStatus[uid]?.status;
                        const hasPendenciaReal = (t.pendencias_ids && t.pendencias_ids.length > 0);
                        const hasCautelaReal = (!!t.cautela && !isConferenciaDeCautela);
                        const ocultarSA = hasPendenciaReal || hasCautelaReal;
                        const statusC = window.itemStatus[`CAUTELA-${uid}`]?.status;
                        const isCiente = statusC === 'cautela_ciente' || window.itemStatus[`CAUTELA-${uid}`]?.cautela_confirmada === true;

                        if (statusU === 'ok' || statusU === 'C/A' || statusU === 'KEEP' || isCiente) {
                            confCount++;
                            if (statusU === 'C/A' || statusU === 'KEEP' || isCiente) temAlertaNoGrupo = true;
                        }

                        htmlTombamentos += `
                            <div class="tombamento-container" data-id="${uid}" style="border: 1px solid #e2e8f0; padding: 12px; margin-bottom: 8px; border-radius: 10px; ${isCiente ? 'background-color: #f0fff4;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size:0.9em; font-weight:700;">Tomb.: <b style="color:#1e293b">${t.tomb}</b></span>
                                    <div class="tombamento-options" style="display:flex; gap:6px;">
                                        ${!ocultarSA ? `<button type="button" class="action-button sa-ok ${statusU === 'ok' ? 'active' : ''}" style="${statusU === 'ok' ? `background-color:${corTema}!important` : ''}" onclick="setItemStatusID(this, 'ok', '${uid}')">${isRecebimentoCarga ? '√çNTEGRO' : 'S/A'}</button>` : ''}
                                        <button type="button" class="action-button ca-alert ${hasPendenciaReal ? 'active' : ''}" onclick="abrirFormNovoID('${uid}', 'multi', '${nomeEscapado}', 1, '${t.tomb}')">${isRecebimentoCarga ? 'AVARIA' : '+ ALT'}</button>
                                    </div>
                                </div>
                                <div class="alerts-wrapper">${pndHtml}</div>
                            </div>`;
                    });
                    let classeMulti = (confCount === item.tombamentos.length && item.tombamentos.length > 0) ? (temAlertaNoGrupo ? 'status-alert' : 'status-ok') : '';
                    htmlConteudoSetor += `
                        <div class="item-conferencia item-has-tombamentos ${classeMulti}" data-id="${itemId}" style="background:#fff; border-radius:12px; margin:15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                            <div class="item-header" style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; gap:10px;">
                                <span class="status-icon ${classeMulti === 'status-ok' ? 'ok' : (classeMulti === 'status-alert' ? 'alert' : '')}" style="${classeMulti === 'status-ok' ? `background-color:${corTema}!important` : ''}"></span>
                                <span class="item-label" style="font-weight:800; color:#0f172a; flex-grow:1; text-align:left;">${item.nome}</span>
                            </div>
                            <div style="padding:10px;">${htmlTombamentos}</div>
                        </div>`;
                } else {
                    // ‚úÖ ITEM TIPO SINGLE (QUANTIDADE) - PRESERVA√á√ÉO TOTAL DA L√ìGICA DE SALDO
                    const uid = itemId; 
                    const pndHtml = montarPendenciaHtml(uid, item);
                    const statusLocal = window.itemStatus[uid] || {};
                    const totalOriginal = Number(item.quantidadeEsperada || item.quantidade || 0);
                    const totalCaut = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                    const totalPend = (item.pendencias_ids || []).reduce((sum, p) => sum + (Number(p.quantidade) || 0), 0);
                    const saldoDisponivel = totalOriginal - totalCaut - totalPend;
                    const hasPendenciaReal = (item.pendencias_ids && item.pendencias_ids.length > 0);
                    const hasCautelaReal = (item.cautelas && item.cautelas.length > 0 && !isConferenciaDeCautela);
                    const ocultarSA = hasPendenciaReal || hasCautelaReal;
                    const isCiente = window.itemStatus[`CAUTELA-${uid}`]?.status === 'cautela_ciente' || window.itemStatus[`CAUTELA-${uid}`]?.cautela_confirmada === true;
                    let classeSingle = (statusLocal.status === 'ok') ? 'status-ok' : (isCiente || hasPendenciaReal ? 'status-alert' : '');

                    htmlConteudoSetor += `
                        <div class="item-conferencia ${classeSingle}" data-type="single" data-id="${uid}" style="background:#fff; border-radius:12px; margin:15px; padding:15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                            <div class="item-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="status-icon ${classeSingle === 'status-ok' ? 'ok' : (classeSingle === 'status-alert' ? 'alert' : '')}" style="${classeSingle === 'status-ok' ? `background-color:${corTema}!important` : ''}"></span>
                                    <div style="display:flex; flex-direction:column; text-align:left;">
                                        <span class="item-label" style="font-weight:800; color:#0f172a;">${item.nome}</span>
                                        ${!isChecklist && !isObsSetor ? `<span style="font-size:0.75em; color:#64748b; font-weight:800; margin-top:2px;">${isRecebimentoCarga ? 'A RECEBER' : 'DISPON√çVEL'}: <span style="background:${corTema}20; color:${corTema}; padding:2px 6px; border-radius:5px;">${isRecebimentoCarga ? totalOriginal : saldoDisponivel} un.</span></span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="item-options" style="margin-top:15px; display:flex; gap:8px;">
                                ${!ocultarSA ? `<button type="button" class="action-button sa-ok ${statusLocal.status === 'ok' ? 'active' : ''}" style="${statusLocal.status === 'ok' ? `background-color:${corTema}!important` : ''}" onclick="setItemStatusID(this, 'ok', '${uid}')">${isRecebimentoCarga ? '√çNTEGRO' : 'S/A'}</button>` : ''}
                                <button type="button" class="action-button ca-alert ${hasPendenciaReal ? 'active' : ''}" onclick="abrirFormNovoID('${itemId}', 'single', '${nomeEscapado}', ${isChecklist ? 1 : (isRecebimentoCarga ? totalOriginal : saldoDisponivel)})">${isRecebimentoCarga ? 'DIVERG.' : (isObsSetor ? '+ TEXTO' : '+ ALT')}</button>
                            </div>
                            <div class="alerts-wrapper" style="margin-top:10px">${pndHtml}</div>
                        </div>`;
                }
            });
        }

        // ‚úÖ ACORDE√ÉO DO SETOR V3
        htmlSetores += `
            <div class="setor" data-total-items="${setor.itens.length}" data-id="${setor.id || setor.nome}" style="background: rgba(255,255,255,0.05); border-radius:15px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.1);">
                <div class="setor-header" onclick="toggleSetor(this)" style="background-color: ${corTema} !important; padding:18px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                    <div class="setor-info" style="display:flex; align-items:center; gap:12px;">
                        <span style="font-weight:900; letter-spacing:0.5px; text-transform:uppercase; font-size:0.9em;">${setor.nome}</span>
                        <div class="setor-status" style="background:rgba(255,255,255,0.2); padding:3px 10px; border-radius:20px; font-weight:800; font-size:0.8em;">0/${setor.itens.length}</div>
                    </div>
                    <span class="arrow"><i class="fas fa-chevron-${isFirstSetor ? 'down' : 'right'}"></i></span>
                </div>
                <div class="setor-content ${isFirstSetor ? 'expanded' : ''}">${htmlConteudoSetor}</div>
            </div>`;
    });

    // ‚úÖ INJE√á√ÉO NO CONTAINER DE DESTINO (COLUNA DIREITA)
    mainContent.innerHTML = htmlSetores;

    // Ajuste do Bot√£o Finalizar para o Sidebar
    const btnFin = document.getElementById('btn-finalizar');
    if (btnFin) {
        btnFin.style.backgroundColor = corTema;
    }
    updateOverallStatus();
}
    
async function carregarDadosRemotos() {
    // 1. CAPTURA IMEDIATA DOS PAR√ÇMETROS
    const urlParamsLocal = new URLSearchParams(window.location.search);
    const idUrl = urlParamsLocal.get('id');
    const cautelaIdUrl = urlParamsLocal.get('cautelaId');
    const modoUrl = urlParamsLocal.get('modo');
    const transferenciaIdUrl = urlParamsLocal.get('transferenciaId'); 

    // 2. DEFINI√á√ÉO DO MODO (Garante identidade visual correta)
    let ID_ALVO = transferenciaIdUrl || cautelaIdUrl || idUrl; 
    const isCautelaLocal = !!cautelaIdUrl;
    const isRecebimentoCarga = modoUrl === 'recebimento_carga'; 
    
    if (modoUrl === 'checklist_vtr' && ID_ALVO && !ID_ALVO.startsWith('CHECKLIST_VTR_')) {
        ID_ALVO = 'CHECKLIST_VTR_' + ID_ALVO;
    }

    window.isModoChecklist = (modoUrl === 'checklist_vtr') || (ID_ALVO && ID_ALVO.startsWith('CHECKLIST_VTR_'));
    
    // 3. CONFIGURA√á√ÉO VISUAL
    const tituloPrincipal = document.getElementById('titulo-conferencia');
    const btnFinalizar = document.getElementById('btn-finalizar');
    
    if (window.isModoChecklist) {
        if (tituloPrincipal) {
            tituloPrincipal.innerText = "Vistoria de Viatura";
            tituloPrincipal.style.color = "#2c3e50";
        }
        if (btnFinalizar) {
            btnFinalizar.innerText = "FINALIZAR VISTORIA";
            btnFinalizar.style.backgroundColor = "#2c3e50";
        }
    } else {
        if (tituloPrincipal) {
            if (isRecebimentoCarga) {
                const ano = new Date().getFullYear();
                tituloPrincipal.innerText = `GUIA: TR-${ano}/${ID_ALVO.substring(0,5).toUpperCase()}`;
            } else {
                tituloPrincipal.innerText = isCautelaLocal ? "Recebimento de Cautela" : "Confer√™ncia de Materiais";
            }
            tituloPrincipal.style.color = isRecebimentoCarga ? "#000000" : "#800020";
        }
        if (btnFinalizar) {
            btnFinalizar.innerText = isRecebimentoCarga ? "CONFIRMAR RECEBIMENTO" : "FINALIZAR CONFER√äNCIA";
            btnFinalizar.style.backgroundColor = isRecebimentoCarga ? "#000000" : "#800020";
        }
    }

    // 4. IDENTIDADE DO CONFERENTE
    userInfo.postoGraduacao = urlParamsLocal.get('posto_grad') || "ND";
    userInfo.quadro = urlParamsLocal.get('quadro') || "ND";
    userInfo.nomeGuerra = urlParamsLocal.get('nome_guerra') || "ND";
    userInfo.uid = urlParamsLocal.get('user_uid') || "ND";

    // ‚úÖ V3: Dispara atualiza√ß√£o do card do militar no sidebar
    if (typeof updateHeaderInfo === "function") updateHeaderInfo();

    const elHeader = document.getElementById('militar-info');
    if (elHeader) {
        let headerHTML = `<i class="fas fa-user-shield"></i> <strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><i class="fas fa-clock"></i> <strong>Data/Hora:</strong> ${new Date().toLocaleString('pt-BR')}`;

        if (window.isModoChecklist) {
            const km = urlParamsLocal.get('km') || "0";
            const combustivel = urlParamsLocal.get('combustivel') || "N/D";
            headerHTML += `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ccc; display: flex; gap: 15px; color: #2c3e50; font-weight: bold; font-size: 0.95em;">
                    <span><i class="fas fa-tachometer-alt"></i> KM: ${Number(km).toLocaleString('pt-BR')}</span>
                    <span><i class="fas fa-gas-pump"></i> Tanque: ${combustivel}</span>
                </div>`;
        }
        elHeader.innerHTML = headerHTML;
    }

    if (!ID_ALVO || ID_ALVO === "null") return;

    let COLECAO_ALVO = isCautelaLocal ? 'cautelas_abertas' : 'listas_conferencia';
    if (window.isModoChecklist) COLECAO_ALVO = 'listas_checklist';
    if (isRecebimentoCarga) COLECAO_ALVO = 'transferencias_pendentes';

    const loadingMsg = document.getElementById('loading-message');
    try {
        const doc = await db.collection(COLECAO_ALVO).doc(ID_ALVO).get();
        if (!doc.exists) throw new Error(`Documento n√£o encontrado na cole√ß√£o ${COLECAO_ALVO}`);
        
        const data = doc.data();
        const isDevolucaoFinal = modoUrl === 'devolucao_final';

        if (isRecebimentoCarga) {
            window.dadosTransferencia = data;
        }
        
        // ‚úÖ BUSCA REVERSA: Captura a √∫ltima confer√™ncia realizada para herdar pend√™ncias
        let pendenciasHerdadas = {};
        if (!isCautelaLocal && !isRecebimentoCarga) {
            const colecaoResultados = window.isModoChecklist ? 'resultados_checklist' : 'resultados_conferencias';
            const ultimaConfQuery = await db.collection(colecaoResultados)
                .where('lista_id', '==', ID_ALVO)
                .orderBy('timestamp', 'desc')
                .limit(1)
                .get();

            if (!ultimaConfQuery.empty) {
                const ultimoResultado = ultimaConfQuery.docs[0].data();
                (ultimoResultado.itensRelatorio || []).forEach(itemRel => {
                    const idBusca = itemRel.id || itemRel.uid_global;
                    if (itemRel.status === 'C/A' && itemRel.pendencias_ids && idBusca) {
                        pendenciasHerdadas[idBusca] = itemRel.pendencias_ids;
                    }
                });
            }
        }

        if (isCautelaLocal || isRecebimentoCarga) {
            dadosConferencia = adaptarCautelaParaRender(data);
        } else {
            const listaBruta = data.list || [];
            dadosConferencia = listaBruta.map(setor => ({
                ...setor,
                itens: (setor.itens || []).map(item => {
                    if (!item.id) item.id = item.uid_global;
                    item.pendencias_ids = []; 
                    if (pendenciasHerdadas[item.id]) {
                        item.pendencias_ids = pendenciasHerdadas[item.id];
                    }
                    item.quantidadeEsperada = Number(item.quantidadeEsperada || item.quantidade || 0);
                    item._ocultarCarimbo = isDevolucaoFinal;
                    return item;
                })
            }));
        }

        window.dadosConferencia = dadosConferencia;

        const infoElement = document.getElementById('local-posto-info');
        if (infoElement) {
            if (isRecebimentoCarga) {
                infoElement.style.display = 'none';
            } else {
                infoLocal = { 
                    nome: isCautelaLocal ? `CAUTELA: ${ID_ALVO}` : (data.ativo_nome || data.nome_local || "Lista"),
                    posto: isCautelaLocal ? "" : (data.posto_nome || data.unidade_sigla || "Geral")
                };
                const separador = infoLocal.posto ? " - " : "";
                const corDinamica = window.isModoChecklist ? "#2c3e50" : "#800020";
                infoElement.innerHTML = `<span style="color:${corDinamica};font-weight:bold">${infoLocal.nome}${separador}${infoLocal.posto}</span>`;
            }
        }

        if (btnFinalizar) {
            btnFinalizar.disabled = false;
            if (isDevolucaoFinal) btnFinalizar.onclick = () => finalizarRecebimentoDevolucao(data);
            else if (isRecebimentoCarga) btnFinalizar.onclick = () => finalizarRecebimentoCarga(data); 
            else if (isCautelaLocal) btnFinalizar.onclick = () => finalizarRecebimentoCautela(data);
            else btnFinalizar.onclick = () => finalizarConferencia();
        }

        renderizarConferencia(); 
        if (typeof updateOverallStatus === "function") updateOverallStatus();
        
        if (loadingMsg) loadingMsg.style.display = 'none'; 
        
        // ‚úÖ V3: Ativa o wrapper do Dashboard
        const mainWrapper = document.getElementById('main-content');
        if (mainWrapper) {
            mainWrapper.style.display = 'flex';
            mainWrapper.classList.add('v3-main-wrapper'); 
        }

    } catch (e) { 
        console.error("Erro no carregamento remoto:", e);
        if (loadingMsg) loadingMsg.innerHTML = `<span style='color:red'>Erro ao carregar dados: ${e.message}</span>`;
    }
}   
    async function abrirModalEditar(pendenciaId, uid, qtdAtual, descricaoAtual) {
    // ‚úÖ IDENTIDADE VISUAL DE EDI√á√ÉO (Azul SIGMA)
    const corEdicao = "#2196F3";
    const uidString = String(uid);

    // ‚úÖ DISPARO DO MODAL ELEGANTE
    const { value: formValues } = await Swal.fire({
        title: `<span style="color: ${corEdicao}; font-size: 0.9em; font-weight: bold;"><i class="fas fa-edit"></i> Editar Relato</span>`,
        html: `
            <div style="text-align: left; font-family: sans-serif;">
                <p style="margin-bottom: 15px; font-size: 0.85em; color: #666;">Ajuste os detalhes da altera√ß√£o selecionada abaixo.</p>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Quantidade:</label>
                    <input id="swal-input-qtd" type="number" class="swal2-input" value="${qtdAtual}" min="1" style="width: 100%; margin: 5px 0 0 0; height: 40px;">
                </div>

                <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Nova Descri√ß√£o:</label>
                <textarea id="swal-input-obs" class="swal2-textarea" placeholder="Descreva a altera√ß√£o..." style="width: 100%; margin: 5px 0 0 0; min-height: 100px; text-transform: uppercase; font-size: 0.9em;">${descricaoAtual}</textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'SALVAR ALTERA√á√ïES',
        cancelButtonText: 'CANCELAR',
        confirmButtonColor: corEdicao,
        reverseButtons: true,
        backdrop: `rgba(33, 150, 243, 0.1)`, // Backdrop azulado sutil
        didOpen: () => {
            const input = document.getElementById('swal-input-obs');
            if (input) {
                input.focus();
                // Coloca o cursor no final do texto (mesmo comportamento do seu c√≥digo original)
                input.setSelectionRange(input.value.length, input.value.length);
            }
        },
        preConfirm: () => {
            const obs = document.getElementById('swal-input-obs').value;
            const qtd = document.getElementById('swal-input-qtd').value;

            if (!obs || obs.trim().length < 5) {
                Swal.showValidationMessage('A descri√ß√£o deve ter pelo menos 5 caracteres');
                return false;
            }
            if (parseInt(qtd) < 1) {
                Swal.showValidationMessage('A quantidade m√≠nima √© 1');
                return false;
            }

            return { 
                qtd: parseInt(qtd), 
                obs: obs.trim().toUpperCase() 
            };
        }
    });

    // ‚úÖ PROCESSAMENTO FINAL: Envia para a l√≥gica de atualiza√ß√£o na mem√≥ria
    if (formValues) {
        executarEdicaoRelato(pendenciaId, uidString, formValues.qtd, formValues.obs);
    }
}
    
      function adaptarCautelaParaRender(cautelaData) {
    if (!cautelaData.itens || cautelaData.itens.length === 0) return [];

    const setorCautela = {
        id: cautelaData.cautela_id,
        nome: "ITENS PARA RECEBIMENTO",
        itens: cautelaData.itens.map(cItem => {
            
            // üõë AQUI EST√Å O SEGREDO: Captura as 4 unidades de qualquer lugar que elas estejam
            const qtdReal = Number(cItem.quantidade || cItem.quantidadeEsperada || 1);

            // Verifica se √© erro de cadastro (P√© de Cabra com tombamento = nome)
            const tombInvalido = (cItem.tombamento === cItem.nome || cItem.tombamento === "S/T" || !cItem.tombamento);
            let tipo = tombInvalido ? 'single' : 'multi';
            
            let tombamentos = null;
            if (tipo === 'multi') {
                tombamentos = [{
                    tomb: cItem.tombamento,
                    id_completo: `${cItem.id_base || cItem.id}-${cItem.tombamento}`,
                    cautela: { id: cautelaData.cautela_id, destinatario: cautelaData.destinatario || "N/D" }
                }];
            }

            return {
                id: cItem.id_base || cItem.id,
                nome: cItem.nome,
                quantidadeEsperada: qtdReal, // Define 4 unidades aqui!
                tipo: tipo,
                tombamentos: tombamentos,
                cautelas: [], // Esconde carimbo laranja
                situacao: "DISPON√çVEL"
            };
        })
    };
    return [setorCautela];
}
        
async function finalizarConferencia() {
    const btn = document.getElementById('btn-finalizar');
    if (btn.disabled && btn.textContent.includes("SALVANDO")) return;

    if (!LISTA_ID) {
        console.warn("Redirecionando fluxo: LISTA_ID ausente.");
        if (typeof finalizarRecebimentoDevolucao === 'function' && CAUTELA_ID) {
            return finalizarRecebimentoDevolucao(window._dadosCautelaOriginal || dadosConferencia[0]);
        }
        alert("Erro: Identificador da lista n√£o encontrado.");
        return;
    }
    
    const isChecklist = window.isModoChecklist || false;
    
    // ‚úÖ UX V3: Feedback visual imediato no bot√£o
    btn.innerHTML = `<i class="fas fa-sync fa-spin"></i> ${isChecklist ? "SALVANDO VISTORIA..." : "SALVANDO CONFER√äNCIA..."}`; 
    btn.disabled = true;
    btn.style.opacity = "0.7";

    try {
        const p = {
            uid: userInfo?.uid || "S_UID",
            postoGraduacao: userInfo?.postoGraduacao || "ND",
            quadro: userInfo?.quadro || "ND",
            nomeGuerra: userInfo?.nomeGuerra || "ND"
        };

        const militarInfoEl = document.getElementById('militar-info');
        const conferenteCompleto = militarInfoEl ? 
            militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim() : 
            `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
     
        const localNome = isChecklist ? `VISTORIA: ${infoLocal.nome}` : `${infoLocal.posto} - ${infoLocal.nome}`;
        const timestampAgora = firebase.firestore.Timestamp.now();
        const dataAtualLog = new Date().toLocaleString('pt-BR');
        
        const urlParams = new URLSearchParams(window.location.search);
        const unidadeId = urlParams.get('unidade_id') || userInfo?.unidadeId || "UNID-GERAL";
        const unidadeNome = urlParams.get('unidade_nome') || userInfo?.unidade || "GERAL";
        const kmEntrada = urlParams.get('km') || "0";
        const combustivelEntrada = urlParams.get('combustivel') || "N/D";
        const obsGeraisEl = document.getElementById('obs-geral-vistoria');
        const obsGeraisTexto = obsGeraisEl ? obsGeraisEl.value.trim() : "";

        let itensRelatorio = [];
        let itensCaa = []; 
        let totalCaa = 0;
        const fonteDeDados = window.dadosConferencia || dadosConferencia;

        // --- PROCESSAMENTO DA √ÅRVORE DE DADOS (Preserva√ß√£o Total) ---
        const novaListaMestra = fonteDeDados.map(setor => {
            return {
                ...setor,
                itens: setor.itens.map(item => {
                    const processarEntidade = (entidade, uid, nomeParaRelatorio) => {
                        const statusLocal = window.itemStatus[uid];
                        if (!entidade.pendencias_ids) entidade.pendencias_ids = [];
                        if (!entidade.historico_vida) entidade.historico_vida = [];

                        if (entidade.situacao === 'AVARIADO' && statusLocal?.status === 'ok') {
                            entidade.situacao = 'DISPON√çVEL';
                            delete entidade.id_cautela_origem;
                            delete entidade.motivo_avaria;
                        }

                        if (!statusLocal || statusLocal.status === 'pending') {
                            const qtdFix = entidade.quantidadeEsperada || entidade.quantidade || 1;
                            itensRelatorio.push({
                                id: String(uid || entidade.uid_global || ""), 
                                uid_global: String(item.uid_global || ""),
                                nomeCompleto: String(nomeParaRelatorio || ""), 
                                status: 'S/A',
                                situacao_patrimonial: entidade.situacao || 'DISPON√çVEL',
                                quantidade: qtdFix, 
                                setor: String(setor.nome || ""), 
                                obs: ""
                            });
                            return entidade;
                        }

                        // L√≥gica de Resolu√ß√£o de Pend√™ncias
                        if (statusLocal.ids_resolvidos) {
                            statusLocal.ids_resolvidos.forEach(res => {
                                const idx = entidade.pendencias_ids.findIndex(pnd => pnd.id === res.id);
                                if (idx > -1) {
                                    const pendenciaMorta = entidade.pendencias_ids[idx];
                                    entidade.historico_vida.push({
                                        evento: res.qtd_remanescente > 0 ? "SOLUCAO_PARCIAL" : "SOLUCAO_TOTAL",
                                        id_pendencia_origem: String(pendenciaMorta.id || ""), 
                                        quem: String(res.resolvido_por || ""),
                                        data: String(res.data_solucao || ""), 
                                        detalhes: `Resolvido ${res.qtd_resolvida}. Desc: ${pendenciaMorta.descricao}`
                                    });
                                    entidade.pendencias_ids.splice(idx, 1);
                                    if (res.qtd_remanescente > 0) {
                                        entidade.pendencias_ids.push({
                                            ...pendenciaMorta, 
                                            id: "PEND_" + Date.now() + "_RES",
                                            quantidade: res.qtd_remanescente, 
                                            descricao: pendenciaMorta.descricao + " (SALDO)",
                                            herdado_de: pendenciaMorta.id
                                        });
                                    }
                                }
                            });
                        }

                        // Convers√£o de TEMP para PEND (DNA Permanente)
                        entidade.pendencias_ids = entidade.pendencias_ids.map(p => {
                            if (p.id && String(p.id).startsWith('TEMP-')) {
                                const novoId = p.id.replace('TEMP-', 'PEND-');
                                entidade.historico_vida.push({
                                    evento: isChecklist ? "ALTERACAO_VISTORIA" : "NOVA_PENDENCIA", 
                                    id_pendencia: novoId, 
                                    quem: String(p.autor_nome || conferenteCompleto),
                                    data: String(p.data_criacao || dataAtualLog), 
                                    detalhes: `${p.quantidade}un - ${p.descricao || ""}`
                                });
                                return { ...p, id: novoId };
                            }
                            return p;
                        });

                        let pendenciasParaRelatorio = [...entidade.pendencias_ids];
                        
                        if (entidade.cautelas && Array.isArray(entidade.cautelas)) {
                            entidade.cautelas.forEach(c => {
                                pendenciasParaRelatorio.push({
                                    autor_nome: String(c.emitente || "SISTEMA"),
                                    data_criacao: String(c.data || ""),
                                    quantidade: c.quantidade || 0,
                                    descricao: `Cautelado para ${c.destinatario} (ID: ${c.id}).`,
                                    status_gestao: "CAUTELADO"
                                });
                            });
                        }

                        const temAlteracao = pendenciasParaRelatorio.length > 0 || entidade.situacao === 'AVARIADO' || statusLocal.status === 'cautela_ciente' || statusLocal.status === 'C/A';
                        const statusFinal = temAlteracao ? 'C/A' : 'S/A';
                        const quantidadeReal = entidade.quantidade || entidade.quantidadeEsperada || 1;

                        const dRel = {
                            id: String(uid || entidade.uid_global || ""), 
                            uid_global: String(item.uid_global || ""),
                            nomeCompleto: String(nomeParaRelatorio || ""), 
                            status: statusFinal,
                            situacao_patrimonial: entidade.situacao || 'DISPON√çVEL',
                            pendencias_ids: pendenciasParaRelatorio,
                            quantidade: quantidadeReal,
                            setor: String(setor.nome || ""), 
                            obs: pendenciasParaRelatorio.map(p => `${p.quantidade}un: ${p.descricao}`).join(' | ')
                        };

                        itensRelatorio.push(dRel);
                        if (temAlteracao) { itensCaa.push(dRel); totalCaa++; }
                        return entidade;
                    };

                    if (item.tipo === 'multi' && item.tombamentos) {
                        item.tombamentos = item.tombamentos.map(t => processarEntidade(t, `${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`));
                    } else {
                        item = processarEntidade(item, item.id, item.nome);
                    }
                    return item;
                })
            };
        });

        // ‚úÖ INICIO DO BATCH (OPERA√á√ÉO AT√îMICA)
        const batch = db.batch();
        
        const listaLimpaParaArquitetura = novaListaMestra.map(setor => ({
            ...setor,
            itens: setor.itens.map(item => {
                const i = { ...item };
                delete i.pendencias_ids; 
                delete i.historico_vida; 
                if (item.tombamentos) {
                    i.tombamentos = item.tombamentos.map(t => {
                        const tt = { ...t };
                        delete tt.pendencias_ids;
                        delete tt.historico_vida;
                        return tt;
                    });
                }
                return i;
            })
        }));

        const colecaoListaOrigem = isChecklist ? 'listas_checklist' : (typeof COLECAO_LISTAS !== 'undefined' ? COLECAO_LISTAS : 'listas_conferencia');
        const colecaoResultadosDestino = isChecklist ? 'resultados_checklist' : 'resultados_conferencias';

        batch.update(db.collection(colecaoListaOrigem).doc(LISTA_ID), { list: listaLimpaParaArquitetura });

        const resRef = db.collection(colecaoResultadosDestino).doc();
        batch.set(resRef, {
            local: String(localNome || ""),
            unidade: String(unidadeNome || ""),
            unidade_id: String(unidadeId || ""),
            lista_id: String(LISTA_ID || ""), 
            conferente_uid: String(p.uid || ""), 
            conferente: String(conferenteCompleto || ""),
            timestamp: timestampAgora, 
            totalItensConferidos: itensRelatorio.length,
            totalCaa: totalCaa, 
            itensCaa: itensCaa || [], 
            itensRelatorio: itensRelatorio || [],
            modo: isChecklist ? 'CHECKLIST_VISTORIA' : 'CONFERENCIA_PADRAO',
            km_entrada: String(kmEntrada || "0"),
            combustivel_entrada: String(combustivelEntrada || "N/D"),
            obs_gerais_vistoria: String(obsGeraisTexto || "")
        });

        // ‚úÖ ATUALIZA√á√ÉO DE SALDOS E INVENT√ÅRIO (SENS√çVEL)
        for (const itemAlterado of itensCaa) {
            const uidGlobal = itemAlterado.uid_global;
            if (!uidGlobal) continue;

            const itemRef = db.collection('inventario').doc(uidGlobal);
            const ehMulti = itemAlterado.id.includes('-') && itemAlterado.id !== uidGlobal;
            
            if (ehMulti) {
                const partesId = itemAlterado.id.split('-');
                const tombamentoAlvo = partesId[partesId.length - 1];
                const tombRef = itemRef.collection('tombamentos').doc(tombamentoAlvo);
                
                const novosLogs = (itemAlterado.pendencias_ids || [])
                    .filter(pend => pend.id && String(pend.id).startsWith('PEND-'))
                    .map(pend => ({
                        data: dataAtualLog,
                        evento: isChecklist ? "ALERTA_VISTORIA" : "ALERTA_CONFERENCIA",
                        quem: conferenteCompleto,
                        detalhes: `‚ö†Ô∏è Altera√ß√£o em ${localNome}: ${pend.descricao}`,
                        uid_pendencia: pend.id,
                        lista_origem_id: LISTA_ID 
                    }));

                novosLogs.forEach((log, idx) => {
                    batch.set(tombRef.collection('historico_vida').doc("EVT-P-" + Date.now() + idx), log);
                });
                batch.update(tombRef, { situacao_atual: "PENDENTE" });
            } else {
                const unidadeIdFinal = urlParams.get('unidade_id') || "UNID-GERAL";
                const saldoRef = itemRef.collection('saldos_unidades').doc(unidadeIdFinal);
                const novasPendencias = (itemAlterado.pendencias_ids || []).filter(pend => pend.id && String(pend.id).startsWith('PEND-'));
                
                if (novasPendencias.length > 0) {
                    const qtdPendenteTotal = novasPendencias.reduce((sum, pend) => sum + (Number(pend.quantidade) || 0), 0);
                    
                    // ‚úÖ INTELIG√äNCIA CIR√öRGICA V3: Blindagem de Saldo F√≠sico
                    if (!isChecklist) {
                        batch.update(saldoRef, {
                            qtd_disp: firebase.firestore.FieldValue.increment(-qtdPendenteTotal),
                            qtd_pend: firebase.firestore.FieldValue.increment(qtdPendenteTotal),
                            last_update: dataAtualLog
                        });
                    } else {
                        batch.update(saldoRef, {
                            qtd_pend: firebase.firestore.FieldValue.increment(qtdPendenteTotal),
                            last_update: dataAtualLog
                        });
                    }

                    novasPendencias.forEach((pend, idx) => {
                        batch.set(saldoRef.collection('historico_vida').doc("EVT-S-P-" + Date.now() + idx), {
                            data: dataAtualLog,
                            evento: "PENDENCIA_RELATADA",
                            quem: conferenteCompleto,
                            detalhes: `‚ö†Ô∏è Altera√ß√£o em ${localNome}: ${pend.descricao}`,
                            quantidade: pend.quantidade,
                            uid_pendencia: pend.id,
                            lista_origem_id: LISTA_ID, 
                            local_sigla: infoLocal.nome || "N/D" 
                        });
                    });
                }
            }
        }
        
        await batch.commit();
        
        // ‚úÖ UX V3: Sucesso com redirecionamento limpo
        alert(isChecklist ? "‚úÖ Vistoria Finalizada com Sucesso!" : "‚úÖ Confer√™ncia Finalizada com Sucesso!");
        window.top.location.href = "sigma_dashboard.html";

    } catch (e) {
        console.error("V3 Critical Error:", e);
        alert("‚ùå Erro fatal ao gravar dados: " + e.message);
        btn.disabled = false;
        btn.innerHTML = isChecklist ? "FINALIZAR VISTORIA" : "FINALIZAR CONFER√äNCIA";
    }
}
        async function finalizarRecebimentoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();
            if (cData.destinatario_original_uid !== meuUid) {
                throw new Error("Apenas o destinat√°rio original pode assinar este recebimento.");
            }

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensConferidos = [];
            
            let temQualquerAlteracao = false;
            let linhasExtrato = [];

            cautela.itens.forEach((cItem, index) => {
                const uidBusca = cItem.tombamento ? `${cItem.id_base || cItem.id}-${cItem.tombamento}` : (cItem.id_base || cItem.id);
                const statusLocal = window.itemStatus[uidBusca] || {};
                
                const isItemOk = (statusLocal.status === 'ok' || statusLocal.status === 'S/A');
                const statusFinal = isItemOk ? 'S/A' : 'C/A';
                const obsFinal = statusLocal.obs || "";
                
                if (statusFinal === 'C/A') temQualquerAlteracao = true;

                itensConferidos.push({
                    ...cItem,
                    status_recebimento: statusFinal,
                    obs_recebimento: obsFinal
                });

                const identificador = cItem.tombamento ? `(Tomb.: ${cItem.tombamento})` : `(QTD: ${cItem.quantidade}UN)`;
                const relatoItem = isItemOk ? 'S/A' : (obsFinal || 'C/A sem obs.');
                linhasExtrato.push(`${index + 1}. ${cItem.nome} ${identificador}: ${relatoItem}`);

                // --- ATUALIZA√á√ÉO DA LISTA MESTRA ---
                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            // Registro no hist√≥rico de vida do item
                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push({
                                evento: "CONFIRMA√á√ÉO_RECEBIMENTO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                detalhes: statusFinal === 'C/A' ? `Avaria: ${obsFinal}` : "Recebido S/A."
                            });

                            const objetoCautelaAtualizado = {
                                id: CAUTELA_ID,
                                emitente: cData.emitente || "N/D",
                                destinatario: meuNomeCompleto,
                                data: cData.timestamp_emissao ? cData.timestamp_emissao.toDate().toLocaleDateString('pt-BR') : dataAtual,
                                status_item: statusFinal,
                                obs_item: obsFinal,
                                quantidade: Number(cItem.quantidade) || 1
                            };

                            // üõë CORRE√á√ÉO PARA ITEM SINGLE: Atualiza o existente em vez de dar push
                            if (mItem.tipo === 'single' && mItem.cautelas) {
                                const idxExistente = mItem.cautelas.findIndex(c => c.id === CAUTELA_ID);
                                if (idxExistente !== -1) {
                                    // Se j√° existe (carimbo de emiss√£o), apenas atualizamos os dados
                                    mItem.cautelas[idxExistente] = objetoCautelaAtualizado;
                                } else {
                                    // Se por algum motivo n√£o existia, a√≠ sim adicionamos
                                    mItem.cautelas.push(objetoCautelaAtualizado);
                                }
                            } 
                            // PARA ITEM MULTI: A sobrescrita j√° √© segura por natureza
                            else if (mItem.tipo === 'multi' && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        t.cautela = objetoCautelaAtualizado;
                                    }
                                    return t;
                                });
                            }
                        }
                        return mItem;
                    })
                }));
            });

            const icone = temQualquerAlteracao ? '‚ö†Ô∏è' : '‚úÖ';
            const tituloLog = `${icone} Recebido ${temQualquerAlteracao ? 'C/A' : 'S/A'} pelo destinat√°rio: ${meuNomeCompleto}`;
            const descricaoCompleta = `${tituloLog}\n${linhasExtrato.join('\n')}`;

            const logMovimentacao = {
                data: dataAtual,
                descricao: descricaoCompleta,
                militar: meuNomeCompleto
            };

            transaction.update(cautelaRef, {
                status: 'RECEBIDA',
                timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
                itens: itensConferidos,
                militar_completo_receptor: meuNomeCompleto,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(logMovimentacao)
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Recebimento confirmado!`);
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (error) {
        console.error("Erro ao receber cautela:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO";
        btn.disabled = false;
    }
}
      async function finalizarDevolucaoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = 'Processando...';
    btn.disabled = true;

    try {
        // Pega as informa√ß√µes do militar logado (quem est√° devolvendo)
        const userInfo = await getLoggedUser(); 
        
        if (!userInfo) {
            alert("Erro: Dados do militar logado n√£o encontrados.");
            btn.textContent = 'ERRO AO FINALIZAR';
            btn.disabled = false;
            return;
        }

        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);

        // üõë CR√çTICO: Executa a Transa√ß√£o no Firebase üõë
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(cautelaRef);

            if (!doc.exists || doc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela n√£o encontrada ou n√£o est√° no status 'RECEBIDA'.");
            }
            
            // 1. A√ß√£o: Mudar o status da cautela para CONCLUIDA.
            transaction.update(cautelaRef, { 
                status: 'CONCLUIDA', // Status final
                timestamp_devolucao: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem est√° devolvendo (Militar Logado)
                reversor: userInfo.nomeGuerra, 
                militar_completo_reversor: `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`,
                
                // Quem est√° recebendo de volta (√öltimo Conferente)
                destinatario_final_devolucao: DESTINATARIO_DEVOLUCAO,
            });
            
            // 2. A√ß√£o: Registrar o hist√≥rico de confer√™ncia final (opcional, mas recomendado)
            // Se necess√°rio, voc√™ pode adicionar um novo documento na sua cole√ß√£o de hist√≥rico.
        }); // Fim da Transa√ß√£o

        alert(`‚úÖ Devolu√ß√£o da Cautela ${CAUTELA_ID} conclu√≠da e status atualizado para \"CONCLUIDA\".`);
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro CR√çTICO ao finalizar devolu√ß√£o:", error);
        alert(`Erro ao finalizar devolu√ß√£o. Nenhum dado foi alterado. Erro: ${error.message}`);
        btn.textContent = "ERRO AO FINALIZAR";
        btn.disabled = false;
    }
}
       async function finalizarRecebimentoDevolucao(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    // üõ°Ô∏è CAPTURA CIR√öRGICA DO ID DA LISTA
    const listaId = cautela.local_origem_id || urlParams.get('lista_origem');

    if (!CAUTELA_ID || !listaId) {
        console.error("IDs ausentes:", { CAUTELA_ID, listaId });
        alert("Erro Cr√≠tico: N√£o foi poss√≠vel identificar a lista de origem para reintegrar o material.");
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) { alert("Sess√£o expirada."); btn.disabled = false; return; }

    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");
            
            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra original n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensDevolvidos = [];

            // --- üõë CONSTRU√á√ÉO DO EXTRATO DETALHADO DE DEVOLU√á√ÉO üõë ---
            let temQualquerAlteracao = false;
            let linhasExtrato = [];

            cautela.itens.forEach((cItem, index) => {
                const uidBusca = cItem.tombamento ? `${cItem.id_base || cItem.id}-${cItem.tombamento}` : (cItem.id_base || cItem.id);
                const statusLocal = window.itemStatus[uidBusca];
                
                const statusFinal = statusLocal?.status === 'ok' ? 'S/A' : 'C/A';
                const obsFinal = statusLocal?.obs || "";

                if (statusFinal === 'C/A') temQualquerAlteracao = true;

                itensDevolvidos.push({
                    ...cItem, status_devolucao: statusFinal, obs_devolucao: obsFinal
                });

                // Monta a linha do extrato para o hist√≥rico
                const identificador = cItem.tombamento ? `(Tomb.: ${cItem.tombamento})` : `(QTD: ${cItem.quantidade}UN)`;
                const relatoItem = statusFinal === 'S/A' ? 'S/A' : (obsFinal || 'C/A sem obs.');
                linhasExtrato.push(`${index + 1}. ${cItem.nome} ${identificador}: ${relatoItem}`);

                // Reinclui o material no Estoque (Lista Mestra)
                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        if ((mItem.id_base || mItem.id) === (cItem.id_base || cItem.id)) {
                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push({
                                evento: "RETORNO_DEVOLUCAO", 
                                id_doc: CAUTELA_ID, 
                                quem: meuNomeCompleto,
                                data: dataAtual, 
                                estado_retorno: statusFinal, 
                                detalhes: statusFinal === 'C/A' ? `Retorno com avaria: ${obsFinal}` : "Retorno em perfeito estado (S/A)."
                            });

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) delete t.cautela;
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = mItem.cautelas.filter(c => c.id !== CAUTELA_ID);
                            }
                        }
                        return mItem;
                    })
                }));
            });

            // Finaliza o T√≠tulo e o Corpo do Log de Movimenta√ß√£o
            const icone = temQualquerAlteracao ? '‚ö†Ô∏è' : '‚úÖ';
            const tituloLog = `${icone} Devolu√ß√£o recebida ${temQualquerAlteracao ? 'C/A' : 'S/A'} pelo detentor: ${meuNomeCompleto}`;
            const descricaoCompleta = `${tituloLog}\n${linhasExtrato.join('\n')}`;

            const logMovimentacao = {
                data: dataAtual,
                descricao: descricaoCompleta,
                militar: meuNomeCompleto
            };

            transaction.update(cautelaRef, { 
                status: 'CONCLU√çDA', 
                timestamp_conclusao: firebase.firestore.FieldValue.serverTimestamp(),
                receptor_final_completo: meuNomeCompleto, 
                itens: itensDevolvidos,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(logMovimentacao)
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert("‚úÖ Devolu√ß√£o finalizada e estoque atualizado!");
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
    } catch (error) {
        console.error("Erro na transa√ß√£o:", error);
        alert(`Erro: ${error.message}`);
        btn.disabled = false;
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
    }
}
// --- NOVAS FUN√á√ïES DE CONTROLE DE IDS √öNICOS ---
// ‚úÖ Adicione este trecho ao in√≠cio da sua fun√ß√£o carregarDadosRemotos
function aplicarCoresV3(modo) {
    const root = document.documentElement;
    if (modo === 'checklist_vtr') {
        document.body.style.setProperty('background', 'linear-gradient(135deg, #2c3e50 0%, #000000 100%)', 'important');
    } else if (modo === 'recebimento_carga') {
        document.body.style.setProperty('background', 'linear-gradient(135deg, #1a1a1a 0%, #333333 100%)', 'important');
    }
}

   async function abrirFormNovoID(uid, tipo, nomeItem, saldo, tombReal = "") {
    // ‚úÖ IDENTIDADE VISUAL DIN√ÇMICA V3
    const isChecklist = window.isModoChecklist;
    const corPrimaria = isChecklist ? "#2c3e50" : "#800020"; 
    const nomeLimpo = nomeItem.replace(/\\'/g, "'");
    const saldoReal = parseInt(saldo) || 0;

    // Valida√ß√£o de saldo inicial para itens que n√£o s√£o tombados
    if (tipo !== 'multi' && saldoReal <= 0) {
        return Swal.fire({
            icon: 'error',
            title: 'Saldo Insuficiente',
            text: 'Este item n√£o possui saldo dispon√≠vel para relatar nova altera√ß√£o.',
            confirmButtonColor: corPrimaria
        });
    }

    // ‚úÖ DISPARO DO MODAL ELEGANTE (Swal)
    const { value: formValues } = await Swal.fire({
        title: `<span style="color: ${corPrimaria}; font-size: 0.9em; font-weight: bold;">${nomeLimpo}</span>`,
        html: `
            <div style="text-align: left; font-family: sans-serif;">
                ${tipo === 'multi' 
                    ? `<p style="margin-bottom: 15px; font-size: 0.9em;">Refer√™ncia Tomb.: <b style="color: #d90f23;">${tombReal}</b></p>` 
                    : `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Quantidade Alterada (Dispon√≠vel: ${saldoReal}):</label>
                        <input id="swal-input-qtd" type="number" class="swal2-input" value="1" min="1" max="${saldoReal}" style="width: 100%; margin: 5px 0 0 0; height: 40px;">
                    </div>`
                }
                <label style="display: block; font-weight: bold; font-size: 0.85em; color: #666;">Descri√ß√£o do Problema:</label>
                <textarea id="swal-input-obs" class="swal2-textarea" placeholder="Descreva o problema detalhadamente..." style="width: 100%; margin: 5px 0 0 0; min-height: 100px; text-transform: uppercase; font-size: 0.9em;"></textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'INCLUIR ALTERA√á√ÉO',
        cancelButtonText: 'CANCELAR',
        confirmButtonColor: corPrimaria,
        reverseButtons: true,
        backdrop: `rgba(15, 23, 42, 0.4)`, // Backdrop suave V3
        didOpen: () => {
            // Foco autom√°tico no campo de observa√ß√£o ao abrir
            const input = document.getElementById('swal-input-obs');
            if (input) input.focus();
        },
        preConfirm: () => {
            const obs = document.getElementById('swal-input-obs').value;
            const qtd = tipo === 'multi' ? 1 : document.getElementById('swal-input-qtd').value;

            // Valida√ß√µes internas do modal
            if (!obs || obs.trim().length < 5) {
                Swal.showValidationMessage('Por favor, descreva o problema (m√≠nimo 5 caracteres)');
                return false;
            }
            if (tipo !== 'multi' && (parseInt(qtd) > saldoReal || parseInt(qtd) < 1)) {
                Swal.showValidationMessage(`Quantidade inv√°lida (M√°x: ${saldoReal})`);
                return false;
            }

            return { qtd: parseInt(qtd), obs: obs.trim().toUpperCase() };
        }
    });

    // ‚úÖ PROCESSAMENTO FINAL
    if (formValues) {
        // Envia para a fun√ß√£o de salvamento que j√° existe no seu c√≥digo
        salvarNovoID(uid, formValues.qtd, tipo, formValues.obs);
    }
}
// ‚úÖ AJUSTE V3: Fechamento de Modal Din√¢mico
function fecharModalPendencia() {
    // 1. Se estiver usando o sistema global do SIGMA:
    // sigmaModal.close(); 

    // 2. Se estiver usando a abordagem din√¢mica pura:
    const modal = document.getElementById('modal-nova-pendencia');
    if (modal) {
        modal.classList.add('v3-modal-out'); // Anima√ß√£o de sa√≠da
        setTimeout(() => {
            modal.style.display = 'none'; // Ou modal.remove() se for 100% din√¢mico
            // Limpa o scroll da p√°gina (caso tenha sido travado)
            document.body.style.overflow = 'auto';
        }, 300);
    }
}

function abrirModalResolver(pendenciaId, uid, qtdOriginal, descricaoOriginal) {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');
    const tituloItem = document.getElementById('modal-titulo-item');
    const subtituloDet = document.getElementById('modal-subtitulo-detalhe');
    const infoMax = document.getElementById('modal-info-max');
    const modalContent = document.querySelector('.modal-content');
    
    if (!modal) return console.error("Modal n√£o encontrado no DOM");

    // ‚úÖ AJUSTE V3: Identidade Visual de Sucesso
    const isChecklist = window.isModoChecklist;
    const corModo = isChecklist ? "#2c3e50" : "#800020"; // Cor do sistema (Azul/Bord√¥)
    const corSucesso = "#1b8a3e"; // Verde padr√£o para resolu√ß√µes

    // 1. Configura√ß√£o de Identidade para RESOLU√á√ÉO
    document.getElementById('modal-acao-objetivo').value = "resolver";
    document.getElementById('modal-uid').value = String(uid);
    document.getElementById('modal-tipo').value = pendenciaId; 

    // 2. Ajuste de Textos e Alinhamento V3
    if (tituloItem) {
        tituloItem.innerText = "Resolver Altera√ß√£o";
        tituloItem.style.color = corModo; // Mant√©m a cor do sistema no t√≠tulo
        tituloItem.style.textAlign = "left";
    }
    if (subtituloDet) {
        subtituloDet.style.textAlign = "left";
        subtituloDet.innerHTML = `Relato original: <b style="color: #333;">"${descricaoOriginal}"</b>`;
    }

    document.getElementById('modal-label-obs').innerText = "Justificativa da Resolu√ß√£o:";
    document.getElementById('modal-label-qtd').innerText = "Unidades Resolvidas:";
    inputObs.placeholder = "Descreva como o problema foi sanado...";
    inputObs.value = '';

    // 3. Ajuste de Quantidade (Trava no valor original)
    const grupoQtd = document.getElementById('modal-grupo-qtd');
    if (grupoQtd) {
        grupoQtd.style.setProperty('display', 'block', 'important');
    }
    
    inputQtd.max = qtdOriginal;
    inputQtd.value = qtdOriginal;
    
    if (infoMax) {
        infoMax.style.textAlign = "left";
        infoMax.style.color = "#666";
        infoMax.innerText = `Quantidade pendente no sistema: ${qtdOriginal} un.`;
    }

    // 4. Est√©tica V3 (Borda superior e Bot√£o em Verde)
    btnConfirmar.innerText = "CONFIRMAR SOLU√á√ÉO";
    btnConfirmar.style.backgroundColor = corSucesso; 
    if (modalContent) {
        modalContent.style.borderTop = `8px solid ${corSucesso}`;
    }

    // 5. Exibi√ß√£o e Foco com Scroll Mobile
    modal.style.zIndex = "99999";
    modal.style.display = 'flex';
    
    // ‚úÖ UX MOBILE: Centraliza√ß√£o de campo para teclado
    setTimeout(() => { 
        if (inputObs) {
            inputObs.focus();
            const yOffset = -100; 
            const y = inputObs.getBoundingClientRect().top + window.pageYOffset + yOffset;
            window.scrollTo({top: y, behavior: 'smooth'});
        }
    }, 300);
}
    
function processarAcaoFinalModal() {
    // 1. CAPTURA DE DADOS
    const objetivo = document.getElementById('modal-acao-objetivo').value;
    const uid = document.getElementById('modal-uid').value; // Refer√™ncia do Item/Tombamento
    const qtdInput = document.getElementById('modal-input-qtd');
    const obs = document.getElementById('modal-input-obs').value;
    const tipoOuPendenciaId = document.getElementById('modal-tipo').value; 

    // 2. VALIDA√á√ÉO DE CONTE√öDO (UX V3)
    if (obs.trim().length < 5) {
        // Alerta visual no pr√≥prio campo antes do alert do navegador
        document.getElementById('modal-input-obs').style.borderColor = "#d90f23";
        return alert("‚ö†Ô∏è Detalhamento insuficiente! Por favor, descreva a situa√ß√£o com pelo menos 5 caracteres.");
    }

    // 3. NORMALIZA√á√ÉO E SEGURAN√áA
    const qtdNumerica = parseInt(qtdInput.value) || 1;
    const uidString = String(uid);
    const refIdString = String(tipoOuPendenciaId);

    // Valida√ß√£o de limite de quantidade (evita erros de digita√ß√£o)
    if (qtdInput.max && qtdNumerica > parseInt(qtdInput.max)) {
        return alert(`‚ö†Ô∏è Erro de Quantidade! O valor m√°ximo permitido para este item √© ${qtdInput.max}.`);
    }

    // 4. ORQUESTRA√á√ÉO LOG√çSTICA
    try {
        if (objetivo === "editar") {
            executarEdicaoRelato(refIdString, uidString, qtdNumerica, obs);
        } 
        else if (objetivo === "resolver") {
            resolverID(refIdString, uidString, qtdNumerica, obs);
        } 
        else {
            salvarNovoID(uidString, qtdNumerica, refIdString, obs);
        }

        // ‚úÖ FEEDBACK V3: Efeito visual de sucesso no elemento que originou a a√ß√£o
        const elAlvo = document.querySelector(`[data-id="${uidString}"]`);
        if (elAlvo) {
            elAlvo.style.transition = "all 0.5s ease";
            elAlvo.style.boxShadow = "0 0 15px rgba(27, 138, 62, 0.4)";
            setTimeout(() => elAlvo.style.boxShadow = "none", 1500);
        }

        // 5. FECHAMENTO E LIMPEZA
        fecharModalPendencia();
        
    } catch (error) {
        console.error("Erro ao processar a√ß√£o do modal:", error);
        alert("‚ùå Ocorreu um erro ao salvar esta altera√ß√£o. Verifique o console.");
    }
}
    function executarEdicaoRelato(pendenciaId, uid, novaQtd, novaObs) {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    let editado = false;

    const idProcurado = String(pendenciaId);
    const uidAlvo = String(uid);

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            // ‚úÖ AJUSTE V3: Busca inteligente em itens simples ou grupos de tombamento
            let alvosParaVerificar = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            
            alvosParaVerificar.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    const p = alvo.pendencias_ids.find(pend => String(pend.id) === idProcurado);
                    
                    if (p) {
                        p.descricao = novaObs.trim().toUpperCase(); // Padroniza√ß√£o SIGMA
                        p.quantidade = parseInt(novaQtd) || 0;
                        editado = true;
                        
                        // ‚úÖ SINCRONISMO: Mant√©m o status global atualizado para o relat√≥rio final
                        if (window.itemStatus[uidAlvo]) {
                            window.itemStatus[uidAlvo].obs = p.descricao;
                            window.itemStatus[uidAlvo].quantidade = p.quantidade;
                            window.itemStatus[uidAlvo].interacao_humana = true;
                        }
                    }
                }
            });
        });
    });

    if (editado) {
        // Redesenha a interface para mostrar os novos textos nos cards
        renderizarConferencia(); 
        
        // ‚úÖ UX V3: Feedback de localiza√ß√£o p√≥s-edi√ß√£o
        setTimeout(() => {
            const el = document.getElementById(`card-${idProcurado}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.transition = "all 0.5s ease";
                el.style.backgroundColor = "#e3f2fd"; // Azul claro de edi√ß√£o
                el.style.borderLeftWidth = "10px";    // Destaque lateral tempor√°rio
                
                setTimeout(() => { 
                    el.style.backgroundColor = "#fff"; 
                    el.style.borderLeftWidth = "1px"; // Retorna ao padr√£o do card
                }, 1200);
            }
        }, 300);
    } else {
        console.error("V3 Error: Pend√™ncia " + idProcurado + " n√£o encontrada na √°rvore de dados.");
        alert("‚ùå Erro ao salvar: O registro original sumiu da mem√≥ria. Reinicie a confer√™ncia.");
    }
}
async function confirmarExclusaoRelato(pendenciaId, uid) {
    // ‚úÖ UX V3: Confirma√ß√£o Destrutiva com SweetAlert2
    const result = await Swal.fire({
        title: 'Apagar Altera√ß√£o?',
        text: "Esta a√ß√£o remover√° o relato tempor√°rio e n√£o poder√° ser desfeita.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33', // Vermelho Alerta
        cancelButtonColor: '#3085d6',
        confirmButtonText: '<i class="fas fa-trash-alt"></i> SIM, APAGAR',
        cancelButtonText: 'CANCELAR',
        reverseButtons: true
    });

    if (!result.isConfirmed) return;

    const fonteDados = window.dadosConferencia || dadosConferencia;
    let excluido = false;
    const idProcurado = String(pendenciaId);
    const uidAlvo = String(uid);

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            let alvos = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            
            alvos.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    const index = alvo.pendencias_ids.findIndex(p => String(p.id) === idProcurado);
                    
                    if (index > -1) {
                        alvo.pendencias_ids.splice(index, 1);
                        excluido = true;
                        
                        // ‚úÖ L√ìGICA DE LIMPEZA CIR√öRGICA V3:
                        // Se era a √∫ltima pend√™ncia, removemos o estado de intera√ß√£o para obrigar nova confer√™ncia
                        if (alvo.pendencias_ids.length === 0) {
                            delete window.itemStatus[uidAlvo]; 
                            
                            const elItem = document.querySelector(`[data-id="${uidAlvo}"]`);
                            if (elItem) {
                                elItem.classList.remove('status-alert', 'status-ok');
                                // Reset sutil de anima√ß√£o
                                elItem.style.transition = "all 0.3s";
                                elItem.style.transform = "scale(0.98)";
                                setTimeout(() => elItem.style.transform = "scale(1)", 300);
                            }
                        }
                    }
                }
            });
        });
    });

    if (excluido) {
        // ‚úÖ FEEDBACK V3: Notifica√ß√£o Toast (n√£o intrusiva)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });
        
        Toast.fire({
            icon: 'success',
            title: 'Relato removido com sucesso'
        });

        renderizarConferencia(); 
        updateOverallStatus();
    } else {
        console.error("V3 Error: ID n√£o localizado para exclus√£o:", idProcurado);
        Swal.fire('Erro', 'N√£o foi poss√≠vel localizar este registro na mem√≥ria.', 'error');
    }
}
    
function salvarNovoID(uid, qtd, tipo, obsModal = null) {
    const obsDigitada = obsModal ? obsModal.trim().toUpperCase() : "";
    const qtdInformada = parseInt(qtd) || 1;

    // 1. CAPTURA DE ASSINATURA SEGURA (Padr√£o V3)
    const militarInfoEl = document.getElementById('militar-info');
    let nomeAssinatura = militarInfoEl ? militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim() : "";
    
    if (!nomeAssinatura) {
        nomeAssinatura = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    }

    // 2. CRIA√á√ÉO DO OBJETO DE PEND√äNCIA COM DNA TEMPOR√ÅRIO
    const novoID = {
        id: "TEMP-" + Date.now(), 
        tipo: "PENDENCIA",
        data_criacao: new Date().toLocaleDateString('pt-BR'),
        autor_uid: String(userInfo.uid || "S_UID"),
        autor_nome: nomeAssinatura,
        descricao: obsDigitada,
        quantidade: qtdInformada,
        status_gestao: "PENDENTE"
    };

    let itemEncontrado = false;
    let elementoPaiAlvo = null;
    const fonteDados = window.dadosConferencia || dadosConferencia;

    // 3. BUSCA EM PROFUNDIDADE (Orientada a Invent√°rio)
    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            const idParaComparar = String(uid);
            // Verifica match tanto pelo uid_global quanto pelo id local
            const matchesID = (String(item.uid_global) === idParaComparar || String(item.id) === idParaComparar);

            if (tipo === 'single' && matchesID) {
                if (!item.pendencias_ids) item.pendencias_ids = [];
                item.pendencias_ids.push(novoID);
                itemEncontrado = true;
            } 
            else if (tipo === 'multi' && item.tombamentos) {
                item.tombamentos.forEach(t => {
                    const uidCompostoGlobal = `${item.uid_global || item.id}-${t.tomb}`;
                    const uidCompostoLocal = `${item.id}-${t.tomb}`;
                    
                    if (idParaComparar === uidCompostoGlobal || idParaComparar === uidCompostoLocal) {
                        if (!t.pendencias_ids) t.pendencias_ids = [];
                        t.pendencias_ids.push(novoID);
                        itemEncontrado = true;
                        // Armazena refer√™ncia para update visual do status icon
                        elementoPaiAlvo = document.querySelector(`[data-id="${item.uid_global || item.id}"]`);
                    }
                });
            }
        });
    });

    if (itemEncontrado) {
        // 4. ATUALIZA√á√ÉO DO ESTADO DE INTERA√á√ÉO (DNA V3)
        const uidStr = String(uid);
        // Captura o tronco do UID para garantir v√≠nculo no banco (FAM-00000X)
        const uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0,4).join('-') : uidStr.split('-')[0];

        window.itemStatus[uid] = { 
            status: 'C/A', 
            interacao_humana: true,
            obs: obsDigitada,
            quantidade: qtdInformada,
            uid_global_ref: uidGlobalFull
        };
        
        // 5. REFRESH DA INTERFACE
        renderizarConferencia();
        
        if (elementoPaiAlvo) {
            updateItemMainStatusDisplay(elementoPaiAlvo);
        }

        // 6. FEEDBACK VISUAL (Efeito Spotlight V3)
        setTimeout(() => {
            let el = document.querySelector(`[data-id="${uid}"]`) || 
                     document.querySelector(`.tombamento-container[data-id="${uid}"]`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.transition = "all 0.6s ease";
                el.style.backgroundColor = "#fff9c4"; // Amarelo Aten√ß√£o tempor√°rio
                el.style.boxShadow = "0 0 20px rgba(217, 15, 35, 0.2)";
                
                setTimeout(() => { 
                    el.style.backgroundColor = ""; 
                    el.style.boxShadow = ""; 
                }, 2000);
            }
        }, 350);
    } else {
        console.error("V3 Error: Falha cr√≠tica de v√≠nculo.", { uid_enviado: uid, tipo: tipo });
        alert("‚ùå Erro t√©cnico: O SIGMA n√£o conseguiu vincular esta altera√ß√£o. Tente recarregar a lista.");
    }
}
function manterID(pendenciaId, uid) {
    // 1. GARANTE A EXIST√äNCIA DO OBJETO E DNA DO ITEM
    if (!window.itemStatus[uid]) {
        window.itemStatus[uid] = { 
            status: 'C/A', 
            ids_mantidos: [], 
            interacao_humana: true 
        };
    }
    
    if (!window.itemStatus[uid].ids_mantidos) {
        window.itemStatus[uid].ids_mantidos = [];
    }
    
    // 2. REGISTRO DO ID MANTIDO (DNA SEGURO)
    const idStr = String(pendenciaId);
    if (!window.itemStatus[uid].ids_mantidos.includes(idStr)) {
        window.itemStatus[uid].ids_mantidos.push(idStr);
    }
    
    // 3. ATUALIZA√á√ÉO DO ESTADO GLOBAL DO ITEM
    window.itemStatus[uid].status = 'C/A';
    window.itemStatus[uid].interacao_humana = true;

    // ‚úÖ AJUSTE CIR√öRGICO V3: V√çNCULO COM O UID GLOBAL COMPLETO
    // Garante que o Invent√°rio saiba exatamente qual documento atualizar
    if (!window.itemStatus[uid].uid_global_ref) {
        const uidStr = String(uid);
        const uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0, 4).join('-') : uidStr.split('-')[0];
        window.itemStatus[uid].uid_global_ref = uidGlobalFull;
    }

    // 4. ATUALIZA√á√ÉO DA INTERFACE VISUAL (REFRESH V3)
    renderizarConferencia();
    updateOverallStatus();
    
    // 5. FEEDBACK T√ÅTIL E VISUAL (Efeito Confirma√ß√£o)
    setTimeout(() => {
        const el = document.getElementById(`card-${idStr}`);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // ‚úÖ UX V3: Transi√ß√£o de cor e brilho para indicar revalida√ß√£o
            el.style.transition = "all 0.6s ease";
            el.style.backgroundColor = "#e8f5e9"; // Verde suave de sucesso
            el.style.borderLeftColor = "#1b8a3e"; // For√ßa a borda verde no carimbo
            el.style.transform = "scale(1.02)";    // Pequeno "pop" visual
            
            setTimeout(() => { 
                el.style.backgroundColor = "#fff"; 
                el.style.transform = "scale(1)";
            }, 1200);
        }
    }, 150);
}

function resolverID(pendenciaId, uid, qtdResolvidaModal, justificativaModal) {
    const qtdResolvida = parseInt(qtdResolvidaModal) || 1;
    const justificativa = justificativaModal ? justificativaModal.trim().toUpperCase() : ""; // Padroniza√ß√£o V3
    const nomeResolutor = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const fonteDados = window.dadosConferencia || dadosConferencia;
    let acaoConcluida = false;
    let pendenciasRestantes = 0;

    const isResolvendoAvaria = String(pendenciaId).startsWith('AVARIA-');

    // --- L√ìGICA DE BAIXA NO OBJETO (N√öCLEO DO SISTEMA) ---
    function executarBaixaNoObjeto(obj) {
        if (isResolvendoAvaria) {
            if (!obj.historico_vida) obj.historico_vida = [];
            obj.historico_vida.push({
                evento: "RESOLU√á√ÉO_AVARIA_CAUTELA",
                data: new Date().toLocaleString('pt-BR'),
                quem: nomeResolutor,
                detalhes: `AVARIA RESOLVIDA. JUSTIFICATIVA: ${justificativa}`,
                cautela_origem: pendenciaId.replace('AVARIA-', '')
            });
            obj.situacao = "DISPON√çVEL"; 
            obj.status = "OK";
            delete obj.id_cautela_origem;
            delete obj.motivo_avaria;
            return true;
        }

        if (!obj.pendencias_ids) return false;
        const idProcurado = String(pendenciaId);
        const index = obj.pendencias_ids.findIndex(p => String(p.id) === idProcurado);
        
        if (index === -1) return false;

        const pOriginal = obj.pendencias_ids[index];
        if (!obj.historico_vida) obj.historico_vida = [];
        
        const registroHistorico = {
            id_referencia: pOriginal.id,
            evento: qtdResolvida >= pOriginal.quantity ? "SOLUCAO_TOTAL" : "SOLUCAO_PARCIAL",
            quantidade: qtdResolvida,
            data: new Date().toLocaleString('pt-BR'),
            quem: nomeResolutor,
            detalhes: `RESOLVIDO VIA CONFER√äNCIA. JUSTIFICATIVA: ${justificativa}. (REF: ${pOriginal.descricao})`
        };

        if (qtdResolvida >= pOriginal.quantidade) {
            obj.pendencias_ids.splice(index, 1);
        } else {
            pOriginal.quantidade -= qtdResolvida;
        }

        obj.historico_vida.push(registroHistorico);
        pendenciasRestantes = obj.pendencias_ids.length;
        return true;
    }

    // --- BUSCA E APLICA√á√ÉO ---
    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            const matchesSingle = String(item.id) === String(uid) || String(item.uid_global) === String(uid);
            
            if (matchesSingle) {
                acaoConcluida = executarBaixaNoObjeto(item);
            } else if (item.tombamentos) {
                item.tombamentos.forEach(t => {
                    const uidCompostoGlobal = `${item.uid_global || item.id}-${t.tomb}`;
                    const uidCompostoLocal = `${item.id}-${t.tomb}`;
                    if (String(uid) === uidCompostoGlobal || String(uid) === uidCompostoLocal) {
                        acaoConcluida = executarBaixaNoObjeto(t);
                    }
                });
            }
        });
    });

    if (acaoConcluida) {
        // 4. ATUALIZA√á√ÉO DO ESTADO DE INTERA√á√ÉO (DNA V3)
        if (!window.itemStatus[uid]) window.itemStatus[uid] = {};
        
        const uidStr = String(uid);
        const uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0, 4).join('-') : uidStr.split('-')[0];
        
        // Se n√£o restam pend√™ncias, o status vira 'ok', sen√£o permanece 'C/A'
        window.itemStatus[uid].status = (pendenciasRestantes > 0) ? 'C/A' : 'ok';
        window.itemStatus[uid].interacao_humana = true;
        window.itemStatus[uid].uid_global_ref = uidGlobalFull;
        
        // Limpa o ID da lista de mantidos caso ele estivesse l√°
        if (window.itemStatus[uid].ids_mantidos) {
            window.itemStatus[uid].ids_mantidos = window.itemStatus[uid].ids_mantidos.filter(id => String(id) !== String(pendenciaId));
        }

        // 5. ATUALIZA√á√ÉO DA UI
        renderizarConferencia();
        updateOverallStatus();

        // 6. FEEDBACK VISUAL DE SUCESSO (V3 GLOW)
        setTimeout(() => {
            let elItem = document.querySelector(`[data-id="${uid}"]`) || 
                         document.querySelector(`.tombamento-container[data-id="${uid}"]`);
            if (elItem) {
                elItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                elItem.style.transition = "all 0.5s cubic-bezier(0.4, 0, 0.2, 1)";
                elItem.style.backgroundColor = "#e8f5e9"; // Verde Sucesso
                elItem.style.boxShadow = "0 0 15px rgba(27, 138, 62, 0.5)";
                
                setTimeout(() => { 
                    elItem.style.backgroundColor = ""; 
                    elItem.style.boxShadow = "";
                }, 1500);
            }
        }, 300);
    } else {
        alert("‚ùå Erro: N√£o foi poss√≠vel localizar a pend√™ncia para aplicar a solu√ß√£o.");
    }
}
    function setItemStatusID(btn, status, uid) {
    const container = btn.closest('.tombamento-container') || btn.closest('.item-conferencia');
    const setor = btn.closest('.setor');
    const itemPai = btn.closest('.item-conferencia');

    if (!window.itemStatus[uid]) window.itemStatus[uid] = {};

    // ‚úÖ L√ìGICA DE EXTRA√á√ÉO DO UID GLOBAL COMPLETO (DNA DO ITEM)
    const uidStr = String(uid);
    const uidGlobalFull = uidStr.includes('FAM-') ? uidStr.split('-').slice(0, 4).join('-') : uidStr.split('-')[0];

    // Identifica o modo para aplicar a cor institucional correta via JS
    const isChecklist = window.isModoChecklist;
    const corV3 = isChecklist ? '#2c3e50' : '#800020'; // Azul Petr√≥leo ou Bord√¥

    if (status === 'ok') {
        // üõë MARCA√á√ÉO CIR√öRGICA: Registra intera√ß√£o e DNA
        window.itemStatus[uid] = { 
            ...window.itemStatus[uid], 
            status: 'ok', 
            interacao_humana: true,
            uid_global_ref: uidGlobalFull 
        };

        // UI: Reseta bot√µes e ativa o selecionado
        container.querySelectorAll('.action-button').forEach(b => {
            b.classList.remove('active');
            b.style.backgroundColor = ''; // Limpa cores manuais anteriores
        });
        
        btn.classList.add('active');
        btn.style.backgroundColor = '#1b8a3e'; // Verde Sucesso sempre para o S/A

        if (itemPai) {
            if (itemPai.classList.contains('item-has-tombamentos')) {
                updateItemMainStatusDisplay(itemPai);
            } else {
                itemPai.classList.remove('status-alert');
                itemPai.classList.add('status-ok');
                const icon = itemPai.querySelector('.status-icon');
                if (icon) {
                    icon.className = 'status-icon ok';
                    icon.style.backgroundColor = corV3; // Cor do modo no √≠cone
                }
            }
        }

        // ‚úÖ UX V3: Auto-Scroll suave para o pr√≥ximo elemento
        const proximoAlvo = container.nextElementSibling || (itemPai ? itemPai.nextElementSibling : null);
        if (proximoAlvo) {
            setTimeout(() => {
                proximoAlvo.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

    } else if (status === 'cautela_ciente') {
        window.itemStatus[uid] = { 
            ...window.itemStatus[uid], 
            status: 'cautela_ciente', 
            cautela_confirmada: true, 
            interacao_humana: true,
            uid_global_ref: uidGlobalFull
        };

        btn.innerHTML = '<i class="fas fa-check-double"></i> Ciente registrado';
        btn.disabled = true;
        btn.style.backgroundColor = "#1b8a3e";
        btn.style.opacity = "0.8";
        
        setTimeout(() => {
            renderizarConferencia();
            updateOverallStatus();
        }, 400);
    }

    updateOverallStatus();
    if (setor) updateSetorStatus(setor);

    if (setor && typeof checkSetorCompletion === 'function') { 
        checkSetorCompletion(setor, uid);
    }
}
    async function verExtratoCautela(cautelaId) {
    if (!cautelaId) return;
    try {
        const doc = await db.collection('cautelas_abertas').doc(cautelaId).get();
        if (!doc.exists) return alert("Cautela n√£o encontrada.");

        const data = doc.data();
        
        const html = `
            <div id="extrato-wrapper" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 29999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                <div style="position: relative; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 15px; z-index: 30000; width: 85%; max-width: 320px; border-top: 4px solid #f57c00; font-family: Arial, sans-serif;" onclick="event.stopPropagation()">
                    <h4 style="margin:0 0 10px 0; color:#800020; font-size:1em; border-bottom:1px solid #eee; padding-bottom:5px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-eye"></i> Detalhes da Cautela
                    </h4>
                    <p style="font-size:0.85em; margin:8px 0; color: #333;"><b>Emitente:</b><br>${data.emitente}</p>
                    
                    <p style="font-size:0.85em; margin:12px 0; color: #333; display: flex; align-items: center; gap: 8px;">
                        <b>Status:</b> 
                        <span style="background: #f57c00; color: white; padding: 3px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85em; text-transform: uppercase;">
                            ${data.status}
                        </span>
                    </p>

                    <p style="font-size:0.85em; margin:10px 0 5px 0; color: #333;"><b>Observa√ß√£o:</b></p>
                    <div style="font-size:0.8em; background:#f9f9f9; padding:8px; border-radius:4px; font-style:italic; color:#555; max-height:100px; overflow-y:auto; border: 1px solid #eee; line-height: 1.4;">
                        ${data.observacoes_emissao || 'Sem observa√ß√µes.'}
                    </div>
                    <button onclick="document.getElementById('extrato-wrapper').remove()" style="width:100%; margin-top:15px; padding:10px; background:#800020; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; text-transform: uppercase; font-size: 0.8em;">Fechar</button>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } catch (e) { console.error(e); }
}
async function finalizarRecebimentoCarga(transferenciaData) {
    const btn = document.getElementById('btn-finalizar');
    const originalText = btn.textContent;
    btn.textContent = "PROCESSANDO RECEBIMENTO...";
    btn.disabled = true;

    // ‚úÖ CIR√öRGICO: Garante a captura do ID da Guia (vinda do banco ou da URL)
    const urlParams = new URLSearchParams(window.location.search);
    const transferenciaId = transferenciaData.id || transferenciaData.transferencia_id || urlParams.get('transferenciaId');
    
    const unidadeDestinoId = transferenciaData.destino_id;
    const siglaDestino = transferenciaData.destino_sigla;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');

    if (!transferenciaId) {
        alert("Erro: ID da transfer√™ncia n√£o localizado.");
        btn.disabled = false;
        btn.textContent = "CONFIRMAR RECEBIMENTO";
        return;
    }

    try {
        const batch = db.batch();
        const transRef = db.collection('transferencias_pendentes').doc(transferenciaId);

        // 1. PROCESSAMENTO DOS ITENS NO INVENT√ÅRIO
        for (const item of transferenciaData.itens) {
            const uidGlobal = item.id_base || item.id;
            const uidBusca = item.tombamento ? `${uidGlobal}-${item.tombamento}` : uidGlobal;
            
            const statusLocal = window.itemStatus[uidBusca] || { status: 'ok' };
            const itemRef = db.collection('inventario').doc(uidGlobal);

            if (item.tombamento) {
                // ‚úÖ L√ìGICA MULTI: Atualiza o Prontu√°rio (Tombamento)
                const tombRef = itemRef.collection('tombamentos').doc(item.tombamento);
                
                batch.update(tombRef, {
                    situacao_atual: statusLocal.status === 'ok' ? "DISPON√çVEL" : "PENDENTE",
                    local_id: unidadeDestinoId,
                    unidade_sigla: siglaDestino,
                    sub_local: "ALMOXARIFADO SETORIAL",
                    recebido_por: meuNomeCompleto,
                    data_recebimento: dataAtual,
                    unidade_destino_id: firebase.firestore.FieldValue.delete(), 
                    unidade_destino_sigla: firebase.firestore.FieldValue.delete()
                });

                const idEvt = "REC-" + Date.now();
                batch.set(tombRef.collection('historico_vida').doc(idEvt), {
                    data: dataAtual,
                    evento: "RECEBIMENTO_CARGA",
                    quem: meuNomeCompleto,
                    detalhes: statusLocal.status === 'ok' 
                        ? `Material recebido e conferido S/A na unidade ${siglaDestino}.` 
                        : `Material recebido com ALTERA√á√ÉO: ${statusLocal.obs || 'N√£o descrita'}.`
                });

            } else {
                // ‚úÖ L√ìGICA SINGLE: Blindagem de quantidade e cria√ß√£o de saldo
                const qtdRecebida = Number(item.quantidade) || 0;
                const saldoRef = itemRef.collection('saldos_unidades').doc(unidadeDestinoId);

                batch.set(saldoRef, {
                    qtd_transito: firebase.firestore.FieldValue.increment(-qtdRecebida),
                    qtd_disp: firebase.firestore.FieldValue.increment(qtdRecebida),
                    qtd_total: firebase.firestore.FieldValue.increment(qtdRecebida),
                    unidade_sigla: siglaDestino,
                    last_update: dataAtual
                }, { merge: true });

                const idEvtS = "REC-S-" + Date.now();
                batch.set(saldoRef.collection('historico_vida').doc(idEvtS), {
                    data: dataAtual,
                    evento: "RECEBIMENTO_CARGA",
                    quem: meuNomeCompleto,
                    quantidade: qtdRecebida, // ‚úÖ Salva a quantidade espec√≠fica deste lote
                    guia_id: transferenciaId, // Para o link com a guia
                    detalhes: `Carga recebida (${qtdRecebida} un.). Guia: ${transferenciaData.id_amigavel || transferenciaId}. Status: ${statusLocal.status.toUpperCase()}.`
                });
            }
        }

        // 1.5 ‚úÖ PREPARA OS ITENS COM O STATUS DA CONFER√äNCIA PARA O PDF POSTERIOR
        // Isso garante que o hist√≥rico salve o que o CAP JOS√â MIGUEL conferiu de fato.
        const itensAtualizadosParaHistorico = transferenciaData.itens.map(item => {
            const uidBusca = item.tombamento ? `${item.id_base || item.id}-${item.tombamento}` : (item.id_base || item.id);
            const statusLocal = window.itemStatus[uidBusca] || { status: 'ok' };
            
            return {
                ...item,
                status_recebimento: statusLocal.status === 'ok' ? 'S/A' : 'C/A',
                observacao_recebimento: statusLocal.obs || ''
            };
        });

        // 2. ATUALIZA O STATUS DA TRANSFER√äNCIA NO BANCO
        batch.update(transRef, {
            status: "RECEBIDO",
            recebedor_nome: meuNomeCompleto,
            recebedor_uid: userInfo.uid, 
            timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
            modo: 'TRANSFERENCIA_CARGA',
            itens: itensAtualizadosParaHistorico // ‚úÖ Salva a confer√™ncia final na guia
        });

        await batch.commit();
        
        // Conforme solicitado, a impress√£o agora √© manual via "Minhas Atividades"
        alert(`‚úÖ Carga recebida com sucesso!\nO Termo de Recebimento j√° est√° dispon√≠vel em "Minhas Atividades".`);
        
        if (window.parent) {
            window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        }

    } catch (e) {
        console.error("Erro ao finalizar recebimento:", e);
        alert("Erro t√©cnico ao processar recebimento: " + e.message);
        btn.disabled = false;
        btn.textContent = originalText;
    }
}
    window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
