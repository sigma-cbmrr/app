<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="sigma-comum.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box; }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold; } 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333; text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        
        /* SETORES E ITENS */
        .setor-header { background-color: #800020; color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s; }
        .setor-info { display: flex; align-items: center; gap: 10px; }
        .setor-status { 
    background-color: #666; 
    color: white !important; 
    font-size: 0.9em; 
    padding: 3px 8px; 
    border-radius: 4px; 
    min-width: 35px; 
    text-align: center; 
    transition: background-color 0.3s; 
    font-weight: bold;
} 
.setor-status.ok { background-color: #1b8a3e !important; }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .arrow { font-size: 1.2em; transition: transform 0.4s; }
        
        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease; }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0; }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0; }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1; }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD; } 
        
        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold; font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '‚úì'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center; }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A'; font-size: 10px; line-height: 18px; color: white; display: block; text-align: center; }
        
        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e; } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        /* ESTILOS PEND√äNCIAS */
        .pendencia-alert-box { font-size: 0.85em; margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s; }
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd; }
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9; }
        
        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0; }
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left; line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none; }
        
        .texto-admin { font-weight: bold; color: #0d47a1; }
        .linha-obs { color: #333; font-weight: 500; }
        .btn-manter, .btn-resolver { flex: 1; border: none; padding: 10px 5px; border-radius: 6px; font-weight: bold; text-transform: uppercase; font-size: 0.75em; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: filter 0.2s; }
        .btn-manter { background-color: #5d6d7e; color: white; }
        .pendencia-actions { display: flex; gap: 8px; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 8px; }
        .btn-manter:active, .btn-resolver:active { filter: brightness(1.2); }
        .btn-manter:hover { background-color: #34495e !important; }
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        span[onclick] { min-width: 35px; min-height: 35px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(0,0,0,0.02); }
        .btn-resolver { background-color: #1b8a3e; color: white; }
        .historico-fixo { background-color: #eeeeee; border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none; }
        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left; padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .tombamento-options { display: flex; gap: 5px; } .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23; display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block; margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px; }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em; }
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px; border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 20000; overflow-y: auto; }
        #btn-finalizar { background-color: #d90f23; color: white; font-weight: bold; border: none; padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease; margin-top: 30px; font-size: 1.1em; box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4); }
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; }
        .d-pc-none { 
            display: inline !important; 
        }
        .d-pc-inline { 
            display: none !important; 
        }
        @media (min-width: 768px) {
            .d-pc-none { 
                display: none !important; 
            }
            .d-pc-inline { 
                display: inline !important; 
            }
        }
        .draft-badge { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Confer√™ncia de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><strong>Rascunho recuperado:</strong> Voc√™ est√° continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Inicializando sistema...</div>
        <div id="main-content" style="display: none;">
            <button id="btn-finalizar" disabled>FINALIZAR CONFER√äNCIA</button>
        </div>
    </div>
    <div id="modal-nova-pendencia" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 20000;">
    <div class="modal-content" style="background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); position: relative; border-top: 5px solid #d90f23; font-family: Arial, sans-serif;">
        
        <h2 id="modal-titulo-item" style="margin-top: 0; color: #800020; font-size: 1.3em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; text-align: left;">Relatar Altera√ß√£o</h2>
        <p id="modal-subtitulo-detalhe" style="font-size: 0.85em; color: #666; margin-bottom: 20px; text-align: left;"></p>

        <input type="hidden" id="modal-uid">
        <input type="hidden" id="modal-tipo">
        <input type="hidden" id="modal-acao-objetivo" value="incluir"> <div id="modal-grupo-qtd" style="display:none; margin-top: 15px; margin-bottom: 20px; padding: 12px; background: #fdf2f2; border-radius: 8px; border: 1px solid #ffdada;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="flex: 1;">
                    <label id="modal-label-qtd" style="display: block; font-weight: bold; font-size: 0.9em; color: #d90f23; font-family: sans-serif;">Quantidade Alterada:</label>
                    <small id="modal-info-max" style="display: block; color: #888; font-size: 0.75em; font-family: sans-serif;"></small>
                </div>
                <input type="number" id="modal-input-qtd" min="1" value="1" 
                       style="width: 80px; padding: 10px; border: 2px solid #d90f23; border-radius: 6px; box-sizing: border-box; font-size: 1.2em; text-align: center; font-weight: bold; background: white;">
            </div>
        </div>

        <div style="margin-top: 15px; text-align: left;">
            <label id="modal-label-obs" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;">Descri√ß√£o do Problema:</label>
            <textarea id="modal-input-obs" placeholder="Descreva o problema..." style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; min-height: 100px; resize: vertical; font-family: inherit;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" onclick="fecharModalPendencia()" style="flex: 1; background: #eee; border: 1px solid #ccc; color: #333; cursor: pointer; padding: 12px; border-radius: 6px; font-weight: bold;">Cancelar</button>
            <button id="modal-btn-confirmar" type="button" onclick="processarAcaoFinalModal()" style="flex: 2; background: #800020; color: white; border: none; cursor: pointer; padding: 12px; border-radius: 6px; font-weight: bold;">INCLUIR</button>
        </div>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", 
        authDomain: "sigma-cbmrr.firebaseapp.com", 
        projectId: "sigma-cbmrr", 
        storageBucket: "sigma-cbmrr.firebasestorage.app", 
        messagingSenderId: "378026276038", 
        appId: "1:378026276038:web:620dd6ff57501b1a8313c7" 
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- INICIALIZA√á√ÉO DE VARI√ÅVEIS E PAR√ÇMETROS DA URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const LISTA_ID = urlParams.get('id');
    const CAUTELA_ID = urlParams.get('cautelaId');
    const COLECAO_LISTAS = 'listas_conferencia';
    const COLECAO_CAUTELAS = 'cautelas_abertas';
    
    // Captura o modo e destinat√°rio de forma direta
    let MODO_OPERACAO = urlParams.get('modo') || 'recebimento'; 
    let DESTINATARIO_DEVOLUCAO = urlParams.get('destinatarioDevolucao'); 

    // Objeto de Usu√°rio preenchido na hora (Resolve o problema do "Carregando...")
 let userInfo = { 
    postoGraduacao: "ND", 
    quadro: "ND", 
    nomeGuerra: "ND",
    uid: "ND"
};

    let dadosConferencia = [];
    let isCautela = !!CAUTELA_ID;
    let infoLocal = { nome: '', posto: '' }; 
    window.itemStatus = {};

    function getUrlParameter(n) { 
        return (new URLSearchParams(window.location.search)).get(n) || ''; 
    }

    function formatarDataSimples(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('pt-BR');
    }

    function updateHeaderInfo() {
    const el = document.getElementById('militar-info');
    if (!el) return;

    // Tenta pegar da vari√°vel global, se estiver vazia, tenta ler da URL na hora
    const p = (userInfo.nomeGuerra !== "ND") ? userInfo : {
        postoGraduacao: getUrlParameter('posto_grad') || "ND",
        quadro: getUrlParameter('quadro_mil') || "ND",
        nomeGuerra: getUrlParameter('nome_guerra') || "ND"
    };

    el.innerHTML = `<strong>Conferente:</strong> ${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`;
}

    function updateOverallStatus() {
    // 1. Identifica todos os materiais (itens pais) na tela
    const itensPai = document.querySelectorAll('.item-conferencia');
    const totalGeral = itensPai.length;
    let concluidosGeral = 0;

    // 2. Conta quantos materiais est√£o com o check [‚úì] ou Alerta [C/A]
    itensPai.forEach(item => {
        if (item.classList.contains('status-ok') || item.classList.contains('status-alert')) {
            concluidosGeral++;
        }
    });

    // 3. Atualiza√ß√£o do Bot√£o Finalizar
    const btn = document.getElementById('btn-finalizar');
    if (btn) {
        const urlParams = new URLSearchParams(window.location.search);
        const modo = urlParams.get('modo') || (typeof MODO_OPERACAO !== 'undefined' ? MODO_OPERACAO : 'recebimento');
        
        let buttonPrefix = 'FINALIZAR CONFER√äNCIA';
        if (modo === 'devolucao_final') buttonPrefix = 'FINALIZAR RECEBIMENTO DE DEVOLU√á√ÉO';
        else if (!!urlParams.get('cautelaId')) buttonPrefix = 'FINALIZAR RECEBIMENTO';

        btn.textContent = `${buttonPrefix} (${concluidosGeral}/${totalGeral} ITENS)`;
        
        const todosConcluidos = totalGeral > 0 && concluidosGeral === totalGeral;
        btn.disabled = !todosConcluidos;
        
        if (btn.disabled) {
            btn.style.backgroundColor = '#a0a0a0';
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';
            btn.style.boxShadow = 'none';
        } else {
            btn.style.backgroundColor = '#1b8a3e';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.style.boxShadow = '0 4px 8px rgba(27, 138, 62, 0.4)';
        }
    }

    // 4. Atualiza os badges de progresso dos Setores (0/X)
    document.querySelectorAll('.setor').forEach(s => {
        const itensNoSetor = s.querySelectorAll('.item-conferencia');
        const totalNoSetor = itensNoSetor.length;
        const concluidosNoSetor = Array.from(itensNoSetor).filter(item => 
            item.classList.contains('status-ok') || item.classList.contains('status-alert')
        ).length;
        const numAlteracoes = s.querySelectorAll('.item-conferencia.status-alert').length;
        
        const statusDiv = s.querySelector('.setor-status');
        if (statusDiv) {
            statusDiv.style.borderRadius = "20px";
            statusDiv.style.fontWeight = "bold";
            statusDiv.style.display = "inline-block";
            statusDiv.style.minWidth = "45px";
            statusDiv.style.color = "#ffffff"; // ‚¨ÖÔ∏è CORRIGIDO: Sempre branco

            if (totalNoSetor > 0 && concluidosNoSetor === totalNoSetor) {
                if (numAlteracoes > 0) {
                    statusDiv.innerText = `${numAlteracoes} C/A`;
                    statusDiv.style.backgroundColor = "#d90f23";
                } else {
                    statusDiv.innerText = "S/A";
                    statusDiv.style.backgroundColor = "#1b8a3e";
                }
            } else {
                statusDiv.innerText = `${concluidosNoSetor}/${totalNoSetor}`;
                statusDiv.style.backgroundColor = "#666"; // ‚¨ÖÔ∏è CORRIGIDO: Fundo escuro para contraste
            }
            statusDiv.dataset.completed = concluidosNoSetor;
        }
    });
}

function updateSetorStatus(setorEl) { 
    if (!setorEl) return;

    const itensPai = setorEl.querySelectorAll('.item-conferencia'); 
    let concluidos = 0;
    let total = itensPai.length; 

    itensPai.forEach(item => { 
        if (item.classList.contains('status-ok') || item.classList.contains('status-alert')) {
            concluidos++;
        }
    }); 

    setorEl.dataset.totalItems = total; 
    
    const st = setorEl.querySelector('.setor-status'); 
    if (st) {
        st.dataset.completed = concluidos; 
        st.style.color = "#ffffff"; // ‚¨ÖÔ∏è CORRIGIDO: Garante branco no update direto
        
        if (concluidos === total && total > 0) { 
            const temAlerta = setorEl.querySelectorAll('.item-conferencia.status-alert').length > 0;
            
            if (temAlerta) {
                st.textContent = 'CONCLU√çDO C/ ALT';
                st.style.backgroundColor = "#d90f23";
            } else {
                st.textContent = 'S/A';
                st.style.backgroundColor = "#1b8a3e";
            }
            st.classList.add('ok'); 
        } else { 
            st.textContent = `${concluidos}/${total}`; 
            st.classList.remove('ok');
            st.style.backgroundColor = "#666"; 
        } 
    }
}
        function updateItemMainStatusDisplay(item) { 
    if (!item || item.dataset.type === 'single') return; 
    
    const itemIdBase = item.getAttribute('data-id'); 
    const tombs = item.querySelectorAll('.tombamento-container'); 
    let concluidos = 0; 
    let temAlteracao = false; 

    tombs.forEach(t => { 
        const uidOriginal = t.getAttribute('data-id'); // Pega o UID exato: "ID-TOMB"
        const uidCautela = `CAUTELA-${uidOriginal}`;

        const statusObj = window.itemStatus[uidOriginal];
        const statusCautelaObj = window.itemStatus[uidCautela];

        const s = statusObj ? statusObj.status : null; 
        const sCautela = statusCautelaObj ? statusCautelaObj.status : null; 

        // CRIT√âRIO DE CONCLUS√ÉO: Verifica se o status existe e √© um dos estados positivos
        const preenchido = (s === 'ok' || s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente');
        
        if (preenchido) {
            concluidos++;
            // Se for qualquer coisa diferente de 'ok', o pai ser√° Alerta (Vermelho)
            if (s === 'C/A' || s === 'KEEP' || sCautela === 'cautela_ciente') {
                temAlteracao = true;
            }
        }
    }); 

    const icon = item.querySelector('.status-icon'); 
    
    // Reseta as classes do Item Pai
    item.classList.remove('status-ok', 'status-alert');
    if (icon) icon.className = 'status-icon'; 

    // L√ìGICA DE ATIVA√á√ÉO: S√≥ pinta o pai se o n√∫mero de tombamentos conclu√≠dos for igual ao total
    if (concluidos === tombs.length && tombs.length > 0) { 
        if (temAlteracao) { 
            item.classList.add('status-alert'); 
            if (icon) icon.classList.add('alert'); 
        } else { 
            item.classList.add('status-ok'); 
            if (icon) icon.classList.add('ok'); 
        } 
    } 
    
    // Atualiza o contador do setor (badge) l√° no topo
    const setorEl = item.closest('.setor');
    if (setorEl) updateSetorStatus(setorEl);
}
       function toggleSetor(header) { 
    const content = header.nextElementSibling; 
    const arrow = header.querySelector('.arrow'); 
    if (content.classList.contains('expanded')) { 
        content.classList.remove('expanded'); 
        arrow.textContent = '‚ñ∫'; 
    } else { 
        document.querySelectorAll('.setor-content.expanded').forEach(c => {
            c.classList.remove('expanded'); 
            c.previousElementSibling.querySelector('.arrow').textContent = '‚ñ∫';
        }); 
        content.classList.add('expanded'); 
        arrow.textContent = '‚ñº'; 
    } 
}
        function checkSetorCompletion(currentSetor, currentItemId) {
    if (!currentSetor) return;

    updateOverallStatus();

    const totalItensNoSetor = parseInt(currentSetor.getAttribute('data-total-items')) || 0;
    
    // Captura todos os itens de confer√™ncia dentro do setor
    const itensNoSetor = currentSetor.querySelectorAll('.item-conferencia');
    
    let concluidos = 0;

    itensNoSetor.forEach(item => {
        const id = item.getAttribute('data-id');
        const isSingle = item.getAttribute('data-type') === 'single';
        const temStatusVisual = item.classList.contains('status-ok') || item.classList.contains('status-alert');
        
        if (isSingle) {
            // L√ìGICA CIR√öRGICA: Para item Single, n√£o basta a classe visual. 
            // Ele precisa ter o sinalizador 'interacao_humana' no window.itemStatus
            // Isso garante que o conferente clicou em Manter, Resolvido, S/A ou +Alt nesta sess√£o.
            const statusMemoria = window.itemStatus[id];
            if (temStatusVisual && statusMemoria && statusMemoria.interacao_humana === true) {
                concluidos++;
            }
        } else {
            // Para itens Multi (tombamentos), mantemos a l√≥gica original de classe visual
            if (temStatusVisual) {
                concluidos++;
            }
        }
    });

    if (concluidos >= totalItensNoSetor && totalItensNoSetor > 0) {
        setTimeout(() => {
            autoAdvanceSetor(currentSetor); 
        }, 550);
    } else {
        // L√≥gica de Scroll para o pr√≥ximo alvo n√£o resolvido
        const todosAlvos = Array.from(document.querySelectorAll('.tombamento-container, .item-conferencia[data-type="single"]'));
        const indexAtual = todosAlvos.findIndex(el => el.getAttribute('data-id') === currentItemId);

        const proximoAlvo = todosAlvos.slice(indexAtual + 1).find(el => {
            const id = el.getAttribute('data-id');
            const type = el.getAttribute('data-type');
            const stNormal = window.itemStatus[id]?.status;
            const stCautela = window.itemStatus[`CAUTELA-${id}`]?.status;
            const interacao = window.itemStatus[id]?.interacao_humana;
            
            // Um alvo √© considerado "j√° resolvido" se:
            // Se for single: tem status E intera√ß√£o humana
            // Se for tombamento: tem status OK/CA ou Ciente
            const jaResolvido = (type === 'single') 
                ? (interacao === true && (stNormal === 'ok' || stNormal === 'C/A'))
                : (stNormal === 'ok' || stNormal === 'C/A' || stNormal === 'KEEP' || stCautela === 'cautela_ciente');
                
            return !jaResolvido;
        });

        if (proximoAlvo) {
            setTimeout(() => {
                proximoAlvo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                proximoAlvo.style.transition = "box-shadow 0.3s";
                proximoAlvo.style.boxShadow = "0 0 10px rgba(245, 124, 0, 0.5)";
                setTimeout(() => proximoAlvo.style.boxShadow = "none", 800);
            }, 300);
        }
    }
}
        function injetarCautelasNaLista() {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    // Aqui simulamos a leitura da sua cole√ß√£o cautelas_abertas
    // No seu c√≥digo real, voc√™ deve garantir que window.cautelasAbertas contenha os itens que voc√™ me enviou
    const cautelas = window.cautelasAbertas || []; 

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            cautelas.forEach(cautelaDoc => {
                cautelaDoc.itens.forEach(itemCautelado => {
                    // Se o ID base coincide (Ex: 56911524-64012364)
                    if (item.id === itemCautelado.id_base) {
                        
                        if (item.tipo === 'multi' && item.tombamentos) {
                            // Procura o tombamento espec√≠fico (Ex: 511.524 ou 511.527)
                            const t = item.tombamentos.find(tomb => tomb.tomb === itemCautelado.tombamento);
                            if (t) {
                                t.cautela = {
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: 1,
                                    id_cautela: cautelaDoc.cautela_id
                                };
                            }
                        } else if (item.tipo === 'single') {
                            if (!item.cautelas) item.cautelas = [];
                            // Evita duplicados
                            if (!item.cautelas.find(c => c.id_cautela === cautelaDoc.cautela_id)) {
                                item.cautelas.push({
                                    destinatario: cautelaDoc.destinatario_original_nome,
                                    quantidade: itemCautelado.quantidade,
                                    id_cautela: cautelaDoc.cautela_id
                                });
                            }
                        }
                    }
                });
            });
        });
    });
}

        function autoAdvanceSetor(currentSetorElement) {
    const todosSetores = Array.from(document.querySelectorAll('.setor'));
    const currentIndex = todosSetores.indexOf(currentSetorElement);
    
    const currentContent = currentSetorElement.querySelector('.setor-content');
    const currentArrow = currentSetorElement.querySelector('.arrow');
    
    if (currentContent) currentContent.classList.remove('expanded');
    if (currentArrow) currentArrow.textContent = '‚ñ∫';

    if (currentIndex !== -1 && currentIndex < todosSetores.length - 1) {
        const nextSetorEl = todosSetores[currentIndex + 1];
        const nextContent = nextSetorEl.querySelector('.setor-content');
        const nextArrow = nextSetorEl.querySelector('.arrow');
        
        if (nextContent) nextContent.classList.add('expanded');
        if (nextArrow) nextArrow.textContent = '‚ñº';
        
        setTimeout(() => {
            nextSetorEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 150);
    } else {
        const btnFin = document.getElementById('btn-finalizar');
        if (btnFin) {
            setTimeout(() => {
                btnFin.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    }
}
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        
        
        function limparRascunho() {
            localStorage.removeItem('sigma_active_conf');
            const listId = CAUTELA_ID || LISTA_ID; // Pega o ID da lista ou cautela
            const userId = (userInfo && userInfo.nomeGuerra) 
            ? userInfo.nomeGuerra.toUpperCase() 
            : null;

            if (listId && userId) {
                // Esta chave DEVE ser a mesma usada na fun√ß√£o salvarRascunho()
                const draftKey = `sigma_draft_${userId}_${listId}`; 
                localStorage.removeItem(draftKey);
                console.log(`Rascunho local (${draftKey}) limpo com sucesso.`);
            }
        }

       // --- 1. FUN√á√ÉO PARA LER DADOS ANTIGOS (LEGADOS) ---
const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
    const separator = ' | + NOVA: ';
    if (typeof textoBruto !== 'string') return [];
    
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
            if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
        if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
    }
    return linhas;
};

// --- 2. FUN√á√ÉO VISUAL √öNICA (SEM HORAS VIA REGEX) ---
const gerarHtmlVisualApp = (pendencia, autorAtual, dataAtual) => {
    let html = '<ul class="lista-pendencias" style="list-style: none; padding: 0; margin: 5px 0;">';
    
    // 1. EXTRA√á√ÉO SEGURA DA LISTA
    // Tenta pegar o array de pend√™ncias acumuladas (Nova Estrutura)
    const lista = (pendencia && pendencia.pendencias_ca) ? pendencia.pendencias_ca : 
                  (Array.isArray(pendencia) ? pendencia : null);

    // üõ°Ô∏è 2. REGRA DE PRIORIDADE (MATA O FANTASMA)
    // Se a lista existir e tiver itens, usamos APENAS ela e ignoramos o campo 'obs'
    if (lista && Array.isArray(lista) && lista.length > 0) {
        lista.forEach(p => {
            const militar = p.quem || 'Militar';
            const dataFull = p.data || '';
            
            // Extrai apenas a data (DD/MM/AAAA) usando regex
            const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
            const dataApenas = matchData ? matchData[0] : dataFull;

            html += `
                <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px;">
                    <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                    <b>Por </b>
                    <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                    <span> em <b>${dataApenas}</b>:</span>
                    <i style="margin-left: 5px; color: #333; font-weight: normal; display: block; padding-left: 25px;">${p.obs}</i>
                </li>`;
        });
    } 
    // 3. FALLBACK PARA DADOS ANTIGOS (S√≥ entra aqui se N√ÉO houver lista)
    else if (pendencia && pendencia.obs && typeof pendencia.obs === 'string') {
        const militar = pendencia.quem || autorAtual || 'Militar';
        const dataFull = pendencia.data || dataAtual || '';
        const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
        const dataApenas = matchData ? matchData[0] : dataFull;

        html += `
            <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem;">
                <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                <b>Por </b>
                <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                <span> em <b>${dataApenas}</b>:</span>
                <i style="margin-left: 5px; color: #333; font-weight: normal;">${pendencia.obs}</i>
            </li>`;
    }

    html += '</ul>';
    return html;
};
    
// --- 3. FUN√á√ÉO DE RENDERIZA√á√ÉO DA TELA ---
// --- 3. FUN√á√ÉO DE RENDERIZA√á√ÉO DA TELA ---
// --- 3. FUN√á√ÉO DE RENDERIZA√á√ÉO DA TELA ---
function renderizarConferencia() {
    const mainContent = document.getElementById('main-content');
    const antigos = mainContent.querySelectorAll('.setor'); 
    antigos.forEach(el => el.remove());

    let htmlSetores = ''; 
    const fonteDados = window.dadosConferencia || dadosConferencia;
    
    const urlParams = new URLSearchParams(window.location.search);
    const isConferenciaDeCautela = !!urlParams.get('cautelaId');

    const montarPendenciaHtml = (uid, itemOuTomb) => {
        let htmlAcumulado = '';
        const statusLocal = window.itemStatus[uid] || {};
        const cautelaUid = `CAUTELA-${uid}`;
        const statusCautela = window.itemStatus[cautelaUid] || {};
        const isCiente = statusCautela.status === 'cautela_ciente' || statusCautela.cautela_confirmada === true;

        if (!isConferenciaDeCautela) {
            let listaDeCautelas = [];
            if (itemOuTomb.cautela) listaDeCautelas = [itemOuTomb.cautela];
            else if (itemOuTomb.cautelas && Array.isArray(itemOuTomb.cautelas)) listaDeCautelas = itemOuTomb.cautelas;

            listaDeCautelas.forEach(c => {
                const dataExibicao = c.data || "Data N/D";
                htmlAcumulado += `
                    <div class="pendencia-id-card status-cautela" style="border-left: 4px solid #f57c00; background-color: #fff8e0; padding: 12px; margin-bottom: 8px; border-radius: 5px; text-align: left;">
                        <div style="font-weight: bold; color: #f57c00; font-size: 0.8em; margin-bottom: 8px; border-bottom: 1px solid rgba(245, 124, 0, 0.2); padding-bottom: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;" onclick="verExtratoCautela('${c.id}')">
                            <i class="fas fa-eye"></i> ${c.id || 'CAUTELA'} em ${dataExibicao}
                        </div>
                        <div style="font-size: 0.85em; color: #333; margin-bottom: 4px;">
                            <i class="fas fa-boxes" style="width: 18px; color: #666;"></i> Quantidade: <b>${c.quantidade || 1} un.</b>
                        </div>
                        <div style="font-size: 0.85em; color: #333; margin-bottom: 8px;">
                            <i class="fas fa-user" style="width: 18px; color: #666;"></i> Detentor: <b>${c.destinatario}</b>
                        </div>
                        ${isCiente ? `
                            <div style="color: #1b8a3e; font-size: 0.75em; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 6px; margin-top: 4px; font-style: italic;">
                                <i class="fas fa-check-double"></i> Ciente nesta confer√™ncia
                            </div>
                        ` : `
                            <button type="button" class="action-button ca-alert active" style="width: 100%; margin-top: 5px; height: 30px; font-size: 0.8em;" onclick="setItemStatusID(this, 'cautela_ciente', '${cautelaUid}')">Ciente</button>
                        `}
                    </div>`;
            });
        }

        if (itemOuTomb.pendencias_ids && Array.isArray(itemOuTomb.pendencias_ids)) {
            itemOuTomb.pendencias_ids.forEach(p => {
                const isTemp = String(p.id).startsWith('TEMP-');
                const jaFoiMantido = statusLocal.ids_mantidos && statusLocal.ids_mantidos.includes(p.id);
                const nomeExibicao = p.autor_nome || "Conferente";

                let acoesHtml = '';
                let botoesGestaoHtml = '';

                if (isTemp) {
                    botoesGestaoHtml = `
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span onclick="abrirModalEditar('${p.id}', '${uid}', ${p.quantidade}, '${p.descricao.replace(/'/g, "\\'")}')" style="cursor:pointer; color:#2196F3; font-size:1.1em; padding:5px;"><i class="fas fa-edit"></i></span>
                            <span onclick="confirmarExclusaoRelato('${p.id}', '${uid}')" style="cursor:pointer; color:#d90f23; font-size:1.1em; padding:5px;"><i class="fas fa-trash-alt"></i></span>
                        </div>`;
                    acoesHtml = `<div style="color:#2196F3; font-size:0.75em; font-weight:bold; text-align:center; width:100%; border-top:1px solid #eee; padding-top:5px; font-style:italic;">Aguardando finaliza√ß√£o...</div>`;
                } else if (jaFoiMantido) {
                    acoesHtml = `<div style="color: #1b8a3e; font-size: 0.75em; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 8px; margin-top: 4px; font-style: italic;"><i class="fas fa-check-double"></i> MANTIDO</div>`;
                } else {
                    acoesHtml = `
                        <div class="pendencia-actions" style="display: flex; gap: 8px; margin-top: 10px;">
                            <button type="button" class="btn-manter" style="flex:1" onclick="manterID('${p.id}', '${uid}')">Manter</button>
                            <button type="button" class="btn-resolver" style="flex:1" onclick="abrirModalResolver('${p.id}', '${uid}', ${p.quantidade}, '${p.descricao.replace(/'/g, "\\'")}')">Resolvido</button>
                        </div>`;
                }

                htmlAcumulado += `
                    <div class="pendencia-id-card" id="card-${p.id}" style="position:relative; border: 1px solid ${isTemp ? '#2196F3' : (jaFoiMantido ? '#1b8a3e' : '#d90f23')}; border-radius: 8px; padding: 12px; margin-bottom: 10px; background-color: #fff; text-align: left;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #666; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">
                            <span>
                                <i class="fas ${isTemp ? 'fa-pen-nib' : 'fa-history'}" style="margin-right: 5px; color: ${isTemp ? '#2196F3' : '#666'};"></i> 
                                <i class="fas fa-user" style="margin-right: 3px;"></i> 
                                ${nomeExibicao}
                            </span>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span>${p.data_criacao}</span>
                                ${botoesGestaoHtml}
                            </div>
                        </div>
                        <div style="font-size: 0.85em; color: #333; margin-bottom: 4px;">
                            <i class="fas fa-boxes" style="width: 18px; color: #666;"></i> Quantidade: <strong style="color: #d90f23;">${p.quantidade} un.</strong>
                        </div>
                        <div style="font-size: 0.85em; color: #333; margin-bottom: 8px;">
                            <i class="fas fa-comment-dots" style="width: 18px; color: #666;"></i> Descri√ß√£o: <b>${p.descricao}</b>
                        </div>
                        ${acoesHtml}
                    </div>`;
            });
        }
        return htmlAcumulado;
    };

    fonteDados.forEach((setor, index) => {
        const isFirstSetor = (index === 0);
        let htmlItens = '';
        const totalItensNoSetor = setor.itens.length;

        setor.itens.forEach(item => {
            const itemId = item.id;
            const nomeEscapado = item.nome.replace(/'/g, "\\'");
            
            if (item.tipo === 'multi' && item.tombamentos) {
                let htmlTombamentos = '';
                let confCount = 0;
                let temAlertaNoGrupo = false;

                item.tombamentos.forEach(t => {
                    const uid = `${itemId}-${t.tomb}`;
                    const pndHtml = montarPendenciaHtml(uid, t);
                    
                    // üõë CORRE√á√ÉO CIR√öRGICA: Oculta o S/A se houver Pend√™ncia OU se houver Cautela
                    const hasPendenciaReal = (t.pendencias_ids && t.pendencias_ids.length > 0);
                    const hasCautelaReal = (!!t.cautela && !isConferenciaDeCautela);
                    const ocultarSA = hasPendenciaReal || hasCautelaReal;

                    const statusU = window.itemStatus[uid]?.status;
                    const statusC = window.itemStatus[`CAUTELA-${uid}`]?.status;
                    const isCiente = statusC === 'cautela_ciente' || window.itemStatus[`CAUTELA-${uid}`]?.cautela_confirmada === true;

                    if (statusU === 'ok' || statusU === 'C/A' || statusU === 'KEEP' || isCiente) {
                        confCount++;
                        if (statusU === 'C/A' || statusU === 'KEEP' || isCiente) temAlertaNoGrupo = true;
                    }

                    htmlTombamentos += `
                        <div class="tombamento-container" data-id="${uid}" data-tomb="${t.tomb}" style="border: 1px solid #eee; padding: 10px; margin-bottom: 5px; border-radius: 8px; ${isCiente ? 'background-color: #f0fff4; border-color: #1b8a3e;' : ''}">
                            <div class="tombamento-controls" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Tomb.: <b>${t.tomb}</b></span>
                                <div class="tombamento-options" style="display: flex; gap: 5px;">
                                    
                                    ${!ocultarSA ? `
                                    <button type="button" class="action-button sa-ok ${statusU === 'ok' ? 'active' : ''}" 
                                            onclick="setItemStatusID(this, 'ok', '${uid}')">S/A</button>
                                    ` : ''}

                                    <button type="button" class="action-button ca-alert ${hasPendenciaReal ? 'active' : ''}" 
                                            onclick="abrirFormNovoID('${uid}', 'multi', '${nomeEscapado}', 1, '${t.tomb}')">
                                            <span class="d-pc-inline">+ Altera√ß√£o</span>
                                            <span class="d-pc-none">+ Alt</span>
                                    </button>
                                </div>
                            </div>
                            <div class="alerts-wrapper">${pndHtml}</div>
                        </div>`;
                });

                let classeMulti = (confCount === item.tombamentos.length && item.tombamentos.length > 0) ? (temAlertaNoGrupo ? 'status-alert' : 'status-ok') : '';
                htmlItens += `<div class="item-conferencia item-has-tombamentos ${classeMulti}" data-id="${itemId}">
                    <div class="item-header">
                        <span class="status-icon ${classeMulti === 'status-ok' ? 'ok' : (classeMulti === 'status-alert' ? 'alert' : '')}"></span>
                        <span class="item-label">${item.nome}</span>
                    </div>
                    ${htmlTombamentos}
                </div>`;

            } else {
                const pndHtml = montarPendenciaHtml(itemId, item);
                const totalOriginal = Number(item.quantidadeEsperada) || 0;
                const totalCaut = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                const totalPend = (item.pendencias_ids || []).reduce((sum, p) => sum + (Number(p.quantidade) || 0), 0);
                const saldoDisponivel = totalOriginal - totalCaut - totalPend;
                
                // üõë CORRE√á√ÉO CIR√öRGICA: Oculta o S/A se houver Pend√™ncia OU se houver Cautela (Single)
                const hasPendenciaReal = (item.pendencias_ids && item.pendencias_ids.length > 0);
                const hasCautelaReal = (item.cautelas && item.cautelas.length > 0 && !isConferenciaDeCautela);
                const ocultarSA = hasPendenciaReal || hasCautelaReal;

                const currentStatus = window.itemStatus[itemId]?.status;
                const statusC = window.itemStatus[`CAUTELA-${itemId}`]?.status;
                const isCiente = statusC === 'cautela_ciente' || window.itemStatus[`CAUTELA-${itemId}`]?.cautela_confirmada === true;

                let classeSingle = (currentStatus === 'ok') ? 'status-ok' : (isCiente || (item.pendencias_ids && item.pendencias_ids.length > 0) ? 'status-alert' : '');

                htmlItens += `
                    <div class="item-conferencia ${classeSingle}" data-type="single" data-id="${itemId}">
                        <div class="item-header">
                            <span class="status-icon ${classeSingle === 'status-ok' ? 'ok' : (classeSingle === 'status-alert' ? 'alert' : '')}"></span>
                            <div style="display:flex; flex-direction:column">
                                <span class="item-label">${item.nome}</span>
                                <span style="font-size:0.82em; color:${(hasPendenciaReal || hasCautelaReal) ? '#d90f23' : '#1b8a3e'}; font-weight:bold;">
                                    DISPON√çVEL: ${saldoDisponivel} de ${totalOriginal}
                                </span>
                            </div>
                        </div>
                        <div class="item-options" style="margin-top:10px; display: flex; gap: 5px;">
                            
                            ${!ocultarSA ? `
                            <button type="button" class="action-button sa-ok ${currentStatus === 'ok' ? 'active' : ''}" 
                                    onclick="setItemStatusID(this, 'ok', '${itemId}')">S/A</button>
                            ` : ''}

                            <button type="button" class="action-button ca-alert ${hasPendenciaReal ? 'active' : ''}" 
                                    onclick="abrirFormNovoID('${itemId}', 'single', '${nomeEscapado}', ${saldoDisponivel})">
                                    <span class="d-pc-inline">+ Altera√ß√£o</span>
                                    <span class="d-pc-none">+ Alt</span>
                            </button>
                        </div>
                        <div class="alerts-wrapper" style="margin-top:10px">${pndHtml}</div>
                    </div>`;
            }
        });

        htmlSetores += `
            <div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id || setor.nome}">
                <div class="setor-header" onclick="toggleSetor(this)">
                    <div class="setor-info">
                        <span>${setor.nome}</span>
                        <div class="setor-status" style="color: white; font-weight: bold;">0/${totalItensNoSetor}</div>
                    </div>
                    <span class="arrow">${isFirstSetor ? '‚ñº' : '‚ñ∫'}</span>
                </div>
                <div class="setor-content ${isFirstSetor ? 'expanded' : ''}">${htmlItens}</div>
            </div>`;
    });

    const btnFin = document.getElementById('btn-finalizar');
    if (btnFin) btnFin.insertAdjacentHTML('beforebegin', htmlSetores);
    updateOverallStatus();
}
    
    function abrirModalEditar(pendenciaId, uid, qtdAtual, descricaoAtual) {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');

    // 1. Configura para Modo Edi√ß√£o
    document.getElementById('modal-acao-objetivo').value = "editar";
    document.getElementById('modal-uid').value = uid;
    document.getElementById('modal-tipo').value = pendenciaId; 

    // 2. Preenche os dados
    document.getElementById('modal-titulo-item').innerText = "Editar Relato";
    document.getElementById('modal-subtitulo-detalhe').innerText = "Ajuste os detalhes da altera√ß√£o selecionada.";
    document.getElementById('modal-label-obs').innerText = "Nova Descri√ß√£o:";
    inputObs.value = descricaoAtual;

    // 3. For√ßa a exibi√ß√£o da quantidade (importante para mobile)
    const grupoQtd = document.getElementById('modal-grupo-qtd');
    if (grupoQtd) {
        grupoQtd.style.display = 'block'; // Remove o 'important' via JS para evitar conflitos
    }
    inputQtd.value = qtdAtual;

    // 4. Ajuste Visual para Edi√ß√£o (Azul)
    btnConfirmar.innerText = "SALVAR ALTERA√á√ïES";
    btnConfirmar.style.backgroundColor = "#2196F3"; 
    document.querySelector('.modal-content').style.borderTopColor = "#2196F3";

    // 5. ACIONAMENTO MOBILE (Garante que o modal suba acima de tudo)
    modal.style.zIndex = "99999";
    modal.style.display = 'flex';

    // 6. Scroll para o topo (Evita que o modal abra "escondido" se a p√°gina estiver longa)
    window.scrollTo(0, 0);

    // Foco no input com delay maior para mobile (espera o teclado subir)
    setTimeout(() => {
        if (inputObs) {
            inputObs.focus();
            inputObs.setSelectionRange(inputObs.value.length, inputObs.value.length);
        }
    }, 300);
}
    
      function adaptarCautelaParaRender(cautelaData) {
    if (!cautelaData.itens || cautelaData.itens.length === 0) return [];

    const setorCautela = {
        id: cautelaData.cautela_id,
        nome: "ITENS PARA RECEBIMENTO",
        itens: cautelaData.itens.map(cItem => {
            
            // üõë AQUI EST√Å O SEGREDO: Captura as 4 unidades de qualquer lugar que elas estejam
            const qtdReal = Number(cItem.quantidade || cItem.quantidadeEsperada || 1);

            // Verifica se √© erro de cadastro (P√© de Cabra com tombamento = nome)
            const tombInvalido = (cItem.tombamento === cItem.nome || cItem.tombamento === "S/T" || !cItem.tombamento);
            let tipo = tombInvalido ? 'single' : 'multi';
            
            let tombamentos = null;
            if (tipo === 'multi') {
                tombamentos = [{
                    tomb: cItem.tombamento,
                    id_completo: `${cItem.id_base || cItem.id}-${cItem.tombamento}`,
                    cautela: { id: cautelaData.cautela_id, destinatario: cautelaData.destinatario || "N/D" }
                }];
            }

            return {
                id: cItem.id_base || cItem.id,
                nome: cItem.nome,
                quantidadeEsperada: qtdReal, // Define 4 unidades aqui!
                tipo: tipo,
                tombamentos: tombamentos,
                cautelas: [], // Esconde carimbo laranja
                situacao: "DISPON√çVEL"
            };
        })
    };
    return [setorCautela];
}
      async function carregarDadosRemotos() {
    const ID_ALVO = isCautela ? CAUTELA_ID : LISTA_ID;
    const COLECAO_ALVO = isCautela ? COLECAO_CAUTELAS : COLECAO_LISTAS;
    
    // --- CAPTURA E EXIBI√á√ÉO IMEDIATA DO CONFERENTE ---
    const urlParamsLocal = new URLSearchParams(window.location.search);
    userInfo.postoGraduacao = urlParamsLocal.get('posto_grad') || "ND";
    userInfo.quadro = urlParamsLocal.get('quadro_mil') || "ND";
    userInfo.nomeGuerra = urlParamsLocal.get('nome_guerra') || "ND";
    userInfo.uid = urlParamsLocal.get('user_uid') || "ND";

    const elHeader = document.getElementById('militar-info');
    if (elHeader) {
        elHeader.innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString('pt-BR')}`;
    }

    if (!ID_ALVO) return;
        
    const loadingMsg = document.getElementById('loading-message');
    if (loadingMsg) loadingMsg.innerHTML = "Conectando ao SIGMA...";

    try {
        const doc = await db.collection(COLECAO_ALVO).doc(ID_ALVO).get();
        if (!doc.exists) throw new Error("Documento n√£o encontrado.");
        
        const data = doc.data();
        const isDevolucaoFinal = urlParamsLocal.get('modo') === 'devolucao_final';
        
        if (isCautela) {
            dadosConferencia = adaptarCautelaParaRender(data);
        } else {
            const listaBruta = data.list || [];
            dadosConferencia = listaBruta.map(setor => ({
                ...setor,
                itens: (setor.itens || []).map(item => {
                    const tombamentoInvalido = item.tombamentos && item.tombamentos.some(t => t.tomb === item.nome || t.tomb === "S/T");
                    if (tombamentoInvalido || item.tipo === 'single') {
                        item.tipo = 'single';
                        item.quantidadeEsperada = Number(item.quantidadeEsperada || item.quantidade || 0);
                    }
                    item._ocultarCarimbo = isDevolucaoFinal;
                    return item;
                })
            }));
        }

        window.dadosConferencia = dadosConferencia;
        
        // üõë AJUSTE CIR√öRGICO: Limpeza de r√≥tulos redundantes no cabe√ßalho
        infoLocal = { 
            nome: isCautela ? `${CAUTELA_ID}` : (data.nome_local || "Lista"),
            posto: isCautela ? "" : (data.posto || "Geral")
        };
        
        const infoElement = document.getElementById('local-posto-info');
        if (infoElement) {
            // Remove o h√≠fen se for cautela (posto vazio)
            const separador = infoLocal.posto ? " - " : "";
            infoElement.innerHTML = `<span style="color:blue;font-weight:bold">${infoLocal.posto}${separador}${infoLocal.nome}</span>`;
        }

        const btnFinalizar = document.getElementById('btn-finalizar');
        if (btnFinalizar) {
            if (isDevolucaoFinal) {
                btnFinalizar.onclick = () => finalizarRecebimentoDevolucao(data);
            } else if (isCautela) {
                btnFinalizar.onclick = () => finalizarRecebimentoCautela(data);
            } else {
                btnFinalizar.onclick = () => finalizarConferencia();
            }
        }

        renderizarConferencia(); 

        if (typeof updateOverallStatus === "function") updateOverallStatus();
        if (loadingMsg) loadingMsg.style.display = 'none'; 
        document.getElementById('main-content').style.display = 'block';

    } catch (e) { 
        console.error(e);
        if (loadingMsg) loadingMsg.innerHTML = `<span style='color:red'>${e.message}</span>`;
    }
}
     
       async function finalizarConferencia() {
    const btn = document.getElementById('btn-finalizar');
    if (btn.disabled) return;

    // üõë TRAVA CIR√öRGICA: Se n√£o h√° LISTA_ID, estamos em modo Cautela/Devolu√ß√£o
    if (!LISTA_ID) {
        console.warn("Redirecionando fluxo: LISTA_ID ausente.");
        if (typeof finalizarRecebimentoDevolucao === 'function' && CAUTELA_ID) {
            return finalizarRecebimentoDevolucao(window._dadosCautelaOriginal || dadosConferencia[0]);
        }
        alert("Erro: Identificador da lista n√£o encontrado.");
        return;
    }
    
    btn.textContent = "SALVANDO SUA CONFER√äNCIA..."; 
    btn.disabled = true;

    try {
        const p = userInfo;
        const militarInfoEl = document.getElementById('militar-info');
        const conferenteCompleto = militarInfoEl ? 
            militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim() : 
            `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;

        const localNome = `${infoLocal.posto} - ${infoLocal.nome}`;
        const timestampAgora = firebase.firestore.Timestamp.now();
        
        let itensRelatorio = [];
        let itensCaa = []; 
        let totalCaa = 0;
        const fonteDeDados = window.dadosConferencia || dadosConferencia;

        const novaListaMestra = fonteDeDados.map(setor => {
            return {
                ...setor,
                itens: setor.itens.map(item => {
                    const processarEntidade = (entidade, uid, nomeParaRelatorio) => {
                        const statusLocal = window.itemStatus[uid];
                        if (!entidade.pendencias_ids) entidade.pendencias_ids = [];
                        if (!entidade.historico_vida) entidade.historico_vida = [];

                        if (entidade.situacao === 'AVARIADO' && statusLocal?.status === 'ok') {
                            entidade.situacao = 'DISPON√çVEL';
                            delete entidade.id_cautela_origem;
                            delete entidade.motivo_avaria;
                        }

                        if (!statusLocal || statusLocal.status === 'pending') {
                            const qtdFix = entidade.quantidadeEsperada || entidade.quantidade || 1;
                            itensRelatorio.push({
                                id: uid, nomeCompleto: nomeParaRelatorio, status: 'S/A',
                                situacao_patrimonial: entidade.situacao || 'DISPON√çVEL',
                                quantidade: qtdFix, setor: setor.nome, obs: ""
                            });
                            return entidade;
                        }

                        if (statusLocal.ids_resolvidos) {
                            statusLocal.ids_resolvidos.forEach(res => {
                                const idx = entidade.pendencias_ids.findIndex(p => p.id === res.id);
                                if (idx > -1) {
                                    const pendenciaMorta = entidade.pendencias_ids[idx];
                                    entidade.historico_vida.push({
                                        evento: res.qtd_remanescente > 0 ? "SOLUCAO_PARCIAL" : "SOLUCAO_TOTAL",
                                        id_pendencia_origem: pendenciaMorta.id, quem: res.resolvido_por,
                                        data: res.data_solucao, detalhes: `Resolvido ${res.qtd_resolvida}. Desc: ${pendenciaMorta.descricao}`
                                    });
                                    entidade.pendencias_ids.splice(idx, 1);
                                    if (res.qtd_remanescente > 0) {
                                        entidade.pendencias_ids.push({
                                            ...pendenciaMorta, id: "PEND_" + Date.now() + "_RES",
                                            quantidade: res.qtd_remanescente, descricao: pendenciaMorta.descricao + " (SALDO)",
                                            herdado_de: pendenciaMorta.id
                                        });
                                    }
                                }
                            });
                        }

                        entidade.pendencias_ids = entidade.pendencias_ids.map(p => {
                            if (p.id.startsWith('TEMP-')) {
                                const novoId = p.id.replace('TEMP-', 'PEND-');
                                entidade.historico_vida.push({
                                    evento: "NOVA_PENDENCIA", id_pendencia: novoId, quem: p.autor_nome,
                                    data: p.data_criacao, detalhes: `${p.quantidade}un - ${p.descricao}`
                                });
                                return { ...p, id: novoId };
                            }
                            return p;
                        });

                        const temAlteracao = entidade.pendencias_ids.length > 0 || entidade.situacao === 'AVARIADO' || statusLocal.status === 'cautela_ciente';
                        const statusFinal = temAlteracao ? 'C/A' : 'S/A';
                        const quantidadeReal = entidade.quantidade || entidade.quantidadeEsperada || 1;

                        const dRel = {
                            id: uid, nomeCompleto: nomeParaRelatorio, status: statusFinal,
                            situacao_patrimonial: entidade.situacao || 'DISPON√çVEL',
                            pendencias_ids: [...entidade.pendencias_ids], quantidade: quantidadeReal,
                            setor: setor.nome, obs: entidade.pendencias_ids.map(p => `${p.quantidade}un: ${p.descricao}`).join(' | ')
                        };
                        itensRelatorio.push(dRel);
                        if (temAlteracao) { itensCaa.push(dRel); totalCaa++; }
                        return entidade;
                    };

                    if (item.tipo === 'multi' && item.tombamentos) {
                        item.tombamentos = item.tombamentos.map(t => processarEntidade(t, `${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`));
                    } else {
                        item = processarEntidade(item, item.id, item.nome);
                    }
                    return item;
                })
            };
        });

        const batch = db.batch();
        batch.update(db.collection(COLECAO_LISTAS).doc(LISTA_ID), { list: novaListaMestra });
        batch.set(db.collection('custodia_atual').doc(LISTA_ID), {
            lista_id: LISTA_ID, local_nome: localNome, conferente_uid: p.uid,
            conferente_completo: conferenteCompleto, timestamp_ultima_conferencia: timestampAgora
        }, { merge: true });
        batch.set(db.collection('resultados_conferencias').doc(), {
            local: localNome, lista_id: LISTA_ID, conferente_uid: p.uid, conferente: conferenteCompleto,
            timestamp: timestampAgora, totalItensConferidos: itensRelatorio.length,
            totalCaa: totalCaa, itensCaa: itensCaa, itensRelatorio: itensRelatorio
        });

        await batch.commit();
        alert("‚úÖ Confer√™ncia Finalizada com Sucesso!");
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
    } catch (e) {
        console.error("Erro fatal:", e);
        alert("Erro ao gravar dados: " + e.message);
        btn.disabled = false;
        btn.textContent = "FINALIZAR CONFER√äNCIA";
    }
}
        async function finalizarRecebimentoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();
            if (cData.destinatario_original_uid !== meuUid) {
                throw new Error("Apenas o destinat√°rio original pode assinar este recebimento.");
            }

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensConferidos = [];
            
            let temQualquerAlteracao = false;
            let linhasExtrato = [];

            cautela.itens.forEach((cItem, index) => {
                const uidBusca = cItem.tombamento ? `${cItem.id_base || cItem.id}-${cItem.tombamento}` : (cItem.id_base || cItem.id);
                const statusLocal = window.itemStatus[uidBusca] || {};
                
                const isItemOk = (statusLocal.status === 'ok' || statusLocal.status === 'S/A');
                const statusFinal = isItemOk ? 'S/A' : 'C/A';
                const obsFinal = statusLocal.obs || "";
                
                if (statusFinal === 'C/A') temQualquerAlteracao = true;

                itensConferidos.push({
                    ...cItem,
                    status_recebimento: statusFinal,
                    obs_recebimento: obsFinal
                });

                const identificador = cItem.tombamento ? `(Tomb.: ${cItem.tombamento})` : `(QTD: ${cItem.quantidade}UN)`;
                const relatoItem = isItemOk ? 'S/A' : (obsFinal || 'C/A sem obs.');
                linhasExtrato.push(`${index + 1}. ${cItem.nome} ${identificador}: ${relatoItem}`);

                // --- ATUALIZA√á√ÉO DA LISTA MESTRA ---
                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            // Registro no hist√≥rico de vida do item
                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push({
                                evento: "CONFIRMA√á√ÉO_RECEBIMENTO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                detalhes: statusFinal === 'C/A' ? `Avaria: ${obsFinal}` : "Recebido S/A."
                            });

                            const objetoCautelaAtualizado = {
                                id: CAUTELA_ID,
                                emitente: cData.emitente || "N/D",
                                destinatario: meuNomeCompleto,
                                data: cData.timestamp_emissao ? cData.timestamp_emissao.toDate().toLocaleDateString('pt-BR') : dataAtual,
                                status_item: statusFinal,
                                obs_item: obsFinal,
                                quantidade: Number(cItem.quantidade) || 1
                            };

                            // üõë CORRE√á√ÉO PARA ITEM SINGLE: Atualiza o existente em vez de dar push
                            if (mItem.tipo === 'single' && mItem.cautelas) {
                                const idxExistente = mItem.cautelas.findIndex(c => c.id === CAUTELA_ID);
                                if (idxExistente !== -1) {
                                    // Se j√° existe (carimbo de emiss√£o), apenas atualizamos os dados
                                    mItem.cautelas[idxExistente] = objetoCautelaAtualizado;
                                } else {
                                    // Se por algum motivo n√£o existia, a√≠ sim adicionamos
                                    mItem.cautelas.push(objetoCautelaAtualizado);
                                }
                            } 
                            // PARA ITEM MULTI: A sobrescrita j√° √© segura por natureza
                            else if (mItem.tipo === 'multi' && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        t.cautela = objetoCautelaAtualizado;
                                    }
                                    return t;
                                });
                            }
                        }
                        return mItem;
                    })
                }));
            });

            const icone = temQualquerAlteracao ? '‚ö†Ô∏è' : '‚úÖ';
            const tituloLog = `${icone} Recebido ${temQualquerAlteracao ? 'C/A' : 'S/A'} pelo destinat√°rio: ${meuNomeCompleto}`;
            const descricaoCompleta = `${tituloLog}\n${linhasExtrato.join('\n')}`;

            const logMovimentacao = {
                data: dataAtual,
                descricao: descricaoCompleta,
                militar: meuNomeCompleto
            };

            transaction.update(cautelaRef, {
                status: 'RECEBIDA',
                timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
                itens: itensConferidos,
                militar_completo_receptor: meuNomeCompleto,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(logMovimentacao)
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Recebimento confirmado!`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (error) {
        console.error("Erro ao receber cautela:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO";
        btn.disabled = false;
    }
}
      async function finalizarDevolucaoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = 'Processando...';
    btn.disabled = true;

    try {
        // Pega as informa√ß√µes do militar logado (quem est√° devolvendo)
        const userInfo = await getLoggedUser(); 
        
        if (!userInfo) {
            alert("Erro: Dados do militar logado n√£o encontrados.");
            btn.textContent = 'ERRO AO FINALIZAR';
            btn.disabled = false;
            return;
        }

        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);

        // üõë CR√çTICO: Executa a Transa√ß√£o no Firebase üõë
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(cautelaRef);

            if (!doc.exists || doc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela n√£o encontrada ou n√£o est√° no status 'RECEBIDA'.");
            }
            
            // 1. A√ß√£o: Mudar o status da cautela para CONCLUIDA.
            transaction.update(cautelaRef, { 
                status: 'CONCLUIDA', // Status final
                timestamp_devolucao: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem est√° devolvendo (Militar Logado)
                reversor: userInfo.nomeGuerra, 
                militar_completo_reversor: `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`,
                
                // Quem est√° recebendo de volta (√öltimo Conferente)
                destinatario_final_devolucao: DESTINATARIO_DEVOLUCAO,
            });
            
            // 2. A√ß√£o: Registrar o hist√≥rico de confer√™ncia final (opcional, mas recomendado)
            // Se necess√°rio, voc√™ pode adicionar um novo documento na sua cole√ß√£o de hist√≥rico.
        }); // Fim da Transa√ß√£o

        alert(`‚úÖ Devolu√ß√£o da Cautela ${CAUTELA_ID} conclu√≠da e status atualizado para \"CONCLUIDA\".`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro CR√çTICO ao finalizar devolu√ß√£o:", error);
        alert(`Erro ao finalizar devolu√ß√£o. Nenhum dado foi alterado. Erro: ${error.message}`);
        btn.textContent = "ERRO AO FINALIZAR";
        btn.disabled = false;
    }
}
       async function finalizarRecebimentoDevolucao(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    // üõ°Ô∏è CAPTURA CIR√öRGICA DO ID DA LISTA
    const listaId = cautela.local_origem_id || urlParams.get('lista_origem');

    if (!CAUTELA_ID || !listaId) {
        console.error("IDs ausentes:", { CAUTELA_ID, listaId });
        alert("Erro Cr√≠tico: N√£o foi poss√≠vel identificar a lista de origem para reintegrar o material.");
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) { alert("Sess√£o expirada."); btn.disabled = false; return; }

    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");
            
            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra original n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensDevolvidos = [];

            // --- üõë CONSTRU√á√ÉO DO EXTRATO DETALHADO DE DEVOLU√á√ÉO üõë ---
            let temQualquerAlteracao = false;
            let linhasExtrato = [];

            cautela.itens.forEach((cItem, index) => {
                const uidBusca = cItem.tombamento ? `${cItem.id_base || cItem.id}-${cItem.tombamento}` : (cItem.id_base || cItem.id);
                const statusLocal = window.itemStatus[uidBusca];
                
                const statusFinal = statusLocal?.status === 'ok' ? 'S/A' : 'C/A';
                const obsFinal = statusLocal?.obs || "";

                if (statusFinal === 'C/A') temQualquerAlteracao = true;

                itensDevolvidos.push({
                    ...cItem, status_devolucao: statusFinal, obs_devolucao: obsFinal
                });

                // Monta a linha do extrato para o hist√≥rico
                const identificador = cItem.tombamento ? `(Tomb.: ${cItem.tombamento})` : `(QTD: ${cItem.quantidade}UN)`;
                const relatoItem = statusFinal === 'S/A' ? 'S/A' : (obsFinal || 'C/A sem obs.');
                linhasExtrato.push(`${index + 1}. ${cItem.nome} ${identificador}: ${relatoItem}`);

                // Reinclui o material no Estoque (Lista Mestra)
                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        if ((mItem.id_base || mItem.id) === (cItem.id_base || cItem.id)) {
                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push({
                                evento: "RETORNO_DEVOLUCAO", 
                                id_doc: CAUTELA_ID, 
                                quem: meuNomeCompleto,
                                data: dataAtual, 
                                estado_retorno: statusFinal, 
                                detalhes: statusFinal === 'C/A' ? `Retorno com avaria: ${obsFinal}` : "Retorno em perfeito estado (S/A)."
                            });

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) delete t.cautela;
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = mItem.cautelas.filter(c => c.id !== CAUTELA_ID);
                            }
                        }
                        return mItem;
                    })
                }));
            });

            // Finaliza o T√≠tulo e o Corpo do Log de Movimenta√ß√£o
            const icone = temQualquerAlteracao ? '‚ö†Ô∏è' : '‚úÖ';
            const tituloLog = `${icone} Devolu√ß√£o recebida ${temQualquerAlteracao ? 'C/A' : 'S/A'} pelo detentor: ${meuNomeCompleto}`;
            const descricaoCompleta = `${tituloLog}\n${linhasExtrato.join('\n')}`;

            const logMovimentacao = {
                data: dataAtual,
                descricao: descricaoCompleta,
                militar: meuNomeCompleto
            };

            transaction.update(cautelaRef, { 
                status: 'CONCLU√çDA', 
                timestamp_conclusao: firebase.firestore.FieldValue.serverTimestamp(),
                receptor_final_completo: meuNomeCompleto, 
                itens: itensDevolvidos,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(logMovimentacao)
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert("‚úÖ Devolu√ß√£o finalizada e estoque atualizado!");
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
    } catch (error) {
        console.error("Erro na transa√ß√£o:", error);
        alert(`Erro: ${error.message}`);
        btn.disabled = false;
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
    }
}
// --- NOVAS FUN√á√ïES DE CONTROLE DE IDS √öNICOS ---

function abrirFormNovoID(uid, tipo, nomeItem, saldo, tombReal = "") {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const grupoQtd = document.getElementById('modal-grupo-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const infoMax = document.getElementById('modal-info-max');
    const subtitulo = document.getElementById('modal-subtitulo-detalhe');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');
    
    document.getElementById('modal-acao-objetivo').value = "incluir";
    inputObs.value = '';
    document.getElementById('modal-uid').value = uid;
    document.getElementById('modal-tipo').value = tipo;
    
    const nomeLimpo = nomeItem.replace(/\\'/g, "'");
    document.getElementById('modal-titulo-item').innerText = nomeLimpo;
    document.getElementById('modal-label-obs').innerText = "Descri√ß√£o do Problema:";
    document.getElementById('modal-label-qtd').innerText = "Quantidade Alterada:";
    inputObs.placeholder = "Descreva o problema...";

    btnConfirmar.innerText = "INCLUIR";
    btnConfirmar.style.backgroundColor = "#800020";
    document.querySelector('.modal-content').style.borderTopColor = "#d90f23";

    if (tipo === 'multi') {
        subtitulo.innerHTML = `Refer√™ncia Tomb.: <span style="color:#d90f23; font-weight:bold;">${tombReal}</span>`;
        grupoQtd.style.setProperty('display', 'none', 'important');
        inputQtd.value = 1;
        inputQtd.max = 1;
    } else {
        subtitulo.innerHTML = ""; 
        grupoQtd.style.setProperty('display', 'block', 'important');
        const saldoReal = parseInt(saldo) || 0;
        inputQtd.max = saldoReal;
        inputQtd.value = 1;
        infoMax.innerText = `Saldo total dispon√≠vel: ${saldoReal}`;
        
        if (saldoReal <= 0) {
            alert("Este item n√£o possui saldo dispon√≠vel para altera√ß√£o.");
            return;
        }
    }

    modal.style.display = 'flex';
    setTimeout(() => { if(inputObs) inputObs.focus(); }, 150);
}

function fecharModalPendencia() {
    const modal = document.getElementById('modal-nova-pendencia');
    if (modal) {
        modal.style.display = 'none';
        document.getElementById('modal-input-obs').value = '';
    }
}

function abrirModalResolver(pendenciaId, uid, qtdOriginal, descricaoOriginal) {
    const modal = document.getElementById('modal-nova-pendencia');
    const inputQtd = document.getElementById('modal-input-qtd');
    const inputObs = document.getElementById('modal-input-obs');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');
    
    if (!modal) return console.error("Modal n√£o encontrado no DOM");

    // Configura√ß√£o de Identidade para RESOLU√á√ÉO
    document.getElementById('modal-acao-objetivo').value = "resolver";
    document.getElementById('modal-uid').value = uid;
    document.getElementById('modal-tipo').value = pendenciaId; 

    // Ajuste de Textos
    document.getElementById('modal-titulo-item').innerText = "Resolver Altera√ß√£o";
    document.getElementById('modal-subtitulo-detalhe').innerHTML = `Relato original: <b>"${descricaoOriginal}"</b>`;
    document.getElementById('modal-label-obs').innerText = "Justificativa da Resolu√ß√£o:";
    document.getElementById('modal-label-qtd').innerText = "Unidades Resolvidas:";
    inputObs.placeholder = "Diga como foi resolvido (ex: reposto, consertado)...";
    inputObs.value = '';

    // Ajuste de Quantidade
    document.getElementById('modal-grupo-qtd').style.setProperty('display', 'block', 'important');
    inputQtd.max = qtdOriginal;
    inputQtd.value = qtdOriginal;
    document.getElementById('modal-info-max').innerText = `Total que estava pendente: ${qtdOriginal} un.`;

    // Est√©tica Verde
    btnConfirmar.innerText = "CONFIRMAR SOLU√á√ÉO";
    btnConfirmar.style.backgroundColor = "#1b8a3e"; 
    document.querySelector('.modal-content').style.borderTopColor = "#1b8a3e";

    modal.style.display = 'flex';
    setTimeout(() => { if(inputObs) inputObs.focus(); }, 150);
}

function processarAcaoFinalModal() {
    const objetivo = document.getElementById('modal-acao-objetivo').value;
    const uid = document.getElementById('modal-uid').value;
    const qtd = document.getElementById('modal-input-qtd').value;
    const obs = document.getElementById('modal-input-obs').value;
    const tipoOuPendenciaId = document.getElementById('modal-tipo').value;

    if (obs.trim().length < 5) {
        return alert("Descri√ß√£o muito curta.");
    }

    if (objetivo === "editar") {
        executarEdicaoRelato(tipoOuPendenciaId, uid, qtd, obs);
    } else if (objetivo === "resolver") {
        resolverID(tipoOuPendenciaId, uid, qtd, obs);
    } else {
        salvarNovoID(uid, qtd, tipoOuPendenciaId, obs);
    }
    
    fecharModalPendencia();
}
    function executarEdicaoRelato(pendenciaId, uid, novaQtd, novaObs) {
    const fonteDados = window.dadosConferencia || dadosConferencia;
    let editado = false;

    // Garantimos que estamos comparando Strings para evitar erro de tipo
    const idProcurado = String(pendenciaId);

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            // Criamos uma lista de alvos (o pr√≥prio item ou a lista de tombamentos dele)
            let alvosParaVerificar = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            
            alvosParaVerificar.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    // Tenta encontrar a pend√™ncia exata dentro do array do item/tombamento
                    const p = alvo.pendencias_ids.find(pend => String(pend.id) === idProcurado);
                    
                    if (p) {
                        p.descricao = novaObs;
                        p.quantidade = parseInt(novaQtd) || 0;
                        editado = true;
                    }
                }
            });
        });
    });

    if (editado) {
        // ESSENCIAL: Redesenha a tela para refletir a mudan√ßa no "carimbo"
        renderizarConferencia(); 
        
        // Feedback visual para o usu√°rio localizar onde editou
        setTimeout(() => {
            const el = document.getElementById(`card-${pendenciaId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.backgroundColor = "#e3f2fd"; // Pisca em azul claro
                setTimeout(() => { el.style.backgroundColor = "#fff"; }, 1000);
            }
        }, 300);
    } else {
        console.error("Erro: Pend√™ncia " + idProcurado + " n√£o encontrada nos dados.");
        alert("Erro ao salvar: N√£o foi poss√≠vel localizar o registro original para altera√ß√£o.");
    }
}
   function confirmarExclusaoRelato(pendenciaId, uid) {
    if (!confirm("Deseja realmente apagar esta pend√™ncia?")) return;

    const fonteDados = window.dadosConferencia || dadosConferencia;
    let excluido = false;
    
    // Convertemos para String para garantir que "TEMP-123" seja comparado corretamente
    const idProcurado = String(pendenciaId);

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            // Define os alvos (item ou lista de tombamentos)
            let alvos = (item.tipo === 'multi' && item.tombamentos) ? item.tombamentos : [item];
            
            alvos.forEach(alvo => {
                if (alvo.pendencias_ids && Array.isArray(alvo.pendencias_ids)) {
                    // Buscamos o √≠ndice comparando as Strings brutas
                    const index = alvo.pendencias_ids.findIndex(p => String(p.id) === idProcurado);
                    
                    if (index > -1) {
                        alvo.pendencias_ids.splice(index, 1);
                        excluido = true;
                        
                        // Se n√£o houver mais nada relatado, o item volta a ser "pendente" (cinza)
                        if (alvo.pendencias_ids.length === 0) {
                            delete window.itemStatus[uid]; 
                        }
                    }
                }
            });
        });
    });

    if (excluido) {
        // ESSENCIAL: Redesenha a tela. Como o item sumiu do Array, 
        // a renderiza√ß√£o n√£o vai mais criar o carimbo.
        renderizarConferencia(); 
        updateOverallStatus();
        console.log("Sucesso: Relato tempor√°rio removido:", idProcurado);
    } else {
        console.error("N√£o localizei o ID:", idProcurado);
        alert("Erro: N√£o foi poss√≠vel localizar este carimbo para exclus√£o.");
    }
}
    
function salvarNovoID(uid, qtd, tipo, obsModal = null) {
    const obsDigitada = obsModal ? obsModal.trim() : "";
    const qtdInformada = parseInt(qtd) || 1;

    const militarInfoEl = document.getElementById('militar-info');
    let nomeAssinatura = militarInfoEl ? militarInfoEl.innerText.split('\n')[0].replace('Conferente:', '').trim() : "";
    
    if (!nomeAssinatura) {
        nomeAssinatura = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    }

    const novoID = {
        id: "TEMP-" + Date.now(),
        tipo: "PENDENCIA",
        data_criacao: new Date().toLocaleDateString('pt-BR'),
        autor_uid: userInfo.uid,
        autor_nome: nomeAssinatura,
        descricao: obsDigitada,
        quantidade: qtdInformada,
        status_gestao: "PENDENTE"
    };

    let itemEncontrado = false;
    let elementoPaiAlvo = null;
    const fonteDados = window.dadosConferencia || dadosConferencia;

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            if (tipo === 'single' && String(item.id) === String(uid)) {
                if (!item.pendencias_ids) item.pendencias_ids = [];
                item.pendencias_ids.push(novoID);
                itemEncontrado = true;
            } else if (tipo === 'multi' && item.tombamentos) {
                item.tombamentos.forEach(t => {
                    if (String(`${item.id}-${t.tomb}`) === String(uid)) {
                        if (!t.pendencias_ids) t.pendencias_ids = [];
                        t.pendencias_ids.push(novoID);
                        itemEncontrado = true;
                        elementoPaiAlvo = document.querySelector(`[data-id="${item.id}"]`);
                    }
                });
            }
        });
    });

    if (itemEncontrado) {
        // üõë AJUSTE CIR√öRGICO PARA O EXTRATO DETALHADO üõë
        // Mantemos o seu status original e apenas injetamos a 'obs' para leitura posterior
        window.itemStatus[uid] = { 
            status: 'C/A', 
            interacao_humana: true,
            obs: obsDigitada // ‚¨ÖÔ∏è Isso permite que o log de cautela capture a descri√ß√£o
        };
        
        renderizarConferencia();
        
        if (elementoPaiAlvo) {
            updateItemMainStatusDisplay(elementoPaiAlvo);
        }

        setTimeout(() => {
            let el = document.querySelector(`[data-id="${uid}"]`) || document.querySelector(`.tombamento-container[data-id="${uid}"]`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.backgroundColor = "#fff9c4";
                setTimeout(() => { el.style.backgroundColor = ""; }, 1000);
            }
        }, 300);
    }
}

function manterID(pendenciaId, uid) {
    if (!window.itemStatus[uid]) {
        window.itemStatus[uid] = { status: 'pending' };
    }
    
    if (!window.itemStatus[uid].ids_mantidos) {
        window.itemStatus[uid].ids_mantidos = [];
    }
    
    if (!window.itemStatus[uid].ids_mantidos.includes(pendenciaId)) {
        window.itemStatus[uid].ids_mantidos.push(pendenciaId);
    }
    
    window.itemStatus[uid].status = 'C/A';
    // üõë MARCA√á√ÉO CIR√öRGICA: Registra que o conferente interagiu com este item
    window.itemStatus[uid].interacao_humana = true;

    renderizarConferencia();
    updateOverallStatus();
    
    setTimeout(() => {
        const el = document.getElementById(`card-${pendenciaId}`);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function resolverID(pendenciaId, uid, qtdResolvidaModal, justificativaModal) {
    const qtdResolvida = parseInt(qtdResolvidaModal) || 1;
    const justificativa = justificativaModal ? justificativaModal.trim() : "";
    const nomeResolutor = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;

    const fonteDados = window.dadosConferencia || dadosConferencia;
    let acaoConcluida = false;

    const isResolvendoAvaria = String(pendenciaId).startsWith('AVARIA-');

    function executarBaixaNoObjeto(obj) {
        if (isResolvendoAvaria) {
            if (!obj.historico_vida) obj.historico_vida = [];
            obj.historico_vida.push({
                tipo: "RESOLU√á√ÉO_AVARIA_CAUTELA",
                data: new Date().toLocaleDateString('pt-BR'),
                resolvido_por: nomeResolutor,
                justificativa: justificativa,
                cautela_origem: pendenciaId.replace('AVARIA-', '')
            });
            obj.situacao = "DISPON√çVEL"; 
            obj.status = "OK";
            delete obj.id_cautela_origem;
            delete obj.motivo_avaria;
            return true;
        }

        if (!obj.pendencias_ids) return false;
        const index = obj.pendencias_ids.findIndex(p => p.id === pendenciaId);
        if (index === -1) return false;

        const pOriginal = obj.pendencias_ids[index];
        const qtdAnterior = pOriginal.quantidade;

        if (!obj.historico_vida) obj.historico_vida = [];
        
        const registroHistorico = {
            ...pOriginal,
            id_referencia: pOriginal.id,
            id: pOriginal.id + "-RES-" + Date.now(),
            quantidade: qtdResolvida,
            data_resolucao: new Date().toLocaleDateString('pt-BR'),
            resolvido_por: nomeResolutor,
            justificativa_resolucao: justificativa,
            status_final: "RESOLVIDO"
        };

        if (qtdResolvida >= qtdAnterior) {
            obj.pendencias_ids.splice(index, 1);
        } else {
            pOriginal.quantidade -= qtdResolvida;
            registroHistorico.justificativa_resolucao += " (Resolu√ß√£o Parcial)";
        }

        obj.historico_vida.push(registroHistorico);
        return true;
    }

    fonteDados.forEach(setor => {
        setor.itens.forEach(item => {
            if (String(item.id) === String(uid)) {
                acaoConcluida = executarBaixaNoObjeto(item);
            } else if (item.tombamentos) {
                item.tombamentos.forEach(t => {
                    if (String(`${item.id}-${t.tomb}`) === String(uid)) {
                        acaoConcluida = executarBaixaNoObjeto(t);
                    }
                });
            }
        });
    });

    if (acaoConcluida) {
        if (!window.itemStatus[uid]) window.itemStatus[uid] = {};
        window.itemStatus[uid].status = 'C/A';
        // üõë MARCA√á√ÉO CIR√öRGICA: Registra que o conferente interagiu com este item
        window.itemStatus[uid].interacao_humana = true;
        
        if (window.itemStatus[uid].ids_mantidos) {
            window.itemStatus[uid].ids_mantidos = window.itemStatus[uid].ids_mantidos.filter(id => id !== pendenciaId);
        }

        renderizarConferencia();
        updateOverallStatus();

        setTimeout(() => {
            let elItem = document.querySelector(`[data-id="${uid}"]`) || document.querySelector(`.tombamento-container[data-id="${uid}"]`);
            if (elItem) {
                elItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                elItem.style.backgroundColor = "#e8f5e9"; 
                setTimeout(() => { elItem.style.backgroundColor = ""; }, 1000);
            }
        }, 300);
    }
}
function setItemStatusID(btn, status, uid) {
    const container = btn.closest('.tombamento-container') || btn.closest('.item-conferencia');
    const setor = btn.closest('.setor');
    const itemPai = btn.closest('.item-conferencia');

    if (!window.itemStatus[uid]) window.itemStatus[uid] = {};

    if (status === 'ok') {
        // üõë MARCA√á√ÉO CIR√öRGICA: Registra intera√ß√£o no clique do S/A
        window.itemStatus[uid] = { ...window.itemStatus[uid], status: 'ok', interacao_humana: true };

        container.querySelectorAll('.action-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (itemPai) {
            if (itemPai.classList.contains('item-has-tombamentos')) {
                updateItemMainStatusDisplay(itemPai);
            } else {
                itemPai.classList.remove('status-alert');
                itemPai.classList.add('status-ok');
                const icon = itemPai.querySelector('.status-icon');
                if (icon) icon.className = 'status-icon ok';
            }
        }
    } else if (status === 'cautela_ciente') {
        window.itemStatus[uid] = { ...window.itemStatus[uid], status: 'cautela_ciente', cautela_confirmada: true, interacao_humana: true };
        btn.innerHTML = '<i class="fas fa-check"></i> Ciente registrado';
        btn.disabled = true;
        btn.style.backgroundColor = "#1b8a3e";
        
        setTimeout(() => {
            renderizarConferencia();
            updateOverallStatus();
        }, 400);
    }

    updateOverallStatus();
    if (setor) updateSetorStatus(setor);

    if (setor && typeof checkSetorCompletion === 'function') { 
        checkSetorCompletion(setor, uid);
    }
}
    async function verExtratoCautela(cautelaId) {
    if (!cautelaId) return;
    try {
        const doc = await db.collection('cautelas_abertas').doc(cautelaId).get();
        if (!doc.exists) return alert("Cautela n√£o encontrada.");

        const data = doc.data();
        
        const html = `
            <div id="extrato-wrapper" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 29999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                <div style="position: relative; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 15px; z-index: 30000; width: 85%; max-width: 320px; border-top: 4px solid #f57c00; font-family: Arial, sans-serif;" onclick="event.stopPropagation()">
                    <h4 style="margin:0 0 10px 0; color:#800020; font-size:1em; border-bottom:1px solid #eee; padding-bottom:5px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-eye"></i> Detalhes da Cautela
                    </h4>
                    <p style="font-size:0.85em; margin:8px 0; color: #333;"><b>Emitente:</b><br>${data.emitente}</p>
                    
                    <p style="font-size:0.85em; margin:12px 0; color: #333; display: flex; align-items: center; gap: 8px;">
                        <b>Status:</b> 
                        <span style="background: #f57c00; color: white; padding: 3px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85em; text-transform: uppercase;">
                            ${data.status}
                        </span>
                    </p>

                    <p style="font-size:0.85em; margin:10px 0 5px 0; color: #333;"><b>Observa√ß√£o:</b></p>
                    <div style="font-size:0.8em; background:#f9f9f9; padding:8px; border-radius:4px; font-style:italic; color:#555; max-height:100px; overflow-y:auto; border: 1px solid #eee; line-height: 1.4;">
                        ${data.observacoes_emissao || 'Sem observa√ß√µes.'}
                    </div>
                    <button onclick="document.getElementById('extrato-wrapper').remove()" style="width:100%; margin-top:15px; padding:10px; background:#800020; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; text-transform: uppercase; font-size: 0.8em;">Fechar</button>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    } catch (e) { console.error(e); }
}
    window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
