<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="sigma-comum.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box; }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold; } 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333; text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        
        /* SETORES E ITENS */
        .setor-header { background-color: #800020; color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s; }
        .setor-info { display: flex; align-items: center; gap: 10px; }
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px; border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e; }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .arrow { font-size: 1.2em; transition: transform 0.4s; }
        
        .item-conferencia { border: 1px solid #e0e0e0; border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease; }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0; }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0; }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1; }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD; } 
        
        .item-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap; }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left; font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold; flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold; font-size: 0; padding: 0; width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '‚úì'; font-size: 12px; line-height: 18px; color: white; display: block; text-align: center; }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A'; font-size: 10px; line-height: 18px; color: white; display: block; text-align: center; }
        
        .item-options { display: flex; justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0; }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333; }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e; } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        /* ESTILOS PEND√äNCIAS */
        .pendencia-alert-box { font-size: 0.85em; margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s; }
        .pendencia-alert-box.admin-reply { border-left-color: #2196F3; background-color: #e3f2fd; }
        .pendencia-alert-box.kept { border-left-color: #1b8a3e; background-color: #f0fff0; opacity: 0.9; }
        
        .lista-pendencias { list-style: none; padding: 0; margin: 5px 0; }
        .lista-pendencias li { margin-bottom: 6px; display: block; padding-left: 5px; text-align: left; line-height: 1.3; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
        .lista-pendencias li:last-child { border-bottom: none; }
        
        .texto-admin { font-weight: bold; color: #0d47a1; }
        .linha-obs { color: #333; font-weight: 500; }
        
        .pendencia-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px; }
        .btn-manter { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; } 
        .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        .historico-fixo { background-color: #eeeeee; border: 1px solid #ccc; color: #555; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 5px; font-style: italic; display: none; }
        .tombamento-container { border-top: 1px dotted #eee; margin-top: 5px; padding-top: 5px; text-align: left; padding-bottom: 5px; }
        .tombamento-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .tombamento-options { display: flex; gap: 5px; } .tombamento-options .action-button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23; display: none; text-align: left; }
        .tombamento-obs-container label, .alteracao-container label { display: block; margin-bottom: 5px; font-weight: bold; color: #d90f23; font-size: 0.85em; }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px; }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em; }
        .descricao-salva, .tombamento-descricao-salva { font-size: 0.9em; margin-top: 5px; display: none; padding-top: 5px; border-top: 1px dashed #ddd; text-align: left; background-color: #fff8f8; padding: 8px; border-radius: 4px; }
        
        #btn-finalizar { background-color: #d90f23; color: white; font-weight: bold; border: none; padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease; margin-top: 30px; font-size: 1.1em; box-shadow: 0 4px 8px rgba(217, 15, 35, 0.4); }
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; }
        
        .draft-badge { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 0.9em; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Confer√™ncia de Materiais</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Local...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do conferente...</p>
        <div id="draft-message" class="draft-badge"><strong>Rascunho recuperado:</strong> Voc√™ est√° continuando de onde parou.</div>
        <div id="loading-message" class="loading-message">Inicializando sistema...</div>
        <div id="main-content" style="display: none;">
            <button id="btn-finalizar" onclick="finalizarConferencia()" disabled>
    FINALIZAR CONFER√äNCIA (0/X ITENS)
</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", 
        authDomain: "sigma-cbmrr.firebaseapp.com", 
        projectId: "sigma-cbmrr", 
        storageBucket: "sigma-cbmrr.firebasestorage.app", 
        messagingSenderId: "378026276038", 
        appId: "1:378026276038:web:620dd6ff57501b1a8313c7" 
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const LISTA_ID = urlParams.get('id');
    const COLECAO_LISTAS = 'listas_conferencia';
    const COLECAO_CAUTELAS = 'cautelas_abertas';
    
    let MODO_OPERACAO = 'recebimento'; 
    let DESTINATARIO_DEVOLUCAO = null; 
    
    const CAUTELA_ID = urlParams.get('cautelaId');
    const modoParam = urlParams.get('modo');
    const USER_UID = urlParams.get('user_uid');

    if (modoParam === 'devolucao') {
        MODO_OPERACAO = 'devolucao';
        DESTINATARIO_DEVOLUCAO = urlParams.get('destinatarioDevolucao');
    } else if (modoParam === 'devolucao_final') {
        MODO_OPERACAO = 'devolucao_final';
    }

    let dadosConferencia = [];
    let isCautela = !!CAUTELA_ID;
    let infoLocal = { nome: '', posto: '' }; 
    window.itemStatus = {};

    function getUrlParameter(n) { 
        return (new URLSearchParams(window.location.search)).get(n) || ''; 
    }
    
    const userInfo = { 
        postoGraduacao: getUrlParameter('posto_grad') || "ND", 
        quadro: getUrlParameter('quadro_mil') || "ND", 
        nomeGuerra: getUrlParameter('nome_guerra') || "ND",
        uid: USER_UID || "ND"
    };

    function formatarDataSimples(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('pt-BR');
    }

    function updateHeaderInfo() {
        const el = document.getElementById('militar-info');
        if(el) el.innerHTML = `<strong>Conferente:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`;
    }

    function updateOverallStatus() {
        let total = 0, completed = 0;
        document.querySelectorAll('.setor').forEach(s => {
            total += parseInt(s.dataset.totalItems || 0);
            completed += parseInt(s.querySelector('.setor-status').dataset.completed || 0);
        });
        const btn = document.getElementById('btn-finalizar');
        
        let buttonPrefix = 'FINALIZAR CONFER√äNCIA';
        // MODO_OPERACAO √© global e foi definido no in√≠cio do script
        if (typeof MODO_OPERACAO !== 'undefined' && MODO_OPERACAO === 'devolucao') {
            buttonPrefix = 'FINALIZAR DEVOLU√á√ÉO';
        }
        
        if(btn) {
            // Altera a linha original para usar o prefixo condicional
            // A contagem (completed/total) √© mantida.
            btn.textContent = `${buttonPrefix} (${completed}/${total} ITENS)`;

            if (total > 0 && completed >= total) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
        
        if(btn) {
            if (total > 0 && completed >= total) {
                btn.disabled = false;
                btn.style.backgroundColor = '#1b8a3e';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.backgroundColor = '#d90f23';
                btn.style.cursor = 'not-allowed';
            }
        }
    }

        function updateSetorStatus(setorEl) { 
            const items = setorEl.querySelectorAll('.item-conferencia'); 
            let completed = 0, total = 0; 
            items.forEach(item => { 
                if (item.dataset.type === 'single') { 
                    total++; const s = window.itemStatus[item.dataset.id]?.status; 
                    if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                } else { 
                    const tombs = item.querySelectorAll('.tombamento-container'); 
                    tombs.forEach(t => { 
                        total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                        if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                    }); 
                } 
            }); 
            setorEl.dataset.totalItems = total; 
            const st = setorEl.querySelector('.setor-status'); 
            st.dataset.completed = completed; 
            if (completed === total && total > 0) { st.textContent = 'OK'; st.classList.add('ok'); } 
            else { st.textContent = `${completed}/${total}`; st.classList.remove('ok'); } 
        }

        function updateItemMainStatusDisplay(item) { 
            if (item.dataset.type === 'single') return; 
            const tombs = item.querySelectorAll('.tombamento-container'); let conf = 0, alt = 0; 
            tombs.forEach(t => { 
                const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                if (s === 'S/A' || s === 'C/A' || s === 'KEEP') { conf++; if (s === 'C/A' || s === 'KEEP') alt++; } 
            }); 
            const icon = item.querySelector('.status-icon'); item.className = 'item-conferencia item-has-tombamentos'; icon.className = 'status-icon'; 
            if (conf === tombs.length) { 
                if (alt > 0) { icon.classList.add('alert'); item.classList.add('status-alert'); } 
                else { icon.classList.add('ok'); item.classList.add('status-ok'); } 
            } 
        }

        function toggleSetor(header) { 
            const content = header.nextElementSibling; const arrow = header.querySelector('.arrow'); 
            if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '‚ñ∫'; } 
            else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='‚ñ∫';}); content.classList.add('expanded'); arrow.textContent = '‚ñº'; } 
        }

        function checkSetorCompletion(currentSetor, currentItemId) { 
            const total = parseInt(currentSetor.dataset.totalItems); const comp = parseInt(currentSetor.querySelector('.setor-status').dataset.completed); 
            if (comp >= total) { autoAdvanceSetor(currentSetor.dataset.id); } else { focusNextItem(currentItemId); }
        }

        function focusNextItem(currentItemId) { 
            const allItems = Array.from(document.querySelectorAll('.item-conferencia')); 
            let baseId = currentItemId.split('-')[0]; 
            const idx = allItems.findIndex(i => i.dataset.id === baseId); 
            for (let i = idx; i < allItems.length; i++) { 
                const item = allItems[i]; if (!item) continue; const id = item.dataset.id; 
                if (item.dataset.type === 'single') { 
                    const st = window.itemStatus[id]; 
                    if (!st || st.status === 'pending' || st.status === 'PENDING_CA') { 
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        if (st && st.status === 'PENDING_CA') item.querySelector('textarea').focus(); return; 
                    } 
                } 
                if (item.dataset.type === 'multi') { 
                    const pendingTomb = Array.from(item.querySelectorAll('.tombamento-container')).find(t => { 
                        const uid = `${id}-${t.dataset.tomb}`; const s = window.itemStatus[uid]?.status; return s === 'pending' || s === 'PENDING_CA'; 
                    }); 
                    if (pendingTomb) { 
                        pendingTomb.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        const uid = `${id}-${pendingTomb.dataset.tomb}`; 
                        if (window.itemStatus[uid]?.status === 'PENDING_CA') pendingTomb.querySelector('textarea').focus(); return; 
                    } 
                } 
            } 
        }

        function autoAdvanceSetor(sid) { 
            const s = document.querySelector(`.setor[data-id="${sid}"]`); 
            if (s) toggleSetor(s.querySelector('.setor-header')); 
            const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1]; 
            if (nextId) { 
                const next = document.querySelector(`.setor[data-id="${nextId}"]`); 
                if (next) { const h = next.querySelector('.setor-header'); toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' }); } 
            } 
        }
        function isElementInViewport(el) { const rect = el.getBoundingClientRect(); return (rect.top >= 60 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        function getStorageKey() { return `sigma_draft_${LISTA_ID}_${userInfo.nomeGuerra}`; }
        function salvarRascunho() { try { localStorage.setItem(getStorageKey(), JSON.stringify({ timestamp: Date.now(), status: window.itemStatus })); } catch (e) {} }
        function limparRascunho() {
            localStorage.removeItem('sigma_active_conf');
            const listId = CAUTELA_ID || LISTA_ID; // Pega o ID da lista ou cautela
            const userId = (userInfo && userInfo.nomeGuerra) 
            ? userInfo.nomeGuerra.toUpperCase() 
            : null;

            if (listId && userId) {
                // Esta chave DEVE ser a mesma usada na fun√ß√£o salvarRascunho()
                const draftKey = `sigma_draft_${userId}_${listId}`; 
                localStorage.removeItem(draftKey);
                console.log(`Rascunho local (${draftKey}) limpo com sucesso.`);
            }
        }

       // --- 1. FUN√á√ÉO PARA LER DADOS ANTIGOS (LEGADOS) ---
const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
    const separator = ' | + NOVA: ';
    if (typeof textoBruto !== 'string') return [];
    
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
            if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
        if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
    }
    return linhas;
};

// --- 2. FUN√á√ÉO VISUAL √öNICA (SEM HORAS VIA REGEX) ---
const gerarHtmlVisualApp = (pendencia, autorAtual, dataAtual, adminStatus, adminObs) => {
    let html = '<ul class="lista-pendencias" style="list-style: none; padding: 0; margin: 5px 0;">';
    
    // 1. L√ìGICA PARA A NOVA ESTRUTURA DE LISTA (Array pendencias_ca)
    if (pendencia && pendencia.pendencias_ca && Array.isArray(pendencia.pendencias_ca)) {
        pendencia.pendencias_ca.forEach(p => {
            const militar = p.quem || 'Militar';
            const dataFull = p.data || '';
            
            // REGEX: Captura apenas DD/MM/AAAA e ignora o resto
            const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
            const dataApenas = matchData ? matchData[0] : dataFull;

            html += `
                <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px;">
                    <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                    <b>Por </b>
                    <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                    <span> em <b>${dataApenas}</b>:</span>
                    <i style="margin-left: 5px; color: #333; font-weight: normal; display: block; padding-left: 25px;">${p.obs}</i>
                </li>`;
        });
    } 
    // 2. FALLBACK PARA O FORMATO DE OBJETO √öNICO (Para n√£o quebrar itens antigos)
    else if (typeof pendencia === 'object' && pendencia !== null && pendencia.obs) {
        const militar = pendencia.quem || autorAtual || 'Militar';
        const dataFull = pendencia.data || dataAtual || '';
        const matchData = dataFull.match(/\d{2}\/\d{2}\/\d{4}/);
        const dataApenas = matchData ? matchData[0] : dataFull;

        html += `
            <li class="linha-obs" style="margin-bottom: 8px; line-height: 1.4; text-align: left; font-size: 0.9rem;">
                <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                <b>Por </b>
                <span style="color: #d90f23; font-weight: bold;">${militar}</span>
                <span> em <b>${dataApenas}</b>:</span>
                <i style="margin-left: 5px; color: #333; font-weight: normal;">${pendencia.obs}</i>
            </li>`;
    }
    // 3. FALLBACK PARA STRINGS LEGADAS
    else if (typeof pendencia === 'string' && pendencia.trim() !== '' && pendencia !== '-') {
        const linhas = typeof gerarLinhasFormatadas === 'function' ? gerarLinhasFormatadas(pendencia, autorAtual, dataAtual, adminStatus, adminObs) : [pendencia];
        linhas.forEach(l => {
            html += `<li class="linha-obs" style="margin-bottom: 5px;"><span style="margin-right: 8px;">‚ö†Ô∏è</span>${l}</li>`;
        });
    }

    html += '</ul>';
    return html;
};

// --- 3. FUN√á√ÉO DE RENDERIZA√á√ÉO DA TELA ---
function renderizarConferencia() {
    const mainContent = document.getElementById('main-content');
    // Limpa setores antigos para evitar duplicidade na tela
    const antigos = mainContent.querySelectorAll('.setor'); 
    antigos.forEach(el => el.remove());

    let htmlSetores = ''; 
    const setorIds = []; 
    dadosConferencia.forEach(s => setorIds.push(s.id || s.nome));
    window.setorIds = setorIds;

    // --- Sub-fun√ß√£o interna para montar o Alerta de Pend√™ncia ---
    const montarPendenciaHtml = (uid, pendenciaObj) => {
        if (!pendenciaObj) return '';
        
        // Trata Cautela Ativa (Visual Laranja/Diferenciado)
        if (pendenciaObj.status === "CAUTELA_ATV") {
            return `<div class="pendencia-alert-box status-cautela" style="border-left: 3px solid #f57c00; background-color: #fff8e0; text-align: left;" data-status-type="cautela">
                        <div style="font-weight: bold; color: #f57c00; margin-bottom: 5px;"><i class="fas fa-boxes"></i> ${pendenciaObj.quem}</div>
                        <p style="margin: 0; font-size: 0.9em; white-space: pre-wrap;"><i class="fas fa-dot-circle" style="color: #f57c00; margin-right: 5px;"></i>${pendenciaObj.obs}</p>
                    </div>`;
        }
        
        // Gera o visual dos carimbos (Por Fulano em Data...)
        const htmlFormatado = gerarHtmlVisualApp(pendenciaObj);
        
        // üõ°Ô∏è PERSIST√äNCIA: Codifica o objeto completo para o bot√£o 'Acrescentar'
        const safeHistorico = encodeURIComponent(JSON.stringify(pendenciaObj));

        if (pendenciaObj.isReadOnly) {
            return `<div class="pendencia-alert-box" style="border-left: 3px solid #d32f2f; margin-top: 10px;">
                        <div style="font-weight: bold; color: #d32f2f; margin-bottom: 5px;"><i class="fas fa-history"></i> C/A ANTERIOR</div>
                        ${htmlFormatado}
                    </div>`;
        } else {
            return `<div class="pendencia-alert-box">
                        ${htmlFormatado}
                        <div class="pendencia-actions">
                            <button class="btn-manter" onclick="manterPendencia(this, '${uid}')">‚úÖ Concordo (Manter)</button>
                            <button class="btn-acrescentar" onclick="acrescentarPendencia(this, '${uid}', '${safeHistorico}')">‚ûï Acrescentar</button>
                        </div>
                    </div>`;
        }
    };

    // --- Loop Principal por Setores ---
    dadosConferencia.forEach((setor, index) => {
        const isFirstSetor = (index === 0); 
        let htmlItens = ''; 
        let totalItensNoSetor = 0;
        
        setor.itens.forEach(item => {
            // CASO A: ITENS COM TOMBAMENTO (MULTI)
            if (item.tipo === 'multi' && item.tombamentos) {
                let htmlTombamentos = '';
                item.tombamentos.forEach(tomb => {
                    const uid = `${item.id}-${tomb.tomb}`; 
                    let isCautelado = !!tomb.cautela;
                    
                    let tombBtnHtml = isCautela ? 
                        `<button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button>` : 
                        (isCautelado ? `<button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'cautela_ciente')">Ciente</button>` : `<button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button>`);
                    
                    let alertaCautelaHtml = (isCautelado && !isCautela) ? montarPendenciaHtml(uid, {obs: `CAUTELADO para ${tomb.cautela.destinatario} em ${tomb.cautela.data}`, quem: "Sistema/Cautela", status: "CAUTELA_ATV"}) : '';
                    
                    htmlTombamentos += `
                        <div class="tombamento-container" data-tomb="${tomb.tomb}">
                            <div class="tombamento-controls">
                                <span>Tomb.: ${tomb.tomb} ${isCautelado ? 'üîí' : ''}</span>
                                <div class="tombamento-options">${tombBtnHtml}</div>
                            </div>
                            ${alertaCautelaHtml}
                            ${montarPendenciaHtml(uid, tomb.pendencia)}
                            <p class="tombamento-descricao-salva"></p>
                            <div class="tombamento-obs-container">
                                <div class="historico-fixo" style="display:none"></div>

                                <label>Descreva a NOVA altera√ß√£o:</label>
                                <textarea placeholder="Detalhe a altera√ß√£o aqui..."></textarea>
                                <button type="button" class="btn-salvar-alteracao" onclick="salvarTombamento(this)">SALVAR</button>
                            </div>
                        </div>`;
                    totalItensNoSetor++; 
                    window.itemStatus[uid] = { status: 'pending', obs: '' };
                });
                htmlItens += `<div class="item-conferencia" data-type="multi" data-id="${item.id}"><div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span></div>${htmlTombamentos}</div>`;
            
            } 
            // CASO B: ITENS √öNICOS (SINGLE)
            else {
                let hasCautela = (item.cautelas && item.cautelas.length > 0);
                let singleBtnHtml = isCautela ? 
                    `<button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button>` : 
                    (hasCautela ? `<button class="action-button sa-ok" onclick="setItemStatus(this, 'cautela_ciente')">Ciente</button><button class="action-button btn-acrescentar" onclick="setItemStatus(this, 'alert')">+ Altera√ß√£o</button>` : `<button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button><button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button>`);
                
                htmlItens += `
                    <div class="item-conferencia" data-type="single" data-id="${item.id}">
                        <div class="item-header">
                            <span class="status-icon"></span>
                            <span class="item-label">${item.nome} ${hasCautela ? 'üîí' : ''}</span>
                            <span class="item-quantidade">QTD: ${item.quantidadeEsperada || 1}</span>
                        </div>
                        <div class="item-options">${singleBtnHtml}</div>
                        ${montarPendenciaHtml(item.id, item.pendencia)}
                        <p class="descricao-salva"></p>
                        <div class="alteracao-container">
                            <div class="historico-fixo" style="display:none"></div>

                            <label>Descreva a NOVA altera√ß√£o:</label>
                            <textarea placeholder="Detalhe a altera√ß√£o aqui..."></textarea>
                            <button type="button" class="btn-salvar-alteracao" onclick="salvarItem(this)">SALVAR</button>
                        </div>
                    </div>`;
                totalItensNoSetor++; 
                window.itemStatus[item.id] = { status: 'pending', obs: '' };
            }
        });
        
        const exp = isFirstSetor ? 'expanded' : ''; 
        const arr = isFirstSetor ? '‚ñº' : '‚ñ∫';
        htmlSetores += `
            <div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id || setor.nome}">
                <div class="setor-header" onclick="toggleSetor(this)">
                    <div class="setor-info">
                        <span>${setor.nome}</span>
                        <div class="setor-status">0/${totalItensNoSetor}</div>
                    </div>
                    <span class="arrow">${arr}</span>
                </div>
                <div class="setor-content ${exp}">${htmlItens}</div>
            </div>`;
    });

    const btnFin = document.getElementById('btn-finalizar');
    if (btnFin) {
        // Insere todos os setores antes do bot√£o finalizar
        btnFin.insertAdjacentHTML('beforebegin', htmlSetores);
    }
    
    // Atualiza contadores e rascunhos ap√≥s montar a tela
    updateOverallStatus();
}
        function setItemStatus(btn, status) { 
    const item = btn.closest('.item-conferencia');
    const setor = btn.closest('.setor'); 
    const uid = item.dataset.id;
    
    item.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); 
    btn.classList.add('active'); 
    item.querySelector('.descricao-salva').style.display='none'; 
    item.querySelector('.alteracao-container').style.display='none';
    const pb = item.querySelector('.pendencia-alert-box'); 
    
    if (pb && pb.getAttribute('data-status-type') !== 'cautela') {
        pb.style.display='none';
    }
    
    if (status === 'cautela_ciente') {
        item.className = 'item-conferencia status-alert';
        item.querySelector('.status-icon').className = 'status-icon alert';
        // üõ°Ô∏è Mant√©m KEEP para a finalizarConferencia preservar o texto
        window.itemStatus[uid] = { status: 'KEEP', obs: '' }; 
        if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
    }
    else if(status==='ok'){
        item.className='item-conferencia status-ok';
        item.querySelector('.status-icon').className='status-icon ok';
        window.itemStatus[uid]={status:'S/A',obs:''};
        if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'none';
    } 
    else { 
        item.className='item-conferencia status-alert';
        item.querySelector('.status-icon').className='status-icon alert'; 
        item.querySelector('.alteracao-container').style.display='block';
        window.itemStatus[uid]={status:'PENDING_CA',obs:''};
        item.querySelector('textarea').focus();
        if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
    } 
    
    salvarRascunho();
    if(setor) updateSetorStatus(setor); 
    updateOverallStatus(); 
    if((status==='ok' || status==='cautela_ciente') && setor) checkSetorCompletion(setor, uid);
}
        
        function setTombamentoStatus(btn, status) { 
    const tomb = btn.closest('.tombamento-container');
    const item = btn.closest('.item-conferencia'); 
    const setor = btn.closest('.setor'); 
    const uid = `${item.dataset.id}-${tomb.dataset.tomb}`; 
    
    tomb.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); 
    btn.classList.add('active'); 
    tomb.querySelector('.tombamento-obs-container').style.display='none'; 
    tomb.querySelector('.tombamento-descricao-salva').style.display='none'; 
    
    const pb = tomb.querySelector('.pendencia-alert-box');
    if (pb && pb.getAttribute('data-status-type') !== 'cautela') {
        pb.style.display='none';
    }

    if (status === 'cautela_ciente') {
        // üõ°Ô∏è CORRE√á√ÉO: Alterado para 'KEEP' para preservar hist√≥rico no Firebase/PDF
        window.itemStatus[uid] = { status: 'KEEP', obs: '' };
        if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
        updateItemMainStatusDisplay(item);
    }
    else if(status==='ok'){
        window.itemStatus[uid]={status:'S/A',obs:''};
        if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'none';
        updateItemMainStatusDisplay(item);
    } 
    else { 
        tomb.querySelector('.tombamento-obs-container').style.display='block';
        window.itemStatus[uid]={status:'PENDING_CA',obs:''}; 
        tomb.querySelector('textarea').focus();
        if(pb && pb.getAttribute('data-status-type') === 'cautela') pb.style.display = 'block';
        updateItemMainStatusDisplay(item);
    } 
    
    salvarRascunho();
    updateSetorStatus(setor); 
    updateOverallStatus(); 
    if(status==='ok' || status==='cautela_ciente') checkSetorCompletion(setor, item.dataset.id);
}
    
        function manterPendencia(btn, uid) { 
            const box = btn.closest('.pendencia-alert-box');
            if(box) { 
                box.querySelector('.pendencia-actions').style.display='none'; box.classList.add('kept');
                box.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e;font-weight:bold;font-size:0.9em;margin-top:5px;border-top:1px dashed #ccc;padding-top:3px;">‚úî Mantido</div>'); 
                // Define status KEEP e obs VAZIA para n√£o poluir o hist√≥rico (nova l√≥gica)
                window.itemStatus[uid]={status:'KEEP',obs:''}; salvarRascunho(); // <<< ALTERA√á√ÉO APLICADA
                const c = box.closest('.tombamento-container')||box.closest('.item-conferencia'); 
                const btnCA=c.querySelector('.ca-alert'); if(btnCA)btnCA.classList.add('active'); 
                const item = c.classList.contains('item-conferencia')?c:c.closest('.item-conferencia'); 
                if(c.classList.contains('tombamento-container'))updateItemMainStatusDisplay(item);
                const setor=c.closest('.setor'); updateSetorStatus(setor); updateOverallStatus(); checkSetorCompletion(setor, item.dataset.id); 
            } 
        }

        function acrescentarPendencia(btn, uid, encodedData) { 
    const box = btn.closest('.pendencia-alert-box'); 
    const container = box.closest('.tombamento-container') || box.closest('.item-conferencia'); 
    box.style.display = 'none'; 
    
    if (container) { 
        const edit = container.querySelector('.tombamento-obs-container') || container.querySelector('.alteracao-container'); 
        edit.style.display = 'block'; 
        
        const hist = edit.querySelector('.historico-fixo'); 
        if (hist) {
            hist.dataset.meta = encodedData; // Injeta o passado aqui
        }
        
        const textarea = edit.querySelector('textarea');
        textarea.value = ''; 
        textarea.focus(); 
        
        // üõ°Ô∏è AQUI: N√£o resetamos o status para vazio se j√° houver algo.
        // Apenas marcamos que uma edi√ß√£o est√° pendente.
        window.itemStatus[uid] = { status: 'PENDING_CA', meta_origem: encodedData }; 
        salvarRascunho(); 
    } 
}

        function salvarItem(btn) { 
    const item = btn.closest('.item-conferencia');
    const containerEdit = item.querySelector('.alteracao-container');
    const obsDigitada = containerEdit.querySelector('textarea').value.trim(); 
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    const conferente = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const uid = item.dataset.id;

    if(obsDigitada.length < 3) return alert("Descreva a altera√ß√£o em detalhes.");

    // üõ°Ô∏è RECUPERA√á√ÉO DO PASSADO (Sem sobrescrever)
    let listaAcumulada = [];
    
    // Tentativa A: Pelo "cofre" meta (usado no bot√£o acrescentar)
    const histFixo = containerEdit.querySelector('.historico-fixo');
    const metaData = histFixo ? histFixo.dataset.meta : null;

    if (metaData && metaData !== "undefined" && metaData !== "") {
        try {
            const passado = JSON.parse(decodeURIComponent(metaData));
            if (passado.pendencias_ca) listaAcumulada = [...passado.pendencias_ca];
            else if (passado.obs) listaAcumulada.push({ quem: passado.quem, data: passado.data, obs: passado.obs });
        } catch (e) { console.error("Erro meta:", e); }
    } 
    
    // Tentativa B: Se a lista ainda estiver vazia, busca direto no objeto original carregado
    if (listaAcumulada.length === 0) {
        const itemOriginal = dadosConferencia.flatMap(s => s.itens).find(i => i.id === uid);
        if (itemOriginal && itemOriginal.pendencia) {
            if (itemOriginal.pendencia.pendencias_ca) listaAcumulada = [...itemOriginal.pendencia.pendencias_ca];
            else if (itemOriginal.pendencia.obs) listaAcumulada.push({ 
                quem: itemOriginal.pendencia.quem, data: itemOuTomb.pendencia.data, obs: itemOuTomb.pendencia.obs 
            });
        }
    }

    // Adiciona a nova entrada
    listaAcumulada.push({ quem: conferente, data: dataAtual, obs: obsDigitada });

    const novoObjeto = {
        status: 'C/A',
        pendencias_ca: listaAcumulada,
        obs: listaAcumulada.map(p => p.obs).join(' | ') // Garante o texto para o PDF
    };

    window.itemStatus[uid] = novoObjeto; 
    containerEdit.style.display = 'none'; 
    const d = item.querySelector('.descricao-salva'); 
    d.innerHTML = gerarHtmlVisualApp(novoObjeto); 
    d.style.display = 'block'; 
    
    salvarRascunho(); 
    updateSetorStatus(btn.closest('.setor')); 
    updateOverallStatus(); 
}
    
       function salvarTombamento(btn) { 
    const tomb = btn.closest('.tombamento-container'); 
    const item = btn.closest('.item-conferencia');
    const containerEdit = tomb.querySelector('.tombamento-obs-container');
    const obsDigitada = containerEdit.querySelector('textarea').value.trim(); 
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    const p = userInfo;
    const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
    const uid = `${item.dataset.id}-${tomb.dataset.tomb}`;

    if(obsDigitada.length < 3) return alert("Por favor, descreva a altera√ß√£o.");

    // üõ°Ô∏è L√ìGICA DE PRESERVA√á√ÉO DO HIST√ìRICO (ACUMULADOR)
    let listaAcumulada = [];
    
    // Tentativa A: Resgatar o passado pelo metadado injetado no bot√£o "Acrescentar"
    const histFixo = containerEdit.querySelector('.historico-fixo');
    const metaData = histFixo ? histFixo.dataset.meta : null;

    if (metaData && metaData !== "undefined" && metaData !== "") {
        try {
            const passado = JSON.parse(decodeURIComponent(metaData));
            if (passado.pendencias_ca && Array.isArray(passado.pendencias_ca)) {
                listaAcumulada = [...passado.pendencias_ca];
            } else if (passado.obs) {
                // Caso o dado antigo ainda esteja no formato de string simples
                listaAcumulada.push({ quem: passado.quem, data: passado.data, obs: passado.obs });
            }
        } catch (e) { 
            console.error("Erro ao decodificar meta no tombamento:", e); 
        }
    } 
    
    // Tentativa B: Fallback de seguran√ßa (Busca direta no objeto global carregado)
    if (listaAcumulada.length === 0) {
        const itemPai = dadosConferencia.flatMap(s => s.itens).find(i => i.id === item.dataset.id);
        if (itemPai && itemPai.tombamentos) {
            const tombOriginal = itemPai.tombamentos.find(t => t.tomb === tomb.dataset.tomb);
            if (tombOriginal && tombOriginal.pendencia) {
                if (tombOriginal.pendencia.pendencias_ca) {
                    listaAcumulada = [...tombOriginal.pendencia.pendencias_ca];
                } else if (tombOriginal.pendencia.obs) {
                    listaAcumulada.push({ 
                        quem: tombOriginal.pendencia.quem, 
                        data: tombOriginal.pendencia.data, 
                        obs: tombOriginal.pendencia.obs 
                    });
                }
            }
        }
    }

    // ‚ûï Adiciona a nova observa√ß√£o ao final da lista recuperada
    listaAcumulada.push({
        quem: conferente,
        data: dataAtual,
        obs: obsDigitada
    });

    // üì¶ Montagem do objeto final para o Firebase/PDF
    // Unimos todas as observa√ß√µes com o separador " | " para o campo de texto simples
    const textoUnido = listaAcumulada.map(p => p.obs).filter(o => o).join(' | ');

    const novoObjeto = {
        status: 'C/A',
        obs: textoUnido,              // Texto "achatado" para o PDF
        pendencias_ca: listaAcumulada // Lista estruturada para carimbos individuais
    };

    // Atualiza o estado global da aplica√ß√£o
    window.itemStatus[uid] = novoObjeto; 
    
    // Interface Visual
    containerEdit.style.display = 'none'; 
    const d = tomb.querySelector('.tombamento-descricao-salva');
    if (d) {
        d.innerHTML = gerarHtmlVisualApp(novoObjeto); // Gera os carimbos na tela
        d.style.display = 'block'; 
    }

    // Persist√™ncia local e atualiza√ß√£o de status
    salvarRascunho(); 
    updateItemMainStatusDisplay(item); 
    updateSetorStatus(btn.closest('.setor')); 
    updateOverallStatus();
}

        function restaurarRascunho() {
            const saved = localStorage.getItem(getStorageKey()); if (!saved) return;
            try {
                const parsed = JSON.parse(saved); window.itemStatus = parsed.status; 
                document.getElementById('draft-message').style.display = 'block';
                Object.keys(window.itemStatus).forEach(uid => {
                    const st = window.itemStatus[uid]; let container, isTombamento=false;
                    container = document.querySelector(`.item-conferencia[data-id="${uid}"]`);
                    if (!container) {
                        const allTombs = document.querySelectorAll('.tombamento-container');
                        for (let t of allTombs) { if (`${t.closest('.item-conferencia').dataset.id}-${t.dataset.tomb}` === uid) { container = t; isTombamento = true; break; } }
                    }
                    if (container) {
                        const btnSA=container.querySelector('.sa-ok'), btnCA=container.querySelector('.ca-alert');
                        if(btnSA)btnSA.classList.remove('active'); if(btnCA)btnCA.classList.remove('active');
                        const descEl = container.querySelector('.descricao-salva') || container.querySelector('.tombamento-descricao-salva');
                        
                        if (st.status === 'S/A') { if(btnSA)btnSA.classList.add('active'); if(!isTombamento) container.querySelector('.status-icon').className='status-icon ok'; }
                        else if (st.status === 'C/A' || st.status === 'KEEP') { 
                            if(btnCA)btnCA.classList.add('active'); 
                            if(!isTombamento) container.querySelector('.status-icon').className='status-icon alert'; 
                            if(descEl && st.status === 'C/A') {
                                const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
                                const now=formatarDataSimples(new Date());
                                descEl.innerHTML = gerarHtmlVisualApp(st.pendencias_ca ? st : st.obs, conf, now, null, null); 
                                descEl.style.display='block';
                                const pendBox = container.querySelector('.pendencia-alert-box'); if(pendBox) pendBox.style.display = 'none';
                            } else if(st.status === 'KEEP') {
                                const pendBox = container.querySelector('.pendencia-alert-box');
                                if(pendBox) {
                                    pendBox.classList.add('kept'); pendBox.querySelector('.pendencia-actions').style.display='none';
                                    if(!pendBox.innerHTML.includes('‚úî Mantido')) pendBox.insertAdjacentHTML('beforeend', '<div style="color:#1b8a3e;font-weight:bold;font-size:0.9em;margin-top:5px;border-top:1px dashed #ccc;padding-top:3px;">‚úî Mantido</div>');
                                }
                            }
                        }
                        else if (st.status === 'PENDING_CA') {
                            const edit = container.querySelector('.tombamento-obs-container')||container.querySelector('.alteracao-container');
                            if(edit) edit.style.display='block';
                            if(btnCA) btnCA.classList.add('active');
                        }
                        if(isTombamento) updateItemMainStatusDisplay(container.closest('.item-conferencia'));
                    }
                });
                document.querySelectorAll('.setor').forEach(s => updateSetorStatus(s)); updateOverallStatus();
            } catch (e) { console.error("Erro restore", e); }
        }
      function adaptarCautelaParaRender(cautelaData) {
    if (!cautelaData.itens || cautelaData.itens.length === 0) return [];

    const setorCautela = {
        id: cautelaData.cautela_id,
        nome: "ITENS CAUTELADOS",
        itens: cautelaData.itens.map(cItem => {
            
            let tipo = cItem.tombamento ? 'multi' : 'single';
            let tombamentos = null;

            if (tipo === 'multi') {
                tombamentos = [{
                    tomb: cItem.tombamento,
                    id_completo: cItem.id_completo || `${cItem.id_base || cItem.id}-${cItem.tombamento}`,
                    // O item da cautela j√° carrega seu pr√≥prio estado (JSON) se houver
                    cautela: cItem.cautela || {
                        id: cautelaData.cautela_id,
                        destinatario: cautelaData.destinatario || cautelaData.destinatario_original_nome,
                        data: cautelaData.timestamp_emissao ? new Date(cautelaData.timestamp_emissao.seconds * 1000).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR')
                    },
                    pendencia: cItem.pendencia || null
                }];
                cItem.quantidade = 1; 
            }

            return {
                id: cItem.id_base || cItem.id,
                nome: cItem.nome,
                quantidadeEsperada: cItem.quantidade || 1,
                tipo: tipo,
                tombamentos: tombamentos,
                // Preserva o carimbo JSON para itens de quantidade (Single)
                cautelas: cItem.cautelas || [],
                pendencia: cItem.pendencia || null
            };
        })
    };

    return [setorCautela];
}
        async function carregarDadosRemotos() {
    const ID_ALVO = isCautela ? CAUTELA_ID : LISTA_ID;
    const COLECAO_ALVO = isCautela ? COLECAO_CAUTELAS : COLECAO_LISTAS;
    
    // 1. Valida√ß√£o Inicial
    if (!ID_ALVO) { 
        console.error("ID n√£o encontrado para carregamento.");
        return; 
    }
        
    const loadingMsg = document.getElementById('loading-message');
    if (loadingMsg) loadingMsg.innerHTML = "Conectando...";

    try {
        // 2. Busca de Dados no Firebase
        const doc = await db.collection(COLECAO_ALVO).doc(ID_ALVO).get();
        if (!doc.exists) throw new Error("Documento n√£o encontrado no banco de dados.");
        
        const data = doc.data();
        
        // 3. Adapta√ß√£o dos Dados (JSON)
        dadosConferencia = isCautela ? adaptarCautelaParaRender(data) : (data.list || []);
        
        // 4. Defini√ß√£o das Informa√ß√µes de Cabe√ßalho
        const nomeLocal = isCautela ? `CAUTELA: ${CAUTELA_ID}` : (data.nome_local || "Lista de Confer√™ncia");
        const postoLocal = isCautela ? `Destinat√°rio: ${data.destinatario || data.destinatario_original_nome}` : (data.posto || "Geral");
        
        infoLocal = { nome: nomeLocal, posto: postoLocal };
        
        // 5. Atualiza√ß√£o Segura da Interface (Apenas se os elementos existirem)
        const infoElement = document.getElementById('local-posto-info');
        if (infoElement) {
            infoElement.innerHTML = `<span style="color:blue;font-weight:bold">${infoLocal.posto} - ${infoLocal.nome}</span>`;
        }

        document.title = isCautela ? `Cautela - ${CAUTELA_ID}` : `Confer√™ncia - ${infoLocal.nome}`;

        // 6. L√≥gica Espec√≠fica de Cautela (Blindada)
        if (isCautela) {
            const h1Element = document.querySelector('h1');
            const subtituloElement = document.querySelector('.subtitulo');
            const btnFinalizar = document.getElementById('btn-finalizar');

            if (h1Element) {
                if (MODO_OPERACAO === 'devolucao_final') h1Element.textContent = 'RECEBIMENTO DE DEVOLU√á√ÉO';
                else if (MODO_OPERACAO === 'devolucao') h1Element.textContent = 'DEVOLU√á√ÉO (TRANSI√á√ÉO)';
                else h1Element.textContent = 'RECEBIMENTO DE CAUTELA';
            }

            if (subtituloElement) {
                if (MODO_OPERACAO === 'devolucao_final') {
                    const reversor = data.militar_completo_reversor || 'Militar Anterior';
                    subtituloElement.innerHTML = `Recebendo Cautela <strong>${CAUTELA_ID}</strong> de: <br> ${reversor}`;
                } else {
                    subtituloElement.textContent = `Processando Cautela ${CAUTELA_ID}`;
                }
            }

            if (btnFinalizar) {
                if (MODO_OPERACAO === 'devolucao_final') {
                    btnFinalizar.textContent = 'FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO';
                    btnFinalizar.onclick = () => finalizarRecebimentoDevolucao(data);
                } else {
                    btnFinalizar.onclick = () => finalizarRecebimentoCautela(data);
                }
            }
        }
        
        // 7. Renderiza√ß√£o e Fun√ß√µes de Suporte
        if (loadingMsg) loadingMsg.innerHTML = "Renderizando itens...";
        
        renderizarConferencia(); 

        // Verifica√ß√£o de exist√™ncia das fun√ß√µes de apoio antes de chamar
        if (typeof updateHeaderInfo === "function") try { updateHeaderInfo(); } catch(e) {}
        if (typeof updateOverallStatus === "function") try { updateOverallStatus(); } catch(e) {}
        if (typeof restaurarRascunho === "function") try { restaurarRascunho(); } catch(e) {}

        // 8. Finaliza√ß√£o do Estado de Carregamento
        if (loadingMsg) loadingMsg.style.display = 'none'; 
        const mainContent = document.getElementById('main-content');
        if (mainContent) mainContent.style.display = 'block';

    } catch (e) { 
        console.error("Erro Cr√≠tico no Carregamento:", e);
        if (loadingMsg) loadingMsg.innerHTML = "<span style='color:red'>Erro ao carregar dados. Verifique o console.</span>";
    }
}
        function getCautelaTextForReport(itemOuTomb) {
    if (!itemOuTomb) return "";
    let textos = [];

    if (itemOuTomb.cautela && typeof itemOuTomb.cautela === 'object') {
        const c = itemOuTomb.cautela;
        textos.push(`Cautela EMITIDA (${c.id}) para ${c.destinatario} em ${c.data}`);
    } else if (itemOuTomb.cautelas && Array.isArray(itemOuTomb.cautelas)) {
        itemOuTomb.cautelas.forEach(c => {
            textos.push(`Cautela EMITIDA (${c.id}) ${c.quantidade}UN para ${c.destinatario}`);
        });
    }

    if (itemOuTomb.pendencia && typeof itemOuTomb.pendencia === 'object') {
        const p = itemOuTomb.pendencia;
        textos.push(`- Por ${p.quem} em ${p.data}: ${p.obs}`);
    } else if (typeof itemOuTomb.pendencia === 'string' && itemOuTomb.pendencia.trim() !== "") {
        textos.push(itemOuTomb.pendencia);
    }

    return textos.join(' | ');
}
        // A fun√ß√£o completa fornecida no passo anterior, que deve substituir a sua:

async function finalizarConferencia() {
    const CURRENT_LIST_ID = LISTA_ID || CAUTELA_ID;
    const CONFERENTE_UID = userInfo.uid || ''; 

    if (isCautela) {
        await finalizarRecebimentoCautela();
        return;
    }
    
    const btn = document.getElementById('btn-finalizar');
    if (btn.disabled) return;
    btn.textContent = "Salvando..."; 
    btn.disabled = true;

    try {
        const p = userInfo;
        const conferente = `${p.postoGraduacao} ${p.quadro} ${p.nomeGuerra}`;
        const localNome = `${infoLocal.posto} - ${infoLocal.nome}`;
        const dataAtualCompleta = new Date().toLocaleString('pt-BR');
        const dataSomenteDia = dataAtualCompleta.split(',')[0];
        
        let updated = false;
        let itensRelatorio = [];
        let itensCaa = []; 

        dadosConferencia.forEach(setor => {
            setor.itens.forEach(item => {
                
                const processarItemUnico = (itemOuTomb, id, nome) => {
                    const s = window.itemStatus[id];
                    
                    // 1. Ignora itens n√£o conferidos
                    if (!s || s.status === 'pending') return; 

                    if (!itemOuTomb.historico_vida) itemOuTomb.historico_vida = [];
                    
                    let finalStatus = (s.status === 'KEEP' || s.status === 'C/A' || s.status === 'PENDING_CA') ? 'C/A' : 'S/A';
                    let listaPendenciasAtivas = [];

                    if (finalStatus === 'C/A') {
                        // 2. PRIORIDADE: Recupera a lista que foi montada no 'salvarItem' ou 'salvarTombamento'
                        if (s.pendencias_ca && Array.isArray(s.pendencias_ca)) {
                            listaPendenciasAtivas = [...s.pendencias_ca];
                        } 
                        // 3. SEGUNDA OP√á√ÉO: Recupera o que j√° existia no Banco de Dados (DNA do Item)
                        else if (itemOuTomb.pendencia && itemOuTomb.pendencia.pendencias_ca) {
                            listaPendenciasAtivas = [...itemOuTomb.pendencia.pendencias_ca];
                        } 
                        // 4. FALLBACK: Converte formato antigo se houver
                        else if (itemOuTomb.pendencia && itemOuTomb.pendencia.obs) {
                            listaPendenciasAtivas.push({
                                quem: itemOuTomb.pendencia.quem,
                                data: itemOuTomb.pendencia.data,
                                obs: itemOuTomb.pendencia.obs
                            });
                        }

                        // 5. TRATAMENTO DE RASCUNHO (Se digitou mas n√£o clicou em salvar individualmente)
                        const obsDigitada = (s.obs && typeof s.obs === 'string') ? s.obs.trim() : "";
                        const ultimaObsNaLista = listaPendenciasAtivas.length > 0 ? listaPendenciasAtivas[listaPendenciasAtivas.length - 1].obs : null;

                        if (obsDigitada !== '' && obsDigitada !== ultimaObsNaLista) {
                            listaPendenciasAtivas.push({
                                quem: conferente,
                                data: dataSomenteDia,
                                obs: obsDigitada
                            });
                            
                            itemOuTomb.historico_vida.push({
                                evento: "ALTERACAO_DETECTADA",
                                quem: conferente,
                                data: dataAtualCompleta,
                                detalhes: obsDigitada
                            });
                        }

                        // üõ°Ô∏è 6. FIXA√á√ÉO DOS DADOS (Evita 'obs' vazio no Firebase/PDF)
                        // Criamos uma string √∫nica unindo todas as observa√ß√µes da lista
                        const textoJoin = listaPendenciasAtivas.map(p => p.obs).filter(o => o).join(' | ');

                        itemOuTomb.pendencia = {
                            tipo: "C/A",
                            pendencias_ca: listaPendenciasAtivas,
                            obs: textoJoin, // <--- Este campo preenche o Firebase e o PDF
                            quem: listaPendenciasAtivas[0]?.quem || conferente,
                            data: listaPendenciasAtivas[0]?.data || dataSomenteDia
                        };
                        updated = true;

                    } else if (s.status === 'S/A' && itemOuTomb.pendencia) {
                        // Saneamento de pend√™ncia
                        itemOuTomb.historico_vida.push({
                            evento: "SANEAMENTO_ALTERACAO",
                            quem: conferente,
                            data: dataAtualCompleta,
                            detalhes: "Item conferido como S/A."
                        });
                        delete itemOuTomb.pendencia;
                        updated = true;
                    }

                    // 7. MONTAGEM PARA COLE√á√ÉO 'resultados_conferencias'
                    const dadosParaRelatorio = { 
                        id: id,
                        nomeCompleto: nome, 
                        status: finalStatus, 
                        pendencias_ca: listaPendenciasAtivas, 
                        obs: itemOuTomb.pendencia?.obs || '', // üëà Garantido que n√£o seja vazio
                        quem: itemOuTomb.pendencia?.quem || '', 
                        data: itemOuTomb.pendencia?.data || '',
                        quantidade: itemOuTomb.quantidade || (item.quantidadeEsperada || 1), 
                        setor: setor.nome
                    };

                    itensRelatorio.push(dadosParaRelatorio);
                    if (finalStatus === 'C/A') itensCaa.push(dadosParaRelatorio);
                };

                // Direcionamento por tipo de item
                if (item.tipo === 'multi' && item.tombamentos) {
                    item.tombamentos.forEach(t => processarItemUnico(t, `${item.id}-${t.tomb}`, `${item.nome} (${t.tomb})`));
                } else {
                    processarItemUnico(item, item.id, item.nome);
                }
            });
        });

        // 8. Grava√ß√£o Final
        if(updated) {
            await db.collection(COLECAO_LISTAS).doc(LISTA_ID).update({ list: dadosConferencia });
        }
        
        await db.collection('resultados_conferencias').add({ 
            local: localNome, 
            lista_id: LISTA_ID, 
            conferente_uid: CONFERENTE_UID,
            conferente: conferente, 
            timestamp: firebase.firestore.Timestamp.now(), 
            totalItensConferidos: itensRelatorio.length, 
            totalCaa: itensCaa.length, 
            itensCaa, 
            itensRelatorio 
        });
        
        const custodiaRef = db.collection('custodia_atual').doc(LISTA_ID);
        await custodiaRef.set({
            lista_id: LISTA_ID, local_nome: localNome, conferente_uid: CONFERENTE_UID,
            conferente_completo: conferente, timestamp_ultima_conferencia: firebase.firestore.FieldValue.serverTimestamp(),
        });

        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        if (window.self === window.top) { 
            alert("Confer√™ncia finalizada com sucesso!"); 
            window.location.href = "operacional.html"; 
        }

    } catch (e) { 
        console.error("Erro na finaliza√ß√£o:", e);
        alert("Erro ao finalizar: " + e.message); 
        btn.disabled = false; 
        btn.textContent = "Finalizar Confer√™ncia";
    }
}
        async function finalizarRecebimentoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();
            if (cData.destinatario_original_uid !== meuUid) {
                throw new Error("Apenas o destinat√°rio original pode assinar este recebimento.");
            }

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensConferidos = [];

            cautela.itens.forEach(cItem => {
                const statusSelect = document.getElementById(`status-${cItem.id}-${cItem.tombamento || 'single'}`);
                const obsInput = document.getElementById(`obs-${cItem.id}-${cItem.tombamento || 'single'}`);
                
                const statusFinal = statusSelect ? statusSelect.value : 'S/A';
                const obsFinal = obsInput ? obsInput.value.trim() : '';

                itensConferidos.push({
                    ...cItem,
                    status_recebimento: statusFinal,
                    obs_recebimento: obsFinal
                });

                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            const logHistorico = {
                                evento: "CONFIRMA√á√ÉO_RECEBIMENTO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                estado: statusFinal,
                                detalhes: statusFinal === 'C/A' ? `Avaria detectada no recebimento: ${obsFinal}` : "Recebido em perfeito estado (S/A)."
                            };

                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push(logHistorico);

                            const objetoCautelaAtualizado = {
                                id: CAUTELA_ID,
                                emitente: cData.emitente,
                                destinatario: meuNomeCompleto,
                                data: dataAtual,
                                status_item: statusFinal,
                                obs_item: obsFinal
                            };

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        t.cautela = objetoCautelaAtualizado;
                                    }
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = mItem.cautelas.map(c => {
                                    if (c.id === CAUTELA_ID) {
                                        return objetoCautelaAtualizado;
                                    }
                                    return c;
                                });
                            }
                        }
                        return mItem;
                    })
                }));
            });

            transaction.update(cautelaRef, {
                status: 'RECEBIDA',
                timestamp_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
                itens: itensConferidos,
                militar_completo_receptor: meuNomeCompleto
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Recebimento confirmado!`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

    } catch (error) {
        console.error("Erro ao receber cautela:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO";
        btn.disabled = false;
    }
}
      async function finalizarDevolucaoCautela(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = 'Processando...';
    btn.disabled = true;

    try {
        // Pega as informa√ß√µes do militar logado (quem est√° devolvendo)
        const userInfo = await getLoggedUser(); 
        
        if (!userInfo) {
            alert("Erro: Dados do militar logado n√£o encontrados.");
            btn.textContent = 'ERRO AO FINALIZAR';
            btn.disabled = false;
            return;
        }

        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);

        // üõë CR√çTICO: Executa a Transa√ß√£o no Firebase üõë
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(cautelaRef);

            if (!doc.exists || doc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela n√£o encontrada ou n√£o est√° no status 'RECEBIDA'.");
            }
            
            // 1. A√ß√£o: Mudar o status da cautela para CONCLUIDA.
            transaction.update(cautelaRef, { 
                status: 'CONCLUIDA', // Status final
                timestamp_devolucao: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem est√° devolvendo (Militar Logado)
                reversor: userInfo.nomeGuerra, 
                militar_completo_reversor: `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`,
                
                // Quem est√° recebendo de volta (√öltimo Conferente)
                destinatario_final_devolucao: DESTINATARIO_DEVOLUCAO,
            });
            
            // 2. A√ß√£o: Registrar o hist√≥rico de confer√™ncia final (opcional, mas recomendado)
            // Se necess√°rio, voc√™ pode adicionar um novo documento na sua cole√ß√£o de hist√≥rico.
        }); // Fim da Transa√ß√£o

        alert(`‚úÖ Devolu√ß√£o da Cautela ${CAUTELA_ID} conclu√≠da e status atualizado para \"CONCLUIDA\".`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro CR√çTICO ao finalizar devolu√ß√£o:", error);
        alert(`Erro ao finalizar devolu√ß√£o. Nenhum dado foi alterado. Erro: ${error.message}`);
        btn.textContent = "ERRO AO FINALIZAR";
        btn.disabled = false;
    }
}
        async function finalizarRecebimentoDevolucao(cautela) {
    const btn = document.getElementById('btn-finalizar');
    btn.textContent = "PROCESSANDO...";
    btn.disabled = true;

    if (!isCautela || !CAUTELA_ID) {
        alert("Erro: ID da cautela n√£o encontrado.");
        btn.disabled = false;
        return;
    }

    const userAuth = firebase.auth().currentUser;
    if (!userAuth) {
        alert("Erro: Sess√£o n√£o encontrada. Fa√ßa login novamente.");
        btn.disabled = false;
        return;
    }

    const meuUid = userAuth.uid;
    const meuNomeCompleto = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
    const dataAtual = new Date().toLocaleString('pt-BR');
    const listaId = cautela.local_origem_id;

    try {
        const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
        const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaId);

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            if (!cautelaDoc.exists) throw new Error("Cautela n√£o encontrada.");

            const cData = cautelaDoc.data();

            const listaMestraDoc = await transaction.get(listaMestraRef);
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra original n√£o encontrada.");

            let listaMestra = listaMestraDoc.data().list;
            const itensDevolvidos = [];

            cautela.itens.forEach(cItem => {
                const statusSelect = document.getElementById(`status-${cItem.id}-${cItem.tombamento || 'single'}`);
                const obsInput = document.getElementById(`obs-${cItem.id}-${cItem.tombamento || 'single'}`);
                
                const statusFinal = statusSelect ? statusSelect.value : 'S/A';
                const obsFinal = obsInput ? obsInput.value.trim() : '';

                itensDevolvidos.push({
                    ...cItem,
                    status_devolucao: statusFinal,
                    obs_devolucao: obsFinal
                });

                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        const idMestra = mItem.id_base || mItem.id;
                        const idCautelaItem = cItem.id_base || cItem.id;

                        if (idMestra === idCautelaItem) {
                            const logHistorico = {
                                evento: "RETORNO_DEVOLUCAO",
                                id_doc: CAUTELA_ID,
                                quem: meuNomeCompleto,
                                data: dataAtual,
                                estado_retorno: statusFinal,
                                detalhes: statusFinal === 'C/A' ? `Item devolvido com altera√ß√£o: ${obsFinal}` : "Item devolvido em perfeito estado (S/A)."
                            };

                            if (!mItem.historico_vida) mItem.historico_vida = [];
                            mItem.historico_vida.push(logHistorico);

                            if (statusFinal === 'C/A') {
                                mItem.pendencia = {
                                    tipo: "C/A",
                                    obs: `[DEVOLU√á√ÉO ${CAUTELA_ID}] ${obsFinal}`,
                                    quem: meuNomeCompleto,
                                    data: dataAtual
                                };
                            } else {
                                delete mItem.pendencia;
                            }

                            if (cItem.tombamento && mItem.tombamentos) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === cItem.tombamento) {
                                        delete t.cautela;
                                    }
                                    return t;
                                });
                            } else if (!cItem.tombamento && mItem.cautelas) {
                                mItem.cautelas = (mItem.cautelas || []).filter(c => 
                                    (c.id !== CAUTELA_ID && c.cautela_id !== CAUTELA_ID)
                                );
                            }
                        }
                        return mItem;
                    })
                }));
            });

            transaction.update(cautelaRef, { 
                status: 'CONCLU√çDA',
                timestamp_conclusao: firebase.firestore.FieldValue.serverTimestamp(),
                receptor_final_completo: meuNomeCompleto,
                destinatario_uid: meuUid,
                itens: itensDevolvidos
            });

            transaction.update(listaMestraRef, { list: listaMestra });
        });

        alert(`‚úÖ Devolu√ß√£o finalizada! Material reintegrado ao estoque e hist√≥rico atualizado.`);
        limparRascunho();
        window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');
        
    } catch (error) {
        console.error("Erro ao finalizar devolu√ß√£o:", error);
        alert(`Erro: ${error.message}`);
        btn.textContent = "FINALIZAR RECEBIMENTO DA DEVOLU√á√ÉO";
        btn.disabled = false;
    }
}
        window.onload = carregarDadosRemotos;
    </script>
</body>
</html>
