<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Operacional</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; display: flex; min-height: 100vh; padding-top: 50px; padding-bottom: 60px; box-sizing: border-box; overflow-x: hidden; }
        
        /* Header */
        .main-header { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background-color: #800020; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; gap: 10px; }
        .header-icon { height: 40px; width: auto; } 
        .header-title-desktop, .header-title-mobile { font-weight: bold; font-size: 1.1em; line-height: 1.2; } 
        .text-white { color: white; } .text-red { color: #FF3B3B; } 
        .header-title-desktop { display: none; } .header-title-mobile { display: block; }
        .btn-logout-header { margin-left: auto; background: none; border: none; color: white; cursor: pointer; font-size: 1.2em; }
        #menu-btn { display: none; background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0 5px; }
        .profile-badge { background-color: rgba(255,255,255,0.2); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; margin-left: 10px; border: 1px solid rgba(255,255,255,0.3); }

        @media (min-width: 768px) { .header-title-desktop { display: block; font-size: 1.2em; } .header-title-mobile { display: none; } #menu-btn { display: none; } }
        
        /* Sidebar */
        .sidebar { width: 250px; background-color: #ffffff; color: #333; padding-top: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); border-right: 1px solid #e0e0e0; position: fixed; top: 50px; left: 0; height: calc(100% - 50px); display: flex; flex-direction: column; z-index: 1100; overflow-y: auto; transition: left 0.3s ease; }
        .sidebar-header { text-align: center; padding: 10px 0 20px 0; border-bottom: 1px solid #eee; margin-bottom: 10px; } 
        .sidebar-header img { width: 60px; height: auto; margin-bottom: 5px; } 
        .sidebar-header h2 { font-size: 1.1em; margin: 0; color: #800020; }
        .sidebar a { padding: 15px 20px; text-decoration: none; font-size: 1em; color: #555; display: block; transition: all 0.3s ease; border-left: 4px solid transparent; cursor: pointer; } 
        .sidebar a:hover { background-color: #fff5f5; color: #800020; } 
        .sidebar a.active { background-color: #ffecec; color: #800020; font-weight: bold; border-left: 4px solid #d90f23; } 
        .menu-label { padding: 15px 20px 5px; font-size: 0.85em; color: #999; text-transform: uppercase; font-weight: bold; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; }

        /* Content */
        .content { margin-left: 250px; flex-grow: 1; padding: 20px; box-sizing: border-box; width: calc(100% - 250px); padding-bottom: 80px; } 
        .view-section { display: none; animation: fadeIn 0.3s ease; } 
        .view-section.active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Footer */
        .footer-central { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 5px 0 5px; background-color: #f4f4f9; color: #555; font-size: 0.65em; line-height: 1.3; z-index: 100; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); } 
        .footer-central strong, .footer-autor { display: block; width: 100%; text-align: center; } .footer-central strong { font-weight: bold; } .footer-autor { margin-top: 10px; color: #888; font-size: 0.9em; }

        /* Greeting Card */
        .greeting-card { background: linear-gradient(135deg, #800020 0%, #5a0017 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(128, 0, 32, 0.2); display: flex; align-items: center; gap: 20px; }
        .greeting-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); object-fit: cover; background-color: white; }
        .greeting-info { flex-grow: 1; }
        .greeting-title { margin: 0; font-size: 1.5em; font-weight: bold; line-height: 1.2; }
        .greeting-date { font-size: 0.85em; opacity: 0.8; margin-top: 3px; display: block; font-style: italic;}
        .greeting-user { font-size: 1.1em; margin-top: 5px; display: block; font-weight: 500; }

        /* Card de Nova Confer√™ncia / Filtros */
        .op-card { background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; border-left: 5px solid #ccc; }
        .op-card.action { border-left-color: #1b8a3e; }
        .op-card.history { border-left-color: #2c7399; }
        .op-card.resume { border-left-color: #f57c00; background-color: #fff3e0; cursor: pointer; transition: transform 0.2s; }
        .op-card.resume:hover { transform: translateY(-2px); }
        
        .op-card-title { color: #333; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; color: #555; margin-bottom: 5px; font-size: 0.9em; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .form-group select:focus, .form-group input:focus { border-color: #800020; outline: none; box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2); }
        .btn-start { background: linear-gradient(135deg, #d90f23 0%, #800020 100%); color: white; border: none; width: 100%; padding: 15px; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(217, 15, 35, 0.3); }
        .btn-start:focus { outline: 3px solid rgba(128,0,32,0.4); }
        
        /* History List Specifics */
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .history-item:hover { background-color: #fafafa; padding-left: 5px; padding-right: 5px; }
        .history-item:last-child { border-bottom: none; }
        .hist-info strong { display: block; color: #333; font-size: 1.05em; }
        .hist-info small { color: #777; font-size: 0.9em; }
        .hist-status { font-size: 0.8em; padding: 4px 10px; border-radius: 12px; font-weight: bold; margin-left: 5px; text-transform: uppercase; }
        .status-ok { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-alert { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .btn-reprint { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; color: #555; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        .btn-reprint:hover { border-color: #800020; color: #800020; background-color: #fff5f5; }

        /* Filtros Premium */
        .modern-filter-card { background-color: #fff; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .filter-item { flex: 1; min-width: 200px; }
        .filter-item label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 0.9em; }
        .filter-input { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95em; box-sizing: border-box; }
        .btn-filter-modern { background-color: #2c7399; color: white; border: none; padding: 11px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* APP CONTAINER (IFRAME) */
        #app-runner-container { display: none; position: fixed; top: 50px; left: 250px; width: calc(100% - 250px); height: calc(100vh - 50px); background: white; z-index: 500; overflow: hidden; }
        #app-iframe { width: 100%; height: 100%; border: none; }

        /* Mobile */
        @media (max-width: 768px) { 
            #menu-btn { display: block; }
            .sidebar { left: -260px; width: 260px; border-right: 1px solid #ddd; } .sidebar.mobile-active { left: 0; } 
            .content { margin-left: 0; width: 100%; padding-top: 15px; } 
            #app-runner-container { left: 0; width: 100%; z-index: 500; }
            .modern-filter-card { flex-direction: column; align-items: stretch; gap: 10px; }
            .btn-filter-modern { width: 100%; }
            .filter-input { max-width: 100%; width: 100%; }
            .filter-item { width: 100%; min-width: 0; }
        }
        @media (min-width: 769px) { .sidebar-overlay { display: none !important; } }
    </style>
</head>
<body>
    <div id="mobile-overlay" class="sidebar-overlay" onclick="closeMenuMobile()"></div>

    <header class="main-header">
        <button id="menu-btn" onclick="toggleMenuMobile()"><i class="fas fa-bars"></i></button>
        <img src="logo_sigma.png" alt="Logo SIGMA" class="header-icon" onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=CBM'">
        <div class="header-title-desktop"><span class="text-white">CORPO DE BOMBEIROS MILITAR </span><span class="text-red">RORAIMA</span></div>
        <div class="header-title-mobile"><span class="text-white">CBM</span><span class="text-red">RR</span></div>
        <span id="user-role-display" class="profile-badge">Carregando...</span>
        <button class="btn-logout-header" onclick="sairDoSistema()" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
    </header>
    
    <div class="sidebar" id="main-sidebar">
        <div class="sidebar-header"><img src="logo_sigma.png" alt="Logo SIGMA" onerror="this.onerror=null; this.src='https://placehold.co/50x50/ffffff/800020/fff?text=S'"><h2>SIGMA Operacional</h2></div>
        <div class="menu-label">Operacional</div>
        <a onclick="switchView('dashboard')" id="link-dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard & Servi√ßo</a>
        <a onclick="switchView('my-history')" id="link-my-history"><i class="fas fa-history"></i> Minhas Confer√™ncias</a>
    </div>

    <div class="content">
        
        <div id="view-dashboard" class="view-section active-view">
            <div class="greeting-card">
                <img id="greeting-photo" src="https://placehold.co/70x70/ffffff/800020?text=U" class="greeting-avatar">
                <div class="greeting-info">
                    <h2 id="greeting-text" class="greeting-title">Carregando...</h2>
                    <span id="greeting-name" class="greeting-user">...</span>
                    <span id="current-date" class="greeting-date">...</span>
                </div>
            </div>

            <div id="resume-container"></div>

            <div class="op-card action">
                <h2 class="op-card-title"><i class="fas fa-clipboard-list"></i> Nova Confer√™ncia</h2>
                <div class="form-group">
                    <label>1. Escolha o Setor / Posto</label>
                    <select id="dash-select-setor" onchange="filtrarListasDashboard()">
                        <option value="" disabled selected>Carregando setores...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>2. Escolha a Viatura / Lista</label>
                    <select id="dash-select-lista" disabled onchange="focarBotaoIniciar()">
                        <option value="" disabled selected>Selecione um setor acima</option>
                    </select>
                </div>
                <button id="btn-start-dash" class="btn-start" onclick="iniciarConferenciaDashboard()">INICIAR AGORA</button>
            </div>

            <div class="op-card history">
                <h2 class="op-card-title"><i class="fas fa-calendar-day"></i> Confer√™ncias Realizadas Hoje (Minhas)</h2>
                <ul id="today-list" class="history-list">
                    <li style="text-align:center; color:#999; padding:20px;">Carregando...</li>
                </ul>
            </div>
        </div>

        <div id="view-my-history" class="view-section">
            <div class="op-card history">
                <h2 class="op-card-title"><i class="fas fa-history"></i> Minhas Confer√™ncias (Hist√≥rico Completo)</h2>
                <div class="modern-filter-card">
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                        <input type="date" id="my-hist-start" class="filter-input">
                    </div>
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Final</label>
                        <input type="date" id="my-hist-end" class="filter-input">
                    </div>
                    <div class="filter-item" style="flex: 0;">
                        <button class="btn-filter-modern" onclick="loadMyHistory()">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
                <ul id="my-history-list" class="history-list">
                    <li style="padding:20px; text-align:center; color:#999;">Use os filtros acima para buscar no hist√≥rico.</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="app-runner-container"><iframe id="app-iframe" src=""></iframe></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const auth = firebase.auth();

        // Constantes Globais
        const COLECAO_RESULTADOS = 'resultados_conferencias';

        // Vari√°veis Globais
        let currentUserData = null;
        let allLists = [];
        let currentView = 'dashboard';

        // --- 1. AUTH & PERMISS√ïES ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection('usuarios').doc(user.uid).get();
                    if (doc.exists) {
                        currentUserData = doc.data();
                        setupUIBasedOnRole();
                    } else {
                        alert("Usu√°rio sem registro no banco."); window.location.href = 'index.html';
                    }
                } catch (e) { console.error(e); }
            } else { window.location.href = 'index.html'; }
        });

        function sairDoSistema() {
            auth.signOut().then(() => { window.location.href = 'index.html'; }).catch((error) => { console.error("Erro ao sair:", error); });
        }

        function setupUIBasedOnRole() {
            const role = currentUserData.role || 'operacional';
            const unit = currentUserData.unidade || 'N/D';
            
            document.getElementById('user-role-display').textContent = `${role.toUpperCase()} - ${unit}`;
            atualizarSaudacao(currentUserData);
            
            // Redireciona para o Dashboard de Gest√£o se o perfil n√£o for operacional
            if (role !== 'operacional') {
                 alert("Acesso operacional restrito. Redirecionando para o painel de Gest√£o.");
                 window.location.href = 'sigma_dashboard.html';
                 return;
            }

            carregarListasParaNovaConferencia();
            verificarConferenciaAtiva();
            carregarConferenciasHoje(); // Nova fun√ß√£o: Carrega as confer√™ncias do dia
        }

        function atualizarSaudacao(user) {
            const now = new Date(); const hour = now.getHours();
            let saudacao = "Bom dia";
            if (hour >= 12 && hour < 18) saudacao = "Boa tarde"; else if (hour >= 18) saudacao = "Boa noite";
            
            const opcoesData = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let dataStr = now.toLocaleDateString('pt-BR', opcoesData);
            dataStr = dataStr.charAt(0).toUpperCase() + dataStr.slice(1);

            document.getElementById('greeting-text').textContent = saudacao + ",";
            document.getElementById('greeting-name').textContent = user.nome_militar_completo || user.nome_guerra;
            document.getElementById('current-date').textContent = dataStr;
            if(user.foto_url) document.getElementById('greeting-photo').src = user.foto_url;
        }

        // --- 2. SWITCH VIEW (Para sidebar) ---
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(view => {
                view.classList.remove('active-view');
            });
            document.getElementById(`view-${viewId}`).classList.add('active-view');
            
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(`link-${viewId}`).classList.add('active');

            currentView = viewId;
            closeMenuMobile();

            // A√ß√µes espec√≠ficas ao mudar de view
            if(viewId === 'my-history') {
                // Apenas exibe a view, o usu√°rio deve clicar em Filtrar
            }
        }
        
        // --- 3. MENU MOBILE ---
        function toggleMenuMobile() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-active');
            overlay.style.display = sidebar.classList.contains('mobile-active') ? 'block' : 'none';
        }

        function closeMenuMobile() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.remove('mobile-active');
            overlay.style.display = 'none';
        }


        // --- 4. VERIFICA√á√ÉO DE RESUME ---
        function verificarConferenciaAtiva() {
            const activeConf = localStorage.getItem('sigma_active_conf');
            const container = document.getElementById('resume-container');
            container.innerHTML = '';
            if (activeConf) {
                try {
                    const confData = JSON.parse(activeConf);
                    if(confData.user === currentUserData.nome_guerra) {
                        container.innerHTML = `<div class="op-card resume" onclick="retomarConferencia('${confData.url}')"><h2 class="op-card-title" style="border:none; margin:0; color:#e65100;"><i class="fas fa-play-circle"></i> Continuar Confer√™ncia: ${confData.nomeLista}</h2><p style="margin:5px 0 0 30px; color:#666; font-size:0.9em;">Clique para retomar de onde parou...</p></div>`;
                    } else {
                        // Limpa se for de outro usu√°rio (cen√°rio raro, mas seguro)
                        localStorage.removeItem('sigma_active_conf');
                    }
                } catch(e) {
                    localStorage.removeItem('sigma_active_conf');
                }
            }
        }

        function retomarConferencia(url) {
            const iframe = document.getElementById('app-iframe');
            const container = document.getElementById('app-runner-container');
            iframe.src = url;
            container.style.display = 'block';
        }

        // --- 5. NOVA CONFER√äNCIA ---
        async function carregarListasParaNovaConferencia() {
            try {
                const doc = await db.collection('config_geral').doc('rotas').get();
                const rotas = doc.data();
                allLists = []; const setores = new Set();
                
                Object.entries(rotas).forEach(([id, info]) => {
                    // Filtra por listas ativas E pela unidade do usu√°rio (se definida)
                    if (info.ativo !== false && (!currentUserData.unidade || info.unidade === currentUserData.unidade)) {
                        allLists.push({ id: id, nome: info.nome, setor: info.posto });
                        setores.add(info.posto);
                    }
                });
                
                const sel = document.getElementById('dash-select-setor');
                sel.innerHTML = '<option value="" disabled selected>Selecione o Setor...</option>';
                
                // Adiciona o Posto/Setor do usu√°rio primeiro (se houver)
                if (currentUserData.posto) {
                     const postoUsuario = currentUserData.posto.toUpperCase();
                     const optUser = document.createElement('option');
                     optUser.value = postoUsuario;
                     optUser.textContent = `üìç ${postoUsuario} (Meu Posto)`;
                     sel.appendChild(optUser);
                     sel.value = postoUsuario; // Seleciona automaticamente
                     filtrarListasDashboard(); // Chama o filtro inicial
                }

                Array.from(setores).sort().forEach(s => {
                    // Evita duplicar se j√° foi adicionado como posto do usu√°rio
                    if (s !== currentUserData.posto?.toUpperCase()) {
                        const opt = document.createElement('option'); 
                        opt.value = s; 
                        opt.textContent = s; 
                        sel.appendChild(opt);
                    }
                });

            } catch(e) {
                console.error("Erro ao carregar listas:", e);
                const sel = document.getElementById('dash-select-setor');
                sel.innerHTML = '<option value="" disabled selected>Erro ao carregar</option>';
            }
        }

        function filtrarListasDashboard() {
            const setor = document.getElementById('dash-select-setor').value;
            const selLista = document.getElementById('dash-select-lista');
            selLista.innerHTML = '<option value="" disabled selected>Selecione a Lista...</option>'; selLista.disabled = false;
            
            const fil = allLists.filter(l => l.setor === setor).sort((a,b)=>a.nome.localeCompare(b.nome));
            
            fil.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l.id; 
                o.textContent = l.nome; 
                selLista.appendChild(o); 
            });
            
            selLista.focus();
        }

        function focarBotaoIniciar() { document.getElementById('btn-start-dash').focus(); }

        function iniciarConferenciaDashboard() {
            const listaId = document.getElementById('dash-select-lista').value;
            const listaSelect = document.getElementById('dash-select-lista');
            const nomeLista = listaSelect.options[listaSelect.selectedIndex].text;
            const postoSetor = document.getElementById('dash-select-setor').value;
            
            if(!listaId) return alert("Selecione uma lista.");
            
            // Adiciona o novo par√¢metro 'posto_setor' na URL
            const url = `conferencia_app.html?id=${listaId}&posto_grad=${encodeURIComponent(currentUserData.posto)}&quadro_mil=${encodeURIComponent(currentUserData.quadro)}&nome_guerra=${encodeURIComponent(currentUserData.nome_guerra)}&posto_setor=${encodeURIComponent(postoSetor)}`;
            
            // Salva para resume
            localStorage.setItem('sigma_active_conf', JSON.stringify({
                id: listaId, nomeLista: nomeLista, user: currentUserData.nome_guerra, url: url
            }));
            verificarConferenciaAtiva();

            const container = document.getElementById('app-runner-container');
            const iframe = document.getElementById('app-iframe');
            iframe.src = url; container.style.display = 'block';
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'SIGMA_FINISHED') {
                document.getElementById('app-runner-container').style.display = 'none';
                document.getElementById('app-iframe').src = "";
                
                localStorage.removeItem('sigma_active_conf');
                verificarConferenciaAtiva();

                // Recarrega a lista do dia
                if(currentView === 'dashboard') {
                    carregarConferenciasHoje();
                }

                alert("Confer√™ncia salva!");
            }
        });
        
        // --- 6. HIST√ìRICO DO DIA (NOVO) ---
        async function carregarConferenciasHoje() {
            const ul = document.getElementById('today-list'); ul.innerHTML = '<li>Carregando...</li>';
            try {
                // Filtra pelo conferente atual e pega os 20 mais recentes (otimiza√ß√£o)
                const snap = await db.collection(COLECAO_RESULTADOS)
                                     .where('conferente', '==', currentUserData.nome_militar_completo)
                                     .limit(20)
                                     .get();
                
                const hojeStr = new Date().toLocaleDateString('pt-BR');
                let docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                let html = '';
                docs.forEach(d => {
                    const dt = d.timestamp.toDate();
                    // Filtra apenas os documentos do dia corrente
                    if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                        html += criarItemHistoricoHTML(d);
                    }
                });
                
                ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nenhuma confer√™ncia realizada hoje.</li>';
            } catch(e){ 
                console.error("Erro ao carregar hoje:", e); 
                ul.innerHTML = 'Erro ao carregar hist√≥rico do dia.'; 
            }
        }
        
        // --- 7. HIST√ìRICO COMPLETO COM FILTRO ---
        async function loadMyHistory() {
            const ul = document.getElementById('my-history-list'); 
            ul.innerHTML = '<li>Buscando...</li>';
            
            const startDateValue = document.getElementById('my-hist-start').value;
            const endDateValue = document.getElementById('my-hist-end').value;

            if (!startDateValue || !endDateValue) {
                ul.innerHTML = '<li style="padding:20px; text-align:center; color:#999;">Preencha a Data Inicial e Final para filtrar.</li>';
                return;
            }

            const dI = new Date(startDateValue + 'T00:00:00');
            const dF = new Date(endDateValue + 'T23:59:59');
            
            try {
                // Busca no hist√≥rico do usu√°rio
                const snap = await db.collection(COLECAO_RESULTADOS)
                                     .where('conferente', '==', currentUserData.nome_militar_completo)
                                     // N√£o usar startAt/endAt com where != para evitar erro
                                     .get(); 
                
                let docs = [];
                snap.forEach(doc => docs.push(doc.data()));
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                let html = '';
                docs.forEach(d => {
                    const dt = d.timestamp.toDate();
                    // Filtra manualmente pelo range de datas
                    if(dt >= dI && dt <= dF) html += criarItemHistoricoHTML(d);
                });
                
                ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nada encontrado no per√≠odo selecionado.</li>';
            } catch(e){ 
                console.error("Erro ao carregar hist√≥rico:", e); 
                ul.innerHTML='Erro ao buscar hist√≥rico.'; 
            }
        }

        function criarItemHistoricoHTML(data) {
            // Verifica se a data √© um objeto Timestamp e a converte, se necess√°rio
            const dataHora = (data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp)).toLocaleString('pt-BR');
            
            // Verifica se tem C/A. O novo campo 'itensCaa' √© mais robusto.
            const temAlteracao = (data.itensCaa && data.itensCaa.length > 0);
            
            // Usa o JSON.stringify() para passar o objeto de dados completo para a fun√ß√£o JS do bot√£o
            const dataString = JSON.stringify(data).replace(/'/g, '&#39;'); 

            return `<li class="history-item"><div class="hist-info"><strong>${data.local}</strong><small>${data.conferente} ‚Ä¢ ${dataHora}</small></div><div style="display:flex;align-items:center;"><span class="hist-status ${temAlteracao?'status-alert':'status-ok'}">${temAlteracao?'C/A':'S/A'}</span><button class="btn-reprint" onclick='reimprimirPDF(${dataString})'><i class="fas fa-file-pdf"></i></button></div></li>`;
        }

        // --- 8. L√ìGICA DE PDF (COPIADA DO DASHBOARD) ---
        window.reimprimirPDF = function(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const MARGIN = 15;
            let currentY = MARGIN;

            // --- Configura√ß√£o e Dados Gerais ---
            doc.setFont('helvetica');

            // Header/T√≠tulo
            doc.setFontSize(10);
            doc.setTextColor(128, 0, 32); // Cor do SIGMA
            doc.text(`CORPO DE BOMBEIROS MILITAR DE RORAIMA - SISTEMA SIGMA`, MARGIN, currentY);
            currentY += 5;
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(51, 51, 51);
            doc.text(`RELAT√ìRIO DE CONFER√äNCIA DE MATERIAL (RCM)`, MARGIN, currentY);
            currentY += 8;

            // Dados da Confer√™ncia
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(51, 51, 51);
            
            const dataHora = data.timestamp.toDate().toLocaleString('pt-BR');
            const dataInfo = [
                [`Data/Hora:`, `${dataHora}`],
                [`Local/Lista:`, `${data.local}`],
                [`Conferente:`, `${data.conferente}`],
                [`Unidade:`, `${data.unidade}`]
            ];
            
            doc.autoTable({
                startY: currentY,
                body: dataInfo,
                theme: 'plain',
                styles: { cellPadding: 1, fontSize: 10, textColor: 51 },
                columnStyles: { 0: { fontStyle: 'bold' } },
                margin: { left: MARGIN, right: MARGIN }
            });
            currentY = doc.autoTable.previous.finalY + 5;

            // --- Agrupamento dos Dados ---

            // 1. Agrupar Itens por Setor (Campo 'setor_nome' adicionado na Confer√™ncia)
            const groupedItems = data.itensRelatorio.reduce((acc, item) => {
                const setor = item.setor_nome || 'GERAL'; // Usa 'GERAL' se o campo n√£o existir (compatibilidade)
                if (!acc[setor]) {
                    acc[setor] = [];
                }
                acc[setor].push(item);
                return acc;
            }, {});

            // 2. Iterar sobre os Setores e gerar tabelas
            Object.keys(groupedItems).sort().forEach(setor => {
                const items = groupedItems[setor];

                // T√≠tulo do Setor
                if (currentY + 10 > 280) { // Verifica se cabe o t√≠tulo + 1 linha
                    doc.addPage();
                    currentY = MARGIN;
                }
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(128, 0, 32); // Cor do SIGMA
                doc.text(`SETOR: ${setor}`, MARGIN, currentY);
                currentY += 4;

                // Tabela de Itens (filtrando apenas o necess√°rio para o PDF)
                const tableBody = items.map(item => {
                    const statusText = item.status === 'S/A' ? 'Sem Altera√ß√£o' : (item.status === 'C/A' ? 'Com Altera√ß√£o' : item.status);
                    const isAlert = item.status !== 'S/A';
                    
                    // Constr√≥i a OBS: Tombamentos ou Simples
                    let obs = '';
                    if (item.tipo === 'multi' && item.tombamentos) {
                        const caaList = item.tombamentos.filter(t => t.status !== 'OK').map(t => `${t.tomb}: ${t.status}`).join(' | ');
                        if (caaList) {
                            obs = `C/A - Tombamentos: ${caaList}`;
                        } else {
                            obs = `Controle de Tombamento: OK (${item.tombamentos.length})`;
                        }
                    } else if (item.observacao) {
                        obs = item.observacao;
                    }

                    return [
                        item.nome,
                        `${item.quantidadeAtual || item.quantidadeEsperada} / ${item.quantidadeEsperada}`, // Qtd Atual / Qtd Esperada
                        statusText,
                        obs
                    ];
                });

                doc.autoTable({
                    startY: currentY,
                    head: [['Material', 'Qtd (Atual/Esperada)', 'Status', 'Observa√ß√£o']],
                    body: tableBody,
                    theme: 'grid',
                    styles: { 
                        cellPadding: 2, 
                        fontSize: 8, 
                        textColor: 51,
                        lineColor: 200, 
                        lineWidth: 0.1 
                    },
                    headStyles: { 
                        fillColor: [240, 240, 240], 
                        textColor: [51, 51, 51], 
                        fontStyle: 'bold' 
                    },
                    columnStyles: {
                        0: { cellWidth: 40 }, 
                        1: { cellWidth: 25, halign: 'center' },
                        2: { cellWidth: 20, halign: 'center' },
                        3: { cellWidth: 'auto' }
                    },
                    didDrawCell: (data) => {
                        // Destaca linhas com C/A
                        const itemData = items[data.row.index];
                        if (itemData && itemData.status !== 'S/A') {
                            if (data.section === 'body') {
                                doc.setFillColor(255, 230, 230); // Rosa claro
                                doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                            }
                        }
                    },
                    margin: { left: MARGIN, right: MARGIN }
                });
                currentY = doc.autoTable.previous.finalY + 5;
            });


            // --- Footer ---
            if (currentY + 20 > 280) { 
                doc.addPage();
                currentY = MARGIN;
            }

            doc.setFontSize(10);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(150, 150, 150);
            doc.text(`Documento gerado pelo SIGMA em ${new Date().toLocaleString('pt-BR')}`, MARGIN, doc.internal.pageSize.height - 10);
            
            // Salvar
            doc.save(`RCM_${data.local}_${data.timestamp.toDate().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
        };
    </script>
</body>
</html>
