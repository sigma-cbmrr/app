<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Gestão & Comando</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="sigma-comum.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9; 
            color: #333; 
            margin: 0; 
            display: flex; 
            min-height: 100vh; 
            padding-top: 50px; 
            padding-bottom: 60px; 
            box-sizing: border-box; 
            overflow-x: hidden;
        }
        
        /* Header */
        .main-header { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 50px; 
            background-color: #800020; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000;
            display: flex; 
            align-items: center; 
            padding: 0 15px; 
            box-sizing: border-box; 
            gap: 10px;
        }
        .header-icon { 
            height: 40px; 
            width: auto;
        } 
        .header-title-desktop, .header-title-mobile { 
            font-weight: bold; 
            font-size: 1.1em; 
            line-height: 1.2;
        } 
        .text-white { 
            color: white; 
        } 
        .text-red { 
            color: #FF3B3B;
        } 
        .header-title-desktop { 
            display: none; 
        } 
        .header-title-mobile { 
            display: block;
        }
        /* 1. Sobrescreve a classe de ação para garantir que seja APENAS um ícone */
        .btn-logout-header {
            /* Anulação da Caixa */
            background: transparent !important; /* Garante fundo transparente, anulando o .btn-modern-action */
            border: none !important;      /* Remove bordas */
            box-shadow: none !important;  /* Remove sombras */
            padding: 0 !important;        /* Remove o padding que cria o tamanho da caixa */
            margin-left: auto !important; /* Mantém o alinhamento à direita */
    
            /* Visibilidade do Ícone */
            color: white !important;      /* Cor branca para o ícone */
            font-size: 0;                 /* Define a fonte do botão como zero para ocultar qualquer texto residual */
        }

        /* 2. Força o ícone (i) a ter o tamanho correto e ser branco */
        .btn-logout-header i {
            color: white !important;
            font-size: 1.5em !important; /* Define o tamanho final do ícone (ajuste se necessário) */
            padding: 5px; /* Adiciona uma área de clique maior ao redor do ícone */
            display: inline-block; /* Garante que o ícone seja renderizado corretamente */
        }

        /* 3. Garante que não haja fundo branco/estranho ao interagir */
        .btn-logout-header:hover,
        .btn-logout-header:active,
        .btn-logout-header:focus {
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
            color: white !important;
        }
        #menu-btn { 
            display: none; 
            background: none; 
            border: none; 
            color: white;
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 0 5px; 
        }
        .profile-badge { 
            background-color: #800020; /* Cor sólida SIGMA (vermelho escuro) */
            color: white; /* Mantém o texto branco no fundo vermelho escuro */
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 0.8em; 
            margin-left: 0; /* Remove a margem horizontal desnecessária na sidebar */
            border: 1px solid rgba(255,255,255,0.5); /* Borda mais visível */
        }
        #sidebar-user-info .profile-badge {
            /* Garante que o badge tenha margem superior para espaçamento */
            margin-top: 5px; 
            margin-left: 0;
        }

        @media (min-width: 768px) { 
            .header-title-desktop { 
                display: block; 
                font-size: 1.2em;
            } 
            .header-title-mobile { 
                display: none; 
            } 
            #menu-btn { 
                display: none;
            } 
        }
        
        /* Sidebar */
        .sidebar { 
            width: 250px;
            background-color: #ffffff; 
            color: #333; 
            padding-top: 20px; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); 
            border-right: 1px solid #e0e0e0; 
            position: fixed;
            top: 50px; 
            left: 0; 
            height: calc(100% - 50px); 
            display: flex; 
            flex-direction: column; 
            z-index: 1100; 
            overflow-y: auto; 
            transition: left 0.3s ease;
        }
        .sidebar-header { 
            text-align: center; 
            padding: 10px 0 20px 0;
            border-bottom: 1px solid #eee; 
            margin-bottom: 10px; 
        } 
        .sidebar-header img { 
            width: 60px;
            height: auto; 
            margin-bottom: 5px; 
        } 
        #sidebar-user-info {
            /* Define o estilo principal do texto */
            font-size: 1.1em;
            font-weight: bold;
            color: #800020; /* Cor do SIGMA */
            margin: 0; /* Remove margens extras */
            line-height: 1.4;
            display: flex; /* Permite alinhar nome e badge lado a lado */
            flex-direction: column; /* Empilha Nome e Badge */
            align-items: center; /* Centraliza verticalmente o texto */
        }
        #sidebar-user-info #user-name {
            /* Estilo para o nome */
            display: block;
            margin-bottom: 5px; /* Espaço entre nome e badge */
            font-size: 0.9em; /* Um pouco menor que o título */
            color: #333;
        }
        .sidebar a { 
            padding: 15px 20px; 
            text-decoration: none; 
            font-size: 1em;
            color: #555; 
            display: block; 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent; 
            cursor: pointer;
        } 
        .sidebar a:hover { 
            background-color: #fff5f5; 
            color: #800020;
        } 
        .sidebar a.active { 
            background-color: #ffecec; 
            color: #800020; 
            font-weight: bold;
            border-left: 4px solid #d90f23; 
        } 
        .menu-label { 
            padding: 15px 20px 5px;
            font-size: 0.85em; 
            color: #999; 
            text-transform: uppercase; 
            font-weight: bold; 
        }
        .sidebar-overlay { 
            display: none;
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1050;
        }

        /* Content */
        .content { 
            margin-left: 250px;
            flex-grow: 1; 
            padding: 20px; 
            box-sizing: border-box; 
            width: calc(100% - 250px); 
            padding-bottom: 80px;
        } 
        .view-section { 
            display: none; 
            animation: fadeIn 0.3s ease;
        } 
        .view-section.active-view { 
            display: block;
        }
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
            } 
            to { 
                opacity: 1;
            } 
        }

        /* Footer */
        .footer-central { 
            position: fixed;
            bottom: 0; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            padding: 5px 0 5px; 
            background-color: #f4f4f9; 
            color: #555; 
            font-size: 0.65em; 
            line-height: 1.3;
            z-index: 100; 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        } 
        .footer-central strong, .footer-autor { 
            display: block; 
            width: 100%; 
            text-align: center;
        } 
        .footer-central strong { 
            font-weight: bold; 
        } 
        .footer-autor { 
            margin-top: 10px; 
            color: #888; 
            font-size: 0.9em;
        }

        /* Cards e Grid */
        /* Cards e Grid */
.cards-grid { 
    display: flex;
/* flex-wrap: wrap;  */
    flex-wrap: wrap; 
    gap: 20px; 
    margin-bottom: 30px; 
} 
.sector-card { 
    background-color: white;
/* padding: 15px;  */
    padding: 15px; 
    min-height: 100px; /* ⬅️ AJUSTE: Altura mínima aumentada para garantir alinhamento com cards de lista */
    border-radius: 8px;
/* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
/* A chave: Força o item a ter 280px como largura base e permite que o flexbox o organize */
    flex: 0 0 220px;
/* max-width: 100%; */ 
    max-width: 100%;
/* /* Garante que não ultrapasse a tela em mobile */ */
    cursor: pointer;
/* /* transition: transform 0.2s, box-shadow 0.2s;  */
    transition: transform 0.2s, box-shadow 0.2s; 
    display: flex; 
    flex-direction: column;
/* justify-content: space-between; */
    justify-content: space-between;
}
        /* Garante que o elemento principal dos Cards de Pendência/Estatística tenha altura para empurrar o rodapé */
        .sector-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background-color: #fff5f5; 
        }
        .sector-card.status-alert { 
            border-left: 5px solid #d90f23;
        } 
        .sector-card.status-ok { 
            border-left: 5px solid #1b8a3e; 
        } 
        .sector-card.status-unit { 
            border-left: 5px solid #2c7399;
        } 
        .sector-card.status-posto { 
            border-left: 5px solid #8e44ad; 
        }
        .sector-card.active-card { 
            background-color: #ffecec;
            border: 1px solid #d90f23; 
            border-left: 5px solid #d90f23; 
        }
        .sector-card h3 { 
            margin-top: 0;
            font-size: 1.1em; 
            color: #333; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .sector-card .main-stat { 
            display: flex;
            align-items: center; 
            justify-content: space-between; 
            margin: 10px 0; 
        }
        .sector-card .count-value { 
            font-size: 2em;
            font-weight: bold; 
        }
        .sector-card.status-alert .count-value { 
            color: #d90f23;
        } 
        .sector-card.status-ok .count-value { 
            color: #1b8a3e; 
        }
        .sector-card .card-footer { 
            font-size: 0.75em;
            color: #777; 
            margin-top: 10px; 
            pt: 10px; 
            border-top: 1px solid #eee; 
            line-height: 1.4;
        }
        /* ==================================== */
/* NOVO: ESTILOS PARA CARDS DO MENU GESTÃO DE CAUTELAS */
/* Usa .sector-card + .menu-card para herdar a base de estilos */
/* ==================================== */

.menu-card {
    /* Garante que o cartão ocupe no mínimo 250px, tornando o layout mais flexível */
    flex: 1 1 0; 
    padding: 25px; 
    text-align: center;
    /* Remove a borda lateral de status que outros cards podem ter */
    border-left: none !important;
}
@media (min-width: 900px) {
    /* Força o grid do menu de cautelas a ter 4 colunas de tamanho igual */
    #cautelas-options-container {
        /* Aumentamos a especificidade para garantir o layout de 4 colunas */
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 15px; 
    }
}

/* Ajusta o hover para ser visualmente mais forte e manter a cor institucional */
.menu-card:hover {
    transform: translateY(-3px); /* Leve levantamento */
    /* Usa a cor principal do sistema (#800020) na sombra */
    box-shadow: 0 6px 15px rgba(128, 0, 32, 0.2); 
    background-color: #fff8f8;
}

/* Estilo do Ícone (a ser usado dentro do .menu-card) */
.menu-card .card-icon {
    font-size: 3em; 
    color: #800020; /* Cor Institucional */
    margin-bottom: 10px;
    display: block;
}

/* Estilo do Título dentro do Card de Menu */
.menu-card h3 {
    font-size: 1.2em;
    color: #333;
    margin-top: 0;
    margin-bottom: 5px;
}

/* Estilo da Descrição/Parágrafo */
.menu-card p {
    font-size: 0.9em;
    color: #666;
    margin: 0;
}
        .sub-list-preview { 
            font-size: 0.85em; 
            color: #555; 
            list-style: none; 
            padding: 0; 
            margin: 0;
            max-height: 60px; 
            overflow: hidden; 
        }
        .sub-list-preview li { 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        /* Greeting Card */
        .greeting-card { 
            /* Estilos Visuais */
            background: linear-gradient(135deg, #800020 0%, #5a0017 100%);
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 10px rgba(128, 0, 32, 0.2); 
    
            /* Configuração Flexbox */
            display: flex;
            flex-wrap: wrap; /* ✅ ESSENCIAL: Permite que a foto e o bloco de info (.greeting-info) quebrem em telas pequenas. */
            align-items: center;
            gap: 20px; 
        }
        .greeting-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            flex-basis: auto;
            border: 3px solid rgba(255,255,255,0.3); 
            object-fit: cover; 
            background-color: white; 
        }
        .greeting-info { 
            display: flex;
            flex-wrap: wrap; /* Permite a quebra de linha em mobile */
            align-items: center; 
            flex-grow: 1; /* Ocupa o máximo de espaço possível */
            gap: 15px;
            flex-basis: 0;
        }
        .greeting-text-wrapper {
            flex-grow: 1;
            margin-bottom: 10px;
            order: 0;
        }
        #btn-open-conf-modal {
            margin-left: auto; /* Empurra o botão para a direita em desktop */
            justify-content: center !important; 
            text-align: center;
        }
        .greeting-title { 
            margin: 0; 
            font-size: 1.3em; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .greeting-date { 
            font-size: 0.85em; 
            opacity: 0.8; 
            margin-top: 3px; 
            display: block;
            font-style: italic;
        }
        .greeting-user { 
            font-size: 1.1em; 
            margin-top: 5px; 
            display: block; 
            font-weight: 500;
        }
        .greeting-title, .greeting-user { 
            white-space: nowrap; /* Impede quebras de linha dentro do texto */
            overflow: hidden;
            text-overflow: ellipsis; /* Adiciona "..." se o texto for muito longo */
            max-width: 100%; /* Garante que respeite o pai */
            display: block;
        }
        .btn-dial-mobile {
            display: none !important;
        }

        /* Card de Nova Conferência / Filtros */
        .op-card { 
            background: white;
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            padding: 25px; 
            margin-bottom: 25px; 
            border-left: 5px solid #ccc;
        }
        .op-card.action { 
            border-left-color: #1b8a3e;
        }
        .op-card.history { 
            border-left-color: #2c7399;
        }
        .op-card.resume { 
            border-left-color: #f57c00; 
            background-color: #fff3e0; 
            cursor: pointer; 
            transition: transform 0.2s;
            padding: 25px 35px 25px 25px; /* Adiciona 35px de padding na direita */
            position: relative;
        }
        .op-card.resume:hover { 
            transform: translateY(-2px);
        }
        
        .op-card-title { 
            color: #333;
            margin-top: 0; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 10px; 
            font-size: 1.2em; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .form-group { 
            margin-bottom: 15px;
        }
        .form-group label { 
            display: block; 
            font-weight: bold; 
            color: #555; 
            margin-bottom: 5px;
            font-size: 0.9em; 
        }
        .form-group select, .form-group input { 
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box;
            /* Garante que todos os inputs de formulário herdem a fonte base */
            font-family: inherit; 
        }
        
        /* Regra específica para inputs de data no Chrome/Edge/Firefox, forçando a fonte */
         input[type="date"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }
        .form-group select:focus, .form-group input:focus { 
            border-color: #800020;
            outline: none; 
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
        }
        .btn-start { 
            background: linear-gradient(135deg, #d90f23 0%, #800020 100%); 
            color: white; 
            border: none;
            width: 100%; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(217, 15, 35, 0.3);
        }
        .btn-start:focus { 
            outline: 3px solid rgba(128,0,32,0.4);
        }

        /* Admin Tables & Lists */
        .new-local-section { 
            background: #fff;
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            border-top: 3px solid #2c7399;
        }
        .admin-table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border-radius: 8px; 
            overflow: hidden; 
            margin-bottom: 20px;
        }
        .admin-table th, .admin-table td { 
            padding: 12px 15px; 
            text-align: center;
            border-bottom: 1px solid #eee; 
        }
        .admin-table th { 
            background-color: #f8f9fa; 
            font-weight: bold;
            color: #555; 
            text-transform: uppercase; 
            font-size: 0.85em;
        }
        .role-badge { 
            padding: 3px 8px;
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold; 
            color: white; 
        }
        .role-admin { 
            background-color: #d90f23;
        } 
        .role-gestor { 
            background-color: #f57c00; 
        } 
        .role-operacional { 
            background-color: #1b8a3e;
        }
        
        /* Editor de Listas (Elementos) */
        .admin-container { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto;
            text-align: center; 
        }
        .lista-setores { 
            padding: 0; 
            list-style: none; 
            text-align: left;
        }
        .setor-item { 
            margin-bottom: 15px; 
            border: 1px solid #800020; 
            border-radius: 6px; 
            background: #fff;
        }
        .item-list-admin {}
        .setor-content-header-sticky {
            /* Tornar o contêiner do cabeçalho e formulário sticky */
            position: sticky;
            top: 50px; /* Bate logo abaixo do main-header (50px) */
            z-index: 50;
            /* Garante que fique acima dos itens rolando */
            background-color: #fff;
            /* Fundo branco para cobrir o conteúdo rolando */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            /* Sombra suave para destacar */
        }
        .setor-header-admin { 
            background-color: #800020; 
            color: white;
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            cursor: grab; 
            z-index: 51;
        }
        .setor-content-admin { 
            transition: max-height 0.4s ease-out;
            /* Removemos o max-height alto e o overflow: hidden */
            max-height: 1500px;
            /* Define uma altura máxima visível */
            overflow-y: auto;
            /* PERMITE A ROLAGEM VERTICAL */
            padding: 10px 10px 10px;
        }
        #lista-setores-container {
             border: none !important;
             margin-top: 20px; 
        }
        .setor-content-admin.collapsed { 
            max-height: 0;
            padding: 0 !important; 
            overflow-y: hidden; /* Oculta a barra quando colapsado */
        }
        .item-conferencia-admin { 
            display: flex;
            justify-content: space-between; 
            align-items: flex-start; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
            cursor: move;
        }
        .add-item-form-setor { 
            padding: 10px 15px 5px; 
            background-color: #f8f8f8; 
            display: flex; 
            gap: 5px;
            margin-bottom: 0; 
        }
        .add-item-form-setor input, .add-item-form-setor select { 
            flex-grow: 1; 
            padding: 8px;
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        .tombamento-container-wrapper { 
            margin-top: 5px; 
            padding-left: 20px;
            background: #f9f9f9; 
            border-left: 3px solid #ccc; 
            width: 100%; 
            box-sizing: border-box;
        }
        .tombamento-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 0;
            border-bottom: 1px dotted #eee; 
        }
        .item-actions-admin { 
            display: flex; 
            gap: 5px;
        }
        .btn-remover { 
            background-color: #d90f23; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        } 
        .btn-edit-alt { 
            background-color: #7f8c8d; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        }
        .btn-add { 
            background-color: #800020; 
            color: white; 
            border: none; 
            padding: 8px 15px;
            border-radius: 4px; 
            cursor: pointer; 
        }
        .locais-list { 
            list-style: none; 
            padding: 0;
        }
        .local-item { 
            background: white; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 5px solid #800020;
        }
        .local-info strong { 
            display: block; 
            font-size: 1.1em; 
            color: #333;
        }

        /* CA Table */
        .ca-table-container { 
            overflow-x: auto;
            background-color: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            margin-top: 10px; 
            border-top: 3px solid #d90f23;
        } 
        .ca-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9em;
        } 
        .ca-table th, .ca-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
            vertical-align: top;
        } 
        .ca-table th { 
            background-color: #f8f8f8; 
            color: #800020; 
            font-weight: bold; 
            text-transform: uppercase;
        }
        .row-amarelo { 
            background-color: #fff9c4 !important; 
        } 
        .row-laranja { 
            background-color: #ffe0b2 !important;
        } 
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold;
        } 
        .badge-pendente { 
            background-color: #ffebee; 
            color: #d32f2f; 
        } 
        .badge-solucao { 
            background-color: #fff9c4; 
            color: #fbc02d; 
            border: 1px solid #fbc02d;
        } 
        .badge-cautela { 
            background-color: #ffe0b2; 
            color: #f57c00; 
            border: 1px solid #f57c00;
        }

        /* Modals - ESTILO PREMIUM */
        .modal-overlay { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 2000;
        } 
        .modal-content { 
            background: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            width: 90%;
            max-width: 500px; 
            position: relative; 
            text-align: left; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        } 
        .modal-content h2 { 
            margin-top: 0; 
            color: #800020; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px; 
            font-size: 1.4em; 
        } 
        .modal-content label { 
            display: block; 
            margin-top: 15px;
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #444; 
            font-size: 0.95em; 
        } 
        
        /* Inputs Premium no Modal */
        .modal-content input[type="text"], 
        .modal-content input[type="number"],
        .modal-content select, 
        .modal-content textarea { 
            width: 100%;
            padding: 12px; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 1em; 
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
            border-color: #800020;
            outline: none;
            box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
        }
        
        .modal-content textarea { 
            height: 100px;
            resize: vertical; 
        } 
        .modal-buttons { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px;
            margin-top: 10px; 
        } 
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px;
            background: none; 
            border: none; 
            font-size: 20px; 
            cursor: pointer; 
            color: #999; 
            transition: color 0.2s;
        }
        .close-btn:hover { 
            color: #d90f23;
        }
        /* --- ADICIONE ESTES ESTILOS AO BLOCO <style> DO sigma_dashboard.html.txt --- */

.modal-content button { 
    padding: 10px 20px; 
    margin-top: 20px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
    transition: background-color 0.3s; 
    font-weight: bold; 
}

.modal-btn-cancel { 
    background-color: #ccc; 
    color: #333; 
}

.modal-btn-cancel:hover { 
    background-color: #bbb; 
}

.modal-actions { 
    display: flex; 
    justify-content: flex-end; 
    gap: 10px; /* Adiciona espaçamento entre os botões */
}
/* --- NOVO ESTILO PREMIUM PARA ABAS --- */
.tab-navigation {
        flex-wrap: nowrap; 
        overflow-x: auto; /* Permite a rolagem horizontal */
        -webkit-overflow-scrolling: touch; 
        box-shadow: none !important;
        padding: 0 10px; /* Padding lateral no mobile */
    }

/* Regra base do botão: Visual Plano e Limpo */
.tab-button {
    background-color: transparent !important;
    border: none !important; /* Remove todas as bordas do botão */
    color: #555 !important; /* Cor de texto padrão (cinza) */
    padding: 10px 0 !important; /* Padding vertical, zero horizontal */
    font-weight: 600;
    transition: all 0.2s ease;
    cursor: pointer;
    margin-bottom: -2px; /* Ajuste para sobrepor a linha, se houver */
    position: relative;
    font-size: 1em;
}

/* Efeito Hover/Foco: Sublinha e Muda Cor */
.tab-button:hover,
.tab-button:focus {
    color: #800020 !important; /* Cor institucional no hover */
    background-color: transparent !important;
}

/* Estilo Ativo: Ícone, Cor, e Underline Forte */
.tab-button.active {
    color: #800020 !important; 
    font-weight: bold;
    border: none !important;
}

/* O underline premium é um pseudo-elemento da aba ativa */
.tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -2px; /* Desce um pouco para o rodapé */
    left: 0;
    width: 100%;
    height: 3px;
    background-color: #d90f23; /* Vermelho mais forte (Destaque) */
    border-radius: 2px;
    transition: width 0.3s ease;
}

/* Estilo do Ícone na aba */
.tab-button i {
    margin-right: 8px;
    font-size: 1.1em;
    vertical-align: middle;
}
        .tab-button:not(:last-child) {
    margin-right: 40px; /* Adiciona 40px de espaço à direita, exceto no último botão */
}

.historico-tab-content {
    background-color: #fff;
    border: 1px solid #ddd;
    border-top: 2px solid #800020; /* Borda da cor da aba ativa */
    padding: 15px;
    border-radius: 0 6px 6px 6px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

/* Garante que o botão de Recebimento use o estilo btn-modern-action, se ele não estiver pegando */
#btn-receber-cautela {
    /* Exemplo: Se precisar de estilo de ação forte */
    background-color: #1b8a3e; /* Verde Forte */
    color: white;
}
#btn-receber-cautela:hover {
    background-color: #14682f;
}

        /* Checkbox list in modal */
        .checklist-container { 
            max-height: 200px;
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 5px; 
            margin-bottom: 15px;
        }
        .checklist-item { 
            display: flex; 
            align-items: center; 
            padding: 5px; 
            border-bottom: 1px dotted #f0f0f0;
        }
        .checklist-item:hover { 
            background: #fafafa;
        }
        .checklist-item input { 
            width: auto; 
            margin-right: 10px; 
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-modern-action {
            /* PROPRIEDADES DE LAYOUT ORIGINAIS (MANTIDAS) */
            display: inline-flex;
            align-items: center;
            gap: 8px;
    
            /* PROPRIEDADES DE ESTILO E COR (ATUALIZADAS) */
            background-color: #800020; /* Vermelho Escuro (Cor principal do SIGMA) */
            color: #ffffff !important; /* Força a cor branca */
            border: none;
            padding: 8px 15px; /* Tamanho ligeiramente menor para botão de 'Voltar' */
            border-radius: 6px; /* Mantive o seu radius original */
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em; /* Tamanho reduzido para ser secundário */
            transition: background-color 0.2s, box-shadow 0.2s; /* Ajuste na transição */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Sombra mais destacada */
            white-space: nowrap; 
        }
        .btn-modern-action:hover {
            background-color: #a00030; /* Um pouco mais claro no hover */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .btn-modern-action:active { 
            transform: translateY(1px);
            box-shadow: none; 
        }
        .btn-create {
            background-color: #2c7399; /* Seu Azul original */
            color: #ffffff !important; 
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .btn-create:hover {
            background-color: #205b7a; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .btn-form-action {
            width: 100%;
            margin-top: 15px; /* Adiciona um espaço acima do botão no formulário */
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .btn-edit { 
            background-color: #2c7399; 
        } 
        .btn-delete { 
            background-color: #d90f23;
        } 
        .btn-sync { 
            background-color: #1b8a3e; 
        } 
        .btn-backup { 
            background: #5d6164;
        }
        .btn-filter-modern { 
            background-color: #2c7399; 
            color: white; 
            border: none; 
            padding: 11px 25px;
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        

        /* APP CONTAINER (IFRAME) */
        #app-runner-container { 
            display: none;
            position: fixed; 
            top: 50px; 
            left: 250px; 
            width: calc(100% - 250px); 
            height: calc(100vh - 50px); 
            background: white; 
            z-index: 500; 
            overflow: hidden;
        }
        #app-iframe { 
            width: 100%; 
            height: 100%; 
            border: none;
        }

        /* History List Specifics */
        .history-list { 
            list-style: none;
            padding: 0; 
            margin: 0; 
        }
        .history-item { 
            border-bottom: 1px solid #eee;
            padding: 15px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background 0.2s;
        }
        .history-item:hover { 
            background-color: #fafafa; 
            padding-left: 5px; 
            padding-right: 5px;
        }
        .history-item:last-child { 
            border-bottom: none;
        }
        .hist-info strong { 
            display: block; 
            color: #333; 
            font-size: 1.05em;
        }
        .hist-info small { 
            color: #777; 
            font-size: 0.9em;
        }
        .hist-status { 
            font-size: 0.8em; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: bold;
            margin-left: 5px; 
            text-transform: uppercase; 
        }
        .status-ok { 
            background-color: #e8f5e9; 
            color: #2e7d32;
            border: 1px solid #c8e6c9; 
        }
        .status-alert { 
            background-color: #ffebee; 
            color: #c62828;
            border: 1px solid #ffcdd2; 
        }
        .btn-reprint { 
            background: white; 
            border: 1px solid #ddd;
            padding: 8px 12px; 
            border-radius: 6px; 
            color: #555; 
            cursor: pointer; 
            font-size: 0.9em; 
            display: flex; 
            align-items: center; 
            gap: 5px;
        }
        .btn-reprint:hover { 
            border-color: #800020; 
            color: #800020; 
            background-color: #fff5f5;
        }

        /* Filtros Premium */
        .modern-filter-card { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #e0e0e0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px; 
            align-items: flex-end; 
        }
        .filter-item { 
            flex: 1; 
            min-width: 200px;
        }
        .filter-item label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: #555;
            font-size: 0.9em; 
        }
        .filter-input { 
            width: 100%; 
            padding: 10px 12px;
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 0.95em; 
            box-sizing: border-box;
        }
        .dashboard-columns {
    display: flex;
    flex-direction: column; /* Em mobile, os blocos ficam empilhados (Mobile-First) */
    gap: 25px; 
}
    /* Regra para garantir o alinhamento vertical centralizado do ícone ao bloco de texto */
.unit-header .unit-flex-title {
    display: flex;
    align-items: center; /* CENTRALIZA O ÍCONE VERTICALMENTE COM O TEXTO QUEBRADO */
    gap: 8px; /* Espaçamento entre o ícone e o texto */
    width: 100%; /* Opcional, para garantir que o H3 preencha a largura */
}

/* Garante que o texto se comporte como um bloco para quebrar corretamente */
.unit-header .unit-flex-title span {
    flex-grow: 1; 
    line-height: 1.3; /* Melhora a leitura do texto quebrado */
}    
        
        /* Mobile */
        @media (max-width: 600px) { 
            .greeting-card {
                align-items: flex-start; /* Alinha o topo da foto com o topo do texto */
            }
            /* O bloco .greeting-info deve ocupar toda a largura abaixo da foto */
            .greeting-info {
                flex-basis: auto; /* Ocupa apenas o espaço necessário ao lado da foto */
                flex-grow: 1;
                margin-top: 0;
        
                /* Define como o TEXTO e o BOTÃO se comportarão internamente */
                flex-direction: row; /* Mantém os filhos (texto e botão) na mesma linha, se possível */
                flex-wrap: wrap; /* CRÍTICO: Permite que APENAS o botão quebre */
                align-items: flex-start;
                gap: 10px;
            }

            /* O wrapper de texto volta a ocupar 100% da linha do .greeting-info */
            .greeting-text-wrapper {
                flex-basis: 100%; /* ✅ NOVO: Força o texto a ocupar 100% da largura DISPONÍVEL (ao lado da foto) */
                flex-grow: 1;
                margin-bottom: 0;
            }

            /* O botão é forçado a quebrar e ocupar 100% da largura */
            #btn-open-conf-modal {
                flex-basis: 100%; /* Força a quebra e 100% da largura da área de info */
                margin-top: 15px; 
                margin-left: 0; 
                width: 100%;
                order: 1; /* Garante que o botão venha depois do texto */
            }
            greeting-avatar {
                flex-basis: auto;
            }
           
            #menu-btn { 
                display: block;
            }
            .sidebar { 
                left: -260px;
                width: 260px;
                border-right: 1px solid #ddd; 
            } 
            .sidebar.mobile-active { 
                left: 0;
            } 
            .content, .content-area {
                margin-left: 0 !important; /* Mantenha o que já tinha */
                width: 100% !important; /* Mantenha o que já tinha */
                padding-top: 15px !important; /* Mantenha o que já tinha */
    
                /* FORÇANDO A CORREÇÃO DE ALINHAMENTO LATERAL */
                padding-left: 10px !important;
                padding-right: 10px !important;
            }

            /* 2. Alvo: A Seção Específica (Gestão de Cautelas) */
            .view-section {
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* 3. Alvo: O Cabeçalho (para garantir que ele também alinhe) */
            .header-container {
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* 4. Alvo: O Card de Menu (Anula margens laterais) */
            .menu-card {
                 margin-left: 0 !important;
                margin-right: 0 !important;
            }

            /* 5. Alvo: Garantir que o nível mais externo (se existir) não tenha margem */
            body {
                margin: 0 !important;
            }
            #app-runner-container { 
                left: 0;
                width: 100%; 
                z-index: 500; 
            }
            .modern-filter-card { 
                flex-direction: column;
                align-items: stretch; 
                gap: 10px; 
            }
            .btn-filter-modern { 
                width: 100%;
            }
            .filter-input { 
                max-width: 100%;
                width: 100%;
            }
            .filter-item { 
                width: 100%;
                min-width: 0;
            }
            .admin-container {
                padding: 10px;
                margin-top: 20px;
            }
            .admin-table, .admin-table thead, .admin-table tbody, .admin-table th, .admin-table td, .admin-table tr {
                display: block;
            }
            .admin-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .admin-table tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            .admin-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%; /* Espaço para o "cabeçalho" embutido */
                text-align: right;
                font-size: 0.9em;
            }
            /* Adiciona o "cabeçalho" como um pseudo-elemento */
            .admin-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #800020;
            }
            .admin-table td:last-child {
                text-align: left;
            }
            .admin-table td[data-label="Ações:"], 
            .admin-table td:last-child {
                /* Força o alinhamento de texto à direita */
                text-align: right !important;
                padding-right: 15px !important;
            }
            /* Ações Globais (Salvar, Backup, Importar, +Setor) */
            .global-actions {
                /* Transforma a barra de ações em empilhamento */
                display: flex;
                /*flex-direction: column; */
                flex-direction: column;
                gap: 10px; /* Adiciona espaçamento entre os botões empilhados */
            }
            /* Gestão de Usuários/Unidades/Postos - Grade de Formulário (Criação) */
            .new-local-section > div[style*="grid"] {
                /* Desativa o grid no celular e empilha */
                display: 
                /*block !important; */
                block !important;
            }
            .new-local-section > div[style*="flex"] {
                display: block !important;
            }
            .new-local-section .form-group {
                margin-bottom: 10px;
            }
            .new-local-section .btn-modern-action, .new-local-section .btn-create {
                width: 100%;
                margin-top: 10px;
            }

            /* Cards de Unidades/Postos - Força para 100% de largura */
            .sector-card {
                margin-left: 0 !important; 
                margin-right: 0 !important;
                flex: 1 1 100% !important; 
                max-width: 100% !important;
            }
   
            .cards-grid {
                gap: 20px 0 !important;
                margin-left: 0 !important; /* CORREÇÃO: Remove a margem negativa que causava o desalinhamento */
                margin-right: 0 !important;
            }

            /* Força o formulário de adicionar setor a empilhar também */
            .add-setor-form {
                 flex-direction: column;
                gap: 10px !important;
                margin-left: 0 !important; /* Remove o auto-margin para preencher a largura */
            }
            .add-item-form-setor {
                flex-wrap: wrap;
            }
            .add-item-form-setor input, .add-item-form-setor select, .add-item-form-setor button {
                flex-grow: 1;
                width: 100%;
                box-sizing: border-box;
            }
            .add-item-form-setor button {
                flex-grow: 0;
                width: 48%;
            }
            .item-conferencia-admin {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            .item-actions-admin {
                margin-top: 10px;
                align-self: flex-end;
            }
            .tombamento-container-wrapper {
                padding-left: 10px;
                margin-top: 10px;
            }
            .tombamento-list li {
                flex-wrap: wrap;
                padding: 5px 0;
            }
            .tombamento-list input {
                flex-grow: 1;
            }
            .form-grid-2-columns {
                grid-template-columns: 1fr; /* Empilha os campos em 1 coluna no celular */
            }
            .ca-table, .ca-table thead, .ca-table tbody, .ca-table th, .ca-table td, .ca-table tr {
                display: block;
            }
            .ca-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .ca-table tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            .ca-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%; /* Espaço para o "cabeçalho" embutido */
                text-align: right;
                font-size: 0.9em;
            }
            /* Adiciona o "cabeçalho" como um pseudo-elemento */
            .ca-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #800020;
            }
            .ca-table td:last-child {
                /* Garante que a última coluna (Status) se alinhe à esquerda se precisar */
                text-align: right;
            }
            .tab-navigation {
                /* Força os itens a ficarem na mesma linha */
                flex-wrap: nowrap; 
        
                /* Permite a rolagem horizontal */
                overflow-x: auto; 
        
                /* Oculta a barra de rolagem no iOS */
                -webkit-overflow-scrolling: touch; 
        
                /* Remove a sombra do container para não atrapalhar a rolagem */
                box-shadow: none !important;
        
                /* Garante que o espaçamento interno seja zero (usaremos margens laterais) */
                padding: 0 10px;
            }
    
            /* Remove a margem direita da última aba para que ela termine na borda */
            .tab-button:not(:last-child) {
                margin-right: 20px !important; /* Reduz o espaçamento no mobile para caber mais abas */
            }

            /* Garante que a primeira aba comece na borda */
            .tab-button:first-child {
                margin-left: 0;
            }
            .btn-dial-mobile {
                display: inline-block !important; /* Torna o botão visível */
            }
        }
        @media (min-width: 769px) { 
            .sidebar-overlay { 
                display: none !important;
            }
    
            .dashboard-columns {
                flex-direction: row; 
                /* 💡 CORREÇÃO: Usamos stretch para que os dois blocos (op-card) 
                ocupem 100% da altura do bloco mais alto, igualando o tamanho. */
                align-items: stretch; 
                gap: 20px;
            }
            .dashboard-columns .op-card {
                flex: 1; 
            }
        }
            .restricted-admin-only { 
                display: none;
            }
        /* Estilo específico para o botão de descarte do card de resumo */
.op-card.resume {
    position: relative; /* Necessário para posicionar o botão absoluto */
}
.btn-resume-close {
    position: absolute;
    top: 5px; 
    right: 5px; 
    background: none;
    border: none;
    color: #d90f23; 
    font-size: 1.4em; 
    cursor: pointer;
    padding: 5px;
    opacity: 0.9; 
    transition: color 0.2s, opacity 0.2s;
}
.btn-resume-close:hover {
    color: #FF3B3B; 
    opacity: 1;
}
        /* ==================================== */
/* ESTILOS ESPECÍFICOS DO FORMULÁRIO DE CAUTELAS */
/* ==================================== */

/* Layout de 2 colunas para campos principais no desktop */
.form-grid-2-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px; /* Espaçamento entre os campos */
}

/* Estilo geral para o grupo de campo */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #444;
}

/* Estilo para todos os inputs, selects e textareas */
.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box; /* CRÍTICO: Garante que padding e border não estourem a largura */
    font-size: 1em;
}

/* Área de Listagem/Seleção de Itens */
#itens-custodia-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
}
    </style>
</head>
<body>
    <div id="mobile-overlay" class="sidebar-overlay" onclick="closeMenuMobile()"></div>

   <header class="main-header">
    <button id="menu-btn" onclick="toggleMenuMobile()"><i class="fas fa-bars"></i></button>

    <img src="cbmrr.png" alt="Logo CBM-RR" class="header-icon" 
         style="margin-right: -10px;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/000000/fff?text=CBM'">
    
    <div class="header-title-desktop">
        <span class="text-white"> CORPO DE BOMBEIROS MILITAR </span>
        <span class="text-red">RORAIMA</span>
    </div>

    <div class="header-title-mobile">
        <span class="text-white">CBM</span><span class="text-red">RR</span>
    </div>
    
    <img src="logo_sigma.png" alt="Logo SIGMA" class="header-icon" 
         style="opacity: 0;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=S'">

    <div id="dashboard-greeting" style="display:none; margin-left: 20px; font-size: 0.9em; font-style: italic;">
        Bem-vindo(a)! Preencha a conferência para hoje.
    </div>
    <button onclick="logout()" class="btn-modern-action btn-logout-header" style="margin-left: auto;">
        <i class="fas fa-sign-out-alt"></i> 
    </button>
</header>
    
    <div class="sidebar" id="main-sidebar">
        <div class="sidebar-header">
            <img src="logo_sigma.png" alt="Logo SIGMA" onerror="this.onerror=null; this.src='https://placehold.co/50x50/ffffff/800020/fff?text=S'">
            <div id="sidebar-user-info">
            <span id="user-name"></span>
            <span id="user-role-display" class="profile-badge">Carregando...</span>
        </div>
        </div>
        <div class="menu-label">Operacional</div>
        <a onclick="switchView('dashboard')" id="link-dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard & Serviço</a>
        <a onclick="switchView('my-history')" id="link-my-history"><i class="fas fa-history"></i> Minhas Conferências</a>
        <a onclick="switchView('cautelas')" id="link-cautelas" class="restricted-admin-only"><i class="fas fa-boxes"></i> Gestão de Cautelas</a>
        
        <div class="menu-label restricted-admin-only" id="sidebar-rotulo-admin">Administração</div>
            <a onclick="switchView('listas')" id="link-listas" class="restricted-admin-only"><i class="fas fa-clipboard-list"></i> Editor de Listas</a>
            <a onclick="switchView('global-history')" id="link-global-history"><i class="fas fa-folder-open"></i> Histórico da Unidade</a>
            <a onclick="switchView('unidades')" id="link-unidades" class="restricted-admin-only"><i class="fas fa-shield-alt"></i> Unidades</a>
            <a onclick="switchView('postos')" id="link-postos" class="restricted-admin-only"><i class="fas fa-map-signs"></i> Postos</a>
            <a onclick="switchView('usuarios')" id="link-usuarios" class="restricted-admin-only"><i class="fas fa-users"></i> Usuários</a>
        </div>
    <div id="content-area" class="main-content-wrapper">
        </div>

    <div class="content">
        
        <div id="view-dashboard" class="view-section active-view">
            <div class="greeting-card">
                <img id="greeting-photo" src="https://placehold.co/70x70/ffffff/800020?text=U" class="greeting-avatar">
                <div class="greeting-info">
                    <div class="greeting-text-wrapper"> 
                        <h2 id="greeting-text" class="greeting-title">Carregando...</h2>
                        <span id="greeting-name" class="greeting-user">...</span>
                        <span id="current-date" class="greeting-date">...</span>
                    </div>
                </div>
        
                <button id="btn-open-conf-modal" class="btn-modern-action" style="background-color: #d90f23;" onclick="openNewConferenceModal()">
                    <i class="fas fa-play-circle"></i> Nova Conferência
                </button>
            </div>

            <div id="resume-container"></div>
            <div id="dashboard-content-by-role">
                <div id="admin-gestor-cards-container"></div>
                <div id="operacional-cards-container"></div>
            </div>
    
            <div id="ca-table-wrapper" class="ca-table-container" style="display: none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="table-title" style="margin:0; color:#800020;">Detalhes</h2>
                    <button onclick="fecharTabela()" class="btn-modern-action btn-delete">Fechar</button>
                </div>
                <table class="ca-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Status</th>
                            <th>Alteração</th>
                            <th>Conferente/Data</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="ca-list-body"></tbody>
                </table>
                <div id="no-issues-msg" style="display:none; padding:20px; text-align:center; color:green;">
                    ✅ Tudo OK.
                </div>
            </div>
        </div>
        
        <div id="view-my-history" class="view-section">
            <div class="op-card history">
                <h2 class="op-card-title"><i class="fas fa-history"></i> Minhas Conferências</h2>
                <div class="modern-filter-card">
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                        <input type="date" id="my-hist-start" class="filter-input">
                    </div>
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Final</label>
                        <input type="date" id="my-hist-end" class="filter-input">
                    </div>
                    <div class="filter-item" style="flex: 0;">
                        <button class="btn-filter-modern" onclick="loadMyHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
                <ul id="my-history-list" class="history-list"></ul>
            </div>
        </div>

    <div id="view-global-history" class="view-section">
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-folder-open"></i> Histórico da Unidade (Gestão)</h2>
            <div class="modern-filter-card">
                <div class="filter-item">
                    <label><i class="fas fa-user"></i> Conferente</label>
                    <select id="glob-hist-user" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                    <input type="date" id="glob-hist-start" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Final</label>
                    <input type="date" id="glob-hist-end" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="fas fa-map-marker-alt"></i> Local</label>
                    <select id="glob-hist-local" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item" style="flex: 0;">
                    <button class="btn-filter-modern" onclick="loadGlobalHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>
            <ul id="global-history-list" class="history-list"></ul>
        </div>
    </div>

    <div id="view-usuarios" class="view-section">
    <h1>Gestão de Usuários</h1>
    <div class="new-local-section">
        <h3>Cadastrar Novo Militar</h3>
        
        <div class="form-grid-2-columns" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            
            <div class="form-group"><label>Nome Completo</label><input type="text" id="new-user-completo" placeholder="NOME COMPLETO"></div>
            <div class="form-group"><label>Nome de Guerra</label><input type="text" id="new-user-guerra" placeholder="EX: JHONATH"></div>
            
            <div class="form-group">
                <label>Posto / Graduação</label>
                <select id="new-user-posto">
                    <option value="" disabled selected>Selecione o Posto</option>
                    <option value="CEL">CEL</option>
                    <option value="TEN CEL">TEN CEL</option>
                    <option value="MAJ">MAJ</option>
                    <option value="CAP">CAP</option>
                    <option value="1º TEN">1º TEN</option>
                    <option value="2º TEN">2º TEN</option>
                    <option value="ST">ST</option>
                    <option value="1º SGT">1º SGT</option>
                    <option value="2º SGT">2º SGT</option>
                    <option value="3º SGT">3º SGT</option>
                    <option value="CB">CB</option>
                    <option value="SD">SD</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Quadro</label>
                <select id="new-user-quadro" disabled>
                    <option value="" disabled selected>Selecione o Posto acima</option>
                </select>
            </div>
            
            <div class="form-group"><label>CPF</label><input type="text" id="new-user-cpf" placeholder="000.000.000-00" maxlength="14"></div>
            <div class="form-group"><label>Matrícula</label><input type="text" id="new-user-matricula" placeholder="0000000-000" maxlength="11"></div>
            <div class="form-group"><label>Telefone para Contato</label><input type="text" id="new-user-telefone" placeholder="(00) 00000-0000" maxlength="15"></div>
            
            <div class="form-group"><label>Email (Login)</label><input type="email" id="new-user-email" placeholder="email@cbm.rr.gov.br"></div>
            
            <div class="form-group">
                <label>Perfil</label>
                <select id="new-user-role">
                    <option value="operacional">Operacional</option>
                    <option value="gestor">Gestor de Unidade</option>
                    <option value="admin">Administrador Geral</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Unidade</label>
                <select id="new-user-unit"><option value="">Carregando...</option></select>
            </div>
        </div>
        
        <button class="btn-modern-action btn-create" onclick="criarUsuario()" style="margin-top: 10px;">Salvar Usuário</button>
    </div>
        
        <h3>Usuários Cadastrados</h3>
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="user-search-input"><i class="fas fa-search"></i> Filtrar por Nome de Exibição:</label>
            <input type="text" id="user-search-input" placeholder="Digite o Nome de Exibição (Posto Quadro Nome Guerra)" class="filter-input" oninput="filtrarUsuarios()">
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Militar</th>
                    <th>Telefone para Contato</th>
                    <th>Perfil</th>
                    <th>Unidade</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="users-table-body"></tbody>
        </table>
    </div>

    <div id="view-unidades" class="view-section">
        <h1>Gestão de Unidades</h1>
        <div class="new-local-section">
            <h3>Criar Nova Unidade</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome da Unidade (Ex: 1ª CIA, CBS)</label>
                    <input type="text" id="new-unit-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarUnidade()">Adicionar</button>
            </div>
        </div>
        <h3>Unidades Existentes</h3>
        <div id="units-cards-container" class="cards-grid"></div>
    </div>
  
    <div id="view-postos" class="view-section">
        <h1>Gestão de Postos</h1>
        <div class="new-local-section">
            <h3>Criar Novo Posto</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome do Posto (Ex: ALFA, BRAVO)</label>
                    <input type="text" id="new-posto-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarPosto()">Adicionar</button>
            </div>
        </div>
        <h3>Postos Existentes</h3>
        <div id="postos-cards-container" class="cards-grid"></div>
    </div>

    <div id="view-listas" class="view-section">
        <h1>Editor de Listas</h1>
        <div class="new-local-section">
            <h3>Criar Lista</h3>

<div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
    
    <div class="form-group" style="flex: 1 1 200px;"> 
        <label>Posto de Serviço</label>
        <select id="novo-local-posto" class="filter-input">
            <option value="" disabled selected>Carregando Postos...</option>
        </select>
    </div>

    <div class="form-group" style="flex: 1 1 250px;">
        <label>Nome do Novo Item</label>
        <input type="text" id="novo-local-nome" placeholder="EX: RESGATE 01" class="filter-input">
    </div>

    <div class="form-group" style="flex: 1 1 200px;">
        <label>Unidade de Vínculo</label>
        <select id="novo-local-unidade" class="filter-input">
            <option value="" disabled selected>Carregando Unidades...</option>
        </select>
    </div>

    <button class="btn-modern-action btn-create" onclick="criarNovoLocal()" style="height: 42px; margin-top: 21px; padding-top: 5px; padding-bottom: 5px;">CRIAR</button>

</div>
    <ul id="lista-locais-container" class="locais-list"></ul>
</div>

    <div id="view-editor" class="view-section">
        <div class="admin-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button onclick="switchView('listas')" class="btn-modern-action btn-edit">Voltar</button>
                <h1 class="page-title" id="editor-title" style="font-size:1.2em; margin:0;">Editando...</h1>
            </div>
            <div id="loading-message-admin">Carregando...</div>
                <div id="main-admin-content" style="display:none;">
                    <div class="global-actions">
                        <button class="btn-modern-action btn-sync" onclick="salvarDados()">Salvar</button>
                        <button class="btn-modern-action btn-backup" onclick="fazerBackupLocal()">Backup</button>
                        <input type="file" id="import-json" style="display: none;" onchange="importarBackupLocal(event)">
                        <button class="btn-modern-action btn-create" onclick="document.getElementById('import-json').click()">Importar</button>
              
                        <div class="add-setor-form" style="margin-left:auto; display:flex; gap:5px;">
                            <input type="text" id="input-setor-nome" placeholder="Nome Setor" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                            <button class="btn-add" onclick="adicionarSetor(document.getElementById('input-setor-nome').value)">+ Setor</button>
                        </div>
                    </div>
                    <ul id="lista-setores-container" class="lista-setores"></ul>
                </div>
            </div>
        </div>
        <div id="view-cautelas" class="view-section restricted-admin-only">
    <div class="header-container">
        <h2>Gestão de Cautelas</h2>
        <p>Gerenciamento completo das cautelas de materiais do sistema SIGMA.</p>
    </div>

    <div id="cautelas-options-container" class="cards-grid"> 

        <div class="sector-card menu-card" onclick="loadNewCautelaForm()">
            <i class="fas fa-file-contract card-icon"></i>
            <h3>Nova Cautela</h3>
            <p>Gerar um novo termo de cautela para um militar.</p>
        </div>

        <div class="sector-card menu-card" onclick="showCautelasDashboard('Cautelas Ativas')">
            <i class="fas fa-clipboard-check card-icon"></i>
            <h3>Cautelas Ativas</h3>
            <p>Visualizar e gerenciar todas as cautelas em vigor.</p>
        </div>

        <div class="sector-card menu-card" onclick="showCautelasDashboard('Cautelas a Receber')">
            <i class="fas fas fa-inbox card-icon"></i> <h3>Cautelas a Receber</h3>
            <p>Pendências de materiais a serem devolvidos/repassados.</p>
        </div>

        <div class="sector-card menu-card" onclick="showCautelasDashboard('Histórico')">
            <i class="fas fa-history card-icon"></i>
            <h3>Histórico de Cautelas</h3>
            <p>Consultar todas as cautelas emitidas e finalizadas.</p>
        </div>

    </div>
    
    <div id="cautelas-content" class="main-content-area">
        </div>
</div>
    </div>
    
    <div id="app-runner-container"><iframe id="app-iframe" src=""></iframe></div>

    <div id="modal-gestao-ca" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-gestao-ca').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Item</h2>
            <p id="gestao-item-nome" style="color:#800020; font-weight:bold; margin-bottom:20px; border-bottom:1px dashed #ccc; padding-bottom:10px;"></p>
            
            <input type="hidden" id="gestao-doc-id">
            <input type="hidden" id="gestao-item-index">
            <input type="hidden" id="gestao-item-id-lista">
            <input type="hidden" id="gestao-item-max-qtd">
            
            <label>Ação a realizar</label>
            <select id="gestao-status">
                <option value="Solucionado">Solucionado (Apenas dar baixa)</option>
                <option value="Em solução">Em solução (Manter alerta)</option>
                <option value="Cautelado">Cautelado (Material saiu)</option>
                <option value="Remover">Remover da Lista (Baixar estoque)</option>
            </select>
            
            <div id="div-gestao-qtd" style="display:none;">
                <label style="color:#d90f23;">Quantidade a Remover do Estoque:</label>
                <input type="number" id="gestao-qtd" min="1" value="1">
                <small id="gestao-qtd-info" style="color:#666; font-size:0.85em;"></small>
            </div>
            
            <label>Observação da Gestão (Obrigatório)</label>
            <textarea id="gestao-obs" placeholder="Descreva o que foi feito (ex: Material consertado; Enviado para manutenção; etc)"></textarea>
            
            <div class="modal-buttons">
                <button class="btn-modern-action btn-backup" onclick="document.getElementById('modal-gestao-ca').style.display='none'">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarGestaoCa()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-unit-manager" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-unit-manager').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Unidade</h2>
            <label>Nome da Unidade</label>
            <input type="text" id="edit-unit-name-input">
            <input type="hidden" id="edit-unit-original-name">
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas:</label>
            <div id="unit-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirUnidade()">Excluir Unidade</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUnidade()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="modal-posto-manager" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-posto-manager').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Posto</h2>
            <label>Nome do Posto</label>
            <input type="text" id="edit-posto-name-input">
            <input type="hidden" id="edit-posto-original-name">
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas a este Posto:</label>
            <div id="posto-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirPosto()">Excluir Posto</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesPosto()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="modal-edicao" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="fecharModal()"><i class="fas fa-times"></i></button>
            <h2>Editar Item</h2>
            <input type="hidden" id="edit-setor-id">
            <input type="hidden" id="edit-item-original-id">
            <label>Nome:</label>
            <input type="text" id="edit-item-nome">
            <label>Mover para Setor:</label>
            <select id="edit-item-setor"></select>
            <label>Quantidade:</label>
            <input type="number" id="edit-item-qtd" min="1">
            <label>Tipo:</label>
            <select id="edit-item-tipo" disabled style="background-color: #eee;">
                <option value="single">Item Único</option>
                <option value="multi">Item com Tombamento</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-remover" onclick="fecharModal()">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarEdicaoItem()">Salvar</button>
            </div>
        </div>
    </div>
    
   <div id="modal-user-manager" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="document.getElementById('modal-user-manager').style.display='none'"><i class="fas fa-times"></i></button>
        <h2>Gerenciar Militar</h2>
        
        <input type="hidden" id="edit-user-doc-id">
        
        <div class="form-grid-2-columns" style="margin-bottom: 0;">
            <div>
                <label>Nome de Guerra</label>
                    <input type="text" id="edit-user-guerra">
        
                <label>Posto/Graduação</label>
                    <select id="edit-user-posto">
                        <option value="" disabled selected>Selecione o Posto</option>
                        <option value="CEL">CEL</option>
                        <option value="TEN CEL">TEN CEL</option>
                        <option value="MAJ">MAJ</option>
                        <option value="CAP">CAP</option>
                        <option value="1º TEN">1º TEN</option>
                        <option value="2º TEN">2º TEN</option>
                        <option value="ST">ST</option>
                        <option value="1º SGT">1º SGT</option>
                        <option value="2º SGT">2º SGT</option>
                        <option value="3º SGT">3º SGT</option>
                        <option value="CB">CB</option>
                        <option value="SD">SD</option>
                    </select>
        
                <label>Quadro</label>
                    <select id="edit-user-quadro" disabled>
                        <option value="" disabled selected>Selecione...</option>
                    </select>

                <label>Nome de Exibição (Posto/Quadro/Guerra)</label>
                    <input type="text" id="edit-user-display-name" disabled style="background-color: #eee;">
        </div>
    <div>
        <label>CPF (Apenas dígitos)</label>
        <input type="text" id="edit-user-cpf"> 
        
        <label>Matrícula (Apenas dígitos)</label>
        <input type="text" id="edit-user-matricula">
        
        <label>Telefone para Contato (DDD)</label>
        <input type="text" id="edit-user-telefone">
    </div>
</div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #eee;">

        <label>Nome Completo</label>
        <input type="text" id="edit-user-completo">

        <label>E-mail (Login) - *Somente Leitura*</label>
        <input type="email" id="edit-user-email" disabled style="background-color: #eee;">

        <label>Perfil de Acesso</label>
        <select id="edit-user-role">
            <option value="operacional">Operacional</option>
            <option value="gestor">Gestor de Unidade</option>
            <option value="admin">Administrador Geral</option>
        </select>

        <label>Unidade Associada</label>
        <select id="edit-user-unit"><option value="">Carregando...</option></select>
        
        <div id="user-permissions-fields" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; display: none;">
            <label class="section-label" style="font-weight: bold;">Permissões de Gestor</label>
            <p style="font-size: 0.8em; margin: 5px 0 10px; color: #666;">Essas permissões só são aplicáveis a usuários com a Role 'gestor'.</p>

            <div style="display: flex; flex-direction: column; gap: 5px;">
                <label><input type="checkbox" id="perm-view-cards"> Visualizar Cards de Pendência C/A</label>
                <label><input type="checkbox" id="perm-view-history"> Acesso ao Histórico da Unidade</label>
                <label><input type="checkbox" id="perm-manage-posts"> Gerenciar Vínculos de Postos</label>
                <label><input type="checkbox" id="perm-manage-users"> Gerenciar Usuários da Unidade</label>
                <label><input type="checkbox" id="perm-manage-lists"> Gerenciar Listas da Unidade</label>
            </div>
        </div>
        
        <div class="modal-buttons" style="justify-content: space-between;">
            <button class="btn-modern-action btn-delete" onclick="excluirUsuario()">Excluir Militar</button>
            <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUsuario()">Salvar Alterações</button>
        </div>
    </div>
</div>
    <div id="modal-nova-conferencia" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <button class="close-btn" onclick="document.getElementById('modal-nova-conferencia').style.display='none'"><i class="fas fa-times"></i></button>
        <div class="op-card action" style="border: none; box-shadow: none; padding: 0;">
            <h2 class="op-card-title"><i class="fas fa-clipboard-list"></i> Nova Conferência</h2>
            <div class="form-group">
                <label>1. Escolha o Setor / Posto</label>
                <select id="dash-select-setor" onchange="filtrarListasDashboard()">
                    <option value="" disabled selected>Carregando setores...</option>
                </select>
            </div>
            <div class="form-group">
                <label>2. Escolha a Viatura / Lista</label>
                <select id="dash-select-lista" disabled onchange="focarBotaoIniciar()">
                    <option value="" disabled selected>Selecione um setor acima</option>
                </select>
            </div>
            <button id="btn-start-dash" class="btn-start" onclick="iniciarConferenciaDashboard()">INICIAR AGORA</button>
        </div>
    </div>
        
</div>
    <div id="cautelaDetailsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #800020;"><i class="fas fa-clipboard-list"></i> Detalhes da Cautela <span id="modal-cautela-id"></span></h3>
            <span style="font-size: 1.2em; font-weight: bold; color: #d90f23;" id="modal-status"></span>
        </div>
    
        <div class="form-area" style="padding: 15px; border: none; box-shadow: none; background-color: #f9f9f9; margin-bottom: 15px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div><label>Emitente (Origem):</label><span id="modal-emitente" class="info-value"></span></div>
        <div><label>Destinatário (Original):</label><span id="modal-destinatario-original" class="info-value"></span></div>
        <div><label>Recebedor:</label><span id="modal-destinatario-atual" class="info-value"></span></div>
        
        <div><label>Local de Origem:</label><span id="modal-local-origem" class="info-value"></span></div>
        <div><label>Data de Emissão:</label><span id="modal-data-emissao" class="info-value"></span></div>
        <div><label>Status:</label><span id="modal-status-text" class="info-value"></span></div>
    </div>
    <label>Observações da Emissão:</label>
    <div id="modal-obs-emissao" style="background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee; min-height: 50px;"></div>
    </div>
<span style="font-size: 1.2em; font-weight: bold; color: #d90f23;" id="modal-status"></span>
        
        <h4 style="color: #800020; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px;">Itens Cautelados:</h4>
        <ul id="modal-itens-cautela" class="cautela-item-list" style="max-height: 250px; overflow-y: auto; margin-top: 10px;">
            </ul>
        
        <div class="modal-actions">
            <button class="btn-modern-action" id="btn-receber-cautela" style="display: none;">
                <i class="fas fa-check-circle"></i> Iniciar Recebimento
            </button>
            
            <button class="btn-modern-action btn-delete" id="btn-devolver-cautela" style="display: none;">
                <i class="fas fa-undo"></i> Iniciar Devolução
            </button>
            
            <button class="btn-modern-action btn-sync" id="btn-confirmar-devolucao" style="display: none;">
                <i class="fas fa-handshake"></i> Confirmar Recebimento da Devolução
            </button>
            
            <button class="modal-btn-cancel" onclick="document.getElementById('cautelaDetailsModal').style.display='none'">Fechar</button>
        </div>
    </div>
</div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        
        function openNewConferenceModal() {
        document.getElementById('modal-nova-conferencia').style.display = 'flex';
        }
        // Constantes Globais
        const COLECAO_RESULTADOS = 'resultados_conferencias';
        const COLECAO_LISTAS = 'listas_conferencia';

        // Variáveis Globais
        let currentUserData = null;
        let allLists = [];
        let allUsersData = [];
        let dadosConferencia = []; // Para o editor
        let currentEditingId = null;
        let conferente = '';

        // --- 1. AUTH & PERMISSÕES ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection('usuarios').doc(user.uid).get();
                    if (doc.exists) {
                        currentUserData = doc.data();
                        conferente = currentUserData.nome_militar_completo;
                        setupUIBasedOnRole();
                    } else {
                        alert("Usuário sem registro no banco."); 
                        window.location.href = 'index.html';
                    }
                } catch (e) { 
                    console.error(e); 
                }
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        function setupUIBasedOnRole() {
            const role = currentUserData.role || 'operacional';
            const unit = currentUserData.unidade || 'N/D';
            // --- CORREÇÃO DE SEGURANÇA NA LINHA 301 ---
            const roleDisplay = document.getElementById('user-role-display');
// Verifica se o elemento existe antes de tentar definir o texto
    if (roleDisplay) { 
        roleDisplay.textContent = `${role.toUpperCase()} - ${unit}`;
}
    // ------------------------------------------

    atualizarSaudacao(currentUserData);
// --- 1. Definindo as Permissões Reais de Acesso ---
    const p = currentUserData.permissoes || {};
// Objeto de Permissões
    const isGestorOuAdmin = (role === 'gestor' || role === 'admin');
    const canViewAdminTools = role === 'admin';
    const canViewDashboardCards = role === 'admin' ||
    (isGestorOuAdmin && p.canViewDashboardCards);
    const canViewUnitHistory = role === 'admin' || (isGestorOuAdmin && p.canViewUnitHistory);
    const canManageUnits = role === 'admin';
// Assume que Gerenciamento de Unidades é Admin-Only
    const canManagePosts = role === 'admin' ||
(isGestorOuAdmin && p.canManagePosts);
    const canManageUnitUsers = role === 'admin' || (isGestorOuAdmin && p.canManageUnitUsers);
    const canManageUnitLists = role === 'admin' ||
(isGestorOuAdmin && p.canManageUnitLists);
// --- 2. Aplicação das Restrições na UI (Corrigida e Segura) ---
    
    // Reseta visibilidade dos links de Admin.
    document.querySelectorAll('.restricted-admin-only').forEach(el => {
        if(el) el.style.display = 'block';
    });
// Oculta o Rótulo e Links de Admin se for Operacional
    if (role === 'operacional') {
        renderOperacionalCards();
 } else {
        // Para Admin e Gestor
        renderAdminGestorCards(canViewDashboardCards);
        // ✅ CORREÇÃO: Removido carregarConferenciasHoje() para evitar TypeError: Cannot set properties of null
    }

    // --- 2.1 Ajuste Fino dos Links de Gestão (para Gestores e Admin) ---
    
    if (!canManageUnits) { 
        const linkUnidades = document.getElementById('link-unidades');
        if(linkUnidades) linkUnidades.style.display = 'none';
    }
    
    if (!canManagePosts) { 
        const linkPostos = document.getElementById('link-postos');
        if(linkPostos) linkPostos.style.display = 'none';
    }
    
    if (!canManageUnitUsers) { 
        const linkUsuarios = document.getElementById('link-usuarios');
        if(linkUsuarios) linkUsuarios.style.display = 'none';
    }
    
    if (!canManageUnitLists) { 
        const linkListas = document.getElementById('link-listas');
        if(linkListas) linkListas.style.display = 'none';
    }
    
    // Oculta o Histórico Global se a permissão não estiver marcada
    const globalHistoryLink = document.getElementById('link-global-history');
    if (!canViewUnitHistory && globalHistoryLink) {
        globalHistoryLink.style.display = 'none';
    }
    
    // Ocultar Rótulo Admin se não sobrou nenhum link
    const adminLinks = ['link-unidades', 'link-postos', 'link-usuarios', 'link-listas'];
    const anyAdminLinkVisible = adminLinks.some(id => {
        const el = document.getElementById(id);
        return el && el.style.display !== 'none';
    });
    const rotuloAdmin = document.getElementById('sidebar-rotulo-admin');
    if (!anyAdminLinkVisible && rotuloAdmin) {
        rotuloAdmin.style.display = 'none';
    }

    // --- 3. Chamadas de Dados Comuns (Manter) ---
    carregarListasParaNovaConferencia(); // Preenche o modal "Iniciar Conferência"
    verificarConferenciaAtiva(); // Renderiza o card de "Continuar Conferência"
    
    // ===================================
    // SOLUÇÃO PARA INICIAR O MENU FECHADO
    // ===================================
    closeMenuMobile();
// --- Trava do Botão Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o botão Voltar do navegador
        history.pushState(null, null, location.href);
    }
    // ----------------------------------------------

    // Garante que a visão seja o dashboard ao logar
    switchView('dashboard');
    setupMasksForModal();
}
        /**
 * Adiciona listeners de formatação (máscara) aos inputs do modal Gerenciar Militar.
 */
function setupMasksForModal() {
    const cpfInput = document.getElementById('edit-user-cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
        // Aplica a máscara imediatamente para valores preenchidos na abertura do modal
        formatarCPF(cpfInput); 
    }
    
    const matriculaInput = document.getElementById('edit-user-matricula');
    if (matriculaInput) {
        matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
        formatarMatricula(matriculaInput);
    }
    
    const telefoneInput = document.getElementById('edit-user-telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));
        formatarTelefone(telefoneInput);
    }
}
            // --- NOVO: Cards Específicos para Operacional ---
function renderOperacionalCards() {
    const container = document.getElementById('operacional-cards-container');
    if (!container) return;
    
    // Esconde o container de Admin/Gestor se existir
    const adminContainer = document.getElementById('admin-gestor-cards-container');
    if(adminContainer) adminContainer.style.display = 'none';

    container.innerHTML = `
        
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-calendar-day"></i> Conferências Realizadas Hoje (Minhas)</h2>
            <ul id="today-list" class="history-list">
                <li style="text-align:center; color:#999; padding:20px;">Carregando...</li>
            </ul>
        </div>

    
        <div class="op-card history" style="margin-top: 25px;">
            <h2 class="op-card-title" style="margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> Dashboard Operacional</h2>
            <div class="cards-grid">
                
                <div class="sector-card status-ok" onclick="switchView('my-history')">
                    <h3>Minhas Conferências</h3>
    
                    <div class="main-stat">
                        <span class="count-value" id="op-conf-count">0</span>
                        <i class="fas fa-history fa-2x" style="color:#1b8a3e;"></i>
                    </div>
         
                    <div class="card-footer">
                        Clique para ver o histórico completo.
                    </div>
                </div>
                <div class="sector-card status-unit" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas Ativas');">
                    <h3>Minhas Cautelas Ativas</h3>
                    <div class="main-stat">
              
                    <span class="count-value" id="op-my-active-cautela-count">0</span>
                        <i class="fas fa-shield-alt fa-2x" style="color:#2c7399;"></i>
                </div>
                <div class="card-footer">
                    
                    Itens que estão sob sua cautela.
                </div>
            </div>

                <div class="sector-card status-posto" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas a Receber');">
                    <h3>Cautelas a Receber</h3>
                    <div class="main-stat">
            
                        <span class="count-value" id="op-cautela-receive-count">0</span>
                        <i class="fas fa-box-open fa-2x" style="color:#8e44ad;"></i>
                    </div>
                    <div class="card-footer">
                  
                        Itens pendentes de recebimento/transferência.
                    </div>
                </div>
                
            </div>
        </div>
    `;
    
    // [NOVO] Adicionar lógica para atualizar a contagem de conferências hoje no card
    updateOperacionalCards();
    container.style.display = 'block';
}
// [NOVO] Atualiza a contagem do Card "Minhas Conferências"
async function getCautelasAReceberCount() {
    if (!currentUserData || !currentUserData.nome_militar_completo) return 0;
    
    const militarCompleto = currentUserData.nome_militar_completo;

    try {
        // 1. Query ABERTAS (Fluxo normal)
        const snapAberta = await db.collection('cautelas_abertas')
            .where('destinatario', '==', militarCompleto)
            .where('status', '==', 'ABERTA')
            .get();
            
        // 2. Query DEVOLUÇÃO (Fluxo de retorno)
        const snapDevolucao = await db.collection('cautelas_abertas')
            .where('destinatario', '==', militarCompleto)
            .where('status', '==', 'DEVOLUÇÃO')
            .get();
            
        // Soma os resultados das duas consultas para o contador do card
        return snapAberta.size + snapDevolucao.size;
        
    } catch (e) {
        console.error("Erro ao contar cautelas a receber:", e);
        return 0;
    }
}
       /**
 * Busca e retorna a contagem de cautelas ativas/recebidas do militar logado,
 * incluindo as que estão EM DEVOLUÇÃO (enviadas por ele).
 */
async function getMyActiveCautelasCount() {
    if (!currentUserData || !currentUserData.nome_militar_completo) return 0;
    
    const militarCompleto = currentUserData.nome_militar_completo;

    try {
        // 1. Query RECEBIDAS (CUSTÓDIA ATUAL - Filtra por DESTINATARIO)
        const snapRecebida = await db.collection('cautelas_abertas')
            .where('destinatario', '==', militarCompleto)
            .where('status', '==', 'RECEBIDA')
            .get();
            
        // 2. Query EM DEVOLUÇÃO (ITENS EM TRÂNSITO - Filtra por REVERSOR)
        const snapDevolucao = await db.collection('cautelas_abertas')
            .where('militar_completo_reversor', '==', militarCompleto)
            .where('status', '==', 'DEVOLUÇÃO')
            .get();
            
        // Soma os resultados das duas consultas
        return snapRecebida.size + snapDevolucao.size;
        
    } catch (e) {
        console.error("Erro ao contar cautelas ativas do militar:", e);
        return 0;
    }
}
async function updateOperacionalCards() {
    const ul = document.getElementById('today-list');
    const countEl = document.getElementById('op-conf-count');
    // 🛑 NOVO: Elemento do contador de Cautelas a Receber
    const cautelaReceiveCountEl = document.getElementById('op-cautela-receive-count');
    const myActiveCautelaCountEl = document.getElementById('op-my-active-cautela-count');
    
    try {
        // --- 1. CONTAGEM TOTAL DE CONFERÊNCIAS (EXISTENTE) ---
        const snapTotal = await db.collection(COLECAO_RESULTADOS)
            .where('conferente', '==', currentUserData.nome_militar_completo)
            .get();
        const totalConferences = snapTotal.size; 
        if (countEl) countEl.textContent = totalConferences;

        // --- 2. CONTAGEM DE CAUTELAS A RECEBER (NOVO) ---
        const totalCautelasAReceber = await getCautelasAReceberCount();
        if (cautelaReceiveCountEl) cautelaReceiveCountEl.textContent = totalCautelasAReceber; 
        // FIM NOVO
        
        // --- 3. CONTAR MINHAS CAUTELAS ATIVAS (NOVO) ---
        const totalMyActiveCautelas = await getMyActiveCautelasCount();
        if (myActiveCautelaCountEl) myActiveCautelaCountEl.textContent = totalMyActiveCautelas; 
        // FIM NOVO
        
        const hojeStr = new Date().toLocaleDateString('pt-BR');
        let countToday = 0; // Contagem das conferências de hoje
        let html = '';
        
        snapTotal.forEach(d => {
            const dt = d.data().timestamp.toDate();
            // Filtro de data para listar apenas as de hoje
            if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                html += criarItemHistoricoHTML(d.data());
                countToday++; // Contagem de hoje
            }
        });
        
        // Atualiza a lista de hoje
        ul.innerHTML = html ||
        '<li style="padding:15px; text-align:center; color:#999;">Nenhuma conferência hoje.</li>';
        
    } catch(e) { 
        console.error("Erro ao carregar dados operacionais:", e);
        if(countEl) countEl.textContent = 'Erro';
        ul.innerHTML = 'Erro.';
    }
}
        
            // --- NOVO: Cards Específicos para Admin/Gestor ---
// --- NOVO: Cards Específicos para Admin/Gestor ---
function renderAdminGestorCards(canViewDashboardCards) {
    const container = document.getElementById('admin-gestor-cards-container');
    if (!container) return;
    const opContainer = document.getElementById('operacional-cards-container');
    if(opContainer) opContainer.style.display = 'none';
    if (canViewDashboardCards) {
        container.innerHTML = `
            <div id="dash-cards-restricted" class="op-card history" style="padding-top: 15px;">
                <h2 class="op-card-title" style="font-size: 1.2em; margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Pendências da Unidade
                </h2>
                <div id="loading-message-dashboard">Carregando dados...</div>
                <div id="cards-container" class="cards-grid">
                    </div>
            </div>
        `;
            loadCaaData(); 
            container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
} 
    closeMenuMobile(); 

    // --- Trava do Botão Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o botão Voltar do navegador
        history.pushState(null, null, location.href); 
    }
    // ----------------------------------------------

    // Garante que a visão seja o dashboard ao logar
    switchView('dashboard');
        
        function atualizarSaudacao(user) {
            const now = new Date();
            const hour = now.getHours();
            let saudacao = "Bom dia";
            if (hour >= 12 && hour < 18) saudacao = "Boa tarde";
            else if (hour >= 18) saudacao = "Boa noite";
            
            const opcoesData = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let dataStr = now.toLocaleDateString('pt-BR', opcoesData);
            dataStr = dataStr.charAt(0).toUpperCase() + dataStr.slice(1);

            document.getElementById('greeting-text').textContent = saudacao + ",";
            document.getElementById('greeting-name').textContent = user.nome_militar_completo || user.nome_guerra;
            document.getElementById('current-date').textContent = dataStr;
            if(user.foto_url) document.getElementById('greeting-photo').src = user.foto_url;
        }

        // --- 2. VERIFICAÇÃO DE RESUME ---
        // --- 2. VERIFICAÇÃO DE RESUME ---
function verificarConferenciaAtiva() {
    const activeConf = localStorage.getItem('sigma_active_conf');
    const container = document.getElementById('resume-container');
    container.innerHTML = '';
    if (activeConf) {
        try {
            const confData = JSON.parse(activeConf);
            if(confData.user === currentUserData.nome_guerra) {
                container.innerHTML = `
                    <div class="op-card resume">
                        <button class="btn-resume-close" onclick="event.stopPropagation(); descartarConferenciaAtiva()">
                            <i class="fas fa-times"></i>
                        </button>
                        <div onclick="retomarConferencia('${confData.url}')" style="cursor: pointer;">
                            <h2 class="op-card-title" style="border:none; margin:0; color:#e65100;">
                                <i class="fas fa-play-circle"></i> Continuar: ${confData.nomeLista}
                            </h2>
                            <p style="margin:5px 0 0 30px; color:#666; font-size:0.9em;">
                                Clique para retomar de onde parou...
                            </p>
                        </div>
                    </div>`;
            }
        } catch(e) {}
    }
}
        

        function retomarConferencia(url) {
            const iframe = document.getElementById('app-iframe');
            const container = document.getElementById('app-runner-container');
            iframe.src = url;
            container.style.display = 'block';
        }
        // --- FUNÇÃO PARA DESCARTAR CONFERÊNCIA ATIVA ---
function descartarConferenciaAtiva() {
    const activeConf = localStorage.getItem('sigma_active_conf');
if (!activeConf) return; // Não há nada para descartar

    try {
        const confData = JSON.parse(activeConf);
        
        // CORREÇÃO: Padroniza o nome de guerra lido do sigma_active_conf
        const userForDraft = (confData.user || 'ND').toUpperCase();
        
if (confirm("Tem certeza que deseja descartar esta conferência em andamento? Ela não poderá ser retomada!")) {
            // 1. Constrói a chave do rascunho para limpeza (usando o nome padronizado)
            const draftKey = `sigma_draft_${confData.id}_${userForDraft}`;
// 2. Limpa o rascunho de progresso
            localStorage.removeItem(draftKey);
// 3. Limpa o card de resumo
            localStorage.removeItem('sigma_active_conf');
// 4. Atualiza UI
            verificarConferenciaAtiva(); 
            alert("Conferência e rascunho descartados.");
}
    } catch(e) {
        console.error("Erro ao descartar conf:", e);
        // Limpa o card de resumo (apenas para corrigir o loop visual)
        localStorage.removeItem('sigma_active_conf');
        verificarConferenciaAtiva();
    }
}
        // --- 3. DASHBOARD HIERÁRQUICO ---
        async function loadCaaData() {
            const container = document.getElementById('cards-container');
            container.innerHTML = 'Carregando...';
            const loading = document.getElementById('loading-message-dashboard');
            loading.style.display = 'block';
            
            try {
                const rotasDoc = await db.collection('config_geral').doc('rotas').get();
                const rotas = rotasDoc.data() || {};
                const listToUnitMap = {};
                
                // Objeto para mapear o ID ÚNICO da ROTA/LISTA ao nome da Unidade
                Object.keys(rotas).forEach(key => {
                    // key é o ID da lista (ex: "alfa_permanencia")
                    if (!key.toLowerCase().includes('bravo 5') && rotas[key].ativo !== false) {
                        listToUnitMap[key] = rotas[key].unidade || 'GERAL';
                    }
                });
                
                const snap = await db.collection(COLECAO_RESULTADOS).limit(100).get();
                
                // ALTERAÇÃO CRÍTICA: 'map' agora usará o LISTA_ID como chave, não o NOME do local.
                const map = {}; 
                const docs = [];
                snap.forEach(d => docs.push({id:d.id, ...d.data()}));
                
                // Ordenação por tempo (mais recente primeiro)
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                docs.forEach(d => {
                    const listaId = d.lista_id; // Usamos o ID único do resultado
                    
                    // Condição crucial: Só processa se a lista existir no mapa filtrado (rotas)
                    if (!rotas[listaId]) return; 

                    // Filtro de segurança (para Gestores)
                    const listUnit = rotas[listaId].unidade || 'GERAL';
                    if (currentUserData.role === 'gestor' && listUnit !== currentUserData.unidade) return;

                    // CORREÇÃO: Usamos o listaId como chave para garantir unicidade.
                    // A primeira a ser encontrada (a mais recente) é a que prevalece.
                    if (!map[listaId]) {
                        map[listaId] = { 
                            docId: d.id, 
                            local: d.local, 
                            conferente: d.conferente, 
                            date: d.timestamp.toDate().toLocaleString(), 
                            items: d.itensCaa || [] 
                        };
                    }
                });
                
                // Passamos o novo mapa baseado em ID para renderizar os cards
                renderCards(map); 
            } catch (e) { 
                console.error(e); 
                container.innerHTML = 'Erro ao carregar.';
            } finally { 
                loading.style.display = 'none';
            }
        }        
       
        async function renderCards(map) {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';
    const keys = Object.keys(map);
    
    // 1. CARREGAR ROTAS PARA MAPEAMENTO DE UNIDADE
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    if (keys.length === 0) { 
        container.innerHTML = '<p style="padding:20px;">Nenhuma pendência encontrada.</p>';
        return;
    }

    // 2. AGRUPAR CARDS POR UNIDADE
    const groupedCards = {};
    keys.forEach(listaId => {
        const d = map[listaId];
        // Busca a Unidade associada a esta lista_id na coleção 'rotas'
        const unit = rotas[listaId]?.unidade || 'GERAL'; 
        
        if (!groupedCards[unit]) {
            groupedCards[unit] = [];
        }
        groupedCards[unit].push(d);
    });

    // 3. RENDERIZAR AGRUPADO POR UNIDADE (Restaura o agrupamento e o empilhamento)
    const sortedUnits = Object.keys(groupedCards).sort();
sortedUnits.forEach(unit => {
        const cardsList = groupedCards[unit];
        
        // --- Cabeçalho da Unidade ---
       const unitHeader = document.createElement('h3');
        unitHeader.className = 'unit-header';
        
        // Restaura as regras inline necessárias (removendo as que causavam o erro de JS)
        unitHeader.style.cssText = 'display: block; width: 100%; color: #800020; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; box-sizing: border-box; font-size: 1.2em;'; 
        
        // NOVO HTML: Usa a estrutura Flexbox para o alinhamento vertical
        unitHeader.innerHTML = `
            <div class="unit-flex-title">
                <i class="fas fa-building"></i>
                <span>${unit}</span>
            </div>
        `;
        container.appendChild(unitHeader); 
        
        // --- Container dos Cards da Unidade ---
        // Aqui não precisamos criar um novo grid, apenas adicionamos os cards ao container principal (container).
        cardsList.forEach(d => {
            const items = d.items || [];
            const count = items.filter(i => i.statusAdmin !== 'Solucionado').length; 
            
            const div = document.createElement('div');
            // O CSS para .sector-card (flex: 0 0 280px) permite que ele se organize lado a lado
            div.className = `sector-card ${count === 0 ? 'status-ok' : 'status-alert'}`;
            div.innerHTML = `
                <h3>${d.local}</h3>
                <div class="main-stat">
                    <span class="count-value">${count === 0 ? 'OK' : count}</span>
                </div>
                <div class="card-footer">
                    <strong>${d.conferente}</strong><br>${d.date}
                </div>
            `;
            div.onclick = () => mostrarTabela(d);
            container.appendChild(div); // Adiciona o card ao container principal (que é um flexbox)
        });
    });
    
    if (container.children.length === 0) {
        container.innerHTML = '<p style="padding:20px;">Nenhuma pendência encontrada para sua unidade ou permissão.</p>';
    }
}
        // --- 4. NOVA CONFERÊNCIA ---
        async function carregarListasParaNovaConferencia() {
            try {
                const doc = await db.collection('config_geral').doc('rotas').get();
                const rotas = doc.data();
                allLists = []; 
                const setores = new Set();
                
                Object.entries(rotas).forEach(([id, info]) => {
                    if (info.ativo !== false && id !== 'ABT-17' && id !== 'ABT-18' && id.indexOf('bravo 5') === -1) {
                        allLists.push({ id: id, nome: info.nome, setor: info.posto });
                        setores.add(info.posto);
                    }
                });
                
                const sel = document.getElementById('dash-select-setor');
                sel.innerHTML = '<option value="" disabled selected>Selecione o Setor...</option>';
                
                Array.from(setores).sort().forEach(s => {
                    const opt = document.createElement('option'); 
                    opt.value = s; 
                    opt.textContent = s; 
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        function filtrarListasDashboard() {
            const setor = document.getElementById('dash-select-setor').value;
            const selLista = document.getElementById('dash-select-lista');
            selLista.innerHTML = '<option value="" disabled selected>Selecione a Lista...</option>'; 
            selLista.disabled = false;
            
            const fil = allLists.filter(l => l.setor === setor).sort((a,b)=>a.nome.localeCompare(b.nome));
            fil.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l.id; 
                o.textContent = l.nome; 
                selLista.appendChild(o); 
            });
            selLista.focus();
        }

        function focarBotaoIniciar() { 
            document.getElementById('btn-start-dash').focus();
        }

        function iniciarConferenciaDashboard() {
            const listaId = document.getElementById('dash-select-lista').value;
            const listaSelect = document.getElementById('dash-select-lista');
            const nomeLista = listaSelect.options[listaSelect.selectedIndex].text;
            
            if(!listaId) return alert("Selecione uma lista.");
            
            // --- CORREÇÃO: Padroniza o nome do usuário para a chave do rascunho ---
            // Define o nome de guerra em MAIÚSCULAS para consistência.
            const userForDraft = (currentUserData.nome_guerra || 'ND').toUpperCase();
            
            // Constrói a URL com o user padronizado (para leitura no app)
            const url = `conferencia_app.html?id=${listaId}&posto_grad=${encodeURIComponent(currentUserData.posto)}&quadro_mil=${encodeURIComponent(currentUserData.quadro)}&nome_guerra=${encodeURIComponent(userForDraft)}`;
            
            // Salva para resume
            localStorage.setItem('sigma_active_conf', JSON.stringify({
                id: listaId, 
                nomeLista: nomeLista, 
                user: userForDraft, // <-- CHAVE PADRONIZADA
                url: url
            }));
            verificarConferenciaAtiva();
            document.getElementById('modal-nova-conferencia').style.display = 'none';
            
            // --- LÓGICA DE ABERTURA DO IFRAME (RE-INSERIDA) ---
            const container = document.getElementById('app-runner-container');
            const iframe = document.getElementById('app-iframe');
            iframe.src = url; 
            container.style.display = 'block';
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'SIGMA_FINISHED') {
                document.getElementById('app-runner-container').style.display = 'none';
                document.getElementById('app-iframe').src = "";
                
                localStorage.removeItem('sigma_active_conf');
    
                verificarConferenciaAtiva();

                loadCaaData();
                carregarConferenciasHoje();
                alert("Conferência salva!");
            }
        });
        
        // --- 5. HISTÓRICOS ---
        async function carregarConferenciasHoje() {
            const ul = document.getElementById('today-list');
            ul.innerHTML = '<li>Carregando...</li>';
            try {
                const snap = await db.collection(COLECAO_RESULTADOS).where('conferente', '==', currentUserData.nome_militar_completo).limit(20).get();
                const hojeStr = new Date().toLocaleDateString('pt-BR');
                let docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
                
                let html = '';
                docs.forEach(d => {
                    const dt = d.timestamp.toDate();
                    if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                        html += criarItemHistoricoHTML(d);
                    }
                });
                
                ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nenhuma conferência hoje.</li>';
            } catch(e){ 
                console.error(e); 
                ul.innerHTML = 'Erro.';
            }
        }

        async function loadMyHistory() {
    const ul = document.getElementById('my-history-list');
    ul.innerHTML = '<li>Buscando...</li>';
    
    // 1. Cria objetos Date dos campos de input, garantindo o início e fim do dia
    const startDateInput = document.getElementById('my-hist-start').value;
    const endDateInput = document.getElementById('my-hist-end').value;

    if (!startDateInput || !endDateInput) {
        ul.innerHTML = '<li>Selecione as datas para filtrar.</li>';
        return;
    }

    // 2. Cria Timestamps para filtro do Firestore
    // dI: Começo do dia (00:00:00)
    const dI = new Date(startDateInput + 'T00:00:00'); 
    // dF: Final do dia (23:59:59), adicionamos um segundo extra para garantir a inclusão
    const dF = new Date(endDateInput + 'T23:59:59'); 

    // Converte para Timestamps do Firebase
    const startTimestamp = firebase.firestore.Timestamp.fromDate(dI);
    const endTimestamp = firebase.firestore.Timestamp.fromDate(dF);

    try {
        // 3. Executa a consulta no Firestore com o filtro de data (query otimizada)
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('conferente', '==', currentUserData.nome_militar_completo)
            .where('timestamp', '>=', startTimestamp) // Data de início
            .where('timestamp', '<=', endTimestamp)   // Data de fim
            .orderBy('timestamp', 'desc') // Ordena (necessário ao usar where em timestamp)
            .limit(100)
            .get();
            
        let docs = [];
        snap.forEach(doc => docs.push(doc.data()));

        let html = '';
        docs.forEach(d => {
            html += criarItemHistoricoHTML(d);
        });
        
        ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nada encontrado no período selecionado.</li>';
        
    } catch(e){ 
        console.error("Erro no loadMyHistory:", e);
        ul.innerHTML='<li>Erro ao carregar histórico.</li>';
    }
}

    async function loadGlobalHistory() {
    const ul = document.getElementById('global-history-list');
    ul.innerHTML = '<li>Buscando...</li>';
    
    // Captura o valor dos filtros
    const dI = new Date(document.getElementById('glob-hist-start').value + 'T00:00:00');
    const dF = new Date(document.getElementById('glob-hist-end').value + 'T23:59:59');
    const localFilter = document.getElementById('glob-hist-local').value;
    const conferenteFilter = document.getElementById('glob-hist-user').value; // Valor do Conferente

    try {
        // 1. Inicia a consulta com os filtros de data (obrigatório para orderBy)
        let queryRef = db.collection(COLECAO_RESULTADOS)
            .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(dI))
            .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(dF))
            .orderBy('timestamp', 'desc');

        // 2. CORREÇÃO: Aplica o filtro 'where' se um Conferente específico for selecionado
        if (conferenteFilter) {
            queryRef = queryRef.where('conferente', '==', conferenteFilter);
        }

        const snap = await queryRef.limit(100).get();
        
        // Carrega o mapeamento de Unidades (necessário para o filtro de Gestor)
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const listToUnitMap = {};
        Object.keys(rotas).forEach(key => listToUnitMap[rotas[key].nome] = rotas[key].unidade || 'GERAL');

        let docs = [];
        snap.forEach(d => docs.push(d.data()));

        let html = '';
        docs.forEach(d => {
            const localNome = d.local.split(' - ')[1] || d.local;
            const unit = listToUnitMap[localNome] || 'GERAL';

            // Filtro de segurança (Gestor)
            if(currentUserData.role === 'gestor' && unit !== currentUserData.unidade) return; 
            
            // Filtro Local: só aplica na memória se for necessário
            if(!localFilter || localNome === localFilter) {
                html += criarItemHistoricoHTML(d);
            }
        });

        ul.innerHTML = html || '<li>Nada encontrado.</li>';
    } catch(e){ 
        console.error("Erro ao carregar histórico global:", e);
        ul.innerHTML='Erro ao carregar histórico.';
    }
}
        function criarItemHistoricoHTML(data) {
            const dataHora = data.timestamp.toDate().toLocaleString('pt-BR');
            const temAlteracao = (data.itensRelatorio && data.itensRelatorio.some(i => i.status !== 'S/A')) || (!data.itensRelatorio && data.totalCaa > 0);
            
            return `<li class="history-item"><div class="hist-info"><strong>${data.local}</strong><small>${data.conferente} • ${dataHora}</small></div><div style="display:flex;align-items:center;"><span class="hist-status ${temAlteracao?'status-alert':'status-ok'}">${temAlteracao?'C/A':'S/A'}</span><button class="btn-reprint" onclick='reimprimirPDF(${JSON.stringify(data)})'><i class="fas fa-file-pdf"></i></button></div></li>`;
        }

        // --- 6. GESTÃO DE UNIDADES (ADMIN) ---
        async function carregarUnidadesVisuais() {
    const container = document.getElementById('units-cards-container');
    container.innerHTML = 'Carregando...';
    
    // --- Variáveis de Restrição ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // -----------------------------
    
    try {
        const unitsDoc = await db.collection('config_geral').doc('unidades').get();
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const unidades = unitsDoc.data().lista || [];
        const rotas = rotasDoc.data() || {};

        container.innerHTML = '';
        unidades.forEach(u => {
            const listsInUnit = Object.values(rotas).filter(r => r.unidade === u).map(r => r.nome);
            const card = document.createElement('div');
            card.className = 'sector-card status-unit';
            card.innerHTML = `<h3>${u}</h3><div class="card-footer"><strong>Contém:</strong><ul class="sub-list-preview">${listsInUnit.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
            card.onclick = () => abrirGestaoUnidade(u, rotas);
            container.appendChild(card);
        });

        // --- NOVO: FILTRAGEM DOS LOCAIS PARA O SELECT DO HISTÓRICO GLOBAL ---
        const sel = document.getElementById('glob-hist-local');
        // Garante que o elemento existe e reseta com a opção "Todos"
        if(sel) sel.innerHTML = '<option value="">Todos</option>'; 
        
        if(sel) {
            // 1. Mapeia todas as rotas (viaturas/listas) ativas
            let locaisFiltrados = Object.values(rotas)
                .filter(r => r.ativo !== false) 
                // 2. Aplica a restrição: Se for gestor, só mostra as rotas da sua unidade.
                .filter(r => !isGestor || r.unidade === unidadeGestor) 
                .map(r => r.nome); 

            // 3. Remove duplicatas e ordena
            const locaisUnicos = [...new Set(locaisFiltrados)].sort();
            
            locaisUnicos.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l; 
                o.text = l; 
                sel.appendChild(o); 
            });
        }
    } catch(e){ 
        console.error("Erro ao carregar unidades visuais:", e);
        container.innerHTML='Erro ao carregar dados.';
    }
}
        function abrirGestaoUnidade(unitName, allRotas) {
            document.getElementById('edit-unit-original-name').value = unitName;
            document.getElementById('edit-unit-name-input').value = unitName;
            const checklist = document.getElementById('unit-lists-checklist');
            checklist.innerHTML = '';
            
            Object.entries(allRotas).forEach(([id, r]) => {
                if(r.ativo === false) return;
                const div = document.createElement('div');
                div.className = 'checklist-item';
                const isChecked = (r.unidade === unitName) ? 'checked' : '';
                
                div.innerHTML = `<input type="checkbox" id="chk-${id}" ${isChecked} value="${id}"> <label for="chk-${id}" style="margin:0;font-weight:normal;">${r.nome} (${r.posto})</label>`;
                checklist.appendChild(div);
            });
            document.getElementById('modal-unit-manager').style.display = 'flex';
        }

        async function salvarAlteracoesUnidade() {
            const oldName = document.getElementById('edit-unit-original-name').value;
            const newName = document.getElementById('edit-unit-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome inválido");
            
            try {
                const unitsRef = db.collection('config_geral').doc('unidades');
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#unit-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    if (chk.checked) {
                        rotasData[id].unidade = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: newName });
                    } else if (rotasData[id].unidade === oldName) {
                        rotasData[id].unidade = null; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: null });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!"); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirUnidade() {
            const name = document.getElementById('edit-unit-original-name').value;
            if(!confirm(`Excluir a unidade ${name}? As listas perderão o vínculo.`)) return;
            
            try {
                await db.collection('config_geral').doc('unidades').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const s = await rotasRef.get(); 
                const d = s.data();
                
                Object.keys(d).forEach(k => { 
                    if(d[k].unidade === name) d[k].unidade = null; 
                });
                
                await rotasRef.set(d);
                alert("Excluído."); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e){ 
                alert("Erro");
            }
        }

        // --- 6.5 GESTÃO DE POSTOS (NOVO!) ---
        async function carregarPostosVisuais() {
            const container = document.getElementById('postos-cards-container');
            if(!container) return;
            container.innerHTML = 'Carregando...';
            
            try {
                const postosDoc = await db.collection('config_geral').doc('postos').get();
                const rotasDoc = await db.collection('config_geral').doc('rotas').get();
                const postos = postosDoc.exists ? (postosDoc.data().lista || []) : [];
                const rotas = rotasDoc.data() || {};

                container.innerHTML = '';
                postos.sort().forEach(p => {
                    const listsInPosto = Object.values(rotas).filter(r => r.posto === p).map(r => r.nome);
                    const card = document.createElement('div');
                    card.className = 'sector-card status-posto';
                   
                    card.innerHTML = `<h3>${p}</h3><div class="card-footer"><strong>Contém:</strong><ul class="sub-list-preview">${listsInPosto.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
                    card.onclick = () => abrirGestaoPosto(p, rotas);
                    container.appendChild(card);
                });
            } catch(e){ 
                container.innerHTML='Erro'; 
            }
        }

        function criarPosto() {
            const nome = document.getElementById('new-posto-name').value.trim().toUpperCase();
            if(!nome) return alert("Digite o nome.");
            
            db.collection('config_geral').doc('postos').set({ lista: firebase.firestore.FieldValue.arrayUnion(nome) }, { merge: true })
            .then(() => { 
                alert("Posto criado!"); 
                carregarPostosVisuais(); 
            })
            .catch(e => alert("Erro: " + e.message));
        }

        function abrirGestaoPosto(postoName, allRotas) {
            document.getElementById('edit-posto-original-name').value = postoName;
            document.getElementById('edit-posto-name-input').value = postoName;
            
            const checklist = document.getElementById('posto-lists-checklist');
            checklist.innerHTML = '';
            
            Object.entries(allRotas).forEach(([id, r]) => {
                if(r.ativo === false) return;
                const div = document.createElement('div');
                div.className = 'checklist-item';
                const isChecked = (r.posto === postoName) ? 'checked' : '';
                
                div.innerHTML = `<input type="checkbox" id="chk-p-${id}" ${isChecked} value="${id}"> <label for="chk-${id}" style="margin:0;font-weight:normal;">${r.nome}</label>`;
                checklist.appendChild(div);
            });
            document.getElementById('modal-posto-manager').style.display = 'flex';
        }

        async function salvarAlteracoesPosto() {
            const oldName = document.getElementById('edit-posto-original-name').value;
            const newName = document.getElementById('edit-posto-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome inválido");

            try {
                // 1. Atualizar lista de postos
                const postosRef = db.collection('config_geral').doc('postos');
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                // 2. Atualizar vínculos das rotas
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#posto-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    // Simplificação: Checkbox marcado = define posto.
                    if (chk.checked) {
                        rotasData[id].posto = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ posto: newName });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!");
                document.getElementById('modal-posto-manager').style.display = 'none';
                carregarPostosVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirPosto() {
            const name = document.getElementById('edit-posto-original-name').value;
            if(!confirm(`Excluir o posto ${name}?`)) return;
            
            try {
                await db.collection('config_geral').doc('postos').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                alert("Excluído."); 
                document.getElementById('modal-posto-manager').style.display = 'none'; 
                carregarPostosVisuais();
            } catch(e){ 
                alert("Erro"); 
            }
        }

        // --- FUNÇÕES DE FORMATAÇÃO DE TEXTO (NECESSÁRIAS PARA O PDF) ---

function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    // Adicionando a função formatarDataSimples do outro arquivo
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('pt-BR');
}

const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    
    // 1. FORMATAÇÃO DA RESPOSTA DO GESTOR (ADMIN)
    if (adminStatus) {
        // Armazenamos o Status e a Observação separados para facilitar a formatação no HTML
        const gestorLinha = `[${adminStatus}] (Admin): ${adminObs}`; 
        linhas.push(gestorLinha);
    }
    
    const separator = ' | + NOVA: ';
    
    // 2. FORMATAÇÃO DAS OBSERVAÇÕES DO CONFERENTE (LINEAR HISTORY)
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
            const match = p.match(regex);
            
            // Verifica se é a AÇÃO GESTOR já salva no histórico.
            if (match && match[1].includes('[AÇÃO GESTOR:')) {
                return; 
            }

            // Se for observação de Conferente:
            if (match) {
                // Formato padrão: Por: NOME em DATA: "OBS"
                linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            } else {
                // Se for texto simples (fallback, não deve acontecer com o padrão atual)
                linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
            }
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
        const match = p.match(regex);

        // Verifica se é uma AÇÃO GESTOR na primeira linha 
        if (match && match[1].includes('[AÇÃO GESTOR:')) {
            return; // Já tratado na seção 1
        }
        
        // Se for a primeira observação de Conferente:
        if (match) {
            linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        } else {
            linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        }
    }
    return linhas;
};

// Função wrapper apenas para manter a consistência com o app (não usada no PDF)
const gerarHtmlVisual = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = gerarLinhasFormatadas(textoBruto, autorAtual, dataAtual, adminStatus, adminObs);
    let html = '<ul class="lista-pendencias">';
    
    linhas.forEach(l => { 
        if (l.includes('(Admin):')) { 
            // Formato de entrada: [STATUS] (Admin): Observação do Gestor
            const [carimboStatus, obsText] = l.split(':');
            const statusText = carimboStatus.match(/\[(.*?)\]/)[1]; // Ex: "EM SOLUÇÃO"
            
            let icon = '';
            let statusColor = '#f57c00'; // Amarelo/Laranja padrão para Em Solução
            let obsColor = '#555';

            // Mapeamento dos Ícones e Cores
            switch(statusText.toUpperCase().trim()) {
                case 'SOLUCIONADO':
                case 'REMOVER':
                    icon = '✅️';
                    statusColor = '#1b8a3e'; // Verde
                    break;
                case 'CAUTELADO':
                    icon = '🔃';
                    statusColor = '#0d47a1'; // Azul
                    break;
                case 'EM SOLUÇÃO':
                default:
                    icon = '⚠️';
                    break;
            }
            
            // Formatado como: **Gestor** <span style="color: StatusColor;">⚠️ *Status*: </span> Observação
            html += `<li>
                        <span style="color: #d90f23;"><b>Gestor</b></span>:
                        <span style="color: ${statusColor}; font-style: italic;">
                            ${icon} ${statusText}
                        </span>
                        : ${obsText.trim()}
                    </li>`; 
        } else { 
            // Formato Conferente: • **Por [Usuário + Data]:**
            // Quebra a linha: Carimbo ("Por: NOME em DATA") e o Resto (": "OBS")
            const [carimbo, ...resto] = l.split(':');
            
            // Aplica BOLD no Carimbo: "Por: NOME em DATA"
            const carimboBold = carimbo.replace('Por:', '**Por**');
            
            html += `<li class="linha-obs">• ${carimboBold}:${resto.join(':')}</li>`;
        } 
    });
    
    html += '</ul>';
    return html;
};

// --- PDF GENERATOR (FUNÇÃO ATUALIZADA) ---
function reimprimirPDF(data) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const MARGIN = 14, PG_W = 210, LOGO_S = 15;

        // MANTÉM A LÓGICA DE BUSCA DE IMAGEM DO DASHBOARD
        // Busca a imagem já carregada no DOM para desenhar no PDF
        const logoDraw = (domId, x) => { 
            // Utilizamos uma consulta que verifica se o src contém o domId
            const el = document.querySelector(`img[src*="${domId}"]`);
            if(el) { 
                try{
                    const c=document.createElement('canvas');
                    c.width=160;
                    c.height=160;
                    c.getContext('2d').drawImage(el,0,0,160,160);
                    // Adiciona a imagem ao PDF
                    doc.addImage(c.toDataURL('image/png'),'PNG',x,10,LOGO_S,LOGO_S);
                }catch(e){
                    // Em caso de falha no canvas (como CORS), o processo continua
                    console.warn(`Falha ao desenhar imagem ${domId}`);
                } 
            } else {
                 console.warn(`Elemento img[src*="${domId}"] não encontrado no DOM. O logo não será exibido.`);
            }
        };
        
        // --- CHAMADAS PARA DESENHAR AS LOGOS ---
        // 1. Logo CBM-RR (Esquerda)
        logoDraw('cbmrr.png', MARGIN);
        // 2. Logo SIGMA (Direita)
        logoDraw('logo_sigma.png', PG_W-MARGIN-LOGO_S);
        
        // CABEÇALHO
        doc.setFontSize(10);
        doc.setTextColor(51); 
        doc.setFont('helvetica','bold');
        doc.text('GOVERNO DE RORAIMA', PG_W/2, 15, {align:'center'}); 
        doc.setTextColor(217,15,35);
        doc.text('CORPO DE BOMBEIROS MILITAR DE RORAIMA', PG_W/2, 20, {align:'center'}); 
        doc.setTextColor(51); 
        doc.setFont('helvetica','italic');
        doc.text('"Amazônia: patrimônio dos brasileiros"', PG_W/2, 25, {align:'center'});
        doc.setFontSize(14); 
        doc.setTextColor(0);
        doc.setFont('helvetica','bold'); 
        doc.text("RELATÓRIO DE CONFERÊNCIA", PG_W/2, 35, {align:'center'});

        // INFORMAÇÕES DE BASE
        doc.setFillColor(240, 240, 240);
        doc.setDrawColor(200, 200, 200); 
        doc.roundedRect(MARGIN, 40, PG_W - (MARGIN*2), 25, 2, 2, 'FD');
        
        doc.setFontSize(10); 
        doc.setTextColor(50);
        let y = 46;
        const X_LABEL = MARGIN + 5; 
        const X_VAL = MARGIN + 30;
        
        const dataTimestamp = data.timestamp ?
        new Date(data.timestamp.seconds * 1000) : new Date();
        const dataHoraStr = dataTimestamp.toLocaleString('pt-BR');
        
        doc.setFont('helvetica','bold'); 
        doc.text('Local:', X_LABEL, y); 
        doc.setFont('helvetica','normal');
        doc.text(data.local || '', X_VAL, y); 
        y+=6; 
        doc.setFont('helvetica','bold'); 
        doc.text('Conferente:', X_LABEL, y); 
        doc.setFont('helvetica','normal'); 
        doc.text(data.conferente || '', X_VAL, y); 
        y+=6; 
        doc.setFont('helvetica','bold');
        doc.text('Data/Hora:', X_LABEL, y); 
        doc.setFont('helvetica','normal'); 
        doc.text(dataHoraStr, X_VAL, y); 
        
        // TOTALIZADOR
        doc.setFont('helvetica','bold');
        doc.setTextColor(128, 0, 32);
        doc.text(`TOTAL: ${data.totalItensConferidos || 0} | C/A: ${data.totalCaa || 0}`, PG_W - MARGIN - 5, 46, {align:'right'});

        // TABELA DE ITENS
        let tableBody = [];
        const RED_FILL = [217, 15, 35]; 
        const GREEN_FILL = [27, 138, 62]; 
        const SECTOR_BG = [60, 60, 60];
        let listaParaImprimir = [];
        
        if (data.itensRelatorio && data.itensRelatorio.length > 0) listaParaImprimir = data.itensRelatorio;
        else if (data.itensCaa && data.itensCaa.length > 0) listaParaImprimir = data.itensCaa;
        else tableBody.push([{ content: 'CONFERÊNCIA REALIZADA SEM ALTERAÇÕES (REGISTRO LEGADO)', colSpan: 4, styles: { halign: 'center', fillColor: GREEN_FILL, textColor: 255, fontStyle: 'bold', cellPadding: 5 } }]);
        
        if (listaParaImprimir.length > 0) {
            let currentSector = null;
            listaParaImprimir.forEach(item => {
                // Lógica de Agrupamento por Setor
                let setorItem = item.setor || "ITENS GERAIS";
                if(setorItem !== currentSector) {
                    tableBody.push([{ content: setorItem.toUpperCase(), colSpan: 4, styles: { fillColor: SECTOR_BG, textColor: 255, fontStyle: 'bold', halign: 'left' } }]);
                    currentSector = setorItem;
                }

                // Lógica de Formatação de Observações
                let finalObs = item.obs || '-';
                
                // ADICIONADO: Variáveis de contexto para a formatação
                const dataConf = dataTimestamp.toLocaleDateString('pt-BR');
                const conf = data.conferente; 
                
                // 1. Usa a função padrão para obter o array de linhas formatadas
                let linhasFormatadas = [];
                if (finalObs !== '-') {
                    linhasFormatadas = gerarLinhasFormatadas(
                        finalObs, 
                        conf, 
                        dataConf,
                        item.statusAdmin, 
                        item.adminObs
                    );
                }
                
                // 2. Transforma o array de linhas em uma string separada por quebra de linha
                // O prefixo '•' já está incluso na função gerarLinhasFormatadas para observações.
                finalObs = linhasFormatadas.map(l => {
                    // Substitui o prefixo de admin (ex: "⚠️ [SOLUCIONADO] (Admin):") para um formato de relatório mais limpo
                    if(l.includes('(Admin):')) {
                        return l.replace('⚠️ ', 'RESPOSTA DA GESTÃO: ');
                    }
                    return l;
                }).join('\n');
                
                if (finalObs.trim() === '') finalObs = '-'; // Volta para '-' se ficar vazio.

                // FIM DA LÓGICA DE FORMATAÇÃO DE OBSERVAÇÕES
                
                let bgStatus = GREEN_FILL;
                if (item.status === 'C/A' || item.status === 'KEEP') bgStatus = RED_FILL;
                
                // Adiciona a linha à tabela
                tableBody.push([ 
                    item.nomeCompleto || 'Item', 
                    { content: `QTD: ${item.quantidade || 1}`, styles: { halign: 'center', valign: 'middle' } }, 
                    { content: item.status || 'S/A', styles: { fillColor: bgStatus, textColor: 255, fontStyle: 'bold', halign: 'center', valign: 'middle' } }, 
                    { content: finalObs, styles: { halign: 'left', valign: 'middle' } } 
                ]);
            });
        }
        
        // Configuração e Geração da Tabela
        doc.autoTable({ 
            startY: 70, 
            head: [['Item', 'Quantidade', 'Status', 'Observação']], 
            body: tableBody, 
            theme: 'striped', 
            styles: { fontSize: 8, valign: 'middle', textColor: 51, cellPadding: 1.5 }, 
            columnStyles: { 
                0:{cellWidth:80, halign:'left'}, 
                1:{cellWidth:20,halign:'center'}, 
                2:{cellWidth:20,halign:'center'}, 
                3:{cellWidth:'auto',halign:'left'} 
            }, 
            headStyles: { fillColor: [128, 0, 32], textColor: 255, fontStyle: 'bold', halign: 'center' } 
        });

        // Rodapé com Paginação
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8); 
            doc.setTextColor(100);
            doc.text('SIGMA - Sistema Integrado de Gestão de Materiais', MARGIN, doc.internal.pageSize.height-10);
            doc.text(`Pág. ${i} de ${totalPages}`, PG_W-MARGIN, doc.internal.pageSize.height-10, {align:'right'});
        }
        
        // Nome do Arquivo
        const nomeArquivo = `Relatorio_${(data.local||'Conf').replace(/[^a-zA-Z0-9]/g,'')}_${dataTimestamp.toISOString().split('T')[0]}.pdf`;
        doc.save(nomeArquivo);
        
    } catch(e) { 
        console.error(e);
        alert("Erro ao gerar PDF: " + e.message);
    }
}
        // --- OUTROS E FUNÇÕES GLOBAIS (UI) ---
        
        function sairDoSistema() { 
            auth.signOut().then(() => { 
                sessionStorage.clear(); 
                window.location.href = 'index.html'; 
            });
        }
        function logout() {
            sairDoSistema();
        }
        
        function switchView(v) {
            // Esconde todas as seções de visualização
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');    
            // Mostra a seção desejada
            const viewElement = document.getElementById(`view-${v}`);
            if (viewElement) {
                viewElement.style.display = 'block';
            } else {
                console.error(`View não encontrada: view-${v}`);
                return;
            }
    
    // Remove a classe 'active' de todos os links e adiciona ao link clicado
    document.querySelectorAll('#main-sidebar a').forEach(el => el.classList.remove('active'));
const activeLink = document.getElementById(`link-${v}`);
    if (activeLink) {
        activeLink.classList.add('active');
}

    // --- AÇÕES ESPECÍFICAS POR VIEW ---
    if (v === 'unidades') {
        carregarUnidadesVisuais();
        setupCadastroMilitarLogic();
// Carrega os cards de Unidades/Rotas (Visão Admin)
    }
    
    if (v === 'postos') {
        carregarPostosVisuais();
// Carrega os cards de Postos (Visão Admin)
    }

    if (v === 'usuarios') {
        listarUsuarios();
// Carrega a tabela de usuários (Visão Admin/Gestor)
        carregarUnidadesSelect();
// Carrega o select de Unidades para o modal de cadastro/edição
    }
    
    if (v === 'listas') {
        // 1. Carrega os Postos de Serviço (Dropdown 1)
        carregarPostosServicoSelect('novo-local-posto'); 
    
        // 2. Carrega as unidades e aplica a lógica de Gestor (Dropdown 2)
        carregarUnidadesSelect('novo-local-unidade'); 
    
        // 3. Carrega a lista de locais existente (se existir)
        carregarListaLocaisAdmin(); 
    }

    if(v === 'global-history') {
        // Inicializa o filtro de data (últimos 30 dias)
        document.getElementById('glob-hist-start').valueAsDate = new Date(new Date().setDate(new Date().getDate()-30));
        document.getElementById('glob-hist-end').valueAsDate = new Date();
        
        
        // Carrega as opções de Local (Viatura) e Filtra por Unidade do Gestor
        carregarUnidadesVisuais();
        // NOVO: Carrega as opções de Conferente (Usuário) e Filtra por Unidade do Gestor
        carregarUsuariosFiltro();
        // Carrega o histórico com os filtros iniciais
        loadGlobalHistory();
    }

    if(v === 'my-history') {
        // 1. Calcular a data de 30 dias atrás
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 30); // Subtrai 30 dias
        document.getElementById('my-hist-start').valueAsDate = startDate;
        document.getElementById('my-hist-end').valueAsDate = endDate;
        loadMyHistory();
    }

    // === SOLUÇÃO: FECHA O MENU APÓS SELEÇÃO NO MOBILE ===
    if (window.innerWidth <= 768) {
        history.pushState(null, null, location.href);
        closeMenuMobile();
    }
    // ===================================================
}
        function toggleMenuMobile() { 
            const s = document.getElementById('main-sidebar');
            if(s.classList.contains('mobile-active')) { 
                s.classList.remove('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='none'; 
            } else { 
                s.classList.add('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='block'; 
            } 
        }
        function closeMenuMobile() { 
    // Obtém o elemento sidebar
    const s = document.getElementById('main-sidebar');

    // Remove explicitamente a classe 'mobile-active' (fecha o menu),
    // independentemente do estado atual.
    if(s.classList.contains('mobile-active')) { 
        s.classList.remove('mobile-active'); 
        document.getElementById('mobile-overlay').style.display='none';
    } 
    // Remove a chamada a toggleMenuMobile()
}
        
        // --- FUNÇÕES DO MODAL GESTÃO C/A ---
        function mostrarTabela(data) {
    const wrapper = document.getElementById('ca-table-wrapper'), tbody = document.getElementById('ca-list-body');
    document.getElementById('table-title').textContent = `Detalhes: ${data.local}`; 
    tbody.innerHTML = '';
    
    // Garante array
    const items = data.items || [];
    const itemsToShow = items.filter(i => i.statusAdmin !== 'Solucionado');
    
    if (itemsToShow.length === 0) { 
        wrapper.querySelector('table').style.display = 'none';
        document.getElementById('no-issues-msg').style.display = 'block';
    } else {
        wrapper.querySelector('table').style.display = 'table';
        document.getElementById('no-issues-msg').style.display = 'none';
        
        itemsToShow.forEach(i => {
            const tr = tbody.insertRow();
            
            // 1. Formata o histórico de observações usando a função padronizada (HTML)
            const obsHtmlFormatada = gerarHtmlVisual(
                i.obs || '', 
                data.conferente, // Nome do conferente original (fallback)
                data.date, // Data da conferência original (fallback)
                i.statusAdmin, 
                i.adminObs
            );

            // 2. Define a classe do badge para o status de gestão
            const statusAdmin = i.statusAdmin || 'Pendente';
            // Garante que o status do Firebase (Ex: Em solução, Cautelado) seja minúsculo e com traço (Ex: em-solucao)
            const badgeClass = 'badge-' + statusAdmin.toLowerCase().replace(' ', '-');
            
            // INJEÇÃO DO DOC_ID DO PAI NO ITEM FILHO
            const itemComDocId = { ...i, docId: data.docId }; 
            
            tr.innerHTML = `
                <td><strong>${i.nomeCompleto}</strong></td>
                <td><span class="status-badge ${badgeClass}">${statusAdmin}</span></td>
                <td>${obsHtmlFormatada}</td>
                <td><small>${data.conferente}<br>${data.date}</small></td>
            `;
            
            const td = tr.insertCell(); 
            // Passa o item enriquecido para o modal de gestão
            td.innerHTML = `<button class="btn-modern-action btn-create" onclick='abrirModalGestao(${JSON.stringify(itemComDocId)})'>Gerenciar</button>`;
        });
    }
    wrapper.style.display = 'block';
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
        function fecharTabela(){ 
            document.getElementById('ca-table-wrapper').style.display='none';
        }
        
        function abrirModalGestao(i){
            document.getElementById('gestao-item-nome').textContent = i.nomeCompleto;
            document.getElementById('gestao-doc-id').value = i.docId; 
            document.getElementById('gestao-item-index').value = i.originalIndex;
            document.getElementById('gestao-item-id-lista').value = i.id; 
            document.getElementById('gestao-item-max-qtd').value = i.quantidade || 1;
            
            document.getElementById('gestao-status').value = i.statusAdmin || 'Solucionado';
            document.getElementById('gestao-obs').value = '';
            document.getElementById('gestao-qtd').value = '1';
            toggleGestaoQtd();

            document.getElementById('modal-gestao-ca').style.display = 'flex';
        }

        function fecharModalGestao(){ 
            document.getElementById('modal-gestao-ca').style.display='none';
        }

        function toggleGestaoQtd(){
            const isRemover = document.getElementById('gestao-status').value === 'Remover';
            document.getElementById('div-gestao-qtd').style.display = isRemover ? 'block' : 'none';
            if(isRemover) {
                const max = document.getElementById('gestao-item-max-qtd').value;
                document.getElementById('gestao-qtd').max = max;
                document.getElementById('gestao-qtd-info').textContent = `Estoque atual: ${max}`;
            }
        }

        document.getElementById('gestao-status').onchange = toggleGestaoQtd;
        
        async function salvarGestaoCa(){
    // [1] RECUPERAÇÃO DE DADOS DO MODAL
    const docId = document.getElementById('gestao-doc-id').value;
    const itemId = document.getElementById('gestao-item-id-lista').value;
    const status = document.getElementById('gestao-status').value;
    const obsRaw = document.getElementById('gestao-obs').value.trim();
    const qtdRemover = parseInt(document.getElementById('gestao-qtd').value);
    
    // [2] VALIDAÇÃO BÁSICA
    if(!obsRaw) return alert("Digite uma observação.");

    try {
        // [3] RECUPERAÇÃO DE METADADOS DO GESTOR E DATA/HORA
        const nomeGestor = `${currentUserData.posto} ${currentUserData.quadro} ${currentUserData.nome_guerra}`;
        const dataHoraStr = new Date().toLocaleString('pt-BR');
        
        // Texto que será carimbado na linha do HISTÓRICO (item.obs)
        const carimboTextoHistorico = `[AÇÃO GESTOR: ${status.toUpperCase()}] ${obsRaw}` + 
                                    (status === 'Remover' ? ` (Removido ${qtdRemover} do estoque)` : '');

        // A linha completa a ser adicionada no histórico linear (formato padronizado)
        const novaLinhaObs = `"${carimboTextoHistorico}" (Por: ${nomeGestor} em ${dataHoraStr})`;
        
        // Texto para exibição no campo adminObs (apenas o raw)
        const obsFinalDisplay = obsRaw; 


        // [4] BUSCA DO DOCUMENTO PAI NO FIREBASE
        const ref = db.collection(COLECAO_RESULTADOS).doc(docId);
        const snap = await ref.get();
        if(!snap.exists) return alert("Erro: Conferência não encontrada.");
        
        const resData = snap.data();
        const items = resData.itensCaa || [];
        
        // [5] BUSCA INTELIGENTE DO ITEM (Pelo ID)
        let targetIndex = -1;
        targetIndex = items.findIndex(i => i.id === itemId);
        
        if (targetIndex === -1) {
            const nomeAlvo = document.getElementById('gestao-item-nome').textContent;
            targetIndex = items.findIndex(i => i.nomeCompleto === nomeAlvo);
        }

        if (targetIndex === -1) return alert("Erro: Item não encontrado na lista de pendências. Alguém pode ter modificado antes.");
        
        // [6] ATUALIZAÇÃO DOS CAMPOS DO ITEM
        const itemParaAtualizar = items[targetIndex];

        // *** CORREÇÃO CRUCIAL 1: Atualiza o campo de histórico linear (item.obs) no resultados_conferencias ***
        let obsAtualizada = itemParaAtualizar.obs || '';
        if (obsAtualizada.trim() !== '') {
            obsAtualizada += ' | + NOVA: ';
        }
        obsAtualizada += novaLinhaObs;
        itemParaAtualizar.obs = obsAtualizada; // SALVA A NOVA LINHA NO HISTÓRICO LINEAR

        // Atualiza campos específicos do Administrador (para uso no Dashboard)
        itemParaAtualizar.statusAdmin = (status === 'Remover' ? 'Solucionado' : status); 
        itemParaAtualizar.adminObs = obsFinalDisplay; 
        
        
        // [7] SALVA AS MUDANÇAS NO FIREBASE
        await ref.update({ itensCaa: items });
        
        
        // [8] ATUALIZAÇÃO NA LISTA MESTRE (LÓGICA DO ESTOQUE E PERSISTÊNCIA DO CARIMBO)
        
        const listaId = resData.lista_id;
        if(listaId) {
            const listRef = db.collection(COLECAO_LISTAS).doc(listaId);
            const listSnap = await listRef.get();
            let updated = false;

            if(listSnap.exists) {
                let listaData = listSnap.data().list;
                
                const updateItemInMasterList = (item, isTombamento = false) => {
                    const isSolved = (status === 'Remover' || status === 'Solucionado');
                    const isManaged = (status === 'Em solução' || status === 'Cautelado');
                    
                    if (isSolved) {
                        // LÓGICA DE SOLUÇÃO (Remove do estoque ou deleta pendência)
                        if (status === 'Remover') {
                            if (!isTombamento) item.quantidadeEsperada -= qtdRemover;
                            else item.tombamentos.splice(item.tombamentos.findIndex(t => t.tomb === itemId.split('-')[1]), 1);
                            
                            if (item.quantidadeEsperada <= 0 || isTombamento) { 
                                // O Splicing do tombamento foi feito na linha acima. 
                                // O splicing do item completo precisa de lógica mais complexa, mas vamos manter o delete pendencia aqui.
                            }
                        }
                        
                        // Atualiza o histórico na lista Mestra antes de deletar a pendência
                        if(item.pendencia && item.pendencia.obs) item.pendencia.obs = obsAtualizada;
                        delete item.pendencia;
                        updated = true;
                        
                    } else if (isManaged) {
                        // LÓGICA DE GESTÃO (ATUALIZA APENAS O CAMPO OBS PARA PERSISTÊNCIA)
                        if (item.pendencia) {
                            item.pendencia.obs = obsAtualizada; // Injeta o histórico completo na lista mestra
                            // item.pendencia.statusAdmin e adminObs NÃO SÃO SALVOS AQUI.
                            updated = true;
                        }
                    }
                    return updated;
                };

                for(let s of listaData) {
                    for(let i = s.itens.length - 1; i >= 0; i--) {
                        const item = s.itens[i];
                        if(item.tipo === 'single' && item.id === itemId) {
                            updateItemInMasterList(item);
                        }
                        else if(item.tipo === 'multi' && item.tombamentos) {
                            const tIndex = item.tombamentos.findIndex(t => `${item.id}-${t.tomb}` === itemId);
                            if(tIndex > -1) {
                                updateItemInMasterList(item.tombamentos[tIndex], true);
                            }
                        }
                    }
                }
                
                if(updated) await listRef.update({ list: listaData });
            }
        }

        // [9] FINALIZAÇÃO
        alert("Salvo com sucesso!");
        fecharModalGestao();
        fecharTabela();
        loadCaaData(); 
    } catch(e) { 
        console.error(e); 
        alert("Erro ao salvar: " + e.message);
    }
}
        // --- FUNÇÕES DE EDITOR (MOVIDAS PARA O ESCOPO GLOBAL) ---
        function abrirEditor(id, nome, unidadeLista) { 
    
    // --- NOVA VERIFICAÇÃO DE PERMISSÃO DE UNIDADE ---
    // Verifica se o usuário é um Gestor E se a Unidade da Lista 
    // é diferente da Unidade do usuário logado.
    if (currentUserData.role === 'gestor' && unidadeLista !== currentUserData.unidade) {
        alert("Acesso negado. Você só pode editar listas da sua unidade.");
        return; // Impede que o editor seja aberto
    }
    // --------------------------------------------------

    currentEditingId = id;
    const editorTitleEl = document.getElementById('editor-title');
    if(editorTitleEl) {
        editorTitleEl.textContent = `Editando: ${nome}`; 
    }
    
    switchView('editor'); 
    carregarDadosGerenciador(); 
}
        function voltarParaLocais() { 
            currentEditingId = null;
            switchView('listas'); 
        }
        
        async function carregarDadosGerenciador(){ 
            if(!currentEditingId) return;
            try{ 
                document.getElementById('loading-message-admin').style.display = 'block';
                document.getElementById('main-admin-content').style.display = 'none';
                const d=await db.collection(COLECAO_LISTAS).doc(currentEditingId).get(); 
                dadosConferencia=d.exists?(d.data().list||[]):[]; 
                renderizarLista(); 
                document.getElementById('loading-message-admin').style.display = 'none';
                document.getElementById('main-admin-content').style.display = 'block';
            }catch(e){
                console.error(e);
                alert("Erro ao carregar lista.");
            } 
        }
        async function salvarDados(a=true){ 
            if(!currentEditingId) return;
            try{ 
                await db.collection(COLECAO_LISTAS).doc(currentEditingId).update({ list:dadosConferencia, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }); 
                if(a)alert("Salvo!"); 
            }catch(e){
                alert("Erro ao salvar");
            } 
        }
        function gerarNovoId(){ 
            return Date.now().toString().slice(-6)+Math.floor(Math.random()*100).toString().padStart(2,'0');
        }
        function adicionarSetor(n){ 
            n=n.trim().toUpperCase(); 
            if(!n)return; 
            dadosConferencia.push({id:gerarNovoId(), nome:n, itens:[]}); 
            document.getElementById('input-setor-nome').value=''; 
            salvarDados(false); 
            renderizarLista();
        }
        function removerSetor(id){ 
            if(confirm("Remover setor?")) { 
                dadosConferencia=dadosConferencia.filter(x=>x.id!==id); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        
        // ATENÇÃO: Esta é a função que você deve modificar no sigma_dashboard.html
        function adicionarItemPorSetor(sid) { 
            const n = document.getElementById('input-item-nome-'+sid).value.trim().toUpperCase();
            const q = parseInt(document.getElementById('input-item-qtd-'+sid).value); 
            const t = document.getElementById('select-item-tipo-'+sid).value; 
            
            if(!n || q < 1) return;
            
            // 1. CAPTURAR O SCROLL POSITION ANTES DA RECONSTRUÇÃO DO DOM
            // O elemento que rola é o pai da lista de setores, ou o contêiner principal do editor.
            const scrollContainer = document.querySelector('.admin-container'); 
            let scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            const s = dadosConferencia.find(x => x.id === sid);
            const novo = {id: sid+'-'+gerarNovoId(), nome: n, quantidadeEsperada: q, tipo: t, tombamentos:[]};
            
            if(t === 'multi') for(let i = 0; i < q; i++) novo.tombamentos.push({tomb: 'NOVO-' + (i+1), status: 'pending', obs: ''}); 
            
            s.itens.push(novo);
            
            // OTIMIZAÇÃO: Limpar o campo de nome
            document.getElementById('input-item-nome-'+sid).value = '';

            salvarDados(false);
            
            // 2. RECONSTRUIR A LISTA
            renderizarLista(); 

            // 3. RESTAURAR O SCROLL POSITION APÓS A RECONSTRUÇÃO
            if (scrollContainer && scrollTop > 0) {
                // Usamos um pequeno timeout para garantir que o DOM foi totalmente renderizado
                setTimeout(() => {
                    scrollContainer.scrollTop = scrollTop;
                }, 50);
            }
        }
        function removerItem(sid,iid){ 
            if(confirm("Remover item?")){ 
                const s=dadosConferencia.find(x=>x.id===sid); 
                s.itens=s.itens.filter(i=>i.id!==iid); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function encontrarItemPorId(id) { 
            for (const setor of dadosConferencia) { 
                const item = setor.itens.find(i => i.id === id);
                if (item) return item; 
            } 
            return null; 
        }
        function adicionarTombamento(itemId, inputElement) { 
            const tombamento = inputElement.value.trim().toUpperCase();
            if (!tombamento) return; 
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                if (item.tombamentos.some(t => t.tomb === tombamento)) return alert("Duplicado!");
                item.tombamentos.push({ tomb: tombamento, status: "pending", obs: "" }); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function removerTombamento(itemId, tombamento) { 
            if (!confirm("Remover tombamento?")) return;
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                item.tombamentos = item.tombamentos.filter(t => t.tomb !== tombamento); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function editarTombamento(itemId, tombamentoAtual, inputElement) { 
            const novoTombamento = inputElement.value.trim().toUpperCase();
            if (!novoTombamento || novoTombamento === tombamentoAtual) return; 
            const item = encontrarItemPorId(itemId);
            if (item) { 
                const tomb = item.tombamentos.find(t => t.tomb === tombamentoAtual); 
                if (tomb) { 
                    tomb.tomb = novoTombamento; 
                    salvarDados(false);
                } 
            } 
        }
        function updateOrdens() { 
            const novosDados = [];
            document.querySelectorAll('.setor-item').forEach(sNode => { 
                const sId = sNode.getAttribute('data-id'); 
                const sOriginal = dadosConferencia.find(x => x.id === sId); 
                const novosItens = []; 
                sNode.querySelectorAll('.item-conferencia-admin').forEach(iNode => { 
                    const iId = iNode.querySelector('.btn-edit-alt').getAttribute('onclick').split("'")[3]; 
                    const itemObj = encontrarItemPorId(iId); 
                    if(itemObj) novosItens.push(itemObj); 
                }); 
                sOriginal.itens = novosItens; 
                novosDados.push(sOriginal); 
            });
            dadosConferencia = novosDados; 
        }
        function abrirModalEdicao(sid, iid){ 
            const s=dadosConferencia.find(x=>x.id===sid); 
            const i=s.itens.find(x=>x.id===iid); 
            document.getElementById('edit-setor-id').value=sid; 
            document.getElementById('edit-item-original-id').value=iid;
            document.getElementById('edit-item-nome').value=i.nome; 
            document.getElementById('edit-item-qtd').value=i.quantidadeEsperada; 
            document.getElementById('edit-item-qtd').disabled=(i.tipo==='multi'); 
            document.getElementById('edit-item-tipo').value=i.tipo; 
            const sl=document.getElementById('edit-item-setor'); 
            sl.innerHTML=''; 
            dadosConferencia.forEach(d=>{
                const o=document.createElement('option'); 
                o.value=d.id; 
                o.text=d.nome; 
                if(d.id===sid)o.selected=true; 
                sl.appendChild(o);
            }); 
            document.getElementById('modal-edicao').style.display='flex';
        }
        function salvarEdicaoItem(){ 
            const osid=document.getElementById('edit-setor-id').value; 
            const iid=document.getElementById('edit-item-original-id').value; 
            const n=document.getElementById('edit-item-nome').value.trim().toUpperCase(); 
            const nsid=document.getElementById('edit-item-setor').value; 
            const q=parseInt(document.getElementById('edit-item-qtd').value);
            
            const os=dadosConferencia.find(x=>x.id===osid); 
            const ns=dadosConferencia.find(x=>x.id===nsid); 
            const i=os.itens.find(x=>x.id===iid); 
            i.nome=n; 
            if(i.tipo==='single')i.quantidadeEsperada=q; 
            
            if(osid!==nsid){ 
                os.itens=os.itens.filter(x=>x.id!==iid); 
                i.id=nsid+'-'+gerarNovoId(); 
                ns.itens.push(i); 
            } 
            salvarDados(false); 
            renderizarLista(); 
            fecharModal();
        }
        function fecharModal(){
            document.getElementById('modal-edicao').style.display='none';
        }
        function fazerBackupLocal(){ 
            const b=new Blob([JSON.stringify(dadosConferencia,null,2)],{type:"application/json"});
            const u=URL.createObjectURL(b); 
            const a=document.createElement('a'); 
            a.href=u; 
            a.download='backup.json'; 
            a.click(); 
        }
        function importarBackupLocal(e){ 
            const f=e.target.files[0]; 
            if(!f)return;
            const r=new FileReader(); 
            r.onload=function(ev){
                if(confirm("Substituir?")){
                    try{
                        dadosConferencia=JSON.parse(ev.target.result);
                        salvarDados();
                        renderizarLista();
                    }catch(err){
                        alert("Erro JSON");
                    }
                }
            }; 
            r.readAsText(f); 
        }
        
       async function carregarUnidadesSelect(elementId = 'new-user-unit') {
    const select = document.getElementById(elementId);
    if (!select) return;

    select.innerHTML = '<option value="">Carregando...</option>';

    try {
        // Busca o documento 'unidades' dentro de 'config_geral'
        const docRef = db.collection('config_geral').doc('unidades');
        const doc = await docRef.get();
        
        let unidades = [];

        // Usa a extração segura de dados
        if (doc.exists) {
            unidades = doc.data().lista || []; // Pega o array 'lista'
        }

        // Preenche o dropdown
        select.innerHTML = '<option value="" disabled selected>Selecione a Unidade</option>';
        unidades.sort().forEach(unidade => {
            const option = document.createElement('option');
            option.value = unidade;
            option.textContent = unidade;
            select.appendChild(option);
        });

        // --- LÓGICA DE PERMISSÃO PARA GESTOR ---
        const isGestor = currentUserData && currentUserData.role === 'gestor';
        const gestorUnidade = currentUserData ? currentUserData.unidade : null;
        
        if (isGestor && gestorUnidade) {
            select.value = gestorUnidade;
            select.disabled = true;
            select.style.backgroundColor = '#f0f0f0';
        } else {
            select.disabled = false;
            select.style.backgroundColor = '';
        }

    } catch(e) {
        console.error("Erro CRÍTICO ao carregar unidades:", e);
        select.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}
        async function criarUsuario() {
    const email = document.getElementById('new-user-email').value.trim();
    const guerra = document.getElementById('new-user-guerra').value.trim().toUpperCase();
    const posto = document.getElementById('new-user-posto').value;
    const quadro = document.getElementById('new-user-quadro').value; // Novo Campo
    const completo = document.getElementById('new-user-completo').value.trim().toUpperCase(); // Nome Civil Completo
    const role = document.getElementById('new-user-role').value;
    const unit = document.getElementById('new-user-unit').value;
    
    // NOVOS CAMPOS DE IDENTIFICAÇÃO E CONTATO (LIMPOS)
    const cpfRaw = document.getElementById('new-user-cpf').value.replace(/\D/g, '');
    const matriculaRaw = document.getElementById('new-user-matricula').value.replace(/\D/g, '');
    const telefoneRaw = document.getElementById('new-user-telefone').value.replace(/\D/g, '');

    if (!email || !guerra || !posto || !quadro || !unit || !completo || !cpfRaw || !telefoneRaw) {
        return alert("Preencha todos os campos obrigatórios: Email, Nome Guerra, Posto/Quadro, Nome Completo, CPF, Telefone e Unidade.");
    }
    
    // --- CÁLCULO DAS VARIÁVEIS AUXILIARES ---
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    // Novo Link WhatsApp (Formato web.whatsapp.com)
    const whatsappUrl = `https://web.whatsapp.com/send?phone=55${telefoneRaw}`;

    try {
        await db.collection('usuarios').add({ 
            email: email, 
            nome_guerra: guerra, 
            posto: posto,
            quadro: quadro,
            nome_completo: completo,
            nome_militar_completo: nomeMilitarCompleto, // Nome de Exibição
            telefone_contato: document.getElementById('new-user-telefone').value, // Salva o telefone FORMATADO
            whatsapp_url: whatsappUrl, // Link WhatsApp atualizado
            cpf: cpfRaw,
            matricula: matriculaRaw,
            
            role: role, 
            unidade: unit 
        });
        alert("Usuário registrado! (Lembre-se de criar o login no Firebase Authentication)"); 
        
        // Limpar os campos após o cadastro
        document.getElementById('new-user-email').value = '';
        document.getElementById('new-user-guerra').value = '';
        document.getElementById('new-user-completo').value = '';
        document.getElementById('new-user-cpf').value = '';
        document.getElementById('new-user-matricula').value = '';
        document.getElementById('new-user-telefone').value = '';
        document.getElementById('new-user-posto').value = ''; // Limpa o select
        document.getElementById('new-user-quadro').value = ''; // Limpa o select
        
        listarUsuarios();
    } catch(e) { 
        alert("Erro ao salvar usuário: " + e.message);
    }
}

        async function listarUsuarios() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
    
    // --- NOVO: FILTRO DE UNIDADE PARA O GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    
    let userQuery = db.collection('usuarios'); // Coleção correta
    
    if (isGestor) {
        // Se for Gestor, filtre a query para buscar usuários APENAS na sua unidade
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }
    // ---------------------------------------------

    try {
        // Executa a query (filtrada ou total)
        const snap = await userQuery.get();
        
        // 1. POPULA A VARIÁVEL GLOBAL allUsersData
        allUsersData = [];
        snap.forEach(doc => {
            // Salva o ID do documento junto com os dados para uso no modal e filtro
            allUsersData.push({ id: doc.id, ...doc.data() }); 
        });
        
        // 2. VERIFICA SE HÁ DADOS
        if (allUsersData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Nenhum militar encontrado nesta unidade.</td></tr>';
            return;
        }

        // 3. INICIA A RENDERIZAÇÃO/FILTRAGEM
        // Chama a função de filtragem (que faz a renderização real)
        filtrarUsuarios();
        
    } catch(e) {
        console.error("Erro ao listar usuários:", e);
        tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar lista de usuários.</td></tr>';
    }
}
        function filtrarUsuarios() {
    const searchInput = document.getElementById('user-search-input');
    const searchTerm = searchInput.value.trim().toUpperCase();
    const tbody = document.getElementById('users-table-body');
    
    tbody.innerHTML = '';
    
    const filteredUsers = allUsersData.filter(u => {
        // Filtra pelo Nome de Exibição completo
        const nomeExibicao = u.nome_militar_completo || '';
        return nomeExibicao.includes(searchTerm);
    });

    if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Nenhum usuário encontrado com o nome digitado.</td></tr>';
        return;
    }

    filteredUsers.forEach(u => {
        const docId = u.id; 
        const tr = document.createElement('tr');
        
        // Verifica se é o usuário logado (para desabilitar o botão de edição)
        const isCurrentUser = firebase.auth().currentUser.uid === docId; 
        
        const telefone = u.telefone_contato || 'N/D';
        const whatsappUrl = u.whatsapp_url || '#';
        const rawTelefone = telefone.replace(/\D/g, '');
        const numeroSemDDD = (rawTelefone.length === 11) ? rawTelefone.substring(2) : rawTelefone; 

        // Constrói os links de ação (WhatsApp e Discagem)
        const whatsappLink = `<a href="${whatsappUrl}" target="_blank" style="margin-left: 5px; color: #25D366;"><i class="fab fa-whatsapp"></i></a>`;
        const dialLink = (rawTelefone.length >= 8) ? 
            `<a href="tel:${numeroSemDDD}" class="btn-dial-mobile" style="margin-left: 5px; color: #2c7399;"><i class="fas fa-phone"></i></a>` : '';
        
        // Renderização da linha
        tr.innerHTML = `
            <td data-label="Militar:">${u.nome_militar_completo}</td>
            <td data-label="Contato:">
                <div style="display: flex; align-items: center; justify-content: center;">
                    <span>${telefone}</span>
                    ${whatsappLink}
                    ${dialLink} 
                </div>
            </td>
            <td data-label="Perfil:"><span class="role-badge role-${u.role}">${u.role}</span></td>
            <td data-label="Unidade:">${u.unidade}</td>
            <td data-label="Ações:"><button class="btn-modern-action btn-edit" style="padding:4px 8px; font-size:0.8em;" onclick="abrirGestaoUsuario('${docId}')" ${isCurrentUser ? 'disabled' : ''}>Editar</button></td>`;
        tbody.appendChild(tr);
    });
}
    
// Aprox. Linha 936
async function abrirGestaoUsuario(docId) {
    try {
        const doc = await db.collection('usuarios').doc(docId).get();
        if (!doc.exists) return alert("Usuário não encontrado.");
        
        const u = doc.data();
        const permissoes = u.permissoes || {};
        
        // Preenche o campo de unidades
        await carregarUnidadesSelect('edit-user-unit');
        
        document.getElementById('edit-user-doc-id').value = docId;
        document.getElementById('edit-user-guerra').value = u.nome_guerra || '';
        document.getElementById('edit-user-posto').value = u.posto || ''; // Preenche o Posto
        document.getElementById('edit-user-completo').value = u.nome_completo || ''; 
        document.getElementById('edit-user-email').value = u.email || 'N/D';
        document.getElementById('edit-user-role').value = u.role || 'operacional';
        document.getElementById('edit-user-unit').value = u.unidade || '';

        // Campos de Identificação Pessoal
        document.getElementById('edit-user-cpf').value = u.cpf || '';
        document.getElementById('edit-user-matricula').value = u.matricula || '';
        document.getElementById('edit-user-telefone').value = u.telefone_contato || '';
        
        // Campo Quadro é tratado abaixo, mas guarda o valor para pré-seleção
        const quadroSalvo = u.quadro || ''; 

        // CAMPO NOME DE EXIBIÇÃO (SINTÉTICO - SOMENTE LEITURA)
        document.getElementById('edit-user-display-name').value = u.nome_militar_completo || 'N/D';

        // --- INTEGRAÇÃO DA LÓGICA DE SELEÇÃO (NOVO BLOCO) ---
        
        // 1. Anexa o Listener de Mudança ao Posto/Graduação
        const postoSelect = document.getElementById('edit-user-posto');
        postoSelect.onchange = atualizarQuadroModal; // Chama a função de dependência

        // 2. Dispara a lógica uma vez para carregar as opções de Quadro
        // Isso preencherá o #edit-user-quadro com as opções corretas para o posto salvo.
        atualizarQuadroModal();

        // 3. Pré-seleciona o Quadro salvo (só funciona após a chamada acima)
        document.getElementById('edit-user-quadro').value = quadroSalvo;

        // --- LÓGICA DE PERMISSÕES (Mantida) ---
        const roleSelect = document.getElementById('edit-user-role');
        const permFields = document.getElementById('user-permissions-fields');
        
        permFields.style.display = (u.role === 'gestor' || u.role === 'admin') ? 'block' : 'none';
        
        document.getElementById('perm-view-cards').checked = permissoes.canViewDashboardCards || false;
        document.getElementById('perm-view-history').checked = permissoes.canViewUnitHistory || false;
        document.getElementById('perm-manage-posts').checked = permissoes.canManagePosts || false;
        document.getElementById('perm-manage-users').checked = permissoes.canManageUnitUsers || false;
        document.getElementById('perm-manage-lists').checked = permissoes.canManageUnitLists || false;

        roleSelect.onchange = function() {
            permFields.style.display = (this.value === 'gestor' || this.value === 'admin') ? 'block' : 'none';
        };

        document.getElementById('modal-user-manager').style.display = 'flex';
    } catch(e) {
        console.error(e);
        alert("Erro ao abrir edição: " + e.message);
    }
}
        
        // Aprox. Linha 948
async function salvarAlteracoesUsuario() {
    const docId = document.getElementById('edit-user-doc-id').value;
    const guerra = document.getElementById('edit-user-guerra').value.trim();
    const posto = document.getElementById('edit-user-posto').value.trim();
    const quadro = document.getElementById('edit-user-quadro').value.trim(); // Lendo do novo SELECT editável
    const completo = document.getElementById('edit-user-completo').value.trim(); 
    const role = document.getElementById('edit-user-role').value;
    const unit = document.getElementById('edit-user-unit').value;
    
    // CAMPOS DE IDENTIFICAÇÃO AGORA EDITÁVEIS
    const cpf = document.getElementById('edit-user-cpf').value.trim();
    const matricula = document.getElementById('edit-user-matricula').value.trim();
    const telefone = document.getElementById('edit-user-telefone').value.trim();

    if (!guerra || !posto || !quadro || !unit || !completo) return alert("Preencha Nome de Guerra, Posto, Quadro, Unidade e Nome Civil Completo.");
    if (posto === "" || quadro === "") return alert("Selecione o Posto/Graduação e o Quadro.");

    // --- RECALCULAÇÃO DA VARIÁVEL SINTÉTICA (NOME DE EXIBIÇÃO) ---
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    
    // --- LÓGICA DE SALVAMENTO DE PERMISSÕES (Mantida) ---
    const novasPermissoes = {
        canViewDashboardCards: document.getElementById('perm-view-cards').checked,
        canViewUnitHistory: document.getElementById('perm-view-history').checked,
        canManagePosts: document.getElementById('perm-manage-posts').checked,
        canManageUnitUsers: document.getElementById('perm-manage-users').checked,
        canManageUnitLists: document.getElementById('perm-manage-lists').checked,
    };
    
    // O objeto de atualização
    const updateData = {
        nome_guerra: guerra,
        posto: posto,
        quadro: quadro,                         
        nome_militar_completo: nomeMilitarCompleto, 
        nome_completo: completo,             
        
        cpf: cpf,
        matricula: matricula,
        telefone_contato: telefone,
        whatsapp_url: `https://web.whatsapp.com/send?phone=55${telefone.replace(/\D/g, '')}`,
        
        role: role,
        unidade: unit,
        permissoes: novasPermissoes,
    };
    
    try {
        await db.collection('usuarios').doc(docId).update(updateData);
        alert("Dados do militar atualizados com sucesso!");
        document.getElementById('modal-user-manager').style.display = 'none';
        listarUsuarios();
    } catch(e) {
        alert("Erro ao salvar alterações: " + e.message);
    }
}
        async function carregarUsuariosFiltro() {
    const select = document.getElementById('glob-hist-user');
    if (!select) return;

    select.innerHTML = '<option value="">Todos</option>';
    
    // Filtro de segurança: Gestor só vê usuários da própria unidade. Admin vê todos.
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;

    let userQuery = db.collection('usuarios');
    
    if (isGestor) {
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }

    try {
        const snap = await userQuery.get();
        let users = [];
        snap.forEach(doc => {
            const u = doc.data();
            // Usamos o nome completo, pois é o que está salvo nos resultados (linha 1082)
            if (u.nome_militar_completo) {
                users.push(u.nome_militar_completo);
            }
        });

        users.sort().forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

    } catch (e) {
        console.error("Erro ao carregar filtro de usuários:", e);
    }
}
        async function excluirUsuario() {
            const docId = document.getElementById('edit-user-doc-id').value;
            const guerra = document.getElementById('edit-user-guerra').value;

            if(!confirm(`Tem certeza que deseja EXCLUIR o militar ${guerra}? O login associado (Auth) DEVE ser removido manualmente.`)) return;
            
            try {
                await db.collection('usuarios').doc(docId).delete();
                alert(`Militar ${guerra} excluído com sucesso do Firestore!`);
                document.getElementById('modal-user-manager').style.display = 'none';
                listarUsuarios();
            } catch(e) {
                alert("Erro ao excluir: " + e.message);
            }
        }

        async function carregarPostosEditor() {
             const sel = document.getElementById('novo-local-posto');
             if(!sel) return;
             
             try {
                const doc = await db.collection('config_geral').doc('postos').get();
                const lista = doc.exists ? doc.data().lista : [];
                let h = ''; 
                lista.forEach(p => h+=`<option value="${p}">${p}</option>`); 
                sel.innerHTML = h;
             } catch(e){}
        }

        async function criarNovoLocal() {
            const posto = document.getElementById('novo-local-posto').value;
            const nome = document.getElementById('novo-local-nome').value.trim().toUpperCase();
            const unidade = document.getElementById('novo-local-unidade').value;
            if(!posto || !nome || !unidade) return alert("Preencha Posto, Nome e Unidade.");
            
            // Constrói o ID único e o nome completo
            const id = `${posto.toLowerCase()}_${nome.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            const localCompleto = `${posto} - ${nome}`; // Nome que aparecerá no Card/Relatório
            
            try {
                // 1. Salva a lista (Viaturas)
                await db.collection(COLECAO_LISTAS).doc(id).set({ nome_local: nome, posto: posto, list: [], unidade: unidade, updatedAt: firebase.firestore.Timestamp.now() });

                // 2. Salva a rota
                await db.collection('config_geral').doc('rotas').set({ [id]: { nome: nome, posto: posto, unidade: unidade, ativo: true } }, { merge: true });

                // --- NOVO: Cria o registro inicial para o Dashboard ---
                // Este registro garante que o Card de Pendências apareça imediatamente com status OK.
                await db.collection(COLECAO_RESULTADOS).add({
                    local: localCompleto,
                    lista_id: id,
                    conferente: "Sistema (Inicialização)",
                    unidade: unidade,
                    posto: posto,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    // Dados para garantir que o card seja renderizado com 0 pendências
                    itensRelatorio: [], 
                    itensCaa: [],
                    totalCaa: 0,
                    totalItensConferidos: 0,
                    statusAdmin: 'OK'
                });
                // ----------------------------------------------------

                alert("Lista Criada e Card Inicializado!"); 
                carregarListaLocaisAdmin();
                // Chama loadCaaData() para atualizar o Dashboard com o novo Card
                loadCaaData(); 
                
            } catch(e) { 
                alert("Erro ao criar lista: " + e.message); 
            }
        }
        
        async function excluirLocalAdmin(listaId, listaNome) {
    if (!confirm(`TEM CERTEZA? Excluir a lista: ${listaNome} (ID: ${listaId})?`)) {
        return;
    }

    try {
        // --- 1. REMOVER REGISTROS DE PENDÊNCIA (CARDS) ---
        const resultadosSnap = await db.collection(COLECAO_RESULTADOS)
            .where('lista_id', '==', listaId)
            .get();

        const batch = db.batch();
        resultadosSnap.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
        // ----------------------------------------------------

        // 2. Remova o item da coleção principal de listas (o conteúdo em si)
        await db.collection(COLECAO_LISTAS).doc(listaId).delete();

        // 3. Remova a referência da rota na configuração geral, inativando-a
        const rotasRef = db.collection('config_geral').doc('rotas');
        const rotasSnap = await rotasRef.get();
        const rotasData = rotasSnap.data();

        if (rotasData && rotasData[listaId]) {
            // Marca como inativo em vez de deletar para manter o histórico de dados antigos
            rotasData[listaId].ativo = false;
            await rotasRef.set(rotasData); 
        }

        alert(`Lista "${listaNome}" excluída/inativada e Cards de Pendência removidos com sucesso!`);
        
        carregarListaLocaisAdmin();
        loadCaaData(); // Atualiza o Dashboard
    } catch (e) {
        console.error("Erro ao excluir lista:", e);
        alert("Erro ao excluir lista: " + e.message);
    }
}
        
        async function carregarListaLocaisAdmin() {
    const ul = document.getElementById('lista-locais-container');
    const doc = await db.collection('config_geral').doc('rotas').get();
    const rotas = doc.data();
    ul.innerHTML = '';
    
    // --- FILTRO DE SEGURANÇA PARA GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // ----------------------------------------
    
    // Objeto para mapear o ID da lista para o nome do local
    const listaNomes = {};

    // Mapeia as rotas e carrega os nomes
    Object.entries(rotas).forEach(([id, info]) => {
        if(info.ativo === false) return;

        // CONDIÇÃO DE FILTRAGEM: Se for gestor, só mostra se a unidade da rota for igual à unidade do gestor.
        if (isGestor && info.unidade !== unidadeGestor) {
            return;
        }
        
        listaNomes[id] = info.nome;
        
        const li = document.createElement('li');
        li.className = 'local-item';
        
        const safeName = info.nome.replace(/'/g, "\\'");
        const safeId = id.replace(/'/g, "\\'");
        // NOVO: Passando o nome da unidade para uso no abrirEditor
        const safeUnit = info.unidade.replace(/'/g, "\\'") || 'Geral'; 
        
        // --- CHAMADA CORRIGIDA: INCLUINDO A UNIDADE NO ABRIR EDITOR ---
        li.innerHTML = `
            <div class="local-info">
                <strong>${info.nome}</strong>
                <span>${info.posto} | Unidade: ${info.unidade||'Geral'}</span>
            </div>
            <div style="display:flex; gap: 10px;">
                <button class="btn-modern-action btn-edit" onclick="abrirEditor('${safeId}', '${safeName}', '${safeUnit}')">
                    Editar
                </button>
                <button class="btn-modern-action btn-delete" onclick="excluirLocalAdmin('${safeId}', '${safeName}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        ul.appendChild(li);
    });
}
        
        function renderizarLista() { 
            const container = document.getElementById('lista-setores-container');
            container.innerHTML = '';
            dadosConferencia.forEach(setor => {
            const setorLi = document.createElement('li'); 
            setorLi.className = 'setor-item'; 
            setorLi.setAttribute('data-id', setor.id);
            const addItemFormHtml = `<div class="add-item-form-setor">
            <input type="text" id="input-item-nome-${setor.id}" placeholder="Item" class="filter-input" style="flex-grow:1;">
            <input type="number" id="input-item-qtd-${setor.id}" value="1" class="filter-input" style="width:50px; flex-grow:0;">
            <select id="select-item-tipo-${setor.id}" class="filter-input" style="flex-grow:1;">
            <option value="single">Único</option>
            <option value="multi">Tombamento</option>
            </select>
            <button class="btn-add" onclick="adicionarItemPorSetor('${setor.id}')">+</button>
            </div>`;
                let itensHtml = '';
                setor.itens.forEach(item => {
                    let tombamentosHtml = '';
                    if (item.tipo === 'multi' && item.tombamentos) {
                        const tombamentosList = item.tombamentos.map(tomb => `<li><div style="display:flex; align-items:center; width:100%;"><span style="margin-right:10px; font-size:0.85em; font-weight:bold; color:#555;">TB:</span><input type="text" value="${tomb.tomb}" onblur="editarTombamento('${item.id}', '${tomb.tomb}', this)" style="padding:4px; font-size:0.85em; border:1px solid #ddd; border-radius:4px;"></div><button class="btn-remover" onclick="removerTombamento('${item.id}', '${tomb.tomb}')" style="padding:2px 8px; margin-left:10px;"><i class="fas fa-trash" style="font-size:0.8em;"></i></button></li>`).join('');
                        tombamentosHtml = `<div class="tombamento-container-wrapper"><div class="tombamento-section"><h4>Tombamentos (${item.tombamentos.length})</h4><ul class="tombamento-list">${tombamentosList}</ul><div class="add-tombamento-form"><input type="text" id="tomb-input-${item.id}" placeholder="Novo Tombamento"><button class="btn-add" onclick="adicionarTombamento('${item.id}', document.getElementById('tomb-input-${item.id}'))"><i class="fas fa-plus"></i></button></div></div></div>`;
                    }
                    itensHtml += `<li class="item-conferencia-admin"><div style="width:100%"><div style="display:flex;justify-content:space-between;"><div><strong>${item.nome}</strong><small> Qtd: ${item.quantidadeEsperada}</small></div><div class="item-actions-admin"><button class="btn-edit-alt" onclick="abrirModalEdicao('${setor.id}','${item.id}')"><i class="fas fa-edit"></i></button><button class="btn-remover" onclick="removerItem('${setor.id}','${item.id}')"><i class="fas fa-trash"></i></button></div></div>${item.tipo === 'multi' ? tombamentosHtml : ''}</div></li>`;
                });
                
                // ... (código dentro do loop forEach) ...
                setorLi.innerHTML = `
    <div class="setor-content-header-sticky" onclick="this.nextElementSibling.classList.toggle('collapsed')">
        <div class="setor-header-admin">
            <span>${setor.nome}</span>
            <button class="btn-remover" onclick="event.stopPropagation();removerSetor('${setor.id}')">X</button>
        </div>
        ${addItemFormHtml}
    </div>
    <div class="setor-content-admin">
        <ul class="lista-setores item-list-admin" data-setor-id="${setor.id}">${itensHtml}</ul>
    </div>
`;
                container.appendChild(setorLi);
            });
            // Inicialização do Sortable para SETORES (na variável 'container')
            new Sortable(container, { 
                animation: 150, 
                handle: '.setor-header-admin', 
                onEnd: () => { 
                    updateOrdens(); // <-- NOVO: Atualiza a ordem dos setores e itens no array global
                    salvarDados(false); 
                } 
            });
            document.querySelectorAll('.item-list-admin').forEach(el => { 
                new Sortable(el, { 
                    group: 'items', 
                    animation: 150, 
                    // === OPÇÕES DE AUTOSCROLL AQUI ===
        
                    scroll: true,             // 1. Ativa a rolagem automática
                    scrollSensitivity: 80,    // 2. Distância (em pixels) da borda para acionar o scroll
                    scrollSpeed: 20,          // 3. Velocidade da rolagem (quanto maior, mais rápido)
                    bubbleScroll: true,
                    // Define o elemento que deve rolar. 
                    // No seu caso, o elemento pai de `el` é o .setor-content-admin
                
                    onEnd: () => { 
                        updateOrdens(); 
                        salvarDados(false); 
                    } 
                }); 
            });
        }
        /**
 * ====================================
 * FUNÇÕES DE GESTÃO DE CAUTELAS
 * INSERIR ESTE BLOCO ANTES DE 'window.addEventListener('popstate'...'
 * ====================================
 */

/**
 * Função que retorna o HTML do formulário de Nova Cautela (Passo 1/2).
 */
function getNovaCautelaFormHTML() {
    return `
        <div class="op-card" id="form-nova-cautela">
            <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3><i class="fas fa-file-contract"></i> Nova Cautela (Passo 1/2)</h3>
                <button class="btn-modern-action" onclick="showMainMenu()">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        
            <div class="form-grid-2-columns">
                <div class="form-group">
                    <label for="cautela-destinatario">Destinatário da Cautela (Quem irá receber):</label>
                    <input type="text" id="cautela-destinatario" list="lista-usuarios" placeholder="Digite o nome ou matrícula do usuário" required>
                    <datalist id="lista-usuarios"></datalist>
                </div>
                
                <div class="form-group">
                    <label for="cautela-local-origem">Local de Origem (Sua Custódia):</label>
                    <select id="cautela-local-origem" required onchange="loadCustodiaItens()">
                        <option value="" disabled selected>Selecione um local...</option>
                    </select>
                </div>
            </div>
        
            <h4 style="margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #800020;">
                <i class="fas fa-clipboard-list"></i> Seleção de Materiais
            </h4>
            
            <div id="itens-custodia-list">
                <p class="placeholder-message" style="text-align: center; color: #999;">
                    Por favor, selecione um Local de Origem para listar os itens sob sua custódia.
                </p>
            </div>
        
            <div class="form-group" style="margin-top: 20px;">
                <label for="cautela-obs">Observações da Cautela (Opcional):</label>
                <textarea id="cautela-obs" rows="3" placeholder="Adicione detalhes, instruções ou a razão da cautela."></textarea>
            </div>
            
            <button class="btn-create btn-form-action" onclick="iniciarCautelaProcesso()" id="btn-iniciar-cautela" disabled>
                <i class="fas fa-paper-plane"></i> Enviar Cautela (0 itens)
            </button>
        </div>
    `;
}

/**
 * Carrega o formulário de Nova Cautela, escondendo o menu de botões.
 * Chamado pelo botão "Nova Cautela".
 */
function loadNewCautelaForm() {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');

    if (menuContainer) {
        menuContainer.style.display = 'none';
    }

    if (contentArea) {
        contentArea.innerHTML = getNovaCautelaFormHTML();
        contentArea.style.display = 'block'; 
        
        // CORREÇÃO DE UI: Adicionar um pequeno atraso para garantir que o DOM esteja pronto 
        // e o campo de observações seja habilitado, caso alguma regra de estilo o tenha desativado.
        setTimeout(() => {
            const obsField = document.getElementById('cautela-obs');
            if (obsField) {
                 // Força remoção de qualquer bloqueio de leitura
                obsField.removeAttribute('readonly'); 
                obsField.removeAttribute('disabled');
            }
        }, 50);

        loadCustodiaLocais(); 
        loadUsersForSearch();
    }
}

/**
 * Volta para o Menu Principal de Cautelas (os 4 botões).
 * Chamado pelo botão "Voltar ao Menu" no formulário e no dashboard.
 */
function showMainMenu() {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');

    // 1. Limpa e esconde a área de conteúdo (formulário ou dashboard)
    if (contentArea) {
        contentArea.innerHTML = '';
        contentArea.style.display = 'none';
    }

    // 2. Exibe o menu de 4 botões novamente (usando grid para layout responsivo)
    if (menuContainer) {
        menuContainer.style.display = 'grid'; 
    }
}

/**
 * Exibe as telas de Cautelas Ativas, Receber, ou Histórico (Temporário).
 * Chamado pelos outros 3 botões do menu.
 */
function showCautelasDashboard(type) {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');
    if (menuContainer) menuContainer.style.display = 'none';

    if (contentArea) {
        let htmlContent = '';

        if (type === 'Cautelas Ativas') {
            htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-clipboard-check"></i> Cautelas Ativas </h3>
                        <button class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Lista de materiais sob sua cautela. Clique em uma linha para ver os detalhes.
                    </p>

                    <div id="loading-cautelas" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando cautelas...
                    </div>

                    <table class="ca-table" id="cautelas-ativas-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Destinatário</th>
                                <th>Emissão</th>
                                <th>Local Origem</th>
                                <th>Itens</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="cautelas-ativas-body">
                            </tbody>
                    </table>
                </div>
            `;
            
            // Chamar a função de carregamento logo após injetar o HTML
            setTimeout(() => loadActiveCautelas(), 50);
            } else if (type === 'Cautelas a Receber') {
            // NOVO BLOCO: Cautelas a Receber
            htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-inbox"></i> Cautelas a Receber </h3>
                        <button class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Cautelas emitidas por terceiros que precisam ser confirmadas por você.
                    </p>

                    <div id="loading-receive" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando cautelas...
                    </div>

                    <table class="ca-table" id="cautelas-receive-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Emitente</th>
                                <th>Emissão</th>
                                <th>Local Origem</th>
                                <th>Itens</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="cautelas-receive-body">
                        </tbody>
                    </table>
                </div>
            `;
            // Chamar a nova função de carregamento logo após injetar o HTML
            setTimeout(() => loadCautionsToReceive(), 50); // CHAMA A NOVA FUNÇÃO
            } else if (type === 'Histórico') {
                // 🛑 NOVO: Mostra a view Histórico e carrega os dados
               htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-archive"></i> Histórico de Cautelas</h3>
                        <button class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Visualize as cautelas finalizadas de acordo com o seu papel na transação.
                    </p>

                    <div class="tab-navigation" style="display: flex; gap: 5px; margin-bottom: 15px;">
                        <button class="tab-button active" data-tab="minhas" onclick="loadHistorico('minhas')">
                            <i class="fas fa-user-tag"></i> Minhas (Dest. Original)
                        </button>
                        <button class="tab-button" data-tab="devolucao" onclick="loadHistorico('devolucao')">
                            <i class="fas fa-undo"></i> Recebidas (Devolução)
                        </button>
                        <button class="tab-button" data-tab="emitidas" onclick="loadHistorico('emitidas')">
                            <i class="fas fa-paper-plane"></i> Emitidas por Mim
                        </button>
                    </div>
                    <div id="historico-content-container">
                        <div id="loading-historico" style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando histórico...
                        </div>
                        
                        <div id="content-minhas" class="historico-tab-content active-tab"></div>
                        <div id="content-devolucao" class="historico-tab-content"></div>
                        <div id="content-emitidas" class="historico-tab-content"></div>
                    </div>
                    
                </div>
            `;
            // Chamar a função de carregamento principal (que dispara a aba 'minhas' por padrão)
            setTimeout(() => loadHistorico('minhas'), 50);
            } else {
                // ⬅️ Adicione este bloco para erros/valores inesperados
                console.warn("View de Cautelas desconhecida:", view);
            }
        
            contentArea.innerHTML = htmlContent;
            contentArea.style.display = 'block';
        }
    }
            window.addEventListener('popstate', function (event) {
            // 1. Reinsere o estado no histórico para neutralizar a navegação de "Voltar"
                history.pushState(null, null, location.href);

                // 2. Verifica se o usuário realmente quer sair
                if (confirm('Atenção! Você está prestes a sair do sistema. Deseja realmente sair?')) {
                    // Limpa o listener popstate para que a saída seja limpa
                    window.removeEventListener('popstate', arguments.callee);
                
                    // Redireciona para o logout
                    logout(); 
                }
            });
    async function loadUsersForSearch() {
    const datalist = document.getElementById('lista-usuarios');
    if (!datalist) return;

    // --- Lógica de Filtro de Unidade para o Gestor (mantida) ---
    const isGestor = currentUserData.role === 'gestor'; 
    const unidadeGestor = currentUserData.unidade; 

    let userQuery = db.collection('usuarios'); 
    if (isGestor) {
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }
    // ------------------------------------------------------------------
    
    try {
        const usersSnapshot = await userQuery.get(); 
        
        let optionsHtml = '';
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            // O nome_militar_completo é o padrão que deve ser exibido.
            const nomeCompleto = user.nome_militar_completo; 

            if (nomeCompleto) {
                // Apenas uma única opção é criada. O datalist só irá filtrar e exibir esta string.
                // Ao digitar 'NORO' ou 'SD QPCBM NOR', o navegador filtrará e exibirá APENAS 'SD QPCBM NORONHA'.
                optionsHtml += `<option data-uid="${doc.id}" value="${nomeCompleto}"></option>`;
            }
        });
        datalist.innerHTML = optionsHtml;
    } catch (error) {
        console.error("Erro ao carregar usuários para a pesquisa:", error);
    }
}

/**
 * Busca os locais onde o usuário logado foi o último conferente
 * e preenche o <select> de Local de Origem.
 */
async function loadCustodiaLocais() {
    const selectLocal = document.getElementById('cautela-local-origem');
    
    // **CORREÇÃO APLICADA:** Usamos a variável 'conferente' encontrada no seu código.
    const currentUserId = conferente; 

    if (!selectLocal || !currentUserId) {
        console.warn("UID do usuário (conferente) não encontrado ou seletor de local ausente.");
        // Opcional: Desabilita o campo e mostra uma mensagem de erro
        selectLocal.innerHTML = '<option value="" disabled selected>Erro: Usuário não identificado.</option>';
        return;
    }
    
    selectLocal.disabled = true;
    selectLocal.innerHTML = '<option value="" disabled selected>Carregando locais...</option>';


    try {
        // Busca no campo 'conferente' da coleção 'resultados_conferencias'
        // Ordenamos pela data para garantir que a custódia seja a mais recente (mesmo que só precisemos do local)
        const resultsSnapshot = await db.collection('resultados_conferencias')
            .where('conferente', '==', currentUserId) 
            .orderBy('timestamp', 'desc')
            .get();

        const locaisDeCustodia = new Set();
        
        // Coleta apenas os locais únicos onde o usuário conferiu por último.
        resultsSnapshot.forEach(doc => {
            locaisDeCustodia.add(doc.data().local);
        });

        // Monta as opções do SELECT.
        let optionsHtml = '<option value="" disabled selected>Selecione um local...</option>';
        if (locaisDeCustodia.size === 0) {
            optionsHtml = '<option value="" disabled selected>Nenhum local sob sua custódia.</option>';
        } else {
            locaisDeCustodia.forEach(local => {
                optionsHtml += `<option value="${local}">${local}</option>`;
            });
        }
        

        selectLocal.innerHTML = optionsHtml;
        selectLocal.disabled = false; 
    } catch (error) {
        console.error("Erro ao carregar locais sob custódia:", error);
        selectLocal.disabled = false;
        selectLocal.innerHTML = '<option value="" disabled selected>Erro ao carregar locais.</option>';
    }
}
     async function loadCustodiaItens() {
    const selectLocal = document.getElementById('cautela-local-origem');
    const localNomeCompleto = selectLocal.value; // Ex: ALFA - PERMANÊNCIA
    const itemListContainer = document.getElementById('itens-custodia-list');
    const btnIniciar = document.getElementById('btn-iniciar-cautela');

    itemListContainer.innerHTML = '<p class="placeholder-message" style="text-align: center; color: #800020;">Buscando materiais...</p>';
    btnIniciar.disabled = true;

    if (!localNomeCompleto) return;

    try {
        // 1. Encontrar o LISTA_ID único a partir do NOME COMPLETO do local
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        
        let listaId = null;
        for (const [id, info] of Object.entries(rotas)) {
            // Reconstroi o nome completo do local para a comparação
            const nomeCompletoRota = `${info.posto} - ${info.nome}`;
            if (nomeCompletoRota === localNomeCompleto) {
                listaId = id;
                break;
            }
        }
        
        if (!listaId) {
            itemListContainer.innerHTML = '<p class="placeholder-message" style="color:red;">Erro: ID da Lista não encontrado para este Local.</p>';
            return;
        }

        // 2. Buscar a lista mestra (a estrutura completa de setores/itens)
        const listaDoc = await db.collection('listas_conferencia').doc(listaId).get();
        if (!listaDoc.exists) {
            itemListContainer.innerHTML = '<p class="placeholder-message" style="color:red;">Lista Mestra de Materiais não encontrada.</p>';
            return;
        }
        const listaMestra = listaDoc.data().list || [];

        // 3. Renderizar o HTML para seleção (Checkboxes e Campos de QTD)
        let htmlContent = '';
        let totalItensDisponiveis = 0;

        listaMestra.forEach(setor => {
            if (setor.itens && setor.itens.length > 0) {
                htmlContent += `<h4 style="margin-top: 15px; font-size: 1em; color: #2c7399;">${setor.nome}</h4>`;
                htmlContent += `<ul style="list-style: none; padding: 0;">`;

                setor.itens.forEach(item => {
                    const itemIdBase = item.id;

                    if (item.tipo === 'single') {
                        // === ITENS ÚNICOS (COM CAMPO DE QUANTIDADE) ===
                        if (item.quantidadeEsperada > 0) {
                             const maxQtd = item.quantidadeEsperada;
                             htmlContent += `
                                <li style="padding: 5px 0; border-bottom: 1px dotted #eee; display: flex; align-items: center; justify-content: space-between;">
                                    <label style="flex-grow: 1;">
                                        <input type="checkbox" name="cautela-item-base" data-id="${itemIdBase}" 
                                               data-nome="${item.nome}" data-tipo="single" 
                                               data-max-qtd="${maxQtd}">
                                        ${item.nome} 
                                        <span style="font-size: 0.85em; color: #555;">(Disponível: ${maxQtd})</span>
                                    </label>
                                    
                                    <input type="number" 
                                           class="input-qtd-cautela"
                                           data-item-id="${itemIdBase}"
                                           min="1" 
                                           max="${maxQtd}" 
                                           value="${maxQtd}"
                                           disabled 
                                           style="width: 50px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                                </li>`;
                            totalItensDisponiveis++;
                        }
                    } else if (item.tipo === 'multi' && item.tombamentos && item.tombamentos.length > 0) {
                        // === ITENS COM TOMBAMENTO (1 CHECKBOX = 1 UNIDADE) ===
                        item.tombamentos.forEach(tomb => {
                            const itemIdTombado = `${itemIdBase}-${tomb.tomb}`;
                            htmlContent += `
                                <li style="padding: 5px 0 5px 15px; border-bottom: 1px dotted #eee; background-color:#f9f9f9;">
                                    <label>
                                        <input type="checkbox" name="cautela-item-multi" data-id="${itemIdTombado}" 
                                               data-nome="${item.nome} (Tomb: ${tomb.tomb})" data-tipo="multi" 
                                               data-qtd="1">
                                        ${item.nome} (Tombamento: ${tomb.tomb})
                                    </label>
                                </li>`;
                            totalItensDisponiveis++;
                        });
                    }
                });
                htmlContent += `</ul>`;
            }
        });

        if (totalItensDisponiveis === 0) {
             itemListContainer.innerHTML = '<p class="placeholder-message" style="color:green;">✅ Nenhum material disponível para cautela neste local.</p>';
        } else {
             itemListContainer.innerHTML = htmlContent;
             
             // 4. Adicionar Listeners de Interatividade
             // Liga o checkbox ao campo de quantidade para itens 'single'
             document.querySelectorAll('input[name="cautela-item-base"]').forEach(chk => {
                 chk.addEventListener('change', () => toggleItemQuantity(chk));
             });
             
             // Liga o input de quantidade e os checkboxes 'multi' para a contagem no botão
             document.querySelectorAll('.input-qtd-cautela, input[name="cautela-item-base"], input[name="cautela-item-multi"]').forEach(el => {
                 if (el.type === 'number') {
                     el.addEventListener('input', updateCautelaItemCount);
                     el.addEventListener('change', updateCautelaItemCount);
                 } else {
                     el.addEventListener('change', updateCautelaItemCount);
                 }
             });

             updateCautelaItemCount(); // Inicializa a contagem
        }

    } catch (error) {
        console.error("Erro ao carregar itens de custódia:", error);
        itemListContainer.innerHTML = '<p class="placeholder-message" style="color:red;">Erro ao carregar lista de materiais.</p>';
    }
}


/**
 * Atualiza o texto do botão de iniciar cautela com a contagem de itens selecionados.
 */
function updateCautelaItemCount() {
    let selectedCount = 0;
    
    // 1. Contagem de itens com Tombamento (tipo 'multi')
    selectedCount += document.querySelectorAll('input[name="cautela-item"]:checked').length;
    
    // 2. Contagem de itens Únicos (tipo 'single') - SOMANDO A QUANTIDADE NO INPUT
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        const li = chk.closest('li');
        const inputQtd = li.querySelector('.input-qtd-cautela');
        
        let qtd = 0;
        if (inputQtd && !inputQtd.disabled) {
            qtd = parseInt(inputQtd.value) || 0;
            const max = parseInt(inputQtd.getAttribute('max')) || 0;
            
            // Validação simples de quantidade
            if (qtd > max) {
                alert(`A quantidade máxima disponível é ${max}.`);
                inputQtd.value = max;
                qtd = max;
            }
            if (qtd < 1) {
                // Se a quantidade for inválida, desmarca o checkbox
                chk.checked = false;
                inputQtd.disabled = true;
                qtd = 0;
                // Re-executa a contagem para refletir a desmarcação
                return updateCautelaItemCount();
            }
        }
        selectedCount += qtd;
    });

    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    
    btnIniciar.textContent = `▶️ Enviar Cautela (${selectedCount} itens)`;
    
    // Habilita o botão se a contagem for maior que zero
    btnIniciar.disabled = (selectedCount <= 0);
}
        function toggleItemQuantity(checkbox) {
    const li = checkbox.closest('li');
    const inputQtd = li.querySelector('.input-qtd-cautela');

    if (inputQtd) {
        inputQtd.disabled = !checkbox.checked;
        if (checkbox.checked && inputQtd.value < 1) {
            inputQtd.value = 1; 
        }
        // Se desmarcado, remove o valor para evitar contagem (opcional)
        if (!checkbox.checked) {
             inputQtd.value = inputQtd.getAttribute('max'); // Reseta para o máximo para evitar confusão.
        }
    }
    updateCautelaItemCount();
}
        async function getListaIdFromLocalName(localNomeCompleto) {
    // Busca o documento 'rotas' onde está o mapeamento dos nomes de local para os IDs.
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    for (const [id, info] of Object.entries(rotas)) {
        // Recria o nome completo para comparação (Ex: "ALFA - PERMANÊNCIA")
        const nomeCompletoRota = `${info.posto} - ${info.nome}`;
        if (nomeCompletoRota === localNomeCompleto) {
            return id;
        }
    }
    return null; // Retorna null se não encontrar o mapeamento
}


/**
 * Coleta todos os dados dos itens selecionados (incluindo as quantidades dos inputs number).
 */
function getSelectedCautelaItemsData() {
    const itens = [];
    
    // 1. Coleta itens com Tombamento (tipo 'multi')
    // Usa o nome 'cautela-item-multi' definido no renderizador
    document.querySelectorAll('input[name="cautela-item-multi"]:checked').forEach(chk => {
        itens.push({
            id_completo: chk.getAttribute('data-id'), // Ex: 1000-01 (ID_base-Tomb)
            id_base: chk.getAttribute('data-id').split('-')[0], // Ex: 1000
            tombamento: chk.getAttribute('data-id').split('-')[1], // Ex: 01
            nome: chk.getAttribute('data-nome'),
            quantidade: 1, // Sempre 1 para tombamento
            tipo: 'multi',
        });
    });

    // 2. Coleta itens Únicos (tipo 'single')
    // Usa o nome 'cautela-item-base' definido no renderizador
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        const li = chk.closest('li');
        const inputQtd = li.querySelector('.input-qtd-cautela');
        
        let qtd = parseInt(inputQtd.value) || 0;
        
        // Verifica se a quantidade é válida (o 'updateCautelaItemCount' já faz a validação visual, mas a final é aqui)
        if (qtd > 0 && qtd <= parseInt(chk.getAttribute('data-max-qtd'))) {
            itens.push({
                id_completo: chk.getAttribute('data-id'), // ID base é o ID completo para itens únicos
                id_base: chk.getAttribute('data-id'),
                nome: chk.getAttribute('data-nome'),
                quantidade: qtd,
                tipo: 'single',
            });
        }
    });

    return itens;
}
        async function iniciarCautelaProcesso() {
    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    btnIniciar.disabled = true;
    btnIniciar.textContent = 'Processando Transação...';

    const destinatarioInput = document.getElementById('cautela-destinatario').value.trim();
    const localOrigem = document.getElementById('cautela-local-origem').value;
    const obsRaw = document.getElementById('cautela-obs').value.trim();
    const itensParaCautela = getSelectedCautelaItemsData();
    const listaId = await getListaIdFromLocalName(localOrigem);

    if (!destinatarioInput || itensParaCautela.length === 0 || !listaId) {
        alert('Falha na validação dos dados. Verifique o destinatário e a seleção de itens.');
        updateCautelaItemCount(); 
        return;
    }

    try {
        await db.runTransaction(async (transaction) => {
            
            // 1. FASE DE LEITURA (TODOS OS `transaction.get()` PRIMEIRO)
            const configRef = db.collection('config_geral').doc('contadores');
            const listaMestraRef = db.collection('listas_conferencia').doc(listaId);
            
            const configDoc = await transaction.get(configRef);
            const listaMestraDoc = await transaction.get(listaMestraRef);
            
            if (!configDoc.exists) throw new Error("Documento de contadores não encontrado! Configure 'contadores' em config_geral.");
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra de Conferência não encontrada!");
            
            // 2. FASE DE PROCESSAMENTO (LÓGICA NA MEMÓRIA)
            let novoContador = (configDoc.data().cautela_seq || 0) + 1;
            const cautelaIdSequencial = `CAUTELA-${String(novoContador).padStart(6, '0')}`;
            
            let listaMestra = listaMestraDoc.data().list;
            let totalItensMovimentados = 0;
            const dataEmissao = new Date().toISOString().split('T')[0];
            
            itensParaCautela.forEach(cItem => {
                listaMestra = listaMestra.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(mItem => {
                        if (mItem.id === cItem.id_base) {
                            // Subtração de Estoque e Carimbo
                            if (cItem.tipo === 'single') {
                                mItem.quantidadeEsperada -= cItem.quantidade;
                                mItem.cautelas = mItem.cautelas || [];
                                mItem.cautelas.push({
                                    id: cautelaIdSequencial,
                                    destinatario: destinatarioInput,
                                    quantidade: cItem.quantidade,
                                    data: dataEmissao
                                });
                                totalItensMovimentados += cItem.quantidade;

                            } else if (cItem.tipo === 'multi' && mItem.tombamentos) {
                                // Item com Tombamento: Marca o tombamento específico
                                mItem.tombamentos = mItem.tombamentos.map(tomb => {
                                    if (tomb.tomb === cItem.tombamento) {
                                        tomb.cautela = {
                                            id: cautelaIdSequencial,
                                            destinatario: destinatarioInput,
                                            data: dataEmissao
                                        };
                                    }
                                    return tomb;
                                });
                                totalItensMovimentados += 1;
                            }
                        }
                        return mItem;
                    })
                }));
            });
            
            // Dados da Cautela Ativa (Documento a ser criado)
            const cautelaData = {
                cautela_id: cautelaIdSequencial,
                emitente: currentUserData.nome_militar_completo,
                destinatario: destinatarioInput,
                
                // 🛑 ADIÇÃO CRÍTICA PARA RASTREABILIDADE (PONTO 2) 🛑
                // Salva o destinatário inicial permanentemente, nunca será alterado.
                destinatario_original: destinatarioInput,
                
                local_origem: localOrigem,
                local_origem_id: listaId,
                observacoes_emissao: obsRaw, // Adicionado observação
                timestamp_emissao: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'ABERTA', 
                itens: itensParaCautela,
            };

            // 3. FASE DE ESCRITA (TODOS OS `transaction.set()`/`update()` AQUI!)
            transaction.update(configRef, { cautela_seq: novoContador });
            transaction.set(db.collection('cautelas_abertas').doc(cautelaIdSequencial), cautelaData);
            transaction.update(listaMestraRef, { list: listaMestra });

            // 4. Conclusão e Feedback (DENTRO DA TRANSAÇÃO, SEM MANIPULAÇÃO DO DOM)
            alert(`✅ Cautela ${cautelaIdSequencial} emitida com sucesso! Total de ${totalItensMovimentados} itens movimentados para ${destinatarioInput}.`);
            
        }); // Fim da Transação

        // A transação foi bem-sucedida. Agora atualiza a UI.
        showMainMenu(); 
        
    } catch (error) {
        // CORREÇÃO: O alerta de erro final
        console.error("Erro CRÍTICO no processo de Cautela:", error);
        alert(`Erro ao emitir cautela. Nenhum dado foi alterado. Erro: ${error.message}`);
        updateCautelaItemCount();
    }
}
        /**
 * Busca e exibe as cautelas ativas.
 * Exibe todas as cautelas da unidade para Gestores/Admin,
 * e apenas as emitidas para/pelo usuário logado para Operacionais.
 */
// Localização: Função loadActiveCautelas (aprox. linha 1132)

async function loadActiveCautelas() {
    const tbody = document.getElementById('cautelas-ativas-body');
    const loading = document.getElementById('loading-cautelas');
    const table = document.getElementById('cautelas-ativas-table');
    const role = currentUserData.role || 'operacional';
    const militarCompleto = currentUserData.nome_militar_completo;
    const unidade = currentUserData.unidade;

    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        let cautelas = []; // Declarada UMA ÚNICA VEZ

        // --- FILTRAGEM DE ACESSO BASEADA NO PERFIL (ROLE) ---
       if (role === 'operacional') {
    // OPERACIONAL: Vê RECEBIDAS (sob sua posse) E em DEVOLUÇÃO (enviadas por ele e em trânsito)
    
    // Query 1: RECEBIDAS (Filtra pelo destinatario)
    const snapRecebida = await db.collection('cautelas_abertas')
        .where('destinatario', '==', militarCompleto)
        .where('status', '==', 'RECEBIDA')
        .orderBy('timestamp_emissao', 'desc')
        .get();
        
    // Query 2: DEVOLUÇÃO (Filtra pelo reversor, que é o usuário logado agora)
    // 🛑 CORREÇÃO CRÍTICA: O filtro muda de 'destinatario' para 'militar_completo_reversor' 🛑
    const snapDevolucao = await db.collection('cautelas_abertas')
        .where('militar_completo_reversor', '==', militarCompleto)
        .where('status', '==', 'DEVOLUÇÃO')
        .orderBy('timestamp_emissao', 'desc')
        .get();
                
            // Combina e popula o array, ordenando localmente
            cautelas = [...snapRecebida.docs.map(doc => doc.data()), ...snapDevolucao.docs.map(doc => doc.data())];
            
            cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

        } else if (role === 'gestor') {
            // GESTOR: Vê ABERTAS e RECEBIDAS de sua Unidade (usa função auxiliar)
            cautelas = await getCautelasForGestor(unidade);
            
        } else { // ADMIN: Vê todas ABERTAS e RECEBIDAS
            cautelas = await getCautelasForAdmin();
        }

        if (cautelas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:20px;">Nenhuma cautela ativa encontrada sob sua responsabilidade.</td></tr>`;
            loading.style.display = 'none';
            table.style.display = 'table';
            return;
        }

        // --- RENDERIZAÇÃO DA TABELA ---
        cautelas.forEach(cautela => {
            const tr = tbody.insertRow();
            tr.onclick = () => showCautelaDetails(cautela.cautela_id);
            
            const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
            
            const dataEmissao = cautela.timestamp_emissao && typeof cautela.timestamp_emissao.toDate === 'function' 
                                ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR') 
                                : 'N/A';
            
            // 🛑 CORREÇÃO DO N/D 🛑
            const status = cautela.status || 'N/A';
            let badgeClass = 'badge-cautela';
            let badgeText = 'N/D'; 

            if (status === 'RECEBIDA') {
                 badgeClass = 'badge-solucao'; 
                 badgeText = 'RECEBIDA';
            } else if (status === 'ABERTA') {
                 badgeClass = 'badge-cautela';
                 badgeText = 'ABERTA';
            } else if (status === 'DEVOLUÇÃO') {
                 // Adiciona a lógica para o novo status
                 badgeClass = 'badge-pendente'; 
                 badgeText = 'EM DEVOLUÇÃO';
            }
            
            tr.innerHTML = `
                <td data-label="ID:"><strong>${cautela.cautela_id}</strong></td>
                <td data-label="Destinatário:">${cautela.destinatario}</td>
                <td data-label="Emissão:">${dataEmissao}</td>
                <td data-label="Local Origem:">${cautela.local_origem}</td>
                <td data-label="Itens:">${itensCount} itens</td>
                <td data-label="Status:"><span class="status-badge ${badgeClass}">${badgeText}</span></td>
            `;
        });

        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas ativas:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
        async function loadCautionsToReceive() {
    const tbody = document.getElementById('cautelas-receive-body');
    const loading = document.getElementById('loading-receive');
    const table = document.getElementById('cautelas-receive-table');
    const militarCompleto = currentUserData.nome_militar_completo;

    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        // --- 1. Consulta ABERTA (Fluxo normal) ---
        const queryAbertaRef = db.collection('cautelas_abertas')
            .where('status', '==', 'ABERTA')
            .where('destinatario', '==', militarCompleto)
            .orderBy('timestamp_emissao', 'desc');

        const snapAberta = await queryAbertaRef.get();
        const cautelasAberta = snapAberta.docs.map(doc => doc.data());
        
        // --- 2. Consulta DEVOLUÇÃO (Novo fluxo) ---
        const queryDevolucaoRef = db.collection('cautelas_abertas')
            .where('status', '==', 'DEVOLUÇÃO')
            .where('destinatario', '==', militarCompleto) // O destinatário agora é o Dono Provisório
            .orderBy('timestamp_devolucao_iniciada', 'desc'); // Ordena pela data de início da devolução

        const snapDevolucao = await queryDevolucaoRef.get();
        const cautelasDevolucao = snapDevolucao.docs.map(doc => doc.data());

        // --- 3. Combina e Ordena as Cautelas ---
        // Combina as listas
        let cautelas = [...cautelasAberta, ...cautelasDevolucao];

        // Ordena a lista combinada para ter as mais recentes no topo (preferindo a data de emissão/devolução)
        cautelas.sort((a, b) => {
            const timeA = (a.timestamp_emissao || a.timestamp_devolucao_iniciada)?.toMillis() || 0;
            const timeB = (b.timestamp_emissao || b.timestamp_devolucao_iniciada)?.toMillis() || 0;
            return timeB - timeA;
        });


        if (cautelas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#1b8a3e; padding:20px;">✅ Nenhuma cautela pendente de recebimento.</td></tr>`;
            loading.style.display = 'none';
            table.style.display = 'table';
            return;
        }

        // --- 4. RENDERIZAÇÃO DA TABELA ---
        cautelas.forEach(cautela => {
            const tr = tbody.insertRow();
            tr.onclick = () => showCautelaDetails(cautela.cautela_id);
            
            const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
            
            // Define a data correta para exibição
            let dataAcao = cautela.timestamp_emissao;
            let statusBadge = 'ABERTA';
            let badgeClass = 'badge-cautela';
            
            if (cautela.status === 'DEVOLUÇÃO') {
                dataAcao = cautela.timestamp_devolucao_iniciada || cautela.timestamp_emissao;
                statusBadge = 'DEVOLUÇÃO';
                badgeClass = 'badge-pendente'; // Use uma classe diferente, por exemplo, cor laranja/amarela
            }
            
            const dataExibicao = dataAcao.toDate().toLocaleDateString('pt-BR');

            tr.innerHTML = `
                <td data-label="ID:"><strong>${cautela.cautela_id}</strong></td>
                <td data-label="Emitente:">${cautela.emitente}</td>
                <td data-label="Emissão:">${dataExibicao}</td>
                <td data-label="Local Origem:">${cautela.local_origem}</td>
                
                <td data-label="Itens:">${itensCount} itens</td>
                <td data-label="Status:"><span class="status-badge ${badgeClass}">${statusBadge}</span></td>
            `;
        });
        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas a receber:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
        async function showCautelaDetails(cautelaId) {
    const modal = document.getElementById('cautelaDetailsModal');
    const btnReceber = document.getElementById('btn-receber-cautela'); // Para status ABERTA
    const btnDevolver = document.getElementById('btn-devolver-cautela'); // Para status RECEBIDA
    const btnConfirmarDevolucao = document.getElementById('btn-confirmar-devolucao'); // NOVO: Para status DEVOLUÇÃO
    
    // 1. Resetar modal e exibir
    document.getElementById('modal-cautela-id').textContent = cautelaId;
    document.getElementById('modal-status').textContent = 'Carregando...';
    modal.style.display = 'flex';
    btnReceber.style.display = 'none'; // Esconde o botão normal de recebimento
    if (btnDevolver) btnDevolver.style.display = 'none'; // Esconde o botão de devolução
    if (btnConfirmarDevolucao) btnConfirmarDevolucao.style.display = 'none'; // Esconde o novo botão

    // Limpar conteúdos anteriores (Adicionado limpeza para os novos campos de rastreabilidade)
    if (document.getElementById('modal-destinatario-original')) document.getElementById('modal-destinatario-original').textContent = '';
    if (document.getElementById('modal-destinatario-atual')) document.getElementById('modal-destinatario-atual').textContent = '';
    if (document.getElementById('modal-ultimo-detentor')) document.getElementById('modal-ultimo-detentor').textContent = '';

    // Campos existentes
    document.getElementById('modal-emitente').textContent = '';
    document.getElementById('modal-local-origem').textContent = '';
    document.getElementById('modal-data-emissao').textContent = '';
    document.getElementById('modal-obs-emissao').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    document.getElementById('modal-itens-cautela').innerHTML = '<li style="text-align:center;">Carregando itens...</li>';

    try {
        // 2. Buscar dados da cautela no Firestore
        const docRef = db.collection('cautelas_abertas').doc(cautelaId);
        const doc = await docRef.get();
        
        if (!doc.exists) {
            alert(`Erro: Cautela ID ${cautelaId} não encontrada.`);
            modal.style.display = 'none';
            return;
        }

        const cautela = doc.data();
        const dataEmissao = cautela.timestamp_emissao ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR') : 'N/D';

        // 3. Preencher Detalhes Principais - COM RASTREABILIDADE
        
        // 🛑 LÓGICA DE RASTREABILIDADE (PONTO 2) 🛑
        
        // A. Emitente (Origem da cautela - USUARIO A)
        document.getElementById('modal-emitente').textContent = cautela.emitente || 'N/D';
        
        // B. Destinatário Original (Quem recebeu a cautela inicialmente - USUARIO B)
        // Este campo DEVE ser criado na função de emissão e NUNCA mais alterado.
        const destinatarioOriginal = cautela.destinatario_original || 'Necessita Campo "original"';
        if (document.getElementById('modal-destinatario-original')) {
             document.getElementById('modal-destinatario-original').textContent = destinatarioOriginal;
        }
        
        // C. Destinatário Atual (Quem tem a posse/responsabilidade AGORA - USUARIO B ou Dono Provisório USUARIO C)
        if (document.getElementById('modal-destinatario-atual')) {
             document.getElementById('modal-destinatario-atual').textContent = cautela.destinatario || 'N/D';
        }
        
        // D. Último Detentor (Quem enviou a devolução - USUARIO B, usando o campo militar_completo_reversor)
        // Só faz sentido se o status for DEVOLUÇÃO.
        let ultimoDetentor = 'N/A';
        if (cautela.status === 'DEVOLUÇÃO') {
             ultimoDetentor = cautela.militar_completo_reversor || 'Não registrado';
        } else if (cautela.status === 'RECEBIDA' || cautela.status === 'ABERTA') {
             // Se não está em devolução, o último detentor é o próprio destinatário.
             ultimoDetentor = cautela.destinatario;
        }
        if (document.getElementById('modal-ultimo-detentor')) {
             document.getElementById('modal-ultimo-detentor').textContent = ultimoDetentor;
        }


        // Informações de Borda (mantido)
        document.getElementById('modal-local-origem').textContent = cautela.local_origem || 'N/D';
        document.getElementById('modal-data-emissao').textContent = dataEmissao;
        document.getElementById('modal-obs-emissao').textContent = cautela.observacoes_emissao || 'Nenhuma observação no momento da emissão.';
        
        // FIM DA LÓGICA DE RASTREABILIDADE
        
        // 4. Preencher a Lista de Itens (mantido o seu código)
        const itensList = document.getElementById('modal-itens-cautela');
        itensList.innerHTML = '';
        
        if (cautela.itens && cautela.itens.length > 0) {
            
            let itemCount = 1;
            cautela.itens.forEach(item => {
                const li = document.createElement('li');
                
                const nomeItem = item.nome || 'Item sem nome';
                const quantidadeOuTombamento = item.tombamento 
                    ? `(Tombamento: <strong>${item.tombamento}</strong>)` 
                    : `(Quantidade: <strong>${item.quantidade}</strong>)`;
                
                li.innerHTML = `
                    <span style="font-weight: 500;">${itemCount++}. ${nomeItem}</span> <span style="font-size: 0.9em; color: #555;">${quantidadeOuTombamento}</span>
                `;
                
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                
                if (itemCount % 2 === 0) {
                    li.style.backgroundColor = '#e0e0e0'; 
                }

                itensList.appendChild(li);
            });
        } else {
            itensList.innerHTML = '<li style="text-align:center; color:red;">Nenhum item encontrado nesta cautela.</li>';
        }

        // 5. Lógica de Ação dos Botões (mantida)
        const militarCompleto = currentUserData.nome_militar_completo;
        const modalStatusElement = document.getElementById('modal-status');
        
        
        // A. Cautelas ABERTAS (A RECEBER - Fluxo Normal)
        if (currentUserData.role === 'operacional' && cautela.destinatario === militarCompleto && cautela.status === 'ABERTA') {
            btnReceber.style.display = 'block';
            btnReceber.onclick = () => iniciarRecebimentoCautela(cautelaId); 
            modalStatusElement.textContent = `Status: ${cautela.status}`;
            
        // B. Cautelas EM DEVOLUÇÃO (A RECEBER - Novo Fluxo Dono Provisório)
        } else if (currentUserData.role === 'operacional' && cautela.destinatario === militarCompleto && cautela.status === 'DEVOLUÇÃO') {
            if (btnConfirmarDevolucao) {
                btnConfirmarDevolucao.style.display = 'block';
                btnConfirmarDevolucao.textContent = 'Confirmar Recebimento da Devolução';
                
                // NOVO ONCLICK: Inicia a conferência para o Dono Provisório (logado)
                btnConfirmarDevolucao.onclick = () => iniciarConferenciaDevolucao(cautelaId, cautela.destinatario);
            }
            // Exibir o status de DEVOLUÇÃO
            modalStatusElement.innerHTML = `Status: <span style="color:#d39e00; font-weight:bold;">DEVOLUÇÃO</span><br>Aguardando sua conferência.`;
            
        // C. Cautelas RECEBIDAS (A DEVOLVER - Fluxo Usuário A)
        } else if (currentUserData.role === 'operacional' && cautela.destinatario === militarCompleto && cautela.status === 'RECEBIDA') {
            // Busca o destinatário da devolução (Último Conferente).
            const ultimoConferente = await getLastConferente(cautela.local_origem);
            
            if (btnDevolver) {
                btnDevolver.style.display = 'block';
                btnDevolver.textContent = 'INICIAR DEVOLUÇÃO';
                
                // Adiciona a informação de quem vai receber de volta no modal
                modalStatusElement.innerHTML = `Status: ${cautela.status}<br><span style="font-size:0.8em; color:#0d47a1;">Devolução p/: <strong>${ultimoConferente}</strong></span>`;

                // Configura o onclick para iniciar a transação de devolução (no Dashboard)
                btnDevolver.onclick = () => iniciarDevolucaoCautela(cautelaId, ultimoConferente); 
            }
        
        // D. Cautelas EM DEVOLUÇÃO (QUEM ENVIOU - Usuário A que ainda rastreia)
        } else if (currentUserData.role === 'operacional' && cautela.militar_completo_reversor === militarCompleto && cautela.status === 'DEVOLUÇÃO') {
             // Este bloco é para o Usuário A ver a cautela que ele enviou, mas não pode clicar
             // No modal, mostra para quem foi enviada.
             modalStatusElement.innerHTML = `Status: <span style="color:#d39e00; font-weight:bold;">EM TRÂNSITO</span><br><span style="font-size:0.8em; color:#0d47a1;">Aguardando recebimento por: <strong>${cautela.destinatario}</strong></span>`;

        // E. LÓGICA PADRÃO (Outros Status / Não é o destinatário)
        } else {
            btnReceber.style.display = 'none';
            if (btnDevolver) btnDevolver.style.display = 'none';
            if (btnConfirmarDevolucao) btnConfirmarDevolucao.style.display = 'none';
            
            modalStatusElement.textContent = `Status: ${cautela.status}`;
        }
        
    // 🛑 CHAVE DE FECHAMENTO DO TRY 🛑
    } catch (e) {
        console.error("Erro ao carregar detalhes da cautela:", e);
        // Garante que os campos de rastreabilidade sejam limpos se houver erro
        if (document.getElementById('modal-destinatario-original')) document.getElementById('modal-destinatario-original').textContent = 'ERRO';
        if (document.getElementById('modal-destinatario-atual')) document.getElementById('modal-destinatario-atual').textContent = 'ERRO';
        if (document.getElementById('modal-ultimo-detentor')) document.getElementById('modal-ultimo-detentor').textContent = 'ERRO';
        
        document.getElementById('modal-obs-emissao').textContent = 'Erro ao buscar observações.';
        document.getElementById('modal-itens-cautela').innerHTML = `<li style="text-align:center; color:red;">Erro ao buscar dados: ${e.message}</li>`;
        document.getElementById('modal-status').textContent = `Status: ERRO`;
    }
    // 🛑 CHAVE DE FECHAMENTO DA FUNÇÃO 🛑
}

function iniciarRecebimentoCautela(cautelaId) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. Constrói a URL para a cautela. (Usa 'cautelaId')
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}`;

    // 4. 🛑 LÓGICA DE ABERTURA DO IFRAME (REPLICADA DA CONFERÊNCIA NORMAL) 🛑
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CRÍTICO: Componentes de execução (app-runner-container ou app-iframe) não encontrados.");
        alert("Erro ao iniciar a conferência. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a área principal do dashboard (content-area) e a sidebar para dar foco total ao app
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}
        function iniciarConferenciaDevolucao(cautelaId, destinatario) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    // 🛑 CORREÇÃO AQUI: Alterando de 'posto_graduacao' para 'posto' (ou similar)
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. Constrói a URL CRÍTICA com o modo de devolução final
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}&modo=devolucao_final&destinatarioDevolucao=${encodeURIComponent(destinatario)}`;

    // 4. LÓGICA DE ABERTURA DO IFRAME (INLINE)
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CRÍTICO: Componentes de execução (app-runner-container ou app-iframe) não encontrados.");
        alert("Erro ao iniciar a conferência. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a área principal do dashboard (content-area) e a sidebar
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar'); 
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}

// Localização: Linha ~1594
function handleIframeMessage(event) {
    // Garante que a mensagem veio do seu domínio (Importante por segurança)
    if (event.origin !== window.location.origin) return;

    if (event.data && event.data.type === 'SIGMA_FINISHED') {
        alert('✅ Operação finalizada com sucesso. Voltando ao Dashboard.');

        // 1. Oculta o container do Iframe
        const container = document.getElementById('app-runner-container');
        if (container) {
            container.style.display = 'none';
            // Limpa a URL do iframe para liberar recursos
            document.getElementById('app-iframe').src = 'about:blank';
        }
        
        // 2. Mostra a área principal do dashboard e a sidebar
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.style.display = 'block';
        }
        const sidebar = document.getElementById('sidebar') || document.getElementById('main-sidebar');
        if (sidebar) {
            sidebar.style.display = 'block';
        }
        
        // 3. Recarrega a lista mais relevante (Cautelas a Receber e Ativas)
        // Isso garante que o item CONCLUÍDA suma da lista A RECEBER/ATIVAS.
        
        // 🛑 CORREÇÃO DE REFERÊNCIA 🛑
        // A função correta é loadActiveCautelas (com 't' e 'l').
        loadCautionsToReceive(); // Atualiza a lista A RECEBER (item sumiu)
        loadActiveCautelas();    // Atualiza a lista ATIVAS (item sumiu/mudou)
        
        // Força a atualização dos cards (contadores) e da lista "Conferências de Hoje"
        if (typeof updateOperacionalCards === 'function') {
            updateOperacionalCards();
        }
        
        // Volta para a view de Cautelas Ativas após o sucesso, se o usuário não estava no Dashboard.
        // Isto é mais seguro do que tentar recarregar a aba 'Histórico' que estava ativa.
        switchView('cautelas'); 
        showCautelasDashboard('Cautelas Ativas'); 
    }
}        /**
 * Busca cautelas com status ABERTA e RECEBIDA para Gestores (filtradas por Unidade).
 * @param {string} unidade - A unidade do Gestor.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForGestor(unidade) {
    // Consulta 1: ABERTAS na Unidade
    const queryAberta = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'ABERTA');

    // Consulta 2: RECEBIDAS na Unidade
    const queryRecebida = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}

/**
 * Busca todas as cautelas com status ABERTA e RECEBIDA para Admin.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForAdmin() {
    // Consulta 1: Todas ABERTAS
    const queryAberta = db.collection('cautelas_abertas')
        .where('status', '==', 'ABERTA');

    // Consulta 2: Todas RECEBIDAS
    const queryRecebida = db.collection('cautelas_abertas')
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}
        /**
 * Carrega o histórico de cautelas (aquelas com status CONCLUÍDA)
 * com filtro por perfil (Operacional/Gestor/Admin).
 */
async function loadCautelasHistorico() {
    const tbody = document.getElementById('cautelas-historico-body');
    const loading = document.getElementById('loading-historico');
    const table = document.getElementById('cautelas-historico-table');
    const role = currentUserData.role || 'operacional';
    const militarCompleto = currentUserData.nome_militar_completo;
    const unidade = currentUserData.unidade;

    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        let queryRef;
        
        // --- FILTRAGEM POR ACESSO (STATUS: CONCLUÍDA) ---
        if (role === 'operacional') {
            // Operacional: Apenas aquelas que ele foi o destinatário
            queryRef = db.collection('cautelas_abertas')
                .where('destinatario', '==', militarCompleto)
                .where('status', '==', 'CONCLUÍDA')
                .orderBy('timestamp_conclusao', 'desc'); 
            
        } else if (role === 'gestor') {
            // Gestor: Apenas aquelas de sua Unidade
            queryRef = db.collection('cautelas_abertas')
                .where('unidade_destino', '==', unidade)
                .where('status', '==', 'CONCLUÍDA')
                .orderBy('timestamp_conclusao', 'desc');
            
        } else { // Admin: Vê todas
            queryRef = db.collection('cautelas_abertas')
                .where('status', '==', 'CONCLUÍDA')
                .orderBy('timestamp_conclusao', 'desc');
        }

        const snap = await queryRef.get();
        const cautelas = snap.docs.map(doc => doc.data());

        if (cautelas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:20px;">Nenhuma cautela concluída encontrada.</td></tr>`;
            loading.style.display = 'none';
            table.style.display = 'table';
            return;
        }

        // --- RENDERIZAÇÃO DA TABELA ---
        cautelas.forEach(cautela => {
            const tr = tbody.insertRow();
            // Implementação futura: tr.onclick = () => showCautelaDetails(cautela.cautela_id);
            
            const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
            
            const dataEmissao = cautela.timestamp_emissao && typeof cautela.timestamp_emissao.toDate === 'function' 
                                ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR') 
                                : 'N/A';
            
            const dataConclusao = cautela.timestamp_conclusao && typeof cautela.timestamp_conclusao.toDate === 'function' 
                                ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') 
                                : 'N/A';

            tr.innerHTML = `
                <td><strong>${cautela.cautela_id}</strong></td>
                <td>${cautela.destinatario}</td>
                <td>${dataEmissao}</td>
                <td>${dataConclusao}</td>
                <td>${itensCount} itens</td>
                <td><span class="status-badge badge-sucesso">CONCLUÍDA</span></td>
            `;
        });

        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar histórico de cautelas:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
        async function getLastConferente(localOrigem) {
            if (!localOrigem) return "N/D";
    
    try {
        // Busca o resultado de conferência mais recente para o local de origem.
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('local', '==', localOrigem)
            .orderBy('timestamp', 'desc')
            .limit(1)
            .get();
            
        if (!snap.empty) {
            const lastResult = snap.docs[0].data();
            // Retorna o nome completo do conferente encontrado.
            return lastResult.conferente || "N/D";
        }
        
        return "N/D (Nenhum histórico recente)";
    } catch (e) {
        console.error("Erro ao buscar último conferente:", e);
        return "N/D (Erro de consulta)";
    }
}
            async function iniciarDevolucaoCautela(cautelaId, destinatario) {
    const btnDevolver = document.getElementById('btn-devolver-cautela');
    
    // 1. Oculta o modal e o botão de devolução imediatamente para evitar cliques duplos.
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    if (btnDevolver) btnDevolver.disabled = true;

    try {
        const militarCompleto = currentUserData.nome_militar_completo;
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaId);

        // 🛑 CRÍTICO: Executa a Transação no Firebase para mudar o status
        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);

            if (!cautelaDoc.exists || cautelaDoc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela não encontrada ou não está no status 'RECEBIDA'.");
            }
            
            // 1. Ação: Mudar o status da cautela para DEVOLUÇÃO.
            transaction.update(cautelaRef, { 
                status: 'DEVOLUÇÃO', // Novo status de trânsito
                timestamp_devolucao_iniciada: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem está enviando/revertendo (Usuário A)
                reversor: currentUserData.nome_guerra, 
                militar_completo_reversor: militarCompleto,
                
                // Quem é o novo destinatário/receptor da devolução (Dono Provisório)
                destinatario: destinatario // 🛑 ATUALIZA o campo DESTINATARIO para ser o Dono Provisório
            });
        }); // Fim da Transação

        // 2. Feedback para o Usuário A e atualização da UI
        alert(`✅ Cautela enviada para devolução a ${destinatario}. Ela aparecerá na lista 'Cautelas a Receber' dele.`);
        
        // Recarrega a lista de Cautelas Ativas para remover o item que acabou de ser devolvido.
        showCautelasDashboard('Cautelas Ativas'); 
        
    } catch (error) {
        console.error("Erro CRÍTICO ao iniciar devolução:", error);
        alert(`Erro ao iniciar devolução. Nenhum dado foi alterado. Erro: ${error.message}`);
        if (btnDevolver) btnDevolver.disabled = false;
    }
}
        /**
 * Alterna a aba do Histórico e dispara o carregamento da função correspondente.
 */
function loadHistorico(tabName) {
    // 1. Atualiza a UI das abas
    document.querySelectorAll('.tab-navigation .tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === tabName) {
            btn.classList.add('active');
        }
    });

    // 2. Oculta e mostra o conteúdo
    document.querySelectorAll('.historico-tab-content').forEach(content => {
        content.classList.remove('active-tab');
        content.style.display = 'none';
    });
    const targetContent = document.getElementById(`content-${tabName}`);
    if (targetContent) {
        targetContent.style.display = 'block';
        targetContent.classList.add('active-tab');
    }
    
    // 3. Dispara a função de carregamento de dados
    if (tabName === 'minhas') {
        loadHistoricoMinhas();
    } else if (tabName === 'devolucao') {
        loadHistoricoDevolucao();
    } else if (tabName === 'emitidas') {
        loadHistoricoEmitidas();
    }
}
        // Função auxiliar para renderizar a tabela, minimizando a repetição
function renderHistoricoTable(containerId, cautelas) {
    const container = document.getElementById(containerId);
    const loading = document.getElementById('loading-historico');

    if (!container) return; 

    // Oculta loading e garante que o container esteja visível
    if (loading) loading.style.display = 'none';

    if (cautelas.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px;">Nenhuma cautela encontrada neste histórico.</p>';
        return;
    }

    // Cria a estrutura da tabela
    let html = `
        <table class="ca-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Dest. Original</th>
                    <th>Emitente</th>
                    <th>Data Final</th>
                    <th>Itens</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
    `;

    cautelas.forEach(cautela => {
        const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
        const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        
        // Define o destinatário original de forma segura (para esta aba)
        const destOriginal = cautela.destinatario_original || 'N/A';
        const badgeText = 'CONCLUÍDA';
        const badgeClass = 'badge-solucao';

        html += `
            <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                <td><strong>${cautela.cautela_id}</strong></td>
                <td>${destOriginal}</td>
                <td>${cautela.emitente}</td>
                <td>${dataFinal}</td>
                <td>${itensCount} itens</td>
                <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

// -------------------------------------------------------------
// FUNÇÕES ESPECÍFICAS DE CARREGAMENTO POR ABA
// -------------------------------------------------------------

/**
 * Aba 1: MINHAS (Destinatário Original)
 * Filtro: destinatario_original == militarCompleto E status == CONCLUÍDA
 */
async function loadHistoricoMinhas() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('destinatario_original', '==', militarCompleto)
            .where('status', '==', 'CONCLUÍDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-minhas', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-minhas').innerHTML = `<p style="color:red;">Erro ao carregar histórico: ${e.message}</p>`;
    }
}

/**
 * Aba 2: DEVOLUÇÃO (Recebidas de volta, como Dono Provisório)
 * Filtro: receptor_final_completo == militarCompleto E status == CONCLUÍDA
 */
async function loadHistoricoDevolucao() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('receptor_final_completo', '==', militarCompleto) // Campo que registra o Dono Provisório
            .where('status', '==', 'CONCLUÍDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-devolucao', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-devolucao').innerHTML = `<p style="color:red;">Erro ao carregar histórico: ${e.message}</p>`;
    }
}

/**
 * Aba 3: EMITIDAS POR MIM
 * Filtro: emitente == militarCompleto E status == CONCLUÍDA
 */
async function loadHistoricoEmitidas() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('emitente', '==', militarCompleto)
            .where('status', '==', 'CONCLUÍDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-emitidas', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-emitidas').innerHTML = `<p style="color:red;">Erro ao carregar histórico: ${e.message}</p>`;
    }
}
        function atualizarQuadroModal() {
    const postoSelect = document.getElementById('edit-user-posto');
    const quadroSelect = document.getElementById('edit-user-quadro');
    const posto = postoSelect.value;
    
    // Limpa o select do quadro e desabilita
    quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    quadroSelect.disabled = true;

    // Se o posto for vazio (ou a opção "Selecione"), sai
    if (!posto) return;

    // Mapeamento dos postos para a categoria (Oficiais, Praças, SD)
    let quadros = [];
    const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1º TEN', '2º TEN'];
    const pracas = ['ST', '1º SGT', '2º SGT', '3º SGT', 'CB'];

    if (oficiais.includes(posto)) {
        quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
    } else if (pracas.includes(posto)) {
        quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
    } else if (posto === 'SD') {
        // SD tem um quadro fixo e não permite alteração
        quadros = ['QPCBM'];
        quadroSelect.disabled = true;
    }

    if (quadros.length > 0) {
        quadroSelect.disabled = (posto === 'SD'); // Desabilita apenas se for SD
        
        // Preenche as opções do quadro
        quadros.forEach(quadro => {
            const option = document.createElement('option');
            option.value = quadro;
            option.textContent = quadro;
            quadroSelect.appendChild(option);
        });
        
        // Tenta pré-selecionar a primeira opção se houver apenas uma (caso do SD)
        if(quadros.length === 1) {
            quadroSelect.value = quadros[0];
        }
    }
}
        function formatarCPF(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
    value = value.substring(0, 11); // Limita a 11 dígitos

    if (value.length > 9) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
    } else if (value.length > 3) {
        value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{3})$/, '$1');
    }
    input.value = value;
}

function formatarMatricula(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
    value = value.substring(0, 10); // Limita a 10 dígitos

    if (value.length > 7) {
        value = value.replace(/^(\d{7})(\d{3})$/, '$1-$2');
    }
    input.value = value;
}

function formatarTelefone(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
    value = value.substring(0, 11); // Limita a 11 dígitos (DDD + 9 dígitos)

    if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
    } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{2})$/, '($1)');
    }
    input.value = value;
}
        function setupCadastroMilitarLogic() {
    // 1. Máscaras
    const cpfInput = document.getElementById('new-user-cpf');
    const matriculaInput = document.getElementById('new-user-matricula');
    const telefoneInput = document.getElementById('new-user-telefone');

    if (cpfInput) cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
    if (matriculaInput) matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
    if (telefoneInput) telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));

    // 2. Lógica de Dependência Posto/Quadro (Adaptada da função atualizarQuadroModal)
    const postoSelect = document.getElementById('new-user-posto');
    const quadroSelect = document.getElementById('new-user-quadro');

    if (postoSelect && quadroSelect) {
        postoSelect.addEventListener('change', () => {
            // Replicar a lógica de atualização do Quadro (Posto->Quadro)
            atualizarQuadroCad(postoSelect, quadroSelect);
        });
    }
}

/**
 * Lógica de dependência Posto/Quadro ADAPTADA para o novo formulário Cadastrar Militar.
 */
function atualizarQuadroCad(postoSelect, quadroSelect) {
    const posto = postoSelect.value;
    
    quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    quadroSelect.disabled = true;

    if (!posto) return;

    let quadros = [];
    const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1º TEN', '2º TEN'];
    const pracas = ['ST', '1º SGT', '2º SGT', '3º SGT', 'CB'];

    if (oficiais.includes(posto)) {
        quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
    } else if (pracas.includes(posto)) {
        quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
    } else if (posto === 'SD') {
        quadros = ['QPCBM'];
        quadroSelect.disabled = true;
    }

    if (quadros.length > 0) {
        quadroSelect.disabled = (posto === 'SD');
        
        quadros.forEach(quadro => {
            const option = document.createElement('option');
            option.value = quadro;
            option.textContent = quadro;
            quadroSelect.appendChild(option);
        });
        
        if(quadros.length === 1) {
            quadroSelect.value = quadros[0];
        }
    }
}
       /**
 * NOVO: Carrega os postos de serviço (ALFA, BRAVO, etc.) do caminho config_geral/postos/lista
 * para preencher o dropdown de seleção de categoria de lista.
 */
async function carregarPostosServicoSelect(elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;

    select.innerHTML = '<option value="" disabled selected>Carregando Postos...</option>';

    try {
        // Usa a busca comprovadamente funcional
        const docRef = db.collection('config_geral').doc('postos');
        const doc = await docRef.get();

        // Usa a extração segura de dados (Postos Visuais usa esta mesma lógica)
        if (doc.exists) {
            const postos = doc.data().lista || []; // Pega o array 'lista'
            
            select.innerHTML = '<option value="" disabled selected>Selecione o Posto de Serviço</option>';
            
            postos.sort().forEach(posto => {
                const option = document.createElement('option');
                option.value = posto;
                option.textContent = posto;
                select.appendChild(option);
            });
            
        } else {
            select.innerHTML = '<option value="" disabled selected>Lista de Postos não encontrada.</option>';
        }

    } catch(e) {
        // Verifique o console (F12) se esta mensagem aparecer
        console.error("Erro CRÍTICO ao carregar Postos de Serviço:", e); 
        select.innerHTML = '<option value="" disabled selected>Erro ao carregar</option>';
    }
}
    </script>
</body>
</html>
