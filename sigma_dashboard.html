<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Gestão & Comando</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="sigma-comum.css">
    <img src="cbmrr.png" id="logo-cbmrr-pdf" crossorigin="anonymous" style="position: absolute; left: -9999px; top: -9999px; width: 100px;">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9; 
            color: #333; 
            margin: 0; 
            display: flex; 
            min-height: 100vh; 
            padding-top: 50px; 
            padding-bottom: 60px; 
            box-sizing: border-box; 
            overflow-x: hidden;
        }
        
        /* Header */
        .main-header { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 50px; 
            background-color: #800020; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000;
            display: flex; 
            align-items: center; 
            padding: 0 15px; 
            box-sizing: border-box; 
            gap: 10px;
        }
        .header-icon { 
            height: 40px; 
            width: auto;
        } 
        .header-title-desktop, .header-title-mobile { 
            font-weight: bold; 
            font-size: 1.1em; 
            line-height: 1.2;
        } 
        .text-white { 
            color: white; 
        } 
        .text-red { 
            color: #FF3B3B;
        } 
        .header-title-desktop { 
            display: none; 
        } 
        .header-title-mobile { 
            display: block;
        }
        /* 1. Sobrescreve a classe de ação para garantir que seja APENAS um ícone */
        .btn-logout-header {
            /* Anulação da Caixa */
            background: transparent !important; /* Garante fundo transparente, anulando o .btn-modern-action */
            border: none !important;      /* Remove bordas */
            box-shadow: none !important;  /* Remove sombras */
            padding: 0 !important;        /* Remove o padding que cria o tamanho da caixa */
            margin-left: auto !important; /* Mantém o alinhamento à direita */
    
            /* Visibilidade do Ícone */
            color: white !important;      /* Cor branca para o ícone */
            font-size: 0;                 /* Define a fonte do botão como zero para ocultar qualquer texto residual */
        }

        /* 2. Força o ícone (i) a ter o tamanho correto e ser branco */
        .btn-logout-header i {
            color: white !important;
            font-size: 1.5em !important; /* Define o tamanho final do ícone (ajuste se necessário) */
            padding: 5px; /* Adiciona uma área de clique maior ao redor do ícone */
            display: inline-block; /* Garante que o ícone seja renderizado corretamente */
        }

        /* 3. Garante que não haja fundo branco/estranho ao interagir */
        .btn-logout-header:hover,
        .btn-logout-header:active,
        .btn-logout-header:focus {
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
            color: white !important;
        }
        #menu-btn { 
            display: none; 
            background: none; 
            border: none; 
            color: white;
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 0 5px; 
        }
        .btn-dial-mobile {
            display: none !important;
        }
		/* --- NOVO DESIGN SYSTEM SIGMA V3 (EXCLUSIVO DASHBOARD) --- */
		.sigma-v3-details-wrapper { background: #f1f5f9 !important; border-radius: 20px !important; padding: 25px !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05) !important; margin-top: 20px; }
		.sigma-v3-details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; padding: 10px 0; }
		.sigma-v3-card-item { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 14px; padding: 18px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: all 0.3s ease; }
		.sigma-v3-card-item:hover { transform: translateY(-4px); border-color: #800020; box-shadow: 0 12px 20px rgba(128, 0, 32, 0.1); }
		.sigma-v3-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
		.sigma-v3-badge { font-size: 0.65em; font-weight: 800; padding: 4px 10px; border-radius: 50px; text-transform: uppercase; letter-spacing: 0.5px; }
		.sigma-v3-date { font-size: 0.72em; color: #94a3b8; font-weight: 600; display: flex; align-items: center; gap: 4px; }
		.sigma-v3-card-item h4 { margin: 0; font-size: 1em; color: #1e293b; font-weight: 700; line-height: 1.2; }
		.sigma-v3-obs-box { font-size: 0.88em; color: #475569; background: #f8fafc; padding: 12px; border-radius: 8px; border-left: 3px solid #cbd5e1; font-style: italic; line-height: 1.4; margin: 0; }
		.sigma-v3-author-info { font-size: 0.78em; color: #64748b; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-top: 4px; }
		.sigma-v3-author-info i { color: #800020; font-size: 0.9em; }
		.sigma-v3-btn-manage { width: 100%; padding: 12px; border: none; border-radius: 10px; background: #800020; color: white; font-weight: 800; font-size: 0.82em; cursor: pointer; text-transform: uppercase; transition: all 0.3s; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px rgba(128, 0, 32, 0.2); }
		.sigma-v3-btn-manage:hover { background: #a00030; box-shadow: 0 6px 12px rgba(128, 0, 32, 0.3); letter-spacing: 1px; }
		
		/* --- CARD DE RESUMO PREMIUM SIGMA V3 --- */
		.sigma-v3-summary-card { background: #ffffff; border-radius: 20px; padding: 22px; flex: 1 1 280px; max-width: 320px; position: relative; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.05); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
		.sigma-v3-summary-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 20px 30px -10px rgba(128, 0, 32, 0.2); }
		.sigma-v3-summary-card::after { font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; bottom: -15px; right: -15px; font-size: 5.5em; opacity: 0.04; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
		.sigma-v3-summary-card:hover::after { opacity: 0.12; transform: rotate(-12deg) scale(1.15); }
		.sigma-v3-summary-card h3 { margin: 0; font-size: 1.25em; font-weight: 800; color: #1e293b; letter-spacing: -0.5px; text-transform: uppercase; }
		.sigma-v3-main-stat { display: flex; align-items: center; gap: 15px; margin: 15px 0; }
		.sigma-v3-stat-circle { width: 60px; height: 60px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.8em; font-weight: 900; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
		.sigma-v3-card-alert { border-top: 6px solid #d90f23 !important; }
		.sigma-v3-card-alert .sigma-v3-stat-circle { background: #fff1f2; color: #d90f23; }
		.sigma-v3-card-ok { border-top: 6px solid #1b8a3e !important; }
		.sigma-v3-card-ok .sigma-v3-stat-circle { background: #f0fdf4; color: #1b8a3e; }
		.sigma-v3-footer-info { border-top: 1px solid #f1f5f9; padding-top: 12px; margin-top: 5px; }
		.sigma-v3-footer-info strong { font-size: 0.72em; color: #64748b; display: block; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.4; }
		.sigma-v3-footer-info small { color: #94a3b8; font-size: 0.7em; font-weight: 600; display: block; margin-top: 2px; }
		.icon-conferencia::after { content: "\f46c"; } /* Clipboard Check */
		.icon-custodia::after { content: "\f47d"; }     /* Hand Holding */
		.icon-receber::after { content: "\f01c"; }       /* Inbox */
		
		/* --- ESTILO FLUTUANTE SIGMA V3 (LIVRE DE CAIXAS) --- */
		.sigma-v3-clean-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; padding: 10px 0 !important; }
		.sigma-v3-floating-card { background: #ffffff; border-radius: 20px; padding: 20px; flex: 1 1 280px; max-width: 320px; position: relative; cursor: pointer; border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 15px 35px rgba(0,0,0,0.05), 0 5px 15px rgba(0,0,0,0.05); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; }
		.sigma-v3-floating-card:hover { transform: translateY(-12px); box-shadow: 0 25px 45px rgba(128, 0, 32, 0.15); border-color: #800020; }
		.sigma-v3-title-label { color: #800020; font-size: 1.1em; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
		.sigma-v3-stat-badge { width: 55px; height: 55px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8em; font-weight: 900; background: #fff1f2; color: #d90f23; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
		.sigma-v3-card-ok-badge { background: #f0fdf4; color: #1b8a3e; }

		/* --- ADICIONAIS PARA DASHBOARD OPERACIONAL SIGMA V3 --- */
		.sigma-v3-card-unit { border-top: 6px solid #2c7399 !important; }
		.sigma-v3-card-unit .sigma-v3-stat-circle { background: #e0f2fe; color: #2c7399; }
		.sigma-v3-card-posto { border-top: 6px solid #8e44ad !important; }
		.sigma-v3-card-posto .sigma-v3-stat-circle { background: #f3e5f5; color: #8e44ad; }

		/* --- VISUALIZADOR DE PDF SIGMA V3 --- */
		.sigma-v3-pdf-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 5000; display: none; align-items: center; justify-content: center; }
		.sigma-v3-pdf-modal { background: #fff; width: 95%; height: 95%; max-width: 1000px; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
		.sigma-v3-pdf-header { background: #800020; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; color: white; }
		.sigma-v3-pdf-actions { display: flex; gap: 10px; }
		.sigma-v3-pdf-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 700; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
		.sigma-v3-pdf-btn:hover { background: #fff; color: #800020; }
		.sigma-v3-pdf-body { flex: 1; background: #525659; position: relative; }
		#sigma-v3-pdf-frame { width: 100%; height: 100%; border: none; }
		@keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

		/* --- TIMELINE MODERNA SIGMA V3 --- */
		.sigma-v3-timeline { position: relative; padding: 20px 0; margin-left: 20px; border-left: 3px solid rgba(128, 0, 32, 0.1); }
		.sigma-v3-timeline-item { position: relative; margin-bottom: 30px; padding-left: 35px; animation: slideInLeft 0.4s ease-out; }
		.sigma-v3-timeline-item::before { content: ""; position: absolute; left: -9px; top: 0; width: 15px; height: 15px; border-radius: 50%; background: #fff; border: 3px solid #800020; box-shadow: 0 0 10px rgba(128, 0, 32, 0.2); z-index: 2; }
		.sigma-v3-timeline-card { background: #ffffff; border-radius: 15px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; transition: 0.3s; }
		.sigma-v3-timeline-card:hover { transform: translateX(8px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); border-color: #800020; }
		.sigma-v3-timeline-info { display: flex; flex-direction: column; gap: 4px; }
		.sigma-v3-timeline-title { font-weight: 800; color: #1e293b; font-size: 1em; text-transform: uppercase; }
		.sigma-v3-timeline-meta { font-size: 0.75em; color: #94a3b8; font-weight: 600; display: flex; align-items: center; gap: 10px; }
		.sigma-v3-timeline-badge { padding: 3px 10px; border-radius: 20px; font-size: 0.9em; font-weight: 800; text-transform: uppercase; }
		@keyframes slideInLeft { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }

		/* --- SIDEBAR V3 PREMIUM --- */
		#main-sidebar { background: #f1f5f9; border-right: 1px solid #e2e8f0; }
		#main-sidebar a { color: #475569; }
		#main-sidebar a:hover { background: #e2e8f0; color: #0f172a; }
		#main-sidebar a.active { background: #fff; color: #800020; border-left: 4px solid #800020; box-shadow: 2px 0 10px rgba(0,0,0,0.02); }
		.menu-label { color: #94a3b8 !important; border-bottom: 1px solid #e2e8f0; margin: 10px 20px; padding: 10px 0 !important; }
		.sigma-v3-dropdown-btn .arrow-icon { margin-left: auto; font-size: 0.8em; transition: 0.3s; }
		.sigma-v3-dropdown-btn.open .arrow-icon { transform: rotate(180deg); }
		.sigma-v3-submenu { display: none; background: #e2e8f0; padding-left: 12px; border-radius: 0 0 10px 10px; }
		.sigma-v3-submenu a { font-size: 0.82em !important; color: #475569 !important; border-left: none !important; }
		.sigma-v3-submenu a:hover { color: #800020 !important; background: rgba(0,0,0,0.03); }
		.sigma-v3-submenu a.active { color: #800020 !important; font-weight: 800; background: #fff !important; }
		#sidebar-user-info span { color: #1e293b !important; }
		@keyframes fadeInSub { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

		/*tabelas CAUTELAS ATIVAS*/
		.sigma-v3-clean-card { background: white; border-radius: 18px; padding: 20px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
		.sigma-v3-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
		.sigma-v3-table th { background: #f8fafc; color: #64748b; font-size: 0.75em; text-transform: uppercase; font-weight: 800; padding: 12px; border-bottom: 2px solid #edf2f7; text-align: left; }
		.sigma-v3-table td { padding: 15px 12px; font-size: 0.85em; color: #1e293b; border-bottom: 1px solid #f1f5f9; }
		.sigma-v3-table tr:hover td { background: #fdfdfd; cursor: pointer; color: #800020; }
		.sigma-v3-tab { background: #f1f5f9; border: none; padding: 10px 18px; border-radius: 10px; color: #64748b; font-weight: 700; font-size: 0.8em; cursor: pointer; transition: 0.3s; }
		.sigma-v3-tab.active { background: #800020; color: white; }

		/* Separadores de Grupo na Tabela Sigma V3 */
		.sigma-v3-table-group-header td { border-bottom: 1px solid #e2e8f0 !important; pointer-events: none; vertical-align: middle; letter-spacing: 0.05em; }
		.sigma-v3-table-group-header i { margin-right: 10px; font-size: 1.1em; }
		tr[style*="rgba(16,185,129,0.03)"]:hover td { background: rgba(16,185,129,0.08) !important; }

		/*MODAL DE GERENCIAR LISTAS EM POSTOS*/
		.swal-v3-list-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 12px 15px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 8px; transition: 0.2s; }
		.swal-v3-list-item:hover { border-color: #8e44ad; background: #fdfaff; }
		.swal-v3-item-info { display: flex; flex-direction: column; text-align: left; }
		.swal-v3-item-name { font-weight: 800; color: #1e293b; font-size: 0.95em; }
		.swal-v3-item-detail { font-size: 0.7em; color: #64748b; font-weight: 700; text-transform: uppercase; }
		.swal-v3-lock { background: #f1f5f9 !important; opacity: 0.7; border-style: dashed !important; }

		/*MODAL DE FORMULÁRIO DE POSTOS*/
		.swal-v3-form-group { text-align: left; margin-bottom: 15px; }
		.swal-v3-form-group label { display: block; font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase; margin-bottom: 6px; }
		.swal-v3-form-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95em; box-sizing: border-box; }

		/*CARDS DE POSTOS*/
		.v3-group-title { grid-column: 1/-1; display: flex; align-items: center; gap: 12px; margin: 30px 0 15px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; color: #1e293b; font-weight: 800; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
		.v3-posto-card { background: #fff; border-radius: 20px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; height: 100%; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; cursor: pointer; box-sizing: border-box; }
		.v3-posto-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
		.v3-posto-header { height: 80px; display: flex; align-items: center; justify-content: center; background: #f8fafc; position: relative; }
		.v3-posto-icon-wrapper { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4em; }
		.v3-posto-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; text-align: center; align-items: center; }
		.v3-posto-badge-dono { position: absolute; top: 15px; left: 15px; background: #1b8a3e; color: #fff; font-size: 0.6em; padding: 4px 10px; border-radius: 50px; font-weight: 900; letter-spacing: 0.5px; box-shadow: 0 4px 10px rgba(27, 138, 62, 0.3); z-index: 5; }
		.v3-posto-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 5; }
		.v3-btn-action { width: 32px; height: 32px; border-radius: 10px; border: none; background: rgba(255,255,255,0.9); color: #64748b; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
		.v3-btn-action:hover { transform: scale(1.1); color: #fff; }
		.v3-btn-edit:hover { background: #2c7399; }
		.v3-btn-delete:hover { background: #ef4444; }
		.v3-posto-footer { width: 100%; border-top: 1px solid #f1f5f9; padding-top: 15px; margin-top: auto; }
		.v3-posto-tag { position: absolute; top: 15px; right: 15px; font-size: 0.6em; font-weight: 900; padding: 4px 10px; border-radius: 50px; letter-spacing: 0.5px; }
		.v3-status-servico { border-left: 6px solid #800020; }
		.v3-status-missao { border-left: 6px solid #2c3e50; }
		.v3-icon-box { width: 60px !important; height: 60px !important; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2em !important; margin-bottom: 15px; flex-shrink: 0; }

		/*MENU VIATURAS*/
		.v3-vtr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
		.v3-vtr-badge { padding: 4px 10px; border-radius: 50px; font-size: 0.65em; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
		.v3-status-pronto { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
		.v3-status-manutencao { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
		.v3-vtr-km-info { background: #f8fafc; border-radius: 12px; padding: 10px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
		
		/* ================================================================
   		BLOCO NOVO: VIATURAS & BASES (IDENTIDADE VISUAL SIGMA)
   		================================================================ */

		/* 1. Container de Seleção Inicial (Funil de Decisão) */
		#vtr-base-selector {
    		display: flex;
    		gap: 25px;
    		justify-content: center;
    		padding: 20px 0;
    		flex-wrap: wrap;
		}

		/* 2. O "Selection Card" - Botão Elegante com Ícone */
		.selection-card {
    		background: #ffffff;
    		border: 2px solid #eee;
    		border-radius: 12px;
    		width: 180px;
    		height: 150px;
    		display: flex;
    		flex-direction: column;
    		align-items: center;
    		justify-content: center;
    		gap: 15px;
    		cursor: pointer;
    		transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    		box-shadow: 0 4px 6px rgba(0,0,0,0.05);
		}

		.selection-card i {
    		font-size: 3em;
    		color: #5d6d7e;
    		transition: all 0.3s ease;
		}

		.selection-card span {
    		font-weight: bold;
    		font-size: 0.85em;
    		color: #555;
    		text-align: center;
		}

		/* 3. Efeitos de Interação (Hover e Selecionado) */
		.selection-card:hover {
    		transform: translateY(-5px);
    		border-color: #2c7399; /* Azul Gestão Sigma */
    		box-shadow: 0 8px 15px rgba(44, 115, 153, 0.2);
		}

		.selection-card:hover i {
    		color: #2c7399;
		}

		.selection-card.selected {
    		background-color: #f0f7fa;
    		border-color: #2c7399;
    		border-width: 3px;
		}

		.selection-card.selected i {
    		color: #2c7399;
    		transform: scale(1.1);
		}

		/* 4. Badges de Status Operativo para os Cards */
		.status-vtr-badge {
    		padding: 3px 8px;
    		border-radius: 4px;
    		font-size: 0.75em;
    		font-weight: bold;
    		text-transform: uppercase;
    		display: inline-block;
    		margin-top: 5px;
		}
		.vtr-ativa { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
		.vtr-manutencao { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
		.vtr-reserva { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }

		/* 5. Alinhamento dos Botões de Ação (Direita do Card) */
		/* Reaproveitando a lógica que funcionou nas Unidades e Postos */
		#vtr-bases-cards-container .card-actions-container {
    		position: absolute !important;
    		top: 10px !important;
    		right: 10px !important;
    		display: flex !important;
    		gap: 8px !important;
    		z-index: 20;
		}
		#vtr-bases-cards-container {
    		display: grid;
    		/* Cria colunas de no mínimo 300px, distribuindo o espaço automaticamente */
    		grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    		gap: 20px;
    		padding: 20px 0;
    		align-items: start;
		}

		/* Garante que o card ocupe a altura total disponível na célula da grade */
		#vtr-bases-cards-container .unit-building-card {
    		display: flex;
    		flex-direction: column;
    		height: 100%;
    		margin: 0; /* Remove margens que podem quebrar o alinhamento do grid */
    		position: relative; /* Necessário para os botões de ação (editar/excluir) */
		}
		/* Customização para o Modal de Vtr */
		.vtr-modal-size {
    		max-width: 600px !important;
    		border-top: 6px solid #2c7399 !important;
		}
		.modal-header-custom {
    		display: flex;
    		justify-content: space-between;
    		align-items: center;
    		border-bottom: 1px solid #eee;
    		padding-bottom: 15px;
    		margin-bottom: 20px;
		}
		.btn-close-modal-x {
    		background: none !important;
    		border: none !important;
    		font-size: 28px !important;
    		color: #888 !important;
    		cursor: pointer !important;
    		margin: 0 !important;
    		padding: 0 !important;
    		line-height: 1 !important;
		}

		.btn-close-modal-x:hover { color: #800020 !important; }	

		/* Ajustes para o modal específico de VTR */
		.vtr-modal-size {
    		max-width: 600px !important;
    		border-top: 6px solid #2c7399 !important;
		}

		.modal-header-custom {
    		display: flex;
    		justify-content: space-between;
    		align-items: center;
    		border-bottom: 1px solid #eee;
    		padding-bottom: 15px;
    		margin-bottom: 20px;
		}

		.btn-close-modal-x {
    		background: none !important;
    		border: none !important;
    		font-size: 28px !important;
    		color: #888 !important;
    		cursor: pointer !important;
    		margin: 0 !important;
    		padding: 0 !important;
    		line-height: 1 !important;
		}

		.btn-close-modal-x:hover { color: #800020 !important; }

		/* Reaproveitando os estilos do semáforo que mandei antes */
		.vtr-semaforo-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
		.semaforo-item { padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
		.semaforo-label { display: block; font-size: 0.65em; font-weight: bold; color: #666; }
		.semaforo-status { line-height: 1.2 !important; font-weight: 800; font-size: 0.85em; display: block; margin-top: 4px; }
		.semaforo-status small {
    		font-size: 0.75em;
    		font-weight: normal;
    		display: block;
    		margin-top: 2px;
    		opacity: 0.9;
		}
		.status-ok { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
		.status-alerta { background: #fffde7; color: #f9a825; border-color: #fff9c4; }
		.status-critico { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
		.vtr-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em; margin-bottom: 20px;}
		.vtr-acoes-container { display: flex; gap: 8px; justify-content: center; border-top: 1px solid #eee; pt: 15px;}
		/* Padronização do Grid de Listas igual ao de Unidades */
		#container-cards-listas.cards-grid {
    		display: grid !important;
    		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
    		gap: 20px !important;
    		width: 100% !important;
    		align-items: stretch;
		}

		/* Garante que o card de lista não "estoure" a largura */
		#container-cards-listas .unit-building-card {
    		width: 100% !important;
    		max-width: 100% !important;
    		margin: 0 !important;
    		box-sizing: border-box !important;
		}
		.timeline-event {
    		position: relative;
    		padding-left: 30px;
    		margin-bottom: 20px;
    		border-left: 2px solid #e2e8f0;
		}
		.timeline-event::before {
    		content: '';
    		position: absolute;
    		left: -7px;
    		top: 0;
    		width: 12px;
    		height: 12px;
    		border-radius: 50%;
    		background: #92400e;
		}
		.event-date { font-size: 0.75em; color: #64748b; font-weight: bold; display: block; }
		.event-title { font-size: 0.9em; font-weight: 800; color: #1e293b; text-transform: uppercase; }
		.event-desc { font-size: 0.9em; color: #475569; margin-top: 4px; background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #f1f5f9; }
		.event-user { font-size: 0.75em; color: #2c7399; font-weight: bold; margin-top: 4px; display: block; }
		.tag-sugestao-setor { background: #f1f5f9; color: #475569; padding: 6px 12px; border-radius: 20px; font-size: 0.75em; font-weight: bold; cursor: pointer; border: 1px solid #e2e8f0; transition: all 0.2s; }
		.tag-sugestao-setor:hover { background: #800020; color: white; border-color: #800020; transform: translateY(-2px); }
		#modal-novo-setor-arquitetura .modal-content { animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }       
		
		/* Badge de Nível Translúcido - Estilo Moderno */
.user-level-badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 50px;
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    margin-top: 8px;
    background: rgba(128, 0, 32, 0.08); /* Fundo muito suave na cor base */
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    border: 1px solid rgba(128, 0, 32, 0.2);
    transition: all 0.3s ease;
}

/* Cores específicas conforme o papel (role) */
.badge-admin { 
    color: #d90f23 !important; 
    background: rgba(217, 15, 35, 0.1) !important;
    border-color: rgba(217, 15, 35, 0.3) !important;
}
.badge-gestor { 
    color: #2c7399 !important; 
    background: rgba(44, 115, 153, 0.1) !important;
    border-color: rgba(44, 115, 153, 0.3) !important;
}
.badge-operacional { 
    color: #1b8a3e !important; 
    background: rgba(27, 138, 62, 0.1) !important;
    border-color: rgba(27, 138, 62, 0.3) !important;
}
		/* Container de resultados com espaço para o efeito de hover */
#resultados-busca-vtr {
    margin-top: 20px;
    max-height: 250px;
    overflow-y: auto;
    padding: 5px; /* Espaço para o card não bater na borda */
}

/* Estado Selecionado do Card */
.result-vtr-card.selected {
    border-left: 6px solid #1b8a3e !important;
    background-color: #f0fdf4 !important;
    border-color: #1b8a3e !important;
    box-shadow: 0 4px 15px rgba(27, 138, 62, 0.15) !important;
    transform: scale(1.01) translateX(5px);
}
	.my-swal-target {
    position: relative !important;
    z-index: 1000 !important;
}	

/* Botão de Iniciar dentro do Modal */
.btn-iniciar-check-modal {
    background-color: #1b8a3e !important;
    color: white !important;
    border-radius: 8px !important;
    padding: 15px !important;
    font-weight: 800 !important;
    letter-spacing: 1px;
    width: 100%;
    margin-top: 15px;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(27, 138, 62, 0.3);
    transition: 0.3s;
}
		.btn-iniciar-check-modal:hover {
    background-color: #14682f !important;
    transform: translateY(-2px);
}
		/* Card de Resumo após seleção */
.vtr-selected-summary {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #1b8a3e;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    margin-top: 15px;
    animation: slideDown 0.3s ease-out;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.vtr-selected-summary h2 {
    color: #1e293b;
    font-size: 2em;
    margin: 0;
    font-weight: 900;
}

.vtr-selected-summary p {
    color: #64748b;
    margin: 5px 0 0 0;
    font-size: 0.9em;
    font-weight: 600;
    text-transform: uppercase;
}
	.vtr-selected-summary .last-check-info {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px dashed #cbd5e1;
    font-size: 0.75em;
    color: #64748b;
    line-height: 1.4;
}

.vtr-selected-summary .last-check-info i {
    color: #1b8a3e;
    margin-right: 4px;
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
		.swal2-container {
    z-index: 99999 !important; /* Valor bem alto para superar Sidebars */
}

/* Garante que o corpo da página não role enquanto o modal está aberto */
body.swal2-shown {
    overflow: hidden !important;
}
		@media (min-width: 768px) {
            .sidebar { left: 0 !important; }
            .header-title-desktop { display: block; font-size: 1.2em; } 
            .header-title-mobile { display: none; } 
            #menu-btn { display: none;} 
        }
        
        /* Sidebar */
        .sidebar { 
            width: 250px;
            background-color: #ffffff; 
            color: #333; 
            padding-top: 20px;
			padding-bottom: 80px !important;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
			box-sizing: border-box;
            border-right: 1px solid #e0e0e0; 
            position: fixed;
            top: 50px; 
            left: 0; 
            height: calc(100% - 50px); 
            display: flex; 
            flex-direction: column; 
            z-index: 1100; 
            overflow-y: auto; 
            transition: left 0.3s ease;
        }
        .sidebar-header { 
            text-align: center; 
            padding: 10px 0 20px 0;
            border-bottom: 1px solid #eee; 
            margin-bottom: 10px; 
        } 
        .sidebar-header img { 
            width: 60px;
            height: auto; 
            margin-bottom: 5px; 
        } 
        #sidebar-user-info {
            /* Define o estilo principal do texto */
            font-size: 1.1em;
            font-weight: bold;
            color: #800020; /* Cor do SIGMA */
            margin: 0; /* Remove margens extras */
            line-height: 1.4;
            display: flex; /* Permite alinhar nome e badge lado a lado */
            flex-direction: column; /* Empilha Nome e Badge */
            align-items: center; /* Centraliza verticalmente o texto */
        }
        #sidebar-user-info #user-name {
            /* Estilo para o nome */
            display: block;
            margin-bottom: 5px; /* Espaço entre nome e badge */
            font-size: 0.9em; /* Um pouco menor que o título */
            color: #333;
        }
        .sidebar a { 
            padding: 15px 20px; 
            text-decoration: none; 
            font-size: 1em;
            color: #555; 
            display: block; 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent; 
            cursor: pointer;
        } 
        .sidebar a:hover { 
            background-color: #fff5f5; 
            color: #800020;
        } 
        .sidebar a.active { 
            background-color: #ffecec; 
            color: #800020; 
            font-weight: bold;
            border-left: 4px solid #d90f23; 
        } 
        .menu-label { 
            padding: 15px 20px 5px;
            font-size: 0.85em; 
            color: #999; 
            text-transform: uppercase; 
            font-weight: bold; 
        }
        .sidebar-overlay { 
            display: none;
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 900;
        }
        .accordion-header:hover {
    		background-color: #fff5f5;
    		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
		}

		.accordion-header i.fa-chevron-down {
    		transition: transform 0.3s;
		}

		/* Rotação do ícone quando ativo */
		.accordion-header.active i.fa-chevron-down {
    		transform: rotate(180deg);
		}

		/* Grid de cards de itens */
		.items-card-grid {
    		display: grid;
    		grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    		gap: 15px;
    		padding: 0 10px 0 10px; /* Adiciona padding interno */
		}

		.item-selection-card.selected {
    		border-color: #1b8a3e; /* Verde quando selecionado */
    		background-color: #f6fff6;
    		box-shadow: 0 0 5px rgba(27, 138, 62, 0.3);
		}

		.item-card-title {
    		font-size: 1em;
    		font-weight: bold;
    		color: #800020;
    		margin: 0 0 10px 0;
		}

		/* Estilo do controle de quantidade para itens 'single' */
		.qtd-control-wrapper {
    		display: flex;
    		align-items: center;
    		gap: 10px;
    		margin-top: 5px;
		}

		.qtd-control-wrapper label {
    		font-weight: normal;
    		font-size: 0.9em;
    		color: #555;
    		display: flex;
    		align-items: center;
    		flex-grow: 1;
		}

		.qtd-control-wrapper input[type="number"] {
    		width: 60px;
    		text-align: center;
    		padding: 5px;
    		border-radius: 4px;
    		font-size: 1em;
		}

		/* Estilo para as Tags/Botões de Tombamento */
		.tombamento-tag-list {
    		display: flex;
    		flex-wrap: wrap;
    		gap: 8px;
    		margin-top: 10px;
		}

		.tombamento-tag {
    		background-color: #efefef;
    		border: 1px solid #ccc;
    		padding: 6px 8px;
    		border-radius: 15px;
    		font-size: 0.8em;
    		cursor: pointer;
    		transition: background-color 0.2s, border-color 0.2s;
    		display: flex;
    		align-items: center;
		}

		.tombamento-tag input[type="checkbox"] {
    		margin-right: 5px;
    		cursor: pointer;
		}

		.tombamento-tag.selected {
    		background-color: #d9ffdb;
    		border-color: #1b8a3e;
    		font-weight: bold;
		}

        /* Content */
        .content { 
    position: fixed !important; /* Mudamos para fixed para travar a moldura */
    top: 50px !important;
    left: 250px !important; /* Início exato após a sidebar */
    width: calc(100% - 250px) !important; /* Largura exata do que sobra */
    height: calc(100vh - 50px) !important;
    margin: 0 !important;
    padding: 20px !important;
    overflow-y: auto !important; /* Scroll apenas aqui */
    overflow-x: hidden !important;
    box-sizing: border-box !important;
    background-color: #f8fafc;
}

/* 4. As seções internas respeitam o limite */
.view-section {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
	display: none;
}

		.view-section.active-view { 
    		display: block;
		}
		.view-section > table, 
		.view-section > .cards-grid {
    		max-width: 100%;
    		overflow-x: auto;
    		display: block; /* Necessário para o overflow funcionar em tabelas */
		}
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
            } 
            to { 
                opacity: 1;
            } 
        }

        /* Footer */
        .footer-central { 
            position: fixed;
            bottom: 0; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            padding: 5px 0 5px; 
            background-color: #f4f4f9; 
            color: #555; 
            font-size: 0.65em; 
            line-height: 1.3;
            z-index: 100; 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        } 
        .footer-central strong, .footer-autor { 
            display: block; 
            width: 100%; 
            text-align: center;
        } 
        .footer-central strong { 
            font-weight: bold; 
        } 
        .footer-autor { 
            margin-top: 10px; 
            color: #888; 
            font-size: 0.9em;
        }

        /* Cards e Grid */
        /* Cards e Grid */
.cards-grid { 
    display: flex;
/* flex-wrap: wrap;  */
    flex-wrap: wrap; 
    gap: 20px; 
    margin-bottom: 30px; 
} 
.sector-card { 
    background-color: white;
/* padding: 15px;  */
    padding: 15px; 
    min-height: 100px; /* ⬅️ AJUSTE: Altura mínima aumentada para garantir alinhamento com cards de lista */
    border-radius: 8px;
/* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
/* A chave: Força o item a ter 280px como largura base e permite que o flexbox o organize */
    flex: 0 0 220px;
/* max-width: 100%; */ 
    max-width: 100%;
/* /* Garante que não ultrapasse a tela em mobile */ */
    cursor: pointer;
/* /* transition: transform 0.2s, box-shadow 0.2s;  */
    transition: transform 0.2s, box-shadow 0.2s; 
    display: flex; 
    flex-direction: column;
/* justify-content: space-between; */
    justify-content: space-between;
}
        /* Garante que o elemento principal dos Cards de Pendência/Estatística tenha altura para empurrar o rodapé */
        .sector-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background-color: #fff5f5; 
        }
        .sector-card.status-alert { 
            border-left: 5px solid #d90f23;
        } 
        .sector-card.status-ok { 
            border-left: 5px solid #1b8a3e; 
        } 
        .sector-card.status-unit { 
            border-left: 5px solid #2c7399;
        } 
        .sector-card.status-posto { 
            border-left: 5px solid #8e44ad; 
        }
        .sector-card.active-card { 
            background-color: #ffecec;
            border: 1px solid #d90f23; 
            border-left: 5px solid #d90f23; 
        }
        .sector-card h3 { 
            margin-top: 0;
            font-size: 1.1em; 
            color: #333; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .sector-card .main-stat { 
            display: flex;
            align-items: center; 
            justify-content: space-between; 
            margin: 10px 0; 
        }
        .sector-card .count-value { 
            font-size: 2em;
            font-weight: bold; 
        }
        .sector-card.status-alert .count-value { 
            color: #d90f23;
        } 
        .sector-card.status-ok .count-value { 
            color: #1b8a3e; 
        }
        .sector-card .card-footer { 
            font-size: 0.75em;
            color: #777; 
            margin-top: 10px; 
            pt: 10px; 
            border-top: 1px solid #eee; 
            line-height: 1.4;
        }
        /* ==================================== */
/* NOVO: ESTILOS PARA CARDS DO MENU GESTÃO DE CAUTELAS */
/* Usa .sector-card + .menu-card para herdar a base de estilos */
/* ==================================== */

.menu-card {
    /* Garante que o cartão ocupe no mínimo 250px, tornando o layout mais flexível */
    flex: 1 1 0; 
    padding: 25px; 
    text-align: center;
    /* Remove a borda lateral de status que outros cards podem ter */
    border-left: none !important;
}
		/* responsáveis pelo DIV de criar listas de conferência */
		.editor-header-sticky { position: sticky; top: 0; z-index: 1000; background: #fff; border-bottom: 2px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); width: 100%; max-width: 100vw; box-sizing: border-box; }
.editor-nav-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #f8fafc; }
.btn-back-editor { background: none; border: none; color: #64748b; font-weight: bold; cursor: pointer; font-size: 0.9em; }
.btn-back-editor:hover { color: #800020; }
.editor-title-container h2 { margin: 0; font-size: 1.2em; color: #1e293b; }
.editor-title-container small { color: #64748b; font-weight: 600; }
.btn-publish { background: #1b8a3e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
.btn-publish:hover { background: #14682f; transform: translateY(-2px); }
.editor-search-bar { display: flex; gap: 20px; padding: 15px 20px; align-items: flex-start; background: #fff; border-bottom: 1px solid #eee; }
.search-input-wrapper { flex: 3; position: relative; display: flex; flex-direction: column; }
.search-input-wrapper i { position: absolute; left: 12px; top: 38px; color: #94a3b8; z-index: 10; }
.search-input-wrapper input { width: 100%; padding: 12px 12px 12px 38px; border: 2px solid #e2e8f0; border-radius: 8px; margin-top: 5px; font-size: 0.95em; box-sizing: border-box; }
.target-sector-wrapper { flex: 1.5; display: flex; flex-direction: column; }
.target-sector-wrapper select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-top: 5px; height: 48px; background-color: #f8fafc; font-weight: bold; color: #1e293b; box-sizing: border-box; }
.btn-add-fast { background: #2c7399; color: white; border: none; height: 48px; padding: 0 25px; border-radius: 8px; font-weight: 800; cursor: pointer; align-self: flex-end; margin-bottom: 0; transition: all 0.2s; white-space: nowrap; }
.btn-add-fast:hover { background: #1e4f6a; box-shadow: 0 4px 6px rgba(44, 115, 153, 0.3); }
.editor-main-layout { display: flex; gap: 20px; padding: 20px; min-height: calc(100vh - 180px); background: #f1f5f9; }
.editor-setores-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; align-items: start; }
.setor-arquitetura-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; max-height: 500px; }
.setor-arquitetura-header { padding: 12px 15px; background: #800020; color: white; border-radius: 11px 11px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
.setor-arquitetura-body { padding: 10px; overflow-y: auto; flex: 1; min-height: 100px; }
.item-arquitetura-linha { display: flex; align-items: center; padding: 10px; background: #fff; border: 1px solid #f1f5f9; border-radius: 6px; margin-bottom: 8px; cursor: move; transition: 0.2s; }
.item-arquitetura-linha:hover { border-color: #2c7399; background: #f8fafc; }
.item-arquitetura-info { flex: 1; }
.item-arquitetura-info b { display: block; font-size: 0.9em; color: #334155; }
.item-arquitetura-info span { font-size: 0.75em; color: #64748b; font-weight: 600; }
.btn-remove-item-vtr { background: none; border: none; color: #cbd5e1; cursor: pointer; font-size: 1.1em; padding: 5px; }
.btn-remove-item-vtr:hover { color: #ef4444; }
.estorno-sidebar { width: 300px; background: #fff; border-left: 4px solid #f57c00; border-radius: 12px; display: flex; flex-direction: column; box-shadow: -4px 0 15px rgba(0,0,0,0.05); position: sticky; top: 140px; height: calc(100vh - 200px); }
.estorno-dock-minimized { position: fixed; bottom: 0; right: 20px; width: 320px; background: #fff; border: 2px solid #f57c00; border-bottom: none; border-radius: 12px 12px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 1000; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.estorno-dock-minimized.expanded { transform: translateY(0); }
.estorno-dock-minimized:not(.expanded) .estorno-content-wrapper { display: none; }
.estorno-header { padding: 12px 15px; background: #fff3e0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
.estorno-header h3 { margin: 0; font-size: 1em; color: #e65100; }
.estorno-header:hover { background: #ffe0b2; }
#badge-estorno-count { background: #e65100; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
.header-left { display: flex; align-items: center; gap: 10px; color: #e65100; font-weight: 800; font-size: 0.9em; }
.badge-voador { background: #d32f2f; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; transition: transform 0.3s; }
.badge-pulse { transform: scale(1.4); }
.estorno-body { max-height: 250px; overflow-y: auto; padding: 10px; background: #fff; }
.item-estorno-linha { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f1f5f9; animation: slideInRight 0.3s ease; }
.estorno-footer { padding: 15px; background: #f8fafc; border-top: 1px solid #eee; }
.estorno-footer textarea { width: 100%; height: 70px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; resize: none; font-size: 0.85em; margin-top: 5px; }.btn-confirm-estorno { width: 100%; background: #f57c00; color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }
.fab-add-setor { position: fixed; bottom: 30px; left: 280px; width: 60px; height: 60px; border-radius: 50%; background: #800020; color: white; border: none; box-shadow: 0 4px 10px rgba(128, 0, 32, 0.4); font-size: 1.5em; cursor: pointer; z-index: 101; transition: 0.3s; }
.fab-add-setor:hover { transform: scale(1.1) rotate(90deg); }
#sugestoes-estoque-editor { position: absolute; top: 100%; left: 0; width: 100%; z-index: 1000; background: white; border: 1px solid #2c7399; border-radius: 0 0 8px 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: none; max-height: 250px; overflow-y: auto; }
.suggestion-item { display: flex !important; align-items: center !important; padding: 10px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
.suggestion-item:hover { background: #f0f7fa; }
.suggestion-item i { width: 20px; text-align: center; font-size: 1.1em; flex-shrink: 0; }
.suggestion-item div { display: flex; flex-direction: column; overflow: hidden; }
.suggestion-item b { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
.suggestion-item small { color: #64748b; font-size: 0.8em; }
@keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
.search-input-wrapper > i { position: absolute; left: 12px; top: 24px; color: #94a3b8; z-index: 10; pointer-events: none; }
.icon-sugestao-estoque { 
    margin-right: 12px !important; 
    width: 20px !important; 
    text-align: center !important; 
    position: static !important; /* Remove o position absolute que causava a sobreposição */
    transform: none !important; 
    display: inline-block !important;
}
		/* Estilo para as Pílulas de Viaturas Recentes */
.badge-vtr-recente {
    background: #f1f5f9;
    color: #2c3e50;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 700;
    cursor: pointer;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.badge-vtr-recente:hover {
    background: #800020;
    color: white;
    border-color: #800020;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(128, 0, 32, 0.2);
}

/* Card de Resultado da Busca Global */
.result-vtr-card {
    background: #fff;
    border: 1px solid #eee;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid #2c3e50;
}

.result-vtr-card:hover {
    background: #f8fafc;
    border-color: #2c7399;
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.result-vtr-card b {
    font-size: 1.1em;
    color: #333;
}

.result-vtr-card i {
    color: #2c7399;
    margin-right: 8px;
}

/* Ajuste no Input do SweetAlert para seguir o padrão SIGMA */
#input-busca-vtr-global {
    border: 2px solid #e2e8f0 !important;
    border-radius: 8px !important;
    font-family: inherit !important;
    font-size: 1em !important;
    height: 45px !important;
    margin: 10px 0 !important;
    transition: border-color 0.3s !important;
}

#input-busca-vtr-global:focus {
    border-color: #800020 !important;
    box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1) !important;
}
		
@media (min-width: 900px) {
    /* Força o grid do menu de cautelas a ter 4 colunas de tamanho igual */
    #cautelas-options-container {
        /* Aumentamos a especificidade para garantir o layout de 4 colunas */
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 15px; 
    }
}

/* Ajusta o hover para ser visualmente mais forte e manter a cor institucional */
.menu-card:hover {
    transform: translateY(-3px); /* Leve levantamento */
    /* Usa a cor principal do sistema (#800020) na sombra */
    box-shadow: 0 6px 15px rgba(128, 0, 32, 0.2); 
    background-color: #fff8f8;
}

/* Estilo do Ícone (a ser usado dentro do .menu-card) */
.menu-card .card-icon {
    font-size: 3em; 
    color: #800020; /* Cor Institucional */
    margin-bottom: 10px;
    display: block;
}

/* Estilo do Título dentro do Card de Menu */
.menu-card h3 {
    font-size: 1.2em;
    color: #333;
    margin-top: 0;
    margin-bottom: 5px;
}

/* Estilo da Descrição/Parágrafo */
.menu-card p {
    font-size: 0.9em;
    color: #666;
    margin: 0;
}
        
        .sub-list-preview { 
            font-size: 0.85em; 
            color: #555; 
            list-style: none; 
            padding: 0; 
            margin: 0;
            max-height: 60px; 
            overflow: hidden; 
        }
        .sub-list-preview li { 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        /* Greeting Card */
        .greeting-card { 
            /* Estilos Visuais */
            background: linear-gradient(135deg, #800020 0%, #5a0017 100%);
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 10px rgba(128, 0, 32, 0.2); 
    
            /* Configuração Flexbox */
            display: flex;
            flex-wrap: wrap; /* ✅ ESSENCIAL: Permite que a foto e o bloco de info (.greeting-info) quebrem em telas pequenas. */
            align-items: center;
            gap: 20px; 
        }
        .greeting-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            flex-basis: auto;
            border: 3px solid rgba(255,255,255,0.3); 
            object-fit: cover; 
            background-color: white; 
        }
        .greeting-info { 
            display: flex;
            flex-wrap: wrap; /* Permite a quebra de linha em mobile */
            align-items: center; 
            flex-grow: 1; /* Ocupa o máximo de espaço possível */
            gap: 15px;
            flex-basis: 0;
        }
        .greeting-text-wrapper {
            flex-grow: 1;
            margin-bottom: 10px;
            order: 0;
        }
        #btn-open-conf-modal {
            margin-left: auto; /* Empurra o botão para a direita em desktop */
            justify-content: center !important; 
            text-align: center;
        }
        .greeting-title { 
            margin: 0; 
            font-size: 1.3em; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .greeting-date { 
            font-size: 0.85em; 
            opacity: 0.8; 
            margin-top: 3px; 
            display: block;
            font-style: italic;
        }
        .greeting-user { 
            font-size: 1.1em; 
            margin-top: 5px; 
            display: block; 
            font-weight: 500;
        }
        .greeting-title, .greeting-user { 
            white-space: nowrap; /* Impede quebras de linha dentro do texto */
            overflow: hidden;
            text-overflow: ellipsis; /* Adiciona "..." se o texto for muito longo */
            max-width: 100%; /* Garante que respeite o pai */
            display: block;
        }

        /* Card de Nova Conferência / Filtros */
        .op-card { 
            background: white;
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            padding: 25px; 
            margin-bottom: 25px; 
            border-left: 5px solid #ccc;
        }
        .op-card.action { 
            border-left-color: #1b8a3e;
        }
        .op-card.history { 
            border-left-color: #2c7399;
        }
        .op-card.resume { 
            border-left-color: #f57c00; 
            background-color: #fff3e0; 
            cursor: pointer; 
            transition: transform 0.2s;
            padding: 25px 35px 25px 25px; /* Adiciona 35px de padding na direita */
            position: relative;
        }
        .op-card.resume:hover { 
            transform: translateY(-2px);
        }
        
        .op-card-title { 
            color: #333;
            margin-top: 0; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 10px; 
            font-size: 1.2em; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .form-group { 
            margin-bottom: 15px;
        }
        .form-group label { 
            display: block; 
            font-weight: bold; 
            color: #555; 
            margin-bottom: 5px;
            font-size: 0.9em; 
        }
        .form-group select, .form-group input { 
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box;
            /* Garante que todos os inputs de formulário herdem a fonte base */
            font-family: inherit; 
        }
        
        /* Regra específica para inputs de data no Chrome/Edge/Firefox, forçando a fonte */
         input[type="date"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }
        .form-group select:focus, .form-group input:focus { 
            border-color: #800020;
            outline: none; 
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
        }
        .btn-start { 
            background: linear-gradient(135deg, #d90f23 0%, #800020 100%); 
            color: white; 
            border: none;
            width: 100%; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(217, 15, 35, 0.3);
        }
        .btn-start:focus { 
            outline: 3px solid rgba(128,0,32,0.4);
        }

        /* Admin Tables & Lists */
        .new-local-section { 
            background: #fff;
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            border-top: 3px solid #2c7399;
        }
        .role-badge { 
            padding: 3px 8px;
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold; 
            color: white; 
        }
        .role-admin { 
            background-color: #d90f23;
        } 
        .role-gestor { 
            background-color: #f57c00; 
        } 
        .role-operacional { 
            background-color: #1b8a3e;
        }
        
        /* Editor de Listas (Elementos) */
        .admin-container { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto;
            text-align: center; 
        }
        .lista-setores { 
            padding: 0; 
            list-style: none; 
            text-align: left;
        }
    
        .item-list-admin {}
        .setor-content-header-sticky {
            /* Tornar o contêiner do cabeçalho e formulário sticky */
            position: sticky;
            top: 50px; /* Bate logo abaixo do main-header (50px) */
            z-index: 50;
            /* Garante que fique acima dos itens rolando */
            background-color: #fff;
            /* Fundo branco para cobrir o conteúdo rolando */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            /* Sombra suave para destacar */
        }
        #lista-setores-container {
             border: none !important;
             margin-top: 20px; 
        }
        .tombamento-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 0;
            border-bottom: 1px dotted #eee; 
        }
        .item-actions-admin { 
            display: flex; 
            gap: 5px;
        }
        .btn-remover { 
            background-color: #d90f23; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        } 
        .btn-edit-alt { 
            background-color: #7f8c8d; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        }
        .btn-add { 
            background-color: #800020; 
            color: white; 
            border: none; 
            padding: 8px 15px;
            border-radius: 4px; 
            cursor: pointer; 
        }
        .locais-list { 
            list-style: none; 
            padding: 0;
        }
        .local-item { 
            background: white; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 5px solid #800020;
        }
        .local-info strong { 
            display: block; 
            font-size: 1.1em; 
            color: #333;
        }

        /* CA Table */
        .ca-table-container, .admin-container, table {
    max-width: 100% !important;
    overflow-x: auto !important;
}
        .ca-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9em;
        } 
        .ca-table th, .ca-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
            vertical-align: top;
        } 
        .ca-table th { 
            background-color: #f8f8f8; 
            color: #800020; 
            font-weight: bold; 
            text-transform: uppercase;
        }
        .custom-select-container {
            position: relative;
        }
        .custom-select-container input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }
         .custom-select-container input[type="text"]:focus {
            border-color: #800020;
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
        }

        .suggestions-box {
            position: absolute;
            top: 100%; /* Posiciona logo abaixo do input */
            left: 0;
            right: 0;
            z-index: 10; /* Garante que fique acima de outros elementos */
            background-color: #fff;
            border: 1px solid #800020; /* Cor Institucional */
            border-top: none;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 200px; /* Limita a altura para rolagem */
            overflow-y: auto;
            display: none; /* Inicia oculto */
        }

        #cautela-suggestions-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #cautela-suggestions-list li {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.95em;
            color: #333;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        #cautela-suggestions-list li:last-child {
            border-bottom: none;
        }

        #cautela-suggestions-list li:hover {
            background-color: #ffecec; /* Hover com cor institucional clara */
            color: #800020;
            font-weight: 500;
        }
        .row-amarelo { 
            background-color: #fff9c4 !important; 
        } 
        .row-laranja { 
            background-color: #ffe0b2 !important;
        } 
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold;
        } 
        .badge-pendente { 
            background-color: #ffebee; 
            color: #d32f2f; 
        } 
        .badge-solucao { 
            background-color: #fff9c4; 
            color: #fbc02d; 
            border: 1px solid #fbc02d;
        } 
        .badge-cautela { 
            background-color: #ffe0b2; 
            color: #f57c00; 
            border: 1px solid #f57c00;
        }

        /* Modals - ESTILO PREMIUM */
		.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Fundo escuro */
    z-index: 2000;

    /* CHAVE DA CENTRALIZAÇÃO */
    display: none; /* O JS mudará para 'flex' */
    align-items: center;    /* Centraliza verticalmente */
    justify-content: center; /* Centraliza horizontalmente */
}

/* Garante que o conteúdo branco não grude nas bordas no mobile */
.modal .modal-content {
    margin: auto;
    position: relative;
}
        .modal-overlay { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 2000;
        } 
        .modal-content { 
            background: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            width: 90%;
            max-width: 500px; 
            position: relative; 
            text-align: left; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        } 
        .modal-content h2 { 
            margin-top: 0; 
            color: #800020; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px; 
            font-size: 1.4em; 
        } 
        .modal-content label { 
            display: block; 
            margin-top: 15px;
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #444; 
            font-size: 0.95em; 
        } 
        
        /* Inputs Premium no Modal */
        .modal-content input[type="text"], 
        .modal-content input[type="number"],
        .modal-content select, 
        .modal-content textarea { 
            width: 100%;
            padding: 12px; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 1em; 
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
            border-color: #800020;
            outline: none;
            box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
        }
        
        .modal-content textarea { 
            height: 100px;
            resize: vertical; 
        } 
        .modal-buttons { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px;
            margin-top: 10px; 
        } 
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px;
            background: none; 
            border: none; 
            font-size: 20px; 
            cursor: pointer; 
            color: #999; 
            transition: color 0.2s;
        }
        .close-btn:hover { 
            color: #d90f23;
        }
        /* --- ADICIONE ESTES ESTILOS AO BLOCO <style> DO sigma_dashboard.html.txt --- */

.modal-content button { 
    padding: 10px 20px; 
    margin-top: 20px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
    transition: background-color 0.3s; 
    font-weight: bold; 
}

.modal-btn-cancel { 
    background-color: #ccc; 
    color: #333; 
}

.modal-btn-cancel:hover { 
    background-color: #bbb; 
}

.modal-actions { 
    display: flex; 
    justify-content: flex-end; 
    gap: 10px; /* Adiciona espaçamento entre os botões */
}
/* --- ESTILOS PARA ABAS DE NAVEGAÇÃO (CORREÇÃO FINAL DE COR) --- */
.tab-navigation {
    width: fit-content; 
    margin: 0 auto;
    display: flex;
    border-bottom: 2px solid #ddd; 
    margin-bottom: 0 !important; 
}

/* Regra base do botão */
.tab-button {
    /* Removendo !important da cor base para que a regra :not(.active) funcione */
    color: #000; 
    background-color: transparent;
    
    border: 1px solid #ccc !important;
    border-bottom: 2px solid #ddd !important;
    border-radius: 8px 8px 0 0 !important; 
    padding: 10px 18px !important;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: -2px; 
}

/* 🛑 CORREÇÃO FINAL: Força o texto para preto SÓ QUANDO NÃO ESTÁ ATIVO 🛑 */
/* Esta regra tem especificidade suficiente para anular a cor branca herdada */
.tab-navigation .tab-button:not(.active) {
    color: #000 !important;
    background-color: transparent !important;
}

.tab-button:hover:not(.active) {
    background-color: #f0f0f0 !important;
    color: #333 !important; 
}

.tab-button.active {
    /* ESTILO ATIVO DESEJADO: BRANCO NO VINHO (#800020) */
    background-color: #800020 !important; 
    color: white !important; /* Texto branco */
    border-color: #800020 !important;
    border-bottom-color: #fff !important; 
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    z-index: 10; 
}

.historico-tab-content {
    background-color: #fff;
    border: 1px solid #ddd;
    border-top: 2px solid #800020; /* Borda da cor da aba ativa */
    padding: 15px;
    border-radius: 0 6px 6px 6px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

/* Garante que o botão de Recebimento use o estilo btn-modern-action, se ele não estiver pegando */
#btn-receber-cautela {
    /* Exemplo: Se precisar de estilo de ação forte */
    background-color: #1b8a3e; /* Verde Forte */
    color: white;
}
#btn-receber-cautela:hover {
    background-color: #14682f;
}

        /* Checkbox list in modal */
        .checklist-container { 
            max-height: 200px;
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 5px; 
            margin-bottom: 15px;
        }
        .checklist-item { 
            display: flex; 
            align-items: center; 
            padding: 5px; 
            border-bottom: 1px dotted #f0f0f0;
        }
        .checklist-item:hover { 
            background: #fafafa;
        }
        .checklist-item input { 
            width: auto; 
            margin-right: 10px; 
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-modern-action {
            /* PROPRIEDADES DE LAYOUT ORIGINAIS (MANTIDAS) */
            display: inline-flex;
            align-items: center;
            gap: 8px;
    
            /* PROPRIEDADES DE ESTILO E COR (ATUALIZADAS) */
            background-color: #800020; /* Vermelho Escuro (Cor principal do SIGMA) */
            color: #ffffff !important; /* Força a cor branca */
            border: none;
            padding: 8px 15px; /* Tamanho ligeiramente menor para botão de 'Voltar' */
            border-radius: 6px; /* Mantive o seu radius original */
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
			text-align: center;
			justify-content: center;
            font-size: 0.9em; /* Tamanho reduzido para ser secundário */
            transition: background-color 0.2s, box-shadow 0.2s; /* Ajuste na transição */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Sombra mais destacada */
            white-space: nowrap; 
        }
        .btn-modern-action:hover {
            background-color: #a00030; /* Um pouco mais claro no hover */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .btn-modern-action:active { 
            transform: translateY(1px);
            box-shadow: none; 
        }
        .btn-create {
            background-color: #800020; /* Seu Azul original */
            color: #ffffff !important; 
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s, box-shadow 0.2s;
			display: flex !important;
    		justify-content: center !important;
    		align-items: center !important;
    		gap: 10px;
    		width: 100%; /* Para ocupar a largura total do formulário */
    		text-align: center;
        }

        .btn-create:hover {
            background-color: #205b7a; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .btn-form-action {
            width: 100%;
            margin-top: 15px; /* Adiciona um espaço acima do botão no formulário */
        }
        .btn-secondary {
    		background-color: #5d6d7e; /* Cinza grafite (mais escuro para dar contraste) */
    		color: #ffffff !important;  /* Força o texto a ser branco */
    		border: none;
    		padding: 8px 15px;
    		border-radius: 5px;
    		cursor: pointer;
    		font-size: 0.9em;
    		font-weight: bold;
    		transition: background-color 0.2s, transform 0.1s;
    		display: inline-flex;
    		align-items: center;
    		gap: 8px;
    		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.btn-secondary:hover {
    		background-color: #34495e; /* Tom mais escuro ao passar o mouse */
		}

		.btn-secondary:active {
    		transform: scale(0.95); /* Efeito de clique */
		}
        .btn-edit { 
            background-color: #2c7399; 
        }
        .btn-edit:hover {
            background-color: #205b7a; /* Um tom mais escuro para o hover */
        }
        .btn-delete { 
            background-color: #d90f23;
        } 
        .btn-sync { 
            background-color: #1b8a3e; 
        } 
        .btn-backup { 
            background: #5d6164;
        }
        .btn-filter-modern { 
            background-color: #2c7399; 
            color: white; 
            border: none; 
            padding: 11px 25px;
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        

        /* APP CONTAINER (IFRAME) */
        #app-runner-container { 
            display: none;
            position: fixed; 
            top: 50px; 
            left: 250px; 
            width: calc(100% - 250px); 
            height: calc(100vh - 50px); 
            background: white; 
            z-index: 500; 
            overflow: hidden;
        }
        #app-iframe { 
            width: 100%; 
            height: 100%; 
            border: none;
        }

        /* History List Specifics */
        .history-list { 
            list-style: none;
            padding: 0; 
            margin: 0; 
        }
        .history-item { 
            border-bottom: 1px solid #eee;
            padding: 15px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background 0.2s;
        }
        .history-item:hover { 
            background-color: #fafafa; 
            padding-left: 5px; 
            padding-right: 5px;
        }
        .history-item:last-child { 
            border-bottom: none;
        }
        .hist-info strong { 
            display: block; 
            color: #333; 
            font-size: 1.05em;
        }
        .hist-info small { 
            color: #777; 
            font-size: 0.9em;
        }
        .hist-status { 
            font-size: 0.8em; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: bold;
            margin-left: 5px; 
            text-transform: uppercase; 
        }
        .status-ok { 
            background-color: #e8f5e9; 
            color: #2e7d32;
            border: 1px solid #c8e6c9; 
        }
        .status-alert { 
            background-color: #ffebee; 
            color: #c62828;
            border: 1px solid #ffcdd2; 
        }
        .btn-reprint { 
            background: white; 
            border: 1px solid #ddd;
            padding: 8px 12px; 
            border-radius: 6px; 
            color: #555; 
            cursor: pointer; 
            font-size: 0.9em; 
            display: flex; 
            align-items: center; 
            gap: 5px;
        }
        .btn-reprint:hover { 
            border-color: #800020; 
            color: #800020; 
            background-color: #fff5f5;
        }

        /* Filtros Premium */
        .modern-filter-card { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #e0e0e0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px; 
            align-items: flex-end; 
        }
        .filter-item { 
            flex: 1; 
            min-width: 200px;
        }
        .filter-item label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: #555;
            font-size: 0.9em; 
        }
        .filter-input { 
            width: 100%; 
            padding: 10px 12px;
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 0.95em; 
            box-sizing: border-box;
        }
        .dashboard-columns {
    display: flex;
    flex-direction: column; /* Em mobile, os blocos ficam empilhados (Mobile-First) */
    gap: 25px; 
}
    /* Regra para garantir o alinhamento vertical centralizado do ícone ao bloco de texto */
.unit-header .unit-flex-title {
    display: flex;
    align-items: center; /* CENTRALIZA O ÍCONE VERTICALMENTE COM O TEXTO QUEBRADO */
    gap: 8px; /* Espaçamento entre o ícone e o texto */
    width: 100%; /* Opcional, para garantir que o H3 preencha a largura */
}

/* Garante que o texto se comporte como um bloco para quebrar corretamente */
.unit-header .unit-flex-title span {
    flex-grow: 1; 
    line-height: 1.3; /* Melhora a leitura do texto quebrado */
}
		#units-cards-container {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important; /* 3 colunas iguais */
    gap: 20px !important;
    margin-top: 20px;
    align-items: stretch;/* Garante que todos os cards da linha tenham a mesma altura */
}
	#postos-cards-container {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important; /* 3 colunas iguais no desktop */
    gap: 20px !important;
    margin-top: 20px;
    align-items: stretch; /* Garante que todos os cards da linha tenham a mesma altura */
}

/* Garante que o card de Posto herde as dimensões corretas da grade */
#postos-cards-container .unit-building-card {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
}
	.card-actions-container {
    	position: absolute;
    	top: 10px;
    	right: 10px;
    	display: flex; /* Alinha os botões lado a lado */
    	gap: 8px;      /* Espaço entre os botões */
    	z-index: 10;
	}
	.btn-edit-unit-card, .btn-delete-unit-card {
    	position: static !important; /* IMPORTANTE: Cancela o absolute individual antigo */
    	width: 30px !important;
    	height: 30px !important;
    	border-radius: 50% !important;
    	display: flex !important;
    	align-items: center !important;
    	justify-content: center !important;
    	background: rgba(255, 255, 255, 0.9) !important;
    	border: 1px solid #ddd !important;
    	cursor: pointer;
    	transition: 0.3s;
	}	
	.btn-edit-unit-card:hover { color: white !important; background: #28a745 !important; }
	.btn-delete-unit-card:hover { color: white !important; background: #d90f23 !important; }
       
/* ================================================================
   BLOCO DE REGRAS EXCLUSIVAS PARA MOBILE (ATÉ 768px)
   ================================================================ */
@media (max-width: 768px) {
    /* Ajuste de moldura do conteúdo principal */
    .content { left: 0 !important; width: 100% !important; }
    
    /* Transformação das Grades em Coluna Única (Empilhamento) */
    #units-cards-container { grid-template-columns: 1fr !important; }
    #postos-cards-container { grid-template-columns: 1fr !important; gap: 15px !important; }
    
    /* Reorganização do Header de Cautelas (Prioridade Flex) */
    .header-container { flex-wrap: wrap; justify-content: flex-start !important; align-items: flex-start !important; padding-left: 5px !important; padding-right: 5px !important; }
    #btn-back-cautelas { order: 1; margin-left: auto; flex-shrink: 0; margin-top: 5px; margin-bottom: 5px; }
    .header-container h3 { order: 2; flex-basis: 100%; margin-top: 0; }
    
    /* Gradeamento Table-to-Card (Transforma tabelas em cartões) */
    #cautelas-ativas-table, #cautelas-receive-table, 
    #cautelas-ativas-table thead, #cautelas-receive-table thead, 
    #cautelas-ativas-table tbody, #cautelas-receive-table tbody, 
    #cautelas-ativas-table th, #cautelas-receive-table th, 
    #cautelas-ativas-table td, #cautelas-receive-table td, 
    #cautelas-ativas-table tr, #cautelas-receive-table tr { display: block; }
    
    /* Ajuste de Títulos de Grupo e remoção de labels automáticos nesses títulos */
    #cautelas-ativas-table .group-title-cell:before { content: none !important; }
    
    /* Ocultação visual do cabeçalho da tabela original */
    #cautelas-ativas-table thead tr, #cautelas-receive-table thead tr { position: absolute; top: -9999px; left: -9999px; }
    
    /* Estilo do Card individual da linha da tabela */
    #cautelas-ativas-table tr, #cautelas-receive-table tr { border: 1px solid #ccc; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 10px; cursor: pointer; }
    
    /* Manutenção do comportamento de linha para cabeçalhos de grupo */
    #cautelas-ativas-table tr.group-header { display: table-row; border: none; box-shadow: none; margin-bottom: 20px; }
    #cautelas-ativas-table tr.group-header td { display: table-cell; padding: 0; }
    .group-header .group-title-cell { font-size: 1.1em; font-weight: bold; color: #333; padding-left: 0 !important; }
    
    /* Formatação de células como linhas de dados (Rótulo à esquerda, Dado à direita) */
    #cautelas-ativas-table td, #cautelas-receive-table td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50% !important; text-align: right; white-space: normal; font-size: 0.9em; }
    #cautelas-ativas-table td:before, #cautelas-receive-table td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: #800020; }
    
    /* Ajustes específicos do Dashboard Greeting */
    .greeting-card { align-items: flex-start; }
    .greeting-info { flex-basis: auto; flex-grow: 1; margin-top: 0; flex-direction: row; flex-wrap: wrap; align-items: flex-start; gap: 10px; }
    .greeting-text-wrapper { flex-basis: 100%; flex-grow: 1; margin-bottom: 0; }
    #btn-open-conf-modal { flex-basis: 100%; margin-top: 15px; margin-left: 0; width: 100%; order: 1; }
    .btn-dial-mobile { display: inline-block !important; }
    .greeting-avatar { flex-basis: auto; }
    
    /* Controle da Sidebar no Mobile */
    #menu-btn { display: block; }
    .sidebar { left: -260px; width: 260px; border-right: 1px solid #ddd; }
    .sidebar.mobile-active { left: 0 !important; }
    
    /* Layout de Seções e Conteúdo */
    .content, .content-area { margin-left: 0 !important; width: 100% !important; padding-top: 15px !important; padding-left: 10px !important; padding-right: 10px !important; }
    .view-section { padding: 0 !important; }
    .menu-card { margin-left: 0 !important; margin-right: 0 !important; }
    #app-runner-container { left: 0; width: 100%; z-index: 500; }
    
    /* Filtros e Inputs Mobile */
    .modern-filter-card { flex-direction: column; align-items: stretch; gap: 10px; }
    .btn-filter-modern { width: 100%; }
    .filter-input { max-width: 100%; width: 100%; }
    .filter-item { width: 100%; min-width: 0; }
    
    /* Tabelas Administrativas Mobile (Rótulos data-label) */
    .admin-container { padding: 10px; margin-top: 20px; }
    .admin-table, .admin-table thead, .admin-table tbody, .admin-table th, .admin-table td, .admin-table tr { display: block; }
    .admin-table thead tr { position: absolute; top: -9999px; left: -9999px; }
    .admin-table tr { border: 1px solid #ccc; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .admin-table td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; text-align: right; font-size: 0.9em; }
    .admin-table td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: #800020; }
    .admin-table td[data-label="Ações:"], .admin-table td:last-child { text-align: right !important; }
    
    /* Formulários Globais e Seções de Cadastro */
    .global-actions { display: flex; flex-direction: column; gap: 10px; }
    .new-local-section > div[style*="grid"] { display: block !important; }
    .new-local-section > div[style*="flex"] { display: block !important; }
    .new-local-section .form-group { margin-bottom: 10px; }
    .new-local-section .btn-modern-action, .new-local-section .btn-create { width: 100%; margin-top: 10px; }
    
    /* Cards de Setor e Grade de Cards */
    .sector-card { margin-left: 0 !important; margin-right: 0 !important; flex: 1 1 100% !important; max-width: 100% !important; }
    .cards-grid { gap: 20px 0 !important; margin-left: 0 !important; margin-right: 0 !important; }
    
    /* Editor de Listas (Setores e Itens) Mobile */
    .add-setor-form { flex-direction: column; gap: 10px !important; margin-left: 0 !important; }
    .add-item-form-setor { flex-wrap: wrap; }
    .add-item-form-setor input, .add-item-form-setor select, .add-item-form-setor button { flex-grow: 1; width: 100%; box-sizing: border-box; }
    .add-item-form-setor button { flex-grow: 0; width: 48%; }
    .item-conferencia-admin { flex-direction: column; align-items: flex-start; padding: 10px; }
    .item-actions-admin { margin-top: 10px; align-self: flex-end; }
    .tombamento-container-wrapper { padding-left: 10px; margin-top: 10px; }
    .tombamento-list li { flex-wrap: wrap; padding: 5px 0; }
    .tombamento-list input { flex-grow: 1; }
    .form-grid-2-columns { grid-template-columns: 1fr; }
	.selection-card { width: 100%; height: 100px; flex-direction: row; padding: 0 20px; justify-content: flex-start; gap: 20px; }
    .selection-card i { font-size: 2em; }
	.editor-search-bar { flex-direction: column; align-items: stretch; gap: 12px !important; padding: 10px 15px 15px 15px !important; }
	.target-sector-wrapper { min-width: 100% !important; }
	.search-input-wrapper { width: 100%; flex: none !important; }
	.editor-main-layout { flex-direction: column; }
	.estorno-sidebar { width: 100%; position: static; height: auto; }
	.fab-add-setor { left: auto; right: 20px; }
}
		.g-cat-form-grid {
        	grid-template-columns: 1fr;
    	}
    	.g-cat-tabs-wrapper {
        	flex-wrap: wrap;
    	}
    	.g-cat-tab-btn {
        	flex-grow: 1;
        	font-size: 0.85em;
    	}
		.admin-table {
    		display: table; /* Força o comportamento de tabela */
    		table-layout: fixed;      /* Mantém as colunas rígidas */
    		border-collapse: collapse;
    		margin: 20px 0;
    		background: white;
    		border: 1px solid #ddd;
		}

		/* 3. Distribuição das colunas (Soma = 100%) */
		.admin-table th:nth-child(1) { width: 30%; } /* Militar */
		.admin-table th:nth-child(2) { width: 25%; } /* Contato */
		.admin-table th:nth-child(3) { width: 15%; } /* Perfil */
		.admin-table th:nth-child(4) { width: 15%; } /* Unidade */
		.admin-table th:nth-child(5) { width: 15%; } /* Ações */

.admin-table th, .admin-table td {
    padding: 12px 15px;
    border: 1px solid #eee;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Centralização para as colunas menores */
.admin-table th:nth-child(3), .admin-table td:nth-child(3),
.admin-table th:nth-child(5), .admin-table td:nth-child(5) {
    text-align: center;
}
		/* Container dos botões */
.user-form-actions {
    display: flex;
    justify-content: flex-end; /* Alinha tudo para a direita */
    gap: 12px;                 /* Espaço entre os botões */
    margin-top: 25px;          /* Afasta um pouco dos campos acima */
    width: 100%;
}

/* Ajuste nos botões para não serem 100% */
.user-form-actions button {
   width: auto;               /* Botão não ocupa mais a tela toda */
    min-width: 160px;          /* Tamanho mínimo para não ficar "espremido" */
    padding: 10px 20px;
    display: flex;             /* Flex no botão para centralizar o texto/ícone */
    align-items: center;
    justify-content: center;   /* Centraliza o texto dentro do botão */
    gap: 8px;                  /* Espaço entre o ícone e o texto */
    cursor: pointer;
    border-radius: 4px;
    font-weight: bold;
    border: none;
    transition: filter 0.2s;
}
		.user-form-actions button:hover {
    filter: brightness(0.9);   /* Efeito visual simples ao passar o mouse */
}

/* Estilo específico do botão excluir para manter o padrão perigoso */
.btn-danger {
    background-color: #d90f23;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
	text-transform: uppercase;
    transition: background 0.3s;
}

.btn-danger:hover {
    background-color: #a80a1a;
}
        @media (min-width: 769px) { 
            .sidebar-overlay { 
                display: none !important;
            }
    
            .dashboard-columns {
                flex-direction: row; 
                /* 💡 CORREÇÃO: Usamos stretch para que os dois blocos (op-card) 
                ocupem 100% da altura do bloco mais alto, igualando o tamanho. */
                align-items: stretch; 
                gap: 20px;
            }
            .dashboard-columns .op-card {
                flex: 1; 
            }
        }
            a.restricted-admin-only, div.menu-label.restricted-admin-only { 
    			display: none; 
			}
        /* Estilo específico para o botão de descarte do card de resumo */
.op-card.resume {
    position: relative; /* Necessário para posicionar o botão absoluto */
}
.btn-resume-close {
    position: absolute;
    top: 5px; 
    right: 5px; 
    background: none;
    border: none;
    color: #d90f23; 
    font-size: 1.4em; 
    cursor: pointer;
    padding: 5px;
    opacity: 0.9; 
    transition: color 0.2s, opacity 0.2s;
}
.btn-resume-close:hover {
    color: #FF3B3B; 
    opacity: 1;
}
        /* ==================================== */
/* ESTILOS ESPECÍFICOS DO FORMULÁRIO DE CAUTELAS */
/* ==================================== */

/* Layout de 2 colunas para campos principais no desktop */
.form-grid-2-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px; /* Espaçamento entre os campos */
}

/* Estilo geral para o grupo de campo */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #444;
}

/* Estilo para todos os inputs, selects e textareas */
.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box; /* CRÍTICO: Garante que padding e border não estourem a largura */
    font-size: 1em;
}

/* Área de Listagem/Seleção de Itens */
#itens-custodia-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
}
	/* Estilos específicos para a tabela do Almoxarifado */
#almox-table th {
    background-color: #800020;
    color: white;
}

#almox-body tr:hover {
    background-color: #fff5f5;
}

/* Badge de estoque disponível */
.stock-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
}

/* Efeito de destaque para a linha de distribuição (Detalhes) */
.distribuicao-row {
    background-color: #f9f9f9;
    border-left: 4px solid #2c7399;
}
		.btn-link-detalhe {
    background: none;
    border: none;
    color: #2c7399;
    text-decoration: underline;
    font-weight: bold;
    cursor: pointer;
    padding: 2px 5px;
}
.btn-link-detalhe:hover {
    color: #800020;
    background-color: #f0f0f0;
    border-radius: 4px;
}
	/* --- BLOCO ISOLADO: CADASTRO GLOBAL (CATÁLOGO) --- */

/* Container de abas exclusivo */
.g-cat-tabs-wrapper {
    display: flex;
    gap: 5px;
    border-bottom: 2px solid #eee;
    margin-bottom: 20px;
}

/* Botões de abas exclusivos */
.g-cat-tab-btn {
    padding: 10px 18px;
    border: none;
    background: #f1f1f1;
    cursor: pointer;
    font-weight: bold;
    color: #666;
    border-radius: 8px 8px 0 0;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
    font-family: inherit;
}

.g-cat-tab-btn:hover {
    background: #e9e9e9;
    color: #800020;
}

.g-cat-tab-btn.active {
    background: #fff;
    color: #800020;
    border-bottom: 3px solid #800020;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
}

/* Grid de formulário protegida */
.g-cat-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

/* Grupos de campos exclusivos */
.g-cat-field-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 15px;
    text-align: left;
}

.g-cat-field-group label {
    font-weight: bold;
    font-size: 0.85em;
    color: #444 !important;
    display: block;
}

/* Inputs exclusivos para não afetar os globais */
.g-cat-input {
    padding: 10px !important;
    border: 1px solid #ccc !important;
    border-radius: 6px !important;
    font-size: 1em !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

.g-cat-input:focus {
    border-color: #800020 !important;
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1) !important;
}

/* Área de Kit e Animação */
.g-cat-kit-box {
    margin-top: 15px;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
    border: 1px dashed #ccc;
    animation: gCatFadeIn 0.3s ease-out;
}

@keyframes gCatFadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
		
/* --- ESTILO DO CARD --- */
.unit-building-card {
    position: relative; /* ⬅️ ADICIONADO: Essencial para posicionar a lixeira no canto */
    background: white;
    border-radius: 12px;
    border: 1px solid #ddd;
    border-top: 6px solid #800020;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    /* Mantive sua transição original abaixo */
    transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease, opacity 0.5s ease; 
    overflow: hidden;
    display: flex;
    flex-direction: column;
	width: 100% !important;
	max-width: 100% !important;
	margin: 0 !important;
	box-sizing: border-box !important;
}
		.btn-delete-unit-card {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.8);
    color: #ccc; /* Cor apagada inicial */
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
}

.btn-delete-unit-card:hover {
    background: #d90f23;
    color: white !important; /* "Acende" em vermelho */
    transform: scale(1.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.unit-building-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

/* --- CONTROLE DO FORMULÁRIO (ABRIR/FECHAR) --- */
.new-local-section.collapsed {
    display: none !important;
}

.new-local-section {
    transition: all 0.3s ease-in-out;
}
		
		@keyframes pulse-highlight {
    		0% { background-color: #fff; transform: scale(1); }
    		50% { background-color: #ffecec; transform: scale(1.02); border-color: #800020; }
    		100% { background-color: #fff; transform: scale(1); }
		}
		.new-card-pulse {
    		animation: pulse-highlight 2s ease-in-out;
		}
		/* Container do Switch */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

/* Esconde o checkbox padrão */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* O trilho do switch */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}

/* A bolinha do switch */
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

/* Cor quando ativado (Roxo do Posto) */
input:checked + .slider {
  background-color: #8e44ad;
}

/* Movimento da bolinha */
input:checked + .slider:before {
  transform: translateX(20px);
}	

    </style>
</head>
<body>
	
    <div id="mobile-overlay" class="sidebar-overlay" onclick="closeMenuMobile()"></div>

   	<header class="main-header">
    	<button id="menu-btn" onclick="toggleMenuMobile()"><i class="fas fa-bars"></i></button>

    	<img src="logo_sigma.png" alt="Logo SIGMA-CBMRR" class="header-icon" 
         	style="margin-right: -10px;" 
         	onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/000000/fff?text=CBM'">
    
    		<div class="header-title-desktop">
        		<span class="text-white"> SISTEMA INTEGRADO DE GESTÃO DE MATERIAIS </span>
        		<span class="text-red"> CBMRR </span>
    		</div>

    		<div class="header-title-mobile">
        		<span class="text-white"> SIGMA </span><span class="text-red"> CBMRR </span>
    		</div>
    
    		<img src="logo_sigma.png" alt="Logo SIGMA" class="header-icon" 
         		style="opacity: 0;" 
         		onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=S'">

    		<div id="dashboard-greeting" style="display:none; margin-left: 20px; font-size: 0.9em; font-style: italic;">
        		Bem-vindo(a)! Preencha a conferência para hoje.
    		</div>
    		<button onclick="logout()" class="btn-modern-action btn-logout-header" style="margin-left: auto;">
        		<i class="fas fa-sign-out-alt"></i> 
    		</button>
	</header>
    
    <div class="sidebar" id="main-sidebar">
    <div class="sidebar-header" style="padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center;">
        <div id="unit-logo-container" style="margin-bottom: 15px;">
            <img src="logo_sigma.png" id="sidebar-logo" alt="Logo SIGMA" style="width: 55px; height: auto; filter: drop-shadow(0 0 8px rgba(255,255,255,0.2));">
        </div>
        <div id="sidebar-user-info">
            <span id="user-name" style="font-size: 0.9em; font-weight: 800; color: #fff; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;"></span>
            <div id="badge-wrapper"></div>
        </div>
    </div>

    <div class="menu-label" style="padding: 25px 20px 10px; font-size: 0.65em; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1.5px;">Operacional</div>
    
    <a onclick="switchView('dashboard')" id="link-dashboard" class="active">
        <i class="fas fa-chart-line"></i> <span>Dashboard & Serviço</span>
    </a>
    
    <a onclick="switchView('my-history')" id="link-my-history">
        <i class="fas fa-history"></i> <span>Minhas Atividades</span>
    </a>

    <div class="sigma-v3-menu-group">
    	<a href="javascript:void(0)" class="sigma-v3-dropdown-btn" onclick="toggleSubMenu('submenu-cautelas', this)" id="link-cautelas-group">
        	<i class="fas fa-inbox"></i> 
        	<span>Gestão de Cautelas</span>
        	<i class="fas fa-chevron-down arrow-icon"></i>
    	</a>
    	<div id="submenu-cautelas" class="sigma-v3-submenu" style="display: none;">
        	<a onclick="switchView('cautelas-nova')" id="link-cautelas-nova">
            	<i class="fas fa-plus-circle"></i> Nova Cautela
        	</a>
        	<a onclick="switchView('cautelas-ativas')" id="link-cautelas-ativas">
            	<i class="fas fa-file-signature"></i> Cautelas Ativas
        	</a>
        	<a onclick="switchView('cautelas-receber')" id="link-cautelas-receber">
            	<i class="fas fa-file-import"></i> Cautelas a Receber
        	</a>
        	<a onclick="switchView('cautelas-historico')" id="link-cautelas-historico">
            	<i class="fas fa-history"></i> Histórico de Cautelas
        	</a>
    	</div>
	</div>
		
    <div class="menu-label restricted-admin-only" id="sidebar-rotulo-admin" style="padding: 25px 20px 10px; font-size: 0.65em; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1.5px;">Administração</div>
    
    <a onclick="switchView('almoxarifado')" id="link-almoxarifado">
        <i class="fas fa-warehouse"></i> <span>Almoxarifado Central</span>
    </a>
    
    <a onclick="switchView('global-history')" id="link-global-history">
        <i class="fas fa-folder-open"></i> <span>Atividades da Unidade</span>
    </a>
    
    <a onclick="switchView('unidades')" id="link-unidades" class="restricted-admin-only">
        <i class="fas fa-building"></i> <span>Unidades</span>
    </a>
    
    <a onclick="switchView('postos')" id="link-postos" class="restricted-admin-only">
        <i class="fa-solid fa-flag"></i> <span>Postos</span>
    </a>
    
    <a onclick="switchView('vtr-bases')" id="link-vtr-bases" class="restricted-admin-only">
        <i class="fas fa-car"></i> <span>Viaturas</span>
    </a>
    
    <a onclick="switchView('usuarios')" id="link-usuarios" class="restricted-admin-only">
        <i class="fas fa-users"></i> <span>Usuários</span>
    </a>
    
    <a onclick="switchView('listas')" id="link-listas" style="display:none;">
        <i class="fas fa-clipboard-list"></i> <span>Gestão de Listas</span>
    </a>
</div>

    <div class="content">
        
        <div id="view-dashboard" class="view-section">
            <div class="greeting-card">
                <img id="greeting-photo" src="https://placehold.co/70x70/ffffff/800020?text=U" class="greeting-avatar">
                <div class="greeting-info">
                    <div class="greeting-text-wrapper"> 
                        <h2 id="greeting-text" class="greeting-title">Carregando...</h2>
                        <span id="greeting-name" class="greeting-user">...</span>
                        <span id="current-date" class="greeting-date">...</span>
                    </div>
                </div>
        
                <div class="main-actions-wrapper" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
					<button id="btn-open-conf-modal" class="btn-modern-action" style="background-color: #d90f23;" onclick="openNewConferenceModal()">
                    	<i class="fas fa-clipboard-list"></i> Conferência de Materiais
                	</button>
					<button id="btn-open-vtr-modal" class="btn-modern-action" style="background-color: #2c3e50; flex: 1; min-width: 160px;" onclick="prepararChecklistVtr()">
            			<i class="fas fa-car"></i> Checklist Viatura
        			</button>
				</div>
            </div>

            <div id="resume-container"></div>
            <div id="dashboard-content-by-role">
                <div id="admin-gestor-cards-container"></div>
                <div id="operacional-cards-container"></div>
            </div>
    
            <div id="ca-table-wrapper" class="sigma-v3-details-wrapper" style="display: none;">
    			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        			<h2 id="table-title" style="margin:0; color:#800020; font-size: 1.4em;"></h2>
        			<button onclick="fecharTabela()" class="btn-modern-action btn-delete" style="height: 35px; padding: 0 20px;">Fechar</button>
    			</div>
    
    			<div id="sigma-v3-dynamic-grid" class="sigma-v3-details-grid"></div>

    			<div id="no-issues-msg" style="display:none; padding:40px; text-align:center; color:#1b8a3e; font-weight: bold;">
        			<i class="fas fa-check-double fa-2x"></i><br>Nenhuma pendência ativa nesta viatura.
    			</div>
			</div>
        </div>
        
        <div id="view-my-history" class="view-section">
    		<div class="sigma-v3-clean-wrapper">
        		<div class="sigma-v3-title-label">
            		<i class="fas fa-history" style="color: #800020;"></i>
            		<span>Histórico Pessoal de Atividades</span>
        		</div>

        		<div style="display: flex; flex-wrap: wrap; gap: 15px; background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); padding: 15px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 30px; align-items: flex-end;">
            
            		<div style="flex: 1; min-width: 140px;">
                		<label style="display:block; font-size: 0.7em; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; margin-left: 5px;">Data Inicial</label>
                		<input type="date" id="my-hist-start" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.9em; color: #1e293b;">
            		</div>

            		<div style="flex: 1; min-width: 140px;">
                		<label style="display:block; font-size: 0.7em; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; margin-left: 5px;">Data Final</label>
                		<input type="date" id="my-hist-end" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.9em; color: #1e293b;">
            		</div>

            		<button onclick="loadMyHistory()" style="background: #800020; color: #fff; border: none; padding: 11px 25px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(128, 0, 32, 0.2);">
                		<i class="fas fa-filter"></i> <span class="hide-mobile">Filtrar</span>
            		</button>
        		</div>

        		<div id="my-history-list" class="sigma-v3-timeline">
            	</div>
    		</div>
		</div>
		
    	<div id="view-global-history" class="view-section">
    		<div class="sigma-v3-clean-wrapper">
        		<div class="sigma-v3-title-label">
            		<i class="fas fa-folder-tree" style="color: #800020;"></i>
            		<span>Gestão de Registros da Unidade</span>
        		</div>

        		<div style="display: flex; flex-wrap: wrap; gap: 12px; background: rgba(255,255,255,0.7); backdrop-filter: blur(12px); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 10px 30px rgba(0,0,0,0.04); margin-bottom: 35px; align-items: flex-end;">
            
            		<div style="flex: 1 1 200px;">
                		<label style="display:block; font-size: 0.65em; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; margin-left: 5px;"><i class="fas fa-user"></i> Militar</label>
                		<select id="glob-hist-user" style="width: 100%; padding: 11px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.85em; color: #1e293b; outline: none;"></select>
            		</div>

            		<div style="flex: 1 1 180px;">
                		<label style="display:block; font-size: 0.65em; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; margin-left: 5px;"><i class="fas fa-truck-pickup"></i> Localização</label>
                		<select id="glob-hist-local" style="width: 100%; padding: 11px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.85em; color: #1e293b; outline: none;"></select>
            		</div>

            		<div style="flex: 1 1 140px;">
                		<label style="display:block; font-size: 0.65em; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; margin-left: 5px;">Início</label>
                		<input type="date" id="glob-hist-start" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.85em;">
            		</div>

            		<div style="flex: 1 1 140px;">
                		<label style="display:block; font-size: 0.65em; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; margin-left: 5px;">Fim</label>
                		<input type="date" id="glob-hist-end" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.85em;">
            		</div>

            		<button onclick="loadGlobalHistory()" style="background: #1e293b; color: #fff; border: none; padding: 12px 25px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(30, 41, 59, 0.25);">
                		<i class="fas fa-filter"></i> <span>Filtrar</span>
            		</button>
        		</div>

        		<div id="global-history-list" class="sigma-v3-timeline">
            	</div>
    		</div>
		</div>
		
    	<div id="view-usuarios" class="view-section">
    		<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        		<h1>Gestão de Usuários</h1>
        		<button id="btn-toggle-usuario" class="btn-secondary" onclick="controlarToggleUsuario()">
            		<i class="fas fa-user-plus"></i> Novo Militar
        		</button>
    		</div>

    		<div id="form-cadastro-usuario" class="new-local-section collapsed" style="border-top: 4px solid #800020;">
        
        		<input type="hidden" id="edit-user-uid" value="">
        
        		<h3 id="titulo-form-usuario"><i class="fas fa-user-shield"></i> Cadastrar Novo Militar</h3>
        
        		<div class="form-grid-2-columns" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            		<div class="form-group"><label>Nome Civil Completo</label><input type="text" id="new-user-completo" placeholder="NOME COMPLETO"></div>
            		<div class="form-group"><label>Nome de Guerra</label><input type="text" id="new-user-guerra" placeholder="EX: JHONATH"></div>
            
            		<div class="form-group">
                		<label>Posto / Graduação</label>
                		<select id="new-user-posto">
                    		<option value="" disabled selected>Selecione o Posto</option>
                    		<option value="CEL">CEL</option>
                    		<option value="TEN CEL">TEN CEL</option>
                    		<option value="MAJ">MAJ</option>
                    		<option value="CAP">CAP</option>
                    		<option value="1º TEN">1º TEN</option>
                    		<option value="2º TEN">2º TEN</option>
                    		<option value="ST">ST</option>
                    		<option value="1º SGT">1º SGT</option>
                    		<option value="2º SGT">2º SGT</option>
                    		<option value="3º SGT">3º SGT</option>
                    		<option value="CB">CB</option>
                    		<option value="SD">SD</option>
                		</select>
            		</div>

            		<div class="form-group">
                		<label>Quadro</label>
                		<select id="new-user-quadro" disabled>
                    		<option value="" disabled selected>Selecione o Posto acima</option>
                		</select>
            		</div>

            		<div class="form-group"><label>CPF (Login Principal)</label><input type="text" id="new-user-cpf" placeholder="000.000.000-00" maxlength="14"></div>
            		<div class="form-group"><label>Matrícula</label><input type="text" id="new-user-matricula" placeholder="0000000-000" maxlength="11"></div>
            		<div class="form-group"><label>Telefone para Contato</label><input type="text" id="new-user-telefone" placeholder="(00) 00000-0000" maxlength="15"></div>
            		<div class="form-group"><label>Email de Contato</label><input type="email" id="new-user-email" placeholder="militar@email.com"></div>
            
            		<div class="form-group" id="group-new-user-password">
                		<label>Senha de Acesso (Mín. 6 dígitos)</label>
                		<input type="password" id="new-user-password" placeholder="Defina a senha">
            		</div>

            		<div class="form-group">
                		<label>Perfil de Acesso</label>
                		<select id="new-user-role">
                    		<option value="operacional">Operacional</option>
                    		<option value="gestor">Gestor de Unidade</option>
                    		<option value="admin">Administrador Geral</option>
                		</select>
            		</div>

            		<div class="form-group">
                		<label>Unidade</label>
                		<select id="new-user-unit"><option value="">Carregando Unidades...</option></select>
            		</div>
        		</div>
        
        		<div class="user-form-actions">
					<button id="btn-usuario-acao-principal" class="btn-modern-action btn-create" onclick="executarAcaoUsuario()">
        				<i class="fas fa-save"></i> Gravar Militar
    				</button>

    				<button id="btn-usuario-excluir" class="btn-danger" onclick="excluirUsuario()" style="display: none;">
        				<i class="fas fa-trash-alt"></i> Excluir Militar
    				</button>
				</div>
    		</div>

    		<div style="border-bottom: 2px solid #800020; margin-bottom: 20px; padding-bottom: 10px; margin-top: 30px;">
        		<h2 style="margin: 0; color: #800020;"><i class="fas fa-users"></i> MILITARES CADASTRADOS</h2>
    		</div>

    		<div class="form-group" style="margin-bottom: 20px;">
        		<div style="position: relative;">
            		<i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #666;"></i>
            		<input type="text" id="user-search-input" placeholder="Buscar por nome, posto ou guerra..." 
                   class="filter-input" style="padding-left: 35px;" oninput="filtrarUsuarios()">
        		</div>
    		</div>
			
			<div class="table-wrapper" style="width: 100%; overflow-x: auto;">
    			<table class="admin-table" style="width: 100%; table-layout: fixed; border-collapse: collapse;">
        			<thead>
            			<tr>
                			<th>Militar</th>
                			<th>Telefone</th> 
                			<th>Perfil</th>
                			<th>Unidade</th>
                			<th>Ações</th>
            			</tr>
        			</thead>
        			<tbody id="users-table-body">
            		</tbody>
    			</table>
			</div>
		</div>
		
  		<div id="view-unidades" class="view-section">
    		<div class="sigma-v3-title-label" style="margin-bottom: 20px;">
        		<i class="fas fa-sitemap" style="color: #800020;"></i>
        		<span>GESTÃO DE UNIDADES</span>
    		</div>

    		<div class="header-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        		<div>
            		<p style="color: #64748b; font-size: 0.85em; font-weight: 600; margin: 0;">
                		Unidades <i class="fas fa-chevron-right" style="font-size: 0.7em; margin: 0 5px;"></i> Gestão de Unidades
            		</p>
        		</div>
        		<div class="global-actions">
            		<button class="sigma-v3-tab active" onclick="abrirFormularioUnidade()" style="background: #800020; color: white; border: none; height: 42px; padding: 0 20px;">
                		<i class="fas fa-plus-circle"></i> NOVA UNIDADE
            		</button>
        		</div>
    		</div>

    		<div class="sigma-v3-clean-card" style="margin-bottom: 25px; padding: 20px;">
        		<div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            		<div class="filter-item" style="flex: 1; min-width: 280px;">
                		<label style="display: block; font-weight: 800; font-size: 0.7em; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
                    		<i class="fas fa-search"></i> Localizar Sigla, Nome ou Comandante
                		</label>
                		<div style="position: relative;">
                    		<i class="fas fa-search" style="position: absolute; left: 15px; top: 12px; color: #94a3b8;"></i>
                    		<input type="text" id="input-busca-unidade" onkeyup="filtrarUnidadesCards()" 
                           	placeholder="Ex: 1º BBM, CCI, COMANDO..." 
                           	style="width: 100%; padding: 10px 10px 10px 40px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; outline: none; box-sizing: border-box; font-size: 0.9em;">
                		</div>
            		</div>
        		</div>
    		</div>

    		<div id="units-cards-container" class="v3-vtr-grid">
        	</div>
		</div>
  
    	<div id="view-postos" class="view-section">
    		<div class="sigma-v3-title-label" style="margin-bottom: 20px;">
    			<i class="fas fa-map-marked-alt" style="color: #800020;"></i>
    			<span>Gestão de Postos e Bases</span>
			</div>

    		<div class="header-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        		<div>
            		<p style="color: #64748b; font-size: 0.85em; font-weight: 600; margin: 0;">
                		Postos <i class="fas fa-chevron-right" style="font-size: 0.7em; margin: 0 5px;"></i> Gestão de Postos e Bases
            		</p>
        		</div>
        		<div class="global-actions">
    				<button id="btn-toggle-posto" class="sigma-v3-tab active" onclick="abrirFormularioPosto()" style="background: #800020; color: white; border: none;">
        				<i class="fas fa-plus-circle"></i> Novo Posto
    				</button>
				</div>
    		</div>

    		<div class="sigma-v3-clean-card" style="margin-bottom: 25px; padding: 20px;">
        		<div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            		<div class="filter-item" style="flex: 1; min-width: 280px;">
                		<label style="display: block; font-weight: 800; font-size: 0.7em; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
                    		<i class="fas fa-search"></i> Localizar Posto ou Endereço
                		</label>
                		<div style="position: relative;">
                    		<i class="fas fa-search" style="position: absolute; left: 15px; top: 12px; color: #94a3b8;"></i>
                    		<input type="text" id="input-busca-posto" 
                           		onkeyup="filtrarPostosCards()" 
                           		placeholder="Ex: Prontidão Alfa, Guarita, Endereço..." 
                           		style="width: 100%; padding: 10px 10px 10px 40px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 0.9em; box-sizing: border-box; outline: none;">
                		</div>
            		</div>
        		</div>
    		</div>

    		<div id="postos-cards-container" class="cards-grid">
        	</div>
		</div>
		
		<div id="view-vtr-bases" class="view-section">
    <div class="sigma-v3-title-label" style="margin-bottom: 20px;">
        <i class="fas fa-car" style="color: #2c7399;"></i>
        <span>Gestão de Viaturas</span>
    </div>

    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        <p style="color: #64748b; font-size: 0.85em; font-weight: 600; margin: 0;">
            Viaturas <i class="fas fa-chevron-right" style="font-size: 0.7em; margin: 0 5px;"></i> Gestão de Viaturas
        </p>
        <div class="global-actions">
            <button id="btn-toggle-vtr-base" class="sigma-v3-tab active" onclick="abrirFormularioViatura()" style="background: #2c7399; color: white; border: none;">
                <i class="fas fa-plus-circle"></i> Nova Viatura
            </button>
        </div>
    </div>

    <div class="sigma-v3-clean-card" style="margin-bottom: 25px; padding: 20px;">
    	<div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
        
        	<div class="filter-item" style="flex: 1; min-width: 280px;">
            	<label style="display: block; font-weight: 800; font-size: 0.7em; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Localizar Prefixo ou Placa</label>
            	<div style="position: relative;">
                	<i class="fas fa-search" style="position: absolute; left: 15px; top: 12px; color: #94a3b8;"></i>
                	<input type="text" id="input-busca-vtr" onkeyup="filtrarViaturasCards()" placeholder="Ex: ABT-10, ABS-05..." 
                       style="width: 100%; padding: 10px 10px 10px 40px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; outline: none; box-sizing: border-box;">
            	</div>
        	</div>

        	<div class="filter-item" style="width: 200px;">
            	<label style="display: block; font-weight: 800; font-size: 0.7em; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Status Operativo</label>
            	<select id="filtro-vtr-status" onchange="filtrarViaturasCards()" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; outline: none; font-weight: 600; color: #475569; height: 42px;">
                	<option value="todos">TODOS OS ATIVOS</option>
                	<option value="ativo">PRONTO (OPERATIVO)</option>
                	<option value="manutencao">BAIXADO (MANUTENÇÃO)</option>
                	<option value="reserva">RESERVA</option>
            	</select>
        	</div>
        
    	</div>
	</div>

    <div id="vtr-bases-cards-container" class="v3-vtr-grid">
        </div>
</div>
			
		<div id="view-almoxarifado" class="view-section">
    		<div class="sigma-v3-title-label" style="margin-bottom: 20px;">
        		<i class="fas fa-warehouse" style="color: #800020;"></i>
        		<span>Almoxarifado Central</span>
    		</div>

    		<div class="header-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        		<div>
            		<p id="almox-breadcrumb" style="color: #64748b; font-size: 0.85em; font-weight: 600; margin: 0;">
                		Logística <i class="fas fa-chevron-right" style="font-size: 0.7em; margin: 0 5px;"></i> Inventário Geral
            		</p>
        		</div>
        		<div class="global-actions" style="display: flex; gap: 10px;">
            		<button id="btn-novo-cadastro-global" class="sigma-v3-tab active" onclick="abrirModalCadastroGlobal()" style="display: none; background: #800020; color: white;">
                		<i class="fas fa-plus-circle"></i> Novo Cadastro
            		</button>
            		<button class="sigma-v3-tab" onclick="imprimirInventario()" style="background: white; border: 1px solid #e2e8f0; color: #475569;">
                		<i class="fas fa-print"></i> Relatório PDF
            		</button>
        		</div>
    		</div>

    		<div class="sigma-v3-clean-card" style="margin-bottom: 25px; padding: 20px;">
    			<div id="almox-filtros-container" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
        
        			<div class="filter-item" style="flex: 2; min-width: 280px;">
            			<label style="display: block; font-weight: 800; font-size: 0.7em; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
                			<i class="fas fa-search"></i> Pesquisar Material
            			</label>
            			<div class="custom-input-group" style="position: relative;">
                			<i class="fas fa-search" style="position: absolute; left: 15px; top: 12px; color: #94a3b8;"></i>
                			<input type="text" id="almox-search" placeholder="Ex: Mangueira, EPR, Lanterna..." 
                       			oninput="filtrarAlmoxarifado()" 
                       			style="width: 100%; padding: 10px 10px 10px 40px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 0.9em; box-sizing: border-box;">
            			</div>
        			</div>

        			<div class="filter-item" style="flex: 1; min-width: 220px;">
            			<label style="display: block; font-weight: 800; font-size: 0.7em; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
                			<i class="fas fa-filter"></i> Categoria
            			</label>
            			<select id="almox-cat-filter" onchange="filtrarAlmoxarifado()" 
                    		style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 0.9em; color: #475569; height: 41px; box-sizing: border-box;">
                			<option value="">Todas as Categorias</option>
                			<option value="EPI">EPI</option>
                			<option value="ELETRÔNICO">ELETRÔNICO</option>
                			<option value="FERRAMENTA">FERRAMENTA</option>
                			<option value="ACESSÓRIO">ACESSÓRIO</option>
                			<option value="EQUIPAMENTO">EQUIPAMENTO</option>
                			<option value="COMUNICAÇÃO">COMUNICAÇÃO</option>
            			</select>
        			</div>
        
    			</div>
			</div>

    		<div id="almox-main-display" class="sigma-v3-clean-card">
        
        		<div id="container-tabela-principal" class="table-responsive">
            		<table class="sigma-v3-table" id="almox-table">
                		<thead>
                    		<tr>
                        		<th>Material</th>
                        		<th style="text-align: center;">Total</th>
                        		<th style="text-align: center;">Em Uso</th>
                        		<th style="text-align: center;">Pendente</th>
                        		<th style="text-align: center;">Disponível</th>
                        		<th style="text-align: center;">Ações</th>
                    		</tr>
                		</thead>
                		<tbody id="almox-body">
                    		<tr>
                        		<td colspan="6" style="text-align:center; padding:60px; color:#64748b;">
                            		<i class="fas fa-sync fa-spin fa-2x" style="opacity:0.3; margin-bottom:15px; display:block;"></i>
                            		<span style="font-weight:600;">Sincronizando Banco de Dados...</span>
                        		</td>
                    		</tr>
                		</tbody>
            		</table>
        		</div>

        		<div id="almox-rastreio-wrapper" style="display: none; animation: fadeIn 0.3s ease;">
		            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom: 2px solid #f1f5f9;">
                		<div>
                    		<h3 id="rastreio-title" style="margin:0; color:#800020; font-size: 1.1em;">Rastreio de Localização</h3>
                    		<small style="color: #94a3b8;">Detalhamento por unidade e carga</small>
                		</div>
                		<button onclick="carregarAlmoxarifadoUI()" class="sigma-v3-tab" style="background: #f1f5f9;">
                    		<i class="fas fa-times"></i> Fechar
                		</button>
            		</div>
            		<div class="table-responsive">
                		<table class="sigma-v3-table">
                    		<thead id="almox-rastreio-thead">
                        		<tr>
                            		<th>Localização</th>
                            		<th style="text-align:center;">Total</th>
                            		<th style="text-align:center;">Disponível</th>
                            		<th style="text-align:center;">Status/Tomb</th>
                            		<th style="text-align:right;">Ações</th>
                        		</tr>
                    		</thead>
                    		<tbody id="almox-rastreio-body"></tbody>
                		</table>
            		</div>
        		</div>
    		</div>
		</div>
			
        <div id="view-cautelas" class="view-section">
    		<div class="sigma-v3-clean-wrapper">
        		<div id="cautelas-content"></div>
    		</div>
		</div>

		<div id="menu-editor-listas" class="view-section">
    		<div class="sigma-v3-title-label" style="margin-bottom: 20px;">
        		<i class="fas fa-clipboard-list" style="color: #2c7399;"></i>
        		<span>GESTÃO DE LISTAS DE CONFERÊNCIA</span>
    		</div>

    		<div class="header-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        		<div>
            		<p style="color: #64748b; font-size: 0.85em; font-weight: 600; margin: 0;">
                		Administração <i class="fas fa-chevron-right" style="font-size: 0.7em; margin: 0 5px;"></i> Inventários e Listas Mestra
            		</p>
        		</div>
        		<div class="global-actions">
            		<button class="sigma-v3-tab active" onclick="abrirFormularioLista()" style="background: #2c7399; color: white; border: none; height: 42px; padding: 0 20px;">
                		<i class="fas fa-plus-circle"></i> NOVA LISTA
            		</button>
        		</div>
    		</div>

    		<div class="sigma-v3-clean-card" style="margin-bottom: 25px; padding: 20px;">
        		<div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            		<div class="filter-item" style="flex: 1; min-width: 280px;">
                		<label style="display: block; font-weight: 800; font-size: 0.7em; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
                    		<i class="fas fa-search"></i> Localizar Prefixo ou Posto Vinculado
                		</label>
                		<div style="position: relative;">
                    		<i class="fas fa-search" style="position: absolute; left: 15px; top: 12px; color: #94a3b8;"></i>
                    		<input type="text" id="filter-lista-busca" onkeyup="filtrarCardsListas()" 
                           	placeholder="Ex: ABT-17, Pátio, Alfa..." 
                           	style="width: 100%; padding: 10px 10px 10px 40px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; outline: none; box-sizing: border-box; font-size: 0.9em;">
                		</div>
            		</div>
        		</div>
    		</div>

    		<div id="container-cards-listas" class="v3-vtr-grid">
        	</div>
		</div>

		<div id="view-editor-arquitetura" class="view-section" style="display:none; padding: 0 !important;">
    
    		<div class="editor-header-sticky">
        		<div class="editor-nav-bar">
            		<button onclick="fecharEditorArquitetura()" class="btn-back-editor">
                		<i class="fas fa-arrow-left"></i> Sair do Editor
            		</button>
            		<div class="editor-title-container">
                		<h2 id="edit-vtr-nome">ABT-17</h2>
                		<small id="edit-vtr-unidade">Unidade: CCI</small>
            		</div>
            		<div class="editor-actions">
                		<button onclick="confirmarPublicacaoLista()" class="btn-publish">
                    		<i class="fas fa-cloud-upload-alt"></i> Publicar Alterações
                		</button>
            		</div>
        		</div>

        		<div class="editor-search-bar" style="display: flex; align-items: center; gap: 10px; padding: 0 15px 15px 15px; box-sizing: border-box; flex-wrap: wrap;">
    				<div class="search-input-wrapper" style="position: relative; flex: 1.5; min-width: 0;">
        				<i class="fas fa-plus-circle" id="icon-plus-busca"></i>
        				<input type="text" id="input-busca-estoque" placeholder="Adicionar item..." oninput="buscarItemParaAdicionar(this.value)" style="width: 100%; box-sizing: border-box;">
        
        				<div id="rascunho-item-novo" style="display:none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; align-items: center; padding: 0 10px; border-radius: 6px; z-index: 5; border: 1px solid #cbd5e1; box-sizing: border-box; justify-content: space-between;">
            				<div id="texto-item-rascunho" style="font-size: 0.85em; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Inter', sans-serif;"></div>
            				<button onclick="cancelarRascunho()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size: 1.2em;">&times;</button>
        				</div>
        				<div id="sugestoes-estoque-editor" class="suggestions-box"></div>
    				</div>

    				<div class="target-sector-wrapper" style="flex: 1; min-width: 180px;">
        				<select id="select-setor-destino" onchange="adicionarItemRapido()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; cursor: pointer;">
            				<option value="">Selecione o Setor Destino...</option>
        				</select>
    				</div>
				</div>
				
				<div id="popover-qtd-editor" style="display:none; position: absolute; z-index: 1001; background: white; border: 1px solid #2c7399; padding: 15px; border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); width: 200px;">
    				<label style="font-size: 0.75em; font-weight: bold; color: #64748b; display: block; margin-bottom: 8px;">QUANTIDADE:</label>
    				<div style="display: flex; gap: 5px;">
        				<input type="number" id="input-qtd-popover" value="1" min="1" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        				<button onclick="confirmarQtdPopover()" style="background: #1b8a3e; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
            				<i class="fas fa-check"></i>
        				</button>
    				</div>
    				<small id="info-max-popover" style="font-size: 0.7em; color: #d32f2f; margin-top: 5px; display: block;"></small>
				</div>
    		</div>

    		<div class="editor-main-layout">
        
        		<div id="setores-drag-container" class="editor-setores-grid">
            	</div>

        		<div id="caixa-estorno-dock" class="estorno-dock-minimized">
    				<div class="estorno-header" onclick="toggleEstornoDock()">
        				<div class="header-left">
            				<i class="fas fa-archive"></i> 
            				<span>Caixa de Saída</span>
            				<span id="badge-estorno-count" class="badge-voador">0</span>
        				</div>
        				<i class="fas fa-chevron-up toggle-icon"></i>
    				</div>
    
    				<div id="estorno-expandable-content" class="estorno-content-wrapper">
        				<div id="lista-itens-estorno" class="estorno-body">
            				<p class="empty-estorno">Nenhum item para devolução.</p>
        				</div>
        				<div class="estorno-footer">
            				<label>Justificativa Global:</label>
            				<textarea id="justificativa-estorno-global" placeholder="Descreva o motivo do estorno..."></textarea>
            				<button onclick="processarEstornoLote()" class="btn-confirm-estorno">Confirmar e Devolver ao Estoque</button>
        				</div>
    				</div>
				</div>

    			<button class="fab-add-setor" onclick="abrirModalNovoSetor()">
        			<i class="fas fa-folder-plus"></i>
    			</button>
			</div>
		</div>
	</div>
    
    <div id="app-runner-container"><iframe id="app-iframe" src=""></iframe></div>
	
	<div id="modal-gestao-ca" class="modal-overlay">
    	<div class="modal-content">
        	<button class="close-btn" onclick="document.getElementById('modal-gestao-ca').style.display='none'"><i class="fas fa-times"></i></button>
        	<h2>Gerenciar Pendência</h2>
        	<p id="gestao-item-nome" style="color:#800020; font-weight:bold; margin-bottom:5px; padding-bottom:0;"></p>
        
        	<input type="hidden" id="gestao-doc-id">
        	<input type="hidden" id="gestao-item-id-lista">
        	<input type="hidden" id="gestao-pendencia-id"> 
        	<input type="hidden" id="gestao-item-max-qtd">
        
        	<label>Ação do Gestor</label>
        	<select id="gestao-status" onchange="toggleGestaoQtd()">
            	<option value="Solucionado">Resolver Pendência</option>
            	<option value="Em solução">Em solução </option>
            	<option value="Cautelado">Passar para Cautela Administrativa</option>
        </select>
    
        <div id="div-gestao-qtd" style="display:none; margin-top: 10px;">
            <label style="color:#d90f23;">Quantidade a Resolver/Tratar:</label>
            <input type="number" id="gestao-qtd" min="1" value="1">
            <small id="gestao-qtd-info" style="color:#666; font-size:0.85em; display: block; margin-top: 2px;"></small>
        </div>
    
        <label style="margin-top: 15px;">Anotação Técnica / Despacho (Obrigatório)</label>
        <textarea id="gestao-obs" style="min-height: 100px;" placeholder="Descreva a solução ou o andamento da manutenção deste item específico..."></textarea>
        
        <div class="modal-buttons">
            <button class="btn-modern-action btn-backup" onclick="document.getElementById('modal-gestao-ca').style.display='none'">Cancelar</button>
            <button class="btn-modern-action btn-sync" onclick="salvarGestaoCa()">Salvar Ação</button>
        </div>
    </div>
</div>
    
	<div id="cautelaDetailsModal" class="modal-overlay">
    	<div class="modal-content" style="max-width: 700px;">
    		<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px;">
        		<h3 style="margin: 0; color: #800020;"><i class="fas fa-clipboard-list"></i> Detalhes da Cautela <span id="modal-cautela-id"></span></h3>
        		<button class="close-btn" onclick="document.getElementById('cautelaDetailsModal').style.display='none'" style="position:static; margin-left:15px;"><i class="fas fa-times"></i></button>
    		</div>

    		<div class="form-area" style="padding: 15px; border: none; box-shadow: none; background-color: #f9f9f9; margin-bottom: 15px; border-radius: 8px;">
        		<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            		<div><label>Emitente:</label><span id="modal-emitente" class="info-value"></span></div>
            		<div><label>Destinatário:</label><span id="modal-destinatario-original" class="info-value"></span></div>
            		<div><label>Recebedor Atual:</label><span id="modal-destinatario-atual" class="info-value"></span></div>
            
            		<div><label>Local de Origem:</label><span id="modal-local-origem" class="info-value"></span></div>
            		<div><label>Data de Emissão:</label><span id="modal-data-emissao" class="info-value"></span></div>
            		<div><label>Status:</label><span id="modal-status-text" class="info-value"></span></div>
        		</div>
        
        		<label>Observações da Emissão:</label>
        		<div id="modal-obs-emissao" style="background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee; min-height: 40px; font-size: 0.9em; font-style: italic; margin-bottom: 15px;"></div>

        		<label><i class="fas fa-stream"></i> Histórico de Movimentações:</label>
        		<div id="modal-historico-movimentacoes" style="background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee; max-height: 150px; overflow-y: auto; font-size: 0.85em;">
            		<p style="color: #999; text-align: center;">Nenhuma movimentação registrada.</p>
        		</div>
    		</div>
    
    		<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px;">
        		<h4 style="color: #800020; margin: 0;">Itens Cautelados:</h4>
        		<button id="btn-reportar-problema" class="btn-modern-action" style="display:none; background-color: #f57c00; font-size: 0.75em; padding: 5px 10px;" onclick="iniciarFluxoSubstituicao()">
            		<i class="fas fa-exclamation-triangle"></i> Substituir/Reportar
        		</button>
    		</div>

    		<ul id="modal-itens-cautela" class="cautela-item-list" style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 0; list-style: none;"></ul>
    
    		<div class="modal-actions" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
        		<button class="btn-modern-action" id="btn-receber-cautela" style="display: none; background-color: #1b8a3e;">
            		<i class="fas fa-check-circle"></i> Iniciar Recebimento
        		</button>
        
        		<button class="btn-modern-action btn-delete" id="btn-devolver-cautela" style="display: none;">
            		<i class="fas fa-undo"></i> Iniciar Devolução
        		</button>
        
        		<button class="btn-modern-action btn-sync" id="btn-confirmar-devolucao" style="display: none;">
            		<i class="fas fa-handshake"></i> Confirmar Devolução
        		</button>
        
        		<button class="modal-btn-cancel" onclick="document.getElementById('cautelaDetailsModal').style.display='none'">Fechar</button>
    		</div>
		</div>
	</div>
		
		<div id="modalReportarItem" class="modal-overlay" style="display:none; z-index: 30000;">
    		<div class="modal-content" style="max-width: 600px;">
        		<h3 style="color: #800020;"><i class="fas fa-exclamation-triangle"></i> Reportar Problemas nos Itens</h3>
        		<p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Selecione os itens danificados e descreva o que houve com cada um:</p>
        
        		<div id="lista-itens-reporte" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa;">
        		</div>

        		<div class="form-group" style="margin-top: 15px; text-align: left;">
            		<label style="font-weight: bold; color: #800020; font-size: 0.9em;"><i class="fas fa-user-shield"></i> Enviar para análise do Gestor:</label>
            		<select id="select-gestor-alvo" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #800020; background: #fff5f5; font-weight: bold; margin-top: 5px;">
                		<option value="" disabled selected>Buscando gestores da unidade...</option>
            		</select>
        		</div>

        		<div class="modal-actions" style="margin-top: 20px;">
            		<button class="btn-modern-action" style="background-color: #f57c00;" onclick="salvarRelatosMultiplos()">
                		<i class="fas fa-paper-plane"></i> Enviar Pendências ao Gestor
            		</button>
            		<button class="modal-btn-cancel" onclick="fecharModalReporte()">Cancelar</button>
        		</div>
    		</div>
		</div>

		<div id="modalDecisaoGestor" class="modal-overlay" style="display:none; z-index: 30005;">
    		<div class="modal-content" style="max-width: 500px; border-top: 5px solid #f57c00;">
        		<h3 style="color: #800020;"><i class="fas fa-gavel"></i> Decisão do Gestor</h3>
        		<p id="info-item-decisao" style="background: #f9f9f9; padding: 10px; border-radius: 5px; font-size: 0.9em; text-align: left; border: 1px solid #eee;"></p>

        		<div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            		<button class="btn-modern-action" style="background-color: #1b8a3e; justify-content: flex-start; padding: 15px; height: auto;" onclick="prepararSubstituicaoFisica()">
                		<i class="fas fa-sync-alt"></i> 
                		<div style="text-align: left; margin-left: 10px;">
                    		<b>Substituir Material</b><br>
                    		<small style="text-transform: none; font-weight: normal; opacity: 0.9;">Retira item novo do estoque e recebe o danificado.</small>
                		</div>
            		</button>

            		<button class="btn-modern-action" style="background-color: #5d6d7e; justify-content: flex-start; padding: 15px; height: auto;" onclick="executarRecolhimentoApenas()">
                		<i class="fas fa-arrow-down"></i> 
                		<div style="text-align: left; margin-left: 10px;">
                    		<b>Apenas Recolher (Baixa)</b><br>
                    		<small style="text-transform: none; font-weight: normal; opacity: 0.9;">Recebe o item danificado e reduz a carga da cautela.</small>
                		</div>
            		</button>

            		<button class="modal-btn-cancel" onclick="document.getElementById('modalDecisaoGestor').style.display='none'" style="margin-top: 10px;">Cancelar</button>
        		</div>
    		</div>
		</div>

		<div id="modalSeletorEstoque" class="modal-overlay" style="display:none; z-index: 30006;">
    		<div class="modal-content" style="max-width: 600px; border-top: 5px solid #1b8a3e;">
        		<h3 style="color: #1b8a3e;"><i class="fas fa-search-location"></i> Selecionar Item de Reposição</h3>
        		<p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
            		Buscando itens do mesmo tipo disponíveis em todas as suas listas.
        		</p>

        		<div id="listaEstoqueDisponivel" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; padding: 5px;">
            		<div style="text-align: center; color: #999; padding: 20px;">
                		Carregando estoque disponível...
            		</div>
        		</div>

        		<button class="modal-btn-cancel" onclick="document.getElementById('modalSeletorEstoque').style.display='none'" style="margin-top: 20px; width: 100%;">Fechar</button>
    		</div>
		</div>
		
		<div id="modal-detalhe-carimbos" class="modal-overlay" style="display:none; z-index: 30007;">
    		<div class="modal-content" style="max-width: 500px; border-top: 5px solid #5d6d7e;">
        		<button class="close-btn" onclick="document.getElementById('modal-detalhe-carimbos').style.display='none'"><i class="fas fa-times"></i></button>
        		<h3 id="titulo-modal-carimbo" style="margin-bottom: 15px; color: #800020;">Detalhes do Item</h3>
        		<div id="corpo-modal-carimbo" style="max-height: 400px; overflow-y: auto; padding: 5px;">
            	</div>
        		<div style="margin-top: 20px; text-align: right;">
            		<button class="btn-secondary" onclick="document.getElementById('modal-detalhe-carimbos').style.display='none'">Fechar Janela</button>
        		</div>
    		</div>
		</div>
	
		<div id="modal-cadastro-global" class="modal-overlay" style="display:none; z-index: 31000;">
    		<div class="modal-content" style="max-width: 700px; border-top: 5px solid #800020;">
        		<button class="close-btn" onclick="fecharModalCadastroGlobal()"><i class="fas fa-times"></i></button>
        
        		<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
            		<i class="fas fa-dna" style="font-size: 2em; color: #800020;"></i>
            		<div>
                		<h2 style="margin:0; color: #800020;">Cadastro Global de Material</h2>
                		<small style="color: #666;">Defina a Família e as especificações do Modelo técnico.</small>
            		</div>
        		</div>

        		<div class="g-cat-tabs-wrapper">
            		<button class="g-cat-tab-btn active" onclick="switchTabCadastro('identificacao')">1. Identificação</button>
            		<button class="g-cat-tab-btn" onclick="switchTabCadastro('logistica')">2. Regras Logísticas</button>
            		<button class="g-cat-tab-btn" onclick="switchTabCadastro('composicao')">3. Composição (Kit)</button>
        		</div>

        		<form id="form-cadastro-global">
            		<div id="tab-identificacao" class="g-cat-tab-content">
                		<div class="g-cat-form-grid">
                    		<div class="g-cat-field-group" style="grid-column: span 2; position: relative;">
                        		<label>Família do Material (Nome Pai)</label>
                        		<input type="text" id="cat-nome-pai" class="g-cat-input" 
                               		placeholder="Digite para buscar ou criar (Ex: MOTOSSERRA, RÁDIO...)" 
                               		oninput="buscarInteligenteFamilia(this.value)" autocomplete="off" required>
                        		<input type="hidden" id="cat-uid-pai">
                        
                        		<div id="suggestions-familia" class="suggestions-box" style="display:none; width: 100%; border-color: #800020;">
                            		<ul id="list-suggestions-familia"></ul>
                        		</div>
                    		</div>

                    		<div class="g-cat-field-group">
                        		<label>Marca</label>
                        		<input type="text" id="cat-marca" class="g-cat-input" placeholder="Ex: STIHL" required>
                    		</div>
                    		<div class="g-cat-field-group">
                        		<label>Modelo / Especificidade</label>
                       			<input type="text" id="cat-modelo" class="g-cat-input" placeholder="Ex: MS 123" required>
                    		</div>
                    
                    		<div class="g-cat-field-group" style="grid-column: span 2;">
                        		<label>Categoria</label>
                        		<select id="cat-categoria" class="g-cat-input" required>
                            		<option value="" disabled selected>Selecione...</option>
                            		<option value="EPI">EPI</option>
                            		<option value="ELETRÔNICO">ELETRÔNICO</option>
                            		<option value="FERRAMENTA">FERRAMENTA</option>
                            		<option value="ACESSÓRIO">ACESSÓRIO</option>
                            		<option value="EQUIPAMENTO">EQUIPAMENTO</option>
                            		<option value="COMUNICAÇÃO">COMUNICAÇÃO</option>
                        		</select>
                    		</div>
                		</div>
            		</div>

            		<div id="tab-logistica" class="g-cat-tab-content" style="display:none;">
                		<div class="g-cat-form-grid">
                    		<div class="g-cat-field-group">
                        		<label>Tipo de Controle (DNA do Ativo)</label>
                        		<div style="display: flex; gap: 15px; margin-top: 8px;">
                            		<label style="font-weight: normal;"><input type="radio" name="cat-tipo" value="single" checked> Single (Quantidade)</label>
                            		<label style="font-weight: normal;"><input type="radio" name="cat-tipo" value="multi"> Multi (Tombamento)</label>
                       			</div>
                    		</div>
                    		<div class="g-cat-field-group">
                        		<label>Unidade de Medida</label>
                        		<select id="cat-unidade-medida" class="g-cat-input">
                            		<option value="Unidade">Unidade</option>
                            		<option value="Par">Par</option>
                            		<option value="Conjunto">Conjunto</option>
                            		<option value="Litro">Litro</option>
                        		</select>
                    		</div>
                    		<div class="g-cat-field-group">
                        		<label>Exige Inspeção?</label>
                        		<input type="checkbox" id="cat-has-inspecao" style="width: 20px;">
                    		</div>
                		</div>
            		</div>

            		<div id="tab-composicao" class="g-cat-tab-content" style="display:none;">
                		<div class="g-cat-field-group">
                    		<label>Este item é um Anfitrião de Kit?</label>
                    		<div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                        		<input type="checkbox" id="cat-is-kit" style="width: auto;" onchange="document.getElementById('area-selecao-componentes').style.display = this.checked ? 'block' : 'none'">
                        		<span>Sim, possui componentes internos.</span>
                    		</div>
                		</div>
                		<div id="area-selecao-componentes" class="g-cat-kit-box" style="display:none;">
                			<label>Componentes Padrão do Kit:</label>
                    		<div id="lista-componentes-selecionados"></div>
                    		<button type="button" class="btn-secondary" style="font-size: 0.8em;">+ Adicionar do Catálogo</button>
                		</div>
            		</div>
        		</form>

        		<div class="modal-buttons" style="margin-top: 30px;">
            		<button type="button" class="btn-modern-action btn-backup" onclick="fecharModalCadastroGlobal()">Cancelar</button>
            		<button type="button" class="btn-modern-action btn-sync" onclick="salvarCadastroGlobalHierarquico()">
            	    	<i class="fas fa-save"></i> Gravar no Catálogo
           			</button>
        		</div>
    		</div>
		</div>
		
		<div id="modal-timeline-global" class="modal-overlay" style="display:none; z-index: 31005;">
    		<div class="modal-content" style="max-width: 550px; border-top: 5px solid #fef3c7; background: #fdfdfd;">
        		<button class="close-btn" onclick="document.getElementById('modal-timeline-global').style.display='none'"><i class="fas fa-times"></i></button>
        
        		<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            		<i class="fas fa-history" style="font-size: 2em; color: #92400e;"></i>
            		<div>
                		<h2 style="margin:0; color: #92400e;">Histórico de Vida</h2>
                		<small id="timeline-item-nome" style="color: #666; font-weight: bold; font-size: 1em;">Material: ---</small>
            		</div>
        		</div>

        		<div id="timeline-container" style="max-height: 450px; overflow-y: auto; padding: 10px; position: relative;">
            	</div>

        		<div style="margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
            		<button class="btn-modern-action btn-secondary" onclick="document.getElementById('modal-timeline-global').style.display='none'">Fechar</button>
        		</div>
    		</div>
		</div>
	
		<div id="modal-novo-setor-arquitetura" class="modal-overlay" style="display:none;">
    		<div class="modal-content" style="max-width: 400px; border-top: 6px solid #800020;">
        		<button class="close-btn" onclick="fecharModalNovoSetor()"><i class="fas fa-times"></i></button>
        		<h2 style="font-size: 1.2em; color: #800020; margin-bottom: 15px;">Criar Novo Setor</h2>
        
        		<div class="form-group">
            		<label>Nome do Setor:</label>
            		<input type="text" id="input-nome-setor-modal" placeholder="Ex: CABINE, CARROCERIA..." 
                   	style="text-transform: uppercase;" onkeyup="if(event.key==='Enter') confirmarNovoSetor()">
        		</div>

        		<div id="area-sugestoes-setores" style="margin-top: 10px;">
            		<label style="font-size: 0.75em; color: #64748b; text-transform: uppercase; font-weight: bold;">Sugestões de Uso Comum:</label>
            		<div id="setores-tags-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                	</div>
        		</div>

        		<div class="modal-buttons" style="margin-top: 25px;">
            		<button class="btn-modern-action btn-backup" onclick="fecharModalNovoSetor()">Cancelar</button>
            		<button class="btn-modern-action btn-sync" onclick="confirmarNovoSetor()" style="background: #1b8a3e !important;">Criar Setor</button>
        		</div>
    		</div>
		</div>
	
		<div id="modal-pdf-viewer" class="sigma-v3-pdf-overlay">
    		<div class="sigma-v3-pdf-modal">
        		<div class="sigma-v3-pdf-header">
            		<div style="display:flex; align-items:center; gap:12px;">
                		<i class="fas fa-file-pdf fa-lg"></i>
                		<div style="line-height:1;">
                    		<b style="display:block; font-size:1.1em;">Visualizar Relatório</b>
                    		<small id="pdf-modal-filename" style="opacity:0.8; font-size:0.75em;"></small>
                		</div>
            		</div>
            		<div class="sigma-v3-pdf-actions">
                		<button class="sigma-v3-pdf-btn" onclick="imprimirPdfInterno()" title="Imprimir">
                    		<i class="fas fa-print"></i> <span class="hide-mobile">Imprimir</span>
                		</button>
                		<button class="sigma-v3-pdf-btn" onclick="compartilharPdfInterno()" title="Compartilhar">
                    		<i class="fas fa-share-nodes"></i> <span class="hide-mobile">Compartilhar</span>
                		</button>
                		<button class="sigma-v3-pdf-btn" onclick="fecharVisualizadorPdf()" style="background:#d90f23; border:none;">
                    		<i class="fas fa-times"></i>
                		</button>
            		</div>
        		</div>
        		<div class="sigma-v3-pdf-body">
            		<iframe id="sigma-v3-pdf-frame"></iframe>
        		</div>
    		</div>
		</div>
	
	
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
		firebase.firestore().clearPersistence().catch((err) => {
    		if (err.code == 'failed-precondition') {
        		console.warn("Múltiplas abas abertas, persistência não pôde ser limpa.");
    		}
		});
        const auth = firebase.auth();
		const secondaryApp = firebase.initializeApp(firebaseConfig, 'Secondary');
    	const secondaryAuth = secondaryApp.auth();
        
        async function openNewConferenceModal() {
    materialSelecionadoNoModal = null; // Reseta variável global

    try {
        // 🛡️ MUDANÇA CIRÚRGICA 1: Busca apenas as listas que REALMENTE estão em prontidão (tem posto_id)
        const snapListas = await db.collection('listas_conferencia')
            .where('ativo', '==', true)
            .get();

        if (snapListas.empty) {
            Swal.fire('Aviso', 'Não há nenhuma viatura ou lista alocada em postos no momento.', 'info');
            return;
        }

        // Transforma os documentos em objetos e filtra quem tem posto_id
        const todasListasAtivas = snapListas.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const listasComPosto = todasListasAtivas.filter(l => l.posto_id && l.posto_nome);

        // 🛡️ MUDANÇA CIRÚRGICA 2: Gera os setores (Postos) ÚNICOS baseados nos vínculos reais
        const setoresUnicos = [...new Set(listasComPosto.map(l => l.posto_nome))].sort();

        if (setoresUnicos.length === 0) {
            Swal.fire('Aviso', 'Nenhuma lista foi vinculada a um posto pela Gestão.', 'warning');
            return;
        }

        // Guardamos as listas filtradas em uma variável temporária para a função de filtragem usar
        window.listasVigentesParaModal = listasComPosto;

        Swal.fire({
            title: '<i class="fas fa-clipboard-check"></i> Conferência de Materiais',
            backdrop: `rgba(0,0,0,0.6)`,
            target: 'body',
            allowOutsideClick: false,
            html: `
                <div style="text-align: left; padding: 5px;">
                    <div id="area-selecao-material">
                        <div class="form-group">
                            <label style="font-size: 0.85em; font-weight:bold; color:#800020;">1. SELECIONE O POSTO / BASE:</label>
                            <select id="swal-select-posto" class="swal2-select" style="width: 100%; margin: 10px 0;" onchange="filtrarListasParaMaterial(this.value)">
                                <option value="" disabled selected>Escolha o posto...</option>
                                ${setoresUnicos.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>

                        <div class="form-group" id="group-select-lista" style="display:none; margin-top:15px;">
                            <label style="font-size: 0.85em; font-weight:bold; color:#800020;">2. ESCOLHA A VIATURA / LISTA:</label>
                            <select id="swal-select-lista" class="swal2-select" style="width: 100%; margin: 10px 0;" onchange="selecionarMaterialVisual()">
                                <option value="" disabled selected>Selecione a lista...</option>
                            </select>
                        </div>
                    </div>

                    <div id="resumo-material-vtr" style="display:none;">
                        <div class="vtr-selected-summary" style="border-color: #2c7399; padding:15px; border:2px solid #2c7399; border-radius:8px; text-align:center;">
                            <i class="fas fa-file-invoice" style="color:#2c7399; font-size:1.5em; margin-bottom:10px;"></i>
                            <p style="margin:0; font-size:0.9em; color:#666;">Lista Selecionada</p>
                            <h2 id="resumo-nome-lista" style="font-size:1.5em; color:#2c7399; margin:5px 0;">---</h2>
                            <div id="resumo-detalhe-posto" style="margin-top:10px; color:#475569; font-size:0.85em; font-weight:bold; text-transform:uppercase;">
                                POSTO/BASE: ---
                            </div>
                        </div>
                    </div>

                    <button id="btn-confirmar-material-modal" class="btn-iniciar-check-modal" style="display:none; background-color:#2c7399 !important; width:100%; color:white; padding:12px; border:none; border-radius:6px; font-weight:bold; margin-top:15px; cursor:pointer;" onclick="confirmarInicioMaterial()">
                        INICIAR CONFERÊNCIA
                    </button>
                    
                    <button id="btn-trocar-material" style="display:none; background:none; border:none; color:#2c7399; cursor:pointer; width:100%; margin-top:10px; font-size:0.8em; text-decoration:underline;" onclick="resetarSelecaoMaterial()">
                        Trocar material selecionado
                    </button>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancelar'
        });

    } catch (e) {
        console.error("Erro ao abrir modal de conferência:", e);
        Swal.fire('Erro', 'Falha ao carregar dados do inventário.', 'error');
    }
}

        // Constantes Globais
        const COLECAO_RESULTADOS = 'resultados_conferencias';
        const COLECAO_LISTAS = 'listas_conferencia';

        // Variáveis Globais
        let currentUserData = null;
        let allLists = [];
        let allUsersData = [];
        let allTargetUsers = [];
        let dadosConferencia = []; // Para o editor
        let currentEditingId = null;
        let conferente = '';
        let userCache = {};
		let cautelaItensSelecionados = [];
		let cautelaIdAtualParaReporte = '';
		let itensDaCautelaAtual = [];
		let pendenciaSendoResolvida = null
		let cachePendenciasCautela = [];
		let arquiteturaAtiva = []; // Guarda o array 'list' da viatura em edição
		let idListaSendoEditada = null;
		let itensParaEstorno = []; // Itens que foram marcados com "X"
		let estoqueGestorLocal = []; // Cache do estoque da unidade para a busca rápida
		let vtrSelecionadaNoModal = null;
		let materialSelecionadoNoModal = null;
		let dadosChecklistTemp = { vtr: null, km: 0, combustivel: '1/2' };
		let isModoVistoria = false;
		let houveAlteracaoNoPosto = false; // Controle de sincronização visual
		window.colecaoAtivaNoEditor = 'listas_conferencia';
		
        // --- 1. AUTH & PERMISSÕES ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection('usuarios').doc(user.uid).get();
                    if (doc.exists) {
                        currentUserData = doc.data();
                        conferente = currentUserData.nome_militar_completo;
                        setupUIBasedOnRole();
                    } else {
                        alert("Usuário sem registro no banco."); 
                        window.location.href = 'index.html';
                    }
                } catch (e) { 
                    console.error(e); 
                }
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        function setupUIBasedOnRole() {
			if (typeof atualizarIdentidadeSidebar === 'function') {
        		atualizarIdentidadeSidebar();
    		}
    		const role = currentUserData.role || 'operacional';
    		const unit = currentUserData.unidade || 'N/D';
    		const p = currentUserData.permissoes || {};

    		atualizarSaudacao(currentUserData);
			carregarAlertasTransferencia();
			setTimeout(() => {
    			if (!document.getElementById('alerta-carga-transito')) {
        			carregarAlertasTransferencia();
    			}
			}, 1500);

    		const isAdmin = (role === 'admin');
    		const isGestorGeral = (role === 'gestor_geral');
    		const isGestorOuAdmin = (role === 'gestor' || role === 'admin' || role === 'gestor_geral');
    
    		const canManageUnits = isAdmin; 

    const canViewDashboardCards = isAdmin || isGestorGeral || (role === 'gestor' && p.canViewDashboardCards);
    const canViewUnitHistory = isAdmin || isGestorGeral || (role === 'gestor' && p.canViewUnitHistory);
    const canManagePosts = isAdmin || isGestorGeral || (role === 'gestor' && p.canManagePosts);
    const canManageUnitUsers = isAdmin || isGestorGeral || (role === 'gestor' && p.canManageUnitUsers);
    const canManageUnitLists = isAdmin || isGestorGeral || (role === 'gestor' && p.canManageUnitLists);

    document.querySelectorAll('.restricted-admin-only').forEach(el => {
        if (el) el.style.display = isGestorOuAdmin ? 'block' : 'none';
    });
	const btnNovoPosto = document.getElementById('btn-toggle-posto');
    if (btnNovoPosto) {
        // Apenas Admin e Gestor Geral podem ver o botão de criar novo posto
        const podeCriarPosto = isAdmin || isGestorGeral; 
        btnNovoPosto.style.display = podeCriarPosto ? 'inline-flex' : 'none';
    }
	const btnNovaVtr = document.getElementById('btn-toggle-vtr-base');
		if (btnNovaVtr) {
	    const podeCriarVtr = (role === 'admin' || role === 'gestor_geral');
    	btnNovaVtr.style.display = podeCriarVtr ? 'inline-flex' : 'none';
	}

    const linkUnidades = document.getElementById('link-unidades');
    if (linkUnidades) linkUnidades.style.display = canManageUnits ? 'block' : 'none';

    const linkPostos = document.getElementById('link-postos');
    if (linkPostos) linkPostos.style.display = canManagePosts ? 'block' : 'none';

    const linkUsuarios = document.getElementById('link-usuarios');
    if (linkUsuarios) linkUsuarios.style.display = canManageUnitUsers ? 'block' : 'none';

    const linkListas = document.getElementById('link-listas');
    if (linkListas) linkListas.style.display = canManageUnitLists ? 'block' : 'none';

    const linkAlmox = document.getElementById('link-almoxarifado');
    if (linkAlmox) linkAlmox.style.display = isGestorOuAdmin ? 'block' : 'none';

    const linkCautelas = document.getElementById('link-cautelas');
	if (linkCautelas) linkCautelas.style.display = 'block';

    const globalHistoryLink = document.getElementById('link-global-history');
    if (globalHistoryLink) globalHistoryLink.style.display = canViewUnitHistory ? 'block' : 'none';

    if (role === 'operacional') {
        renderOperacionalCards();
    } else {
        renderAdminGestorCards(canViewDashboardCards);
    }

    const btnGlobal = document.getElementById('btn-novo-cadastro-global');
    if (btnGlobal) {
        btnGlobal.style.display = (role === 'admin' || role === 'gestor_geral') ? 'inline-flex' : 'none';
    }
    
    const adminLinks = ['link-unidades', 'link-postos', 'link-usuarios', 'link-listas', 'link-almoxarifado', 'link-global-history'];
    const anyAdminLinkVisible = adminLinks.some(id => {
        const el = document.getElementById(id);
        return el && el.style.display !== 'none';
    });
    
    const rotuloAdmin = document.getElementById('sidebar-rotulo-admin');
    if (rotuloAdmin) {
        rotuloAdmin.style.display = anyAdminLinkVisible ? 'block' : 'none';
    }

    // ✅ VÍNCULO CIRÚRGICO: POSTO -> QUADRO NO NOVO FORMULÁRIO
    const selectPostoNovo = document.getElementById('new-user-posto');
    const selectQuadroNovo = document.getElementById('new-user-quadro');
    if (selectPostoNovo && selectQuadroNovo) {
        selectPostoNovo.addEventListener('change', () => atualizarQuadroCad(selectPostoNovo, selectQuadroNovo));
    }

    const editorArq = document.getElementById('view-editor-arquitetura');
    if (editorArq) editorArq.style.display = 'none';

    closeMenuMobile();

    if (window.innerWidth <= 768) {
        history.pushState(null, null, location.href);
    }

    switchView('dashboard');

    if (typeof setupMasksForModal === 'function') setupMasksForModal();
}
        
/**
 * Adiciona listeners de formatação (máscara) aos inputs do modal Gerenciar Militar.
 */
function setupMasksForModal() {
    const cpfInput = document.getElementById('edit-user-cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
        // Aplica a máscara imediatamente para valores preenchidos na abertura do modal
        formatarCPF(cpfInput); 
    }
    
    const matriculaInput = document.getElementById('edit-user-matricula');
    if (matriculaInput) {
        matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
        formatarMatricula(matriculaInput);
    }
    
    const telefoneInput = document.getElementById('edit-user-telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));
        formatarTelefone(telefoneInput);
    }
}
		function toggleSubMenu(id, btn) {
    const submenu = document.getElementById(id);
    const isVisible = submenu.style.display === 'block';
    
    // Oculta outros submenus abertos para manter a sidebar limpa
    document.querySelectorAll('.sigma-v3-submenu').forEach(s => {
        if (s.id !== id) s.style.display = 'none';
    });
    document.querySelectorAll('.sigma-v3-dropdown-btn').forEach(b => {
        if (b !== btn) b.classList.remove('open');
    });

    // Alterna o estado atual
    if (isVisible) {
        submenu.style.display = 'none';
        btn.classList.remove('open');
    } else {
        submenu.style.display = 'block';
        btn.classList.add('open');
    }
}
            // --- NOVO: Cards Específicos para Operacional ---
function renderOperacionalCards() {
    const container = document.getElementById('operacional-cards-container');
    if (!container) return;
    
    const adminContainer = document.getElementById('admin-gestor-cards-container');
    if(adminContainer) adminContainer.style.display = 'none';

    // ✅ HIERARQUIA V3: Atividades do dia primeiro, Cards de Resumo depois
    container.innerHTML = `
        <div class="sigma-v3-clean-wrapper" style="margin-top: 10px;">
            
            <div class="sigma-v3-title-label">
                <i class="fas fa-calendar-day" style="color: #800020;"></i>
                <span>Atividades Realizadas Hoje</span>
            </div>
            <ul id="today-list" class="history-list" style="background: white; border-radius: 15px; padding: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 40px; list-style: none;">
                <li style="text-align:center; color:#999; padding:20px;">
                    <i class="fas fa-sync fa-spin"></i> Carregando registros de hoje...
                </li>
            </ul>

            <div class="sigma-v3-title-label" style="border-top: 1px solid rgba(0,0,0,0.05); padding-top: 30px;">
                <i class="fas fa-chart-bar" style="color: #2c7399;"></i> 
                <span>Dashboard de Serviço</span>
            </div>

            <div class="cards-grid" style="display: flex; flex-wrap: wrap; gap: 20px;">
                
                <div class="sigma-v3-summary-card sigma-v3-card-ok icon-conferencia" onclick="switchView('my-history')">
                    <h3>Minhas Conferências</h3>
                    <div class="sigma-v3-main-stat">
                        <div class="sigma-v3-stat-circle" id="op-conf-count">0</div>
                        <div style="line-height: 1.2;">
                            <span style="font-size: 0.8em; font-weight: 800; color: #1b8a3e;">HISTÓRICO</span><br>
                            <small style="color: #64748b; font-size: 0.7em;">Registros totais</small>
                        </div>
                    </div>
                    <div class="sigma-v3-footer-info">
                        <strong><i class="fas fa-arrow-right"></i> Clique para acessar</strong>
                        <small>Histórico completo de atividades</small>
                    </div>
                </div>

                <div class="sigma-v3-summary-card sigma-v3-card-unit icon-custodia" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas Ativas');">
                    <h3>Minha Custódia</h3>
                    <div class="sigma-v3-main-stat">
                        <div class="sigma-v3-stat-circle" id="op-my-active-cautela-count">0</div>
                        <div style="line-height: 1.2;">
                            <span style="font-size: 0.8em; font-weight: 800; color: #2c7399;">ATIVAS</span><br>
                            <small style="color: #64748b; font-size: 0.7em;">Materiais em seu nome</small>
                        </div>
                    </div>
                    <div class="sigma-v3-footer-info">
                        <strong><i class="fas fa-shield-alt"></i> Gestão de Cautela</strong>
                        <small>Itens sob sua responsabilidade</small>
                    </div>
                </div>

                <div class="sigma-v3-summary-card sigma-v3-card-posto icon-receber" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas a Receber');">
                    <h3>A Receber / Conferir</h3>
                    <div class="sigma-v3-main-stat">
                        <div class="sigma-v3-stat-circle" id="op-cautela-receive-count">0</div>
                        <div style="line-height: 1.2;">
                            <span style="font-size: 0.8em; font-weight: 800; color: #8e44ad;">PENDENTES</span><br>
                            <small style="color: #64748b; font-size: 0.7em;">Ação necessária</small>
                        </div>
                    </div>
                    <div class="sigma-v3-footer-info">
                        <strong><i class="fas fa-box-open"></i> Aguardando Você</strong>
                        <small>Recebimento de materiais</small>
                    </div>
                </div>
                
            </div>
        </div>
    `;
    
    // Dispara a lógica de preenchimento dos dados (ul e contadores)
    updateOperacionalCards();
    container.style.display = 'block';
}
// [NOVO] Atualiza a contagem do Card "Minhas Conferências"
async function getCautelasAReceberCount() {
    if (!currentUserData) return 0;
    const militarUid = firebase.auth().currentUser.uid;

    try {
        // Cautelas NOVAS (Alvo Original)
        const snapNovas = await db.collection('cautelas_abertas')
            .where('destinatario_original_uid', '==', militarUid)
            .where('status', '==', 'ABERTA')
            .get();

        // DEVOLUÇÕES para conferir (Destinatário Atual)
        const snapDevolucoes = await db.collection('cautelas_abertas')
            .where('destinatario_uid', '==', militarUid)
            .where('status', '==', 'DEVOLUÇÃO')
            .get();

        // Usamos um Set para garantir que se uma cautela cair em ambos, conte apenas uma vez
        const totalIds = new Set();
        snapNovas.forEach(doc => totalIds.add(doc.id));
        snapDevolucoes.forEach(doc => totalIds.add(doc.id));

        return totalIds.size;
    } catch (e) {
        console.error("Erro ao contar cautelas:", e);
        return 0;
    }
}
       /**
 * Busca e retorna a contagem de cautelas ativas/recebidas do militar logado,
 * incluindo as que estão EM DEVOLUÇÃO (enviadas por ele).
 */
/**
 * Calcula a contagem total e desduplicada de cautelas ativas para o dashboard,
 * respeitando os filtros de perfil (Operacional, Gestor, Admin).
 */
async function countActiveCautelas() {
    if (!currentUserData || !currentUserData.nome_militar_completo) return 0;
    
    const role = currentUserData.role;
    const user = currentUserData;
    
    // Conjunto para garantir que cada Cautela ID seja contada apenas uma vez
    const countedIds = new Set();
    
    // --- 1. BUSCAS PARA OPERACIONAL / GESTOR (Regras Pessoais) ---
    if (role === 'operacional' || role === 'gestor') {
        
        // A. CUSTÓDIA ATIVA + RASTREIO DE DEVOLUÇÃO (RECEBIDA como destinatário OU DEVOLUÇÃO como reversor)
        // Usaremos duas queries separadas e depois desduplicaremos para garantir a contagem.
        
        // CUSTÓDIA ATIVA (RECEBIDA)
        const custodiaRecebida = await queryCautelas(['RECEBIDA'], role, user, 'destinatario', 'personal');
        custodiaRecebida.forEach(c => countedIds.add(c.cautela_id));
        
        // RASTREIO DE RESPONSABILIDADE (DEVOLUÇÃO como Reversor)
        const devolucaoRastreio = await queryCautelas(['DEVOLUÇÃO'], role, user, 'militar_completo_reversor', 'personal');
        devolucaoRastreio.forEach(c => countedIds.add(c.cautela_id));

        // B. RASTREIO PESSOAL (ABERTA, RECEBIDA, DEVOLUÇÃO como Emitente)
        const rastreioEmitente = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÇÃO'], role, user, 'emitente', 'personal');
        rastreioEmitente.forEach(c => countedIds.add(c.cautela_id));
    }
    
    // --- 2. BUSCAS PARA GESTOR / ADMIN (Regras Gerenciais de Monitoramento) ---
    if (role === 'gestor' || role === 'admin') {
        
        // MONITORAMENTO: ABERTA, RECEBIDA, DEVOLUÇÃO (Filtro por Unidade ou Global)
        const monitoramentoRaw = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÇÃO'], role, user, null, 'unit');

        // Adiciona todos os IDs de monitoramento no Set (ele cuida da desduplicação)
        monitoramentoRaw.forEach(c => countedIds.add(c.cautela_id));
    }

    // O tamanho do Set é a contagem total desduplicada de todas as cautelas ativas
    return countedIds.size;
}
// Localização: Linha ~2792
async function updateOperacionalCards() {
    const ul = document.getElementById('today-list');
    const countEl = document.getElementById('op-conf-count');
    const cautelaReceiveCountEl = document.getElementById('op-cautela-receive-count');
    const myActiveCautelaCountEl = document.getElementById('op-my-active-cautela-count');
    
    const conferenteUid = firebase.auth().currentUser.uid;
    if (!conferenteUid || !ul || !countEl || !cautelaReceiveCountEl || !myActiveCautelaCountEl) {
        console.warn("Elemento de card operacional ou UID ausente. Pulando atualização.");
        return; 
    }
    countEl.textContent = "...";
	cautelaReceiveCountEl.textContent = "...";
	myActiveCautelaCountEl.textContent = "...";
    try {
        // --- 1. CONSULTA DUPLA (MATERIAIS E VISTORIAS) ---
        // Buscamos os últimos registros de ambas as coleções para este usuário
        const [snapMateriais, snapChecklists] = await Promise.all([
            db.collection('resultados_conferencias')
                .where('conferente_uid', '==', conferenteUid)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get(),
            db.collection('resultados_checklist')
                .where('conferente_uid', '==', conferenteUid)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get()
        ]);

        // Unifica os documentos na memória para processar a "Lista de Hoje"
        let todosDocs = [];
        snapMateriais.forEach(doc => todosDocs.push(doc.data()));
        snapChecklists.forEach(doc => todosDocs.push(doc.data()));

        // Atualiza o contador total (Soma das duas frentes de trabalho)
        const totalGeralAtividades = snapMateriais.size + snapChecklists.size;
        countEl.textContent = totalGeralAtividades; 

        // --- 2. OUTROS CONTADORES (CAUTELAS) ---
        const [totalCautelasAReceber, totalMyActiveCautelas] = await Promise.all([
            getCautelasAReceberCount(),
            countActiveCautelas()
        ]);
        cautelaReceiveCountEl.textContent = totalCautelasAReceber; 
        myActiveCautelaCountEl.textContent = totalMyActiveCautelas; 
        
        // --- 3. FILTRAGEM PARA "HOJE" E RENDERIZAÇÃO ---
        const hojeStr = new Date().toLocaleDateString('pt-BR');
        
        // Ordena por timestamp antes de filtrar
        todosDocs.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

        let html = '';
        todosDocs.forEach(data => {
            const dt = data.timestamp.toDate();
            // Filtro de data local (apenas as que caem na data de hoje)
            if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                html += criarItemHistoricoHTML(data);
            }
        });
        
        ul.innerHTML = html ||
        '<li style="padding:15px; text-align:center; color:#999;">Nenhuma atividade hoje.</li>';
        
    } catch(e) { 
        console.error("Erro ao carregar dados operacionais unificados:", e);
        if(countEl) countEl.textContent = 'Erro';
        if(ul) ul.innerHTML = '<li style="text-align:center; color:red;">Erro ao carregar lista de hoje.</li>';
    }
}
        
function renderAdminGestorCards(canViewDashboardCards) {
    const container = document.getElementById('admin-gestor-cards-container');
    if (!container) return;

    // Se não tiver permissão, esconde e sai
    if (!canViewDashboardCards) {
        container.style.display = 'none';
        return;
    }

    // ✅ MUDANÇA PREMIUM: Removemos a moldura ('op-card') e deixamos o conteúdo livre
    // Usamos a classe 'sigma-v3-clean-wrapper' que define fundo transparente no CSS
    if (!document.getElementById('cards-container')) {
        container.innerHTML = `
            <div id="dash-cards-restricted" class="sigma-v3-clean-wrapper" style="margin-top: 20px;">
                <div class="sigma-v3-title-label">
                    <i class="fas fa-exclamation-triangle" style="color: #d90f23;"></i> 
                    <span>Pendências de Listas (Unidade)</span>
                </div>
                
                <div id="loading-message-dashboard" style="padding: 20px; color: #64748b; font-size: 0.9em; font-weight: 600;">
                    <i class="fas fa-sync fa-spin"></i> Verificando pendencias...
                </div>

                <div id="cards-container" class="cards-grid"></div>
            </div>
        `;
    }
    
    container.style.display = 'block';
    
    // Dispara a carga de dados que agora vai gerar os cards flutuantes (sigma-v3-floating-card)
    loadCaaData(); 
}
    closeMenuMobile(); 

    // --- Trava do Botão Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o botão Voltar do navegador
        history.pushState(null, null, location.href); 
    }
    // ----------------------------------------------

    // Garante que a visão seja o dashboard ao logar
    switchView('dashboard');
        
        function atualizarSaudacao(user) {
    const now = new Date();
    const hour = now.getHours();
    let saudacao = "Bom dia";
    if (hour >= 12 && hour < 18) saudacao = "Boa tarde";
    else if (hour >= 18) saudacao = "Boa noite";
    
    const opcoesData = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    let dataStr = now.toLocaleDateString('pt-BR', opcoesData);
    dataStr = dataStr.charAt(0).toUpperCase() + dataStr.slice(1);

    document.getElementById('greeting-text').textContent = saudacao + ",";
    document.getElementById('greeting-name').textContent = user.nome_militar_completo || user.nome_guerra;
    document.getElementById('current-date').textContent = dataStr;

    // ✅ LÓGICA DE FOTO COM FALLBACK (INICIAIS)
    const elFoto = document.getElementById('greeting-photo');
    if (elFoto) {
        if (user.foto_url && user.foto_url !== "") {
            // Se tem foto do Google ou Upload, usa ela
            elFoto.src = user.foto_url;
        } else {
            // Se não tem foto, gera iniciais no fundo Bordô do SIGMA
            const nomeParaAvatar = user.nome_guerra || user.nome_completo || "BM";
            elFoto.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(nomeParaAvatar)}&background=800020&color=fff&bold=true&size=128`;
        }
    }
}
        

        // --- 3. DASHBOARD HIERÁRQUICO ---
   async function loadCaaData() {
    const container = document.getElementById('cards-container');
    if (!container) return;
    const loading = document.getElementById('loading-message-dashboard');
    if (loading) loading.style.display = 'block';
    
    try {
        await loadCautelaPendencies(); 

        const gestorUnidadeId = currentUserData.unidade_id;
        const gestorUnidadeSigla = currentUserData.unidade || "Unidade";
        const isAdmin = currentUserData.role === 'admin' || currentUserData.role === 'gestor_geral';

        // 1. Busca os resultados (limitamos a 50 para performance)
        const snap = await db.collection(COLECAO_RESULTADOS).orderBy('timestamp', 'desc').limit(50).get();
        
        // Objeto para garantir UNICIDADE (chave é o lista_id)
        const map = {}; 
        const cacheUnidadesLista = {};

        for (const doc of snap.docs) {
            const d = doc.data();
            const listaId = d.lista_id;

            // Se já processamos o resultado mais RECENTE desta lista, ignoramos os anteriores (Evita duplicados)
            if (map[listaId]) continue;

            let unidadeVinculada = d.unidade_id;
            let siglaVinculada = d.unidade_sigla;

            // Inteligência para buscar unidade na lista mestra se faltar no resultado
            if (!unidadeVinculada && listaId) {
                if (!cacheUnidadesLista[listaId]) {
                    const docLista = await db.collection('listas_conferencia').doc(listaId).get();
                    if (docLista.exists) {
                        const dataL = docLista.data();
                        cacheUnidadesLista[listaId] = {
                            id: dataL.unidade_id,
                            sigla: dataL.unidade_sigla
                        };
                    }
                }
                if (cacheUnidadesLista[listaId]) {
                    unidadeVinculada = cacheUnidadesLista[listaId].id;
                    siglaVinculada = cacheUnidadesLista[listaId].sigla;
                }
            }

            // ✅ FILTRO DE VISIBILIDADE
            if (isAdmin || unidadeVinculada === gestorUnidadeId) {
                let pendenciasReais = [];
                const fonteItens = d.itensRelatorio || d.itensCaa || [];
                
                fonteItens.forEach(it => {
                    if (it.status === 'C/A' && it.pendencias_ids) {
                        it.pendencias_ids.forEach(p => {
                            if (p.status_gestao !== 'RESOLVIDO') {
                                pendenciasReais.push({ 
                                    ...p, 
                                    itemNome: it.nomeCompleto || it.nome, 
                                    itemId: it.id || it.uid_global, 
                                    tipoRegistro: 'PENDENCIA' 
                                });
                            }
                        });
                    }
                });

                if (pendenciasReais.length > 0) {
                   map[listaId] = { 
    					docId: doc.id, 
    					lista_id: listaId, 
    					local: d.local, 
    					conferente: d.conferente, 
    					date: d.timestamp.toDate().toLocaleString('pt-BR'), 
    					unidade_sigla: d.unidade_sigla || siglaVinculada || currentUserData.unidade || "Unidade", 
    					items: pendenciasReais 
					};
                }
            }
        }
        
        renderCards(map); 

    } catch (e) { 
        console.error("Erro Dashboard:", e); 
        container.innerHTML = 'Erro ao processar dados.';
    } finally { 
        if (loading) loading.style.display = 'none';
    }
}     
       
        async function renderCards(map) {
    const container = document.getElementById('cards-container');
    if (!container) return;
    container.innerHTML = '';
    const keys = Object.keys(map);
    
    let rotas = {};
    try {
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        rotas = rotasDoc.data() || {};
    } catch (e) { console.warn("Falha rotas:", e); }

    if (keys.length === 0) { 
        container.innerHTML = '<div style="padding:60px; text-align:center; color:#64748b; width:100%;">' +
                              '<i class="fas fa-check-circle" style="font-size:4em; color:#1b8a3e; opacity:0.2; display:block; margin-bottom:20px;"></i>' +
                              '<b style="font-size:1.2em;">Tudo em Conformidade</b><br>Nenhuma pendência ativa na unidade.</div>';
        return;
    }

    const groupedCards = {};
    keys.forEach(listaId => {
        const d = map[listaId];
        const unit = rotas[listaId]?.unidade || 'GERAL'; 
        if (!groupedCards[unit]) groupedCards[unit] = [];
        groupedCards[unit].push(d);
    });

    const sortedUnits = Object.keys(groupedCards).sort();
    sortedUnits.forEach(unit => {
        const isAdmin = currentUserData.role === 'admin' || currentUserData.role === 'gestor_geral';
        
        if (isAdmin || (unit !== "GERAL" && unit !== "Unidade")) {
            const unitHeader = document.createElement('h3');
            unitHeader.className = 'unit-header';
            unitHeader.style.cssText = 'display: block; width: 100%; color: #800020; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; font-size: 1.3em; font-weight: 800;'; 
            unitHeader.innerHTML = `<div class="unit-flex-title"><i class="fas fa-building"></i> <span>${unit}</span></div>`;
            container.appendChild(unitHeader); 
        }
        
        const cardsList = groupedCards[unit];
        cardsList.forEach(d => {
    		const allItems = d.items || [];
    		const countTotal = allItems.length;
    		const temAlteracao = countTotal > 0;
    
    		const div = document.createElement('div');
    		// ✅ CLASSE FLUTUANTE
    		div.className = `sigma-v3-floating-card`;
    
    		div.innerHTML = `
        		<div style="display: flex; justify-content: space-between; align-items: flex-start;">
            		<h3 style="margin:0; font-size: 1.2em; font-weight: 900; color: #1e293b;">${d.local}</h3>
            		<div class="sigma-v3-stat-badge ${!temAlteracao ? 'sigma-v3-card-ok-badge' : ''}">
                		${countTotal === 0 ? '<i class="fas fa-check" style="font-size: 0.6em;"></i>' : countTotal}
            		</div>
        		</div>
        
        		<div style="margin-top: 10px;">
            		<span style="font-size: 0.7em; font-weight: 800; color: ${temAlteracao ? '#d90f23' : '#1b8a3e'}; text-transform: uppercase;">
                		${temAlteracao ? '⚠️ Atenção Requerida' : '✅ Inventário em Dia'}
            		</span>
        		</div>

        		<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #f1f5f9;">
            		<div style="display: flex; align-items: center; gap: 8px;">
                		<i class="fas fa-user-shield" style="color: #94a3b8; font-size: 0.8em;"></i>
                		<span style="font-size: 0.75em; color: #64748b; font-weight: 600;">${d.conferente}</span>
            		</div>
            		<small style="display: block; color: #94a3b8; font-size: 0.7em; margin-top: 4px; margin-left: 22px;">
                		${d.date}
            		</small>
        		</div>
    		`;
    
    		div.onclick = () => mostrarTabela(d);
    		container.appendChild(div);
		});
    });
}
        // --- 4. NOVA CONFERÊNCIA ---
        async function carregarListasParaNovaConferencia() {
            try {
                const doc = await db.collection('config_geral').doc('rotas').get();
                const rotas = doc.data();
                allLists = []; 
                const setores = new Set();
                
                Object.entries(rotas).forEach(([id, info]) => {
                    if (info.ativo !== false && id !== 'ABT-17' && id !== 'ABT-18' && id.indexOf('bravo 5') === -1) {
                        allLists.push({ id: id, nome: info.nome, setor: info.posto });
                        setores.add(info.posto);
                    }
                });
                
                const sel = document.getElementById('dash-select-setor');
                sel.innerHTML = '<option value="" disabled selected>Selecione o Setor...</option>';
                
                Array.from(setores).sort().forEach(s => {
                    const opt = document.createElement('option'); 
                    opt.value = s; 
                    opt.textContent = s; 
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        async function filtrarListasParaMaterial(postoNome) {
    const selectLista = document.getElementById('swal-select-lista');
    const groupLista = document.getElementById('group-select-lista');
    
    if (!selectLista || !groupLista) return;

    // 🛡️ MUDANÇA CIRÚRGICA: Não busca mais em 'config_geral/rotas'
    // Usa a variável global que populamos com dados REAIS na openNewConferenceModal
    const listasVigentes = window.listasVigentesParaModal || [];
    
    // Filtra apenas as listas que pertencem ao posto selecionado pelo usuário
    const filtradas = listasVigentes.filter(l => l.posto_nome === postoNome);
    
    let options = '<option value="" disabled selected>Selecione a lista...</option>';

    if (filtradas.length > 0) {
        filtradas.forEach(lista => {
            // Usamos o ID do documento da 'listas_conferencia' e o nome real gravado nela
            options += `<option value="${lista.id}">${lista.ativo_nome}</option>`;
        });

        selectLista.innerHTML = options;
        groupLista.style.display = 'block';
    } else {
        // Caso de segurança: se por algum motivo o posto aparecer mas não tiver listas
        selectLista.innerHTML = '<option value="">Nenhuma viatura disponível</option>';
        groupLista.style.display = 'block';
    }
}
        
        // Localização: Linha ~1353
function selecionarMaterialVisual() {
    const selectPosto = document.getElementById('swal-select-posto');
    const selectLista = document.getElementById('swal-select-lista');
    
    if (!selectLista.value) return;

    const idLista = selectLista.value;
    const nomeLista = selectLista.options[selectLista.selectedIndex].text;
    const nomePosto = selectPosto.value;

    // Armazena o objeto completo para o início da conferência
    materialSelecionadoNoModal = { id: idLista, nome: nomeLista, posto: nomePosto };

    // UI: Transição suave para o resumo
    document.getElementById('area-selecao-material').style.display = 'none';
    document.getElementById('resumo-nome-lista').textContent = nomeLista;
    document.getElementById('resumo-detalhe-posto').textContent = `POSTO: ${nomePosto}`;
    document.getElementById('resumo-material-vtr').style.display = 'block';

    // Exibe botões de ação
    document.getElementById('btn-confirmar-material-modal').style.display = 'block';
    document.getElementById('btn-trocar-material').style.display = 'block';
}

function resetarSelecaoMaterial() {
    materialSelecionadoNoModal = null;
    const selectLista = document.getElementById('swal-select-lista');
    if (selectLista) selectLista.value = ""; // Limpa o select anterior

    document.getElementById('area-selecao-material').style.display = 'block';
    document.getElementById('resumo-material-vtr').style.display = 'none';
    document.getElementById('btn-confirmar-material-modal').style.display = 'none';
    document.getElementById('btn-trocar-material').style.display = 'none';
}

function confirmarInicioMaterial() {
    if (!materialSelecionadoNoModal) return;
    
    const { id, nome, posto } = materialSelecionadoNoModal;
    const userUid = firebase.auth()?.currentUser?.uid || 'SISTEMA';
    
    // Preparação do nome de guerra
    const userForDraft = (currentUserData?.nome_guerra || 'ND').toUpperCase();
    const postoGrad = (currentUserData?.posto || 'MILITAR').toUpperCase();

    // ✅ MUDANÇA CIRÚRGICA: A URL agora leva o ID real da 'listas_conferencia'
    // Isso garante que o app-conferência.html carregue os itens reais vinculados.
    const url = `conferencia_app.html?id=${id}` +
            `&posto_grad=${encodeURIComponent(currentUserData.posto || '')}` +
            `&quadro=${encodeURIComponent(currentUserData.quadro || '')}` + // ✅ Ajustado para .quadro
            `&nome_guerra=${encodeURIComponent(userForDraft)}` +
            `&user_uid=${userUid}` +
			`&unidade_id=${encodeURIComponent(currentUserData.unidade_id || '')}` +
            `&unidade_nome=${encodeURIComponent(currentUserData.unidade || '')}`;
    Swal.close();

    // Disparo do Iframe
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (iframe && container) {
        iframe.src = url;
        container.style.display = 'block';
        console.log(`🚀 Iniciando Conferência: ${nome} no posto ${posto}`);
    } else {
        console.error("Erro: Container do App não localizado no DOM.");
    }
}      
        // --- 5. HISTÓRICOS ---
        async function carregarConferenciasHoje() {
    // 🛑 CHAMA A FUNÇÃO UNIFICADA QUE JÁ ATUALIZA TODOS OS CARDS E A LISTA DE HOJE
    // Isso garante que a lógica de filtro UID/Data seja sempre a mesma.
    await updateOperacionalCards(); 
}
async function loadMyHistory() {
    const ul = document.getElementById('my-history-list');
    const conferenteUid = firebase.auth()?.currentUser?.uid;
    
    if (!ul || !conferenteUid) return;

    // ✅ Feedback visual moderno durante o carregamento
    ul.innerHTML = `
        <div style="text-align:center; padding:40px; color:#64748b;">
            <i class="fas fa-sync fa-spin fa-2x"></i>
            <p style="margin-top:10px; font-weight:600;">Sincronizando sua linha do tempo...</p>
        </div>`;
    
    const startDateInput = document.getElementById('my-hist-start').value;
    const endDateInput = document.getElementById('my-hist-end').value;

    if (!startDateInput || !endDateInput) {
        ul.innerHTML = `
            <div style="text-align:center; padding:40px; color:#d90f23; background: #fff1f2; border-radius:15px;">
                <i class="fas fa-calendar-exclamation fa-2x"></i>
                <p style="margin-top:10px; font-weight:800;">Atenção: Selecione as datas de início e fim.</p>
            </div>`;
        return;
    }

    const startTimestamp = firebase.firestore.Timestamp.fromDate(new Date(startDateInput + 'T00:00:00'));
    const endTimestamp = firebase.firestore.Timestamp.fromDate(new Date(endDateInput + 'T23:59:59'));

    try {
        const [snapMat, snapCheck, snapTrans] = await Promise.all([
            db.collection('resultados_conferencias')
                .where('conferente_uid', '==', conferenteUid)
                .where('timestamp', '>=', startTimestamp)
                .where('timestamp', '<=', endTimestamp).get(),
            
            db.collection('resultados_checklist')
                .where('conferente_uid', '==', conferenteUid)
                .where('timestamp', '>=', startTimestamp)
                .where('timestamp', '<=', endTimestamp).get(),
            
            db.collection('transferencias_pendentes')
                .where('status', '==', 'RECEBIDO')
                .where('recebedor_uid', '==', conferenteUid).get()
        ]);
            
        let docs = [];

        snapMat.forEach(doc => docs.push({ ...doc.data(), id_doc: doc.id }));
        snapCheck.forEach(doc => docs.push({ ...doc.data(), id_doc: doc.id }));
        
        snapTrans.forEach(doc => {
            const d = doc.data();
            const ts = d.timestamp_recebimento;
            if (ts && ts.seconds >= startTimestamp.seconds && ts.seconds <= endTimestamp.seconds) {
                const itensNormalizados = (d.itens || []).map(item => ({
                    nomeCompleto: item.tombamento ? `${item.nome} (Tomb: ${item.tombamento})` : item.nome,
                    quantidade: item.quantidade || 1,
                    status: item.status_recebimento || 'S/A', 
                    setor: item.setor || "CARGA",
                    obs: item.observacao_recebimento || ''
                }));

                docs.push({ 
                    ...d, 
                    id_doc: doc.id, 
                    modo: 'TRANSFERENCIA_CARGA',
                    local: `TRANSFERÊNCIA: ${d.origem_sigla} > ${d.destino_sigla}`,
                    timestamp: ts,
                    conferente: d.recebedor_nome,
                    itensRelatorio: itensNormalizados,
                    totalItensConferidos: itensNormalizados.length,
                    totalCaa: itensNormalizados.filter(i => i.status !== 'S/A').length,
                    id_amigavel: `TR-${new Date(ts.seconds * 1000).getFullYear()}/${doc.id.substring(0,5).toUpperCase()}`
                });
            }
        });

        docs.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

        let html = '';
        docs.forEach(d => {
            html += criarItemHistoricoHTML(d);
        });
        
        // ✅ Renderização final na Timeline
        ul.innerHTML = html || `
            <div style="text-align:center; padding:60px; color:#94a3b8;">
                <i class="fas fa-folder-open fa-3x" style="opacity:0.2;"></i>
                <p style="margin-top:15px; font-weight:600;">Nenhum registro encontrado para este período.</p>
            </div>`;
        
    } catch(e){ 
        console.error("Erro no histórico:", e);
        ul.innerHTML = `
            <div style="text-align:center; padding:40px; color:#d90f23;">
                <i class="fas fa-exclamation-circle fa-2x"></i>
                <p style="margin-top:10px; font-weight:800;">Erro ao carregar atividades. Tente novamente.</p>
            </div>`;
    }
}
	async function loadGlobalHistory() {
    const listContainer = document.getElementById('global-history-list');
    const localFilter = document.getElementById('glob-hist-local').value;
    const conferenteFilter = document.getElementById('glob-hist-user').value; 
    
    if (!listContainer) return;

    listContainer.innerHTML = `
        <div style="text-align:center; padding:60px; color:#64748b;">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i>
            <p style="margin-top:15px; font-weight:700; text-transform:uppercase; font-size:0.8em;">
                Consultando registros da unidade ${currentUserData.unidade}...
            </p>
        </div>`;
    
    const dI = new Date(document.getElementById('glob-hist-start').value + 'T00:00:00');
    const dF = new Date(document.getElementById('glob-hist-end').value + 'T23:59:59');
    
    if (isNaN(dI.getTime()) || isNaN(dF.getTime())) {
        listContainer.innerHTML = `<div class="status-error">Selecione o período corretamente.</div>`;
        return;
    }

    const startTS = firebase.firestore.Timestamp.fromDate(dI);
    const endTS = firebase.firestore.Timestamp.fromDate(dF);

    try {
        // ✅ 1. CONSULTA DIRECIONADA (Filtro por Unidade no Servidor)
        let refConf = db.collection('resultados_conferencias')
                        .where('timestamp', '>=', startTS)
                        .where('timestamp', '<=', endTS);
        
        let refCheck = db.collection('resultados_checklist')
                         .where('timestamp', '>=', startTS)
                         .where('timestamp', '<=', endTS);

        // Se for GESTOR, ele só pode ver a própria unidade (Filtro nativo do banco)
        if (currentUserData.role === 'gestor') {
            refConf = refConf.where('unidade', '==', currentUserData.unidade);
            refCheck = refCheck.where('unidade', '==', currentUserData.unidade);
        }

        // Filtro opcional por nome do militar
        if (conferenteFilter) {
            refConf = refConf.where('conferente', '==', conferenteFilter);
            refCheck = refCheck.where('conferente', '==', conferenteFilter);
        }

        // Executa busca
        const [snapConf, snapCheck] = await Promise.all([
            refConf.orderBy('timestamp', 'desc').get(),
            refCheck.orderBy('timestamp', 'desc').get()
        ]);

        let docs = [];
        snapConf.forEach(d => docs.push({ ...d.data(), id_doc: d.id }));
        snapCheck.forEach(d => docs.push({ ...d.data(), id_doc: d.id }));

        // Ordena tudo por tempo
        docs.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

        let html = '';
        docs.forEach(d => {
            // ✅ 2. FILTRO DE LOCAL (Filtro na memória apenas para o local específico)
            const localLimpo = d.local.includes(': ') ? d.local.split(': ')[1] : (d.local.split(' - ')[1] || d.local);
            
            if(!localFilter || localLimpo === localFilter) {
                html += criarItemHistoricoHTML(d);
            }
        });

        listContainer.innerHTML = html || `<div style="text-align:center; padding:80px; color:#94a3b8;"><p>Nenhum registro encontrado.</p></div>`;

    } catch(e){ 
        console.error("Erro no loadGlobalHistory:", e);
        listContainer.innerHTML = `<div style="text-align:center; padding:40px; color:#d90f23;"><p>Erro na consulta. Certifique-se de que os índices do Firestore foram criados.</p></div>`;
    }
}
       function criarItemHistoricoHTML(data) {
    const dataHora = data.timestamp.toDate().toLocaleString('pt-BR');
    const temAlteracao = (data.itensRelatorio && data.itensRelatorio.some(i => i.status !== 'S/A')) || (!data.itensRelatorio && data.totalCaa > 0);
    
    // ✅ DEFINIÇÃO DE IDENTIDADE VISUAL POR MODO
    let iconClass = 'fa-file-alt';
    let corIcone = '#800020'; // Padrão Bordô
    let modoLabel = 'Conferência';

    if (data.modo === 'CHECKLIST_VISTORIA') {
        iconClass = 'fa-truck-check';
        corIcone = '#2c3e50'; // Azul Petróleo
        modoLabel = 'Vistoria VTR';
    } else if (data.modo === 'TRANSFERENCIA_CARGA') {
        iconClass = 'fa-right-left';
        corIcone = '#343a40'; // Grafite
        modoLabel = 'Carga';
    }

    const dataSegura = encodeURIComponent(JSON.stringify(data));

    return `
        <div class="sigma-v3-timeline-item">
            <div class="sigma-v3-timeline-card" onclick="reimprimirPDF(JSON.parse(decodeURIComponent('${dataSegura}')))" style="cursor: pointer;">
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <div style="width: 45px; height: 45px; border-radius: 12px; background: ${corIcone}15; color: ${corIcone}; display: flex; align-items: center; justify-content: center; font-size: 1.2em;">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    
                    <div class="sigma-v3-timeline-info">
                        <span class="sigma-v3-timeline-title">${data.local}</span>
                        <div class="sigma-v3-timeline-meta">
                            <span><i class="fas fa-tag"></i> ${modoLabel}</span>
                            <span><i class="far fa-clock"></i> ${dataHora}</span>
                        </div>
                        <div style="font-size: 0.7em; color: #64748b; margin-top: 2px;">
                            <i class="fas fa-user-edit"></i> Resp: ${data.conferente}
                        </div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="sigma-v3-timeline-badge" style="background: ${temAlteracao ? '#fff1f2' : '#f0fdf4'}; color: ${temAlteracao ? '#d90f23' : '#1b8a3e'};">
                        ${temAlteracao ? 'C/A' : 'S/A'}
                    </span>
                    <div style="color: #cbd5e1;">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </div>
    `;
}
        // --- 6. GESTÃO DE UNIDADES (ADMIN) ---
        async function carregarUnidadesVisuais() {
    const container = document.getElementById('units-cards-container');
    if (!container) return;

    // Loading Shimmer V3
    container.innerHTML = `
        <div style="grid-column: 1/-1; text-align:center; padding:60px; color:#64748b;">
            <i class="fas fa-sync fa-spin fa-3x" style="opacity:0.3; margin-bottom:15px; display:block;"></i>
            <span style="font-weight:700; letter-spacing:1px; text-transform:uppercase; font-size:0.8em;">Sincronizando Estrutura Organizacional...</span>
        </div>`;

    try {
        const snap = await db.collection('unidades_estruturadas').where('ativo', '==', true).get();
        
        if (snap.empty) {
            container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#94a3b8;">Nenhuma unidade cadastrada.</div>`;
            return;
        }

        const unidades = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Separação por Natureza para criar os Headers de Grupo
        const adm = unidades.filter(u => u.tipo === 'administrativo');
        const ope = unidades.filter(u => u.tipo === 'operacional');

        let html = '';

        const renderGrupo = (lista, titulo, icone, cor) => {
            if (lista.length === 0) return '';
            
            let grupoHtml = `
                <div class="unit-header" style="grid-column: 1/-1; display: flex; align-items: center; gap: 12px; margin: 30px 0 15px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; color: #1e293b; font-weight: 800; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">
                    <i class="fas ${icone}" style="color:${cor}"></i> ${titulo} (${lista.length})
                </div>`;

            lista.forEach(u => {
                const corTipo = u.tipo === 'administrativo' ? '#475569' : '#800020';
                const icon = u.tipo === 'administrativo' ? 'fa-landmark' : 'fa-building-shield';
                
                // Sanitização para o objeto de edição
                const uJson = JSON.stringify(u).replace(/'/g, "&apos;").replace(/"/g, "&quot;");

                grupoHtml += `
                    <div class="v3-posto-card" style="border-top: 6px solid ${corTipo}; min-height: 200px;">
                        <div class="v3-posto-actions">
                            <button class="v3-btn-action" title="Editar Unidade" onclick="abrirFormularioUnidade(JSON.parse('${uJson}'))">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="v3-btn-action" title="Excluir Unidade" onclick="deletarUnidadeSistema('${u.id}', '${u.sigla}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>

                        <div style="padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center;">
                            <div class="v3-icon-box" style="background: ${corTipo}15; color: ${corTipo}; width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; margin-bottom: 15px;">
                                <i class="fas ${icon}"></i>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <span style="display:block; font-weight:900; font-size:1.4em; color:#1e293b; letter-spacing:-0.5px;">${u.sigla}</span>
                                <span style="display:block; font-size: 0.7em; font-weight: 700; color: #64748b; text-transform: uppercase;">${u.nome_completo}</span>
                            </div>

                            <div style="width: 100%; border-top: 1px solid #f1f5f9; padding-top: 12px; margin-top: auto;">
                                <small style="display:block; font-size:0.6em; color:#94a3b8; font-weight:800; text-transform:uppercase; margin-bottom:4px;">Comando / Direção</small>
                                <span style="font-size:0.85em; font-weight:700; color:#1e293b;">
                                    <i class="fas fa-user-tie" style="margin-right:5px; opacity:0.5; color:${corTipo}"></i> ${u.comandante_nome_estatico || 'Não definido'}
                                </span>
                            </div>
                        </div>
                    </div>`;
            });
            return grupoHtml;
        };

        // Renderiza primeiro os Comandos (ADM) e depois as Unidades Operacionais
        html += renderGrupo(adm, 'Comandos e Diretorias', 'fa-crown', '#475569');
        html += renderGrupo(ope, 'Unidades Operacionais', 'fa-shield-halved', '#800020');

        container.innerHTML = html;

        // Gatilho de ícones FontAwesome
        if (window.FontAwesome) FontAwesome.dom.i2svg();

    } catch (e) {
        console.error("Erro ao renderizar unidades:", e);
        container.innerHTML = `<p style="color:red; text-align:center; padding:40px;">Erro ao carregar mapa de unidades.</p>`;
    }
}
      async function abrirFormularioUnidade(dadosEdicao = null) {
    const isEdit = !!dadosEdicao;
    
    Swal.fire({
        title: isEdit ? '<i class="fas fa-edit"></i> Editar Unidade' : '<i class="fas fa-sitemap"></i> Nova Unidade',
        width: '550px',
        html: `
            <div style="text-align: left; padding: 5px;">
                <div class="swal-v3-form-group">
                    <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">1. Nome Completo da Unidade</label>
                    <input type="text" id="swal-unid-nome" class="swal2-input" value="${isEdit ? dadosEdicao.nome_completo : ''}" placeholder="Ex: 1º Batalhão de Bombeiros Militar" style="width:100%; margin:5px 0 15px 0; border-radius: 10px;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="swal-v3-form-group">
                        <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">2. Sigla</label>
                        <input type="text" id="swal-unid-sigla" class="swal2-input" value="${isEdit ? dadosEdicao.sigla : ''}" placeholder="Ex: 1º BBM" style="width:100%; margin:5px 0 15px 0; border-radius: 10px; text-transform: uppercase;">
                    </div>
                    <div class="swal-v3-form-group">
                        <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">3. Natureza</label>
                        <select id="swal-unid-tipo" class="swal2-select" style="width:100%; margin:5px 0 15px 0; border-radius: 10px;">
                            <option value="operacional" ${isEdit && dadosEdicao.tipo === 'operacional' ? 'selected' : ''}>Operacional</option>
                            <option value="administrativo" ${isEdit && dadosEdicao.tipo === 'administrativo' ? 'selected' : ''}>Administrativo</option>
                        </select>
                    </div>
                </div>

                <div class="swal-v3-form-group" style="margin-top:10px; position: relative;">
                    <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">4. Comandante / Diretor (Busca Inteligente)</label>
                    <input type="text" id="swal-unid-comandante" class="swal2-input" value="${isEdit ? dadosEdicao.comandante_nome_estatico : ''}" placeholder="Digite o nome de guerra..." style="width:100%; margin:5px 0 0 0; border-radius: 10px;" autocomplete="off">
                    <input type="hidden" id="swal-unid-comandante-uid" value="${isEdit ? dadosEdicao.comandante_uid : ''}">
                    <div id="swal-unid-sugestoes" class="suggestions-box" style="display:none; position: absolute; width: 100%; z-index: 1000; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 10px 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'SALVAR UNIDADE',
        confirmButtonColor: '#800020',
        cancelButtonText: 'Cancelar',
        // ✅ INSERÇÃO DO DIDOPEN (LÓGICA DE AUTOCOMPLETE)
        didOpen: () => {
            const inputCmd = document.getElementById('swal-unid-comandante');
            const hiddenUid = document.getElementById('swal-unid-comandante-uid');
            const sugestoesBox = document.getElementById('swal-unid-sugestoes');

            inputCmd.addEventListener('input', () => {
                const termo = inputCmd.value.toUpperCase();
                sugestoesBox.innerHTML = '';
                
                if (termo.length < 2) {
                    sugestoesBox.style.display = 'none';
                    return;
                }

                // Filtra no array global de militares que você já possui
                const filtrados = allTargetUsers.filter(u => u.nome.toUpperCase().includes(termo));

                filtrados.forEach(militar => {
                    const item = document.createElement('div');
                    item.style.padding = '10px';
                    item.style.cursor = 'pointer';
                    item.style.borderBottom = '1px solid #eee';
                    item.innerHTML = `<i class="fas fa-user-shield" style="color:#800020"></i> ${militar.nome}`;
                    
                    item.onclick = () => {
                        inputCmd.value = militar.nome;
                        hiddenUid.value = militar.id;
                        sugestoesBox.style.display = 'none';
                        inputCmd.style.borderColor = '#166534'; // Verde para indicar seleção válida
                    };
                    sugestoesBox.appendChild(item);
                });

                sugestoesBox.style.display = filtrados.length > 0 ? 'block' : 'none';
            });

            // Fecha sugestões ao clicar fora
            document.addEventListener('click', (e) => {
                if (!inputCmd.contains(e.target)) sugestoesBox.style.display = 'none';
            });
        },
        preConfirm: () => {
            const nome = document.getElementById('swal-unid-nome').value.trim().toUpperCase();
            const sigla = document.getElementById('swal-unid-sigla').value.trim().toUpperCase();
            const comandante = document.getElementById('swal-unid-comandante').value.trim().toUpperCase();
            const comandanteUid = document.getElementById('swal-unid-comandante-uid').value;

            if (!nome || !sigla || !comandante) {
                return Swal.showValidationMessage('Todos os campos são obrigatórios');
            }

            return {
                nome_completo: nome,
                sigla: sigla,
                tipo: document.getElementById('swal-unid-tipo').value,
                comandante_nome_estatico: comandante,
                comandante_uid: comandanteUid
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            executarSalvamentoUnidade(isEdit ? dadosEdicao.uid : null, result.value);
        }
    });
}
        
async function executarSalvamentoUnidade(uid, dados) {
    Swal.fire({ 
        title: 'Sincronizando...', 
        html: 'Atualizando estrutura organizacional.',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading() 
    });

    try {
        const uidFinal = uid || ("UNID-" + Date.now());
        const unitRef = db.collection('unidades_estruturadas').doc(uidFinal);
        const dataHora = firebase.firestore.FieldValue.serverTimestamp();

        const payload = {
            uid: uidFinal,
            nome_completo: dados.nome_completo,
            sigla: dados.sigla,
            tipo: dados.tipo,
            comandante_nome_estatico: dados.comandante_nome_estatico,
            comandante_uid: dados.comandante_uid || "",
            ativo: true,
            ultima_atualizacao: dataHora,
            atualizado_por: currentUserData.nome_militar_completo
        };

        if (!uid) {
            payload.data_criacao = dataHora;
        }

        // Gravação Atômica
        await unitRef.set(payload, { merge: true });

        // Toast de Sucesso Sigma V3
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'success',
            title: uid ? 'Unidade atualizada!' : 'Unidade cadastrada com sucesso!'
        });

        carregarUnidadesVisuais(); // Recarrega o grid de cards

    } catch (e) {
        console.error("Erro ao salvar unidade:", e);
        Swal.fire('Erro Técnico', 'Não foi possível salvar a unidade no Firebase.', 'error');
    }
}
		//---GESTÃO DE POSTOS--- 08.01.2025
		async function abrirGestaoPosto(postoUid) {
    // 1. Busca os dados do Posto
    const postoDoc = await db.collection('postos_estruturados').doc(postoUid).get();
    if (!postoDoc.exists) return;
    const postoData = postoDoc.data();

    // Mostra loading inicial no SweetAlert
    Swal.fire({
        title: 'Sincronizando Ativos...',
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const minhaUnidadeId = currentUserData?.unidade_id;
        const souAdmin = (currentUserData?.role === 'admin' || currentUserData?.role === 'gestor_geral');

        // 2. Busca TODAS as listas ativas para cruzamento
        const listasSnapshot = await db.collection('listas_conferencia').where('ativo', '==', true).get();
        
        let htmlGestao = `<div style="margin-bottom: 20px; text-align: left;">
            <p style="font-size: 0.75em; font-weight: 800; color: #8e44ad; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px;">
                <i class="fas fa-truck-monster"></i> Suas Viaturas / Listas (Gestão Ativa)
            </p>`;
        
        let htmlLeitura = `<div style="text-align: left; border-top: 1px solid #eee; padding-top: 15px;">
            <p style="font-size: 0.75em; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px;">
                <i class="fas fa-lock"></i> Outras Unidades no Local
            </p>`;

        let contadorGestao = 0;
        let contadorLeitura = 0;

        listasSnapshot.forEach(doc => {
            const lista = doc.data();
            const estaNestePosto = (lista.posto_id === postoUid);
            const ehMinhaLista = (lista.unidade_id === minhaUnidadeId);
            const podeVincular = souAdmin || ehMinhaLista;

            if (podeVincular) {
                contadorGestao++;
                htmlGestao += `
                    <div class="swal-v3-list-item">
                        <div class="swal-v3-item-info">
                            <span class="swal-v3-item-name">${lista.ativo_nome}</span>
                            <span class="swal-v3-item-detail">${lista.unidade_sigla || 'Sem Unidade'}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" ${estaNestePosto ? 'checked' : ''} 
                                   onchange="vincularListaAoPosto('${doc.id}', '${postoUid}', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>`;
            } else if (estaNestePosto) {
                contadorLeitura++;
                htmlLeitura += `
                    <div class="swal-v3-list-item swal-v3-lock">
                        <div class="swal-v3-item-info">
                            <span class="swal-v3-item-name" style="color:#64748b;">${lista.ativo_nome}</span>
                            <span class="swal-v3-item-detail">${lista.unidade_sigla} (Unidade Externa)</span>
                        </div>
                        <i class="fas fa-shield-alt" style="color:#cbd5e1;"></i>
                    </div>`;
            }
        });

        htmlGestao += (contadorGestao === 0) ? '<p style="color:#94a3b8; font-size:0.8em; text-align:center;">Nenhuma viatura disponível para alocação.</p>' : '';
        htmlGestao += '</div>';
        
        htmlLeitura += (contadorLeitura === 0) ? '<p style="color:#cbd5e1; font-size:0.8em; text-align:center;">Nenhuma viatura externa vinculada.</p>' : '';
        htmlLeitura += '</div>';

        // 3. Renderiza o Modal Final
        Swal.fire({
            title: `<div style="font-size:0.7em; color:#8e44ad; font-weight:800; text-transform:uppercase;">Gerenciar Localização</div> ${postoData.nome}`,
            html: `
                <div style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:20px; border:1px solid #e2e8f0; text-align:left;">
                    <small style="color:#64748b; font-size:0.8em;"><i class="fas fa-map-marker-alt"></i> ${postoData.endereco}</small>
                </div>
                <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                    ${htmlGestao}
                    ${htmlLeitura}
                </div>
            `,
            showConfirmButton: true,
            confirmButtonText: 'CONCLUIR',
            confirmButtonColor: '#8e44ad',
            allowOutsideClick: true,
            didClose: () => {
                if (houveAlteracaoNoPosto) {
                    carregarPostosVisuais();
                    houveAlteracaoNoPosto = false;
                }
            }
        });

    } catch (e) {
        console.error("Erro ao gerir posto:", e);
        Swal.fire('Erro', 'Não foi possível carregar os ativos.', 'error');
    }
}

async function vincularListaAoPosto(listaUid, postoUid, associar) {
    try {
        const listaRef = db.collection('listas_conferencia').doc(listaUid);
        const postoRef = db.collection('postos_estruturados').doc(postoUid);
        const dadosPosto = (await postoRef.get()).data();

        const nomeMilitar = currentUserData ? `${currentUserData.posto} ${currentUserData.quadro} ${currentUserData.nome_guerra}` : "SISTEMA";

        await listaRef.update({
            posto_id: associar ? postoUid : null,
            posto_nome: associar ? dadosPosto.nome : "NÃO VINCULADO",
            ultima_movimentacao_posto: firebase.firestore.FieldValue.serverTimestamp(),
            movimentado_por: nomeMilitar
        });

        houveAlteracaoNoPosto = true; // Gatilho para atualizar os cards ao fechar o modal
        
        // Toast discreto de sucesso (padrão Sigma V3)
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        Toast.fire({ icon: 'success', title: associar ? 'Viatura alocada!' : 'Viatura removida!' });

    } catch (e) {
        console.error("Erro no vínculo:", e);
        Swal.showValidationMessage(`Erro ao salvar: ${e.message}`);
    }
}
		async function abrirFormularioPosto(dadosEdicao = null) {
    const isEdit = !!dadosEdicao;

    // Busca as unidades para preencher o novo seletor de Unidade Gestora
    const snapUnidades = await db.collection('unidades_estruturadas').where('ativo', '==', true).get();
    let optionsUnidades = '<option value="" disabled selected>Selecione a Unidade Responsável...</option>';
    
    snapUnidades.forEach(u => {
        const d = u.data();
        const selected = (isEdit && dadosEdicao.unidade_gestora_id === u.id) ? 'selected' : '';
        optionsUnidades += `<option value="${u.id}" data-sigla="${d.sigla}" ${selected}>${d.sigla} - ${d.nome_completo}</option>`;
    });

    Swal.fire({
        title: isEdit ? '<i class="fas fa-edit"></i> Editar Posto' : '<i class="fas fa-plus-circle"></i> Novo Posto',
        width: '550px',
        html: `
            <div style="padding: 5px; text-align: left;">
                <div class="swal-v3-form-group">
                    <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">1. Nome do Posto / Base:</label>
                    <input type="text" id="swal-posto-nome" class="swal2-input" placeholder="Ex: PRONTIDÃO ALFA" value="${isEdit ? dadosEdicao.nome : ''}" style="margin: 5px 0 15px 0; width:100%; border-radius: 10px;">
                </div>

                <div class="swal-v3-form-group">
                    <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">2. Unidade Gestora (Responsável pela Prontidão/Material):</label>
                    <select id="swal-posto-unidade-gestora" class="swal2-select" style="width:100%; margin: 5px 0 15px 0; border-radius: 10px; font-size: 0.9em;">
                        ${optionsUnidades}
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="swal-v3-form-group">
                        <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">3. Natureza:</label>
                        <select id="swal-posto-natureza" class="swal2-select" style="width:100%; margin: 5px 0 15px 0; border-radius: 10px; font-size: 0.85em;">
                            <option value="SERVIÇO OPERACIONAL" ${isEdit && dadosEdicao.natureza === 'SERVIÇO OPERACIONAL' ? 'selected' : ''}>OPERACIONAL</option>
                            <option value="MISSÃO" ${isEdit && dadosEdicao.natureza === 'MISSÃO' ? 'selected' : ''}>MISSÃO / ESPECIAL</option>
                        </select>
                    </div>
                    <div class="swal-v3-form-group">
                        <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">4. Endereço:</label>
                        <input type="text" id="swal-posto-endereco" class="swal2-input" placeholder="Localização..." value="${isEdit ? dadosEdicao.endereco : ''}" style="margin: 5px 0 0 0; width:100%; border-radius: 10px; font-size: 0.85em;">
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: isEdit ? 'SALVAR ALTERAÇÕES' : 'GRAVAR POSTO',
        confirmButtonColor: '#800020',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            const nome = document.getElementById('swal-posto-nome').value.trim().toUpperCase();
            const unidadeEl = document.getElementById('swal-posto-unidade-gestora');
            const gestora_id = unidadeEl.value;
            const gestora_sigla = unidadeEl.options[unidadeEl.selectedIndex].getAttribute('data-sigla');
            const natureza = document.getElementById('swal-posto-natureza').value;
            const endereco = document.getElementById('swal-posto-endereco').value.trim();
            
            if (!nome || !gestora_id) return Swal.showValidationMessage('Nome e Unidade Gestora são obrigatórios');
            
            return { nome, gestora_id, gestora_sigla, natureza, endereco };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            executarSalvamentoPosto(isEdit ? dadosEdicao.uid : null, result.value);
        }
    });
}
		async function executarSalvamentoPosto(uid, dados) {
    Swal.fire({ 
        title: 'Sincronizando...', 
        html: 'Gravando dados no território global.',
        didOpen: () => Swal.showLoading() 
    });

    try {
        const uidFinal = uid || ("POSTO-" + Date.now());
        const postoRef = db.collection('postos_estruturados').doc(uidFinal);
        const dataHora = firebase.firestore.FieldValue.serverTimestamp();
        
        const payload = {
            uid: uidFinal,
            nome: dados.nome,
            natureza: dados.natureza,
            endereco: dados.endereco || "Não informado",
            
            // ✅ VÍNCULO DE GESTÃO (Substitui o menu Bases)
            unidade_gestora_id: dados.gestora_id,
            unidade_gestora_sigla: dados.gestora_sigla,
            
            ativo: true,
            atualizado_por: currentUserData.nome_militar_completo,
            ultima_atualizacao: dataHora
        };

        if (!uid) {
            payload.criado_em = dataHora;
            payload.criado_por_unidade = currentUserData.unidade || "SISTEMA";
        }

        await postoRef.set(payload, { merge: true });

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'success',
            title: uid ? 'Posto atualizado!' : 'Novo posto cadastrado!'
        });

        carregarPostosVisuais();

    } catch (e) {
        console.error("Erro ao salvar posto:", e);
        Swal.fire({ icon: 'error', title: 'Falha na Gravação', confirmButtonColor: '#800020' });
    }
}
		function filtrarPostosCards() {
    // Remove espaços e hífens para busca aproximada (Ex: "1 BBM" acha "1BBM")
    const termo = document.getElementById('input-busca-posto').value.trim().toUpperCase().replace(/[^A-Z0-9]/gi, '');
    const cards = document.querySelectorAll('#postos-cards-container .v3-posto-card');

    cards.forEach(card => {
        // Captura todo o texto (Nome, Endereço e agora a Unidade Gestora)
        const textoCard = card.innerText.toUpperCase().replace(/[^A-Z0-9]/gi, '');
        
        if (textoCard.includes(termo)) {
            card.style.display = "flex";
            card.style.animation = "fadeIn 0.3s ease";
        } else {
            card.style.display = "none";
        }
    });

    // Filtro de títulos de grupo (Mantido, está perfeito)
    document.querySelectorAll('.v3-group-title').forEach(title => {
        let proximo = title.nextElementSibling;
        let temVisivel = false;
        while (proximo && !proximo.classList.contains('v3-group-title')) {
            if (proximo.classList.contains('v3-posto-card') && proximo.style.display !== 'none') {
                temVisivel = true;
                break;
            }
            proximo = proximo.nextElementSibling;
        }
        title.style.display = temVisivel ? "flex" : "none";
    });
}
		async function carregarPostosVisuais() {
    const container = document.getElementById('postos-cards-container');
    if (!container) return;

    // Loading Shimmer/Spinner V3 (Padronizado)
    container.innerHTML = `
        <div style="grid-column: 1/-1; text-align:center; padding:60px; color:#64748b;">
            <i class="fas fa-radar fa-spin fa-3x" style="opacity:0.3; margin-bottom:15px; display:block;"></i>
            <span style="font-weight:700; letter-spacing:1px; text-transform:uppercase; font-size:0.8em;">Sincronizando Territórios...</span>
        </div>`;

    try {
        // 1. Definição Cirúrgica de Permissão (Fácil manutenção posterior)
        const perfisAutorizadosAcoes = ['admin', 'gestor_geral']; 
        const podeEditarOuExcluir = perfisAutorizadosAcoes.includes(currentUserData?.role);

        // 2. Busca dados em paralelo (Performance)
        const [snapPostos, snapListas] = await Promise.all([
            db.collection('postos_estruturados').where('ativo', '==', true).get(),
            db.collection('listas_conferencia').where('ativo', '==', true).get()
        ]);

        if (snapPostos.empty) {
            container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#94a3b8;"><i class="fas fa-map-marked fa-3x" style="opacity:0.2; margin-bottom:15px; display:block;"></i>Nenhum posto de serviço cadastrado.</div>`;
            return;
        }

        const todasListas = snapListas.docs.map(d => d.data());
        const postos = snapPostos.docs.map(d => ({ id: d.id, ...d.data() }));

        // --- DIVISÃO POR GRUPOS (OPERACIONAL VS MISSÃO) ---
        const operacionais = postos.filter(p => p.natureza === 'SERVIÇO OPERACIONAL' || !p.natureza);
        const missoes = postos.filter(p => p.natureza === 'MISSÃO');

        let htmlFinal = '';

        const renderGrupo = (lista, titulo, cor) => {
            if (lista.length === 0) return '';
            let htmlGrupo = `<div class="v3-group-title" style="grid-column: 1/-1; display: flex; align-items: center; gap: 12px; margin: 30px 0 15px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; color: #1e293b; font-weight: 800; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">
                <i class="fas fa-house-flag" style="color:${cor}"></i> ${titulo} (${lista.length})
            </div>`;
            
            lista.forEach(posto => {
                const ativosNoPosto = todasListas.filter(l => l.posto_id === posto.id);
                const nomesAtivos = ativosNoPosto.map(l => l.ativo_nome);
                
                const isMissao = posto.natureza === 'MISSÃO';
                const corTema = isMissao ? '#2c3e50' : '#800020';
                const borderStyle = `border-left: 6px solid ${corTema} !important;`;

                htmlGrupo += `
                    <div class="v3-posto-card" 
                         onclick="abrirGestaoPosto('${posto.id}')"
                         style="${borderStyle} padding: 0; background: #fff; border-radius: 20px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; height: 100%; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; cursor: pointer; box-sizing: border-box;">
                        
                        <div class="v3-posto-actions" style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; z-index: 5;">
                            ${podeEditarOuExcluir ? `
                                <button class="v3-btn-action" style="background:none; border:none; color:#cbd5e1; cursor:pointer;" 
                                        onclick="event.stopPropagation(); abrirFormularioPosto({ uid: '${posto.id}', nome: '${posto.nome}', endereco: '${posto.endereco}', natureza: '${posto.natureza || 'SERVIÇO OPERACIONAL'}' })">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button class="v3-btn-action" style="background:none; border:none; color:#cbd5e1; cursor:pointer;" 
                                        onclick="event.stopPropagation(); deletarPostoSistema('${posto.id}', '${posto.nome}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : `<i class="fas fa-lock" style="color:#cbd5e1; font-size: 0.8em; margin: 4px;" title="Somente Leitura"></i>`}
                        </div>
                        
                        <div style="padding: 20px; flex-grow: 1; display: flex; flex-direction: column; align-items: center; text-align: center;">
                            <div class="v3-icon-box" style="width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4em; margin-bottom: 15px; background: ${corTema}10; color: ${corTema}; flex-shrink: 0;">
                                <i class="fas fa-house-flag"></i>
                            </div>

                            <div style="width: 100%; margin-bottom: 10px;">
                                <span style="display:block; font-weight:900; font-size:1.15em; color:#1e293b; letter-spacing:-0.4px; margin-bottom: 4px;">
                                    ${posto.nome}
                                </span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 5px; color: #64748b; font-size: 0.8em; font-weight: 600;">
                                    <i class="fas fa-map-marker-alt" style="opacity:0.5; color:#ef4444; font-size: 0.9em;"></i>
                                    <span style="line-height: 1.2;">${posto.endereco || 'Local não definido'}</span>
                                </div>
                            </div>

                            <div style="width: 100%; margin-top: auto; padding-top: 12px; border-top: 1px solid #f1f5f9;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                                    <span style="font-weight:800; color:#94a3b8; text-transform:uppercase; font-size:0.65em; letter-spacing:0.5px;">Ativos Alocados</span>
                                    <span style="font-size:0.85em; font-weight:900; color:${corTema};">${ativosNoPosto.length}</span>
                                </div>
                                <div style="color:#475569; font-weight:700; font-size:0.78em; line-height:1.4;">
                                    ${nomesAtivos.length > 0 ? nomesAtivos.join(' • ') : '<span style="color:#cbd5e1; font-weight:500; font-style:italic;">Nenhum ativo alocado</span>'}
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            return htmlGrupo;
        };

        htmlFinal = renderGrupo(operacionais, 'Prontidão Operacional', '#800020') + 
                   renderGrupo(missoes, 'Missões e Reforços', '#2c3e50');

        container.innerHTML = htmlFinal;

    } catch (e) {
        console.error("Erro fatal ao carregar postos:", e);
        container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#e11d48;"><i class="fas fa-exclamation-circle fa-2x"></i><br><b>Erro ao sincronizar territórios.</b></div>`;
    }
}
		
		async function deletarPostoSistema(uid, nome) {
    // 1. Confirmação de Segurança com Design Crítico
    const confirmacao = await Swal.fire({
        title: 'Excluir Posto?',
        html: `Você está prestes a remover <b>${nome}</b>.<br><br>
               <div style="font-size: 0.8em; background: #fff5f5; color: #c53030; padding: 10px; border-radius: 8px; border: 1px solid #feb2b2;">
                <i class="fas fa-exclamation-triangle"></i> <b>AVISO:</b> Viaturas vinculadas a este posto ficarão com o local indefinido.
               </div>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'SIM, EXCLUIR',
        cancelButtonText: 'CANCELAR',
        reverseButtons: true
    });

    if (!confirmacao.isConfirmed) return;

    // Feedback de processamento
    Swal.fire({
        title: 'Removendo...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const batch = db.batch();
        const postoRef = db.collection('postos_estruturados').doc(uid);
        const legacyRef = db.collection('config_geral').doc('postos');

        // 2. Limpeza do legado (Coleção antiga de strings)
        batch.update(legacyRef, {
            lista: firebase.firestore.FieldValue.arrayRemove(nome)
        });

        // 3. Desativação Lógica (Padrão de Auditoria Sigma)
        batch.update(postoRef, {
            ativo: false,
            data_exclusao: firebase.firestore.FieldValue.serverTimestamp(),
            excluido_por: currentUserData?.nome_militar_completo || "SISTEMA"
        });

        await batch.commit();

        // 4. Feedback Visual Imediato (Efeito de Desintegração)
        const cards = document.querySelectorAll('.unit-building-card');
        cards.forEach(card => {
            // Verifica o UID ou o texto para garantir que removemos o card certo
            if (card.innerHTML.includes(uid) || card.innerText.includes(nome)) {
                card.style.transition = "all 0.6s cubic-bezier(0.4, 0, 0.2, 1)";
                card.style.opacity = "0";
                card.style.transform = "translateY(20px) scale(0.9)";
                card.style.filter = "blur(10px)";
                
                setTimeout(() => {
                    card.remove();
                    // Se o grid ficar vazio, recarrega a mensagem de "Nenhum posto"
                    const restantes = document.querySelectorAll('#postos-cards-container .unit-building-card');
                    if (restantes.length === 0) carregarPostosVisuais();
                }, 600);
            }
        });

        // Toast de confirmação final
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
        Toast.fire({ icon: 'success', title: 'Posto removido com sucesso' });

    } catch (e) {
        console.error("Erro ao excluir posto:", e);
        Swal.fire({
            icon: 'error',
            title: 'Erro Técnico',
            text: 'Não foi possível desativar o posto no banco de dados.',
            confirmButtonColor: '#8e44ad'
        });
    }
}
        // --- FUNÇÕES DE FORMATAÇÃO DE TEXTO (NECESSÁRIAS PARA O PDF) ---

function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    // Adicionando a função formatarDataSimples do outro arquivo
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('pt-BR');
}

	function prepararDadosParaTransferencia(transferenciaData) {
    const itensConferidos = [];
    let totalCaa = 0;

    window.dadosConferencia.forEach(setor => {
        setor.itens.forEach(item => {
            const uidBusca = item.tombamento ? `${item.id_base || item.id}-${item.tombamento}` : (item.id_base || item.id);
            const statusLocal = window.itemStatus[uidBusca] || { status: 'ok' };
            
            if (statusLocal.status !== 'ok') totalCaa++;

            itensConferidos.push({
                nomeCompleto: item.tombamento ? `${item.nome} (Tomb: ${item.tombamento})` : item.nome,
                quantidade: item.quantidade || 1,
                status: statusLocal.status === 'ok' ? 'S/A' : 'C/A',
                setor: setor.nome,
                pendencias_ids: item.pendencias_ids || [],
                obs: statusLocal.obs || ''
            });
        });
    });

    return {
        id: transferenciaData.id || transferenciaData.transferencia_id,
        id_amigavel: `TR-${new Date().getFullYear()}/${(transferenciaData.id || '').substring(0,5).toUpperCase()}`,
        modo: 'TRANSFERENCIA_CARGA',
        local: transferenciaData.destino_sigla,
        origem_sigla: transferenciaData.origem_sigla,
        destino_sigla: transferenciaData.destino_sigla,
        emitente: transferenciaData.emitente || 'DLOG',
        conferente: `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`,
        timestamp: { seconds: Math.floor(Date.now() / 1000) },
        totalItensConferidos: itensConferidos.length,
        totalCaa: totalCaa,
        itensRelatorio: itensConferidos
    };
}	
function reimprimirPDF(data) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const MARGIN = 14, PG_W = 210, LOGO_S = 15;

        // ✅ Identificação de Modo e Identidade Visual (Adicionado TRANSFERENCIA)
        const isChecklist = data.modo === 'CHECKLIST_VISTORIA';
        const isTransferencia = data.modo === 'TRANSFERENCIA_CARGA';
        
        // Cores: Bordô para Relatórios, Azul Petróleo para Vistorias, Cinza Grafite para Transferências
        const COR_PRIMARIA = isChecklist ? [44, 62, 80] : (isTransferencia ? [33, 37, 41] : [128, 0, 32]);
        const TITULO_DOC = isChecklist ? "RELATÓRIO DE VISTORIA DE VIATURA" : (isTransferencia ? "TERMO DE TRANSFERÊNCIA DE CARGA" : "RELATÓRIO DE CONFERÊNCIA");

        const logoDraw = (domId, x) => { 
            const el = document.querySelector(`img[src*="${domId}"]`);
            if(el) { 
                try {
                    const c = document.createElement('canvas');
                    c.width = 160; c.height = 160;
                    c.getContext('2d').drawImage(el, 0, 0, 160, 160);
                    doc.addImage(c.toDataURL('image/png'), 'PNG', x, 10, LOGO_S, LOGO_S);
                } catch(e) { console.warn(`Logo erro: ${domId}`); } 
            }
        };
        
        logoDraw('cbmrr.png', MARGIN);
        logoDraw('logo_sigma.png', PG_W - MARGIN - LOGO_S);

        // Cabeçalho Institucional
        doc.setFontSize(10).setTextColor(51).setFont('helvetica', 'bold');
        doc.text('GOVERNO DE RORAIMA', PG_W/2, 15, {align:'center'}); 
        doc.setTextColor(217,15,35).text('CORPO DE BOMBEIROS MILITAR DE RORAIMA', PG_W/2, 20, {align:'center'}); 
        doc.setTextColor(51).setFont('helvetica', 'italic').text('"Amazônia: patrimônio dos brasileiros"', PG_W/2, 25, {align:'center'});
        
        // Título Dinâmico
        doc.setFontSize(14).setTextColor(COR_PRIMARIA[0], COR_PRIMARIA[1], COR_PRIMARIA[2]).setFont('helvetica', 'bold').text(TITULO_DOC, PG_W/2, 35, {align:'center'});

        // ✅ Container de Informações Adaptável (Box Cinza)
        const boxHeight = (isChecklist || isTransferencia) ? 32 : 25;
        doc.setFillColor(240, 240, 240).setDrawColor(200, 200, 200).roundedRect(MARGIN, 40, PG_W - (MARGIN*2), boxHeight, 2, 2, 'FD');
        
        const dataTimestamp = data.timestamp?.seconds ? new Date(data.timestamp.seconds * 1000) : new Date();
        
        if (isTransferencia) {
            // Layout Específico para Transferência (Origem vs Destino)
            doc.setFontSize(9).setTextColor(50).setFont('helvetica','bold').text('GUIA Nº:', MARGIN + 5, 46); 
            doc.setFont('helvetica','normal').text(data.id_amigavel || data.id, MARGIN + 35, 46); 
            doc.setFont('helvetica','bold').text('ORIGEM:', MARGIN + 5, 52); 
            doc.setFont('helvetica','normal').text(`${data.origem_sigla} (${data.emitente})`, MARGIN + 35, 52); 
            doc.setFont('helvetica','bold').text('DESTINO:', MARGIN + 5, 58); 
            doc.setFont('helvetica','normal').text(`${data.destino_sigla} (${data.conferente})`, MARGIN + 35, 58);
            doc.setFont('helvetica','bold').text('DATA REC:', MARGIN + 5, 64); 
            doc.setFont('helvetica','normal').text(dataTimestamp.toLocaleString('pt-BR'), MARGIN + 35, 64);
        } else {
            // Layout Original (Checklist/Conferência)
            doc.setFontSize(9).setTextColor(50).setFont('helvetica','bold').text(isChecklist ? 'Viatura:' : 'Local:', MARGIN + 5, 46); 
            doc.setFont('helvetica','normal').text(data.local || '', MARGIN + 35, 46); 
            doc.setFont('helvetica','bold').text('Conferente:', MARGIN + 5, 52); 
            doc.setFont('helvetica','normal').text(data.conferente || '', MARGIN + 35, 52); 
            doc.setFont('helvetica','bold').text('Data/Hora:', MARGIN + 5, 58); 
            doc.setFont('helvetica','normal').text(dataTimestamp.toLocaleString('pt-BR'), MARGIN + 35, 58); 

            if (isChecklist) {
                doc.setFont('helvetica','bold').text('Odômetro:', MARGIN + 5, 64);
                doc.setFont('helvetica','normal').text(`${data.km_entrada || '0'} KM`, MARGIN + 35, 64);
                doc.setFont('helvetica','bold').text('Tanque:', MARGIN + 100, 64);
                doc.setFont('helvetica','normal').text(`${data.combustivel_entrada || 'N/D'}`, MARGIN + 120, 64);
            }
        }

        doc.setFont('helvetica','bold').setTextColor(COR_PRIMARIA[0], COR_PRIMARIA[1], COR_PRIMARIA[2]).text(`ITENS: ${data.totalItensConferidos || 0} | C/A: ${data.totalCaa || 0}`, PG_W - MARGIN - 5, 46, {align:'right'});

        // Montagem da Tabela
        let tableBody = [];
        const RED_FILL = [217, 15, 35], GREEN_FILL = [27, 138, 62], SECTOR_BG = (isChecklist || isTransferencia) ? COR_PRIMARIA : [60, 60, 60];
        let listaParaImprimir = data.itensRelatorio || data.itensCaa || [];
        
        if (listaParaImprimir.length > 0) {
            let currentSector = null;
            listaParaImprimir.forEach(item => {
                const nomeSetor = (item.setor || "").toUpperCase();
                if (isChecklist && (nomeSetor.includes("FOTO") || nomeSetor.includes("OBSERVAÇ"))) return;

                let setorItem = item.setor || "ITENS GERAIS";
                if(setorItem !== currentSector) {
                    tableBody.push([{ content: setorItem.toUpperCase(), colSpan: 4, styles: { fillColor: SECTOR_BG, textColor: 255, fontStyle: 'bold', halign: 'left' } }]);
                    currentSector = setorItem;
                }

                let finalObs = '-';
                if (item.pendencias_ids && item.pendencias_ids.length > 0) {
                    // ✅ AJUSTE CIRÚRGICO: Inclusão da data e formatação padrão SIGMA
                    finalObs = item.pendencias_ids.map(p => {
                        const dataP = p.data_criacao || "";
                        return `\u2022 Por ${p.autor_nome}${dataP ? ' em ' + dataP : ''}: ${p.descricao}`;
                    }).join('\n');
                } else if (item.obs) {
                    finalObs = item.obs;
                }

                let bgStatus = (item.status === 'C/A') ? RED_FILL : GREEN_FILL;
                
                tableBody.push([ 
                    item.nomeCompleto || 'Item', 
                    { content: `${item.quantidade || 1} un.`, styles: { halign: 'center' } }, 
                    { content: item.status || 'S/A', styles: { fillColor: bgStatus, textColor: 255, fontStyle: 'bold', halign: 'center' } }, 
                    { content: finalObs, styles: { halign: 'left', fontSize: 7 } }
                ]);
            });
        }
        
        doc.autoTable({ 
            startY: 45 + boxHeight, 
            head: [['Descrição do Item', 'Qtd', 'Status', 'Observações / Pendências']], 
            body: tableBody, 
            theme: 'striped', 
            styles: { fontSize: 8, valign: 'middle', textColor: 51, cellPadding: 2 }, 
            columnStyles: { 0:{cellWidth:75}, 1:{cellWidth:15}, 2:{cellWidth:15}, 3:{cellWidth:'auto'} }, 
            headStyles: { fillColor: COR_PRIMARIA, textColor: 255, fontStyle: 'bold', halign: 'center' } 
        });

        let finalY = doc.lastAutoTable.finalY + 10;

        // ✅ SEÇÃO ORIGINAL PRESERVADA: Considerações Gerais
        if (isChecklist && data.obs_gerais_vistoria) {
            if (finalY > 250) { doc.addPage(); finalY = 20; }
            doc.setFontSize(10).setFont('helvetica', 'bold').setTextColor(COR_PRIMARIA[0], COR_PRIMARIA[1], COR_PRIMARIA[2]);
            doc.text("CONSIDERAÇÕES GERAIS DA VISTORIA:", MARGIN, finalY);
            doc.setFont('helvetica', 'normal').setTextColor(50).setFontSize(9);
            const splitObs = doc.splitTextToSize(data.obs_gerais_vistoria, PG_W - (MARGIN * 2));
            doc.text(splitObs, MARGIN, finalY + 6);
            finalY += (splitObs.length * 5) + 12;
        }

        // ✅ SEÇÃO ORIGINAL PRESERVADA: Registro Fotográfico
        if (isChecklist) {
            if (finalY > 230) { doc.addPage(); finalY = 20; }
            doc.setFontSize(10).setFont('helvetica', 'bold').setTextColor(COR_PRIMARIA[0], COR_PRIMARIA[1], COR_PRIMARIA[2]);
            doc.text("EVIDÊNCIAS FOTOGRÁFICAS (ANEXOS):", MARGIN, finalY);
            
            const boxW = 55, boxH = 40, spacing = 5;
            for(let i=0; i<5; i++) {
                const col = i % 3;
                const row = Math.floor(i / 3);
                const xPos = MARGIN + (col * (boxW + spacing));
                const yPos = finalY + 5 + (row * (boxH + spacing));
                
                doc.setDrawColor(200).setFillColor(245).rect(xPos, yPos, boxW, boxH, 'F');
                doc.setFontSize(7).setTextColor(150).text(`FOTO ${i+1}`, xPos + boxW/2, yPos + boxH/2, {align:'center'});
                doc.text("(Aguardando Integração Storage)", xPos + boxW/2, yPos + boxH/2 + 4, {align:'center'});
            }
        }

        // Rodapé Institucional + Autenticidade Digital
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8).setTextColor(100).setFont('helvetica', 'normal');
            
            // Texto original
            doc.text('SIGMA - Sistema Integrado de Gestão de Materiais e Vistorias', MARGIN, doc.internal.pageSize.height-10);
            doc.text(`Pág. ${i} de ${totalPages}`, PG_W-MARGIN, doc.internal.pageSize.height-10, {align:'right'});

            // ✅ NOVO: Hash de Autenticidade (Selo de segurança)
            const hashSimples = btoa(`${data.id}-${data.conferente}`).substring(0, 20).toUpperCase();
            doc.setFontSize(7).setTextColor(150).setFont('courier', 'normal');
            doc.text(`CHAVE DE AUTENTICIDADE: ${hashSimples}`, MARGIN, doc.internal.pageSize.height-15);
        }
        
        const dataIso = dataTimestamp.toISOString().split('T')[0];
    	const prefixo = isTransferencia ? 'Termo_Carga' : (isChecklist ? 'Vistoria' : 'Relatorio');
    	const nomeArquivo = `${prefixo}_${(data.local||'Conf').replace(/[^a-zA-Z0-9]/g,'')}_${dataIso}.pdf`;
    
    	// Gera os dados binários (Blob) e cria a URL temporária
    	const pdfBlob = doc.output('blob');
    	const pdfUrl = URL.createObjectURL(pdfBlob);
    
    	// Alimenta o Modal Sigma V3
    	document.getElementById('sigma-v3-pdf-frame').src = pdfUrl;
    	document.getElementById('pdf-modal-filename').textContent = nomeArquivo;
    	document.getElementById('modal-pdf-viewer').style.display = 'flex';
    
    	// Salva globalmente para as funções de Imprimir/Compartilhar
    	window.currentPdfBlob = pdfBlob;
    	window.currentPdfName = nomeArquivo;
        
    } catch(e) { 
        console.error("Erro PDF Unificado:", e);
        alert("Erro ao gerar PDF: " + e.message);
    }
}
		/* --- FUNÇÕES DE CONTROLE DO VISUALIZADOR DE PDF SIGMA V3 --- */

	// 1. FECHAR: Limpa a memória e esconde o modal
function fecharVisualizadorPdf() {
    const frame = document.getElementById('sigma-v3-pdf-frame');
    if (frame) frame.src = 'about:blank'; // Evita rastro do PDF anterior
    document.getElementById('modal-pdf-viewer').style.display = 'none';
}

// 2. IMPRIMIR: Foca no documento e dispara a impressora
function imprimirPdfInterno() {
    const frame = document.getElementById('sigma-v3-pdf-frame');
    if (frame && frame.contentWindow) {
        frame.contentWindow.focus();
        frame.contentWindow.print();
    } else {
        alert("Não foi possível acionar a impressora neste navegador.");
    }
}

// 3. COMPARTILHAR: Integração nativa com Android/iOS (WhatsApp, etc)
async function compartilharPdfInterno() {
    if (!window.currentPdfBlob) return alert("Nenhum arquivo pronto para compartilhar.");

    const file = new File([window.currentPdfBlob], window.currentPdfName, { type: 'application/pdf' });

    // Verifica se o navegador suporta compartilhamento de arquivos (Mobile e Safari Desktop)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
            await navigator.share({
                title: 'SIGMA - Relatório',
                text: 'Segue em anexo o relatório gerado pelo sistema SIGMA.',
                files: [file]
            });
        } catch (err) {
            console.log("Compartilhamento cancelado.");
        }
    } else {
        // Fallback: Se não suportar share, ele faz o download como segurança
        const link = document.createElement('a');
        link.href = URL.createObjectURL(window.currentPdfBlob);
        link.download = window.currentPdfName;
        link.click();
        Swal.fire({ icon: 'info', title: 'Download realizado', text: 'Seu dispositivo não suporta compartilhamento direto, o arquivo foi baixado.', timer: 2000 });
    }
}
		// --- OUTROS E FUNÇÕES GLOBAIS (UI) ---
        
        function sairDoSistema() { 
            auth.signOut().then(() => { 
                sessionStorage.clear(); 
                window.location.href = 'index.html'; 
            });
        }
        function logout() {
            sairDoSistema();
        }
        
        function switchView(v) {
    // 1. LIMPEZAS E PREPARAÇÕES INICIAIS
    const editorArq = document.getElementById('view-editor-arquitetura');
    if (editorArq) editorArq.style.display = 'none';

    const contentPrincipal = document.querySelector('.content');
    if (contentPrincipal) contentPrincipal.style.padding = '20px';

    document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');

    const appRunner = document.getElementById('app-runner-container');
    if (appRunner) { appRunner.style.display = 'none'; }

    // ✅ CORREÇÃO CIRÚRGICA: Limpa todos os links ativos (Pai e Submenu) antes de qualquer ação
    document.querySelectorAll('#main-sidebar a, .sigma-v3-submenu a').forEach(el => el.classList.remove('active'));

    // ✅ BLOCO INTERCEPTADOR DE CAUTELAS (POSIÇÃO CORRIGIDA)
    // Este bloco precisa interceptar 'v' antes da lógica de 'targetId'
    if (v && v.startsWith('cautelas')) {
        // Mostra apenas a seção PAI (view-cautelas)
        const viewCautelas = document.getElementById('view-cautelas');
        if (viewCautelas) viewCautelas.style.display = 'block';

        // Limpa o palco interno para novo conteúdo
        const container = document.getElementById('cautelas-content');
        if (container) container.innerHTML = '<div style="text-align:center; padding:50px;"><i class="fas fa-sync fa-spin"></i> Preparando tela...</div>';

        // Dispara a função correspondente
        if (v === 'cautelas-nova') loadNewCautelaForm();
        else if (v === 'cautelas-ativas') showCautelasDashboard('Cautelas Ativas');
        else if (v === 'cautelas-receber') showCautelasDashboard('Cautelas a Receber');
        else if (v === 'cautelas-historico') showCautelasDashboard('Histórico');

        // Marca o link ativo no submenu da Sidebar V3
        const subLink = document.getElementById(`link-${v}`);
        if (subLink) subLink.classList.add('active');

        // Retorna aqui para evitar o erro de "View não encontrada" abaixo
        return; 
    }

    // 2. CONTROLE DE ACESSO DINÂMICO (Sidebar)
    if (currentUserData) {
        const role = currentUserData.role;
        const podeGerenciar = (role === 'admin' || role === 'gestor_geral' || role === 'gestor');
        
        const linkListas = document.getElementById('link-listas');
        const linkPostos = document.getElementById('link-postos');
        const linkGlobalHistory = document.getElementById('link-global-history');
        
        if (linkListas) linkListas.style.display = podeGerenciar ? 'block' : 'none';
        if (linkPostos) linkPostos.style.display = podeGerenciar ? 'block' : 'none';
        if (linkGlobalHistory) linkGlobalHistory.style.display = podeGerenciar ? 'block' : 'none';
    }

    // 3. DEFINIÇÃO DINÂMICA DA VIEW (Lógica padrão)
    let targetId;
    if (v === 'listas') {
        targetId = 'menu-editor-listas';
    } else if (v === 'editor-arquitetura') {
        targetId = 'view-editor-arquitetura';
    } else {
        targetId = `view-${v}`;
    }

    const viewElement = document.getElementById(targetId);
    
    if (viewElement) {
        viewElement.style.display = 'block';
    } else {
        console.error(`View não encontrada: ${targetId}`);
        return;
    }
    
    // 4. ATIVAÇÃO VISUAL DO LINK NA SIDEBAR (Links de nível 1)
    const activeLink = document.getElementById(`link-${v}`);
    if (activeLink) {
        activeLink.classList.add('active');
    }

    // 5. DISPARO DE CARREGAMENTO DE DADOS ESPECÍFICOS
    if (v === 'dashboard') {
        const resCont = document.getElementById('resume-container');
        const adminCont = document.getElementById('admin-gestor-cards-container');

        if (resCont) resCont.innerHTML = ''; 
        carregarAlertasTransferencia();

        if (currentUserData) {
            const role = currentUserData.role || 'operacional';
            const isAdmin = (role === 'admin');
            const isGestorGeral = (role === 'gestor_geral');
            const canView = isAdmin || isGestorGeral || (role === 'gestor');

            if (role === 'operacional') {
                renderOperacionalCards();
            } else {
                if (adminCont) adminCont.style.display = 'block';
                renderAdminGestorCards(canView);
            }
        }
    }

    if (v === 'almoxarifado') {
        carregarAlmoxarifadoUI();
    }

    if (v === 'unidades') {
        carregarUnidadesVisuais();
        configurarBuscaComandanteUnidade();
    }
    
    if (v === 'postos') {
        carregarPostosVisuais();
    }

    if (v === 'vtr-bases') {
        carregarVtrBasesCards();
    }

    if (v === 'usuarios') {
        listarUsuarios();
        carregarUnidadesSelect();
        setupCadastroMilitarLogic();
    }
            
    if (v === 'listas') {
        carregarCardsListasExistentes(); 
    }

    if (v === 'global-history') {
        const startInput = document.getElementById('glob-hist-start');
        const endInput = document.getElementById('glob-hist-end');
        if (startInput) startInput.valueAsDate = new Date(new Date().setDate(new Date().getDate() - 30));
        if (endInput) endInput.valueAsDate = new Date();
        
        carregarUsuariosFiltro();
        loadGlobalHistory();
    }

    if (v === 'my-history') {
        const startInput = document.getElementById('my-hist-start');
        const endInput = document.getElementById('my-hist-end');
        if (startInput) {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            startInput.valueAsDate = startDate;
        }
        if (endInput) endInput.valueAsDate = new Date();
        
        loadMyHistory();
    }

    // 6. TRATAMENTO MOBILE
    if (window.innerWidth <= 768) {
        history.pushState(null, null, location.href);
        if (typeof closeMenuMobile === "function") closeMenuMobile();
    }
}
        // Alterna entre abrir e fechar o menu lateral no mobile
		function toggleMenuMobile() { 
    		const s = document.getElementById('main-sidebar');
    		const overlay = document.getElementById('mobile-overlay');
    
    		if(s.classList.contains('mobile-active')) { 
        		s.classList.remove('mobile-active'); 
        		overlay.style.display = 'none'; 
    		} else { 
        		s.classList.add('mobile-active'); 
        		overlay.style.display = 'block'; 
    		} 
		}

		// Força o fechamento do menu e do fundo escurecido (overlay)
		function closeMenuMobile() { 
    		const s = document.getElementById('main-sidebar');
    		const overlay = document.getElementById('mobile-overlay');

    		if(s) s.classList.remove('mobile-active'); 
    		if(overlay) overlay.style.display = 'none';
		}
        
        // --- FUNÇÕES DO MODAL GESTÃO C/A ---
        function mostrarTabela(data) {
    const wrapper = document.getElementById('ca-table-wrapper');
    const gridContainer = document.getElementById('sigma-v3-dynamic-grid');
    const msgNoIssues = document.getElementById('no-issues-msg');

    if (!wrapper || !gridContainer) return;

    // 1. CABEÇALHO PREMIUM: Mantendo sua lógica de informações de conferência
    document.getElementById('table-title').innerHTML = `
        <div style="display: flex; flex-direction: column; line-height: 1.2;">
            <span style="letter-spacing: -0.5px;">Lista: ${data.local}</span>
            <span style="font-size: 0.55em; color: #64748b; font-weight: 600; margin-top: 6px; text-transform: uppercase;">
                <i class="fas fa-user-check" style="color: #1b8a3e;"></i> Conferido por: <b style="color: #1e293b;">${data.conferente}</b> em ${data.date}
            </span>
        </div>
    `;
    
    // Limpa o grid antes de renderizar
    gridContainer.innerHTML = '';

    const pendenciasReais = data.items || [];

    if (pendenciasReais.length === 0) {
        gridContainer.style.display = 'none';
        if (msgNoIssues) msgNoIssues.style.display = 'block';
    } else {
        gridContainer.style.display = 'grid';
        if (msgNoIssues) msgNoIssues.style.display = 'none';

        pendenciasReais.forEach(p => {
            const statusG = p.status_gestao || 'PENDENTE';
            const ehCautela = p.tipoRegistro === 'CAUTELA';
            
            // Definição de cores e ícones baseada no seu sistema de carimbos
            const colorRef = ehCautela ? '#f57c00' : (statusG === 'PENDENTE' ? '#d90f23' : '#2c7399');
            const badgeBg = ehCautela ? '#fff3e0' : (statusG === 'PENDENTE' ? '#ffebee' : '#e0f2fe');
            const iconRef = ehCautela ? 'fa-hand-holding' : 'fa-exclamation-triangle';

            // ✅ CORREÇÃO CIRÚRGICA: Mantém o nome completo do autor (Posto Quadro Nome) 
            // Removido o .split(' ').pop() que causava a perda da patente.
            const nomeAutorCompleto = p.autor_nome || "Militar não identificado";

            // Preparação dos dados para o botão (Sua lógica original preservada)
            const btnData = {
                docId: data.docId,
                listaId: data.lista_id,
                itemId: p.itemId,
                pendenciaId: p.id,
                nome: p.itemNome,
                tombamento: p.tombamento || "",
                descricao: p.descricao,
                qtd: p.quantidade
            };
            const btnJson = JSON.stringify(btnData).replace(/'/g, "\\'");

            // Construção do Card Individual Sigma V3
            const card = document.createElement('div');
            card.className = 'sigma-v3-card-item';
            
            card.innerHTML = `
                <div class="sigma-v3-card-header">
                    <span class="sigma-v3-badge" style="background: ${badgeBg}; color: ${colorRef};">
                        <i class="fas ${iconRef}"></i> ${statusG}
                    </span>
                    <span class="sigma-v3-date">
                        <i class="far fa-calendar-alt"></i> ${p.data_criacao || data.date.split(',')[0]}
                    </span>
                </div>

                <h4>${p.itemNome}</h4>
                
                <div style="display: flex; gap: 10px; font-size: 0.75em; font-weight: 800; text-transform: uppercase;">
                    ${p.tombamento ? 
                        `<span style="color: #800020;"><i class="fas fa-tag"></i> Tomb: ${p.tombamento}</span>` : 
                        `<span style="color: #d90f23;"><i class="fas fa-layer-group"></i> Qtd: ${p.quantidade} un.</span>`}
                </div>

                <p class="sigma-v3-obs-box">
                    "${p.descricao}"
                </p>

                <div class="sigma-v3-author-info">
                    <i class="fas fa-user-edit"></i> 
                    <span>Por: <b>${nomeAutorCompleto}</b></span>
                </div>

                ${!ehCautela ? 
                    `<button class="sigma-v3-btn-manage" onclick='abrirModalGestaoID(${btnJson})'>
                        <i class="fas fa-gavel"></i> Gerenciar Pendência
                    </button>` : 
                    `<div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 10px; font-size: 0.7em; color: #94a3b8; font-weight: 700; border: 1px dashed #cbd5e1;">
                        <i class="fas fa-lock"></i> ITEM EM POSSE PESSOAL
                    </div>`
                }
            `;

            gridContainer.appendChild(card);
        });
    }

    wrapper.style.display = 'block';
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
		
function abrirModalGestaoID(data) {
    // 1. Elementos de Interface
    const elNome = document.getElementById('gestao-item-nome');
    const elObs = document.getElementById('gestao-obs');
    const modal = document.getElementById('modal-gestao-ca');

    if (!modal) return console.error("Modal de gestão não encontrado no HTML.");

    // 2. Preenchimento de Identidade do Material
    elNome.textContent = data.nome || data.nomeCompleto || "Item não identificado";
    
    // 3. Mapeamento de IDs para o Processamento (Inputs Hidden)
    // Certifique-se que esses IDs existem no seu HTML
    document.getElementById('gestao-doc-id').value = data.docId || "";           // Resultado da Conf.
    document.getElementById('gestao-item-id-lista').value = data.itemId || "";   // UID Global (Inventário)
    
    const inputPendId = document.getElementById('gestao-pendencia-id');
    if (inputPendId) {
        inputPendId.value = data.pendenciaId || ""; // O ID da Pendência (PEND-...)
    }

    // 4. Configuração do Campo de Texto
    if (elObs) {
        elObs.value = '';
        const desc = data.descricao || "Sem descrição";
        elObs.placeholder = `Descreva a solução para: ${desc}`;
    }

    // 5. Reset de campos de quantidade (se houver)
    const elQtd = document.getElementById('gestao-qtd');
    if (elQtd) elQtd.value = data.qtd || data.quantidade || '1';

    // 6. Exibição
    modal.style.display = 'flex';
    console.log("🛠️ Modal de Gestão aberto para a pendência:", data.pendenciaId);
}
        function fecharTabela(){ 
            document.getElementById('ca-table-wrapper').style.display='none';
        }

        function fecharModalGestao(){ 
            document.getElementById('modal-gestao-ca').style.display='none';
        }

        function toggleGestaoQtd() {
    		const status = document.getElementById('gestao-status').value;
    		const divQtd = document.getElementById('div-gestao-qtd');
    		const max = document.getElementById('gestao-item-max-qtd').value;
    		const inputQtd = document.getElementById('gestao-qtd');
    		const infoQtd = document.getElementById('gestao-qtd-info');

    		if (status === 'Solucionado') {
        		divQtd.style.display = 'block';
        		inputQtd.max = max; // Define o limite físico no input
        		infoQtd.textContent = `Máximo disponível para solução: ${max} un.`;
    		} else {
        		divQtd.style.display = 'none';
    		}
		}

        document.getElementById('gestao-status').onchange = toggleGestaoQtd;
        
        async function salvarGestaoCa() {
    const docId = document.getElementById('gestao-doc-id').value;          // Doc em resultados_conferencias
    const itemId = document.getElementById('gestao-item-id-lista').value;  // UID Global (DNA do material)
    const pendId = document.getElementById('gestao-pendencia-id').value;   // ID da pendência (PEND-...)
    const statusAcao = document.getElementById('gestao-status').value;     // Solucionado, Em solução, etc.
    const obsGestor = document.getElementById('gestao-obs').value.trim();
    const qtdInformada = parseInt(document.getElementById('gestao-qtd').value) || 1;

    if (!obsGestor) return alert("Descreva a ação tomada.");

    const btnSalvar = document.querySelector('.btn-sync');
    btnSalvar.disabled = true;
    btnSalvar.textContent = "PROCESSANDO...";

    try {
        const nomeGestor = `${currentUserData.posto} ${currentUserData.nome_guerra}`;
        const dataHora = new Date().toLocaleString('pt-BR');
        const batch = db.batch();

        // 1. ATUALIZAR NO REGISTRO DE RESULTADOS (DASHBOARD)
        const resRef = db.collection('resultados_conferencias').doc(docId);
        const resSnap = await resRef.get();
        if (!resSnap.exists) throw new Error("Registro de conferência não encontrado.");

        let resData = resSnap.data();
        let itensRelatorio = resData.itensRelatorio || []; // Usamos itensRelatorio que é a fonte oficial do PDF

        const itemRes = itensRelatorio.find(i => i.id === itemId || i.uid_global === itemId);
        
        if (itemRes && itemRes.pendencias_ids) {
            const pIdx = itemRes.pendencias_ids.findIndex(p => p.id === pendId);
            if (pIdx > -1) {
                if (statusAcao === 'Solucionado') {
                    itemRes.pendencias_ids.splice(pIdx, 1); // Remove do dashboard pois foi resolvido
                    if (itemRes.pendencias_ids.length === 0) itemRes.status = 'S/A';
                } else {
                    itemRes.pendencias_ids[pIdx].status_gestao = statusAcao.toUpperCase();
                    itemRes.pendencias_ids[pIdx].descricao += `\n[GESTÃO ${dataHora} - ${nomeGestor}]: ${obsGestor}`;
                }
            }
        }
        batch.update(resRef, { itensRelatorio });

        // 2. SINCRONIZAÇÃO COM O INVENTÁRIO (DEVOLUÇÃO DE SALDO)
        // ✅ AJUSTE CIRÚRGICO: Se resolvido, o saldo sai de PENDENTE e volta para DISPONÍVEL
        if (statusAcao === 'Solucionado' && itemId) {
            const unidadeId = currentUserData.unidade_id || "UNID-1767838511310";
            const saldoRef = db.collection('inventario').doc(itemId).collection('saldos_unidades').doc(unidadeId);
            
            batch.update(saldoRef, {
                qtd_disp: firebase.firestore.FieldValue.increment(qtdInformada),
                qtd_pend: firebase.firestore.FieldValue.increment(-qtdInformada),
                last_update: dataHora
            });

            // Registro no Histórico de Vida do Material
            const histRef = saldoRef.collection('historico_vida').doc("SOL-" + Date.now());
            batch.set(histRef, {
                data: dataHora,
                evento: "SOLUCAO_GESTOR",
                quem: nomeGestor,
                detalhes: `✅ Pendência ${pendId} resolvida via Dashboard. Despacho: ${obsGestor}`,
                quantidade: qtdInformada
            });
        }

        await batch.commit();

        Swal.fire({
            icon: 'success',
            title: 'Ação Registrada!',
            text: statusAcao === 'Solucionado' ? 'O item retornou ao status DISPONÍVEL no inventário.' : 'Status de solução atualizado.',
            confirmButtonColor: '#800020'
        });

        document.getElementById('modal-gestao-ca').style.display = 'none';
        if (typeof loadCaaData === 'function') loadCaaData();
        if (typeof fecharTabela === 'function') fecharTabela();

    } catch (e) {
        console.error("Erro na gestão:", e);
        alert("Erro ao processar ação: " + e.message);
    } finally {
        btnSalvar.disabled = false;
        btnSalvar.textContent = "Salvar Ação";
    }
}
	function controlarToggleUsuario() {
    const container = document.getElementById('form-cadastro-usuario');
    const btnControl = document.getElementById('btn-toggle-usuario');
    const btnAcao = document.getElementById('btn-usuario-acao-principal');
    const tituloForm = document.getElementById('titulo-form-usuario');
    const campoSenha = document.getElementById('group-new-user-password');
    const btnExcluir = document.getElementById('btn-usuario-excluir'); // ✅ Adicionado
    
    container.classList.toggle('collapsed');
    const estaFechado = container.classList.contains('collapsed');

    if (estaFechado) {
        btnControl.innerHTML = '<i class="fas fa-user-plus"></i> Novo Militar';
        btnControl.style.backgroundColor = ""; 
        
        document.getElementById('edit-user-uid').value = '';
        
        tituloForm.innerHTML = '<i class="fas fa-user-shield"></i> Cadastrar Novo Militar';
        btnAcao.innerHTML = 'Gravar Militar no Sistema';
        btnAcao.className = "btn-modern-action btn-create"; 
        btnAcao.style.backgroundColor = ""; // ✅ Reseta a cor para o padrão (Bordô)

        campoSenha.style.display = 'block';
        if (btnExcluir) btnExcluir.style.display = 'none'; // ✅ Esconde o botão de excluir no fechamento

        const inputs = container.querySelectorAll('input, select');
        inputs.forEach(campo => {
            if (campo.id !== 'edit-user-uid') {
                campo.value = '';
            }
        });
        
        document.getElementById('new-user-quadro').disabled = true;

    } else {
        btnControl.innerHTML = '<i class="fas fa-times"></i> Cancelar';
        btnControl.style.backgroundColor = "#5d6d7e";
    }
}	
        
       async function criarUsuario() {
    const cpfRaw = document.getElementById('new-user-cpf').value.replace(/\D/g, '');
    const password = document.getElementById('new-user-password').value.trim();
    
    if (cpfRaw.length !== 11) return alert("Erro: Informe um CPF válido com 11 dígitos.");
    if (password.length < 6) return alert("Erro: A senha deve ter pelo menos 6 caracteres.");

    const emailLogin = `${cpfRaw}@sigma.com.br`;
    const emailContato = document.getElementById('new-user-email').value.trim();
    const guerra = document.getElementById('new-user-guerra').value.trim().toUpperCase();
    const posto = document.getElementById('new-user-posto').value;
    const quadro = document.getElementById('new-user-quadro').value;
    const completo = document.getElementById('new-user-completo').value.trim().toUpperCase();
    const role = document.getElementById('new-user-role').value;
    
    const selectUnit = document.getElementById('new-user-unit');
    const unitId = selectUnit.value; 
    const unitSigla = selectUnit.options[selectUnit.selectedIndex].text;
    
    const matriculaRaw = document.getElementById('new-user-matricula').value.replace(/\D/g, '');
    const telefoneRaw = document.getElementById('new-user-telefone').value.replace(/\D/g, '');

    if (!guerra || !posto || !quadro || !unitId || !completo || !matriculaRaw || !telefoneRaw) {
        return alert("Erro: Preencha todos os campos obrigatórios.");
    }
    
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    const whatsappUrl = `https://web.whatsapp.com/send?phone=55${telefoneRaw}`;

    // ✅ AJUSTE CIRÚRGICO: Seletor do botão usando o ID único da nova arquitetura
    const btn = document.getElementById('btn-usuario-acao-principal');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando conta...';

    try {
        const userCredential = await secondaryAuth.createUserWithEmailAndPassword(emailLogin, password);
        const userUid = userCredential.user.uid;

        await secondaryAuth.signOut();

        await db.collection('usuarios').doc(userUid).set({ 
            uid: userUid,
            email: emailLogin,
            email_contato: emailContato,
            nome_guerra: guerra, 
            posto: posto,
            quadro: quadro,
            nome_completo: completo,
            nome_militar_completo: nomeMilitarCompleto,
            telefone_contato: document.getElementById('new-user-telefone').value,
            whatsapp_url: whatsappUrl,
            cpf: cpfRaw,
            matricula: matriculaRaw,
            role: role, 
            unidade: unitSigla,
            unidade_id: unitId,
            foto_url: "", 
            data_cadastro: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`✅ Militar ${nomeMilitarCompleto} cadastrado!\n\nACESSO:\nCPF: ${cpfRaw}\nSenha: ${password}`); 
        
        // ✅ AJUSTE CIRÚRGICO: Chama nossa função unificada para fechar e limpar o formulário
        controlarToggleUsuario();
        
        listarUsuarios();
    } catch(e) { 
        console.error(e);
        alert("Erro ao cadastrar: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Gravar Militar no Sistema';
    }
}
		async function excluirUsuario() {
    const uid = document.getElementById('edit-user-uid').value;
    const nomeGuerra = document.getElementById('new-user-guerra').value;

    if (!uid) return alert("Erro: Nenhum militar selecionado para exclusão.");

    // Alerta de segurança padrão SIGMA
    const confirmacao = confirm(`⚠️ ATENÇÃO!\n\nVocê está prestes a excluir o militar: ${nomeGuerra}.\n\nEsta ação removerá o perfil do Firestore. O login (Auth) deverá ser removido manualmente no Firebase Console.\n\nDeseja continuar?`);
    
    if (!confirmacao) return;

    try {
        await db.collection('usuarios').doc(uid).delete();
        alert(`Militar ${nomeGuerra} removido com sucesso.`);
        
        // Fecha o formulário e limpa tudo
        controlarToggleUsuario();
        
        // Atualiza a listagem
        listarUsuarios();
        
    } catch (e) {
        console.error("Erro ao excluir militar:", e);
        alert("Erro técnico ao excluir: " + e.message);
    }
}
		async function prepararEdicaoUsuario(uid) {
    try {
        const doc = await db.collection('usuarios').doc(uid).get();
        if (!doc.exists) return alert("Militar não encontrado!");
        const u = doc.data();

        const container = document.getElementById('form-cadastro-usuario');
        const btnControl = document.getElementById('btn-toggle-usuario');
        
        if (container.classList.contains('collapsed')) {
            container.classList.remove('collapsed');
            btnControl.innerHTML = '<i class="fas fa-times"></i> Cancelar Edição';
            btnControl.style.backgroundColor = "#5d6d7e";
        }

        document.getElementById('edit-user-uid').value = uid;
        document.getElementById('new-user-completo').value = u.nome_completo || '';
        document.getElementById('new-user-guerra').value = u.nome_guerra || '';
        document.getElementById('new-user-posto').value = u.posto || '';
        
        const selectPosto = document.getElementById('new-user-posto');
        const selectQuadro = document.getElementById('new-user-quadro');
        atualizarQuadroCad(selectPosto, selectQuadro);
        selectQuadro.value = u.quadro || '';

        document.getElementById('new-user-cpf').value = u.cpf || '';
        document.getElementById('new-user-matricula').value = u.matricula || '';
        document.getElementById('new-user-telefone').value = u.telefone_contato || '';
        document.getElementById('new-user-email').value = u.email_contato || u.email || '';
        document.getElementById('new-user-role').value = u.role || 'operacional';
        document.getElementById('new-user-unit').value = u.unidade_id || '';

        document.getElementById('titulo-form-usuario').innerHTML = '<i class="fas fa-user-edit"></i> Editar Dados do Militar';
        
        const btnAcao = document.getElementById('btn-usuario-acao-principal');
        btnAcao.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
        btnAcao.className = "btn-modern-action btn-edit"; // Atualiza a classe se necessário
        btnAcao.style.backgroundColor = "#2c7399";

        document.getElementById('group-new-user-password').style.display = 'none';

        // ✅ INCLUSÃO CIRÚRGICA: Mostra o botão de excluir apenas na edição
        const btnExcluir = document.getElementById('btn-usuario-excluir');
        if (btnExcluir) btnExcluir.style.display = 'block';

        container.scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch (e) {
        console.error("Erro ao carregar dados para edição:", e);
        alert("Erro ao carregar dados do militar.");
    }
}

        async function listarUsuarios() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
    
    // ✅ AJUSTE: O Gestor agora filtra pelo unidade_id (mais preciso)
    const isGestor = currentUserData.role === 'gestor';
    const unidadeIdGestor = currentUserData.unidade_id; 
    
    let userQuery = db.collection('usuarios');
    
    if (isGestor && unidadeIdGestor) {
        userQuery = userQuery.where('unidade_id', '==', unidadeIdGestor);
    }

    try {
        const snap = await userQuery.get();
        
        allUsersData = [];
        snap.forEach(doc => {
            allUsersData.push({ id: doc.id, ...doc.data() }); 
        });
        
        if (allUsersData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Nenhum militar encontrado nesta unidade.</td></tr>';
            return;
        }

        // Chama o filtro para renderizar a tabela na tela
        filtrarUsuarios();
        
    } catch(e) {
        console.error("Erro ao listar usuários:", e);
        tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar lista de usuários.</td></tr>';
    }
}
        
       async function salvarAlteracoesUsuario(uid) {
    const guerra = document.getElementById('new-user-guerra').value.trim().toUpperCase();
    const posto = document.getElementById('new-user-posto').value;
    const quadro = document.getElementById('new-user-quadro').value;
    const completo = document.getElementById('new-user-completo').value.trim().toUpperCase();
    const role = document.getElementById('new-user-role').value;
    
    const selectUnit = document.getElementById('new-user-unit');
    const unitId = selectUnit.value; 
    const unitSigla = selectUnit.options[selectUnit.selectedIndex].text;
    
    const matriculaRaw = document.getElementById('new-user-matricula').value.replace(/\D/g, '');
    const telefoneRaw = document.getElementById('new-user-telefone').value.replace(/\D/g, '');
    const emailContato = document.getElementById('new-user-email').value.trim();

    if (!guerra || !posto || !quadro || !unitId || !completo || !matriculaRaw || !telefoneRaw) {
        return alert("Erro: Todos os campos são obrigatórios para atualizar o militar.");
    }
    
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    const whatsappUrl = `https://web.whatsapp.com/send?phone=55${telefoneRaw}`;

    const btn = document.getElementById('btn-usuario-acao-principal');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';

    try {
        await db.collection('usuarios').doc(uid).update({ 
            nome_guerra: guerra, 
            posto: posto,
            quadro: quadro,
            nome_completo: completo,
            nome_militar_completo: nomeMilitarCompleto,
            telefone_contato: document.getElementById('new-user-telefone').value,
            email_contato: emailContato,
            whatsapp_url: whatsappUrl,
            matricula: matriculaRaw,
            role: role, 
            unidade: unitSigla,
            unidade_id: unitId
        });
        
        alert("Dados do militar atualizados com sucesso!"); 
        
        // Fecha o formulário e limpa tudo usando a função que já criamos
        controlarToggleUsuario();
        
        // Atualiza a tabela
        listarUsuarios();
    } catch(e) { 
        console.error("Erro ao editar:", e);
        alert("Erro ao atualizar dados: " + e.message);
    } finally {
        btn.disabled = false;
    }
}
        async function carregarUsuariosFiltro() {
    const select = document.getElementById('glob-hist-user');
    if (!select) return;

    select.innerHTML = '<option value="">Todos</option>';
    
    // ✅ AJUSTE: O Gestor agora filtra pelo unidade_id (mais seguro e preciso)
    const isGestor = currentUserData.role === 'gestor';
    const unidadeIdGestor = currentUserData.unidade_id;

    let userQuery = db.collection('usuarios');
    
    if (isGestor && unidadeIdGestor) {
        userQuery = userQuery.where('unidade_id', '==', unidadeIdGestor);
    }

    try {
        const snap = await userQuery.get();
        let users = [];
        snap.forEach(doc => {
            const u = doc.data();
            if (u.nome_militar_completo) {
                users.push(u.nome_militar_completo);
            }
        });

        // Remove duplicatas e ordena alfabeticamente
        [...new Set(users)].sort().forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

    } catch (e) {
        console.error("Erro ao carregar filtro de usuários:", e);
    }
}
        
function getNovaCautelaFormHTML() {
    return `
        <div class="sigma-v3-title-label" style="margin-bottom: 25px;">
            <i class="fas fa-file-contract" style="color: #800020;"></i>
            <span>Nova Cautela de Material</span>
        </div>

        <div style="background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #eef2f6;">
            <div class="form-grid-2-columns" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                
                <div class="form-group">
                    <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 8px;">
                        <i class="fas fa-user-tag"></i> Destinatário (Recebedor)
                    </label>
                    <div class="custom-select-container">
                        <input type="hidden" id="cautela-destinatario-uid">
                        <input type="text" id="cautela-destinatario" placeholder="Nome, posto ou matrícula" required autocomplete="off" 
                               style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc;">
                        <div id="cautela-suggestions-box" class="suggestions-box">
                            <ul id="cautela-suggestions-list"></ul>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 8px;">
                        <i class="fas fa-warehouse"></i> Local de Origem
                    </label>
                    <select id="cautela-local-origem" required onchange="loadCustodiaItens()" 
                            style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc;">
                        <option value="" disabled selected>Selecione sua custódia...</option>
                    </select>
                </div>
            </div>
        
            <h4 style="margin-top: 30px; margin-bottom: 15px; font-weight: 800; font-size: 0.85em; color: #800020; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                <i class="fas fa-clipboard-list"></i> Seleção de Materiais
            </h4>
            
            <div id="itens-custodia-list" style="background: #f8fafc; border-radius: 15px; min-height: 150px; padding: 20px; border: 2px dashed #e2e8f0;">
                <p style="text-align: center; color: #94a3b8; font-size: 0.9em; margin-top: 40px;">
                    Selecione a Origem para listar seus itens disponíveis.
                </p>
            </div>
        
            <div class="form-group" style="margin-top: 25px;">
                <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 8px;">Observações</label>
                <textarea id="cautela-obs" rows="3" placeholder="Detalhes ou justificativa..." 
                          style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc;"></textarea>
            </div>
            
            <button class="btn-create" onclick="iniciarCautelaProcesso()" id="btn-iniciar-cautela" disabled 
                    style="width: 100%; margin-top: 20px; padding: 15px; border-radius: 12px; background: #800020; color: white; font-weight: 800; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; box-shadow: 0 4px 15px rgba(128,0,32,0.2);">
                <i class="fas fa-paper-plane"></i> ENVIAR CAUTELA (0 itens)
            </button>
        </div>
    `;
}

/**
 * Carrega o formulário de Nova Cautela, escondendo o menu de botões.
 * Chamado pelo botão "Nova Cautela".
 */
function loadNewCautelaForm() {
    const contentArea = document.getElementById('cautelas-content');

    if (contentArea) {
        // Injeta o novo HTML limpo
        contentArea.innerHTML = getNovaCautelaFormHTML();
        
        // Ativa os listeners de busca (Autocomplete)
        if (typeof setupCautelaDestinatarioListener === 'function') {
            setupCautelaDestinatarioListener();
        }
        
        // Libera campos e carrega dados iniciais
        setTimeout(() => {
            const obsField = document.getElementById('cautela-obs');
            if (obsField) {
                obsField.removeAttribute('readonly'); 
                obsField.removeAttribute('disabled');
            }
        }, 50);

        loadCustodiaLocais(); 
        loadUsersForSearch();
    }
}
/**
 * Volta para o Menu Principal de Cautelas (os 4 botões).
 * Chamado pelo botão "Voltar ao Menu" no formulário e no dashboard.
 */
function showMainMenu() {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');

    // 1. Limpa e esconde a área de conteúdo (formulário ou dashboard)
    if (contentArea) {
        contentArea.innerHTML = '';
        contentArea.style.display = 'none';
    }

    // 2. Exibe o menu de 4 botões novamente (usando grid para layout responsivo)
    if (menuContainer) {
        menuContainer.style.display = 'grid'; 
    }
}
    function showCautelasDashboard(type) {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');
    
    // Mantém a compatibilidade com o layout de cards se ele ainda existir
    if (menuContainer) menuContainer.style.display = 'none';

    if (contentArea) {
        let htmlContent = '';
        let icon = '';
        let title = '';
        let description = '';

        // Definindo as variáveis de texto para evitar repetição de HTML
        if (type === 'Cautelas Ativas') {
            icon = 'fa-clipboard-check';
            title = 'Cautelas Ativas';
            description = 'Lista de materiais sob sua cautela. Clique em uma linha para ver os detalhes.';
        } else if (type === 'Cautelas a Receber') {
            icon = 'fa-inbox';
            title = 'Cautelas a Receber (Ação Imediata)';
            description = 'Cautelas emitidas por terceiros que precisam ser confirmadas por você.';
        } else if (type === 'Histórico') {
            icon = 'fa-archive';
            title = 'Histórico de Cautelas';
            description = 'Visualize as cautelas finalizadas de acordo com o seu papel na transação.';
        }

        // Cabeçalho Padrão Sigma V3 (Substitui o antigo header-container)
        htmlContent = `
            <div class="sigma-v3-title-label" style="margin-bottom: 20px;">
                <i class="fas ${icon}" style="color: #800020;"></i>
                <span>${title}</span>
            </div>
            <p style="font-size: 0.85em; color: #64748b; margin-bottom: 25px; padding-left: 5px;">${description}</p>
        `;

        if (type === 'Cautelas Ativas') {
            htmlContent += `
                <div class="sigma-v3-clean-card">
                    <div id="loading-cautelas" style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i><br><span style="font-size:0.8em; font-weight:700; margin-top:10px; display:block;">SINCRONIZANDO REGISTROS...</span>
                    </div>
                    <div class="table-responsive">
                        <table class="sigma-v3-table" id="cautelas-ativas-table" style="display: none; width:100%;">
                            <thead>
                                <tr>
                                    <th>ID</th><th>Destinatário</th><th>Emissão</th><th>Local Origem</th><th>Itens</th><th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="cautelas-ativas-body"></tbody>
                        </table>
                    </div>
                </div>`;
            setTimeout(() => loadActiveCautelas(), 50);

        } else if (type === 'Cautelas a Receber') {
            htmlContent += `
                <div class="sigma-v3-clean-card">
                    <div id="loading-receive" style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i><br><span style="font-size:0.8em; font-weight:700; margin-top:10px; display:block;">BUSCANDO PENDÊNCIAS...</span>
                    </div>
                    <div class="table-responsive">
                        <table class="sigma-v3-table" id="cautelas-receive-table" style="display: none; width:100%;">
                            <thead>
                                <tr>
                                    <th>ID</th><th>Emitente</th><th>Emissão</th><th>Local Origem</th><th>Itens</th><th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="cautelas-receive-body"></tbody>
                        </table>
                    </div>
                </div>`;
            setTimeout(() => loadCautionsToReceive(), 50);

        } else if (type === 'Histórico') {
            htmlContent += `
                <div class="sigma-v3-clean-card">
                    <div id="historico-abas-operacional" class="sigma-v3-tab-container" style="display: flex; gap: 10px; margin-bottom: 25px;">
                        <button class="sigma-v3-tab active" onclick="loadHistorico('minhas')">Minhas (Custódia)</button>
                        <button class="sigma-v3-tab" onclick="loadHistorico('devolucao')">Devoluções</button>
                        <button class="sigma-v3-tab" onclick="loadHistorico('emitidas')">Emitidas por Mim</button>
                    </div>
                    <div id="historico-content-container">
                        <div id="loading-historico" style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-sync fa-spin fa-2x"></i><br><span style="font-size:0.8em; font-weight:700; margin-top:10px; display:block;">CARREGANDO HISTÓRICO...</span>
                        </div>
                    </div>
                </div>`;
            setTimeout(() => loadHistorico('minhas'), 50);
        } else {
            console.warn("View de Cautelas desconhecida:", type);
        }

        contentArea.innerHTML = htmlContent;
        contentArea.style.display = 'block';
    }
}
    async function loadUsersForSearch() {
    // 1. BUSCA IRRESTRITA E EXCLUSÃO DO PRÓPRIO USUÁRIO
    let userQuery = db.collection('usuarios'); 
    const militarLogadoCompleto = currentUserData.nome_militar_completo;

    try {
        const usersSnapshot = await userQuery.get();
        // Zera o array global antes de popular
        allTargetUsers = []; 
        
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            const nomeCompleto = user.nome_militar_completo; 
            
            // Excluir o próprio usuário logado
            if (nomeCompleto && nomeCompleto !== militarLogadoCompleto) {
                // Salva o objeto completo no array (com ID e nome)
                allTargetUsers.push({
                    id: doc.id, // 🛑 CRÍTICO: Este é o UID
                    nome: nomeCompleto
                });
            }
        });
        
        // 2. CONFIGURA LISTENERS APÓS CARREGAR DADOS
        setupCautelaDestinatarioListener();

    } catch (error) {
        console.error("Erro ao carregar usuários para a busca:", error);
    }
}
		
      function setupCautelaDestinatarioListener() {
    // Referências dos elementos
    const input = document.getElementById('cautela-destinatario');
    const suggestionsBox = document.getElementById('cautela-suggestions-box');
    const suggestionsList = document.getElementById('cautela-suggestions-list');
    const uidInput = document.getElementById('cautela-destinatario-uid');

    if (!input || !suggestionsBox || !suggestionsList || !uidInput) {
        console.error("Elementos do Autocomplete de Cautela não encontrados. Não é possível configurar o listener.");
        return;
    }

    // 🛑 0. CORREÇÃO CRÍTICA DO BLUR/CLICK (MOUSEDOWN)
    // Previne que o campo perca o foco (blur) quando o usuário clica na lista.
    suggestionsBox.addEventListener('mousedown', (event) => {
        if (event.target.closest('li')) {
            event.preventDefault(); // Impede o 'blur' do input, permitindo que o 'click' seja processado.
            // console.log("MOUSEDOWN - BLUR do input temporariamente prevenido.");
        }
    });

    // 1. LISTENER DE DIGITAÇÃO (Filtra e Renderiza)
    input.addEventListener('input', () => {
        const searchTerm = input.value.trim(); // Não converte para UPPERCASE aqui para usar na RegExp
        suggestionsList.innerHTML = '';
        
        // Limpa o UID e a cor do border ao digitar qualquer coisa nova
        uidInput.value = ''; 
        input.style.borderColor = '#ccc'; 

        if (searchTerm.length < 3) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const searchTermUpper = searchTerm.toUpperCase(); // Termo em caixa alta para a busca
        
        const filteredUsers = allTargetUsers.filter(user => 
            user.nome.toUpperCase().includes(searchTermUpper)
        ).sort((a, b) => a.nome.localeCompare(b.nome));

        if (filteredUsers.length > 0) {
            
            // 🛑 CRIA A EXPRESSÃO REGULAR PARA O DESTAQUE
            // 'gi' = global (todas as ocorrências) e case-insensitive (ignora caixa alta/baixa)
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            
            let html = '';
            filteredUsers.forEach(user => {
                const fullUserName = user.nome; 
                const safeName = fullUserName.replace(/'/g, "&#39;"); 

                // 🛑 CORREÇÃO: Usa a regex para substituir a ocorrência do termo de busca
                // pelo termo envolvido em tags <strong>.
                const highlightedName = fullUserName.replace(regex, '<strong>$1</strong>');
                
                // O layout visual anterior (separando posto/quadro) foi removido
                // para simplificar e garantir que o destaque funcione em qualquer parte do nome.
                
                html += `<li data-user-name="${safeName}" data-uid="${user.id}">
                             <span style="color: #800020;">${highlightedName}</span>
                         </li>`;
            });
            
            suggestionsList.innerHTML = html;
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    // 2. LISTENER DE SELEÇÃO (Preenche o Input e Esconde a Lista)
    suggestionsList.addEventListener('click', (event) => {
        const listItem = event.target.closest('li'); 

        if (listItem) {
            const selectedNameRaw = listItem.getAttribute('data-user-name');
            const selectedUid = listItem.getAttribute('data-uid');
            const selectedName = selectedNameRaw ? selectedNameRaw.replace(/&#39;/g, "'") : '';

            // console.log("SELEÇÃO CLIQUE - Capturado. UID:", selectedUid, " Nome:", selectedName);

            if (selectedName && selectedUid) {
                
                // Preenche os valores
                input.value = selectedName; 
                uidInput.value = selectedUid;
                input.style.borderColor = '#1b8a3e';
                suggestionsBox.style.display = 'none';
                
                // Força o foco de volta para o input (complemento do mousedown)
                input.focus(); 
                
                // Dispara o change para revalidação
                input.dispatchEvent(new Event('change'));
                
            } else {
                console.warn("Falha na Captura do Item da Lista: UID ou Nome ausente.");
                uidInput.value = '';
                input.style.borderColor = 'red';
            }
        }
    });

    // 3. LÓGICA DE VALIDAÇÃO NO BLUR (Perda de Foco)
    input.addEventListener('blur', () => {
        
        setTimeout(() => {
            suggestionsBox.style.display = 'none';
            
            const finalName = input.value.trim();
            
            // console.log("BLUR VALIDATION - Final Name:", finalName, " UID:", uidInput.value);

            if (finalName.length > 0 && !uidInput.value) {
                
                const isNameValid = allTargetUsers.some(user => user.nome.trim() === finalName);

                if (!isNameValid) {
                    input.value = ''; 
                    input.style.borderColor = 'red';
                    uidInput.value = ''; 
                    // console.warn("BLUR - Inválido/Não selecionado. Campo Limpo.");
                } else {
                    // Fallback
                    const validUser = allTargetUsers.find(user => user.nome.trim() === finalName);
                    if (validUser) {
                        uidInput.value = validUser.id; 
                        input.style.borderColor = '#1b8a3e';
                        // console.log("BLUR - UID preenchido por fallback de nome válido.");
                    } else {
                        input.value = '';
                        input.style.borderColor = 'red';
                        uidInput.value = '';
                    }
                }
            } else if (finalName.length === 0) {
                // Campo vazio, garantir que o UID esteja vazio e resetar a cor
                uidInput.value = '';
                input.style.borderColor = '#ccc';
                // console.log("BLUR - Campo Vazio. Resetado.");
            }
            
        }, 100); 
    });

    // 4. Garante que a caixa reapareça ao focar se houver texto
    input.addEventListener('focus', () => {
        if (input.value.length >= 3) {
            input.dispatchEvent(new Event('input')); 
        }
    });
}
		
async function loadCustodiaLocais() {
    const selectLocal = document.getElementById('cautela-local-origem');
    const militarUid = firebase.auth().currentUser.uid;

    if (!selectLocal || !militarUid) {
        const fallbackNome = currentUserData.nome_militar_completo || 'Usuário Desconhecido';
        selectLocal.innerHTML = `<option value="" disabled selected>Erro: Usuário (${fallbackNome}) não identificado.</option>`;
        return;
    }
    
    selectLocal.disabled = true;
    selectLocal.innerHTML = '<option value="" disabled selected>Carregando locais...</option>';
    
    try {
        // Busca na coleção 'custodia_atual' as listas onde o militar logado é o conferente
        const custodyRef = db.collection('custodia_atual');
        const resultsSnapshot = await custodyRef
            .where('conferente_uid', '==', militarUid)
            .get();
        
        // Usamos um Map para garantir que não haja duplicidade de IDs de lista
        const locaisMap = new Map();
        
        resultsSnapshot.forEach(doc => {
            const data = doc.data();
            const idRealDaLista = data.lista_id; // "alfa_abt17"
            const nomeExibicao = data.local_nome; // "ALFA - ABT-17"

            if (idRealDaLista && nomeExibicao) {
                locaisMap.set(idRealDaLista, nomeExibicao);
            }
        });
        
        let optionsHtml = '<option value="" disabled selected>Selecione um local...</option>';
        
        if (locaisMap.size === 0) {
            optionsHtml = '<option value="" disabled selected>Nenhum local sob sua custódia.</option>';
        } else {
            // Converte o Map em Array e ordena pelo Nome legível
            const listaOrdenada = Array.from(locaisMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
            
            listaOrdenada.forEach(([id, nome]) => {
                // 🛑 CORREÇÃO: O 'value' agora é o ID (alfa_abt17) e o texto é o Nome (ALFA - ABT-17)
                optionsHtml += `<option value="${id}">${nome}</option>`;
            });
        }
        
        selectLocal.innerHTML = optionsHtml;
        selectLocal.disabled = false;
        
    } catch (error) {
        console.error("Erro ao carregar locais sob custódia:", error);
        selectLocal.disabled = false;
        selectLocal.innerHTML = '<option value="" disabled selected>Erro ao carregar locais.</option>';
    }
}
		async function loadCustodiaItens() {
    const selectLocal = document.getElementById('cautela-local-origem');
    const listaId = selectLocal.value; 
    
    const itemListContainer = document.getElementById('itens-custodia-list');
    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    
    itemListContainer.innerHTML = '<p class="placeholder-message" style="text-align: center; color: #800020;">Buscando materiais...</p>';
    if (btnIniciar) btnIniciar.disabled = true;

    if (!listaId) {
        itemListContainer.innerHTML = '<p class="placeholder-message" style="text-align: center; color: #999;">Por favor, selecione um Local de Origem.</p>';
        return;
    }
    
    try {
        const listaDoc = await db.collection('listas_conferencia').doc(listaId).get();
        
        if (!listaDoc.exists) {
            itemListContainer.innerHTML = `<p style="color:red; text-align:center;">Erro: Documento da lista (${listaId}) não encontrado.</p>`;
            return;
        }

        const listaMestra = listaDoc.data().list || [];
        let htmlContent = '<div class="inventory-accordion-container">';
        let totalGeralDisponivel = 0;
        let isFirst = true;

        listaMestra.forEach(setor => {
            const setorItems = (setor.itens || []);

            // 🛑 CÁLCULO UNIFICADO DE DISPONIBILIDADE (Igual ao App de Conferência)
            const setorTotal = setorItems.reduce((acc, item) => {
                if (item.tipo === 'single') {
                    const esperado = Number(item.quantidadeEsperada || item.quantidade) || 0;
                    const cautelado = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                    // ⬇️ NOVA LÓGICA: Abate também pendências de conferência não resolvidas
                    const pendente = (item.pendencias_ids || []).reduce((sum, p) => sum + (Number(p.quantidade) || 0), 0);
                    
                    const saldo = esperado - cautelado - pendente;
                    return acc + (saldo > 0 ? saldo : 0);
                } else if (item.tipo === 'multi') {
                    // ⬇️ NOVA LÓGICA: Só conta se não tiver cautela E não tiver pendências de conferência no tombamento
                    return acc + (item.tombamentos || []).filter(t => !t.cautela && (!t.pendencias_ids || t.pendencias_ids.length === 0)).length;
                }
                return acc;
            }, 0);

            if (setorTotal <= 0) return;
            totalGeralDisponivel += setorTotal;

            const contentId = `content-${setor.id}`;
            htmlContent += `
                <div class="${isFirst ? 'accordion-header active' : 'accordion-header'}" onclick="toggleAccordion(this, '${contentId}')">
                    <span>${setor.nome} (${setorTotal} disponíveis)</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" id="${contentId}" style="${isFirst ? 'max-height: 1500px;' : ''}">
                    <div class="items-card-grid">`;

            setorItems.forEach(item => {
                if (item.tipo === 'single') {
                    const totalEsperado = Number(item.quantidadeEsperada || item.quantidade) || 0;
                    const totalCautelado = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                    // ⬇️ Abatimento de pendências para o saldo individual do card
                    const totalPendente = (item.pendencias_ids || []).reduce((sum, p) => sum + (Number(p.quantidade) || 0), 0);
                    
                    const saldoDisponivel = totalEsperado - totalCautelado - totalPendente;

                    if (saldoDisponivel > 0) {
                        htmlContent += `
                            <div class="item-selection-card" data-item-id="${item.id}">
                                <h4 class="item-card-title"><i class="fas fa-boxes"></i> ${item.nome}</h4>
                                <div class="qtd-control-wrapper">
                                    <label>
                                        <input type="checkbox" name="cautela-item-base" 
                                               data-id="${item.id}" data-nome="${item.nome}" data-tipo="single" data-max-qtd="${saldoDisponivel}"
                                               onchange="toggleItemQuantity(this); updateCautelaItemCount();"> Selecionar
                                    </label>
                                    <input type="number" class="input-qtd-cautela" data-item-id="${item.id}" 
                                           min="1" max="${saldoDisponivel}" value="1" disabled style="width: 60px;">
                                </div>
                                <small style="color:#a00030; font-weight: bold;">Disponível: ${saldoDisponivel} de ${totalEsperado}</small>
                            </div>`;
                    }
                } else if (item.tipo === 'multi' && item.tombamentos?.length > 0) {
                    // ⬇️ Filtra tombamentos que possuem pendências ativas (carimbos vermelhos)
                    const tags = (item.tombamentos || []).map(t => {
                        const isC = !!t.cautela;
                        const hasP = (t.pendencias_ids && t.pendencias_ids.length > 0);
                        const bloqueado = isC || hasP;
                        const motivoBloqueio = isC ? 'Cautelado' : (hasP ? 'Com Pendência' : 'Livre');

                        return `
                            <div class="tombamento-tag ${bloqueado ? 'cautelado' : ''}" title="${motivoBloqueio}">
                                <input type="checkbox" name="cautela-item-multi" 
                                       data-id="${item.id}-${t.tomb}" data-id-base="${item.id}" data-tombamento="${t.tomb}" 
                                       data-nome="${item.nome}" data-tipo="multi" 
                                       onchange="updateCautelaItemCount();" ${bloqueado ? 'disabled' : ''}>
                                ${t.tomb} ${bloqueado ? `<i class="fas fa-lock" style="color: ${hasP ? '#d90f23' : '#800020'};"></i>` : ''}
                            </div>`;
                    }).join('');

                    // Só renderiza o card se houver algum tombamento não bloqueado
                    if (tags.includes('type="checkbox"')) {
                        htmlContent += `
                            <div class="item-selection-card">
                                <h4 class="item-card-title"><i class="fas fa-shield-alt"></i> ${item.nome}</h4>
                                <div class="tombamento-tag-list">${tags}</div>
                            </div>`;
                    }
                }
            });
            htmlContent += '</div></div>';
            isFirst = false;
        });

        if (totalGeralDisponivel === 0) {
            itemListContainer.innerHTML = '<p style="color:green; padding:20px; text-align:center;">✅ Nenhum material disponível para cautela (itens com pendência ou cautelados).</p>';
        } else {
            itemListContainer.innerHTML = htmlContent + '</div>';
            document.querySelectorAll('.input-qtd-cautela').forEach(el => {
                el.addEventListener('input', updateCautelaItemCount);
            });
            updateCautelaItemCount();
        }

    } catch (error) {
        console.error("Erro ao carregar itens:", error);
        itemListContainer.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar materiais.</p>';
    }
}
        
function updateCardClass(card) {
    if (!card) return;
    const isMulti = card.getAttribute('data-tipo') === 'multi';
    let isChecked = false;

    if (isMulti) {
        // Para itens multi, verifica se pelo menos um tombamento está checado
        const checkedTombamentos = card.querySelectorAll('input[name="cautela-item-multi"]:checked');
        isChecked = checkedTombamentos.length > 0;

        // Atualiza a classe de cada tag individualmente
        card.querySelectorAll('.tombamento-tag input[type="checkbox"]').forEach(chk => {
            if (chk.checked) {
                chk.closest('.tombamento-tag').classList.add('selected');
            } else {
                chk.closest('.tombamento-tag').classList.remove('selected');
            }
        });
        
    } else {
        // Para itens single, verifica o checkbox principal
        const mainCheckbox = card.querySelector('input[name="cautela-item-base"]');
        isChecked = mainCheckbox && mainCheckbox.checked;
    }
    
    if (isChecked) {
        card.classList.add('selected');
    } else {
        card.classList.remove('selected');
    }
}

/**
 * Lógica do Acordeão: Mostra ou esconde o conteúdo do setor.
 * @param {HTMLElement} header - O cabeçalho clicado.
 * @param {string} contentId - O ID do conteúdo a ser expandido/colapsado.
 */
function toggleAccordion(header, contentId) {
    const content = document.getElementById(contentId);
    
    // 1. Alterna a classe 'active' no cabeçalho
    header.classList.toggle('active');
    
    // 2. Controla o max-height para animação de acordeão
    if (content.style.maxHeight !== '0px' && content.style.maxHeight !== '') {
        content.style.maxHeight = '0px';
    } else {
        // Define uma altura suficientemente grande para conter o conteúdo
        content.style.maxHeight = content.scrollHeight + 50 + 'px'; 
    }
}

/**
 * Atualiza o texto do botão de iniciar cautela com a contagem de itens selecionados.
 */
function updateCautelaItemCount() {
    let selectedCount = 0;
    // REINICIALIZA O ARRAY GLOBAL (Garante que a função de envio veja os dados novos)
    cautelaItensSelecionados = []; 
    
    // 1. Processar itens com Tombamento (tipo 'multi')
    document.querySelectorAll('input[name="cautela-item-multi"]:checked').forEach(chk => {
        const idBase = chk.getAttribute('data-id-base');
        const tombamento = chk.getAttribute('data-tombamento');
        const nomeCompleto = chk.getAttribute('data-nome') || "";

        // Remove "(Tomb: ...)" do nome se ele já existir, para não salvar duplicado
        const nomeLimpo = nomeCompleto.replace(/\s\(Tomb:\s[^\)]+\)/i, '').trim();

        if (idBase && tombamento) {
            cautelaItensSelecionados.push({
                id: `${idBase}-${tombamento}`, 
                id_base: idBase,
                nome: nomeLimpo,
                tombamento: tombamento,
                quantidade: 1,
                tipo: 'multi'
            });
            selectedCount++;
        }
    });
    
    // 2. Processar itens Únicos (tipo 'single')
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        const card = chk.closest('.item-selection-card');
        if (!card) return;
        
        const inputQtd = card.querySelector('.input-qtd-cautela');
        const id = chk.getAttribute('data-id');
        const nome = chk.getAttribute('data-nome');

        let qtd = 1;
        if (inputQtd && !inputQtd.disabled) {
            qtd = parseInt(inputQtd.value) || 0;
            const max = parseInt(inputQtd.getAttribute('max')) || 0;
            
            if (qtd > max) {
                alert(`A quantidade máxima disponível para ${nome} é ${max}.`);
                inputQtd.value = max;
                qtd = max;
            }
            
            if (qtd < 1) {
                chk.checked = false;
                inputQtd.disabled = true;
                return; 
            }
        }

        if (id) {
            cautelaItensSelecionados.push({
                id: id,
                id_base: id,
                nome: nome,
                quantidade: qtd,
                tipo: 'single'
            });
            selectedCount += qtd;
        }
    });

    // 3. Atualizar Interface do Botão
    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    if (btnIniciar) {
        btnIniciar.innerHTML = `<i class="fas fa-paper-plane"></i> Enviar Cautela (${selectedCount} itens)`;
        // O botão só habilita se houver itens no array global
        btnIniciar.disabled = (selectedCount <= 0);
    }
}
        function toggleItemQuantity(checkbox) {
    // 🛑 CORREÇÃO: Usar .item-selection-card como elemento pai mais próximo 🛑
    const card = checkbox.closest('.item-selection-card'); 
    if (!card) return; // Se o card não for encontrado (segurança)

    const inputQtd = card.querySelector('.input-qtd-cautela');

    if (inputQtd) {
        inputQtd.disabled = !checkbox.checked;
        
        // Garante que o valor seja pelo menos 1 quando marcado
        if (checkbox.checked) {
             if (parseInt(inputQtd.value) < 1 || isNaN(parseInt(inputQtd.value))) {
                 inputQtd.value = 1;
             }
        } else {
             // Se desmarcado, reseta o valor para o máximo (ou outro valor de reset)
             inputQtd.value = inputQtd.getAttribute('max');
        }
    }
}
        async function getListaIdFromLocalName(localNomeCompleto) {
    // Busca o documento 'rotas' onde está o mapeamento dos nomes de local para os IDs.
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    for (const [id, info] of Object.entries(rotas)) {
        // Recria o nome completo para comparação (Ex: "ALFA - PERMANÊNCIA")
        const nomeCompletoRota = `${info.posto} - ${info.nome}`;
        if (nomeCompletoRota === localNomeCompleto) {
            return id;
        }
    }
    return null; // Retorna null se não encontrar o mapeamento
}


/**
 * Coleta todos os dados dos itens selecionados (incluindo as quantidades dos inputs number).
 */
function getSelectedCautelaItemsData() {
    const itens = [];
    
    // 1. Coleta itens com Tombamento (tipo 'multi')
    document.querySelectorAll('input[name="cautela-item-multi"]:checked').forEach(chk => {
        // Captura direta dos atributos que definimos no loadCustodiaItens
        const idBase = chk.getAttribute('data-id-base');
        const tombamentoReal = chk.getAttribute('data-tombamento');
        const nomeOriginal = chk.getAttribute('data-nome') || "";
        
        // Limpa o nome para não salvar o texto "(Tomb: ...)" dentro do campo nome no banco
        const nomeLimpo = nomeOriginal.replace(/\s\(Tomb:\s[^\)]+\)/i, '').trim();

        if (idBase && tombamentoReal) {
            itens.push({
                id: `${idBase}-${tombamentoReal}`, // ID composto para controle
                id_base: idBase,                   // ID do documento na lista mestra
                tombamento: tombamentoReal,        // O número do tombamento
                nome: nomeLimpo,
                quantidade: 1,                     // Multi é sempre 1 por linha
                tipo: 'multi'
            });
        }
    });

    // 2. Coleta itens Únicos (tipo 'single')
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        const card = chk.closest('.item-selection-card');
        if (!card) return; 

        const inputQtd = card.querySelector('.input-qtd-cautela');
        const idBase = chk.getAttribute('data-id');
        const nome = chk.getAttribute('data-nome');
        const maxPermitido = parseInt(chk.getAttribute('data-max-qtd')) || 0;
        
        let qtd = parseInt(inputQtd.value) || 0;
        
        // Validação de segurança para garantir que a quantidade é real e permitida
        if (qtd > 0 && qtd <= maxPermitido) {
            itens.push({
                id: idBase,       // Para single, o ID único é o próprio ID base
                id_base: idBase,
                nome: nome,
                quantidade: qtd,
                tipo: 'single'
            });
        }
    });

    return itens;
}
        // Localização: Aproximadamente linha 1197
// A função iniciarCautelaProcesso original no sigma_dashboard.txt será modificada.

async function iniciarCautelaProcesso() {
    const localId = document.getElementById('cautela-local-origem').value;
    const destinatarioUid = document.getElementById('cautela-destinatario-uid').value;
    const destinatarioNome = document.getElementById('cautela-destinatario').value;
    const obsEmissao = document.getElementById('cautela-obs')?.value || "";
    
    if (!localId || !destinatarioUid || cautelaItensSelecionados.length === 0) {
        alert("Preencha todos os campos e selecione ao menos um item.");
        return;
    }

    const btn = document.getElementById('btn-iniciar-cautela');
    btn.disabled = true; btn.textContent = "Processando...";

    try {
        // --- 🛑 BUSCA CIRÚRGICA NA ROTA PARA NOME AMIGÁVEL ---
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const rotaInfo = rotas[localId];
        
        // Monta o nome amigável no padrão "POSTO - NOME"
        const nomeAmigavelLocal = rotaInfo ? `${rotaInfo.posto} - ${rotaInfo.nome}` : "Local N/D";
        const unidadeOrigem = rotaInfo ? rotaInfo.unidade : "";
        // ----------------------------------------------------

        const cautelaId = "CAUTELA-" + Math.floor(10000000 + Math.random() * 90000000);
        const emitenteNome = `${currentUserData.posto} ${currentUserData.quadro} ${currentUserData.nome_guerra}`;
        const dataAtual = new Date().toLocaleString('pt-BR');

        const novaCautela = {
            cautela_id: cautelaId,
            emitente_uid: firebase.auth().currentUser.uid,
            emitente: emitenteNome,
            destinatario_original_uid: destinatarioUid,
            destinatario_original_nome: destinatarioNome,
            destinatario_uid: destinatarioUid, // Define destinatário atual inicial
            local_origem_id: localId,
            local_origem: nomeAmigavelLocal, // ⬅️ AGORA SALVA O NOME AMIGÁVEL VIA ROTA
            unidade_origem: unidadeOrigem,   // ⬅️ SALVA A UNIDADE PARA GESTÃO
            status: 'ABERTA',
            timestamp_emissao: firebase.firestore.FieldValue.serverTimestamp(),
            observacoes_emissao: obsEmissao,
            itens: cautelaItensSelecionados
        };

        const listaRef = db.collection('listas_conferencia').doc(localId);

        await db.runTransaction(async (transaction) => {
            const listaDoc = await transaction.get(listaRef);
            if (!listaDoc.exists) throw new Error("Lista não encontrada.");

            let list = listaDoc.data().list;

            list = list.map(setor => ({
                ...setor,
                itens: setor.itens.map(mItem => {
                    const selecoes = cautelaItensSelecionados.filter(c => c.id_base === mItem.id);
                    
                    if (selecoes.length > 0) {
                        if (!mItem.historico_vida) mItem.historico_vida = [];
                        
                        selecoes.forEach(sel => {
                            const carimbo = {
                                id: cautelaId,
                                destinatario: destinatarioNome,
                                data: dataAtual,
                                quantidade: Number(sel.quantidade) || 1
                            };

                            mItem.historico_vida.push({
                                evento: "SAIDA_CAUTELA", id_doc: cautelaId, quem: emitenteNome, data: dataAtual,
                                detalhes: `Saída de ${carimbo.quantidade}un para ${destinatarioNome}`
                            });

                            if (mItem.tipo === 'multi' && sel.tombamento) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === sel.tombamento) t.cautela = carimbo;
                                    return t;
                                });
                            } else {
                                if (!mItem.cautelas) mItem.cautelas = [];
                                mItem.cautelas.push(carimbo);
                            }
                        });
                    }
                    return mItem;
                })
            }));

            transaction.set(db.collection('cautelas_abertas').doc(cautelaId), novaCautela);
            transaction.update(listaRef, { list });
        });

        alert(`✅ Cautela ${cautelaId} enviada com sucesso!`);
        location.reload();

    } catch (e) {
        console.error(e);
        alert("Erro ao emitir cautela: " + e.message);
        btn.disabled = false;
        btn.textContent = "Enviar Cautela";
    }
}
		
function findItemInList(lista, itemIdBase) {
    for (const setor of lista) {
        for (const item of setor.itens) {
            if (item.id === itemIdBase) {
                return item;
            }
        }
    }
    return null;
}
        /**
 * Função robusta para encontrar o objeto item base (mItem) na lista mestra
 * dado um tombamento específico dentro de seu array de tombamentos.
 * @param {Array} lista - O array listaMestra.
 * @param {string} tombamentoReal - O valor do tombamento a ser procurado (Ex: '511.524').
 * @returns {object|null} O objeto mItem ou null.
 */
function findItemByTombamento(lista, tombamentoReal) {
    for (const setor of lista) {
        for (const item of setor.itens) {
            if (item.tipo === 'multi' && item.tombamentos) {
                // Verifica se algum dos tombamentos possui o valor real
                const foundTomb = item.tombamentos.find(tomb => tomb.tomb === tombamentoReal);
                if (foundTomb) {
                    return item; // Retorna o mItem (item base) que contém o tombamento
                }
            }
        }
    }
    return null;
}
        /**
 * Busca e exibe as cautelas ativas.
 * Exibe todas as cautelas da unidade para Gestores/Admin,
 * e apenas as emitidas para/pelo usuário logado para Operacionais.
 */
// Localização: Função loadActiveCautelas (aprox. linha 1132)

async function loadActiveCautelas() {
    const tbody = document.getElementById('cautelas-ativas-body');
    const loading = document.getElementById('loading-cautelas');
    const table = document.getElementById('cautelas-ativas-table');
    if (!tbody || !loading || !table) return;
    const role = currentUserData.role || 'operacional';

    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        const user = currentUserData;
        
        // Estrutura para os subgrupos
        const grupos = {
            custodiaAtiva: { title: 'Custódia Ativa (Itens sob sua responsabilidade)', data: [] },
            rastreioPessoal: { title: 'Meus Envios em Trânsito (Acompanhamento)', data: [] },
            monitoramento: { title: 'Monitoramento Gerencial/Global', data: [] },
        };
        
        const renderedIds = new Set();
        
        // --- 1. CONFIGURAÇÃO E EXECUÇÃO DAS BUSCAS ---

        // A. Pessoal: Custódia Ativa (RECEBIDA como destinatário)
        if (role === 'operacional' || role === 'gestor') {
            const militarCompleto = currentUserData.nome_militar_completo;
        
            // --- 1. GRUPO CUSTÓDIA ATIVA (APENAS POSSE ATIVA) ---
            
            // A. CUSTÓDIA ATIVA: RECEBIDA (Destinatário)
            // Somente itens que estão sob POSSE ATIVA.
            grupos.custodiaAtiva.data = await queryCautelas(['RECEBIDA'], role, user, 'destinatario', 'personal');
            grupos.custodiaAtiva.data.forEach(c => renderedIds.add(c.cautela_id));
            
            // --- 2. GRUPO RASTREIO PESSOAL (REMETENTE E REVERSOR) ---

            // B. RASTREIO PESSOAL - PARTE 1: Emitente (ABERTA, RECEBIDA, DEVOLUÇÃO)
            // Rastreamento para itens que ele EMITIU.
            const rastreioEmitente = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÇÃO'], role, user, 'emitente', 'personal');

            // C. RASTREIO PESSOAL - PARTE 2: Reversor (DEVOLUÇÃO)
            // Rastreamento para itens que ele DEVOLVEU (e precisa acompanhar o retorno).
            const rastreioReversor = await queryCautelas(['DEVOLUÇÃO'], role, user, 'militar_completo_reversor', 'personal');
            
            // Concatena as duas listas de rastreio
            let rastreioRaw = [...rastreioEmitente, ...rastreioReversor];

            // 🛑 CORREÇÃO: Desduplica o array rastreioRaw internamente, usando Map 🛑
            const uniqueRastreio = new Map();
            rastreioRaw.forEach(c => uniqueRastreio.set(c.cautela_id, c));
            const rastreioDesduplicado = Array.from(uniqueRastreio.values());
            
            // Remove itens que já estão na Custódia Ativa (filtro contra o outro grupo)
            grupos.rastreioPessoal.data = rastreioDesduplicado.filter(c => !renderedIds.has(c.cautela_id));
            grupos.rastreioPessoal.data.forEach(c => renderedIds.add(c.cautela_id));
        }
        
        // C. Gerencial/Admin: Monitoramento da Unidade/Global
        if (role === 'gestor' || role === 'admin') {
            
            if (role === 'gestor') {
                // 🛑 CORREÇÃO CRÍTICA PARA GESTOR (Evitar duplo 'in') 🛑
                const unitListIds = await getUnitListIds();
                let monitoramentoRaw = [];
                const statuses = ['ABERTA', 'RECEBIDA', 'DEVOLUÇÃO'];
                
                grupos.monitoramento.title = 'Monitoramento da Unidade (Material sob sua gestão)';
                
                // Verifica se há IDs de lista e se estamos dentro do limite de 10 do 'in'
                if (unitListIds.length > 0 && unitListIds.length <= 10) {
                    
                    // 1. Executa a consulta APENAS com o filtro 'local_origem_id' ('in')
                    let queryRef = db.collection('cautelas_abertas')
                        .where('local_origem_id', 'in', unitListIds)
                        .orderBy('timestamp_emissao', 'desc');

                    const snapshot = await queryRef.get();
                    snapshot.forEach(doc => {
                        const cautela = { id: doc.id, ...doc.data() };
                        
                        // 2. Filtra por status ABERTA, RECEBIDA, DEVOLUÇÃO na MEMÓRIA
                        if (statuses.includes(cautela.status)) {
                            monitoramentoRaw.push(cautela);
                        }
                    });
                    
                } else if (unitListIds.length > 10) {
                     console.error("ALERTA: Gestor tem mais de 10 Listas. Filtro de unidade está incompleto.");
                } else {
                     // Nenhum ID de lista, Monitoramento vazio.
                }

                grupos.monitoramento.data = monitoramentoRaw;
                
            } else { // role === 'admin'
                grupos.monitoramento.title = 'Monitoramento Global (ADMIN)';
                // Admin pode usar o 'in' para status, pois não usa o 'in' para local_origem_id
                grupos.monitoramento.data = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÇÃO'], role, user, null, 'unit');
            }
            
            // Remove itens que já foram vistos nos grupos pessoais (APÓS A BUSCA)
            grupos.monitoramento.data = grupos.monitoramento.data.filter(c => !renderedIds.has(c.cautela_id));
        }
        
        // --- 2. CONSOLIDAÇÃO E RENDERIZAÇÃO NA TABELA ---
        let htmlContent = '';
        const allGroups = [grupos.custodiaAtiva, grupos.rastreioPessoal, grupos.monitoramento];
        let totalCautelas = 0;

        allGroups.forEach(group => {
            if (group.data.length > 0) {
                totalCautelas += group.data.length;
                
                // Adiciona o cabeçalho do subgrupo (usando colspan para mesclar a linha)
                htmlContent += `
                    <tr class="group-header">
                        <td colspan="6" class="group-title-cell" data-label="">
                            <i class="fas fa-folder-open"></i> <strong>${group.title}</strong> (${group.data.length})
                        </td>
                    </tr>
                `;

                // Renderiza as linhas de dados (usando a nova função auxiliar)
                group.data.forEach(cautela => {
                    htmlContent += renderCautelaRow(cautela); 
                });
            }
        });

        // --- 3. EXIBIÇÃO FINAL ---
        if (totalCautelas === 0) {
            tbody.innerHTML = `
    <tr>
        <td colspan="6" style="text-align:center; padding:60px; color:#64748b;">
            <i class="fas fa-file-signature fa-3x" style="opacity:0.2; margin-bottom:15px; display:block;"></i>
            <span style="font-weight:600; font-size:0.95em;">Nenhuma cautela ativa encontrada.</span>
            <p style="font-size:0.8em; opacity:0.7; margin-top:5px;">No momento, não existem materiais sob sua responsabilidade direta.</p>
        </td>
    </tr>`;
        } else {
            tbody.innerHTML = htmlContent;
        }

        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas ativas:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
       
        async function loadCautionsToReceive() {
    const tbody = document.getElementById('cautelas-receive-body');
    const loading = document.getElementById('loading-receive');
    const table = document.getElementById('cautelas-receive-table');
    
    // Configurações de exibição inicial
    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        const role = currentUserData.role || 'operacional';
        const user = currentUserData;
        
        // Statuses de Ação Pessoal: ABERTA e DEVOLUÇÃO
        const statusesToReceive = ['ABERTA', 'DEVOLUÇÃO'];
        
        // Busca: Filtra pelo 'destinatario' e usa escopo 'personal' para TODOS os perfis (Operacional, Gestor, Admin).
        // Isso implementa a regra de que esta aba é APENAS para AÇÃO PESSOAL.
        const cautionsToReceive = await queryCautelas(
            statusesToReceive, 
            role, 
            user, 
            'destinatario',    
            'personal'         
        );

        // --- RENDERIZAÇÃO ---
        
        if (cautionsToReceive.length === 0) {
            tbody.innerHTML = `
    			<tr>
        			<td colspan="6" style="text-align:center; padding:60px; color:#64748b;">
            			<i class="fas fa-file-import fa-3x" style="opacity:0.2; margin-bottom:15px; display:block;"></i>
            			<span style="font-weight:600; font-size:0.95em;">Nenhuma cautela pendente de recebimento.</span>
			            <p style="font-size:0.8em; opacity:0.7; margin-top:5px;">Você está em dia com suas conferências de materiais.</p>
        			</td>
    			</tr>`;
        } else {
            let htmlContent = '';
            cautionsToReceive.forEach(cautela => {
                htmlContent += renderCautelaRow(cautela); 
            });
            tbody.innerHTML = htmlContent;
        }

        // --- FINALIZAÇÃO DA EXIBIÇÃO ---
        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas a receber:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
        async function showCautelaDetails(cautelaId) {
    const modal = document.getElementById('cautelaDetailsModal');
    const btnReceber = document.getElementById('btn-receber-cautela');
    const btnDevolver = document.getElementById('btn-devolver-cautela');
    const btnConfirmarDevolucao = document.getElementById('btn-confirmar-devolucao');
    const btnSubstituir = document.getElementById('btn-reportar-problema');
    
    document.getElementById('modal-cautela-id').textContent = cautelaId;
    modal.style.display = 'flex';
    
    [btnReceber, btnDevolver, btnConfirmarDevolucao, btnSubstituir].forEach(b => { if(b) b.style.display = 'none'; });

    try {
        const docRef = db.collection('cautelas_abertas').doc(cautelaId);
        const doc = await docRef.get();
        if (!doc.exists) return alert("Erro: Cautela não encontrada.");

        let cautela = doc.data(); 
        const currentStatus = cautela.status || 'N/D';
        const meuUid = firebase.auth().currentUser.uid;

        // --- LÓGICA DE PENDÊNCIAS PARA BLOQUEIO VISUAL ---
        const pendencias = cautela.pendencias_ativas || [];
        const temPendencia = pendencias.length > 0;

        let donoProvisorioNome = "Aguardando Devolução";
        let destaqueRecebedor = ""; 
        
        if (currentStatus === 'RECEBIDA' && cautela.local_origem_id) {
            const custodyDoc = await db.collection('custodia_atual').doc(cautela.local_origem_id).get();
            if (custodyDoc.exists) {
                donoProvisorioNome = custodyDoc.data().conferente_completo || "Dono não identificado";
                if (meuUid !== cautela.destinatario_uid) {
                    destaqueRecebedor = `<span style="background-color: #fff5f5; color: #800020; padding: 4px 10px; border-radius: 6px; border: 1.5px solid #800020; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-hand-holding"></i> ${donoProvisorioNome}
                                         </span>`;
                }
            }
        }

        const getUpdatedName = async (uid, fallbackName) => {
             if (uid) {
                const userData = await getUserInfoByUid(uid);
                return userData ? userData.nome_militar_completo : fallbackName || 'N/D';
            }
            return fallbackName || 'N/D';
        };

        document.getElementById('modal-emitente').textContent = await getUpdatedName(cautela.emitente_uid, cautela.emitente);
        document.getElementById('modal-destinatario-original').textContent = await getUpdatedName(cautela.destinatario_original_uid, cautela.destinatario_original_nome);
        document.getElementById('modal-destinatario-atual').innerHTML = destaqueRecebedor || donoProvisorioNome;
        document.getElementById('modal-local-origem').textContent = cautela.local_origem || 'N/D';
        document.getElementById('modal-data-emissao').textContent = cautela.timestamp_emissao ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        document.getElementById('modal-obs-emissao').textContent = cautela.observacoes_emissao || 'Nenhuma observação.';
        
        const statusTextElement = document.getElementById('modal-status-text');
        if (statusTextElement) {
            statusTextElement.textContent = currentStatus;
            let color = (currentStatus === 'ABERTA') ? "#f57c00" : (currentStatus === 'RECEBIDA') ? "#2e7d32" : "#c62828";
            statusTextElement.style.cssText = `background: ${color}; color: white; padding: 2px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85em; text-transform: uppercase;`;
        }

        const histContainer = document.getElementById('modal-historico-movimentacoes');
        if (cautela.historico_movimentacoes && cautela.historico_movimentacoes.length > 0) {
            histContainer.innerHTML = cautela.historico_movimentacoes.map(h => `
                <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                    <strong style="color:#800020;">${h.data || ''}:</strong> 
                    <div style="white-space: pre-line; font-size: 0.95em; color: #333; margin-top: 5px;">
                        ${h.descricao || h.mensagem || h.detalhes || ''}
                    </div>
                    <small style="color:#666; font-style:italic; display: block; margin-top: 5px;">
                        Por: ${h.militar || h.autor || h.quem || 'N/D'}
                    </small>
                </div>
            `).join('');
        } else {
            histContainer.innerHTML = '<p style="color: #999; text-align: center; margin: 5px 0;">Nenhuma movimentação registrada.</p>';
        }

        const itensList = document.getElementById('modal-itens-cautela');
        itensList.innerHTML = '';
        if (cautela.itens) {
            cautela.itens.forEach((item, idx) => {
                const li = document.createElement('li');
                li.style.cssText = `display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-bottom:1px solid #eee; background-color: ${idx % 2 !== 0 ? '#f2f2f2' : 'transparent'}; font-size: 0.9em;`;
                
                // 🛑 LÓGICA DO ÍCONE DE ALERTA NO ITEM 🛑
                const pDoItem = pendencias.find(p => p.item_index === idx);
                let htmlAlerta = "";
                if (pDoItem) {
                    htmlAlerta = `<i class="fas fa-exclamation-triangle" style="color: #f57c00; margin-left: 8px; cursor: help;" title="Aguardando Análise: ${pDoItem.motivo}"></i>`;
                }

                const temTombamentoReal = item.tombamento && item.tombamento !== "" && item.tombamento !== item.nome;
                const qtdExibicao = item.quantidade !== undefined ? item.quantidade : 1;
                const rotulo = temTombamentoReal 
                    ? `<b style="color: #800020;">Tomb.:</b> ${item.tombamento}` 
                    : `<b style="color: #800020;">QTD:</b> ${qtdExibicao}UN`;
                
                li.innerHTML = `<span>${idx + 1}. ${item.nome}${htmlAlerta}</span> <span>${rotulo}</span>`;
                itensList.appendChild(li);
            });
        }

        // --- BLOQUEIO VISUAL DO BOTÃO DE DEVOLUÇÃO ---
        if (currentStatus === 'ABERTA' && cautela.destinatario_original_uid === meuUid) {
            if (btnReceber) { btnReceber.style.display = 'block'; btnReceber.onclick = () => iniciarRecebimentoCautela(cautelaId); }
        } 
        else if (currentStatus === 'RECEBIDA' && (cautela.destinatario_uid === meuUid || cautela.destinatario_original_uid === meuUid)) {
            if (btnDevolver) { 
                btnDevolver.style.display = 'block'; 
                if (temPendencia) {
                    // Estado Desativado/Bloqueado
                    btnDevolver.disabled = true;
                    btnDevolver.style.opacity = "0.5";
                    btnDevolver.style.cursor = "not-allowed";
                    btnDevolver.title = "A devolução está bloqueada porque existem itens com problemas aguardando análise do Gestor.";
                    btnDevolver.innerHTML = `<i class="fas fa-lock"></i> Devolução Bloqueada`;
                } else {
                    // Estado Normal
                    btnDevolver.disabled = false;
                    btnDevolver.style.opacity = "1";
                    btnDevolver.style.cursor = "pointer";
                    btnDevolver.title = "";
                    btnDevolver.innerHTML = `<i class="fas fa-undo"></i> Iniciar Devolução`;
                    btnDevolver.onclick = () => iniciarDevolucaoCautela(cautelaId, donoProvisorioNome); 
                }
            }
            if (btnSubstituir) { btnSubstituir.style.display = 'block'; }
        }
        else if (currentStatus === 'DEVOLUÇÃO' && cautela.destinatario_uid === meuUid) {
            if (btnConfirmarDevolucao) { btnConfirmarDevolucao.style.display = 'block'; btnConfirmarDevolucao.onclick = () => iniciarConferenciaDevolucao(cautelaId, currentUserData.nome_militar_completo); }
        }

    } catch (e) {
        console.error("Erro no modal:", e);
    }
}
		// Função para mostrar/esconder campo de quantidade no modal de reporte
function fecharModalReporte() {
    document.getElementById('modalReportarItem').style.display = 'none';
    showCautelaDetails(cautelaIdAtualParaReporte); // Reabre o detalhe ao cancelar
}

async function iniciarFluxoSubstituicao() {
    const cautelaId = document.getElementById('modal-cautela-id').textContent;
    cautelaIdAtualParaReporte = cautelaId;

    try {
        const doc = await db.collection('cautelas_abertas').doc(cautelaId).get();
        if (!doc.exists) return alert("Erro: Cautela não encontrada.");

        const data = doc.data();
        itensDaCautelaAtual = data.itens || [];
        const pendenciasAtivas = data.pendencias_ativas || [];
        const indicesBloqueados = pendenciasAtivas.map(p => p.item_index);

        let unidadeAlvo = data.unidade_destino || "";
        if (!unidadeAlvo && data.local_origem_id) {
            const rotasDoc = await db.collection('config_geral').doc('rotas').get();
            const rotas = rotasDoc.data() || {};
            if (rotas[data.local_origem_id]) unidadeAlvo = rotas[data.local_origem_id].unidade;
        }
        if (!unidadeAlvo) unidadeAlvo = currentUserData.unidade;

        const container = document.getElementById('lista-itens-reporte');
        
        // --- CORREÇÃO CIRÚRGICA INICIA AQUI ---
        container.innerHTML = itensDaCautelaAtual.map((item, index) => {
            const estaBloqueado = indicesBloqueados.includes(index);
            const corFundo = estaBloqueado ? '#fff5f5' : '#fff';
            const corTexto = estaBloqueado ? '#999' : '#000';
            
            // 1. Identifica se é MULTI (tem tombamento real e diferente do nome)
            const ehMulti = item.tombamento && item.tombamento !== "" && item.tombamento !== item.nome;

            // 2. Monta o texto de exibição do nome (Sem repetir se for single)
            const textoExibicao = ehMulti 
                ? `${item.nome} <span style="color:#800020;">[Tomb: ${item.tombamento}]</span>` 
                : `${item.nome} (Qtd: ${item.quantidade} un)`;

            return `
            <div style="margin-bottom: 10px; padding: 10px; border: 1px solid ${estaBloqueado ? '#ffcccc' : '#ddd'}; background: ${corFundo}; border-radius:6px; opacity: ${estaBloqueado ? '0.8' : '1'};">
                <label style="display: flex; align-items: center; cursor: ${estaBloqueado ? 'not-allowed' : 'pointer'}; font-weight: bold; color: ${corTexto};">
                    <input type="checkbox" class="check-item-reporte" data-index="${index}" 
                           ${estaBloqueado ? 'disabled' : ''} 
                           style="margin-right: 10px;" onchange="toggleObsInput(${index})">
                    ${textoExibicao}
                    ${estaBloqueado ? '<span style="margin-left:auto; color:#d90f23; font-size:0.7em;"><i class="fas fa-clock"></i> EM ANÁLISE</span>' : ''}
                </label>
                <div id="div-obs-${index}" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee;">
                    ${!ehMulti ? `
                        <label style="font-size: 0.8em; color:#d90f23; font-weight:bold;">QUANTIDADE COM PROBLEMA:</label>
                        <input type="number" id="qtd-obs-${index}" value="1" min="1" max="${item.quantidade}" 
                               style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius:4px; box-sizing: border-box;">
                    ` : `<input type="hidden" id="qtd-obs-${index}" value="1">`}
                    
                    <label style="font-size: 0.8em; font-weight:bold;">MOTIVO DO RELATO:</label>
                    <textarea id="text-obs-${index}" placeholder="Descreva o que houve..." 
                              style="width: 100%; height: 50px; font-size: 0.85em; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                </div>
            </div>
        `}).join('');
        // --- FIM DA CORREÇÃO ---

        const selectGestor = document.getElementById('select-gestor-alvo');
        selectGestor.innerHTML = '<option value="" disabled selected>Buscando gestores...</option>';
        const gestoresSnap = await db.collection('usuarios').where('unidade', '==', unidadeAlvo).get();
        let options = '<option value="" disabled selected>Selecione o Gestor...</option>';
        let encontrouAlguem = false;

        gestoresSnap.forEach(gDoc => {
            const gData = gDoc.data();
            if (gData.role === 'gestor' || gData.role === 'admin') {
                options += `<option value="${gDoc.id}">${gData.nome_militar_completo}</option>`;
                encontrouAlguem = true;
            }
        });

        if (!encontrouAlguem) {
            const adminsGerais = await db.collection('usuarios').where('role', '==', 'admin').get();
            adminsGerais.forEach(aDoc => {
                options += `<option value="${aDoc.id}">${aDoc.data().nome_militar_completo} (Admin Geral)</option>`;
                encontrouAlguem = true;
            });
        }
        selectGestor.innerHTML = encontrouAlguem ? options : '<option value="" disabled selected>Nenhum gestor disponível</option>';
        document.getElementById('cautelaDetailsModal').style.display = 'none';
        document.getElementById('modalReportarItem').style.display = 'flex';

    } catch (e) { 
        console.error("Erro:", e);
        alert("Erro ao carregar dados.");
    }
}

function toggleObsInput(index) {
    const div = document.getElementById(`div-obs-${index}`);
    const isChecked = document.querySelector(`.check-item-reporte[data-index="${index}"]`).checked;
    div.style.display = isChecked ? 'block' : 'none';
}

async function salvarRelatosMultiplos() {
    const checks = document.querySelectorAll('.check-item-reporte:checked');
    const gestorUid = document.getElementById('select-gestor-alvo').value;
    
    if (checks.length === 0) return alert("Selecione pelo menos um item com problema.");
    if (!gestorUid) return alert("Por favor, selecione o Gestor que receberá este relato.");

    const selectG = document.getElementById('select-gestor-alvo');
    const nomeGestorAlvo = selectG.options[selectG.selectedIndex].text;

    let pendencias = [];
    let logsParaAdicionar = [];
    const dataAtual = new Date();
    const dataFormatada = dataAtual.toLocaleString('pt-BR');

    for (let check of checks) {
        const idx = check.getAttribute('data-index');
        const item = itensDaCautelaAtual[idx];
        const motivo = document.getElementById(`text-obs-${idx}`).value;
        const qtd = parseInt(document.getElementById(`qtd-obs-${idx}`).value) || 1;

        if (!motivo.trim()) {
            alert(`Descreva o problema do item: ${item.nome}`);
            return;
        }

        pendencias.push({
            item_nome: item.nome,
            item_tombamento: item.tombamento || null,
            item_id_base: item.id_base || item.id,
            item_index: parseInt(idx),
            quantidade: qtd,
            motivo: motivo,
            status: "PENDENTE",
            timestamp: dataAtual,
            solicitante_nome: currentUserData.nome_militar_completo,
            gestor_alvo_uid: gestorUid,
            gestor_alvo_nome: nomeGestorAlvo
        });

        logsParaAdicionar.push({
            data: dataFormatada,
            descricao: `⚠️ PENDÊNCIA ENVIADA: ${qtd}un de ${item.nome} (${item.tombamento || 'S/T'}) para análise de ${nomeGestorAlvo}. Motivo: ${motivo}`,
            militar: currentUserData.nome_militar_completo
        });
    }

    try {
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaIdAtualParaReporte);
        
        await cautelaRef.update({
            pendencias_ativas: firebase.firestore.FieldValue.arrayUnion(...pendencias),
            historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(...logsParaAdicionar)
        });

        alert(`Relato enviado com sucesso para ${nomeGestorAlvo}!`);
        document.getElementById('modalReportarItem').style.display = 'none';
        showCautelaDetails(cautelaIdAtualParaReporte);

    } catch (e) {
        console.error("Erro ao salvar:", e);
        alert("Erro ao processar envio.");
    }
}
		
function iniciarRecebimentoCautela(cautelaId) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. Constrói a URL para a cautela. (Usa 'cautelaId')
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}`;

    // 4. 🛑 LÓGICA DE ABERTURA DO IFRAME (REPLICADA DA CONFERÊNCIA NORMAL) 🛑
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CRÍTICO: Componentes de execução (app-runner-container ou app-iframe) não encontrados.");
        alert("Erro ao iniciar a conferência. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a área principal do dashboard (content-area) e a sidebar para dar foco total ao app
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}
        function iniciarConferenciaDevolucao(cautelaId, destinatario) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    // 🛑 CORREÇÃO AQUI: Alterando de 'posto_graduacao' para 'posto' (ou similar)
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. Constrói a URL CRÍTICA com o modo de devolução final
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}&modo=devolucao_final&destinatarioDevolucao=${encodeURIComponent(destinatario)}`;

    // 4. LÓGICA DE ABERTURA DO IFRAME (INLINE)
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CRÍTICO: Componentes de execução (app-runner-container ou app-iframe) não encontrados.");
        alert("Erro ao iniciar a conferência. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a área principal do dashboard (content-area) e a sidebar
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar'); 
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}

// Localização: Linha ~1594
function handleIframeMessage(event) {
    // Garante que a mensagem veio do seu domínio (Importante por segurança)
    if (event.origin !== window.location.origin) return;

    if (event.data && event.data.type === 'SIGMA_FINISHED') {
        alert('✅ Operação finalizada com sucesso. Voltando ao Dashboard.');

        // 1. Oculta o container do Iframe
        const container = document.getElementById('app-runner-container');
        if (container) {
            container.style.display = 'none';
            // Limpa a URL do iframe para liberar recursos
            document.getElementById('app-iframe').src = 'about:blank';
        }
        
        // 2. Mostra a área principal do dashboard e a sidebar
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.style.display = 'block';
        }
        const sidebar = document.getElementById('sidebar') || document.getElementById('main-sidebar');
        if (sidebar) {
            sidebar.style.display = 'block';
        }
        
        // 3. Recarrega a lista mais relevante (Cautelas a Receber e Ativas)
        // Isso garante que o item CONCLUÍDA suma da lista A RECEBER/ATIVAS.
        
        // 🛑 CORREÇÃO DE REFERÊNCIA 🛑
        // A função correta é loadActiveCautelas (com 't' e 'l').
        loadCautionsToReceive(); // Atualiza a lista A RECEBER (item sumiu)
        loadActiveCautelas();    // Atualiza a lista ATIVAS (item sumiu/mudou)
        
        // Força a atualização dos cards (contadores) e da lista "Conferências de Hoje"
        if (typeof updateOperacionalCards === 'function') {
            updateOperacionalCards();
        }
        
        // Volta para a view de Cautelas Ativas após o sucesso, se o usuário não estava no Dashboard.
        // Isto é mais seguro do que tentar recarregar a aba 'Histórico' que estava ativa.
        switchView('cautelas'); 
        showCautelasDashboard('Cautelas Ativas'); 
    }
}        /**
 * Busca cautelas com status ABERTA e RECEBIDA para Gestores (filtradas por Unidade).
 * @param {string} unidade - A unidade do Gestor.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForGestor(unidade) {
    // Consulta 1: ABERTAS na Unidade
    const queryAberta = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'ABERTA');

    // Consulta 2: RECEBIDAS na Unidade
    const queryRecebida = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}

/**
 * Busca todas as cautelas com status ABERTA e RECEBIDA para Admin.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForAdmin() {
    // Consulta 1: Todas ABERTAS
    const queryAberta = db.collection('cautelas_abertas')
        .where('status', '==', 'ABERTA');

    // Consulta 2: Todas RECEBIDAS
    const queryRecebida = db.collection('cautelas_abertas')
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}

async function loadHistoricalCautelas() {
    const loading = document.getElementById('loading-historico');
    const historicoContentContainer = document.getElementById('historico-content-container'); 
    const abasOperacional = document.getElementById('historico-abas-operacional'); 
    
    const role = currentUserData.role || 'operacional';
    const user = currentUserData;
    
    if (historicoContentContainer) historicoContentContainer.innerHTML = ''; 
    loading.style.display = 'block';

    try {
        if (role === 'operacional') {
            
            if (abasOperacional) {
                abasOperacional.style.setProperty('display', 'flex', 'important');
            }
            
            const abasHtml = `
                <div id="content-minhas" class="historico-tab-content active-tab" style="display:block;"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>  <-- NOVO: Adiciona loading na aba inicial
                <div id="content-devolucao" class="historico-tab-content"></div>
                <div id="content-emitidas" class="historico-tab-content"></div>
            `;
            historicoContentContainer.innerHTML = abasHtml;
            
            loadHistorico('minhas'); 
            
        } else {
            
            if (abasOperacional) {
                abasOperacional.style.setProperty('display', 'none', 'important');
            }
            
            const snapGeral = await queryCautelas(['CONCLUÍDA'], role, user, null, 'unit');
            
            let titulo = (role === 'admin') ? 'Histórico Global (ADMIN)' : 'Histórico da Unidade (GESTOR)';
            
            if (snapGeral.length > 0) {
                
                let tableHtml = `
                    <div class="op-card" style="padding:15px; margin-bottom:0;">
                        <h4 style="margin-top:0; color:#800020; border-bottom:1px solid #eee; padding-bottom:5px;">
                            <i class="fas fa-archive"></i> ${titulo} (${snapGeral.length} registros)
                        </h4>
                        <table class="ca-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Dest. Original</th>
                                    <th>Emitente</th>
                                    <th>Local Origem</th>
                                    <th>Data Conclusão</th>
                                    <th>Itens</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                snapGeral.forEach(cautela => {
                    const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
                    const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
                    
                    tableHtml += `
                        <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                            <td data-label="ID"><strong>${cautela.cautela_id}</strong></td>
                            <td data-label="Dest. Original">${cautela.destinatario_original || 'N/A'}</td>
                            <td data-label="Emitente">${cautela.emitente}</td>
                            <td data-label="Local Origem">${cautela.local_origem || 'N/D'}</td>
                            <td data-label="Conclusão">${dataFinal}</td>
                            <td data-label="Itens">${itensCount} itens</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                historicoContentContainer.innerHTML = tableHtml;

            } else {
                historicoContentContainer.innerHTML = `<div class="op-card" style="padding:20px; text-align:center; color:#999;">Nenhuma cautela concluída encontrada para ${role}.</div>`;
            }
        }

    } catch (e) {
        console.error("Erro ao carregar histórico de cautelas:", e);
        historicoContentContainer.innerHTML = `<div class="op-card" style="padding:20px; text-align:center; color:red;">Erro ao carregar dados: ${e.message}</div>`;
    } finally {
        loading.style.display = 'none'; 
    }
}
        function renderHistoricalGroup(title, cautelas, groupId) {
    // Retorna string vazia se não houver dados
    if (cautelas.length === 0) {
        return ''; 
    }
    
    // Constrói a estrutura do grupo (que pode ser uma aba ou uma seção)
    let html = `
        <div class="historical-group" id="${groupId}">
            <h4 class="group-title-historical"><i class="fas fa-history"></i> ${title} (${cautelas.length})</h4>
            <div class="table-responsive-container">
            <table class="cautelas-table" id="${groupId}-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Emitente</th>
                        <th>Dest. Atual</th>
                        <th>Data Conclusão</th>
                        <th>Itens</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Adiciona as linhas da tabela
    cautelas.forEach(cautela => {
        // Reutiliza a função de renderização de linha que já está ajustada
        html += renderCautelaRow(cautela); 
    });
    
    html += `
                </tbody>
            </table>
            </div>
        </div>
    `;
    return html;
}
        // Localização: Aproximadamente linha 6310

async function getLastConferente(localOrigem) {
    if (!localOrigem) return "N/D";
    
    try {
        // 1. Busca o resultado de conferência mais recente para o local de origem.
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('local', '==', localOrigem)
            .orderBy('timestamp', 'desc')
            .limit(1)
            .get();
            
        if (!snap.empty) {
            const lastResult = snap.docs[0].data();
            
            // 🛑 2. VERIFICA O UID (CHAVE IMUTÁVEL)
            const conferenteUid = lastResult.conferente_uid; 
            
            if (conferenteUid) {
                // 3. SE TEM UID, FAZ O LOOKUP PARA OBTER O NOME ATUALIZADO
                const userData = await getUserInfoByUid(conferenteUid);
                
                if (userData && userData.nome_militar_completo) {
                    // Retorna o nome atualizado do militar
                    return userData.nome_militar_completo;
                }
            }
            
            // 4. FALLBACK: Se não tem UID ou lookup falhou, retorna o nome estático
            // (Isso lida com registros legados).
            return lastResult.conferente || "N/D (Sem UID ou Cadastro)";
        }
        
        return "N/D (Nenhum histórico recente)";
    } catch (e) {
        console.error("Erro ao buscar último conferente (UID Lookup):", e);
        return "N/D (Erro de consulta)";
    }
}
            async function iniciarDevolucaoCautela(cautelaId, ultimoConferenteNome) {
    const btnDevolver = document.getElementById('btn-devolver-cautela');
    
    // 1. CONFIRMAÇÃO INICIAL COM O USUÁRIO
    const confirmacaoUsuario = confirm(`A CAUTELA SERÁ ENVIADA PARA DEVOLUÇÃO A "${ultimoConferenteNome}". CONFIRMA?`);
    if (!confirmacaoUsuario) return; // Cancela se o usuário clicar em "Cancelar"

    // Esconde o modal e desativa o botão após a confirmação
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    if (btnDevolver) btnDevolver.disabled = true;

    try {
        const militarCompleto = currentUserData.nome_militar_completo;
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaId);

        // Busca o UID do Usuário C (o novo recebedor)
        const ucUid = await findUidByName(ultimoConferenteNome);

        if (!ucUid) {
            throw new Error(`Não foi possível localizar o ID de sistema para: ${ultimoConferenteNome}.`);
        }

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            
            if (!cautelaDoc.exists) throw new Error("Documento não localizado.");
            
            const data = cautelaDoc.data();

            // --- 🛑 TRAVA DE SEGURANÇA: ITENS EM ANÁLISE 🛑 ---
            const pendencias = data.pendencias_ativas || [];
            if (pendencias.length > 0) {
                const listaItens = pendencias.map(p => p.itemNome).join(', ');
                throw new Error(`BLOQUEIO: Existem itens em análise pelo Gestor: (${listaItens}).\n\nResolva as pendências antes de devolver.`);
            }

            if (data.status !== 'RECEBIDA') {
                throw new Error("A cautela não está em sua posse confirmada para ser devolvida.");
            }

            // --- 📝 PREPARAÇÃO DO LOG DE MOVIMENTAÇÃO ---
            const novoLog = {
    			data: new Date().toLocaleString('pt-BR'), // Grava como texto formatado, não como objeto Timestamp
    			descricao: `Devolução iniciada: Material enviado por ${militarCompleto} para conferência de retorno de ${ultimoConferenteNome}.`,
    			militar: militarCompleto, // Nome da chave corrigido para bater com o modal
   			 	tipo: "TRANSICAO_DEVOLUCAO"
			};
            
            // Se passar por todas as travas, executa a atualização
            transaction.update(cautelaRef, { 
                status: 'DEVOLUÇÃO', 
                timestamp_devolucao_iniciada: firebase.firestore.FieldValue.serverTimestamp(),
                
                reversor_uid: firebase.auth().currentUser.uid,
                militar_completo_reversor: militarCompleto,
                
                destinatario_uid: ucUid, 
                destinatario: ultimoConferenteNome,

                // Adiciona o log ao histórico da cautela
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(novoLog)
            });
        });

        alert(`✅ Cautela enviada para conferência de ${ultimoConferenteNome}.`);
        if (typeof loadActiveCautelas === 'function') loadActiveCautelas();
        if (typeof updateOperacionalCards === 'function') updateOperacionalCards();

    } catch (error) {
        console.error("Erro ao iniciar devolução:", error);
        alert(`${error.message}`);
        if (btnDevolver) btnDevolver.disabled = false;
    }
}
        /**
 * Alterna a aba do Histórico e dispara o carregamento da função correspondente.
 */
// Localização: Função loadHistorico (Aproximadamente linha 1504)

function loadHistorico(tabName) {
    const role = currentUserData.role || 'operacional';
    
    // 🛑 1. SE FOR GESTOR/ADMIN, FORÇAMOS A VISUALIZAÇÃO DA TABELA ÚNICA 🛑
    // Isso garante que loadHistoricalCautelas rode e sobreescreva a estrutura de abas.
    if (role === 'gestor' || role === 'admin') {
        loadHistoricalCautelas();
        return; // Sai da função após iniciar a visualização Gerencial/Global
    }
    
    // 2. Para Operacional, continua a lógica de abas:
    
    // 2.1. Atualiza a UI das abas
    document.querySelectorAll('.tab-navigation .tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === tabName) {
            btn.classList.add('active');
        }
    });

    // 2.2. Oculta e mostra o conteúdo (containers internos)
    document.querySelectorAll('.historico-tab-content').forEach(content => {
        content.classList.remove('active-tab');
        content.style.display = 'none';
    });
    const targetContent = document.getElementById(`content-${tabName}`);
    if (targetContent) {
        targetContent.style.display = 'block';
        targetContent.classList.add('active-tab');
    }
    
    // 2.3. Dispara a função de carregamento de dados (Operacional)
    if (tabName === 'minhas') {
        loadHistoricoMinhas();
    } else if (tabName === 'devolucao') {
        loadHistoricoDevolucao();
    } else if (tabName === 'emitidas') {
        loadHistoricoEmitidas();
    }
}
        // Função auxiliar para renderizar a tabela, minimizando a repetição
function renderHistoricoTable(containerId, cautelas) {
    const container = document.getElementById(containerId);
    const loading = document.getElementById('loading-historico');

    if (!container) return; 

    // Oculta loading e garante que o container esteja visível
    if (loading) loading.style.display = 'none';

    if (cautelas.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px;">Nenhuma cautela encontrada neste histórico.</p>';
        return;
    }

    // Cria a estrutura da tabela
    let html = `
        <table class="ca-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Dest. Original</th>
                    <th>Emitente</th>
                    <th>Data Final</th>
                    <th>Itens</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
    `;

    cautelas.forEach(cautela => {
        const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
        const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        
        // Define o destinatário original de forma segura (para esta aba)
        const destOriginal = cautela.destinatario_original || 'N/A';
        const badgeText = 'CONCLUÍDA';
        const badgeClass = 'badge-solucao';

        html += `
            <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                <td><strong>${cautela.cautela_id}</strong></td>
                <td>${destOriginal}</td>
                <td>${cautela.emitente}</td>
                <td>${dataFinal}</td>
                <td>${itensCount} itens</td>
                <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

// -------------------------------------------------------------
// FUNÇÕES ESPECÍFICAS DE CARREGAMENTO POR ABA
// -------------------------------------------------------------

/**
 * Aba 1: MINHAS (Destinatário Original)
 * Filtro: destinatario_original == militarCompleto E status == CONCLUÍDA
 */
async function loadHistoricoMinhas() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('destinatario_original', '==', militarCompleto)
            .where('status', '==', 'CONCLUÍDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-minhas', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-minhas').innerHTML = `<p style="color:red;">Erro ao carregar histórico: ${e.message}</p>`;
    }
}

/**
 * Aba 2: DEVOLUÇÃO (Recebidas de volta, como Dono Provisório)
 * Filtro: receptor_final_completo == militarCompleto E status == CONCLUÍDA
 */
async function loadHistoricoDevolucao() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('receptor_final_completo', '==', militarCompleto) // Campo que registra o Dono Provisório
            .where('status', '==', 'CONCLUÍDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-devolucao', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-devolucao').innerHTML = `<p style="color:red;">Erro ao carregar histórico: ${e.message}</p>`;
    }
}

/**
 * Aba 3: EMITIDAS POR MIM
 * Filtro: emitente == militarCompleto E status == CONCLUÍDA
 */
async function loadHistoricoEmitidas() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('emitente', '==', militarCompleto)
            .where('status', '==', 'CONCLUÍDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-emitidas', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-emitidas').innerHTML = `<p style="color:red;">Erro ao carregar histórico: ${e.message}</p>`;
    }
}
        function atualizarQuadroModal() {
    const postoSelect = document.getElementById('edit-user-posto');
    const quadroSelect = document.getElementById('edit-user-quadro');
    const posto = postoSelect.value;
    
    // Limpa o select do quadro e desabilita
    quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    quadroSelect.disabled = true;

    // Se o posto for vazio (ou a opção "Selecione"), sai
    if (!posto) return;

    // Mapeamento dos postos para a categoria (Oficiais, Praças, SD)
    let quadros = [];
    const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1º TEN', '2º TEN'];
    const pracas = ['ST', '1º SGT', '2º SGT', '3º SGT', 'CB'];

    if (oficiais.includes(posto)) {
        quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
    } else if (pracas.includes(posto)) {
        quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
    } else if (posto === 'SD') {
        // SD tem um quadro fixo e não permite alteração
        quadros = ['QPCBM'];
        quadroSelect.disabled = true;
    }

    if (quadros.length > 0) {
        quadroSelect.disabled = (posto === 'SD'); // Desabilita apenas se for SD
        
        // Preenche as opções do quadro
        quadros.forEach(quadro => {
            const option = document.createElement('option');
            option.value = quadro;
            option.textContent = quadro;
            quadroSelect.appendChild(option);
        });
        
        // Tenta pré-selecionar a primeira opção se houver apenas uma (caso do SD)
        if(quadros.length === 1) {
            quadroSelect.value = quadros[0];
        }
    }
}
        function formatarCPF(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
    value = value.substring(0, 11); // Limita a 11 dígitos

    if (value.length > 9) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
    } else if (value.length > 3) {
        value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{3})$/, '$1');
    }
    input.value = value;
}

function formatarMatricula(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
    value = value.substring(0, 10); // Limita a 10 dígitos

    if (value.length > 7) {
        value = value.replace(/^(\d{7})(\d{3})$/, '$1-$2');
    }
    input.value = value;
}

function formatarTelefone(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
    value = value.substring(0, 11); // Limita a 11 dígitos (DDD + 9 dígitos)

    if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
    } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{2})$/, '($1)');
    }
    input.value = value;
}
        function filtrarUsuarios() {
    		const searchInput = document.getElementById('user-search-input');
    		const searchTerm = searchInput.value.trim().toUpperCase();
    		const tbody = document.getElementById('users-table-body');
    
    		tbody.innerHTML = '';
    
    		const filteredUsers = allUsersData.filter(u => {
        		const nomeExibicao = u.nome_militar_completo || '';
        		return nomeExibicao.includes(searchTerm);
    		});

    		if (filteredUsers.length === 0) {
        		tbody.innerHTML = '<tr><td colspan="5">Nenhum usuário encontrado com o nome digitado.</td></tr>';
        		return;
    		}

    		filteredUsers.forEach(u => {
        		const docId = u.id; 
        		const tr = document.createElement('tr');
        
        		// Bloqueia a edição de si mesmo para evitar que o Admin mude o próprio nível acidentalmente
        		const isCurrentUser = firebase.auth().currentUser.uid === docId; 
        
        		const telefone = u.telefone_contato || 'N/D';
        		const whatsappUrl = u.whatsapp_url || '#';
        		const rawTelefone = telefone.replace(/\D/g, '');
        		const numeroSemDDD = (rawTelefone.length === 11) ? rawTelefone.substring(2) : rawTelefone; 

        		const whatsappLink = `<a href="${whatsappUrl}" target="_blank" style="margin-left: 5px; color: #25D366;"><i class="fab fa-whatsapp"></i></a>`;
        		const dialLink = (rawTelefone.length >= 8) ? 
            	`<a href="tel:${numeroSemDDD}" class="btn-dial-mobile" style="margin-left: 5px; color: #2c7399;"><i class="fas fa-phone"></i></a>` : '';
        
       			tr.innerHTML = `
    			<td data-label="Militar:" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
        			${u.nome_militar_completo}
    			</td>
    			<td data-label="Contato:">
        			<div style="display: flex; align-items: center; gap: 8px;">
            			<span>${telefone}</span>
            			<div style="display: flex; gap: 5px;">
                			${whatsappLink}
                			${dialLink}
            			</div>
        			</div>
    			</td>
    			<td data-label="Perfil:" style="text-align: center;">
        			<span class="role-badge role-${u.role}">${u.role.toUpperCase()}</span>
    			</td>
    			<td data-label="Unidade:" style="text-align: center;">
        			${u.unidade}
    			</td>
    			<td data-label="Ações:" style="text-align: center;">
        			<button class="btn-modern-action btn-edit" 
                		style="padding: 6px 12px; font-size: 0.85em; width: auto; display: inline-flex; align-items: center; gap: 5px; margin: 0 auto;" 
                		onclick="prepararEdicaoUsuario('${docId}')" 
                		${isCurrentUser ? 'disabled title="Você não pode editar seu próprio perfil"' : ''}>
            			<i class="fas fa-edit"></i> Editar
        			</button>
   				</td>`;
				tbody.appendChild(tr);
			});
		}
		
		function executarAcaoUsuario() {
    const uidEdicao = document.getElementById('edit-user-uid').value;
    
    // Se houver UID, estamos em modo edição, senão, modo cadastro
    if (uidEdicao && uidEdicao !== "") {
        salvarAlteracoesUsuario(uidEdicao);
    } else {
        criarUsuario();
    }
}
        function setupCadastroMilitarLogic() {
    // 1. Máscaras
    const cpfInput = document.getElementById('new-user-cpf');
    const matriculaInput = document.getElementById('new-user-matricula');
    const telefoneInput = document.getElementById('new-user-telefone');

    if (cpfInput) cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
    if (matriculaInput) matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
    if (telefoneInput) telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));

    // 2. Lógica de Dependência Posto/Quadro (Adaptada da função atualizarQuadroModal)
    const postoSelect = document.getElementById('new-user-posto');
    const quadroSelect = document.getElementById('new-user-quadro');

    if (postoSelect && quadroSelect) {
        postoSelect.addEventListener('change', () => {
            // Replicar a lógica de atualização do Quadro (Posto->Quadro)
            atualizarQuadroCad(postoSelect, quadroSelect);
        });
    }
}

/**
 * Lógica de dependência Posto/Quadro ADAPTADA para o novo formulário Cadastrar Militar.
 */
    function atualizarQuadroCad(postoSelect, quadroSelect) {
    const posto = postoSelect.value;
    quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    
    if (!posto) {
        quadroSelect.disabled = true;
        return;
    }

    let quadros = [];
    const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1º TEN', '2º TEN'];
    const pracas = ['ST', '1º SGT', '2º SGT', '3º SGT', 'CB'];

    if (oficiais.includes(posto)) {
        quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
        quadroSelect.disabled = false;
    } else if (pracas.includes(posto)) {
        quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
        quadroSelect.disabled = false;
    } else if (posto === 'SD') {
        quadros = ['QPCBM'];
        quadroSelect.disabled = true; // Soldado é sempre QPCBM
    }

    quadros.forEach(quadro => {
        const option = document.createElement('option');
        option.value = quadro;
        option.textContent = quadro;
        quadroSelect.appendChild(option);
    });

    if (quadros.length === 1) {
        quadroSelect.value = quadros[0];
    }
}
		
    async function carregarPostosServicoSelect(elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;

    select.innerHTML = '<option value="" disabled selected>Carregando Postos...</option>';

    try {
        // Usa a busca comprovadamente funcional
        const docRef = db.collection('config_geral').doc('postos');
        const doc = await docRef.get();

        // Usa a extração segura de dados (Postos Visuais usa esta mesma lógica)
        if (doc.exists) {
            const postos = doc.data().lista || []; // Pega o array 'lista'
            
            select.innerHTML = '<option value="" disabled selected>Selecione o Posto de Serviço</option>';
            
            postos.sort().forEach(posto => {
                const option = document.createElement('option');
                option.value = posto;
                option.textContent = posto;
                select.appendChild(option);
            });
            
        } else {
            select.innerHTML = '<option value="" disabled selected>Lista de Postos não encontrada.</option>';
        }

    } catch(e) {
        // Verifique o console (F12) se esta mensagem aparecer
        console.error("Erro CRÍTICO ao carregar Postos de Serviço:", e); 
        select.innerHTML = '<option value="" disabled selected>Erro ao carregar</option>';
    }
}
        async function carregarUnidadesSelect(elementId = 'new-user-unit') {
    const select = document.getElementById(elementId);
    if (!select) return;
    select.innerHTML = '<option value="">Carregando...</option>';
    
    try {
        // MUDANÇA CIRÚRGICA: Busca na coleção estruturada para pegar o UID
        const snap = await db.collection('unidades_estruturadas')
                             .where('ativo', '==', true)
                             .get();
        
        // Preenche o dropdown
        select.innerHTML = '<option value="" disabled selected>Selecione a Unidade</option>';
        
        const unidades = [];
        snap.forEach(doc => {
            unidades.push({ uid: doc.id, ...doc.data() });
        });

        // Ordena por sigla
        unidades.sort((a, b) => a.sigla.localeCompare(b.sigla)).forEach(u => {
            const option = document.createElement('option');
            option.value = u.uid; // O VALUE agora é o UID (Essencial para o salvamento)
            option.textContent = u.sigla; // O TEXTO é a Sigla (Ex: CCI)
            select.appendChild(option);
        });

        // --- LÓGICA DE PERMISSÃO PARA GESTOR (Mantida e Adaptada) ---
        const isGestor = currentUserData && currentUserData.role === 'gestor';
        
        if (isGestor) {
            // Se for gestor, trava no UID da unidade dele
            select.value = currentUserData.unidade_id; // Assume que você salvou o UID no login
            select.disabled = true;
            select.style.backgroundColor = '#f0f0f0';
        } else {
            select.disabled = false;
            select.style.backgroundColor = '';
        }

    } catch(e) {
        console.error("Erro CRÍTICO ao carregar unidades:", e);
        select.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}
        //FUNÇÕES PARA MELHORIA DAS FILTRAGENS POR STATUS E PERFIL NO MENI GESTAO DE CAUTELAS
        async function getUnitListIds() {
    // 1. Obter a unidade do usuário logado
    const userUnidade = currentUserData.unidade || '';
    if (!userUnidade) {
        console.warn("Unidade do usuário não definida. Retornando vazio.");
        return [];
    }

    // 2. Buscar no documento 'config_geral/rotas'
    try {
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const unitListIds = [];

        for (const [id, info] of Object.entries(rotas)) {
            // Se o nome da unidade na rota for igual à unidade do usuário
            if (info.unidade === userUnidade && info.ativo !== false) { 
                unitListIds.push(id);
            }
        }
        return unitListIds;

    } catch (error) {
        console.error("Erro ao obter IDs de listas da unidade:", error);
        return [];
    }
}
        // Localização: Função queryCautelas (Aproximadamente linha 1600 do arquivo completo)

// A função queryCautelas foi alterada para suportar a busca por UID em filtros pessoais.
async function queryCautelas(statusArray, role, user, field = null, type = 'personal') {
    let query = db.collection('cautelas_abertas');

    if (type === 'personal' || role === 'admin') {
        if (statusArray.length > 0) {
            query = query.where('status', 'in', statusArray);
        } else {
            return [];
        }
    }

    const militarCompleto = user.nome_militar_completo;
    const militarUid = firebase.auth().currentUser.uid;

    if (role === 'gestor' && type === 'unit') {
        const unitListIds = await getUnitListIds();
        if (unitListIds.length > 0 && unitListIds.length <= 10) {
            query = query.where('local_origem_id', 'in', unitListIds);
        } else {
            return [];
        }
    } else if (type === 'personal') {
        if (field === 'destinatario') {
            const [snapOriginal, snapAtual] = await Promise.all([
                db.collection('cautelas_abertas')
                    .where('destinatario_original_uid', '==', militarUid)
                    .where('status', 'in', statusArray)
                    .get(),
                db.collection('cautelas_abertas')
                    .where('destinatario_uid', '==', militarUid)
                    .where('status', 'in', statusArray)
                    .get()
            ]);

            let mapResult = new Map();
            snapOriginal.forEach(doc => mapResult.set(doc.id, { id: doc.id, ...doc.data() }));
            snapAtual.forEach(doc => mapResult.set(doc.id, { id: doc.id, ...doc.data() }));

            return Array.from(mapResult.values()).sort((a, b) => 
                (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0)
            );

        } else if (field === 'emitente') {
            query = query.where('emitente_uid', '==', militarUid);
        } else if (field === 'receptor_final_completo') {
            query = query.where('receptor_final_completo', '==', militarCompleto);
        } else if (field === 'destinatario_original') {
            query = query.where('destinatario_original', '==', militarCompleto);
        } else if (field === 'militar_completo_reversor') {
            query = query.where('militar_completo_reversor', '==', militarCompleto);
        }
    }

    try {
        const snapshot = await query.orderBy('timestamp_emissao', 'desc').get();
        let cautelas = [];
        snapshot.forEach(doc => {
            const cautela = { id: doc.id, ...doc.data() };
            if (role === 'gestor' && type === 'unit' && !statusArray.includes(cautela.status)) {
                return;
            }
            cautelas.push(cautela);
        });
        return cautelas;
    } catch (error) {
        console.error("Erro na consulta de cautelas:", error);
        throw error;
    }
}
    /**
 * Renderiza uma linha de tabela (<tr>) para a cautela, adicionando data-labels para responsividade mobile.
 */
function renderCautelaRow(cautela) {
    const clickAction = `showCautelaDetails('${cautela.cautela_id}')`;
    const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
    
    // 🛑 INDICADOR DE PENDÊNCIA NA LINHA
    const temPendencia = cautela.pendencias_ativas && cautela.pendencias_ativas.length > 0;
    const alertaCaa = temPendencia ? `<i class="fas fa-exclamation-circle" style="color: #f57c00;" title="Possui itens em análise"></i> ` : "";

    const dataEmissao = cautela.timestamp_emissao && typeof cautela.timestamp_emissao.toDate === 'function'
                        ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR')
                        : 'N/A';
                                
    const status = cautela.status || 'N/A';
    let badgeClass = 'badge-cautela';
    let badgeText = 'N/D'; 

    if (status === 'RECEBIDA') { badgeClass = 'badge-solucao'; badgeText = 'RECEBIDA'; } 
    else if (status === 'ABERTA') { badgeClass = 'badge-cautela'; badgeText = 'ABERTA'; } 
    else if (status === 'DEVOLUÇÃO') { badgeClass = 'badge-pendente'; badgeText = 'EM DEVOLUÇÃO'; } 
    else if (status === 'CONCLUÍDA') { badgeClass = 'badge-concluida'; badgeText = 'CONCLUÍDA'; }
    
    return `
        <tr onclick="${clickAction}" style="${temPendencia ? 'background-color: #fff9f0;' : ''}">
            <td data-label="ID"><strong>${cautela.cautela_id}</strong></td>
            <td data-label="Destinatário">${cautela.destinatario || cautela.destinatario_original_nome || 'Aguardando...'}</td>
            <td data-label="Emissão">${dataEmissao}</td>
            <td data-label="Origem">${cautela.local_origem}</td>
            <td data-label="Itens">${alertaCaa}${itensCount} itens</td>
            <td data-label="Status"><span class="status-badge ${badgeClass}">${badgeText}</span></td>
        </tr>
    `;
}
     // Adicionar esta função no final do bloco de funções do Editor de Listas (sigma_dashboard.txt)

        
        // Localização: Aproximadamente linha 6445
async function getUserInfoByUid(uid) {
    if (userCache[uid]) {
        return userCache[uid];
    }
    
    try {
        // Tenta encontrar o documento onde o UID é o ID do documento
        const doc = await db.collection('usuarios').doc(uid).get(); 
        
        if (doc.exists) {
            userCache[uid] = { id: doc.id, ...doc.data() };
            return userCache[uid];
        }

        return null;
        
    } catch (e) {
        console.warn(`Falha ao buscar militar pelo UID ${uid}: ${e.message}`);
        return null;
    }
}
        /**
 * Tenta encontrar o UID de um militar usando seu nome militar completo (Posto Quadro Nome Guerra).
 * Usado como fallback para cautelas legadas.
 * @param {string} nomeCompleto - O nome completo (Ex: '2º SGT QPCBM JHONATH').
 * @returns {string|null} O ID do documento (UID) se encontrado.
 */
async function findUidByName(nomeCompleto) {
    if (!nomeCompleto) return null;
    
    try {
        // Busca exata pelo nome de exibição
        const snap = await db.collection('usuarios')
            .where('nome_militar_completo', '==', nomeCompleto.trim())
            .get();
            
        if (snap.empty) {
            console.warn(`Nenhum militar encontrado com o nome exato: ${nomeCompleto}`);
            return null;
        }

        if (snap.size > 1) {
            alert(`⚠️ Atenção: Foram encontrados ${snap.size} cadastros para "${nomeCompleto}". Verifique se há nomes duplicados no banco de dados.`);
        }

        // Retorna o UID do primeiro documento encontrado
        return snap.docs[0].id; 
    } catch (e) {
        console.error("Erro ao buscar UID por nome:", e);
        return null;
    }
}

async function loadCautelaPendencies() {
    const container = document.getElementById('admin-gestor-cards-container');
    if (!container || !currentUserData) return;

    try {
        console.log("=== BUSCANDO PENDÊNCIAS DE CAUTELA ===");
        
        const unitListIds = await getUnitListIds();
        
        let query = db.collection('cautelas_abertas')
                      .where('status', 'in', ['ABERTA', 'RECEBIDA', 'DEVOLUÇÃO']);
        
        const snap = await query.get();
        let totalPendenciasTroca = 0;
        let cautelasComPendencia = [];

        snap.forEach(doc => {
            const data = doc.data();
            const pertenceAoSetor = currentUserData.role === 'admin' || unitListIds.includes(data.local_origem_id);

            if (pertenceAoSetor && data.pendencias_ativas && data.pendencias_ativas.length > 0) {
                
                // --- CORREÇÃO CIRÚRGICA: INJETAR DADOS DO MILITAR EM CADA PENDÊNCIA ---
                const pendenciasComRastreabilidade = data.pendencias_ativas.map(p => {
    			// Chaves REAIS confirmadas no seu log:
    			const nomeReal = data.destinatario_original_nome || p.solicitante_nome || "Militar";
    			const uidReal = data.destinatario_uid || p.solicitante_uid || "";

   				 return {
        			...p,
        			gestor_alvo_nome: nomeReal, // Normaliza para o fluxo seguinte
        			gestor_alvo_uid: uidReal,
        			cautelaId: doc.id,
        			localId: data.local_origem_id,
        			itemNome: p.item_nome || p.itemNome || "Item"
    			};
			});

                if (pendenciasComRastreabilidade.length > 0) {
                    totalPendenciasTroca += pendenciasComRastreabilidade.length;
                    cautelasComPendencia.push({ 
                        id: doc.id, 
                        ...data, 
                        pendencias: pendenciasComRastreabilidade 
                    });
                    console.log(`Cautela ${doc.id}: ${data.destinatario} tem ${pendenciasComRastreabilidade.length} pendência(s).`);
                }
            }
        });

        // ATUALIZA O CACHE GLOBAL
        cachePendenciasCautela = cautelasComPendencia;
        console.log("Total de itens para troca localizados:", totalPendenciasTroca);

        const cardExistente = document.getElementById('card-pendencia-cautela-ativa');
        
        if (totalPendenciasTroca === 0) {
            if (cardExistente) cardExistente.remove();
            return;
        }

        // MONTAGEM DO CARD
        let cardHtml = `
            <div id="card-pendencia-cautela-ativa" class="sector-card status-alert" 
                 style="border-left: 5px solid #f57c00; background-color: #fff3e0; margin-bottom: 20px; flex: 1 1 100%; cursor: pointer; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                 onclick="abrirGestaoPendenciasCautela()">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: #e65100; margin: 0; font-size: 1.1em;"><i class="fas fa-exclamation-circle"></i> Pendências de Cautelas Ativas</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">Existem itens aguardando substituição ou recolhimento.</p>
                    </div>
                    <div class="count-value" style="color: #e65100; font-size: 2em; font-weight: bold;">${totalPendenciasTroca}</div>
                </div>
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(230, 81, 0, 0.2); color: #e65100; font-size: 0.8em; font-weight: bold; text-transform: uppercase;">
                    Clique para gerenciar
                </div>
            </div>
        `;

        if (cardExistente) {
            cardExistente.outerHTML = cardHtml;
        } else {
            container.insertAdjacentHTML('afterbegin', cardHtml);
        }

    } catch (e) {
        console.error("Erro ao carregar pendências de cautela:", e);
    }
}
async function abrirGestaoPendenciasCautela() {
    const cautelas = cachePendenciasCautela;
    const wrapper = document.getElementById('ca-table-wrapper');
    const tbody = document.getElementById('ca-list-body');
    if (!wrapper || !tbody) return;

    // 1. AJUSTE DO CABEÇALHO DA TABELA
    const thead = wrapper.querySelector('thead tr');
    if (thead) {
        thead.innerHTML = `
            <th>Material</th>
            <th>Cautela ID</th>
            <th>Alteração</th>
            <th>Conferente/Data</th>
            <th>Ação</th>
        `;
    }

    document.getElementById('table-title').innerHTML = `<i class="fas fa-exchange-alt"></i> Substituições Pendentes`;
    tbody.innerHTML = '';
    wrapper.querySelector('table').style.display = 'table';
    document.getElementById('no-issues-msg').style.display = 'none';

    cautelas.forEach(cautela => {
        cautela.pendencias.forEach(p => {
            const tr = tbody.insertRow();
            
            // Coluna Material
            const tdMaterial = tr.insertCell();
            tdMaterial.innerHTML = `
                <strong>${p.item_nome}</strong><br>
                <small style="color:#800020">Origem: ${cautela.local_origem || 'Não especificado'}</small>
            `;

            // Coluna Cautela ID
            const tdCautela = tr.insertCell();
            tdCautela.innerHTML = `<span class="status-badge badge-cautela" style="font-family: monospace; font-size: 0.95em;">${cautela.id}</span>`;

            // Coluna Alteração (Single vs Multi)
            const tdAlteracao = tr.insertCell();
            tdAlteracao.style.textAlign = "left";
            
            const itemNome = (p.item_nome || "").trim().toUpperCase();
            const itemTomb = (p.item_tombamento || "S/T").trim().toUpperCase();
            const itemQtd = p.quantidade || 1;
            const ehItemSingle = !p.item_tombamento || itemTomb === "S/T" || itemTomb === itemNome;

            const labelIdentificador = ehItemSingle 
                ? `<b style="color:#666;">Qtd:</b> ${itemQtd} un.` 
                : `<b style="color:#666;">Tomb:</b> ${p.item_tombamento}`;

            tdAlteracao.innerHTML = `
                <div style="font-size:0.9em;">
                    <b style="color:#d90f23;">Motivo:</b> ${p.motivo}<br>
                    ${labelIdentificador}
                </div>
            `;

            // Coluna Solicitante e Data
            const tdMilitar = tr.insertCell();
            let dataFormatada = "Data indisponível";
            if (p.timestamp) {
                const d = p.timestamp.seconds ? new Date(p.timestamp.seconds * 1000) : new Date(p.timestamp);
                if (!isNaN(d.getTime())) dataFormatada = d.toLocaleString('pt-BR');
            }
            tdMilitar.innerHTML = `<small><b>${p.solicitante_nome}</b><br>${dataFormatada}</small>`;

            // Preparação dos dados (btnData)
            const idItemReal = p.id_item || "";
            const idBaseReal = p.id_base || "";
            const tombReal = p.item_tombamento || "";

            const btnData = encodeURIComponent(JSON.stringify({
                cautelaId: cautela.id,
                solicitacaoId: p.id_solicitacao,
                itemNome: p.item_nome,
                itemTomb: tombReal,
                localId: cautela.local_origem_id,
                motivo: p.motivo,
                uidItem: idItemReal || (idBaseReal ? `${idBaseReal}-${tombReal}` : ""),
                solicitante_nome: p.solicitante_nome || "Militar", 
                gestor_alvo_nome: p.solicitante_nome || "Militar",
                gestor_alvo_uid: p.solicitante_uid || "",
                quantidade: itemQtd
            }));

            const tdAcao = tr.insertCell();
            tdAcao.innerHTML = `
                <button class="btn-modern-action" style="background-color: #f57c00; padding: 5px 10px; cursor:pointer; display: flex; align-items: center; gap: 8px;" 
                    onclick="abrirDecisaoGestor('${btnData}')">
                    <i class="fas fa-tools"></i> Resolver
                </button>
            `;
        });
    });

    wrapper.style.display = 'block';
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function abrirDecisaoGestor(dataJson) {
    try {
        const data = JSON.parse(decodeURIComponent(dataJson));
        
        // 1. NORMALIZAÇÃO DE RASTREABILIDADE
        data.gestor_alvo_nome = data.solicitante_nome || data.gestor_alvo_nome || "Militar";
        data.gestor_alvo_uid = data.solicitante_uid || data.gestor_alvo_uid || "";
        data.itemNome = data.item_nome || data.itemNome || "Item sem nome";
        data.motivo = data.motivo || "Avaria relatada";

        // 2. CORREÇÃO DE IDS ESPECÍFICOS
        if (!data.uidItem || (data.uidItem && String(data.uidItem).includes('undefined'))) {
            const nomeUpper = data.itemNome.toUpperCase();
            if (nomeUpper.includes("PÉ DE CABRA")) {
                data.uidItem = "56911524-65986249";
                data.id_base = "56911524-65986249";
            } else if (nomeUpper.includes("EPR SCOTT")) {
                data.uidItem = "56911524-64012364-" + (data.itemTomb || data.item_tombamento || "S/T");
                data.id_base = "56911524-64012364";
            }
        }

        data.quantidade = Number(data.quantidade || data.itemQtd || 1);
        pendenciaSendoResolvida = data; 

        // 3. PREPARAÇÃO DA INTERFACE DO MODAL
        const tombReal = data.itemTomb || data.item_tombamento || "";
        const ehItemSingle = !tombReal || tombReal === "S/T" || tombReal.trim().toUpperCase() === data.itemNome.trim().toUpperCase();
        
        const identificadorHtml = ehItemSingle 
            ? `<b>Quantidade relatada:</b> <span style="color:#d90f23; font-weight:bold;">${data.quantidade} un.</span>` 
            : `<b>Tombamento:</b> <span style="color:#800020; font-weight:bold;">${tombReal}</span>`;

        const infoBox = document.getElementById('info-item-decisao');
        if (infoBox) {
            infoBox.innerHTML = `
                <div style="line-height: 1.6; text-align: left; background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #ddd; border-left: 5px solid #800020;">
                    <b style="color: #800020; font-size: 1.1em; text-transform: uppercase;">${data.itemNome}</b><br>
                    <div style="margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px; font-size: 0.95em;">
                        ${identificadorHtml}<br>
                        <b>Relatado por:</b> <span style="color: #2c7399; font-weight: bold;">${data.gestor_alvo_nome}</span><br>
                        <b>Motivo:</b> <span style="color:#333;">${data.motivo}</span>
                    </div>
                </div>
            `;
        }

        const modal = document.getElementById('modalDecisaoGestor');
        if (modal) modal.style.display = 'flex';

    } catch (e) {
        console.error("Erro crítico ao abrir modal de decisão:", e);
        alert("Erro ao processar dados da pendência.");
    }
}
		async function executarRecolhimentoApenas() {
    if (!pendenciaSendoResolvida) return;
    
    const p = pendenciaSendoResolvida;
    const confirmacao = confirm(`Deseja confirmar o recolhimento de "${p.itemNome}"?\n\nO item sairá da carga do militar e retornará ao estoque com carimbo de PENDÊNCIA.`);
    if (!confirmacao) return;

    try {
        const cautelaRef = db.collection('cautelas_abertas').doc(p.cautelaId);
        const listaRef = db.collection('listas_conferencia').doc(p.localId);

        const [docCautela, docLista] = await Promise.all([
            cautelaRef.get(),
            listaRef.get()
        ]);

        if (!docCautela.exists || !docLista.exists) return alert("Erro: Documentos não localizados.");

        const dataCautela = docCautela.data();
        const dataRegistro = new Date().toLocaleString('pt-BR');
        const dataSimples = new Date().toLocaleDateString('pt-BR');
        const nomeLimpo = (p.itemNome || "").trim().toUpperCase();

        // Identifica o Gestor logado para o histórico (Posto + Nome de Guerra)
        let nomeGestorLogado = "Gestor";
        if (typeof currentUserData !== 'undefined' && currentUserData.nome_militar_completo) {
            nomeGestorLogado = currentUserData.nome_militar_completo;
        }

        // 1. ATUALIZAÇÃO DA CARGA DO MILITAR (CAUTELA) - CORREÇÃO CIRÚRGICA DE QUANTIDADE
        const pendenciasRestantes = (dataCautela.pendencias_ativas || []).filter(item => 
            String(item.id_solicitacao) !== String(p.solicitacaoId)
        );

        const qtdBaixa = Number(p.quantidade) || 1;
        let novosItensCautela = [];

        // Lógica para detectar se é item de estoque (Single)
        const itemTombReal = (p.itemTomb || "S/T").trim().toUpperCase();
        const ehItemSingle = !p.itemTomb || itemTombReal === "S/T" || itemTombReal === nomeLimpo;

        if (!ehItemSingle) {
            // ITEM MULTI: Remove o objeto pelo tombamento específico
            novosItensCautela = (dataCautela.itens || []).filter(it => it.tombamento !== p.itemTomb);
        } else {
            // ITEM SINGLE: Subtrai apenas a quantidade reportada, preservando o restante
            novosItensCautela = (dataCautela.itens || []).map(it => {
                const isMesmoItem = it.id === p.id_base || it.id === p.uidItem || it.nome.trim().toUpperCase() === nomeLimpo;

                if (isMesmoItem) {
                    const novaQtd = (Number(it.quantidade) || 0) - qtdBaixa;
                    return novaQtd > 0 ? { ...it, quantidade: novaQtd } : null;
                }
                return it;
            }).filter(it => it !== null);
        }

        // 2. ATUALIZAÇÃO DO ESTOQUE (LISTA MESTRA) - CONVERSÃO DE CARIMBOS
        const novaListaMestra = docLista.data().list.map(setor => ({
            ...setor,
            itens: (setor.itens || []).map(it => {
                if (it.nome.trim().toUpperCase() === nomeLimpo || it.id === p.id_base) {
                    
                    const novoIdPendencia = "PEND-" + Date.now();
                    const descricaoPadrao = `${p.motivo} (RECOLHIDO DE ${p.cautelaId})`;

                    // A. TRATA ITENS MULTI (Tombamentos)
                    if (it.tipo === 'multi' && it.tombamentos) {
                        it.tombamentos = it.tombamentos.map(t => {
                            if (t.tomb === p.itemTomb) {
                                delete t.cautela; // Remove carimbo LARANJA
                                t.status = 'pending'; 
                                
                                if (!t.pendencias_ids) t.pendencias_ids = [];
                                t.pendencias_ids.push({
                                    id: novoIdPendencia,
                                    quantidade: 1,
                                    descricao: descricaoPadrao,
                                    data_criacao: dataSimples,
                                    status_gestao: "PENDENTE",
                                    tipo: "PENDENCIA",
                                    autor_nome: p.gestor_alvo_nome || "Militar"
                                });
                            }
                            return t;
                        });
                    }

                    // B. TRATA ITENS SINGLE (Redução de carimbo laranja no estoque)
                    if (it.tipo === 'single' && it.cautelas) {
                        it.cautelas = it.cautelas.map(c => {
                            if (c.id === p.cautelaId) {
                                const novaQtdC = (Number(c.quantidade) || 0) - qtdBaixa;
                                return novaQtdC > 0 ? { ...c, quantidade: novaQtdC } : null;
                            }
                            return c;
                        }).filter(c => c !== null);
                    }

                    // C. CARIMBO DE PENDÊNCIA GERAL (Vermelho)
                    if (!it.pendencias_ids) it.pendencias_ids = [];
                    it.pendencias_ids.push({
                        id: novoIdPendencia,
                        quantidade: qtdBaixa,
                        descricao: descricaoPadrao,
                        data_criacao: dataSimples,
                        status_gestao: "PENDENTE",
                        tipo: "PENDENCIA",
                        autor_nome: p.gestor_alvo_nome || "Militar"
                    });

                    // D. HISTÓRICO DE VIDA DO ITEM
                    if (!it.historico_vida) it.historico_vida = [];
                    it.historico_vida.push({
                        data: dataRegistro,
                        evento: "RECOLHIMENTO_AVARIA",
                        detalhes: `Recolhimento de ${qtdBaixa}un. Item saiu da carga de ${p.gestor_alvo_nome} e retornou como pendência.`,
                        quem: nomeGestorLogado
                    });
                }
                return it;
            })
        }));

        // --- PREPARAÇÃO DO TEXTO DO HISTÓRICO DA CAUTELA ---
        const prefixoDescricao = ehItemSingle ? `${qtdBaixa}un de ` : "Item ";

        const batch = db.batch();
        
        // Update Cautela com menção à quantidade
        batch.update(cautelaRef, {
            itens: novosItensCautela,
            pendencias_ativas: pendenciasRestantes,
            historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion({
                data: dataRegistro,
                descricao: `📥Recolhimento: ${prefixoDescricao}${p.itemNome} removido da carga. Motivo: ${p.motivo}`,
                militar: nomeGestorLogado
            })
        });

        // Update Lista Mestra
        batch.update(listaRef, { 
            list: novaListaMestra, 
            updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
        });

        await batch.commit();
        alert(`✅ Recolhimento concluído!\nSaldo atualizado na carga do militar.`);
        
        if (document.getElementById('modalDecisaoGestor')) document.getElementById('modalDecisaoGestor').style.display = 'none';
        if (typeof fecharTabela === 'function') fecharTabela(); 
        if (typeof loadCaaData === 'function') await loadCaaData(); 

    } catch (e) {
        console.error("Erro fatal no recolhimento:", e);
        alert("❌ Erro ao processar recolhimento: " + e.message);
    }
}
		
// FUNÇÕES AUXILIARES PARA LIMPEZA DE CÓDIGO
function transformarEmAvariado(item, tomb, cautelaId, motivo, relator) {
    const { cautela, ...limpo } = item;
    
    // Gera o log para o item que quebrou
    const historicoAtualizado = gerarLogMovimentacao(item, "SUBSTITUIÇÃO_SAÍDA", 
        `Item retirado de carga devido à avaria. Substituído pelo novo tombamento. Motivo: ${motivo}`);

    return { 
        ...limpo, 
        situacao: "AVARIADO",
        id_cautela_origem: cautelaId,
        motivo_avaria: motivo,
        relatado_por: relator,
        data_avaria: new Date().toLocaleString('pt-BR'),
        historico_vida: historicoAtualizado 
    };
}

function injetarCautelaNoItem(item, tomb, dadosMilitar) {
    // Gera o log para o item bom que está entrando
    const historicoAtualizado = gerarLogMovimentacao(item, "SUBSTITUIÇÃO_ENTRADA", 
        `Item inserido na cautela ${dadosMilitar.id} em substituição ao item avariado anterior.`);

    return { 
        ...item, 
        situacao: "DISPONÍVEL",
        status_cautela: "ABERTA",
        historico_vida: historicoAtualizado,
        cautela: {
            id: dadosMilitar.id,
            destinatario: dadosMilitar.destinatario,
            data: dadosMilitar.data,
            quantidade: 1
        }
    };
}
		function gerarLogMovimentacao(itemObj, evento, detalhes) {
    if (!itemObj.historico_vida) itemObj.historico_vida = [];
    
    itemObj.historico_vida.push({
        data: new Date().toLocaleString('pt-BR'),
        evento: evento,
        autor: `${userInfo.postoGraduacao} ${userInfo.nomeGuerra}`,
        detalhes: detalhes,
        timestamp: Date.now()
    });
    
    return itemObj.historico_vida;
}
		
		// Função para abrir o modal e carregar itens de todas as listas do gestor
async function abrirSeletorGlobalSubstituicao() {
    if (!pendenciaSendoResolvida) return;
    const p = pendenciaSendoResolvida;
    const modal = document.getElementById('modalSeletorEstoque');
    const container = document.getElementById('listaEstoqueDisponivel');
    
    // Identifica o "DNA" (prefixo do UID) - Ex: de 'EPR-01-511527' para 'EPR-01'
    const partesId = p.uidItem.split('-');
    partesId.pop(); // Remove o sufixo (tombamento)
    const dnaBusca = partesId.join('-'); 

    container.innerHTML = `<div class="loader-p">Buscando ${p.itemNome} em todas as suas ftr/setores...</div>`;
    modal.style.display = 'block';

    try {
        // Busca TODAS as listas de conferência (Jurisdição do Gestor)
        const snapshot = await db.collection('listas_conferencia').get();
        let htmlAcumulado = '';
        let totalEncontrado = 0;

        snapshot.forEach(docLista => {
            const nomeLista = docLista.id.toUpperCase();
            const dados = docLista.data();

            if (dados.list) {
                dados.list.forEach(setor => {
                    setor.itens.forEach(item => {
                        
                        // Função interna para validar e montar o HTML do card
                        const validarEExibir = (entidade, idReal) => {
                            // Verifica se o ID começa com o DNA e se está DISPONÍVEL
                            if (idReal.startsWith(dnaBusca) && !entidade.cautela && entidade.situacao !== 'AVARIADO' && idReal !== p.uidItem) {
                                totalEncontrado++;
                                htmlAcumulado += `
                                    <div class="item-selecao-global" style="border: 1px solid #ddd; padding: 12px; margin-bottom: 8px; border-radius: 8px; background: white;">
                                        <div style="display:flex; justify-content:space-between; align-items:center;">
                                            <div>
                                                <small style="color: #666; font-weight: bold;">ORIGEM: ${nomeLista}</small><br>
                                                <b>Tombamento: ${entidade.tomb || entidade.tombamento}</b>
                                            </div>
                                            <button class="btn-resolver" style="width:auto; padding: 5px 15px;" 
                                                onclick="confirmarTrocaCruzada('${idReal}', '${docLista.id}', '${entidade.tomb || entidade.tombamento}')">
                                                Selecionar
                                            </button>
                                        </div>
                                    </div>`;
                            }
                        };

                        if (item.tipo === 'multi' && item.tombamentos) {
                            item.tombamentos.forEach(t => validarEExibir(t, `${item.id}-${t.tomb}`));
                        } else {
                            validarEExibir(item, item.id);
                        }
                    });
                });
            }
        });

        container.innerHTML = totalEncontrado > 0 ? htmlAcumulado : `<p style="text-align:center; padding:20px;">Nenhum item reserva do tipo <b>${p.itemNome}</b> disponível em suas listas.</p>`;

    } catch (e) {
        console.error(e);
        container.innerHTML = "<p>Erro ao processar busca global.</p>";
    }
}
	async function confirmarTrocaCruzada(uidNovo, listaOrigemNovo, tombamentoNovo, cautelaId, localIdOrigem, idBaseOrigem, nomeItemOrigem, motivoMilitar, uidResponsavel, nomeResponsavel) {
    const dataFormatada = new Date().toLocaleString('pt-BR');
    const dataSimples = new Date().toLocaleDateString('pt-BR');
    const nomeLimpo = (nomeItemOrigem || "").trim().toUpperCase();
    const nomeMilitarRelator = nomeResponsavel || "Militar";
    const uidMilitarRelator = uidResponsavel || "";

    // 🛑 BUSCA O NOME REAL DO GESTOR LOGADO NO DASHBOARD
    let nomeGestorLogado = "Gestor";
    if (typeof currentUserData !== 'undefined' && currentUserData.nome_militar_completo) {
        nomeGestorLogado = currentUserData.nome_militar_completo;
    }

    try {
        const batch = db.batch();
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaId);
        const listaOrigemRef = db.collection('listas_conferencia').doc(localIdOrigem);

        // 1. ATUALIZAÇÃO DA CAUTELA (CARGA DO MILITAR)
        const docC = await cautelaRef.get();
        if (docC.exists) {
            const d = docC.data();
            const pAtivas = (d.pendencias_ativas || []).filter(pa => (pa.item_nome || "").trim().toUpperCase() !== nomeLimpo);
            
            // Identifica se o novo item é multi ou single para formatar a descrição do histórico
            const ehMulti = tombamentoNovo && tombamentoNovo !== "" && tombamentoNovo !== nomeItemOrigem;
            const identificadorNovo = ehMulti ? `tombamento ${tombamentoNovo}` : `${uidNovo.split('-').pop()} unidades`;

            const itensC = (d.itens || []).map(it => {
                if (it.nome.trim().toUpperCase() === nomeLimpo) {
                    return { ...it, id: uidNovo, tombamento: tombamentoNovo || "" };
                }
                return it;
            });

            batch.update(cautelaRef, { 
                pendencias_ativas: pAtivas, 
                itens: itensC,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion({
                    data: dataFormatada,
                    // ✅ MUDANÇA: "🔄Substituição:" e correção do texto de identificação
                    descricao: `🔄Substituição: Item ${nomeItemOrigem} substituído por ${identificadorNovo}.`,
                    militar: nomeGestorLogado // ✅ MUDANÇA: Agora aparece CAP QPCBM VIDO (ou quem estiver logado)
                })
            });
        }

        // 2. ATUALIZAÇÃO DO ESTOQUE (ITENS SINGLE E MULTI)
        const docL = await listaOrigemRef.get();
        if (docL.exists) {
            const listData = docL.data().list.map(setor => ({
                ...setor,
                itens: (setor.itens || []).map(it => {
                    if (it.id === idBaseOrigem || it.nome.trim().toUpperCase() === nomeLimpo) {
                        
                        let objetoCautelaParaMover = null;
                        const novoIdPendencia = "PEND-" + Date.now();
                        // Aqui mantivemos o padrão solicitado anteriormente para o carimbo vermelho
                        const descricaoPadrao = `${motivoMilitar} (IDENTIFICADO EM: ${cautelaId})`;

                        if (it.tipo === "multi" && it.tombamentos) {
                            it.tombamentos = it.tombamentos.map(t => {
                                if (t.cautela && t.cautela.id === cautelaId) {
                                    objetoCautelaParaMover = t.cautela; 
                                    delete t.cautela;
                                    if (!t.pendencias_ids) t.pendencias_ids = [];
                                    t.pendencias_ids.push({
                                        id: novoIdPendencia,
                                        quantidade: 1,
                                        descricao: descricaoPadrao,
                                        data_criacao: dataSimples,
                                        status_gestao: "PENDENTE",
                                        tipo: "PENDENCIA",
                                        autor_nome: nomeMilitarRelator
                                    });
                                }
                                return t;
                            }).map(t => {
                                if (t.tomb === tombamentoNovo) t.cautela = objetoCautelaParaMover; 
                                return t;
                            });
                        }

                        if (!it.pendencias_ids) it.pendencias_ids = [];
                        it.pendencias_ids.push({
                            id: novoIdPendencia,
                            quantidade: 1,
                            descricao: descricaoPadrao,
                            data_criacao: dataSimples,
                            status_gestao: "PENDENTE",
                            tipo: "PENDENCIA",
                            autor_nome: nomeMilitarRelator
                        });

                        if (!it.historico_vida) it.historico_vida = [];
                        it.historico_vida.push({
                            data: dataFormatada,
                            evento: "RETORNO_TROCA",
                            detalhes: `🔄Substituição efetuada por ${nomeGestorLogado}.`,
                            quem: nomeGestorLogado
                        });
                    }
                    return it;
                })
            }));
            batch.update(listaOrigemRef, { list: listData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        }

        await batch.commit();
        alert(`✅ Substituição concluída!\nRegistrado por: ${nomeGestorLogado}`);
        location.reload();
    } catch (e) {
        console.error(e);
        alert("Erro: " + e.message);
    }
}
	async function prepararSubstituicaoFisica() {
    if (!pendenciaSendoResolvida) return;
    const p = pendenciaSendoResolvida;
    const modalSeletor = document.getElementById('modalSeletorEstoque');
    const container = document.getElementById('listaEstoqueDisponivel');

    document.getElementById('modalDecisaoGestor').style.display = 'none';
    modalSeletor.style.display = 'flex';
    container.innerHTML = `<div style="text-align:center; padding:30px;"><i class="fas fa-sync fa-spin"></i> Buscando itens compatíveis no estoque...</div>`;

    try {
        const idReferencia = p.uidItem || p.idItem || p.id_base || "";
        const partes = idReferencia.split('-');
        let dnaBusca = partes.length > 2 ? partes.slice(0, 2).join('-') : idReferencia;
        
        const motivoMilitar = (p.motivo || "Avaria reportada").replace(/'/g, "\\'");
        const uidResponsavel = p.gestor_alvo_uid || ""; 
        const nomeResponsavel = (p.gestor_alvo_nome || "Militar").replace(/'/g, "\\'");
        const nomeEscapado = p.itemNome.replace(/'/g, "\\'");

        const snapshot = await db.collection('listas_conferencia').get();
        let htmlAcumulado = '';
        let totalEncontrado = 0;

        snapshot.forEach(docLista => {
            const dadosLista = docLista.data();
            const nomeLocal = dadosLista.nome_local || docLista.id.toUpperCase();

            if (dadosLista.list) {
                dadosLista.list.forEach(setor => {
                    setor.itens.forEach(item => {
                        if (item.id && item.id.startsWith(dnaBusca)) {
                            
                            // --- LÓGICA PARA ITEM SINGLE ---
                            if (item.tipo === 'single' || !item.tombamentos || item.tombamentos.length === 0) {
                                const qtdCautelada = (item.cautelas || []).reduce((acc, c) => acc + (Number(c.quantidade) || 0), 0);
                                const qtdPendente = (item.pendencias_ids || []).reduce((acc, pen) => acc + (Number(pen.quantidade) || 0), 0);
                                const saldoDisponivel = (Number(item.quantidadeEsperada) || 0) - qtdCautelada - qtdPendente;

                                if (saldoDisponivel > 0) {
                                    totalEncontrado++;
                                    const etiquetaLocal = docLista.id === p.localId ? `${nomeLocal} (ESTOQUE LOCAL)` : nomeLocal;
                                    
                                    htmlAcumulado += `
                                        <div class="item-selecao-global" style="border: 1px solid #ddd; padding: 15px; border-radius: 10px; background: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                            <div style="flex: 1;">
                                                <small style="color: #1b8a3e; font-weight: bold;"><i class="fas fa-map-marker-alt"></i> ${etiquetaLocal}</small><br>
                                                <b style="color: #333; font-size: 1.1em;">${item.nome}</b><br>
                                                <small style="color: #666;">Saldo disponível: <b>${saldoDisponivel} un</b></small>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 15px;">
                                                <div style="display: flex; flex-direction: column; align-items: center;">
                                                    <label style="font-size: 0.7em; font-weight: bold; color: #555; margin-bottom: 4px; text-transform: uppercase;">Qtd</label>
                                                    <input type="number" id="qtd_subst_${item.id}_${docLista.id}" 
                                                        value="1" min="1" max="${saldoDisponivel}" 
                                                        style="width: 55px; padding: 8px; border: 1px solid #1b8a3e; border-radius: 5px; text-align: center; font-weight: bold;">
                                                </div>
                                                <button class="btn-resolver" style="height: 42px; padding: 0 20px; background: #1b8a3e; color:white; border:none; border-radius:5px; cursor:pointer; font-weight: bold;" 
                                                    onclick="confirmarTrocaCruzada('${item.id}', '${docLista.id}', '${item.nome}', '${p.cautelaId}', '${p.localId}', '${p.id_base || p.uidItem}', '${nomeEscapado}', '${motivoMilitar}', '${uidResponsavel}', '${nomeResponsavel}')">
                                                    Selecionar
                                                </button>
                                            </div>
                                        </div>`;
                                }
                            }
                            // --- LÓGICA PARA ITEM MULTI ---
                            else {
                                item.tombamentos.forEach(t => {
                                    const idCompleto = `${item.id}-${t.tomb}`;
                                    const temPendenciaAtiva = (t.pendencias_ids && t.pendencias_ids.length > 0);
                                    const disponivel = !t.cautela && !temPendenciaAtiva && t.situacao !== 'AVARIADO';
                                    
                                    if (disponivel && idCompleto !== idReferencia) {
                                        totalEncontrado++;
                                        const etiquetaLocal = docLista.id === p.localId ? `${nomeLocal} (RESERVA)` : nomeLocal;

                                        htmlAcumulado += `
                                            <div class="item-selecao-global" style="border: 1px solid #ddd; padding: 15px; border-radius: 10px; background: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                                <div>
                                                    <small style="color: #1b8a3e; font-weight: bold;"><i class="fas fa-map-marker-alt"></i> ${etiquetaLocal}</small><br>
                                                    <b style="color: #333;">Tombamento: ${t.tomb}</b><br>
                                                    <small style="color: #666;">${item.nome}</small>
                                                </div>
                                                <button class="btn-resolver" style="width:auto; padding: 10px 15px; background: #1b8a3e; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;" 
                                                    onclick="confirmarTrocaCruzada('${idCompleto}', '${docLista.id}', '${t.tomb}', '${p.cautelaId}', '${p.localId}', '${p.id_base || p.uidItem}', '${nomeEscapado}', '${motivoMilitar}', '${uidResponsavel}', '${nomeResponsavel}')">
                                                    Selecionar
                                                </button>
                                            </div>`;
                                    }
                                });
                            }
                        }
                    });
                });
            }
        });

        container.innerHTML = totalEncontrado > 0 ? htmlAcumulado : `<div style="text-align:center; padding:20px; color:#666;">Nenhum item compatível livre encontrado.</div>`;

    } catch (e) {
        console.error("Erro na busca global:", e);
        container.innerHTML = `<div style="color:red; padding:20px; text-align:center;">Erro: ${e.message}</div>`;
    }
}
		async function sincronizarAlmoxarifado() {
    if(!confirm("Deseja recalcular o saldo global baseado em todas as listas da unidade?")) return;
    
    // Feedback visual de carregamento
    const tbody = document.getElementById('almox-body');
    if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;"><i class="fas fa-sync fa-spin"></i> Sincronizando dados das viaturas...</td></tr>';

    try {
        const unitListIds = await getUnitListIds(); 
        const inventarioCalculado = {};

        // 1. Varre todas as listas (viaturas/bases) vinculadas à unidade
        for (const listaId of unitListIds) {
            const doc = await db.collection('listas_conferencia').doc(listaId).get();
            if (!doc.exists) continue;
            
            const data = doc.data().list || [];
            data.forEach(setor => {
                setor.itens.forEach(item => {
                    const uidGlobal = item.uid_global; // Usamos o UID Global como chave única
                    if (!uidGlobal) return;

                    if (!inventarioCalculado[uidGlobal]) {
                        inventarioCalculado[uidGlobal] = { emCarga: 0, emAlteracao: 0, tipo: item.tipo };
                    }
                    
                    if (item.tipo === 'single') {
                        const esperado = Number(item.quantidadeEsperada || item.quantidade) || 0;
                        const cautelado = (item.cautelas || []).reduce((s, c) => s + (Number(c.quantidade) || 0), 0);
                        const pendente = (item.pendencias_ids || []).reduce((s, p) => s + (Number(p.quantidade) || 0), 0);
                        
                        inventarioCalculado[uidGlobal].emCarga += (esperado - cautelado - pendente);
                        inventarioCalculado[uidGlobal].emAlteracao += (cautelado + pendente);
                    } else {
                        const tombamentos = item.tombamentos || [];
                        inventarioCalculado[uidGlobal].emCarga += tombamentos.filter(t => !t.cautela && (!t.pendencias_ids || t.pendencias_ids.length === 0)).length;
                        inventarioCalculado[uidGlobal].emAlteracao += tombamentos.filter(t => t.cautela || (t.pendencias_ids && t.pendencias_ids.length > 0)).length;
                    }
                });
            });
        }

        // 2. Atualiza os saldos nas sub-coleções de cada item no Inventário
        const batch = db.batch();
        const minhaUnidadeId = currentUserData.unidade_id;
        const dataReg = new Date().toLocaleString('pt-BR');

        for (const [uidGlobal, dados] of Object.entries(inventarioCalculado)) {
            const itemRef = db.collection('inventario').doc(uidGlobal);
            
            if (dados.tipo === 'single') {
                const saldoRef = itemRef.collection('saldos_unidades').doc(minhaUnidadeId);
                // Sincroniza apenas os campos de carga e alteração, mantendo o total e disponível
                batch.update(saldoRef, {
                    qtd_em_carga: dados.emCarga,
                    qtd_pend: dados.emAlteracao,
                    last_sync: dataReg
                });
            }
            // Itens Multi não precisam de update aqui pois o status está no documento do próprio tombamento
        }

        await batch.commit();
        alert("✅ Sincronização concluída! Saldos de carga atualizados no inventário.");
        
        // 3. Recarrega a UI (Substituindo o "();" anterior pela chamada correta)
        if (typeof carregarAlmoxarifadoUI === 'function') {
            await carregarAlmoxarifadoUI();
        }

    } catch (e) {
        console.error("Erro na sincronização:", e);
        alert("Erro ao sincronizar. Verifique o console.");
        if (typeof carregarAlmoxarifadoUI === 'function') {
            carregarAlmoxarifadoUI();
        }
    }
}
		
/**
 * RENDERIZAÇÃO DA TABELA DO ALMOXARIFADO
 * Ajustada para permitir visão global ao ADMIN e restrita ao GESTOR.
 */
async function carregarAlmoxarifadoUI() {
    const tbody = document.getElementById('almox-body');
    const palcoPrincipal = document.getElementById('container-tabela-principal');
    const wrapperRastreio = document.getElementById('almox-rastreio-wrapper');
    const filtroCard = document.getElementById('almox-filtros-container');
    const breadcrumb = document.getElementById('almox-breadcrumb');

    // Reset de UI padrão V3
    if (palcoPrincipal) palcoPrincipal.style.display = 'block';
    if (wrapperRastreio) wrapperRastreio.style.display = 'none';
    if (breadcrumb) breadcrumb.innerHTML = `Almoxarifado <i class="fas fa-chevron-right" style="font-size:0.7em; margin:0 5px;"></i> Inventário Geral`;

    if (!tbody) return;

    // Loading Padronizado V3
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:60px; color:#64748b;">
        <i class="fas fa-sync fa-spin fa-2x" style="opacity:0.3; margin-bottom:15px; display:block;"></i>
        <span style="font-weight:600;">CONSOLIDANDO INVENTÁRIO...</span>
    </td></tr>`;

    try {
        const role = currentUserData ? currentUserData.role : null;
        const isAdmin = (role === 'admin' || role === 'gestor_geral');
        const temUnidade = !!(currentUserData && currentUserData.unidade_id);

        if (!role || (!isAdmin && !temUnidade)) {
            setTimeout(carregarAlmoxarifadoUI, 1000);
            return;
        }

        const minhaUnidadeId = currentUserData.unidade_id;
        const snapItens = await db.collection('inventario').get();
        const listaFinal = [];

        for (const doc of snapItens.docs) {
            const d = doc.data();
            if (!d) continue;

            const itemConsolidado = {
                id: doc.id,
                nome: d.nome || "Item sem Nome",
                tipo: d.tipo || "single",
                categoria: d.categoria || "OUTROS",
                total: 0, disponivel: 0, emCarga: 0, emAlteracao: 0, locais: []
            };

            if (itemConsolidado.tipo === 'multi') {
                let queryTomb = doc.ref.collection('tombamentos');
                if (!isAdmin) queryTomb = queryTomb.where('local_id', '==', minhaUnidadeId);
                const snapTomb = await queryTomb.get();
                snapTomb.forEach(tDoc => {
                    const t = tDoc.data();
                    itemConsolidado.total++;
                    if (t.situacao_atual === 'DISPONÍVEL') itemConsolidado.disponivel++;
                    else if (t.situacao_atual === 'EM CARGA') itemConsolidado.emCarga++;
                    else if (['AVARIADO', 'PENDENTE', 'MANUTENÇÃO'].includes(t.situacao_atual)) itemConsolidado.emAlteracao++;
                    if (t.local_id && !itemConsolidado.locais.includes(t.local_id)) itemConsolidado.locais.push(t.local_id);
                });
            } else {
                let querySaldo = doc.ref.collection('saldos_unidades');
                if (!isAdmin) querySaldo = querySaldo.where(firebase.firestore.FieldPath.documentId(), '==', minhaUnidadeId);
                const snapSaldo = await querySaldo.get();
                snapSaldo.forEach(sDoc => {
                    const s = sDoc.data();
                    itemConsolidado.total += (Number(s.qtd_total) || 0);
                    itemConsolidado.disponivel += (Number(s.qtd_disp) || 0);
                    itemConsolidado.emCarga += (Number(s.qtd_em_carga) || 0);
                    itemConsolidado.emAlteracao += (Number(s.qtd_pend) || 0) + (Number(s.qtd_caut) || 0) + (Number(s.qtd_transito) || 0);
                    if (s.unidade_sigla && !itemConsolidado.locais.includes(s.unidade_sigla)) itemConsolidado.locais.push(s.unidade_sigla);
                });
            }
            if (itemConsolidado.total > 0 || isAdmin) listaFinal.push(itemConsolidado);
        }

        let html = '';
        listaFinal.sort((a, b) => a.nome.localeCompare(b.nome));

        if (listaFinal.length === 0) {
            html = `<tr><td colspan="6" style="text-align:center; padding:60px; color:#64748b;">
                <i class="fas fa-box-open fa-3x" style="opacity:0.2; margin-bottom:15px; display:block;"></i>
                <span style="font-weight:600;">Nenhum material localizado.</span>
            </td></tr>`;
        } else {
            listaFinal.forEach(d => {
                // Cores baseadas no design System V3
                let statusColor = (d.disponivel === 0) ? '#e11d48' : (d.disponivel < (d.total * 0.25)) ? '#f59e0b' : '#10b981';
                
                const labelLocais = isAdmin && d.locais.length > 0
                    ? `<div style="margin-top:4px;"><span style="font-size:10px; background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-weight:bold;"><i class="fas fa-map-marker-alt"></i> ${d.locais.join(', ')}</span></div>` 
                    : '';

                html += `
                <tr data-categoria="${d.categoria.toUpperCase()}">
                    <td>
                        <div style="line-height:1.4;">
                            <span style="font-weight:700; color:#1e293b; font-size:1.1em;">${d.nome}</span>
                            ${labelLocais}
                            <div style="font-size:10px; color:#94a3b8; font-weight:700; text-transform:uppercase; margin-top:2px;">CAT: ${d.categoria} • ${d.tipo}</div>
                        </div>
                    </td>
                    <td style="text-align:center; font-weight:700; color:#475569;">${d.total}</td>
                    <td style="text-align:center; color:#64748b;">${d.emCarga}</td>
                    <td style="text-align:center; color:#e11d48; font-weight:600;">${d.emAlteracao}</td>
                    <td style="text-align:center;">
                        <span style="display:inline-block; padding:4px 12px; border-radius:8px; background:${statusColor}15; color:${statusColor}; font-weight:800; font-size:1.1em;">
                            ${d.disponivel}
                        </span>
                    </td>
                    <td>
                        <div style="display:flex; gap:8px; justify-content:center;">
                            <button class="sigma-v3-tab" title="Rastrear" onclick="verDetalhesItemAlmox('${d.id}')" style="padding:8px 12px; background:#f1f5f9;">
                                <i class="fas fa-search-location"></i>
                            </button>
                            <button class="sigma-v3-tab" title="Entrada" onclick="prepararAporte('${d.id}')" style="padding:8px 12px; background:#800020; color:white;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
        }
        tbody.innerHTML = html;
    } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#e11d48; padding:20px; font-weight:bold;">ERRO NA CONSOLIDAÇÃO</td></tr>';
    }
}
/**
 * Filtro de pesquisa unificado (Texto + Categoria) com feedback de lista vazia.
 */
function filtrarAlmoxarifado() {
    const searchInput = document.getElementById('almox-search');
    const catSelect = document.getElementById('almox-cat-filter');
    const searchTerm = searchInput.value.toUpperCase().trim();
    const categoryTerm = catSelect.value.toUpperCase().trim();
    const tbody = document.getElementById('almox-body');
    const rows = tbody.querySelectorAll('tr:not(.no-results-row)');

    let visibleCount = 0;

    rows.forEach(row => {
        if (!row.hasAttribute('data-categoria')) return;

        const textMaterial = row.cells[0]?.textContent.toUpperCase() || "";
        const itemCategory = row.getAttribute('data-categoria').toUpperCase().trim();

        const matchesSearch = textMaterial.includes(searchTerm);
        const matchesCategory = (categoryTerm === "" || itemCategory === categoryTerm);

        if (matchesSearch && matchesCategory) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    });

    // --- LÓGICA DE MENSAGEM V3 ---
    const existingMsg = tbody.querySelector('.no-results-row');
    if (existingMsg) existingMsg.remove();

    if (visibleCount === 0) {
        const tr = document.createElement('tr');
        tr.className = 'no-results-row';
        tr.innerHTML = `
            <td colspan="6" style="text-align:center; padding:60px; color:#64748b;">
                <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
                    <i class="fas fa-box-open fa-3x" style="opacity:0.2; color:#94a3b8;"></i>
                    <span style="font-weight:600; font-size:0.95em;">Nenhum material localizado nos filtros atuais.</span>
                    <button onclick="document.getElementById('almox-search').value=''; document.getElementById('almox-cat-filter').value=''; filtrarAlmoxarifado();" 
                            style="margin-top:8px; padding:8px 16px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; color:#800020; cursor:pointer; font-weight:700; font-size:0.8em; transition:0.3s; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                        <i class="fas fa-filter-circle-xmark"></i> LIMPAR BUSCA
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    }
}
		
async function verDetalhesItemAlmox(docId) {
    const palcoPrincipal = document.getElementById('container-tabela-principal');
    const palcoRastreio = document.getElementById('almox-rastreio-wrapper');
    const tbodyRastreio = document.getElementById('almox-rastreio-body');
    const theadRastreio = document.getElementById('almox-rastreio-thead');
    const filtroCard = document.getElementById('almox-filtros-container');
    const breadcrumb = document.getElementById('almox-breadcrumb');

    if (!docId || !palcoPrincipal || !palcoRastreio) return;

    palcoPrincipal.style.display = 'none';
    // ✅ ALTERAÇÃO CIRÚRGICA: Removida a linha que ocultava o filtroCard (display = 'none')
    // O filtro agora permanece visível para permitir buscas dentro dos detalhes do item.
    palcoRastreio.style.display = 'block';

    tbodyRastreio.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:60px; color:#64748b;">
        <i class="fas fa-radar fa-spin fa-3x" style="opacity:0.3; margin-bottom:15px; display:block;"></i>
        <span style="font-weight:600;">MAPEANDO LOGÍSTICA ESTADUAL...</span>
    </td></tr>`;

    try {
        const docAlvo = await db.collection('inventario').doc(docId).get();
        if (!docAlvo.exists) throw new Error("Item não encontrado.");
        
        const itemData = docAlvo.data();
        const ehMulti = itemData.tipo === 'multi';
        const uidGlobal = itemData.uid_global || docId; 
        const role = currentUserData.role;
        const souAdminGeral = (role === 'admin' || role === 'gestor_geral');

        if (breadcrumb) breadcrumb.innerHTML = `Almoxarifado <i class="fas fa-chevron-right" style="font-size:0.7em; margin:0 5px;"></i> Detalhes <i class="fas fa-chevron-right" style="font-size:0.7em; margin:0 5px;"></i> <b style="color:#800020;">${itemData.nome}</b>`;

        const btnHistGlobal = !ehMulti ? 
            `<button class="sigma-v3-tab" title="Ver histórico de movimentações do lote" onclick="verHistoricoVidaGlobal('${docId}')" style="background:#fef3c7; color:#92400e; border:none;"><i class="fas fa-history"></i> Lote</button>` : '';

        const headerHtml = `
            <div id="header-detalhe-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:#f8fafc; border-radius:12px;">
                <div>
                    <h2 style="margin:0; color:#1e293b; font-size:1.4em; font-weight:800;">${itemData.nome}</h2>
                    <small style="color:#64748b; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">Rastreio em Tempo Real</small>
                </div>
                ${btnHistGlobal}
            </div>`;

        const oldHeader = document.getElementById('header-detalhe-item');
        if(oldHeader) oldHeader.remove();
        palcoRastreio.prepend(new DOMParser().parseFromString(headerHtml, 'text/html').body.firstChild);

        theadRastreio.innerHTML = `
            <tr>
                ${ehMulti ? '<th>Tombamento / Unidade</th>' : '<th>Localização / Unidade</th>'}
                <th style="text-align:center;">Saldo</th>
                <th style="text-align:center;">Status</th>
                <th style="text-align:right;">Ações</th>
            </tr>`;

        let htmlPrioridade = ''; let htmlRestante = '';   
        let cDisp = 0, cUso = 0, cCaut = 0, cPend = 0;
        const pendenciasVtrMap = {}; 

        // --- 1. PROCESSAMENTO DE ESTOQUE (ALMOXARIFADO) ---
        if (ehMulti) {
            const snapTombs = await db.collection('inventario').doc(docId).collection('tombamentos').get();
            for (const tDoc of snapTombs.docs) {
                const t = tDoc.data();
                const ehDono = (t.local_id === currentUserData.unidade_id);
                const podeEnviar = (souAdminGeral && t.local_id === "ADMIN") || (ehDono && !souAdminGeral);
                if (!t.viatura_id) {
                    const temP = t.pendencias_ids?.length > 0;
                    if (ehDono || souAdminGeral) { if (temP) cPend++; else cDisp++; }
                    const statusTxt = temP ? 'PENDENTE' : 'DISPONÍVEL';
                    const badgeStyle = temP ? 'background:#fee2e2;color:#b91c1c;' : 'background:#dcfce7;color:#15803d;';
                    let bufferHtml = `
                        <tr style="background:${ehDono ? 'rgba(16,185,129,0.03)' : '#fff'};">
                            <td><span style="font-weight:700; color:#1e293b;">${t.tomb}</span><br><small style="color:#64748b;"><i class="fas fa-warehouse"></i> ${t.unidade_sigla || '---'}</small></td>
                            <td style="text-align:center; font-weight:800; color:#1e293b;">1 un.</td>
                            <td style="text-align:center;"><span style="padding:4px 10px; border-radius:6px; font-size:0.75em; font-weight:800; ${badgeStyle}">${statusTxt}</span></td>
                            <td style="text-align:right;">
                                <div style="display:flex; gap:5px; justify-content:flex-end;">
                                    ${podeEnviar ? `<button onclick="prepararMovimentacao('${docId}','ENVIO','${t.tomb}')" title="Enviar para outra unidade" class="sigma-v3-tab active" style="padding:6px 10px; background:#800020;"><i class="fas fa-paper-plane"></i></button>` : ''}
                                    <button onclick="verHistoricoVidaGlobal('${docId}', '${t.tomb}')" title="Ver histórico individual" class="sigma-v3-tab" style="padding:6px 10px; background:#fef3c7; color:#92400e;"><i class="fas fa-history"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    if (ehDono) htmlPrioridade += bufferHtml; else htmlRestante += bufferHtml;
                }
            }
        } else {
            const snapSaldos = await db.collection('inventario').doc(docId).collection('saldos_unidades').get();
            for (const sDoc of snapSaldos.docs) {
                const s = sDoc.data();
                const ehDono = (sDoc.id === currentUserData.unidade_id);
                const podeEnviar = (souAdminGeral && sDoc.id === "ADMIN") || (ehDono && !souAdminGeral);
                
                const snapLogs = await sDoc.ref.collection('historico_vida').where('evento', '==', 'PENDENCIA_RELATADA').get();
                let pendenciaVazanteParaVtr = 0;
                
                snapLogs.forEach(logDoc => {
                    const log = logDoc.data();
                    if (log.lista_origem_id) {
                        pendenciasVtrMap[log.lista_origem_id] = (pendenciasVtrMap[log.lista_origem_id] || 0) + (log.quantidade || 0);
                        pendenciaVazanteParaVtr += (log.quantidade || 0);
                    }
                });

                const saldoDispRealAlmox = Number(s.qtd_disp) || 0;
                const saldoPendLocalAlmox = (Number(s.qtd_pend) || 0) - pendenciaVazanteParaVtr;
                const saldoFisicoNoAlmox = saldoDispRealAlmox + saldoPendLocalAlmox;

                if (ehDono || souAdminGeral) { cDisp += saldoDispRealAlmox; }

                if (saldoFisicoNoAlmox > 0) {
                    let statusHtml = '';
                    if (saldoDispRealAlmox > 0 && saldoPendLocalAlmox > 0) {
                        statusHtml = `<div><span style="font-size:0.75em; font-weight:800; color:#15803d;">${saldoDispRealAlmox} un. DISPONÍVEL</span></div>
                                      <div style="margin-top:2px;"><span style="padding:2px 8px; border-radius:4px; font-size:0.7em; font-weight:800; background:#fee2e2; color:#b91c1c;">${saldoPendLocalAlmox} un. PENDENTE</span></div>`;
                    } else if (saldoPendLocalAlmox > 0) {
                        statusHtml = `<span style="padding:4px 10px; border-radius:6px; font-size:0.75em; font-weight:800; background:#fee2e2; color:#b91c1c;">${saldoPendLocalAlmox} un. PENDENTE</span>`;
                    } else {
                        statusHtml = `<span style="padding:4px 10px; border-radius:6px; font-size:0.75em; font-weight:800; background:#dcfce7; color:#15803d;">DISPONÍVEL</span>`;
                    }

                    let bufferHtml = `
                        <tr style="background:${ehDono ? 'rgba(16,185,129,0.03)' : '#fff'};">
                            <td><i class="fas fa-warehouse" style="margin-right:8px; color:#64748b;"></i><span style="font-weight:700;">${s.unidade_sigla}</span></td>
                            <td style="text-align:center; font-weight:800; color:#1e293b;">${saldoFisicoNoAlmox} un.</td>
                            <td style="text-align:center;">${statusHtml}</td>
                            <td style="text-align:right;">
                                ${podeEnviar ? `<button onclick="prepararMovimentacao('${docId}','ENVIO')" title="Transferir saldo" class="sigma-v3-tab active" style="background:#800020;"><i class="fas fa-paper-plane"></i></button>` : ''}
                            </td>
                        </tr>`;
                    if (ehDono) htmlPrioridade += bufferHtml; else htmlRestante += bufferHtml;
                }
            }
        }

        // --- 2. BUSCA EM VIATURAS ---
        const snapListas = await db.collection('listas_conferencia').where('ativo', '==', true).get();
        snapListas.forEach(docVtr => {
            const vtrData = docVtr.data();
            const ehMinhaVtr = (vtrData.unidade_id === currentUserData.unidade_id);
            (vtrData.list || []).forEach(setor => {
                const itNaVtr = (setor.itens || []).find(i => i.uid_global === uidGlobal || i.nome === itemData.nome);
                if (!itNaVtr) return;
                
                if (ehMulti) {
                    (itNaVtr.tombamentos || []).forEach(t => {
                        const temC = !!t.cautela; const temP = t.pendencias_ids?.length > 0;
                        if (ehMinhaVtr || souAdminGeral) { if (temP) cPend++; else if (temC) cCaut++; else cUso++; }
                        const statusTxt = temP ? 'PENDENTE' : (temC ? 'CAUTELADO' : 'EM USO');
                        const badgeStyle = temP ? 'background:#fee2e2;color:#b91c1c;' : (temC ? 'background:#fff3cd;color:#856404;' : 'background:#f1f5f9;color:#475569;');
                        let bufferVtr = `<tr style="background:${ehMinhaVtr ? 'rgba(16,185,129,0.03)' : '#fff'};">
                            <td><span style="font-weight:700;">${t.tomb}</span><br><small style="color:#64748b;"><i class="fas fa-truck-container" style="margin-right:5px;"></i> ${vtrData.ativo_nome}</small></td>
                            <td style="text-align:center; font-weight:800; color:#1e293b;">1 un.</td>
                            <td style="text-align:center;"><span style="padding:4px 10px; border-radius:6px; font-size:0.75em; font-weight:800; ${badgeStyle}">${statusTxt}</span></td>
                            <td style="text-align:right;">
                                <div style="display:flex; gap:5px; justify-content:flex-end;">
                                    ${ehMinhaVtr || role === 'admin' ? `<button onclick="prepararMovimentacao('${docId}','RECOLHIMENTO','${t.tomb}','${docVtr.id}')" title="Retornar ao estoque" class="sigma-v3-tab" style="background:#f59e0b; color:white;"><i class="fas fa-arrow-down"></i></button>` : ''}
                                    <button onclick="verHistoricoVidaGlobal('${docId}', '${t.tomb}')" title="Ver histórico" class="sigma-v3-tab" style="padding:6px 10px; background:#fef3c7; color:#92400e;"><i class="fas fa-history"></i></button>
                                </div>
                            </td>
                        </tr>`;
                        if (ehMinhaVtr) htmlPrioridade += bufferVtr; else htmlRestante += bufferVtr;
                    });
                } else {
                    const qtdFisicaVtr = Number(itNaVtr.quantidadeEsperada) || 0;
                    const qtdPendVtr = pendenciasVtrMap[docVtr.id] || 0;
                    const qtdEmUsoLimpa = qtdFisicaVtr - qtdPendVtr;

                    if (ehMinhaVtr || souAdminGeral) { 
                        cUso += qtdEmUsoLimpa; 
                        cPend += qtdPendVtr; 
                    }

                    if (qtdFisicaVtr > 0) {
                        let statusHtml = '';
                        if (qtdEmUsoLimpa > 0 && qtdPendVtr > 0) {
                            statusHtml = `<div><span style="font-size:0.75em; font-weight:800; color:#475569;">${qtdEmUsoLimpa} un. EM USO</span></div>
                                          <div style="margin-top:2px;"><span style="padding:2px 8px; border-radius:4px; font-size:0.7em; font-weight:800; background:#fee2e2; color:#b91c1c;">${qtdPendVtr} un. PENDENTE</span></div>`;
                        } else if (qtdPendVtr > 0) {
                            statusHtml = `<span style="padding:4px 10px; border-radius:6px; font-size:0.75em; font-weight:800; background:#fee2e2; color:#b91c1c;">${qtdPendVtr} un. PENDENTE</span>`;
                        } else {
                            statusHtml = `<span style="padding:4px 10px; border-radius:6px; font-size:0.75em; font-weight:800; background:#f1f5f9; color:#475569;">EM USO</span>`;
                        }

                        let bufferVtr = `<tr style="background:${ehMinhaVtr ? 'rgba(16,185,129,0.03)' : '#fff'};">
                            <td><i class="fas fa-truck-pickup" style="margin-right:8px; color:#64748b;"></i><span style="font-weight:700;">${vtrData.ativo_nome}</span></td>
                            <td style="text-align:center; font-weight:800; color:#1e293b;">${qtdFisicaVtr} un.</td>
                            <td style="text-align:center;">${statusHtml}</td>
                            <td style="text-align:right;">
                                ${ehMinhaVtr || role === 'admin' ? 
                                    `<button onclick="prepararMovimentacao('${docId}','RECOLHIMENTO', null,'${docVtr.id}')" title="Recolher material" class="sigma-v3-tab" style="background:#f59e0b; color:white;"><i class="fas fa-arrow-down"></i></button>` : ''}
                            </td>
                        </tr>`;
                        if (ehMinhaVtr) htmlPrioridade += bufferVtr; else htmlRestante += bufferVtr;
                    }
                }
            });
        });

        let finalHtml = "";
        if (htmlPrioridade) {
            finalHtml += `<tr class="sigma-v3-table-group-header"><td colspan="4" style="background:#f0fdf4; color:#166534; font-weight:800; font-size:0.75em; padding:10px 15px; text-transform:uppercase; letter-spacing:1px; border-left:4px solid #10b981;"><i class="fas fa-shield-alt"></i> Custódia de Minha Unidade (Estoque Local)</td></tr>`;
            finalHtml += htmlPrioridade;
        }
        if (htmlRestante) {
            finalHtml += `<tr class="sigma-v3-table-group-header"><td colspan="4" style="background:#f8fafc; color:#64748b; font-weight:800; font-size:0.75em; padding:25px 15px 10px 15px; text-transform:uppercase; letter-spacing:1px; border-left:4px solid #cbd5e1;"><i class="fas fa-globe-americas"></i> Disponibilidade em Outras Unidades (Consulta Global)</td></tr>`;
            finalHtml += htmlRestante;
        }

        const totalG = cDisp + cUso + cCaut + cPend;
        const extratoHtml = `
            <div id="almox-resumo-topo" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:15px; margin-bottom:25px;">
                <div style="background:#dcfce7; padding:15px; border-radius:12px; text-align:center; border:1px solid #bcf0da;">
                    <small style="color:#15803d; font-weight:800; display:block; font-size:0.7em; text-transform:uppercase;">Disponível</small>
                    <b style="font-size:1.6em; color:#15803d;">${cDisp}</b>
                </div>
                <div style="background:#f1f5f9; padding:15px; border-radius:12px; text-align:center; border:1px solid #e2e8f0;">
                    <small style="color:#475569; font-weight:800; display:block; font-size:0.7em; text-transform:uppercase;">Em Uso</small>
                    <b style="font-size:1.6em; color:#475569;">${cUso}</b>
                </div>
                <div style="background:#fff3cd; padding:15px; border-radius:12px; text-align:center; border:1px solid #ffeeba;">
                    <small style="color:#856404; font-weight:800; display:block; font-size:0.7em; text-transform:uppercase;">Cautelado</small>
                    <b style="font-size:1.6em; color:#856404;">${cCaut}</b>
                </div>
                <div style="background:#fee2e2; padding:15px; border-radius:12px; text-align:center; border:1px solid #fecaca;">
                    <small style="color:#b91c1c; font-weight:800; display:block; font-size:0.7em; text-transform:uppercase;">Pendente</small>
                    <b style="font-size:1.6em; color:#b91c1c;">${cPend}</b>
                </div>
                <div style="background:#800020; padding:15px; border-radius:12px; text-align:center;">
                    <small style="color:#fff; font-weight:800; display:block; font-size:0.7em; text-transform:uppercase;">Total Geral</small>
                    <b style="font-size:1.6em; color:#fff;">${totalG}</b>
                </div>
            </div>`;

        const resOld = document.getElementById('almox-resumo-topo');
        if(resOld) resOld.remove();
        palcoRastreio.querySelector('#header-detalhe-item').insertAdjacentHTML('afterend', extratoHtml);
        tbodyRastreio.innerHTML = finalHtml || `<tr><td colspan="4" style="text-align:center; padding:60px; color:#64748b;"><i class="fas fa-box-open fa-3x" style="opacity:0.2; margin-bottom:15px; display:block;"></i>Nenhum registro localizado.</td></tr>`;

    } catch (e) {
        console.error(e);
        tbodyRastreio.innerHTML = '<tr><td colspan="4" style="color:#e11d48; text-align:center; font-weight:bold; padding:40px;">ERRO NO PROCESSAMENTO DE RASTREIO</td></tr>';
    }
}
		
		
// FUNÇÃO COMPLEMENTAR DO MODAL DE CONSULTA (Agrupamento Logístico)
function abrirModalConsultaTombamentos(unidade, listaJson) {
    try {
        const stringLimpa = listaJson.replace(/&quot;/g, '"');
        const lista = JSON.parse(stringLimpa);

        const modalHtml = `
            <div id="modal-consulta-tomb" class="modal-modern-overlay" style="display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
                <div class="modal-modern-content" style="max-width:350px; background:#fff; padding:20px; border-radius:12px; width:90%; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                    <div class="modal-modern-header" style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                        <h3 style="margin:0; font-size:1.1em; color:#333;">Tombamentos: ${unidade}</h3>
                        <button onclick="document.getElementById('modal-consulta-tomb').remove()" style="background:none; border:none; font-size:1.5em; cursor:pointer; color:#999;">&times;</button>
                    </div>
                    <div class="modal-modern-body" style="max-height:300px; overflow-y:auto; padding-right:5px;">
                        <ul style="list-style:none; padding:0; margin:0;">
                            ${lista.map(t => `<li style="padding:12px 10px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; gap:12px;">
    <i class="fas fa-tag" style="color:#2c7399; font-size:1em;"></i> 
    <span style="font-family:monospace; font-weight:bold; color:#333; font-size: 1.15em;">${t}</span>
</li>`).join('')}
                        </ul>
                    </div>
                    <div class="modal-modern-footer" style="text-align:right; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                        <button onclick="document.getElementById('modal-consulta-tomb').remove()" 
                                style="background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; transition: background 0.2s;">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>`;
        
        const anterior = document.getElementById('modal-consulta-tomb');
        if(anterior) anterior.remove();

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    } catch (e) {
        console.error("Erro no modal de consulta:", e);
    }
}
		
		// Função de Filtragem Instantânea com Higienização Numérica
function filtrarRastreioMulti() {
    // 1. Pega o termo digitado e remove qualquer caractere que não seja número
    const termoOriginal = document.getElementById('filtro-tomb-input').value.toLowerCase();
    const termoApenasNumeros = termoOriginal.replace(/\D/g, ''); 
    
    const local = document.getElementById('filtro-local-select').value;
    const linhas = document.querySelectorAll('#almox-rastreio-body tr');

    linhas.forEach(tr => {
        const tombOriginal = tr.getAttribute('data-tomb') || "";
        // 2. Remove a pontuação do tombamento da tabela para comparação
        const tombApenasNumeros = tombOriginal.replace(/\D/g, '');
        const localTr = tr.getAttribute('data-local') || "";
        
        // 3. Verifica se bate: ou pelo texto original (caso busquem letras) ou pela sequência numérica
        const bateTomb = tombOriginal.toLowerCase().includes(termoOriginal) || 
                         (termoApenasNumeros !== "" && tombApenasNumeros.includes(termoApenasNumeros));
        
        const bateLocal = local === "" || localTr === local;

        tr.style.display = (bateTomb && bateLocal) ? "" : "none";
    });
}
/**
 * Função de ponte que prepara o modal de transferência com os dados clicados na lupa
 */
async function prepararMovimentacao(docId, operacao, tombamento = null, viaturaId = null) {
    // 1. Busca os dados do item no Inventário V3 antes de abrir o modal
    const docAlvo = await db.collection('inventario').doc(docId).get();
    if (!docAlvo.exists) return alert("Erro ao localizar item no inventário.");
    
    const itemData = docAlvo.data();
    const ehMulti = itemData.tipo === 'multi';
    const role = currentUserData.role;
    const souAdmin = (role === 'admin' || role === 'gestor_geral');

    // 2. Define Identidade Visual (Cores e Títulos)
    const config = {
        ENVIO: {
            titulo: souAdmin ? "Transferência de Unidade" : "Enviar para Viatura",
            cor: "#2c7399",
            icone: "fa-paper-plane",
            btnTexto: souAdmin ? "CONFIRMAR TRANSFERÊNCIA" : "CONFIRMAR ENVIO"
        },
        RECOLHIMENTO: {
            titulo: "Recolher para Almoxarifado",
            cor: "#f57c00",
            icone: "fa-arrow-down",
            btnTexto: "CONFIRMAR RECOLHIMENTO"
        }
    }[operacao];

    // 3. Monta o Modal SweetAlert2 Moderno
    Swal.fire({
        title: `<i class="fas ${config.icone}"></i> ${config.titulo}`,
        html: `
            <div style="text-align: left; padding: 5px;">
                <div class="summary-item-modal" style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:15px; border-left:4px solid ${config.cor};">
                    <small style="color:#64748b; font-weight:700; text-transform:uppercase; font-size:0.7em;">Item Selecionado</small>
                    <div style="font-weight:800; color:#1e293b; font-size:1.1em;">${itemData.nome}</div>
                </div>

                <div class="form-group">
                    <label style="font-size: 0.85em; font-weight:bold; color:#800020;">
                        ${souAdmin ? '1. UNIDADE DE DESTINO:' : '1. VIATURA / LOCAL ALVO:'}
                    </label>
                    <select id="swal-mov-destino" class="swal2-select" style="width: 100%; margin: 10px 0;">
                        <option value="" disabled selected>Selecione o destino...</option>
                    </select>
                </div>

                ${!souAdmin && operacao === 'ENVIO' ? `
                <div class="form-group" style="margin-top:15px;">
                    <label style="font-size: 0.85em; font-weight:bold; color:#800020;">2. SETOR DE CARGA:</label>
                    <select id="swal-mov-setor" class="swal2-select" style="width: 100%; margin: 10px 0;">
                        <option value="CABINE">CABINE</option>
                        <option value="CARROCERIA">CARROCERIA</option>
                    </select>
                </div>` : ''}

                <div class="form-group" style="margin-top:15px;">
                    <label id="label-qtd-swal" style="font-size: 0.85em; font-weight:bold; color:#800020;">
                        ${ehMulti ? 'PATRIMÔNIO / TOMBAMENTO:' : 'QUANTIDADE PARA MOVIMENTAR:'}
                    </label>
                    
                    ${ehMulti ? `
                        <div id="lista-tomb-swal" style="max-height:150px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; padding:10px; margin-top:5px; background:#fff;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando materiais...
                        </div>
                    ` : `
                        <input type="number" id="swal-mov-qtd" class="swal2-input" 
                            style="width:80%; margin:10px 0;" placeholder="0" min="1" max="0"
                            oninput="if(parseInt(this.value) > parseInt(this.max)) { this.value = this.max; Swal.showValidationMessage('Saldo insuficiente! Máximo: ' + this.max); } else { Swal.resetValidationMessage(); }">
                    `}
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: config.btnTexto,
        confirmButtonColor: config.cor,
        cancelButtonText: 'Cancelar',
        didOpen: async () => {
            await popularDestinosMovimentacao(souAdmin, operacao, viaturaId);
            
            if (ehMulti) {
                await popularTombamentosMovimentacao(docId, operacao, tombamento, viaturaId, config.cor);
            } else {
                // ✅ BUSCA DE SALDO PARA TRAVA DE QUANTIDADE
                try {
                    const minhaUnidadeId = currentUserData.unidade_id;
                    const snapSaldo = await db.collection('inventario').doc(docId)
                                              .collection('saldos_unidades').doc(minhaUnidadeId).get();
                    
                    const saldoDisp = snapSaldo.exists ? (snapSaldo.data().qtd_disp || 0) : 0;
                    const inputQtd = document.getElementById('swal-mov-qtd');
                    const labelQtd = document.getElementById('label-qtd-swal');

                    if (inputQtd) {
                        inputQtd.max = saldoDisp; // Define o teto matemático no atributo max
                        if (labelQtd) {
                            labelQtd.innerHTML = `QUANTIDADE PARA MOVIMENTAR: <span style="float:right; color:#1b8a3e;">Saldo Disponível: ${saldoDisp}</span>`;
                        }
                        if (saldoDisp <= 0 && operacao === 'ENVIO') {
                            inputQtd.disabled = true;
                            Swal.showValidationMessage('Atenção: Esta unidade não possui saldo disponível para envio.');
                        }
                    }
                } catch (e) { console.error("Erro ao carregar saldo:", e); }
            }
        },
        preConfirm: () => {
            const destino = document.getElementById('swal-mov-destino').value;
            const inputQtd = document.getElementById('swal-mov-qtd');

            if (!destino) return Swal.showValidationMessage('Por favor, selecione o destino');
            
            if (inputQtd) {
                const qtdValor = parseInt(inputQtd.value);
                const qtdMax = parseInt(inputQtd.max);

                if (!qtdValor || qtdValor <= 0) return Swal.showValidationMessage('Informe uma quantidade válida');
                // ✅ VALIDAÇÃO FINAL DE SEGURANÇA
                if (qtdValor > qtdMax && operacao === 'ENVIO') {
                    return Swal.showValidationMessage(`Saldo insuficiente! Você só possui ${qtdMax} unidades.`);
                }
                
                return { 
                    destinoId: destino, 
                    quantidade: qtdValor, 
                    tombamentos: null,
                    setorId: document.getElementById('swal-mov-setor')?.value || 'CABINE'
                };
            }
            
            return {
                destinoId: destino,
                quantidade: null,
                tombamentos: ehMulti ? Array.from(document.querySelectorAll('.swal-tomb-check:checked')).map(cb => cb.value) : null,
                setorId: document.getElementById('swal-mov-setor')?.value || 'CABINE'
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            executarMovimentacaoReal(docId, operacao, result.value);
        }
    });
}
		async function popularDestinosMovimentacao(souAdmin, operacao, viaturaIdPreSeleccionada = null) {
    const selectDestino = document.getElementById('swal-mov-destino');
    if (!selectDestino) return;

    try {
        let htmlOptions = `<option value="" disabled selected>Selecione o destino...</option>`;

        if (souAdmin) {
            // ✅ CORREÇÃO V3: Busca na coleção estruturada e ordenada por sigla
            const snapUnidades = await db.collection('unidades_estruturadas')
                                         .where('ativo', '==', true)
                                         .get();
            
            // Ordenação manual para garantir estética
            const unidades = snapUnidades.docs.map(d => ({ id: d.id, ...d.data() }))
                                              .sort((a, b) => a.sigla.localeCompare(b.sigla));

            unidades.forEach(u => {
                htmlOptions += `<option value="${u.id}">${u.sigla} - ${u.nome_completo}</option>`;
            });
        } else {
            // GESTOR LOCAL: Busca as listas de conferência (Viaturas/Bases) da unidade dele
            const snapVtrs = await db.collection('listas_conferencia')
                                     .where('unidade_id', '==', currentUserData.unidade_id)
                                     .where('ativo', '==', true)
                                     .get();
            
            snapVtrs.forEach(doc => {
                const data = doc.data();
                const isSelected = (viaturaIdPreSeleccionada === doc.id) ? 'selected' : '';
                htmlOptions += `<option value="${doc.id}" ${isSelected}>${data.ativo_nome} (${data.posto_nome})</option>`;
            });

            // Se for recolhimento vindo do rastreio, trava o destino para evitar erro
            if (operacao === 'RECOLHIMENTO' && viaturaIdPreSeleccionada) {
                selectDestino.disabled = true;
                selectDestino.style.backgroundColor = "#f1f5f9";
            }
        }

        selectDestino.innerHTML = htmlOptions;

    } catch (e) {
        console.error("Erro ao popular destinos:", e);
        selectDestino.innerHTML = `<option value="">Erro ao carregar dados</option>`;
    }
}
		async function popularTombamentosMovimentacao(docId, operacao, tombamentoFoco, viaturaId, corTema) {
    const containerTomb = document.getElementById('lista-tomb-swal');
    if (!containerTomb) return;

    try {
        let listaTombs = [];

        if (operacao === 'ENVIO') {
            // Busca tombamentos que estão no estoque central da unidade (viatura_id == null)
            const snap = await db.collection('inventario').doc(docId)
                                  .collection('tombamentos')
                                  .where('local_id', '==', currentUserData.unidade_id)
                                  .where('viatura_id', '==', null).get();
            snap.forEach(d => listaTombs.push(d.data()));
        } else {
            // RECOLHIMENTO: Busca tombamentos que estão especificamente naquela viatura
            const snap = await db.collection('inventario').doc(docId)
                                  .collection('tombamentos')
                                  .where('viatura_id', '==', viaturaId).get();
            snap.forEach(d => listaTombs.push(d.data()));
        }

        if (listaTombs.length === 0) {
            containerTomb.innerHTML = `<span style="color:#64748b; font-size:0.85em;">Nenhum material disponível para esta operação.</span>`;
            return;
        }

        // Gera o HTML dos checkboxes com o estilo Sigma V3
        let htmlChecks = "";
        listaTombs.forEach(t => {
            const isFoco = (t.tomb === tombamentoFoco) ? 'checked' : '';
            htmlChecks += `
                <div style="margin-bottom:8px; display:flex; align-items:center;">
                    <input type="checkbox" class="swal-tomb-check" id="chk-${t.tomb}" value="${t.tomb}" ${isFoco} style="width:18px; height:18px; accent-color:${corTema};">
                    <label for="chk-${t.tomb}" style="margin-left:10px; font-weight:700; color:#1e293b; cursor:pointer;">
                        ${t.tomb} <small style="color:#64748b; font-weight:400;">(${t.situacao_atual || 'DISPONÍVEL'})</small>
                    </label>
                </div>`;
        });

        containerTomb.innerHTML = htmlChecks;
    } catch (e) {
        containerTomb.innerHTML = "Erro ao carregar tombamentos.";
    }
}
	async function executarMovimentacaoReal(docId, operacao, dados) {
    const { destinoId, quantidade, tombamentos } = dados;
    const minhaUnidadeId = currentUserData.unidade_id;
    const dataHora = new Date().toLocaleString('pt-BR');
    
    // Mostra o loading do Sigma V3
    Swal.fire({
        title: 'Processando Movimentação...',
        html: 'Sincronizando inventário estadual.',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    const batch = db.batch();

    try {
        const itemRef = db.collection('inventario').doc(docId);
        const itemSnap = await itemRef.get();
        const itemData = itemSnap.data();
        const ehMulti = itemData.tipo === 'multi';

        // --- LÓGICA PARA ITENS MULTI (TOMBAMENTOS) ---
        if (ehMulti && tombamentos && tombamentos.length > 0) {
            for (const tomb of tombamentos) {
                const tombRef = itemRef.collection('tombamentos').doc(tomb);
                
                if (operacao === 'ENVIO') {
                    // SAINDO DO ALMOX -> PARA VIATURA
                    batch.update(tombRef, {
                        viatura_id: destinoId,
                        data_ultima_movimentacao: dataHora,
                        movimentado_por: currentUserData.nomeGuerra
                    });
                    // Registra no histórico do tombamento
                    const histRef = tombRef.collection('historico_vida').doc();
                    batch.set(histRef, {
                        evento: "ENVIO_PARA_VIATURA",
                        destino: destinoId,
                        data: dataHora,
                        quem: currentUserData.nomeGuerra
                    });
                } else {
                    // SAINDO DA VIATURA -> PARA ALMOX
                    batch.update(tombRef, {
                        viatura_id: null,
                        data_ultima_movimentacao: dataHora,
                        movimentado_por: currentUserData.nomeGuerra
                    });
                    // Registra no histórico do tombamento
                    const histRef = tombRef.collection('historico_vida').doc();
                    batch.set(histRef, {
                        evento: "RECOLHIMENTO_ALMOXARIFADO",
                        data: dataHora,
                        quem: currentUserData.nomeGuerra
                    });
                }
            }
        } 

        // --- LÓGICA PARA ITENS SINGLE (VOLUME/LOTE) ---
        else if (!ehMulti) {
            const qtdNum = Number(quantidade);
            const saldoRef = itemRef.collection('saldos_unidades').doc(minhaUnidadeId);

            if (operacao === 'ENVIO') {
                batch.update(saldoRef, {
                    qtd_disp: firebase.firestore.FieldValue.increment(-qtdNum),
                    qtd_em_carga: firebase.firestore.FieldValue.increment(qtdNum),
                    last_update: dataHora
                });
            } else {
                batch.update(saldoRef, {
                    qtd_disp: firebase.firestore.FieldValue.increment(qtdNum),
                    qtd_em_carga: firebase.firestore.FieldValue.increment(-qtdNum),
                    last_update: dataHora
                });
            }
        }

        // --- ATUALIZAÇÃO DA LISTA DE CONFERÊNCIA (O ALVO) ---
        // Aqui o sistema entra na viatura alvo e insere/remove o item da lista física
        await atualizarArquiteturaViatura(destinoId, itemData, operacao, dados);

        await batch.commit();

        Swal.fire({
            icon: 'success',
            title: 'Movimentação Concluída!',
            text: `${itemData.nome} movimentado com sucesso.`,
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
            // Recarrega a lupa/rastreio para mostrar a nova realidade
            if (typeof verDetalhesItemAlmox === 'function') verDetalhesItemAlmox(docId);
        });

    } catch (e) {
        console.error(e);
        Swal.fire('Erro Fatal', 'Não foi possível processar a movimentação no banco.', 'error');
    }
}
	async function atualizarArquiteturaViatura(viaturaId, itemData, operacao, dados) {
    const vtrRef = db.collection('listas_conferencia').doc(viaturaId);
    const vtrSnap = await vtrRef.get();

    if (!vtrSnap.exists) {
        console.error("Viatura não encontrada para sincronização de arquitetura.");
        return;
    }

    const vtrData = vtrSnap.data();
    let listaAtualizada = [...vtrData.list]; // A estrutura principal 'list' que contém os setores
    const setorAlvo = dados.setorId || 'CABINE'; // Default para Cabine se não especificado
    const ehMulti = itemData.tipo === 'multi';

    // 1. Localiza o setor e o item dentro da lista da viatura
    let setorEncontrado = listaAtualizada.find(s => s.nome === setorAlvo);
    
    // Se o setor não existir na vtr (ex: Carroceria), nós o criamos ou usamos o primeiro disponível
    if (!setorEncontrado) setorEncontrado = listaAtualizada[0];

    let itemNaVtr = setorEncontrado.itens.find(it => it.uid_global === itemData.uid_global);

    if (operacao === 'ENVIO') {
        if (!itemNaVtr) {
            // ITEM NOVO NA VIATURA: Se não existia, adicionamos a estrutura base
            itemNaVtr = {
                uid_global: itemData.uid_global,
                nome: itemData.nome,
                quantidadeEsperada: 0,
                tombamentos: [],
                tipo: itemData.tipo
            };
            setorEncontrado.itens.push(itemNaVtr);
        }

        if (ehMulti) {
            // Adiciona apenas os tombamentos que ainda não estão lá
            dados.tombamentos.forEach(t => {
                if (!itemNaVtr.tombamentos.includes(t)) {
                    itemNaVtr.tombamentos.push(t);
                }
            });
            itemNaVtr.quantidadeEsperada = itemNaVtr.tombamentos.length;
        } else {
            // Soma a quantidade ao que já existia
            itemNaVtr.quantidadeEsperada += Number(dados.quantidade);
        }
    } 
    else if (operacao === 'RECOLHIMENTO') {
        if (itemNaVtr) {
            if (ehMulti) {
                // Remove os tombamentos específicos recolhidos
                itemNaVtr.tombamentos = itemNaVtr.tombamentos.filter(t => !dados.tombamentos.includes(t));
                itemNaVtr.quantidadeEsperada = itemNaVtr.tombamentos.length;
            } else {
                // Subtrai a quantidade
                itemNaVtr.quantidadeEsperada -= Number(dados.quantidade);
            }

            // Se a quantidade zerar, removemos o item da viatura para não poluir a lista
            if (itemNaVtr.quantidadeEsperada <= 0) {
                setorEncontrado.itens = setorEncontrado.itens.filter(it => it.uid_global !== itemData.uid_global);
            }
        }
    }

    // 2. Grava a nova arquitetura de volta na viatura
    await vtrRef.update({
        list: listaAtualizada,
        ultima_atualizacao_inventario: new Date().toISOString()
    });
}	
/**
 * Função que renderiza os carimbos originais do Conferencia App dentro do modal
 */
function mostrarCarimbos(titulo, dataJson, tipo, listaId = null, nomeItemLimpo = "") {
    const dados = JSON.parse(dataJson);
    const modal = document.getElementById('modal-detalhe-carimbos');
    const corpo = document.getElementById('corpo-modal-carimbo');
    const h3 = document.getElementById('titulo-modal-carimbo');

    if (!modal || !corpo) return;

    h3.textContent = titulo;
    modal.querySelector('.modal-content').style.borderTop = tipo === 'cautela' ? '5px solid #f57c00' : '5px solid #d90f23';
    
    let html = '';
    dados.forEach(item => {
        if (tipo === 'cautela') {
            const cId = item.id;
            html += `
                <div style="border: 1px solid #eee; padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid #f57c00; background: #fffaf5;">
                    <div style="display:flex; justify-content:space-between; align-items: flex-start; margin-bottom:8px;">
                        <div>
                            <b style="font-size: 1.1em; color: #333;">${item.destinatario}</b><br>
                            <small style="color:#666;"><i class="far fa-calendar-alt"></i> Cautelado em: ${item.data || 'N/D'}</small>
                        </div>
                        <span class="badge-cautela" style="background:#f57c00; color:white; padding:4px 10px; border-radius:15px; font-weight:bold;">${item.quantidade || 1} un</span>
                    </div>
                    <div style="text-align: right; margin-top: 10px; border-top: 1px solid #ffe0b2; padding-top: 8px;">
                        <button class="btn-modern-action" style="font-size: 0.75em; padding: 5px 10px; background-color: #f57c00;" 
                                onclick="atalhoGestaoCautela('${cId}')">
                            <i class="fas fa-external-link-alt"></i> Ver Cautela
                        </button>
                    </div>
                </div>`;
        } else {
            // Pega o ID único da pendência para a busca cirúrgica
            const pId = item.id || item.pendencia_id; 

            html += `
                <div style="border: 1px solid #eee; padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid #d90f23; background: #fff5f5;">
                    <div style="display:flex; justify-content:space-between; align-items: flex-start; margin-bottom:8px;">
                        <div>
                            <b style="font-size: 1.1em; color: #333;">Relatado por: ${item.autor_nome}</b><br>
                            <small style="color:#666;"><i class="far fa-calendar-alt"></i> ${item.data_criacao || 'N/D'}</small>
                        </div>
                        <span class="badge-pendente" style="background:#d90f23; color:white; padding:4px 10px; border-radius:15px; font-weight:bold;">${item.quantidade || 1} un</span>
                    </div>
                    <div style="font-size:0.95em; color: #555; margin:8px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ffdada;">
                        <i class="fas fa-comment-dots"></i> "${item.descricao}"
                    </div>
                    <div style="text-align: right; margin-top: 10px; border-top: 1px solid #ffdada; padding-top: 8px;">
                        <button class="btn-modern-action" style="font-size: 0.75em; padding: 5px 10px; background-color: #d90f23;" 
                                onclick="atalhoGestaoPendencia('${listaId}', '${nomeItemLimpo}', '${pId}')">
                            <i class="fas fa-wrench"></i> Resolver na Viatura
                        </button>
                    </div>
                </div>`;
        }
    });

    corpo.innerHTML = html || '<p style="text-align:center; color:#999;">Nenhum registro detalhado encontrado.</p>';
    modal.style.display = 'flex';
}
/**
 * ATALHO 1: Direciona para a aba de Cautelas e abre o detalhe da cautela
 */
function atalhoGestaoCautela(cId) {
    document.getElementById('modal-detalhe-carimbos').style.display = 'none';
    switchView('cautelas');
    setTimeout(() => {
        showCautelaDetails(cId);
    }, 300);
}

/**
 * ATALHO 2: Simula o clique exato no card de pendência do Dashboard.
 */
async function atalhoGestaoPendencia(listaId, itemNomeAlvo) {
    if(!listaId) return alert("Erro: ID da lista não identificado.");
    
    document.getElementById('modal-detalhe-carimbos').style.display = 'none';
    switchView('dashboard');

    try {
        // 1. Busca a última conferência (O Cabeçalho)
        const snap = await db.collection(COLECAO_RESULTADOS)
                             .where('lista_id', '==', listaId)
                             .orderBy('timestamp', 'desc')
                             .limit(1)
                             .get();

        if(!snap.empty) {
            const docReal = snap.docs[0];
            const d = docReal.data();
            
            // 2. Prepara o objeto exatamente como a sua função mostrarTabela espera
            // Note que usamos d.timestamp.toDate().toLocaleString() para evitar o 'undefined'
            const objetoParaTabela = {
                id: docReal.id,
                lista_id: listaId,
                local: d.local || "Viatura",
                conferente: d.conferente,
                date: d.timestamp ? d.timestamp.toDate().toLocaleString('pt-BR') : 'Data N/D',
                items: [] // Vamos preencher abaixo
            };

            // 3. Busca a Lista Mestra para extrair as Pendências/Cautelas Reais
            // Esse é o segredo para não aparecer "Tudo OK"
            const docMestra = await db.collection('listas_conferencia').doc(listaId).get();
            if (docMestra.exists) {
                const dataMestra = docMestra.data().list || [];
                const pendenciasReais = [];

                for (const setor of dataMestra) {
                    for (const it of (setor.itens || [])) {
                        // Pendências Single
                        if (it.pendencias_ids) {
                            it.pendencias_ids.forEach(p => pendenciasReais.push({ ...p, itemNome: it.nome, itemId: it.id, tipoRegistro: 'PENDENCIA' }));
                        }
                        // Cautelas Single
                        if (it.cautelas) {
                            it.cautelas.forEach(c => pendenciasReais.push({ ...c, itemNome: it.nome, itemId: it.id, status_gestao: 'CAUTELADO', tipoRegistro: 'CAUTELA' }));
                        }
                        // Itens Multi (Tombamentos)
                        if (it.tipo === 'multi' && it.tombamentos) {
                            it.tombamentos.forEach(t => {
                                if (t.pendencias_ids) t.pendencias_ids.forEach(p => pendenciasReais.push({ ...p, itemNome: it.nome, tombamento: t.tomb, itemId: it.id, tipoRegistro: 'PENDENCIA' }));
                                if (t.cautela) pendenciasReais.push({ ...t.cautela, itemNome: it.nome, tombamento: t.tomb, itemId: it.id, status_gestao: 'CAUTELADO', tipoRegistro: 'CAUTELA' });
                            });
                        }
                    }
                }
                objetoParaTabela.items = pendenciasReais;
            }

            // 4. Agora sim, chama a função com os dados completos e processados
            setTimeout(() => {
                mostrarTabela(objetoParaTabela);
                
                // 5. Aponta o item alvo
                setTimeout(() => {
                    destacarItemNaTabela(itemNomeAlvo);
                }, 600);
            }, 300);
        }
    } catch (e) {
        console.error("Erro no atalho:", e);
    }
}
/**
 * Localiza o item na tabela, com sistema de espera (polling) 
 * para garantir que a renderização terminou.
 */
function destacarItemNaTabela(nomeItem, pendenciaId) {
    let tentativas = 0;
    const alvoNome = nomeItem ? nomeItem.trim().toUpperCase() : null;

    const intervalBusca = setInterval(() => {
        const rows = document.querySelectorAll('#ca-list-body tr');
        let linhaEncontrada = null;

        rows.forEach(row => {
            if (linhaEncontrada) return; // Se já achou, ignora o resto

            // 1. PRIORIDADE MÁXIMA: Busca pelo ID da Pendência em qualquer lugar da linha
            if (pendenciaId) {
                // Procura o ID no HTML da linha toda (botões, inputs hidden, textos)
                if (row.innerHTML.includes(pendenciaId)) {
                    linhaEncontrada = row;
                }
            } 
            
            // 2. SEGUNDA PRIORIDADE: Busca por Nome + Texto "PENDENTE" 
            // Isso evita focar no item "CAUTELADO" se o objetivo é resolver pendência
            if (!linhaEncontrada && alvoNome) {
                const textoLinha = row.innerText.toUpperCase();
                // Verifica se na mesma linha tem o Nome do Item E a palavra PENDENTE
                if (textoLinha.includes(alvoNome) && textoLinha.includes("PENDENTE")) {
                    linhaEncontrada = row;
                }
            }
        });

        if (linhaEncontrada) {
            clearInterval(intervalBusca);
            
            // Centraliza e destaca
            linhaEncontrada.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Estilo visual de impacto
            linhaEncontrada.style.backgroundColor = "#fff3cd";
            linhaEncontrada.style.outline = "3px solid #d90f23"; // Vermelho para pendência
            
            linhaEncontrada.animate([
                { transform: 'scale(1)', boxShadow: 'none' },
                { transform: 'scale(1.01)', boxShadow: '0 0 20px #d90f23' },
                { transform: 'scale(1)', boxShadow: 'none' }
            ], { duration: 400, iterations: 5 });

            setTimeout(() => {
                linhaEncontrada.style.backgroundColor = "";
                linhaEncontrada.style.outline = "none";
            }, 6000);

        } else if (tentativas >= 25) {
            clearInterval(intervalBusca);
            console.warn("Destaque: Falha ao localizar o item alvo.");
        }
        
        tentativas++;
    }, 200);
}
		
function abrirModalCadastroGlobal() {
    const modal = document.getElementById('modal-cadastro-global');
    if (!modal) return;
    
    // Reseta o formulário para garantir que abra limpo
    document.getElementById('form-cadastro-global').reset();
    
    // Oculta área de kit por padrão
    document.getElementById('area-selecao-componentes').style.display = 'none';
    
    // Inicia na aba de identificação
    switchTabCadastro('identificacao');
    
    modal.style.display = 'flex';
}

/**
 * Fecha o modal
 */
function fecharModalCadastroGlobal() {
    const modal = document.getElementById('modal-cadastro-global');
    if (modal) modal.style.display = 'none';
}

/**
 * Alterna entre as abas usando Namespacing para segurança
 */
function switchTabCadastro(tabId) {
    // 1. Gerencia os botões (Abas)
    const botoes = document.querySelectorAll('.g-cat-tab-btn');
    botoes.forEach(btn => btn.classList.remove('active'));

    // 2. Gerencia os conteúdos
    const conteudos = document.querySelectorAll('.g-cat-tab-content');
    conteudos.forEach(div => div.style.display = 'none');

    // 3. Ativa o selecionado
    if (tabId === 'identificacao') {
        botoes[0].classList.add('active');
        document.getElementById('tab-identificacao').style.display = 'block';
    } else if (tabId === 'logistica') {
        botoes[1].classList.add('active');
        document.getElementById('tab-logistica').style.display = 'block';
    } else if (tabId === 'composicao') {
        botoes[2].classList.add('active');
        document.getElementById('tab-composicao').style.display = 'block';
    }
}

/**
 * Listener para o Checkbox de Kit (Exibição Dinâmica)
 * Usamos a delegação de eventos para garantir que funcione mesmo após renderizações
 */
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'cat-is-kit') {
        const areaKit = document.getElementById('area-selecao-componentes');
        if (areaKit) {
            areaKit.style.display = e.target.checked ? 'block' : 'none';
        }
    }
});
	/**
 * 1. AUTOCOMPLETE: Busca em tempo real no Catálogo Global
 * Acoplado ao campo 'cat-nome-tecnico' do modal
 */
async function buscarInteligenteFamilia(termo) {
    const listUI = document.getElementById('list-suggestions-familia');
    const boxUI = document.getElementById('suggestions-familia');
    const uidPaiInput = document.getElementById('cat-uid-pai');

    if (termo.length < 2) {
        boxUI.style.display = 'none';
        return;
    }

    try {
        const termoUpper = termo.toUpperCase();
        // Busca famílias que tenham o nome ou marcas vinculadas
        const snap = await db.collection('catalogo_familias')
            .where('tags_busca', 'array-contains', termoUpper)
            .limit(5).get();

        if (snap.empty) {
            boxUI.style.display = 'none';
            uidPaiInput.value = ''; // Se não achou, limpa o ID para criar novo
            return;
        }

        let html = '';
        snap.forEach(doc => {
            const fam = doc.data();
            html += `<li onclick="selecionarFamilia('${doc.id}', '${fam.nome_pai}')" style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;">
                        <i class="fas fa-folder"></i> Família: <b>${fam.nome_pai}</b>
                     </li>`;
        });

        listUI.innerHTML = html;
        boxUI.style.display = 'block';
    } catch (e) { console.error(e); }
}

function selecionarFamilia(uid, nome) {
    document.getElementById('cat-nome-pai').value = nome;
    document.getElementById('cat-uid-pai').value = uid;
    document.getElementById('suggestions-familia').style.display = 'none';
    document.getElementById('cat-nome-pai').style.borderColor = '#1b8a3e';
}

/**
 * 2. SELEÇÃO: Preenche e trava o formulário se o item já existe
 */
async function selecionarItemDoCatalogo(uid) {
    const doc = await db.collection('catalogo_global').doc(uid).get();
    if (!doc.exists) return;

    const data = doc.data();
    document.getElementById('cat-nome-tecnico').value = data.nome_tecnico;
    document.getElementById('cat-categoria').value = data.categoria;
    
    // Marca o rádio button correto (Single ou Multi)
    document.querySelector(`input[name="cat-tipo"][value="${data.tipo_controle}"]`).checked = true;

    // Se não for ADMIN, trava os campos para evitar duplicidade de DNA
    if (currentUserData.role !== 'admin') {
        document.getElementById('cat-nome-tecnico').readOnly = true;
        document.getElementById('cat-categoria').disabled = true;
        document.querySelectorAll('input[name="cat-tipo"]').forEach(r => r.disabled = true);
        
        const btnSalvar = document.querySelector('.btn-sync');
        btnSalvar.innerHTML = `<i class="fas fa-check-circle"></i> Habilitar no meu Almoxarifado`;
    }

    document.getElementById('cautela-suggestions-box').style.display = 'none';
}

/**
 * 3. SALVAMENTO: Cria o DNA (Global) e o Saldo (Local)
 */
async function salvarCadastroGlobalHierarquico() {
    const nomePai = document.getElementById('cat-nome-pai').value.trim().toUpperCase();
    const marca = document.getElementById('cat-marca').value.trim().toUpperCase();
    const modelo = document.getElementById('cat-modelo').value.trim().toUpperCase();
    const categoria = document.getElementById('cat-categoria').value;
    const tipoControle = document.querySelector('input[name="cat-tipo"]:checked').value;
    let uidPai = document.getElementById('cat-uid-pai').value;

    if (!nomePai || !marca || !modelo) return alert("Preencha os campos obrigatórios.");

    const btn = document.querySelector('.btn-sync');
    const originalText = btn.innerHTML;
    btn.disabled = true; 
    btn.textContent = "Processando DNA...";

    const autorNome = currentUserData.nome_militar_completo;
    // ✅ CAPTURA A UNIDADE DO CRIADOR DINAMICAMENTE
    const unidadeCriadorId = currentUserData.unidade_id || "ADMIN"; 
    const unidadeCriadorSigla = currentUserData.unidade || "ADMINISTRATIVO";
    const dataRegistro = new Date().toLocaleString('pt-BR');

    try {
        await db.runTransaction(async (transaction) => {
            const contRef = db.collection('config_geral').doc('contadores');
            const contSnap = await transaction.get(contRef);
            const contData = contSnap.data() || { ultimo_id_pai: 0, ultimo_id_modelo: 0 };

            // 1. GERENCIAR UID PAI (FAMÍLIA)
            if (!uidPai) {
                const proximoPai = (contData.ultimo_id_pai || 0) + 1;
                uidPai = `FAM-${String(proximoPai).padStart(6, '0')}`;
                
                transaction.set(db.collection('catalogo_familias').doc(uidPai), {
                    uid_pai: uidPai,
                    nome_pai: nomePai,
                    tags_busca: [nomePai],
                    criado_em: firebase.firestore.FieldValue.serverTimestamp()
                });
                transaction.update(contRef, { ultimo_id_pai: proximoPai });
            }

            // 2. GERENCIAR UID GLOBAL (MODELO TÉCNICO)
            const proximoMod = (contData.ultimo_id_modelo || 0) + 1;
            const uidGlobal = `${uidPai}-MOD-${proximoMod}`;
            const nomeTecnicoCompleto = `${nomePai} ${marca} ${modelo}`;

            // 3. SALVAR NO CATÁLOGO GLOBAL (DNA)
            transaction.set(db.collection('catalogo_global').doc(uidGlobal), {
                uid_global: uidGlobal,
                uid_pai: uidPai,
                nome_pai: nomePai,
                nome_tecnico: nomeTecnicoCompleto,
                marca: marca,
                modelo: modelo,
                categoria: categoria,
                tipo_controle: tipoControle,
                criado_por: autorNome,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // 4. ATUALIZAR TAGS DA FAMÍLIA E CONTADOR
            transaction.update(db.collection('catalogo_familias').doc(uidPai), {
                tags_busca: firebase.firestore.FieldValue.arrayUnion(marca, modelo)
            });
            transaction.update(contRef, { ultimo_id_modelo: proximoMod });

            // 5. INICIALIZAR NO INVENTÁRIO COM VÍNCULO DE UNIDADE
            const invRef = db.collection('inventario').doc(uidGlobal);
            transaction.set(invRef, {
                uid_global: uidGlobal,
                nome: nomeTecnicoCompleto,
                tipo: tipoControle,
                categoria: categoria,
                qtd_corporativa_total: 0,
                criado_em: dataRegistro,
                criado_por: autorNome,
                unidade_origem_id: unidadeCriadorId // ✅ Rastro de quem criou
            });

            // ✅ SE FOR SINGLE, JÁ CRIA O DOCUMENTO DE SALDO NA UNIDADE DO CRIADOR
            if (tipoControle === 'single') {
                const saldoRef = invRef.collection('saldos_unidades').doc(unidadeCriadorId);
                transaction.set(saldoRef, {
                    unidade_sigla: unidadeCriadorSigla,
                    qtd_total: 0,
                    qtd_disp: 0,
                    qtd_em_carga: 0,
                    qtd_pend: 0,
                    qtd_caut: 0,
                    last_update: dataRegistro
                });
            }
            // Itens Multi não precisam de doc prévio, o local_id irá no tombamento no Teste 2.
        });

        alert(`✅ Cadastro Global realizado!\nItem vinculado à unidade ${unidadeCriadorSigla}.`);
        fecharModalCadastroGlobal();
        if (typeof carregarAlmoxarifadoUI === 'function') carregarAlmoxarifadoUI();

    } catch (e) {
        console.error("Erro na transação:", e);
        alert("Erro ao salvar: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
		
		async function prepararAporte(docId) {
    // 1. Busca os dados do item no Inventário V3
    const docAlvo = await db.collection('inventario').doc(docId).get();
    if (!docAlvo.exists) return alert("Erro ao localizar material.");
    
    const item = docAlvo.data();
    const ehMulti = item.tipo === 'multi';

    // 2. Lança o Modal Elegante
    Swal.fire({
        title: `<i class="fas fa-plus-circle"></i> Aporte de Material`,
        html: `
            <div style="text-align: left; padding: 5px;">
                <div style="background: #f0fdf4; padding: 12px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #bbf7d0;">
                    <small style="color: #166534; font-weight: 800; text-transform: uppercase; font-size: 0.7em;">Material Selecionado</small>
                    <div style="font-weight: 800; color: #14532d; font-size: 1.1em;">${item.nome}</div>
                    <small style="color: #166534; font-size: 0.75em;">DNA: ${item.tipo.toUpperCase()} • ${item.categoria}</small>
                </div>

                <div class="form-group">
                    <label style="font-size: 0.85em; font-weight:bold; color:#800020;">QUANTIDADE DE ENTRADA:</label>
                    <input type="number" id="swal-aporte-qtd" class="swal2-input" value="1" min="1" 
                           style="width: 100%; margin: 10px 0;"
                           oninput="gerarInputsTombamentoDinamico(this.value, '${item.tipo}')">
                </div>

                <div id="div-tombamentos-dinamicos" style="display: ${ehMulti ? 'block' : 'none'}; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px dashed #2c7399;">
                    <label style="font-weight: bold; color: #2c7399; font-size: 0.85em; display: block; margin-bottom: 10px;">
                        <i class="fas fa-barcode"></i> Identificação dos Itens (Tomb / Série):
                    </label>
                    <div id="container-inputs-tomb" style="max-height: 200px; overflow-y: auto;">
                        </div>
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label style="font-size: 0.85em; font-weight:bold; color:#800020;">JUSTIFICATIVA / NOTA FISCAL:</label>
                    <textarea id="swal-aporte-obs" class="swal2-textarea" style="width: 100%; margin: 10px 0; height: 80px;" placeholder="Ex: NF 455 - Compra Direta..."></textarea>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-check"></i> CONFIRMAR ENTRADA',
        confirmButtonColor: '#166534',
        cancelButtonText: 'Cancelar',
        didOpen: () => {
            // Inicializa os inputs se for multi
            if (ehMulti) gerarInputsTombamentoDinamico(1, 'multi');
        },
        preConfirm: () => {
            const qtd = document.getElementById('swal-aporte-qtd').value;
            const obs = document.getElementById('swal-aporte-obs').value.trim();
            
            if (!qtd || qtd < 1) return Swal.showValidationMessage('Informe uma quantidade válida');
            if (!obs) return Swal.showValidationMessage('A justificativa é obrigatória');

            let tombamentos = [];
            if (ehMulti) {
                const linhas = document.querySelectorAll('.linha-tomb-input');
                for (let linha of linhas) {
                    const t = linha.querySelector('.val-tomb').value.trim().toUpperCase();
                    const s = linha.querySelector('.val-sn').value.trim().toUpperCase();
                    if (!t) return Swal.showValidationMessage('Preencha todos os tombamentos');
                    tombamentos.push({ tomb: t, serie: s });
                }
            }

            return {
                quantidade: parseInt(qtd),
                observacao: obs,
                tombamentos: ehMulti ? tombamentos : null
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Chama a função que já temos de gravar no banco, passando os novos dados
            processarAporteNoBanco(docId, result.value);
        }
    });
}
	function gerarInputsTombamentoDinamico(qtd, tipo) {
    const containerDiv = document.getElementById('div-tombamentos-dinamicos');
    const lista = document.getElementById('container-inputs-tomb');
    
    if (tipo !== 'multi') {
        if(containerDiv) containerDiv.style.display = 'none';
        return;
    }

    containerDiv.style.display = 'block';
    lista.innerHTML = '';
    
    for (let i = 1; i <= qtd; i++) {
        lista.innerHTML += `
            <div class="linha-tomb-input" style="display: grid; grid-template-columns: 30px 1fr 1fr; gap: 8px; margin-bottom: 8px; align-items: center;">
                <div style="background: #166534; color: white; text-align: center; border-radius: 4px; font-size: 0.8em; height: 30px; line-height: 30px;">${i}</div>
                <input type="text" class="swal2-input val-tomb" placeholder="Tombamento" style="margin:0; height: 35px; font-size: 0.9em;">
                <input type="text" class="swal2-input val-sn" placeholder="Nº Série" style="margin:0; height: 35px; font-size: 0.9em;">
            </div>`;
    }
}	

async function processarAporteNoBanco(uidGlobal, dados) {
    const { quantidade, observacao, tombamentos } = dados;
    const ehMulti = tombamentos !== null;
    
    const minhaUnidadeId = currentUserData.unidade_id || "ADMIN";
    const minhaUnidadeSigla = currentUserData.unidade || "ADMINISTRATIVO";
    const dataReg = new Date().toLocaleString('pt-BR');
    const autorNome = currentUserData.nome_militar_completo;

    // Feedback visual Sigma V3
    Swal.fire({
        title: 'Registrando Entrada...',
        html: 'Atualizando prontuários e saldos globais.',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const itemRef = db.collection('inventario').doc(uidGlobal);
        
        await db.runTransaction(async (transaction) => {
            const snapItem = await transaction.get(itemRef);
            if (!snapItem.exists) throw new Error("DNA do material não encontrado.");
            
            const d = snapItem.data();
            const idEvento = "EVT-APORTE-" + Date.now();
            let qtdEfetiva = 0;

            if (ehMulti) {
                let listaTombsTxt = [];
                
                for (let tInfo of tombamentos) {
                    qtdEfetiva++;
                    listaTombsTxt.push(tInfo.tomb);
                    const tombRef = itemRef.collection('tombamentos').doc(tInfo.tomb);
                    
                    // Registro no Prontuário Individual (RG do Ativo)
                    transaction.set(tombRef, {
                        tomb: tInfo.tomb, 
                        serie: tInfo.serie || "N/A", 
                        situacao_atual: "DISPONÍVEL",
                        local_id: minhaUnidadeId, 
                        unidade_sigla: minhaUnidadeSigla,
                        sub_local: "ALMOXARIFADO CENTRAL", 
                        data_entrada: dataReg, 
                        criado_por: autorNome
                    });

                    // Log individual do item
                    transaction.set(tombRef.collection('historico_vida').doc(idEvento), {
                        data: dataReg, 
                        evento: "APORTE_ESTOQUE", 
                        quem: autorNome,
                        detalhes: `Incorporado via Aporte. Justificativa: ${observacao}`
                    });
                }

                // Log no Documento Pai (Linha do tempo global)
                transaction.update(itemRef, {
                    historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion({
                        data: dataReg,
                        evento: "APORTE_LOTE_PATRIMONIO",
                        quem: autorNome,
                        detalhes: `Aporte de ${qtdEfetiva} unidades em ${minhaUnidadeSigla}. Itens: ${listaTombsTxt.join(', ')}. Obs: ${observacao}`
                    })
                });

            } else {
                // LÓGICA SINGLE: Atualiza saldo da unidade
                qtdEfetiva = quantidade;
                const saldoUnidadeRef = itemRef.collection('saldos_unidades').doc(minhaUnidadeId);
                const snapSaldo = await transaction.get(saldoUnidadeRef);
                const dSaldo = snapSaldo.exists ? snapSaldo.data() : { qtd_total: 0, qtd_disp: 0 };

                transaction.set(saldoUnidadeRef, {
                    unidade_sigla: minhaUnidadeSigla,
                    qtd_total: (dSaldo.qtd_total || 0) + qtdEfetiva,
                    qtd_disp: (dSaldo.qtd_disp || 0) + qtdEfetiva,
                    last_update: dataReg
                }, { merge: true });

                // Log no histórico de saldo da unidade
                transaction.set(saldoUnidadeRef.collection('historico_vida').doc(idEvento), {
                    data: dataReg, 
                    evento: "APORTE_ESTOQUE", 
                    quem: autorNome,
                    quantidade: qtdEfetiva,
                    detalhes: `Entrada física de material de consumo. Obs: ${observacao}`
                });
            }

            // Atualiza o consolidado corporativo (Total de todas as unidades)
            transaction.update(itemRef, {
                qtd_corporativa_total: (d.qtd_corporativa_total || 0) + qtdEfetiva,
                ultima_movimentacao: dataReg
            });
        });

        // Sucesso
        await Swal.fire({
            icon: 'success',
            title: 'Aporte Concluído!',
            text: `${qtdEfetiva} unidade(s) adicionada(s) ao estoque de ${minhaUnidadeSigla}.`,
            timer: 2500,
            showConfirmButton: false
        });

        if (typeof carregarAlmoxarifadoUI === 'function') carregarAlmoxarifadoUI();

    } catch (e) {
        console.error("Erro no aporte:", e);
        Swal.fire('Erro no Processamento', e.message, 'error');
    }
}
		
		async function configurarBuscaComandanteUnidade() {
    const input = document.getElementById('new-unit-commander-search');
    const suggestionsBox = document.getElementById('unit-commander-suggestions');
    const suggestionsList = document.getElementById('unit-commander-list');
    const uidInput = document.getElementById('new-unit-commander-uid');

    if (!input) return;

    // Garante que temos militares carregados para a busca global
    // Se o array global allTargetUsers estiver vazio, buscamos todos os militares do banco
    if (typeof allTargetUsers === 'undefined' || allTargetUsers.length === 0) {
        console.log("Populando lista global de militares para seleção de comando...");
        const snap = await db.collection('usuarios').get();
        allTargetUsers = [];
        snap.forEach(doc => {
            const u = doc.data();
            allTargetUsers.push({
                id: doc.id,
                nome: u.nome_militar_completo || u.nome_completo
            });
        });
    }

    input.addEventListener('input', () => {
        const termo = input.value.toUpperCase();
        suggestionsList.innerHTML = '';

        if (termo.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const filtrados = allTargetUsers.filter(u => 
            u.nome.toUpperCase().includes(termo)
        );

        filtrados.forEach(militar => {
            const li = document.createElement('li');
            li.style.padding = "10px";
            li.style.cursor = "pointer";
            li.style.borderBottom = "1px solid #eee";
            li.innerHTML = `<i class="fas fa-user-shield"></i> ${militar.nome}`;
            
            li.onclick = () => {
                input.value = militar.nome;
                uidInput.value = militar.id; // Salva o UID imutável (ex: 8snxsQcrahT4...)
                suggestionsBox.style.display = 'none';
                input.style.borderColor = '#1b8a3e';
                console.log("Comandante selecionado:", militar.id);
            };
            suggestionsList.appendChild(li);
        });

        suggestionsBox.style.display = filtrados.length > 0 ? 'block' : 'none';
    });

    // Fecha a lista se clicar fora
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target)) suggestionsBox.style.display = 'none';
    });
}
	
		function filtrarUnidadesCards() {
    // Captura o termo e normaliza (remove acentos e caracteres especiais para busca precisa)
    const inputBusca = document.getElementById('input-busca-unidade');
    if (!inputBusca) return;
    
    const termo = inputBusca.value.trim().toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos
        .replace(/[^a-z0-9]/g, ""); // Mantém apenas letras e números

    // Seleciona os cards padrão V3 dentro do container de unidades
    const cards = document.querySelectorAll('#units-cards-container .v3-posto-card');
    const headers = document.querySelectorAll('#units-cards-container .unit-header');

    cards.forEach(card => {
        // Captura o conteúdo do card e normaliza para comparação
        const textoCard = card.innerText.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]/g, "");

        const matches = textoCard.includes(termo);

        if (matches) {
            card.style.display = "flex";
            card.style.animation = "fadeIn 0.3s ease";
        } else {
            card.style.display = "none";
        }
    });

    // Filtra os títulos de grupo (Headers), escondendo se o grupo estiver vazio
    headers.forEach(header => {
        let proximo = header.nextElementSibling;
        let temVisivel = false;

        // Varre os elementos seguintes até o próximo header ou fim do container
        while (proximo && !proximo.classList.contains('unit-header')) {
            if (proximo.classList.contains('v3-posto-card') && proximo.style.display !== 'none') {
                temVisivel = true;
                break;
            }
            proximo = proximo.nextElementSibling;
        }
        
        header.style.display = temVisivel ? "block" : "none";
    });
}
		/*[GESTÃO DE VIATURAS/BASE*/


		async function carregarVtrBasesCards() {
    const container = document.getElementById('vtr-bases-cards-container');
    if (!container) return;

    container.innerHTML = `
        <div style="grid-column: 1/-1; text-align:center; padding:60px; color:#64748b;">
            <i class="fas fa-sync fa-spin fa-3x" style="opacity:0.3; margin-bottom:15px; display:block;"></i>
            <span style="font-weight:700; letter-spacing:1px; text-transform:uppercase; font-size:0.8em;">Sincronizando Frota Global...</span>
        </div>`;

    try {
        const snapshot = await db.collection('viaturas').orderBy('prefixo', 'asc').get();

        if (snapshot.empty) {
            container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#94a3b8;">Nenhuma viatura cadastrada no sistema.</div>`;
            return;
        }

        let html = '';

        snapshot.forEach(doc => {
            const vtr = doc.data();
            const status = vtr.status_operativo || 'ativo';
            const statusLabel = status === 'ativo' ? 'PRONTO' : (status === 'manutencao' ? 'BAIXADO' : 'RESERVA');
            const statusClass = status === 'ativo' ? 'v3-status-pronto' : 'v3-status-manutencao';
            
            const podeEditarOuExcluir = ['admin', 'gestor_geral'].includes(currentUserData?.role);
            const corTema = status === 'ativo' ? '#166534' : (status === 'manutencao' ? '#991b1b' : '#c2780e');

            const iconMap = { 
                incendio: 'fa-truck-moving', 
                ambulancia: 'fa-solid fa-truck-medical', 
                salvamento: 'fa-solid fa-truck-pickup', 
                passeio: 'fa-solid fa-car-side' 
            };
            const iconClass = iconMap[vtr.segmento] || 'fa-solid fa-car';
            const modeloLimpo = (vtr.modelo || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');

            // ✅ ADICIONADO: Evento onclick="abrirModalDetalhesVtr(...)" no card principal
            html += `
                <div class="v3-posto-card" 
                     onclick="abrirModalDetalhesVtr('${vtr.unidade_id}', '${doc.id}')"
                     style="border-left: 6px solid ${corTema}; min-height: 220px; cursor: pointer;">
                    
                    <div class="v3-posto-actions">
                        ${podeEditarOuExcluir ? `
                            <button class="v3-btn-action" onclick="event.stopPropagation(); abrirFormularioViatura({ 
                                uid: '${doc.id}', 
                                prefixo: '${vtr.prefixo}', 
                                placa: '${vtr.placa}', 
                                unidade_id: '${vtr.unidade_id}',
                                segmento: '${vtr.segmento}',
                                status: '${status}',
                                modelo: '${modeloLimpo}',
                                ano: '${vtr.ano}',
                                km_atual: ${vtr.km_atual || 0},
                                oleo_data: '${vtr.manutencao?.oleo_data || ''}',
                                oleo_km: ${vtr.manutencao?.oleo_km_prevista || 0}
                            })">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="v3-btn-action" onclick="event.stopPropagation(); deletarViaturaGlobal('${doc.id}', '${vtr.prefixo}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        ` : `<i class="fas fa-lock" style="color:#cbd5e1; font-size: 0.8em; margin: 5px;"></i>`}
                    </div>

                    <div style="padding: 20px; flex-grow: 1; display: flex; flex-direction: column; align-items: center; text-align: center;">
                        
                        <div class="v3-icon-box" style="background: ${corTema}15; color: ${corTema}; width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                            <i class="${iconClass}" style="font-size: 1.8em;"></i>
                        </div>

                        <div style="width: 100%; margin-bottom: 10px;">
                            <span style="display:block; font-weight:900; font-size:1.3em; color:#1e293b; letter-spacing:-0.5px; margin-bottom: 2px;">${vtr.prefixo}</span>
                            <span style="display:block; font-size: 0.75em; font-weight: 800; color: #64748b; text-transform: uppercase;">${vtr.modelo} | ${vtr.placa}</span>
                        </div>

                        <div style="width: 100%; margin-top: auto;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                                <span class="v3-vtr-badge ${statusClass}">${statusLabel}</span>
                                <span style="font-weight: 900; color: #2c7399; font-size: 0.75em;">${vtr.unidade_sigla || 'ADMIN'}</span>
                            </div>
                            
                            <div class="v3-vtr-km-info">
                                <div style="text-align: left;">
                                    <small style="display:block; font-size:0.6em; color:#94a3b8; font-weight:800; text-transform:uppercase;">KM Atual</small>
                                    <span style="font-size:0.85em; font-weight:900; color:#1e293b;">${Number(vtr.km_atual || 0).toLocaleString('pt-BR')} km</span>
                                </div>
                                <div style="text-align: right;">
                                    <small style="display:block; font-size:0.6em; color:#94a3b8; font-weight:800; text-transform:uppercase;">Próx. Óleo</small>
                                    <span style="font-size:0.85em; font-weight:900; color:#c2780e;">${Number(vtr.manutencao?.oleo_km_prevista || 0).toLocaleString('pt-BR')} km</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        });

        container.innerHTML = html;

        // Gatilho para processar ícones se usar FontAwesome JS
        if (window.FontAwesome) FontAwesome.dom.i2svg();

    } catch (e) {
        console.error("Erro ao carregar frota:", e);
        container.innerHTML = `<p style="color:red; text-align:center; padding:40px;">Erro técnico ao carregar frota global.</p>`;
    }
}
		async function deletarViaturaGlobal(uid, prefixo) {
    // 1. Confirmação Estilizada
    const confirmacao = await Swal.fire({
        title: 'Excluir Viatura?',
        html: `Você está removendo o ativo <b>${prefixo}</b> do sistema.<br>Esta ação é irreversível.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#991b1b', // Vermelho Escuro
        cancelButtonColor: '#64748b',
        confirmButtonText: 'SIM, REMOVER',
        cancelButtonText: 'CANCELAR',
        reverseButtons: true
    });

    if (!confirmacao.isConfirmed) return;

    // Feedback de processamento
    Swal.fire({
        title: 'Removendo Ativo...',
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        // 2. Remoção no Firestore
        await db.collection('viaturas').doc(uid).delete();

        // 3. Efeito Visual de Desintegração V3
        const cards = document.querySelectorAll('.v3-posto-card');
        cards.forEach(card => {
            if (card.innerHTML.includes(uid) || card.innerText.includes(prefixo)) {
                card.style.transition = "all 0.6s cubic-bezier(0.4, 0, 0.2, 1)";
                card.style.opacity = "0";
                card.style.transform = "scale(0.8) translateY(20px)";
                card.style.filter = "blur(10px)";
                
                setTimeout(() => {
                    card.remove();
                    // Se não sobrarem cards, recarrega para mostrar a mensagem de lista vazia
                    if (document.querySelectorAll('#vtr-bases-cards-container .v3-posto-card').length === 0) {
                        carregarVtrBasesCards();
                    }
                }, 600);
            }
        });

        // 4. Toast de Sucesso
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
        });
        Toast.fire({ icon: 'success', title: 'Viatura removida da frota.' });

    } catch (e) {
        console.error("Erro ao excluir viatura:", e);
        Swal.fire('Erro', 'Não foi possível excluir o ativo. Verifique sua conexão.', 'error');
    }
}
		function filtrarViaturasCards() {
    const termo = document.getElementById('input-busca-vtr').value.trim().toLowerCase().replace(/[^A-Z0-9]/gi, '');
    const statusFiltro = document.getElementById('filtro-vtr-status').value;
    const cards = document.querySelectorAll('#vtr-bases-cards-container .v3-posto-card');

    cards.forEach(card => {
        // Captura o texto do card para busca
        const textoCard = card.innerText.toLowerCase().replace(/[^A-Z0-9]/gi, '');
        
        // Captura o status do card através da classe de badge
        const badge = card.querySelector('.v3-vtr-badge');
        const statusCard = badge.classList.contains('v3-status-pronto') ? 'ativo' : 
                           (badge.innerText.includes('BAIXADO') ? 'manutencao' : 'reserva');

        const bateTexto = textoCard.includes(termo);
        const bateStatus = (statusFiltro === 'todos' || statusCard === statusFiltro);

        if (bateTexto && bateStatus) {
            card.style.display = "flex";
            card.style.animation = "fadeIn 0.3s ease";
        } else {
            card.style.display = "none";
        }
    });
}

// 🛑 Adicione esta função auxiliar para deletar da coleção GLOBAL
async function deletarAtivoGlobal(ativoUid, nomeIdentificador) {
    if (!confirm(`Deseja realmente remover a viatura "${nomeIdentificador}" do sistema global?`)) return;
    try {
        await db.collection('viaturas').doc(ativoUid).delete();
        alert("Viatura removida com sucesso!");
        carregarVtrBasesCards();
    } catch (e) {
        alert("Erro ao excluir viatura.");
    }
}
		
		function fecharModalVtr() {
    // 1. Comando oficial para fechar modais do SweetAlert2
    if (typeof Swal !== 'undefined' && Swal.isVisible()) {
        Swal.close();
    }
    
    // 2. Segurança: Tenta fechar o elemento antigo apenas se ele ainda existir no DOM
    const modalLegado = document.getElementById('modal-detalhes-vtr');
    if (modalLegado) {
        modalLegado.style.display = 'none';
    }
}

async function abrirModalDetalhesVtr(unidadeUid, ativoUid) {
    Swal.fire({
        title: 'Acessando Prontuário...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    try {
        const doc = await db.collection('viaturas').doc(ativoUid).get();
        if (!doc.exists) throw new Error("Viatura não localizada.");

        const vtr = doc.data();
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        // --- LÓGICA DE SEMÁFOROS (Cores Dinâmicas) ---
        
        // 1. Licenciamento
        let anoExercicio = vtr.licenciamento ? parseInt(vtr.licenciamento.toString().substring(0, 4)) : null;
        let licStatus = "N/D", licColor = "#94a3b8", licBg = "#f1f5f9";
        if (anoExercicio) {
            const isVencido = anoExercicio < hoje.getFullYear();
            licStatus = isVencido ? 'VENCIDO' : 'EM DIA';
            licColor = isVencido ? '#991b1b' : '#166534';
            licBg = isVencido ? '#fef2f2' : '#dcfce7';
        }

        // 2. Troca de Óleo
        const kmPrevisto = vtr.manutencao?.oleo_km_prevista || 0;
        const kmAtual = vtr.km_atual || 0;
        let oleoStatus = "N/D", oleoColor = "#94a3b8", oleoBg = "#f1f5f9";
        if (kmPrevisto > 0) {
            const isVencido = kmAtual >= kmPrevisto;
            oleoStatus = isVencido ? 'VENCIDO' : 'OK';
            oleoColor = isVencido ? '#991b1b' : '#166534';
            oleoBg = isVencido ? '#fef2f2' : '#dcfce7';
        }

        // 3. Situação Geral
        const stOp = (vtr.status_operativo || "").toLowerCase();
        let sitStatus = 'ATIVA', sitColor = '#166534', sitBg = '#dcfce7';
        if (vtr.em_manutencao) { sitStatus = 'MANUTENÇÃO'; sitColor = '#92400e'; sitBg = '#fef3c7'; }
        else if (stOp === 'manutencao') { sitStatus = 'BAIXADA'; sitColor = '#991b1b'; sitBg = '#fef2f2'; }
        else if (stOp === 'reserva') { sitStatus = 'RESERVA'; sitColor = '#1e293b'; sitBg = '#f1f5f9'; }

        // Renderização do Modal Premium
        Swal.fire({
            width: '650px',
            showConfirmButton: false,
            padding: '0',
            background: '#f8fafc',
            html: `
                <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 35px 25px; color: white; border-radius: 15px 15px 0 0; text-align: left;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="width: 70px; height: 70px; background: rgba(255,255,255,0.1); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2.2em;">
                            <i class="fa-solid fa-truck-moving"></i>
                        </div>
                        <div>
                            <h2 style="margin: 0; font-size: 1.8em; font-weight: 900; letter-spacing: -1px;">${vtr.prefixo || 'S/P'}</h2>
                            <div style="background: #800020; color: white; display: inline-block; padding: 2px 10px; border-radius: 6px; font-size: 0.7em; font-weight: 800; margin-top: 5px;">
                                UNIDADE: ${vtr.unidade_atual_nome || 'N/D'}
                            </div>
                        </div>
                    </div>
                </div>

                <div style="padding: 25px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: -55px; margin-bottom: 25px;">
                        <div style="background: ${licBg}; padding: 12px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; border: 1px solid ${licColor}20;">
                            <small style="display:block; font-size: 0.6em; font-weight: 800; color: #64748b;">LICENCIAMENTO</small>
                            <b style="color: ${licColor}; font-size: 0.9em;">${licStatus}</b>
                        </div>
                        <div style="background: ${oleoBg}; padding: 12px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; border: 1px solid ${oleoColor}20;">
                            <small style="display:block; font-size: 0.6em; font-weight: 800; color: #64748b;">TROCA DE ÓLEO</small>
                            <b style="color: ${oleoColor}; font-size: 0.9em;">${oleoStatus}</b>
                        </div>
                        <div style="background: ${sitBg}; padding: 12px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; border: 1px solid ${sitColor}20;">
                            <small style="display:block; font-size: 0.6em; font-weight: 800; color: #64748b;">SITUAÇÃO</small>
                            <b style="color: ${sitColor}; font-size: 0.9em;">${sitStatus}</b>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; background: white; border-radius: 18px; border: 1px solid #e2e8f0; text-align: left; margin-bottom: 20px;">
                        <div>
                            <small style="display:block; color:#94a3b8; font-weight:800; text-transform:uppercase; font-size:0.6em;">Identificação</small>
                            <div style="font-weight:700; color:#1e293b; margin-top:4px;"><i class="fa-solid fa-id-card" style="width:20px; color:#2c7399;"></i> Placa: ${vtr.placa || '---'}</div>
                            <div style="font-weight:700; color:#1e293b; margin-top:8px;"><i class="fa-solid fa-car-rear" style="width:20px; color:#2c7399;"></i> ${vtr.modelo || '---'}</div>
                        </div>
                        <div>
                            <small style="display:block; color:#94a3b8; font-weight:800; text-transform:uppercase; font-size:0.6em;">Monitoramento</small>
                            <div style="font-weight:900; color:#2c7399; margin-top:4px;"><i class="fa-solid fa-gauge-high" style="width:20px;"></i> ${(vtr.km_atual || 0).toLocaleString('pt-BR')} km</div>
                            <div style="font-weight:700; color:#1e293b; margin-top:8px;"><i class="fa-solid fa-user-shield" style="width:20px; color:#2c7399;"></i> ${vtr.responsavel_atual_nome || 'No Pátio'}</div>
                        </div>
                    </div>

                    <button onclick="verHistoricoVidaViatura('${ativoUid}', '${vtr.prefixo}')" style="width: 100%; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; color: #475569; font-weight: 800; font-size: 0.75em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 25px; transition: 0.3s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#fff'">
                        <i class="fa-solid fa-clock-rotate-left" style="color: #800020;"></i> EXIBIR LINHA DO TEMPO E REGISTROS DO ATIVO
                    </button>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="gerenciarChecklistVtr('${ativoUid}', '${(vtr.prefixo || "VTR").replace(/'/g, "\\'")}')" style="flex: 2; padding: 15px; border-radius: 12px; border: none; background: #2c7399; color: white; font-weight: 800; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fa-solid fa-list-check"></i> Checklist
                        </button>
                        <button onclick="alert('Módulo de Defeitos em Breve')" style="flex: 1; padding: 15px; border-radius: 12px; border: none; background: #800020; color: white; font-weight: 800; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fa-solid fa-triangle-exclamation"></i> Defeitos
                        </button>
                    </div>
                </div>
            `
        });

    } catch (e) {
        console.error("Erro no prontuário:", e);
        Swal.fire('Erro', 'Falha ao carregar prontuário: ' + e.message, 'error');
    }
}
		async function verHistoricoVidaViatura(vtrId, prefixo) {
    const containerId = 'timeline-vtr-' + Date.now();
    
    Swal.fire({
        title: `<i class="fa-solid fa-clock-rotate-left"></i> Histórico: ${prefixo}`,
        width: '600px',
        html: `<div id="${containerId}" style="max-height: 450px; overflow-y: auto; padding: 10px; text-align: left;">
                  <i class="fas fa-spinner fa-spin"></i> Consultando registros...
               </div>`,
        showConfirmButton: true,
        confirmButtonText: 'FECHAR',
        confirmButtonColor: '#1e293b'
    });

    try {
        // Busca vistorias realizadas especificamente para esta viatura
        // O ID do checklist segue o padrão que definimos: CHECKLIST_VTR_{vtrId}
        const checklistId = `CHECKLIST_VTR_${vtrId}`;
        
        const snap = await db.collection('resultados_checklist')
            .where('id_origem', '==', checklistId) // Ajuste para o campo que você usa no seu banco
            .orderBy('timestamp', 'desc')
            .limit(20)
            .get();

        const container = document.getElementById(containerId);
        if (snap.empty) {
            container.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:20px;">Nenhum registro de vistoria encontrado para este ativo.</p>';
            return;
        }

        let htmlTimeline = '<div class="sigma-v3-timeline">';
        snap.forEach(doc => {
            const data = doc.data();
            const dt = data.timestamp.toDate().toLocaleString('pt-BR');
            const temPendencia = data.totalCaa > 0;
            
            htmlTimeline += `
                <div class="sigma-v3-timeline-item" style="margin-bottom: 20px; border-left: 3px solid ${temPendencia ? '#991b1b' : '#166534'}; padding-left: 15px; position: relative;">
                    <div style="position: absolute; left: -8px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: white; border: 3px solid ${temPendencia ? '#991b1b' : '#166534'};"></div>
                    <small style="color: #64748b; font-weight: 800;">${dt}</small>
                    <div style="font-weight: 700; color: #1e293b; margin-top: 2px;">VISTORIA REALIZADA</div>
                    <div style="font-size: 0.8em; color: #475569;">Por: <b>${data.conferente}</b></div>
                    <div style="margin-top: 5px;">
                        <span style="font-size: 0.7em; padding: 2px 8px; border-radius: 4px; background: ${temPendencia ? '#fef2f2' : '#dcfce7'}; color: ${temPendencia ? '#991b1b' : '#166534'}; font-weight: 800;">
                            ${temPendencia ? '⚠️ POSSUI AVARIAS' : '✅ SEM ALTERAÇÕES'}
                        </span>
                    </div>
                </div>`;
        });
        htmlTimeline += '</div>';
        container.innerHTML = htmlTimeline;

    } catch (e) {
        console.error("Erro no histórico:", e);
        document.getElementById(containerId).innerHTML = '<p style="color:red;">Erro ao processar linha do tempo.</p>';
    }
}
		/*[GESTÃO DE VIATURAS/BASE*/
		async function abrirFormularioViatura(dadosEdicao = null) {
    const isEdit = !!dadosEdicao;
    
    // Lista de Unidades para o Select (Busca na coleção oficial V3)
    const snapUnidades = await db.collection('unidades_estruturadas').where('ativo', '==', true).get();
    let optionsUnidades = '<option value="" disabled selected>Selecione a Unidade...</option>';
    snapUnidades.forEach(u => {
        const d = u.data();
        const selected = (isEdit && dadosEdicao.unidade_id === u.id) ? 'selected' : '';
        optionsUnidades += `<option value="${u.id}" data-sigla="${d.sigla}" ${selected}>${d.sigla} - ${d.nome_completo}</option>`;
    });

    Swal.fire({
        title: isEdit ? '<i class="fas fa-edit"></i> Editar Viatura' : '<i class="fas fa-truck-pickup"></i> Nova Viatura',
        width: '600px',
        html: `
            <div style="text-align: left; padding: 5px;">
                <div style="background: #f0f7fa; padding: 15px; border-radius: 12px; border: 1px solid #d1e2eb; margin-bottom: 20px;">
                    <small style="color: #2c7399; font-weight: 800; text-transform: uppercase; font-size: 0.7em;">1. Identificação e Unidade</small>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div class="swal-v3-form-group">
                            <label>Prefixo (Ex: ABT-10)</label>
                            <input type="text" id="swal-vtr-prefixo" class="swal2-input" value="${isEdit ? dadosEdicao.prefixo : ''}" style="width:100%; margin:0;">
                        </div>
                        <div class="swal-v3-form-group">
                            <label>Placa</label>
                            <input type="text" id="swal-vtr-placa" class="swal2-input" value="${isEdit ? dadosEdicao.placa : ''}" style="width:100%; margin:0;">
                        </div>
                    </div>
                    <div class="swal-v3-form-group" style="margin-top:15px;">
                        <label>Unidade Responsável</label>
                        <select id="swal-vtr-unidade" class="swal2-select" style="width:100%; margin:0;">
                            ${optionsUnidades}
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="swal-v3-form-group">
                            <label>Segmento / Emprego</label>
                            <select id="swal-vtr-segmento" class="swal2-select" style="width:100%; margin:0;">
                                <option value="incendio" ${isEdit && dadosEdicao.segmento === 'incendio' ? 'selected' : ''}>Incêndio (Caminhão)</option>
                                <option value="ambulancia" ${isEdit && dadosEdicao.segmento === 'ambulancia' ? 'selected' : ''}>Ambulância (Resgate)</option>
                                <option value="salvamento" ${isEdit && dadosEdicao.segmento === 'salvamento' ? 'selected' : ''}>Salvamento / Pick-up</option>
                                <option value="passeio" ${isEdit && dadosEdicao.segmento === 'passeio' ? 'selected' : ''}>Adm / Passeio</option>
                            </select>
                        </div>
                        <div class="swal-v3-form-group">
                            <label>Status Operativo</label>
                            <select id="swal-vtr-status" class="swal2-select" style="width:100%; margin:0;">
                                <option value="ativo" ${isEdit && dadosEdicao.status === 'ativo' ? 'selected' : ''}>PRONTO (ATIVO)</option>
                                <option value="manutencao" ${isEdit && dadosEdicao.status === 'manutencao' ? 'selected' : ''}>BAIXADO (MANUTENÇÃO)</option>
                                <option value="reserva" ${isEdit && dadosEdicao.status === 'reserva' ? 'selected' : ''}>RESERVA</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top:15px;">
                         <div class="swal-v3-form-group">
                            <label>Marca/Mod.</label>
                            <input type="text" id="swal-vtr-modelo" class="swal2-input" value="${isEdit ? dadosEdicao.modelo : ''}" style="width:100%; margin:0;">
                        </div>
                        <div class="swal-v3-form-group">
                            <label>Ano</label>
                            <input type="number" id="swal-vtr-ano" class="swal2-input" value="${isEdit ? dadosEdicao.ano : ''}" style="width:100%; margin:0;">
                        </div>
                        <div class="swal-v3-form-group">
                            <label>KM Atual</label>
                            <input type="number" id="swal-vtr-km" class="swal2-input" value="${isEdit ? dadosEdicao.km_atual : ''}" style="width:100%; margin:0;">
                        </div>
                    </div>
                </div>

                <div style="background: #fff9f0; padding: 15px; border-radius: 12px; border: 1px solid #ffe8cc;">
                    <small style="color: #c2780e; font-weight: 800; text-transform: uppercase; font-size: 0.7em;">3. Manutenção Preventiva (Óleo)</small>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div class="swal-v3-form-group">
                            <label>Data Prevista</label>
                            <input type="date" id="swal-vtr-oleo-data" class="swal2-input" value="${isEdit ? dadosEdicao.oleo_data : ''}" style="width:100%; margin:0;">
                        </div>
                        <div class="swal-v3-form-group">
                            <label>KM Prevista</label>
                            <input type="number" id="swal-vtr-oleo-km" class="swal2-input" value="${isEdit ? dadosEdicao.oleo_km : ''}" style="width:100%; margin:0;">
                        </div>
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'SALVAR VIATURA',
        confirmButtonColor: '#2c7399',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            const prefixo = document.getElementById('swal-vtr-prefixo').value.trim().toUpperCase();
            const placa = document.getElementById('swal-vtr-placa').value.trim().toUpperCase();
            const unidadeEl = document.getElementById('swal-vtr-unidade');
            const unidade_id = unidadeEl.value;
            const unidade_sigla = unidadeEl.options[unidadeEl.selectedIndex].getAttribute('data-sigla');

            if (!prefixo || !placa || !unidade_id) {
                return Swal.showValidationMessage('Prefixo, Placa e Unidade são obrigatórios');
            }

            return {
                prefixo,
                placa,
                unidade_id,
                unidade_sigla,
                segmento: document.getElementById('swal-vtr-segmento').value,
                status: document.getElementById('swal-vtr-status').value,
                modelo: document.getElementById('swal-vtr-modelo').value.trim().toUpperCase(),
                ano: document.getElementById('swal-vtr-ano').value,
                km_atual: parseInt(document.getElementById('swal-vtr-km').value) || 0,
                oleo_data: document.getElementById('swal-vtr-oleo-data').value,
                oleo_km: parseInt(document.getElementById('swal-vtr-oleo-km').value) || 0
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            executarSalvamentoViatura(isEdit ? dadosEdicao.uid : null, result.value);
        }
    });
}
		async function executarSalvamentoViatura(uid, dados) {
    Swal.fire({ 
        title: 'Sincronizando...', 
        html: 'Atualizando dados da frota global.',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading() 
    });

    try {
        const uidFinal = uid || ("VTR-" + Date.now());
        const vtrRef = db.collection('viaturas').doc(uidFinal);
        const dataHora = firebase.firestore.FieldValue.serverTimestamp();
        
        // Criamos a chave de busca para o filtro instantâneo
        const searchKey = (dados.prefixo + dados.placa).replace(/[^A-Z0-9]/gi, '').toLowerCase();

        const payload = {
            uid: uidFinal,
            prefixo: dados.prefixo,
            placa: dados.placa,
            search_key: searchKey,
            unidade_id: dados.unidade_id,
            unidade_sigla: dados.unidade_sigla,
            segmento: dados.segmento,
            status_operativo: dados.status, // Padronizado com o seu campo original
            modelo: dados.modelo,
            ano: dados.ano,
            km_atual: dados.km_atual,
            manutencao: {
                oleo_data: dados.oleo_data,
                oleo_km_prevista: dados.oleo_km
            },
            last_update: dataHora,
            atualizado_por: currentUserData.nome_militar_completo
        };

        if (!uid) {
            payload.data_cadastro = dataHora;
        }

        await vtrRef.set(payload, { merge: true });

        // Toast de Sucesso Sigma V3
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'success',
            title: uid ? 'Viatura atualizada!' : 'Viatura cadastrada com sucesso!'
        });

        carregarVtrBasesCards(); // Recarrega o grid

    } catch (e) {
        console.error("Erro ao salvar viatura:", e);
        Swal.fire('Erro Técnico', 'Não foi possível salvar os dados no Firebase.', 'error');
    }
}

// MENU LISTAS
async function abrirFormularioLista(dadosEdicao = null) {
    const isEdit = !!dadosEdicao;
    
    // Mostra loading enquanto busca dados para os selects
    Swal.fire({ title: 'Carregando opções...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    try {
        // Busca Ativos, Unidades e Postos em paralelo para agilizar
        const [snapAtivos, snapUnidades, snapPostos] = await Promise.all([
            db.collection('viaturas').orderBy('prefixo').get(),
            db.collection('unidades_estruturadas').where('ativo', '==', true).get(),
            db.collection('postos_estruturados').where('ativo', '==', true).get()
        ]);

        let optAtivos = '<option value="" disabled selected>Selecione o Ativo...</option>';
        snapAtivos.forEach(doc => {
            const v = doc.data();
            const sel = isEdit && dadosEdicao.ativo_id === doc.id ? 'selected' : '';
            optAtivos += `<option value="${doc.id}" data-nome="${v.prefixo}" ${sel}>${v.prefixo} (${v.placa})</option>`;
        });

        let optUnidades = '<option value="" disabled selected>Selecione a Unidade...</option>';
        snapUnidades.forEach(doc => {
            const u = doc.data();
            const sel = isEdit && dadosEdicao.unidade_id === doc.id ? 'selected' : '';
            optUnidades += `<option value="${doc.id}" data-sigla="${u.sigla}" ${sel}>${u.sigla}</option>`;
        });

        let optPostos = '<option value="" disabled selected>Vincular ao Posto...</option>';
        snapPostos.forEach(doc => {
            const p = doc.data();
            const sel = isEdit && dadosEdicao.posto_id === doc.id ? 'selected' : '';
            optPostos += `<option value="${doc.id}" data-nome="${p.nome}" ${sel}>${p.nome}</option>`;
        });

        Swal.fire({
            title: isEdit ? '<i class="fas fa-edit"></i> Editar Lista' : '<i class="fas fa-plus-circle"></i> Nova Lista Mestra',
            width: '600px',
            html: `
                <div style="text-align: left; padding: 5px;">
                    <div class="swal-v3-form-group">
                        <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">1. Ativo Vinculado (Viatura/Base)</label>
                        <select id="swal-lista-ativo" class="swal2-select" style="width:100%; margin:5px 0 15px 0; border-radius: 10px;">${optAtivos}</select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="swal-v3-form-group">
                            <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">2. Unidade Gestora</label>
                            <select id="swal-lista-unidade" class="swal2-select" style="width:100%; margin:5px 0 15px 0; border-radius: 10px;">${optUnidades}</select>
                        </div>
                        <div class="swal-v3-form-group">
                            <label style="font-weight: 800; font-size: 0.75em; color: #64748b; text-transform: uppercase;">3. Posto de Serviço</label>
                            <select id="swal-lista-posto" class="swal2-select" style="width:100%; margin:5px 0 15px 0; border-radius: 10px;">${optPostos}</select>
                        </div>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: isEdit ? 'ATUALIZAR CABEÇALHO' : 'CRIAR E CONFIGURAR ITENS',
            confirmButtonColor: isEdit ? '#2c7399' : '#800000',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const selAtivo = document.getElementById('swal-lista-ativo');
                const selUnid = document.getElementById('swal-lista-unidade');
                const selPosto = document.getElementById('swal-lista-posto');

                if (!selAtivo.value || !selUnid.value || !selPosto.value) {
                    return Swal.showValidationMessage('Selecione todos os campos');
                }

                return {
                    ativo_id: selAtivo.value,
                    ativo_nome: selAtivo.options[selAtivo.selectedIndex].dataset.nome,
                    unidade_id: selUnid.value,
                    unidade_sigla: selUnid.options[selUnid.selectedIndex].dataset.sigla,
                    posto_id: selPosto.value,
                    posto_nome: selPosto.options[selPosto.selectedIndex].dataset.nome
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const abrirEditor = !isEdit; // Só abre o editor de itens se for lista nova
                gravarCabecalhoListaV3(abrirEditor, isEdit ? dadosEdicao.uid : null, result.value);
            }
        });

    } catch (e) {
        console.error(e);
        Swal.fire('Erro', 'Falha ao carregar dependências.', 'error');
    }
}
	async function gravarCabecalhoListaV3(abrirEditor, uidExistente, dados) {
    Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });

    try {
        const uidFinal = uidExistente || `LISTA_${dados.ativo_id}_${Date.now()}`;
        const docRef = db.collection('listas_conferencia').doc(uidFinal);
        
        const payload = {
            ...dados,
            uid: uidFinal,
            ativo: true,
            tipo: 'conferencia_materiais',
            atualizado_em: firebase.firestore.FieldValue.serverTimestamp(),
            atualizado_por: currentUserData.nome_militar_completo
        };

        if (!uidExistente) {
            payload.criado_em = firebase.firestore.FieldValue.serverTimestamp();
            payload.list = []; // Inicia vazia para o editor
        }

        await docRef.set(payload, { merge: true });

        if (abrirEditor) {
            abrirModalEditorItens(uidFinal, dados.ativo_nome);
        } else {
            Swal.fire({ icon: 'success', title: 'Lista atualizada!', timer: 1500, showConfirmButton: false });
            carregarCardsListasExistentes();
        }

    } catch (e) {
        console.error(e);
        Swal.fire('Erro', 'Erro ao gravar no banco.', 'error');
    }
}	
async function carregarCardsListasExistentes() {
    const container = document.getElementById('container-cards-listas');
    if (!container) return;

    // Grid V3 Layout
    container.innerHTML = `
        <div style="grid-column: 1/-1; text-align:center; padding:60px; color:#64748b;">
            <i class="fas fa-sync fa-spin fa-3x" style="opacity:0.3; margin-bottom:15px; display:block;"></i>
            <span style="font-weight:700; letter-spacing:1px; text-transform:uppercase; font-size:0.8em;">Sincronizando Inventários...</span>
        </div>`;

    try {
        const role = currentUserData?.role;
        const minhaUnidadeId = currentUserData?.unidade_id;
        const isAdminGeral = (role === 'admin' || role === 'gestor_geral');

        let query = db.collection('listas_conferencia')
            .where('ativo', '==', true)
            .where('tipo', '==', 'conferencia_materiais');

        if (!isAdminGeral) {
            query = query.where('unidade_id', '==', minhaUnidadeId);
        }

        const snap = await query.get();

        if (snap.empty) {
            container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#94a3b8;">Nenhuma lista localizada.</div>`;
            return;
        }

        let html = '';
        snap.forEach(doc => {
            const lista = doc.data();
            const qtdItens = (lista.list || []).reduce((acc, setor) => acc + (setor.itens ? setor.itens.length : 0), 0);
            
            // Sanitização para o botão de edição (Lápis)
            const listaJson = JSON.stringify({ uid: doc.id, ...lista }).replace(/"/g, '&quot;');

            const btnDelete = isAdminGeral ? `
                <button class="v3-btn-action" title="Excluir Lista" onclick="event.stopPropagation(); deletarListaInteira('${doc.id}', '${lista.ativo_nome}')">
                    <i class="fas fa-trash-alt"></i>
                </button>` : '';

            html += `
                <div class="v3-posto-card" style="border-top: 6px solid #2c7399; cursor:pointer;" 
                     onclick="abrirModalEditorItens('${doc.id}', '${lista.ativo_nome}')">
                    
                    <div class="v3-posto-actions">
                        <button class="v3-btn-action" title="Editar Informações" onclick="event.stopPropagation(); abrirFormularioLista(JSON.parse('${listaJson}'))">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        ${btnDelete}
                    </div>
                    
                    <div style="padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; flex-grow: 1;">
                        <div class="v3-icon-box" style="background: rgba(44, 115, 153, 0.1); color: #2c7399; width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.6em; margin-bottom: 15px;">
                            <i class="fa-solid fa-clipboard-list"></i>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <span style="display:block; font-weight:900; font-size:1.2em; color:#1e293b; letter-spacing:-0.5px;">${lista.ativo_nome}</span>
                            <span class="v3-vtr-badge v3-status-pronto" style="margin-top: 5px; display: inline-block; background: #e0f2fe; color: #0369a1;">
                                ${qtdItens} ITENS NO INVENTÁRIO
                            </span>
                        </div>

                        <div style="width: 100%; border-top: 1px solid #f1f5f9; padding-top: 12px; margin-top: auto; text-align: left;">
                            <small style="display:block; font-size:0.6em; font-weight:800; color:#94a3b8; text-transform:uppercase; margin-bottom:4px;">Localização & Gestão</small>
                            <div style="display:flex; align-items:center; gap:6px;">
                                <i class="fas fa-map-marker-alt" style="color:#2c7399; font-size:0.75em;"></i>
                                <span style="font-size:0.8em; font-weight:700; color:#475569;">${lista.posto_nome} | ${lista.unidade_sigla}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
        });

        container.innerHTML = html;
        if (window.FontAwesome) FontAwesome.dom.i2svg();

    } catch (e) {
        console.error("Erro V3 Listas:", e);
        container.innerHTML = `<p style="color:red; text-align:center; padding:40px;">Erro ao carregar inventários.</p>`;
    }
}
		
	function filtrarCardsListas() {
    const termo = document.getElementById('filter-lista-busca').value.toUpperCase();
    const cards = document.querySelectorAll('#container-cards-listas .v3-posto-card');
    cards.forEach(card => {
        card.style.display = card.innerText.toUpperCase().includes(termo) ? "flex" : "none";
    });
}			

/**
 * Exclui a lista de conferência e limpa a rota associada
 */
async function deletarListaInteira(listaUid, nomeAtivo) {
    if (!confirm(`⚠️ ATENÇÃO: Isso apagará permanentemente o inventário de materiais do ${nomeAtivo}. Confirma?`)) return;

    try {
        const batch = db.batch();
        
        // 1. Remove a lista (Operação principal)
        batch.delete(db.collection('listas_conferencia').doc(listaUid));
        
        // 🗑️ REMOVIDO: Bloco que tentava atualizar config_geral/rotas
        // A limpeza do legado agora é automática, pois não dependemos mais desse índice.

        await batch.commit();
        alert("Lista removida com sucesso.");
        carregarCardsListasExistentes();

    } catch (e) {
        console.error("Erro ao deletar lista:", e);
        alert("Erro ao excluir lista.");
    }
}
		

async function abrirModalEditorItens(uid, nome, colecaoAlvo) {
    // 1. BLINDAGEM DE INSTÂNCIA
    const firestore = firebase.firestore(); 

    // 2. NORMALIZAÇÃO RADICAL DE ID E RESET DE CONTROLE
    let idReal = (typeof uid === 'object' && uid !== null) ? (uid.id || uid.uid || uid.checklistId) : String(uid);
    idReal = idReal.trim();
    idListaSendoEditada = idReal;
    
    // Reset de arrays de movimentação para evitar contaminação
    itensParaEstorno = []; 
    if (typeof atualizarInterfaceEstorno === 'function') atualizarInterfaceEstorno();

    // 3. DEFINIÇÃO DE CONTEXTO (VISTORIA VS CONFERÊNCIA)
    if (idReal.startsWith('CHECKLIST_VTR_')) {
        window.colecaoAtivaNoEditor = 'listas_checklist';
        window.isModoVistoria = true; 
        isModoVistoria = true;
    } else {
        window.colecaoAtivaNoEditor = colecaoAlvo || 'listas_conferencia';
        window.isModoVistoria = false;
        isModoVistoria = false;
    }

    const modoCor = isModoVistoria ? '#2c3e50' : '#800020';
    const modoTexto = isModoVistoria ? 'EDITOR DE CHECKLIST' : 'EDITOR DE LISTA';
    const modoIcone = isModoVistoria ? 'fa-car' : 'fa-clipboard-list';

    // 4. INTERFACE E TRANSIÇÃO
    switchView('editor-arquitetura');
    
    const headerSticky = document.querySelector('.editor-header-sticky');
    if (headerSticky) headerSticky.style.borderTop = `6px solid ${modoCor}`;

    const elNome = document.getElementById('edit-vtr-nome');
    if (elNome) {
        elNome.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas ${modoIcone}" style="color: ${modoCor}; font-size: 0.9em;"></i>
                <div style="line-height: 1;">
                    <span style="display: block; font-size: 0.5em; font-weight: 800; color: ${modoCor}; letter-spacing: 1px; text-transform: uppercase;">${modoTexto}</span>
                    <span style="font-size: 1em;">${nome}</span>
                </div>
            </div>`;
    }

    const containerDrag = document.getElementById('setores-drag-container');
    if (containerDrag) {
        containerDrag.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding:50px;">
                <i class="fas fa-sync fa-spin fa-2x" style="color: ${modoCor}"></i><br>
                Sincronizando Dados...
            </div>`;
    }

    try {
        // 5. BUSCA DIRETA NO DOCUMENTO (SEM DEPENDÊNCIA DE ROTAS)
        let doc = await firestore.collection(window.colecaoAtivaNoEditor).doc(idReal).get();
        
        if (!doc.exists) {
            await new Promise(r => setTimeout(r, 800)); // Pequeno delay para consistência do Firebase
            doc = await firestore.collection(window.colecaoAtivaNoEditor).doc(idReal).get();
        }

        if (!doc.exists) throw new Error("A arquitetura desta lista não foi localizada.");

        const dados = doc.data();
        arquiteturaAtiva = dados.list || []; 
        
        // 6. SINCRONIZAÇÃO DE RÓTULOS E ESTOQUE
        const elUnidade = document.getElementById('edit-vtr-unidade');
        if (elUnidade) elUnidade.textContent = `Unidade: ${dados.unidade_sigla || 'N/D'}`;
        
        const inputBusca = document.getElementById('input-busca-estoque');
        if (inputBusca) {
            inputBusca.placeholder = isModoVistoria ? "Digitar item de vistoria..." : "Adicionar item do estoque...";
        }

        // CARGA INTELIGENTE: Carrega o estoque baseado no unidade_id do próprio documento
        if (!isModoVistoria && dados.unidade_id) {
            await carregarEstoqueParaEditor(dados.unidade_id);
        } else {
            estoqueGestorLocal = []; 
        }

        renderizarArquiteturaEditor(); 
        if (typeof atualizarSelectSetores === 'function') atualizarSelectSetores();
        
        const btnPub = document.querySelector('.btn-publish');
        if (btnPub) btnPub.style.backgroundColor = isModoVistoria ? '#2c7399' : '#1b8a3e';

    } catch (e) {
        console.error("❌ FALHA NO EDITOR:", e);
        alert(e.message);
        isModoVistoria ? switchView('vtr-bases') : switchView('listas');
    }
}
		async function verHistoricoVidaGlobal(uidGlobal, tombamento = null) {
    const container = document.getElementById('timeline-container');
    const modal = document.getElementById('modal-timeline-global');
    const labelNome = document.getElementById('timeline-item-nome');

    if (!container || !modal) return;

    modal.style.display = 'flex';
    container.innerHTML = '<div style="text-align:center; padding:30px;"><i class="fas fa-spinner fa-spin"></i> Acessando prontuário...</div>';

    try {
        const docRef = db.collection('inventario').doc(uidGlobal);
        let eventos = [];

        if (tombamento) {
            // ✅ MODO MULTI: ACESSO AO PRONTUÁRIO INDIVIDUAL
            labelNome.textContent = `RG Individual: Tomb. ${tombamento}`;
            
            const histSnap = await docRef
                .collection('tombamentos')
                .doc(tombamento)
                .collection('historico_vida')
                .get();

            eventos = histSnap.docs.map(d => ({
                ...d.data(),
                id_evento: d.id
            }));

        } else {
            // ✅ MODO SINGLE/LOTE
            labelNome.textContent = `Histórico de Lote`;
            
            // 1. Busca logs no Documento Principal
            const snapPai = await docRef.get();
            if (snapPai.exists && snapPai.data().historico_movimentacoes) {
                eventos = [...snapPai.data().historico_movimentacoes];
            }

            // 2. Busca logs distribuídos nas sub-coleções de saldos das unidades
            const saldosSnap = await docRef.collection('saldos_unidades').get();
            for (const docUnid of saldosSnap.docs) {
                const hSnap = await docUnid.ref.collection('historico_vida').get();
                hSnap.forEach(hDoc => {
                    eventos.push({
                        ...hDoc.data(),
                        unidade_ref: docUnid.data().unidade_sigla
                    });
                });
            }
        }

        if (eventos.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:#999; padding:40px;">
                    <i class="fas fa-search fa-3x" style="opacity:0.2; margin-bottom:10px;"></i>
                    <p>Nenhum registro encontrado para este nível.</p>
                </div>`;
            return;
        }

        // Ordenação Cronológica (Mais recente primeiro)
        eventos.sort((a, b) => {
            const parseDate = (str) => {
                if (!str) return new Date(0);
                const parts = str.split(', ');
                const dateParts = parts[0].split('/');
                const timeParts = parts[1] ? parts[1].split(':') : [0,0,0];
                return new Date(dateParts[2], dateParts[1]-1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]);
            };
            return parseDate(b.data) - parseDate(a.data);
        });

        // ✅ MONTAGEM DA UI COM TRATAMENTO DE QUANTIDADE E GUIA AMIGÁVEL
        container.innerHTML = eventos.map(ev => {
            let icon = 'fa-history';
            let color = '#4b5563'; // Cinza escuro padrão
            const evNome = (ev.evento || "").toUpperCase();

            // Lógica de Cores e Ícones
            if (evNome.includes('APORTE')) { icon = 'fa-plus-circle'; color = '#1b8a3e'; }
            if (evNome.includes('RECEBIMENTO')) { icon = 'fa-file-import'; color = '#1b8a3e'; }
            if (evNome.includes('ENVIO') || evNome.includes('TRANSFERENCIA')) { icon = 'fa-exchange-alt'; color = '#2c7399'; }
            if (evNome.includes('AVARIA') || evNome.includes('PENDENCIA')) { icon = 'fa-exclamation-triangle'; color = '#800020'; }

            // ✅ Tratamento da Quantidade (Apenas se houver e for lote)
            const labelQtd = ev.quantidade ? `<span style="background:${color}22; color:${color}; padding:2px 6px; border-radius:4px; margin-left:8px; font-size:0.9em;">[${ev.quantidade} un.]</span>` : '';

            // ✅ Tratamento da Guia Amigável (Converte ID longo em TR-ANO/ID)
            let detalhesTexto = ev.detalhes || ev.descricao || 'Sem descrição.';
            const regexFirestoreID = /[a-zA-Z0-9]{20}/g; // Identifica IDs padrão do Firestore
            detalhesTexto = detalhesTexto.replace(regexFirestoreID, (match) => {
                return `<b>TR-2026/${match.substring(0, 5).toUpperCase()}</b>`;
            });

            return `
                <div class="timeline-event" style="border-left: 3px solid ${color}; margin-bottom: 20px; padding-left: 20px; position: relative;">
                    <div style="position: absolute; left: -9px; top: 0; background: #fff; padding: 2px;">
                        <i class="fas ${icon}" style="color: ${color}; font-size: 12px;"></i>
                    </div>
                    <span class="event-date" style="font-size: 0.8em; color: #666; font-weight: bold;">${ev.data}</span>
                    <span class="event-title" style="display: block; font-weight: 800; color: #333; font-size: 0.85em; text-transform: uppercase;">
                        ${evNome.replace(/_/g, ' ')} ${ev.unidade_ref ? `[${ev.unidade_ref}]` : ''} ${labelQtd}
                    </span>
                    <div class="event-desc" style="font-size: 0.9em; color: #444; background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #eee; margin-top: 5px; line-height: 1.4;">
                        ${detalhesTexto}
                    </div>
                    <span class="event-user" style="font-size: 0.75em; color: #999; display: block; margin-top: 5px;">
                        <i class="fas fa-user-edit"></i> Resp: ${ev.quem || 'Sistema'}
                    </span>
                </div>`;
        }).join('');

    } catch (e) {
        console.error("❌ Erro ao carregar histórico:", e);
        container.innerHTML = `<p style="color:red; text-align:center; padding:20px;">Erro: ${e.message}</p>`;
    }
}
	async function executarEnvioUnidade() {
    const docElement = document.getElementById('almox-transf-item-nome');
    const uidGlobal = docElement.getAttribute('data-docid').replace('ADMIN_', ''); 
    const ehMulti = docElement.getAttribute('data-tipo') === 'multi';
    
    const unidadeDestinoUid = document.getElementById('almox-viatura-alvo').value; 
    const obs = document.getElementById('almox-transf-obs').value.trim();
    const dataReg = new Date().toLocaleString('pt-BR');
    const autorNome = currentUserData.nome_militar_completo;

    if (!unidadeDestinoUid) return alert("Selecione a Unidade de destino.");
    const selectUnidade = document.getElementById('almox-viatura-alvo');
    const nomeUnidadeDestino = selectUnidade.options[selectUnidade.selectedIndex].text;

    let qtd = parseInt(document.getElementById('almox-transf-qtd').value);
    if (!qtd || qtd < 1) return alert("Informe uma quantidade válida.");
    if (!obs) return alert("A justificativa da transferência é obrigatória.");

    const btn = document.getElementById('btn-confirmar-movimentacao');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando Guia de Trânsito...';

    try {
        const itemRef = db.collection('inventario').doc(uidGlobal);
        const transRef = db.collection('transferencias_pendentes').doc(); // Nova coleção para o App
        const idEvento = "TRF-" + Date.now();

        await db.runTransaction(async (transaction) => {
            const snapItem = await transaction.get(itemRef);
            if (!snapItem.exists) throw new Error("Item não localizado no inventário.");
            const dItem = snapItem.data();

            let detalhesItens = []; // Para a Guia de Transferência

            // 1. TRATAMENTO PARA ITENS MULTI (TOMBAMENTOS)
            if (ehMulti) {
                const selecionados = Array.from(document.querySelectorAll('.check-envio-tomb:checked')).map(c => c.value);
                if (selecionados.length !== qtd) throw new Error("Selecione os tombamentos correspondentes.");

                for (let t of selecionados) {
                    const tombRef = itemRef.collection('tombamentos').doc(t);
                    
                    // ✅ DOUTRINA: Muda para "EM TRÂNSITO" e remove local atual
                    transaction.update(tombRef, {
                        situacao_atual: "EM TRÂNSITO",
                        unidade_destino_id: unidadeDestinoUid,
                        unidade_destino_sigla: nomeUnidadeDestino,
                        enviado_por: autorNome,
                        data_envio: dataReg
                    });

                    transaction.set(tombRef.collection('historico_vida').doc(idEvento), {
                        data: dataReg,
                        evento: "ENVIO_TRANSFERENCIA",
                        quem: autorNome,
                        detalhes: `Material em trânsito para ${nomeUnidadeDestino}. Guia: ${transRef.id}. Obs: ${obs}`
                    });

                    detalhesItens.push({ id_base: uidGlobal, nome: dItem.nome, tombamento: t, quantidade: 1 });
                }
            } else {
                // 2. TRATAMENTO PARA ITENS SINGLE (SALDOS)
                const refSaldoOrigem = itemRef.collection('saldos_unidades').doc('ADMIN');
                const refSaldoDestino = itemRef.collection('saldos_unidades').doc(unidadeDestinoUid);

                const [snapOrigem, snapDestino] = await Promise.all([
                    transaction.get(refSaldoOrigem),
                    transaction.get(refSaldoDestino)
                ]);

                if (!snapOrigem.exists || snapOrigem.data().qtd_disp < qtd) {
                    throw new Error("Saldo disponível insuficiente no Almoxarifado Central.");
                }

                // Subtrai do Disponível DLOG
                transaction.update(refSaldoOrigem, {
                    qtd_total: snapOrigem.data().qtd_total - qtd,
                    qtd_disp: snapOrigem.data().qtd_disp - qtd,
                    last_update: dataReg
                });

                // ✅ DOUTRINA: Incrementa o Trânsito no Destino (Não o Disponível!)
                const dadosDest = snapDestino.exists ? snapDestino.data() : { qtd_total: 0, qtd_disp: 0, qtd_transito: 0 };
                transaction.set(refSaldoDestino, {
                    unidade_sigla: nomeUnidadeDestino,
                    qtd_transito: (dadosDest.qtd_transito || 0) + qtd,
                    last_update: dataReg
                }, { merge: true });

                transaction.set(refSaldoDestino.collection('historico_vida').doc(idEvento), {
                    data: dataReg,
                    evento: "ENVIO_TRANSFERENCIA",
                    quem: autorNome,
                    quantidade: qtd,
                    detalhes: `Lote em trânsito vindo da DLOG. Guia: ${transRef.id}. Obs: ${obs}`
                });

                detalhesItens.push({ id_base: uidGlobal, nome: dItem.nome, quantidade: qtd });
            }

            // 3. ✅ GERAÇÃO DO DOCUMENTO DE CONFERÊNCIA PARA O APP
            transaction.set(transRef, {
                transferencia_id: transRef.id,
                origem_id: "ADMIN",
                origem_sigla: "DLOG",
                destino_id: unidadeDestinoUid,
                destino_sigla: nomeUnidadeDestino,
                emitente: autorNome,
                timestamp_envio: firebase.firestore.FieldValue.serverTimestamp(),
                status: "EM_TRANSITO",
                observacoes: obs,
                itens: detalhesItens,
                tipo_conferencia: "RECEBIMENTO_CARGA"
            });
        });

        alert(`📦 Material enviado!\n\nO saldo está agora como 'EM TRÂNSITO' para ${nomeUnidadeDestino}.\n\nA Guia de Transferência foi gerada para conferência via App.`);
        document.getElementById('modal-almox-transferencia').style.display = 'none';
        
        // Opcional: Aqui poderíamos disparar a função de PDF que você mencionou
        // gerarPDFTransferencia(transRef.id);

        carregarAlmoxarifadoUI();

    } catch (e) {
        console.error("Erro na transferência:", e);
        alert("❌ Erro no envio: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check"></i> Confirmar';
    }
}

// ================================================================
// 2. FECHAR O EDITOR (BOTÃO VOLTAR)
// ================================================================
function fecharEditorArquitetura() {
    // 1. Verificação de segurança para mudanças não salvas
    const btnPub = document.querySelector('.btn-publish');
    if (btnPub && btnPub.classList.contains('modified')) {
        if (!confirm("Você possui alterações não publicadas. Deseja realmente sair e descartar as mudanças?")) return;
    }
    
    // 2. Limpa o estado global do editor
    idListaSendoEditada = null;
    arquiteturaAtiva = [];
    itensParaEstorno = [];
    
    // 3. UI: Esconde o palco do editor
    document.getElementById('view-editor-arquitetura').style.display = 'none';
    
    // 4. ✅ LÓGICA DE RETORNO INTELIGENTE
    if (isModoVistoria) {
        // Se for checklist, volta para o menu de Viaturas & Bases
        switchView('vtr-bases');
    } else {
        // Se for material, volta para a Gestão de Listas (comportamento original)
        document.getElementById('menu-editor-listas').style.display = 'block';
        const linkListas = document.getElementById('link-listas');
        if (linkListas) linkListas.classList.add('active');
        carregarCardsListasExistentes();
    }

    // 5. Restaura o padding padrão da tela que o editor remove
    const contentPrincipal = document.querySelector('.content');
    if (contentPrincipal) contentPrincipal.style.padding = '20px';
}

// ================================================================
// 3. CARREGAR ESTOQUE DA UNIDADE (BUSCA INTELIGENTE)
// ================================================================
async function carregarEstoqueParaEditor(unidadeId) {
    try {
        // 1. RESET: Limpa o cache para garantir que não haja "lixo" de outras unidades
        estoqueGestorLocal = [];

        // 2. BUSCA NA NOVA ARQUITETURA:
        // Entramos no Inventário Único. O desafio aqui é listar apenas os itens 
        // onde a unidade possui um documento de saldo criado.
        // Usamos uma "Group Query" ou buscamos os itens globais e filtramos o saldo local.
        const snapItens = await db.collection('inventario').get();

        for (const doc of snapItens.docs) {
            const itemGlobal = doc.data();
            const ehMulti = itemGlobal.tipo === 'multi';

            // 3. CAPTURA DO SALDO ESPECÍFICO DA UNIDADE
            // Buscamos na sub-coleção 'saldos_unidades' pelo ID da unidade do gestor
            const saldoDoc = await doc.ref.collection('saldos_unidades').doc(unidadeId).get();

            if (saldoDoc.exists) {
                const s = saldoDoc.data();
                const totalDisponivel = Number(s.qtd_disp) || 0;

                // 4. MAPEAMENTO PARA O BUSCADOR (estoqueGestorLocal)
                const objetoParaBusca = {
                    id_almox: doc.id, // O UID_GLOBAL (Ex: FAM-001-MOD-1)
                    nome: itemGlobal.nome,
                    tipo: itemGlobal.tipo,
                    categoria: itemGlobal.categoria,
                    disponivel: totalDisponivel,
                    unidade_id: unidadeId,
                    uid_global: doc.id
                };

                // Se for MULTI, precisamos carregar os tombamentos disponíveis para o autocomplete
                if (ehMulti) {
                    const snapTombs = await doc.ref.collection('tombamentos')
                        .where('local_id', '==', unidadeId)
                        .where('situacao_atual', '==', 'DISPONÍVEL')
                        .get();
                    
                    objetoParaBusca.tombamentos = snapTombs.docs.map(t => t.data());
                    // Para itens multi, o 'disponivel' é a contagem de tombamentos livres
                    objetoParaBusca.disponivel = snapTombs.size;
                }

                // 5. ALIMENTA O CACHE
                // Só adicionamos se houver o que gerenciar (saldo > 0 ou tombamentos livres)
                if (objetoParaBusca.disponivel > 0) {
                    estoqueGestorLocal.push(objetoParaBusca);
                }
            }
        }

        console.log(`🚀 Buscador Inteligente: ${estoqueGestorLocal.length} itens do Inventário mapeados para a unidade ${unidadeId}`);

    } catch (e) {
        console.error("Erro ao mapear Inventário para o Editor:", e);
    }
}
		// ================================================================
// 4. RENDERIZAÇÃO DA INTERFACE (GRID E CARDS)
// ================================================================
function renderizarArquiteturaEditor() {
    const container = document.getElementById('setores-drag-container');
    if (!container) return;

    container.innerHTML = '';

    // Define a cor temática baseada no modo (Checklist VTR ou Lista Materiais)
    const corTemaSetor = window.isModoVistoria ? '#2c3e50' : '#800020';

    if (arquiteturaAtiva.length === 0) {
        container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#64748b;">
            <i class="fas fa-folder-open fa-3x" style="display:block; margin-bottom:15px; opacity:0.3;"></i>
            Nenhum setor criado. Clique no botão + para começar.
        </div>`;
        return;
    }

    arquiteturaAtiva.forEach((setor, indexSetor) => {
        const setorDiv = document.createElement('div');
        setorDiv.className = 'setor-arquitetura-card';
        setorDiv.dataset.index = indexSetor;

        // ✅ Aplica a cor dinâmica no background do cabeçalho do setor
        let htmlHeader = `
            <div class="setor-arquitetura-header" style="background-color: ${corTemaSetor} !important;">
                <span><i class="fas fa-grip-lines" style="margin-right:10px; opacity:0.5;"></i> ${setor.nome}</span>
                <button onclick="removerSetorArquitetura(${indexSetor})" class="btn-remove-item-vtr" style="color:white;">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>`;

        let htmlItens = `<div class="setor-arquitetura-body" data-setor-index="${indexSetor}">`;
        
        (setor.itens || []).forEach((item, indexItem) => {
            const ehMulti = item.tipo === 'multi';

            htmlItens += `
                <div class="item-arquitetura-linha" data-item-index="${indexItem}" style="flex-direction: column; align-items: flex-start; gap: 5px; padding: 10px; border-bottom: 1px solid #f1f5f9; position: relative;">
                    <div class="item-arquitetura-info" style="width: 100%; display: flex; justify-content: space-between; align-items: flex-start;">
                        <b style="color: #1e293b; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Inter', sans-serif; padding-right: 25px;">${item.nome}</b>
                        
                        <button onclick="${ehMulti ? '' : `marcarParaEstorno(${indexSetor}, ${indexItem})`}" 
                                style="${ehMulti ? 'display:none;' : 'background: #f1f5f9; border: none; color: #94a3b8; cursor: pointer; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;'}" 
                                onmouseover="this.style.background='#fee2e2'; this.style.color='#ef4444'" 
                                onmouseout="this.style.background='#f1f5f9'; this.style.color='#94a3b8'">
                            <i class="fas fa-times" style="font-size: 9px;"></i>
                        </button>
                    </div>
                    
                    <div class="lista-tombamentos-container" style="width: 100%; display: flex; flex-wrap: wrap; gap: 4px; margin-top: 2px;">
                        ${ehMulti ? 
                            (item.tombamentos || []).map((tData, tIndex) => `
                                <div style="display: flex; align-items: center; background: #f8fafc; padding: 2px 2px 2px 8px; border-radius: 4px; border: 1px solid #e2e8f0; gap: 6px;">
                                    <span style="font-size: 11px; font-family: 'Inter', sans-serif; font-weight: 700; color: #475569; letter-spacing: -0.2px;">
                                        <i class="fas fa-tag" style="font-size: 9px; color: ${corTemaSetor}; margin-right: 3px;"></i>${tData.tomb || 'S/N'}
                                    </span>
                                    <button onclick="removerTombamentoIndividual(${indexSetor}, ${indexItem}, ${tIndex})" 
                                            style="background: #fee2e2; border: none; color: #b91c1c; cursor: pointer; border-radius: 3px; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 9px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `).join('') 
                            : 
                            `<div style="font-size: 10px; font-weight: 800; color: #b45309; background: #fff7ed; padding: 2px 8px; border-radius: 4px; border: 1px solid #ffedd5; font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-boxes" style="font-size: 9px; opacity: 0.7;"></i>
                                QTD: ${item.quantidadeEsperada}
                            </div>`
                        }
                    </div>
                </div>`;
        });

        htmlItens += `</div>`;
        setorDiv.innerHTML = htmlHeader + htmlItens;
        container.appendChild(setorDiv);

        new Sortable(setorDiv.querySelector('.setor-arquitetura-body'), {
            group: 'itens_viatura', 
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const fromIdx = evt.from.dataset.setorIndex;
                const toIdx = evt.to.dataset.setorIndex;
                const oldItemIdx = evt.oldIndex;
                const newItemIdx = evt.newIndex;
                const itemMovido = arquiteturaAtiva[fromIdx].itens.splice(oldItemIdx, 1)[0];
                arquiteturaAtiva[toIdx].itens.splice(newItemIdx, 0, itemMovido);
                marcarAlteracao();
            }
        });
    });

    new Sortable(container, {
        animation: 150,
        handle: '.setor-arquitetura-header',
        onEnd: function (evt) {
            const oldIdx = evt.oldIndex;
            const newIdx = evt.newIndex;
            const setorMovido = arquiteturaAtiva.splice(oldIdx, 1)[0];
            arquiteturaAtiva.splice(newIdx, 0, setorMovido);
            marcarAlteracao(); 
        }
    });
}
		function removerTombamentoIndividual(indexSetor, indexItem, tIndex) {
    const setorOrigem = arquiteturaAtiva[indexSetor];
    const itemOrigem = setorOrigem.itens[indexItem];
    
    // Remove o tombamento do array original
    const tombRemovido = itemOrigem.tombamentos.splice(tIndex, 1)[0];

    // --- CARIMBO DE ORIGEM: Fundamental para o Cancelar Estorno ---
    itensParaEstorno.push({
        uid_global: itemOrigem.uid_global,
        nome: itemOrigem.nome, // Importante para exibir na lista de estorno
        tipo: 'multi',
        tombamentos: [tombRemovido],
        setorOrigem: setorOrigem.nome // Salva o nome do setor para possível retorno
    });

    // Se o item ficou sem nenhum tombamento no setor, remove o objeto pai
    if (itemOrigem.tombamentos.length === 0) {
        arquiteturaAtiva[indexSetor].itens.splice(indexItem, 1);
    }

    marcarAlteracao();
    renderizarArquiteturaEditor();
    atualizarInterfaceEstorno();
}
		
// ================================================================
// 5. INTELIGÊNCIA: MESCLAGEM AUTOMÁTICA
// ================================================================
function processarMesclagemAutomatica(setorIndex) {
    const itens = arquiteturaAtiva[setorIndex].itens;
    const mapa = new Map();
    const novosItens = [];

    itens.forEach(item => {
        const chave = item.uid_global;

        if (mapa.has(chave)) {
            const existente = mapa.get(chave);
            
            if (item.tipo === 'single') {
                // Mesclagem de Consumo: Soma as quantidades
                existente.quantidadeEsperada = (Number(existente.quantidadeEsperada) || 0) + (Number(item.quantidadeEsperada) || 0);
            } else {
                // Mesclagem de Patrimônio: Une os arrays de tombamentos
                const tombamentosExistentes = existente.tombamentos || [];
                const novosTombamentos = item.tombamentos || [];

                // Desduplicação inteligente baseada no número do tombamento (tomb)
                novosTombamentos.forEach(novoT => {
                    const jaExiste = tombamentosExistentes.some(t => t.tomb === novoT.tomb);
                    if (!jaExiste) {
                        tombamentosExistentes.push(novoT);
                    }
                });
                
                existente.tombamentos = tombamentosExistentes;
                // A quantidade esperada em itens multi deve ser sempre o total de tombamentos vinculados
                existente.quantidadeEsperada = existente.tombamentos.length;
            }
        } else {
            // Se for a primeira vez que o item aparece no setor, registra no mapa
            // Fazemos um shallow copy para evitar mutações inesperadas em outros setores
            mapa.set(chave, item);
            novosItens.push(item);
        }
    });

    // Atualiza o estado global com a lista limpa e mesclada
    arquiteturaAtiva[setorIndex].itens = novosItens;
    
    // Renderiza a interface (onde os tombamentos aparecerão um abaixo do outro conforme configuramos)
    renderizarArquiteturaEditor();
    marcarAlteracao();
}

function marcarAlteracao() {
    const btn = document.querySelector('.btn-publish');
    if (!btn) return;

    // 1. Habilita o botão caso esteja desabilitado
    btn.disabled = false;

    // 2. Adiciona a classe de controle CSS
    btn.classList.add('modified');

    // 3. Feedback Visual Forte
    // Usamos um fundo laranja/âmbar para indicar que existem dados "pendentes" de gravação
    btn.style.backgroundColor = '#d97706'; 
    btn.style.color = 'white';
    btn.style.fontWeight = 'bold';

    // 4. Texto Dinâmico
    // O asterisco ajuda a indicar visualmente que o que está na tela não é o que está no banco
    btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publicar Alterações *';

    // 5. Animação (Opcional, mas recomendado)
    // Se você tiver uma animação de "pulse" no seu CSS, pode aplicar aqui
    btn.style.animation = 'pulse-orange 2s infinite';
}
// ================================================================
// 6. BUSCA INTELIGENTE NO ESTOQUE (AUTOCOMPLETE)
// ================================================================
function buscarItemParaAdicionar(termo) {
    const box = document.getElementById('sugestoes-estoque-editor');
    if (!box) return;
    
    if (termo.length < 2) { 
        box.style.display = 'none'; 
        return; 
    }

    const t = termo.toLowerCase().trim();
    const suggestions = [];

    estoqueGestorLocal.forEach(item => {
        const nomeMatch = item.nome.toLowerCase().includes(t);
        
        // ✅ CÁLCULO CIRÚRGICO: Quanto deste item já foi adicionado aos setores no rascunho?
        let qtdJaEscalada = 0;
        let tombamentosEmUsoNoRascunho = [];

        arquiteturaAtiva.forEach(setor => {
            (setor.itens || []).forEach(it => {
                if (it.uid_global === item.uid_global) {
                    if (item.tipo === 'multi') {
                        (it.tombamentos || []).forEach(tm => tombamentosEmUsoNoRascunho.push(tm.tomb));
                    } else {
                        qtdJaEscalada += Number(it.quantidadeEsperada || 0);
                    }
                }
            });
        });

        if (item.tipo === 'multi') {
            (item.tombamentos || []).forEach(tomb => {
                const tombNum = String(tomb.tomb || "");
                // ✅ FILTRO: Só sugere se não estiver na VTR (DB) E nem no rascunho atual (tela)
                if (!tomb.viatura_id && !tombamentosEmUsoNoRascunho.includes(tomb.tomb) && (nomeMatch || tombNum.toLowerCase().includes(t))) {
                    suggestions.push({ 
                        ...item, 
                        tombamentoExibicao: tomb.tomb, 
                        id_unico: `${item.id_almox}_${tomb.tomb}` 
                    });
                }
            });
        } else {
            // ✅ CÁLCULO: Saldo Real = Saldo do Almoxarifado - O que já está na tela
            const saldoRealDisponivel = item.disponivel - qtdJaEscalada;

            if (nomeMatch && saldoRealDisponivel > 0) {
                suggestions.push({ 
                    ...item, 
                    id_unico: item.id_almox,
                    disponivelReal: saldoRealDisponivel // Passamos o saldo abatido
                });
            }
        }
    });

    const matches = suggestions.slice(0, 10);
    window.tempSuggestionsSearch = matches; 

    if (matches.length === 0) {
        if (isModoVistoria) {
            box.innerHTML = `
                <div class="suggestion-item" onclick="prepararInclusaoTextoLivre('${termo.replace(/'/g, "\\'")}')" 
                     style="padding:15px; background:#f0f9ff; border:1px dashed #0369a1; border-radius:6px; cursor:pointer; text-align:center;">
                    <i class="fas fa-plus-circle" style="color:#0369a1;"></i>
                    <b style="color:#0369a1; font-size:0.9em; display:block;">Adicionar "${termo}"</b>
                    <small style="color:#64748b; font-size:0.75em;">Como item de vistoria técnica</small>
                </div>`;
        } else {
            box.innerHTML = '<div style="padding:15px; color:#94a3b8; text-align:center;">Sem saldo disponível.</div>';
        }
    } else {
        let htmlFinal = matches.map((i, index) => `
            <div class="suggestion-item" onclick="selecionarSugestaoPorIndex(${index})" 
                 style="display: flex !important; align-items: center !important; width: 100% !important; border-bottom: 1px solid #f1f5f9; padding: 10px 15px; cursor: pointer; background: white; gap: 12px; box-sizing: border-box;">
                <div style="flex-shrink: 0; width: 24px; display: flex; justify-content: center; align-items: center;">
                    <i class="fas ${i.tipo === 'multi' ? 'fa-tag' : 'fa-boxes'}" 
                       style="color: ${i.tipo === 'multi' ? '#800020' : '#2c7399'}; font-size: 1.1em; position: static !important; transform: none !important;"></i>
                </div>
                <div style="flex-grow: 1; display: flex; flex-direction: column; line-height: 1.2; overflow: hidden;">
                    <b style="font-size: 0.85em; color: #1e293b; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${i.nome}
                    </b>
                    <small style="color: #64748b; font-size: 0.72em; font-weight: 600;">
                        ${i.tipo === 'multi' ? 'TOMB: ' + i.tombamentoExibicao : 'SALDO RESTANTE: ' + i.disponivelReal}
                    </small>
                </div>
            </div>`).join('');

        if (isModoVistoria) {
            htmlFinal += `<div class="suggestion-item" onclick="prepararInclusaoTextoLivre('${termo.replace(/'/g, "\\'")}')" style="padding:10px; background:#fff8e1; border-top:2px solid #ffb300; cursor:pointer; text-align:center; margin-top:5px;"><span style="font-size:0.8em; color:#856404; font-weight:bold;">+ ADICIONAR COMO TEXTO LIVRE</span></div>`;
        }
        box.innerHTML = htmlFinal;
    }
    box.style.display = 'block';
}
		function prepararInclusaoTextoLivre(nomeDigitado) {
    const box = document.getElementById('sugestoes-estoque-editor');
    const inputBusca = document.getElementById('input-busca-estoque');

    // 1. Cria o objeto do item no formato que o seu editor espera
    const novoItemVistoria = {
        id_almox: "VISTORIA_" + Date.now(), // ID temporário único
        nome: nomeDigitado.toUpperCase(),
        tipo: "single",
        disponivel: 1,
        uid_global: "ITEM_VISTORIA_LIVRE",
        categoria: "VISTORIA"
    };

    // 2. Simula a seleção de uma sugestão para abrir o popover de quantidade/setor
    // Usamos a lógica que você já tem no sistema para manter a consistência
    window.tempSuggestionsSearch = [novoItemVistoria];
    selecionarSugestaoPorIndex(0);

    // 3. Limpa a interface de busca
    if (box) box.style.display = 'none';
    if (inputBusca) inputBusca.value = '';
    
    console.log("🛠️ Preparando inclusão de item de vistoria:", nomeDigitado);
}	

// Função de apoio para evitar passar JSON gigante no HTML
function selecionarSugestaoPorIndex(index) {
    const item = window.tempSuggestionsSearch[index];
    if (item) {
        // Esta função deve alimentar o itemSelecionadoTemp e fechar o box
        selecionarItemParaAdicionar(item); 
    }
}

let itemSelecionadoTemp = null;

// 7. SELEÇÃO COM MICRO-MODAL
function selecionarItemParaAdicionar(item) {
    if (!item) return;

    itemSelecionadoTemp = item;
    const boxSugestoes = document.getElementById('sugestoes-estoque-editor');
    const popover = document.getElementById('popover-qtd-editor');
    const inputBusca = document.getElementById('input-busca-estoque');
    const selectSetor = document.getElementById('select-setor-destino');

    if (boxSugestoes) boxSugestoes.style.display = 'none';

    if (item.tipo === 'single') {
        // ✅ CAPTURA: Usamos o saldo real (já abatido) calculado na busca
        const saldoFinal = item.disponivelReal;

        popover.style.position = 'absolute';
        popover.style.top = (inputBusca.offsetTop + inputBusca.offsetHeight + 5) + 'px';
        popover.style.left = inputBusca.offsetLeft + 'px'; 
        popover.style.display = 'block';
        popover.style.zIndex = '1000';
        
        const inputQtd = document.getElementById('input-qtd-popover');
        const infoMax = document.getElementById('info-max-popover');

        // ✅ TRAVA: O máximo permitido agora é o saldo após as deduções do rascunho
        inputQtd.max = saldoFinal;
        inputQtd.value = 1;
        if (infoMax) infoMax.textContent = `Saldo livre na tela: ${saldoFinal} un.`;

        // Atribuímos ao objeto temporário para validar no confirmarQtdPopover
        itemSelecionadoTemp.disponivel = saldoFinal;

        setTimeout(() => {
            inputQtd.focus();
            inputQtd.select();
        }, 50);

    } else {
        if (popover) popover.style.display = 'none';
        exibirDraftCard(`${item.nome} (TOMB: ${item.tombamentoExibicao})`);
        if (selectSetor) selectSetor.focus();
    }
}
// Função auxiliar cirúrgica para o visual moderno
function exibirDraftCard(texto) {
    const card = document.getElementById('rascunho-item-novo'); // ID ÚNICO PARA A BUSCA
    const label = document.getElementById('texto-item-rascunho');
    const iconPlus = document.getElementById('icon-plus-busca');

    if (card && label) {
        label.innerHTML = `<i class="fas fa-check-circle" style="color:#10b981"></i> ${texto}`;
        card.style.display = 'flex';
        if (iconPlus) iconPlus.style.visibility = 'hidden';
    }
}
		function confirmarQtdPopover() {
    const input = document.getElementById('input-qtd-popover');
    const qtd = parseInt(input.value);
    
    // ✅ SEGURANÇA: Captura o saldo real projetado (já abatido os itens da tela)
    // Se por algum motivo 'disponivelReal' não existir, usamos o 'disponivel' padrão.
    const saldoLimite = itemSelecionadoTemp.disponivelReal !== undefined ? 
                        itemSelecionadoTemp.disponivelReal : 
                        itemSelecionadoTemp.disponivel;

    if (isNaN(qtd) || qtd <= 0) {
        alert("Informe uma quantidade válida.");
        return;
    }
    
    // ✅ VALIDAÇÃO CIRÚRGICA: Impede que o usuário digite um valor maior do que 
    // o que sobrou no estoque físico após as alocações já feitas no editor.
    if (qtd > saldoLimite) {
        alert(`Quantidade indisponível para esta lista.\n\nSaldo Total: ${itemSelecionadoTemp.disponivel}\nJá alocado em outros setores: ${itemSelecionadoTemp.disponivel - saldoLimite}\nRestante disponível: ${saldoLimite}`);
        input.value = saldoLimite;
        input.focus();
        input.select();
        return;
    }

    // 3. Atribui a quantidade ao objeto temporário
    itemSelecionadoTemp.quantidadeEscolhida = qtd;

    // 4. Fecha o popover
    document.getElementById('popover-qtd-editor').style.display = 'none';

    // 5. Ativa o Card de Rascunho com o feedback visual
    exibirDraftCard(`${qtd}un. x ${itemSelecionadoTemp.nome}`);

    // 6. Foca no seletor de setor
    const selectSetor = document.getElementById('select-setor-destino');
    if (selectSetor) {
        selectSetor.focus();
        selectSetor.style.border = "2px solid #2c7399";
    }
}		

// ================================================================
// 7. ADIÇÃO DO ITEM AO SETOR ESCOLHIDO
// ================================================================
function adicionarItemRapido() {
    const selectSetor = document.getElementById('select-setor-destino');
    const setorIdx = selectSetor.value;
    const inputBusca = document.getElementById('input-busca-estoque');

    // 1. Validações de segurança
    if (!itemSelecionadoTemp) return alert("Selecione um item primeiro.");
    if (setorIdx === "") return alert("Escolha o setor de destino.");

    const novoItem = {
        uid_global: itemSelecionadoTemp.uid_global || itemSelecionadoTemp.id_almox,
        nome: itemSelecionadoTemp.nome,
        tipo: itemSelecionadoTemp.tipo,
        quantidadeEsperada: 0 
    };

    if (itemSelecionadoTemp.tipo === 'single') {
        const qtd = itemSelecionadoTemp.quantidadeEscolhida || 1;
        novoItem.quantidadeEsperada = qtd;
    } else {
        novoItem.tombamentos = [{
            tomb: itemSelecionadoTemp.tombamentoExibicao,
            situacao: "EM CARGA"
        }];
        novoItem.quantidadeEsperada = 1;
    }

    arquiteturaAtiva[setorIdx].itens.push(novoItem);
    
    // --- MUDANÇAS CIRÚRGICAS: LIMPEZA MODERNA ---
    cancelarRascunho(); // Limpa o card, o itemTemp e o botão
    
    if (selectSetor) {
        selectSetor.value = ""; 
        selectSetor.style.border = "1px solid #cbd5e1"; // Reseta a borda
    }
    
    processarMesclagemAutomatica(setorIdx);
    marcarAlteracao();
    inputBusca.focus(); 
}
/**
 * Cancela a seleção atual e reseta a interface de busca.
 */
function cancelarRascunho() {
    itemSelecionadoTemp = null;
    const card = document.getElementById('rascunho-item-novo');
    const iconPlus = document.getElementById('icon-plus-busca');
    const inputBusca = document.getElementById('input-busca-estoque');
    const selectSetor = document.getElementById('select-setor-destino'); // Referência ao select
    
    if (card) card.style.display = 'none';
    if (iconPlus) iconPlus.style.visibility = 'visible';
    
    if (inputBusca) {
        inputBusca.value = '';
        inputBusca.style.backgroundColor = "#fff"; // Garante limpeza de cores residuais
    }

    if (selectSetor) {
        selectSetor.value = ""; // Reseta o seletor para "Selecione o Setor..."
        selectSetor.style.border = "1px solid #cbd5e1"; // Remove destaques de foco
    }
}
// ================================================================
// 8. UTILITÁRIOS: ATUALIZAR SELECT E NOVO SETOR
// ================================================================
function atualizarSelectSetores() {
    const select = document.getElementById('select-setor-destino');
    select.innerHTML = '<option value="">Selecione o Setor...</option>' + 
        arquiteturaAtiva.map((s, idx) => `<option value="${idx}">${s.nome}</option>`).join('');
}

// 1. Abre o modal e carrega a "inteligência" de nomes
async function abrirModalNovoSetor() {
    const modal = document.getElementById('modal-novo-setor-arquitetura');
    const input = document.getElementById('input-nome-setor-modal');
    const containerTags = document.getElementById('setores-tags-container');
    
    input.value = '';
    modal.style.display = 'flex';
    input.focus();

    // Inteligência: Busca todos os nomes de setores já usados no sistema
    try {
        containerTags.innerHTML = '<small>Buscando padrões...</small>';
        const snap = await db.collection('listas_conferencia').get();
        const nomesSetores = new Set();
        
        // Nomes padrão de segurança
        ['CABINE', 'CARROCERIA', 'TETO', 'MOTOR'].forEach(n => nomesSetores.add(n));

        snap.forEach(doc => {
            const lista = doc.data().list || [];
            lista.forEach(s => nomesSetores.add(s.nome.toUpperCase()));
        });

        // Transforma o Set em Tags clicáveis (limitado a 10 sugestões mais comuns)
        const listaFinal = Array.from(nomesSetores).sort();
        containerTags.innerHTML = listaFinal.map(nome => `
            <span class="tag-sugestao-setor" onclick="selecionarTagSetor('${nome}')">${nome}</span>
        `).join('');

    } catch (e) {
        containerTags.innerHTML = '<small>Não foi possível carregar sugestões.</small>';
    }
}

// 2. Auxiliar para preencher o input via clique na tag
function selecionarTagSetor(nome) {
    document.getElementById('input-nome-setor-modal').value = nome;
    confirmarNovoSetor(); // Já confirma para agilizar
}

// 3. Valida e cria o setor no rascunho
function confirmarNovoSetor() {
    const nome = document.getElementById('input-nome-setor-modal').value.trim().toUpperCase();
    
    if (!nome) return alert("Digite um nome para o setor.");

    // Trava de duplicidade: Evita dois setores com mesmo nome na mesma VTR
    const existe = arquiteturaAtiva.some(s => s.nome === nome);
    if (existe) return alert("Este setor já existe nesta viatura.");

    arquiteturaAtiva.push({
        id: "setor_" + Date.now(),
        nome: nome,
        itens: []
    });

    renderizarArquiteturaEditor();
    atualizarSelectSetores();
    marcarAlteracao();
    fecharModalNovoSetor();
}

function fecharModalNovoSetor() {
    document.getElementById('modal-novo-setor-arquitetura').style.display = 'none';
}
function removerSetorArquitetura(idx) {
    const setor = arquiteturaAtiva[idx];
    
    if (setor.itens && setor.itens.length > 0) {
        if (!confirm(`O setor "${setor.nome}" contém ${setor.itens.length} tipo(s) de item(ns). Ao excluí-lo, todos os itens retornarão para o estoque. Confirmar?`)) {
            return;
        }

        // --- SEGURANÇA: MOVE TODOS OS ITENS COM CARIMBO DE ORIGEM ---
        setor.itens.forEach(item => {
            const baseItem = {
                uid_global: item.uid_global,
                nome: item.nome,
                tipo: item.tipo,
                setorOrigem: setor.nome // Permite desfazer mesmo se o setor sumir (vai para o 1º disponível)
            };

            if (item.tipo === 'multi') {
                itensParaEstorno.push({
                    ...baseItem,
                    tombamentos: [...(item.tombamentos || [])]
                });
            } else {
                itensParaEstorno.push({
                    ...baseItem,
                    quantidadeEsperada: item.quantidadeEsperada
                });
            }
        });
    }
    
    // Remove o setor do rascunho
    arquiteturaAtiva.splice(idx, 1);
    
    // Atualiza a interface completa
    renderizarArquiteturaEditor();
    if (typeof atualizarSelectSetores === 'function') atualizarSelectSetores();
    if (typeof atualizarInterfaceEstorno === 'function') atualizarInterfaceEstorno();
    
    marcarAlteracao();
}
		document.addEventListener('DOMContentLoaded', function() {
    const card = document.getElementById('container-item-rascunho');
    if (card) {
        card.style.display = 'none';
    }
});
// ================================================================
// 9. GESTÃO DA CAIXA DE SAÍDA (ESTORNOS)
// ================================================================
function marcarParaEstorno(setorIdx, itemIdx) {
    const itemAlvo = arquiteturaAtiva[setorIdx].itens[itemIdx];

    // LÓGICA CIRÚRGICA: Se for modo Vistoria (Checklist), remove direto sem ir para a caixa de saída
    if (window.isModoVistoria) {
    Swal.fire({
        title: 'Remover Item?',
        text: `Deseja remover "${itemAlvo.nome}" da vistoria?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#2c3e50', // Azul Petróleo
        confirmButtonText: 'Sim, remover',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            arquiteturaAtiva[setorIdx].itens.splice(itemIdx, 1);
            renderizarArquiteturaEditor();
            marcarAlteracao();
        }
    });
    return;
}

    // LÓGICA ORIGINAL: Para Materiais, move para a caixa de saída (estorno)
    const itemRemovido = arquiteturaAtiva[setorIdx].itens.splice(itemIdx, 1)[0];
    
    itensParaEstorno.push({
        ...itemRemovido,
        setorOrigem: arquiteturaAtiva[setorIdx].nome
    });

    const badge = document.getElementById('badge-estorno-count');
    if (badge) {
        badge.classList.add('badge-pulse');
        setTimeout(() => badge.classList.remove('badge-pulse'), 300);
    }

    atualizarInterfaceEstorno();
    renderizarArquiteturaEditor();
    marcarAlteracao();
    console.log(`Item ${itemRemovido.nome} movido para caixa de saída.`);
}
		
function atualizarInterfaceEstorno() {
    const dock = document.getElementById('caixa-estorno-dock');
    if (!dock) return;

    // ✅ O VIGILANTE: Se for modo Checklist, garante invisibilidade absoluta
    if (window.isModoVistoria === true) {
        dock.style.setProperty('display', 'none', 'important');
        
        // Bloqueia futuras tentativas de outras funções de mostrarem a caixa
        if (!dock.dataset.vigilanteAtivo) {
            const observer = new MutationObserver(() => {
                if (window.isModoVistoria && dock.style.display !== 'none') {
                    dock.style.setProperty('display', 'none', 'important');
                }
            });
            observer.observe(dock, { attributes: true, attributeFilter: ['style'] });
            dock.dataset.vigilanteAtivo = "true";
        }
        return; 
    }
	dock.dataset.vigilanteAtivo = "";

    const container = document.getElementById('lista-itens-estorno');
    const badge = document.getElementById('badge-estorno-count');
    
    if (!container || !badge) return;

    // Lógica para materiais (onde a caixa deve aparecer se houver itens)
    if (itensParaEstorno.length === 0) {
        dock.style.display = 'none';
        badge.textContent = "0";
        return;
    } else {
        dock.style.display = 'block';
    }

    badge.textContent = itensParaEstorno.length;

    container.innerHTML = itensParaEstorno.map((item, idx) => {
        const ehMulti = item.tipo === 'multi';
        let detalhe = ehMulti && item.tombamentos ? item.tombamentos.map(t => t.tomb).join(', ') : item.quantidadeEsperada + ' unidades';

        return `
            <div class="item-estorno-linha" style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f1f5f9; background: #fffaf0; margin-bottom: 5px; border-radius: 6px;">
                <div style="flex:1; padding-right: 10px;">
                    <b style="font-size:0.85em; display:block; color:#334155; text-transform: uppercase;">${item.nome || 'Material'}</b>
                    <small style="color:#e65100; font-weight:700; font-size: 0.75em; display: block; line-height: 1.2;">
                        ${ehMulti ? '<i class="fas fa-tag"></i> TOMB: ' + detalhe : '<i class="fas fa-boxes"></i> QTD: ' + detalhe}
                    </small>
                </div>
                <button onclick="cancelarEstorno(${idx})" class="btn-remove-item-vtr" style="background: #f1f5f9!important; color: #64748b!important; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                    <i class="fas fa-undo" style="font-size:0.8em;"></i>
                </button>
            </div>`;
    }).reverse().join(''); 
}
			function toggleEstornoDock() {
    const dock = document.getElementById('caixa-estorno-dock');
    if (!dock) {
        console.error("❌ Erro: Elemento 'caixa-estorno-dock' não encontrado no HTML.");
        return; 
    }

    const icon = dock.querySelector('.toggle-icon');
    
    // Inverte a classe de expansão
    dock.classList.toggle('expanded');
    
    // Sincroniza o ícone (seta para cima/baixo)
    if (icon) {
        if (dock.classList.contains('expanded')) {
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        } else {
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        }
    }
}

function cancelarEstorno(idx) {
    // 1. Remove da lista de estorno (Caixa de Saída)
    const item = itensParaEstorno.splice(idx, 1)[0];
    if (!item) return;

    // 2. Localiza o setor de destino
    // Tenta pelo nome original ou cai no primeiro setor disponível
    let setorDestino = arquiteturaAtiva.find(s => s.nome === item.setorOrigem) || arquiteturaAtiva[0];

    if (setorDestino) {
        // 3. Devolve o item para a memória da arquitetura
        if (!setorDestino.itens) setorDestino.itens = [];
        setorDestino.itens.push(item);
        
        // 4. ESSENCIAL: Mesclagem automática
        // Evita que o item apareça duplicado se já existir um do mesmo tipo no setor
        const sIdx = arquiteturaAtiva.indexOf(setorDestino);
        processarMesclagemAutomatica(sIdx);
        
        console.log(`✅ Item "${item.nome}" restaurado no setor "${setorDestino.nome}".`);
    } else {
        alert("Não há setores disponíveis para restaurar o item.");
        itensParaEstorno.splice(idx, 0, item); // Devolve para a caixa de saída em caso de erro
        return;
    }
    
    // 5. Sincronização Total da UI
    atualizarInterfaceEstorno();
    renderizarArquiteturaEditor();
    marcarAlteracao();
}

// ================================================================
// 10. PUBLICAÇÃO FINAL (GRAVAÇÃO NO FIREBASE)
// ================================================================
async function confirmarPublicacaoLista() {
    if (!confirm("Deseja publicar as alterações? Isso atualizará a lista e ajustará o saldo do estoque.")) return;

    const firestore = firebase.firestore();
	const elNome = document.getElementById('edit-vtr-nome');
    const nomeAmigavelVtr = elNome ? (elNome.innerText || elNome.textContent).split('\n').pop().trim() : "Viatura";
    const justificativa = document.getElementById('justificativa-estorno-global').value.trim();
    const unidadeGestoraId = currentUserData.unidade_id || (typeof dados !== 'undefined' ? dados.unidade_id : null);

    const estornosReais = itensParaEstorno.filter(i => i.uid_global !== "ITEM_VISTORIA_LIVRE");

    if (estornosReais.length > 0 && !justificativa) {
        alert("Para devolver materiais ao estoque, preencha a justificativa.");
        document.getElementById('justificativa-estorno-global').focus();
        return;
    }

    const btn = document.querySelector('.btn-publish');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Publicando...';

    try {
        const batch = firestore.batch();
        const listaRef = firestore.collection(window.colecaoAtivaNoEditor).doc(idListaSendoEditada);
        const snapLista = await listaRef.get();
        const listaAnterior = snapLista.exists ? (snapLista.data().list || []) : [];
        
        // 1. MAPEIA ESTADO ANTERIOR
        const mapaAnterior = {};
        listaAnterior.forEach(setor => {
            (setor.itens || []).forEach(it => { 
                mapaAnterior[it.uid_global] = (mapaAnterior[it.uid_global] || 0) + (Number(it.quantidadeEsperada) || 0); 
            });
        });

        // 2. IDENTIFICA MUDANÇAS LÍQUIDAS NA ARQUITETURA ATIVA
        const mapaAtual = {};
        arquiteturaAtiva.forEach(setor => {
            (setor.itens || []).forEach(it => {
                if (it.uid_global !== "ITEM_VISTORIA_LIVRE") {
                    mapaAtual[it.uid_global] = (mapaAtual[it.uid_global] || 0) + (Number(it.quantidadeEsperada) || 0);
                }
            });
        });

        // --- A. ATUALIZA A ESTRUTURA DA LISTA ---
        batch.update(listaRef, {
            list: arquiteturaAtiva,
            ultima_edicao_arquitetura: firebase.firestore.FieldValue.serverTimestamp(),
            editado_por: currentUserData.nome_militar_completo
        });

        const idEvento = "EDT-" + Date.now();
        const dataReg = new Date().toLocaleString('pt-BR');

        // --- B. PROCESSA LOGÍSTICA DE INVENTÁRIO ---

        // B1. SAÍDAS E ENTRADAS PROPORCIONAIS (Itens Single)
        // Comparamos o total que havia na lista vs o total que há agora
        const todosUids = new Set([...Object.keys(mapaAnterior), ...Object.keys(mapaAtual)]);
        
        for (const uid of todosUids) {
            const qtdAnt = mapaAnterior[uid] || 0;
            const qtdAtu = mapaAtual[uid] || 0;
            const diferenca = qtdAtu - qtdAnt; // Positivo = saiu do estoque | Negativo = voltou

            if (diferenca !== 0) {
                const itemDoc = estoqueGestorLocal.find(i => i.uid_global === uid);
                if (itemDoc && itemDoc.tipo === 'single') {
                    const saldoRef = firestore.collection('inventario').doc(uid).collection('saldos_unidades').doc(unidadeGestoraId);
                    batch.update(saldoRef, {
                        qtd_disp: firebase.firestore.FieldValue.increment(-diferenca),
                        qtd_em_carga: firebase.firestore.FieldValue.increment(diferenca),
                        last_update: dataReg
                    });
                }
            }
        }

        // B2. PROCESSA ITENS MULTI (Tombamentos Novos)
        arquiteturaAtiva.forEach(setor => {
            (setor.itens || []).forEach(item => {
                if (item.tipo === 'multi' && item.uid_global !== "ITEM_VISTORIA_LIVRE") {
                    // Verifica se este item/tombamento já existia na lista anterior
                    // Se é novo (não estava no mapaAnterior), atualiza o prontuário
                    (item.tombamentos || []).forEach(t => {
                        const itemRef = firestore.collection('inventario').doc(item.uid_global);
                        const tombRef = itemRef.collection('tombamentos').doc(t.tomb);
                        
                        batch.update(tombRef, {
                            situacao_atual: "EM CARGA",
                            viatura_id: idListaSendoEditada,
                            sub_local: setor.nome
                        });
                        batch.set(tombRef.collection('historico_vida').doc(idEvento), {
                            data: dataReg, evento: "SAIDA_EDITOR", quem: currentUserData.nome_militar_completo,
                            detalhes: `Alocado no setor ${setor.nome} da lista ${nomeAmigavelVtr}.`
                        });
                    });
                }
            });
        });

        // B3. PROCESSA ESTORNOS (Itens Multi que voltaram ao estoque)
        for (const item of estornosReais) {
            if (item.tipo === 'multi') {
                const itemRef = firestore.collection('inventario').doc(item.uid_global);
                for (const t of (item.tombamentos || [])) {
                    const tombRef = itemRef.collection('tombamentos').doc(t.tomb);
                    batch.update(tombRef, {
                        situacao_atual: "DISPONÍVEL",
                        viatura_id: null,
                        sub_local: "ALMOXARIFADO"
                    });
                    batch.set(tombRef.collection('historico_vida').doc(idEvento), {
                        data: dataReg, evento: "ESTORNO_EDITOR", quem: currentUserData.nome_militar_completo,
                        detalhes: `Removido da lista ${nomeAmigavelVtr}. Motivo: ${justificativa}`
                    });
                }
            }
            // Nota: Itens Single removidos já são tratados pelo cálculo de diferença no passo B1
        }

        await batch.commit();
        await Swal.fire({ icon: 'success', title: 'Publicado!', text: 'Inventário atualizado com sucesso.', timer: 2000, showConfirmButton: false });
        location.reload(); 

    } catch (e) {
        console.error("Erro na publicação:", e);
        alert("Falha ao salvar: " + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Tentar Novamente';
    }
}	
		// Fecha as caixas de busca e popover ao clicar fora delas
		document.addEventListener('keydown', function (event) {
    		// 1. Tratamento da tecla ESC
    		if (event.key === 'Escape') {
		        fecharBuscaELimpar();
    		}
		});

document.addEventListener('mousedown', function (event) {
    const buscaBox = document.getElementById('sugestoes-estoque-editor');
    const inputBusca = document.getElementById('input-busca-estoque');
    const popoverQtd = document.getElementById('popover-qtd-editor');

    // 2. Se a caixa de sugestões estiver aberta e o clique for fora dela e do input
    if (buscaBox && !buscaBox.contains(event.target) && event.target !== inputBusca) {
        if (buscaBox.style.display === 'block') {
            fecharBuscaELimpar();
        }
    }

    // 3. Se o popover de quantidade estiver aberto e o clique for fora dele
    if (popoverQtd && !popoverQtd.contains(event.target) && event.target !== inputBusca) {
        if (popoverQtd.style.display === 'block') {
            popoverQtd.style.display = 'none';
            itemSelecionadoTemp = null; 
            if (inputBusca) inputBusca.value = ''; // Limpa ao cancelar a quantidade também
        }
    }
});

/**
 * Função auxiliar para evitar repetição de código
 */
function fecharBuscaELimpar() {
    const buscaBox = document.getElementById('sugestoes-estoque-editor');
    const inputBusca = document.getElementById('input-busca-estoque');
    
    if (buscaBox) buscaBox.style.display = 'none';
    if (inputBusca) {
        inputBusca.value = '';
        inputBusca.blur(); // Remove o cursor do campo
    }
}
		// INSIRA ESTE BLOCO PARA DAR VIDA AO SELECT
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'select-setor-destino') {
        const setorIdx = e.target.value;

        // Se existe um item "carimbado" aguardando destino e um setor válido foi escolhido
        if (itemSelecionadoTemp && setorIdx !== "") {
            
            // Se for multi, já adiciona direto. 
            // Se for single, verifica se a quantidade já foi escolhida no popover
            if (itemSelecionadoTemp.tipo === 'multi' || (itemSelecionadoTemp.tipo === 'single' && itemSelecionadoTemp.quantidadeEscolhida > 0)) {
                adicionarItemRapido(); 
            }
        }
    }
});
		async function atualizarIdentidadeSidebar() {
    if (!currentUserData) return;

    const logoContainer = document.getElementById('unit-logo-container');
    const badgeWrapper = document.getElementById('badge-wrapper');
    const siglaUnidade = currentUserData.unidade || "SIGMA";
    const role = currentUserData.role || "operacional";

    // 1. LÓGICA DO BRASÃO CIRCULAR
    if (currentUserData.unidade_logo_url) {
        logoContainer.innerHTML = `<img src="${currentUserData.unidade_logo_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);">`;
    } else {
        // Fallback: Iniciais em Círculo Perfeito
        logoContainer.innerHTML = `
            <div style="width: 60px; height: 60px; background: #800020; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.3em; box-shadow: 0 4px 8px rgba(0,0,0,0.15); border: 2px solid rgba(255,255,255,0.2);">
                ${siglaUnidade.substring(0, 3).toUpperCase()}
            </div>`;
    }

    // 2. LÓGICA DO BADGE TRANSLÚCIDO (Mantida)
    const roleMap = {
        'admin': 'Administrador Geral',
        'gestor': 'Gestor de Unidade',
        'operacional': 'Operacional'
    };
    const nomeRole = roleMap[role] || role.toUpperCase();
    const classeBadge = `badge-${role.replace('_', '-')}`;
    badgeWrapper.innerHTML = `<div class="user-level-badge ${classeBadge}">${nomeRole}</div>`;
}
		async function prepararChecklistVtr() {
    dadosChecklistTemp.vtr = null; // Reseta seleção ao abrir
    const recentes = JSON.parse(localStorage.getItem(`sigma_vtr_recentes_${currentUserData.uid}`)) || [];
    
    let htmlRecentes = recentes.map(v => `
        <span class="badge-vtr-recente" onclick="recuperarDadosVtrESelecionar('${v.id}')">
            ${v.prefixo}
        </span>`).join('');

    Swal.fire({
        title: '<i class="fas fa-clipboard-check"></i> Checklist de Viatura',
        backdrop: `rgba(0,0,0,0.6)`,
        target: 'body',
        allowOutsideClick: false,
        showConfirmButton: false,
        showCancelButton: true,
        cancelButtonText: 'Sair',
        html: `
            <div id="checklist-stepper" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0 40px; position: relative;">
                <div style="position: absolute; top: 15px; left: 60px; right: 60px; height: 2px; background: #ddd; z-index: 1;"></div>
                <div id="step-1-icon" style="z-index: 2; text-align: center;">
                    <div class="step-dot" style="width: 30px; height: 30px; border-radius: 50%; background: #800020; color: white; line-height: 30px; margin: 0 auto; border: 3px solid #fff; box-shadow: 0 0 8px rgba(128,0,32,0.4);">1</div>
                    <small style="color: #800020; font-weight: bold; display: block; margin-top: 5px;">Viatura</small>
                </div>
                <div id="step-2-icon" style="z-index: 2; text-align: center;">
                    <div class="step-dot" style="width: 30px; height: 30px; border-radius: 50%; background: #ccc; color: white; line-height: 30px; margin: 0 auto; border: 3px solid #fff;">2</div>
                    <small style="color: #999; font-weight: bold; display: block; margin-top: 5px;">Dados</small>
                </div>
            </div>

            <div id="checklist-step-container" style="overflow: hidden; position: relative; min-height: 300px;">
                
                <div id="step-1-content" style="transition: all 0.4s ease; width: 100%;">
                    <div id="area-busca-vtr" style="text-align: left;">
                        <label style="font-size: 0.85em; font-weight:bold; color:#800020;">LOCALIZAR PREFIXO OU PLACA:</label>
                        <input type="text" id="input-busca-vtr-global" class="swal2-input" placeholder="Digite..." style="text-transform: uppercase; width: 100%; margin: 10px 0;">
                        <div id="container-recentes" style="margin-top: 10px; ${recentes.length ? '' : 'display:none;'}">
                            <small style="color: #999; display: block; margin-bottom: 5px;">Acesso Rápido:</small>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">${htmlRecentes}</div>
                        </div>
                        <div id="resultados-busca-vtr" style="margin-top: 15px; max-height: 180px; overflow-y: auto;"></div>
                    </div>

                    <div id="resumo-selecao-vtr" style="display:none;"></div>

                    <button id="btn-proximo-step" class="btn-iniciar-check-modal" style="display:none;" onclick="avancarParaEtapa2()">
                        PRÓXIMO <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <div id="step-2-content" style="display:none; transition: all 0.4s ease; width: 100%; text-align: left;">
                    <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="font-weight: bold; color: #800020; font-size: 0.85em;">QUILOMETRAGEM ATUAL (KM):</label>
                            <input type="text" id="vtr-km-check" class="swal2-input" style="width: 100%; margin: 5px 0; font-weight: bold; text-align: center;" inputmode="numeric">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: bold; color: #800020; font-size: 0.85em;">NÍVEL DE COMBUSTÍVEL:</label>
                            <select id="vtr-combustivel-check" class="swal2-select" style="width: 100%; margin: 5px 0; font-weight: bold;">
    							<option value="reserva">⛽  ⚠️  RESERVA</option>
    							<option value="1/4">⛽  ▂      1/4 (UM QUARTO)</option>
    							<option value="1/2" selected>⛽  ▄      1/2 (MEIO TANQUE)</option>
    							<option value="3/4">⛽  ▆      3/4 (TRÊS QUARTOS)</option>
    							<option value="cheio">⛽  █      FULL (TANQUE CHEIO)</option>
							</select>
                        </div>
                    </div>
                    <button class="btn-iniciar-check-modal" style="margin-top: 20px;" onclick="finalizarPreCheckEIrProApp()">
                        INICIAR INSPEÇÃO
                    </button>
                    <button style="background:none; border:none; color:#64748b; cursor:pointer; width:100%; margin-top:10px; font-size:0.8em; text-decoration:underline;" onclick="voltarParaEtapa1()">
                        <i class="fas fa-arrow-left"></i> Voltar para seleção
                    </button>
                </div>
            </div>
        `,
        didOpen: () => {
            const inputBusca = document.getElementById('input-busca-vtr-global');
            inputBusca.focus();
            inputBusca.addEventListener('input', (e) => filtrarVtrsGlobais(e.target.value));
        }
    });
}
		function avancarParaEtapa2() {
    const step1 = document.getElementById('step-1-content');
    const step2 = document.getElementById('step-2-content');
    
    // Transição de Slide
    step1.style.transform = "translateX(-110%)";
    setTimeout(() => {
        step1.style.display = "none";
        step2.style.display = "block";
        step2.style.transform = "translateX(110%)";
        step2.offsetHeight;
        step2.style.transform = "translateX(0)";
        
        // 1. Sugere o KM e configura a Máscara
        const kmInput = document.getElementById('vtr-km-check');
        const kmAnterior = dadosChecklistTemp.vtr.km_atual || 0;
        
        if(kmInput) {
            // Exibe o KM anterior formatado como sugestão inicial
            kmInput.value = kmAnterior.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            
            // Aplica a máscara enquanto digita
            kmInput.addEventListener('input', function(e) {
                // Remove tudo que não é número
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 1) v = parseInt(v).toString();
				v = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                // Formata com pontos de milhar
                e.target.value = v;
            });
        }
    }, 200);

    // Atualiza Stepper (Cores)
    const dot1 = document.querySelector('#step-1-icon .step-dot');
    const dot2 = document.querySelector('#step-2-icon .step-dot');
    dot1.style.background = "#1b8a3e";
    dot1.innerHTML = '<i class="fas fa-check" style="font-size:10px;"></i>';
    dot2.style.background = "#800020";
    document.querySelector('#step-2-icon small').style.color = "#800020";
}

function voltarParaEtapa1() {
    const step1 = document.getElementById('step-1-content');
    const step2 = document.getElementById('step-2-content');

    step2.style.transform = "translateX(110%)";
    setTimeout(() => {
        step2.style.display = "none";
        step1.style.display = "block";
        step1.style.transform = "translateX(-110%)";
        step1.offsetHeight;
        step1.style.transform = "translateX(0)";
    }, 200);

    // Reseta Stepper
    const dot1 = document.querySelector('#step-1-icon .step-dot');
    const dot2 = document.querySelector('#step-2-icon .step-dot');
    dot1.style.background = "#800020";
    dot1.innerHTML = '1';
    dot2.style.background = "#ccc";
    dot2.style.boxShadow = "none";
    document.querySelector('#step-2-icon small').style.color = "#999";
}
		
		async function recuperarDadosVtrESelecionar(vtrId) {
    try {
        const doc = await db.collection('viaturas').doc(vtrId).get();
        if (doc.exists) {
            const v = doc.data();
            selecionarVtrVisual(doc.id, v.prefixo, v.placa, v.unidade_atual_nome, v.ultima_conferencia);
        }
    } catch (e) { console.error("Erro ao recuperar recente:", e); }
}
		function resetarBuscaVtr() {
    dadosChecklistTemp.vtr = null;
    document.getElementById('area-busca-vtr').style.display = 'block';
    document.getElementById('resumo-selecao-vtr').style.display = 'none';
    document.getElementById('btn-proximo-step').style.display = 'none'; // Some com o botão
    setTimeout(() => document.getElementById('input-busca-vtr-global').focus(), 100);
}
		
		function selecionarVtrVisual(id, prefixo, placa, unidade, ultimaConf) {
    // 1. Guarda os dados no objeto global temporário
    dadosChecklistTemp.vtr = { id, prefixo, placa, unidade, km_atual: 0 }; 
    
    // Busca o KM atual se disponível no cache de busca ou objeto
    // (Ajuste: tentamos pegar de onde o Firestore retornou)
    const containerBusca = document.getElementById('area-busca-vtr');
    const containerResumo = document.getElementById('resumo-selecao-vtr');
    const btnProximo = document.getElementById('btn-proximo-step');

    // 2. Limpeza Visual: Esconde o buscador e os recentes
    if (containerBusca) containerBusca.style.display = 'none';
    document.getElementById('input-busca-vtr-global').value = '';

    // 3. Monta o Card de Resumo (O militar confirma o que escolheu)
    let infoUltima = "Nenhuma checagem registrada";
    if (ultimaConf && ultimaConf.data) {
        const dataFmt = new Date(ultimaConf.data).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
        infoUltima = `Último check: ${dataFmt} por ${ultimaConf.usuario_nome || 'Sistema'}`;
    }

    containerResumo.innerHTML = `
        <div class="vtr-selected-summary" style="border-color: #1b8a3e;">
            <i class="fas fa-check-circle" style="color:#1b8a3e; font-size:1.2em; margin-bottom:10px;"></i>
            <p>Viatura Selecionada</p>
            <h2>${prefixo}</h2>
            <div style="margin-top:5px; color:#475569; font-size:0.85em; font-weight:bold;">
                ${placa} | ${unidade || 'PÁTIO'}
            </div>
            <div class="last-check-info">
                <i class="fas fa-history"></i> ${infoUltima}
            </div>
        </div>
        
        <button style="background:none; border:none; color:#2c7399; cursor:pointer; width:100%; margin-top:10px; font-size:0.8em; text-decoration:underline;" onclick="resetarBuscaVtr()">
            Trocar viatura selecionada
        </button>
    `;
    containerResumo.style.display = 'block';

    // 4. MOSTRA O BOTÃO PRÓXIMO
    if (btnProximo) {
        btnProximo.style.setProperty('display', 'block', 'important');
        btnProximo.innerHTML = `PRÓXIMO <i class="fas fa-arrow-right"></i>`;
    }
}
		
		// 2. FUNÇÃO QUE VALIDA E LANÇA O APP DE CONFERÊNCIA
function finalizarPreCheckEIrProApp() {
    const kmInput = document.getElementById('vtr-km-check');
    const kmDigitado = parseInt(kmInput.value.replace(/\D/g, '')) || 0;
    const kmAnterior = dadosChecklistTemp.vtr.km_atual || 0;
    const combustivel = document.getElementById('vtr-combustivel-check').value;

    if (kmDigitado === 0) {
        Swal.showValidationMessage("Por favor, informe a quilometragem atual.");
        kmInput.style.borderColor = "red";
        return;
    }

    if (kmDigitado < kmAnterior) {
        const kmAnteriorFmt = kmAnterior.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        Swal.showValidationMessage(`Erro: O KM não pode ser menor que o atual (${kmAnteriorFmt} km)`);
        kmInput.style.borderColor = "red";
        return;
    }

    // ✅ CORREÇÃO CIRÚRGICA: Montagem do ID Completo (Prefixo + ID)
    const { id, prefixo } = dadosChecklistTemp.vtr;
    const idCompletoChecklist = `CHECKLIST_VTR_${id}`;
    
    const userUid = firebase.auth().currentUser.uid;
    const guerra = (currentUserData.nome_guerra || 'ND').toUpperCase();
    const posto = (currentUserData.posto || 'ND');
    const quadro = (currentUserData.quadro || 'ND');

    // ✅ URL PADRONIZADA (Mesmos nomes de parâmetros da função de Material)
    const url = `conferencia_app.html?id=${idCompletoChecklist}` +
                `&prefixo=${encodeURIComponent(prefixo)}` +
                `&km=${kmDigitado}` +
                `&combustivel=${encodeURIComponent(combustivel)}` +
                `&modo=checklist_vtr` +
                `&posto_grad=${encodeURIComponent(posto)}` +
                `&quadro_mil=${encodeURIComponent(quadro)}` +
                `&nome_guerra=${encodeURIComponent(guerra)}` +
                `&user_uid=${userUid}`;

    Swal.close();
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (container && iframe) {
        iframe.src = url;
        container.style.display = 'block';
    }

    console.log("Vistoria Iniciada com Sucesso:", { prefixo, idCompletoChecklist });
}
		
		async function filtrarVtrsGlobais(termo) {
    const container = document.getElementById('resultados-busca-vtr');
    const busca = termo.replace(/[^A-Z0-9]/gi, '').toLowerCase();

    if (busca.length < 2) {
        container.innerHTML = '';
        return;
    }

    const snap = await db.collection('viaturas')
        .where('search_key', '>=', busca)
        .where('search_key', '<=', busca + '\uf8ff')
        .limit(5)
        .get();

    if (snap.empty) {
        container.innerHTML = '<p style="font-size:0.8em; color:#999; text-align:center;">Viatura não cadastrada.</p>';
        return;
    }

    let html = '';
    snap.forEach(doc => {
        const v = doc.data();
        // Escapando strings para evitar erros no onclick
        const vData = JSON.stringify(v.ultima_conferencia || {}).replace(/"/g, '&quot;');
        
        html += `
            <div class="result-vtr-card" onclick="selecionarVtrVisual('${doc.id}', '${v.prefixo}', '${v.placa}', '${v.unidade_atual_nome}', ${vData})">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span><i class="fas fa-truck-pickup"></i> <b>${v.prefixo}</b></span>
                    <small style="color:#2c7399; font-weight:bold;">${v.placa}</small>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}
		
		function selecionarVtrBusca(id, prefixo) {
    // 1. Salva nos recentes do usuário
    const key = `sigma_vtr_recentes_${currentUserData.uid}`;
    let recentes = JSON.parse(localStorage.getItem(key)) || [];
    recentes = recentes.filter(v => v.id !== id); // Remove se já existe
    recentes.unshift({ id, prefixo }); // Adiciona no topo
    localStorage.setItem(key, JSON.stringify(recentes.slice(0, 4))); // Mantém os 4 últimos

    // 2. Fecha o modal e inicia o fluxo (Ponto 3 da nossa conversa)
    Swal.close();
    alert(`Iniciando Checklist da VTR ${prefixo}...`);
    // Aqui chamaremos o conferencia_app.html futuramente
}
		async function gerenciarChecklistVtr(vtrId, prefixo) {
    const checklistId = `CHECKLIST_VTR_${vtrId}`;
    const colecaoAlvo = 'listas_checklist';
    
    // ✅ GARANTIA DE INSTÂNCIA
    const firestore = window.db || db; 
    
    console.log("🚀 Iniciando gestão de checklist para:", checklistId);
    
    try {
        // 1. Validação da Viatura no cadastro global
        const vtrDoc = await firestore.collection('viaturas').doc(vtrId).get();
        if (!vtrDoc.exists) return alert("Erro: Viatura não localizada no cadastro global.");
        const vtrData = vtrDoc.data();

        // 2. Verificação de existência da lista de checklist
        const docRef = firestore.collection(colecaoAlvo).doc(checklistId);
        const snapChecklist = await docRef.get();

        if (!snapChecklist.exists) {
            console.log("📋 Criando novo checklist baseado no template padrão...");
            
            // Busca o template definido pela administração
            const templateDoc = await firestore.collection('config_checklists').doc('vtr_padrao').get();
            if (!templateDoc.exists) throw new Error("Template 'vtr_padrao' não encontrado no banco.");
            const template = templateDoc.data();

            // Mapeia os setores e itens do template para a nova lista da viatura
            const novaListaFormatada = template.setores.map(setor => ({
                id: "setor_" + Date.now() + Math.random().toString(36).substr(2, 5),
                nome: setor.nome,
                itens: setor.itens.map(it => {
                    const isObjeto = (typeof it === 'object' && it !== null);
                    const nomeFinal = isObjeto ? it.nome : it;
                    const tipoFinal = isObjeto ? (it.tipo || 'single') : 'single';
                    const idSeguro = nomeFinal.replace(/\s+/g, '_').toUpperCase();

                    return {
                        id: "item_" + Math.random().toString(36).substr(2, 9),
                        nome: nomeFinal.toUpperCase(),
                        tipo: tipoFinal,
                        quantidadeEsperada: 1,
                        uid_global: "ITEM_VISTORIA_LIVRE",
                        referencia_template: idSeguro,
                        categoria: "VISTORIA",
                        ...(isObjeto ? it : {}) 
                    };
                })
            }));

            // Grava a estrutura inicial
            await docRef.set({
                uid: checklistId,
                ativo_id: vtrId,
                ativo_nome: prefixo,
                unidade_id: vtrData.unidade_atual_id || vtrData.unidade_id || "", 
                unidade_sigla: vtrData.unidade_atual_nome || vtrData.unidade_sigla || "N/D",
                posto_nome: "PÁTIO / MANUTENÇÃO",
                ativo: true,
                tipo: 'checklist_viatura',
                list: novaListaFormatada,
                criado_em: firebase.firestore.FieldValue.serverTimestamp(),
                criado_por: currentUserData.nome_militar_completo
            });
        }

        // 3. TRANSIÇÃO PARA O EDITOR SIGMA V3
        
        // Define estados globais para o comportamento do editor
        window.isModoVistoria = true; 
        window.colecaoAtivaNoEditor = colecaoAlvo;

        // Fecha o modal de detalhes do SweetAlert antes de mudar a tela
        if (Swal.isVisible()) Swal.close(); 

        // Muda a visualização para o editor
        switchView('editor-arquitetura'); 

        // Ajuste de layout: remove padding lateral para foco total no editor
        const contentPrincipal = document.querySelector('.content');
        if (contentPrincipal) contentPrincipal.style.padding = '0px';

        // 4. ABERTURA DO EDITOR DE ITENS
        // Timeout para garantir que o DOM da view 'editor-arquitetura' esteja pronto
        setTimeout(async () => {
            console.log("🛠️ Abrindo interface do editor...");
            await abrirModalEditorItens(checklistId, prefixo, colecaoAlvo);
        }, 400);

    } catch (error) {
        console.error("❌ Erro crítico no gerenciarChecklistVtr:", error);
        Swal.fire({
            icon: 'error',
            title: 'Falha no Processo',
            text: error.message,
            confirmButtonColor: '#800020'
        });
    }
}
async function carregarAlertasTransferencia() {
    const container = document.getElementById('resume-container');
    
    // Verifica se os dados básicos existem
    if (!currentUserData || !currentUserData.unidade_id) {
        // Se ainda não carregou, não exibe erro, apenas sai silenciosamente 
        // pois o setTimeout ou o switchView tentarão novamente.
        return;
    }

    // Se o usuário for Operacional, ele não recebe carga (geralmente), 
    // então paramos aqui para poupar processamento
    if (currentUserData.role === 'operacional') return;

    try {
        const minhaUnidadeId = currentUserData.unidade_id;
        
        const snap = await db.collection('transferencias_pendentes')
            .where('destino_id', '==', minhaUnidadeId)
            .where('status', '==', 'EM_TRANSITO')
            .get();

        if (snap.empty) {
            console.log("Nenhuma carga em trânsito para a unidade:", minhaUnidadeId);
            return;
        }

        // Se chegou aqui, há carga. Remove duplicados e insere.
        const alertaExistente = document.getElementById('alerta-carga-transito');
        if (alertaExistente) alertaExistente.remove();

        const alertaHtml = `
            <div id="alerta-carga-transito" class="op-card resume" style="background-color: #fff8e1; border-left-color: #f57c00; margin-bottom: 20px; animation: fadeIn 0.5s ease;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-truck-loading fa-2x" style="color: #f57c00;"></i>
                    <div style="flex: 1; text-align: left;">
                        <h3 style="margin: 0; color: #e65100; font-size: 1.1em;">Carga em Trânsito</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">
                            Existem <b>${snap.size}</b> guias aguardando conferência nesta unidade.
                        </p>
                    </div>
                    <button class="btn-modern-action" style="background-color: #f57c00 !important;" onclick="abrirListaRecebimentoCarga()">
                        <i class="fas fa-clipboard-check"></i> Conferir
                    </button>
                </div>
            </div>`;

       if (container) {
    		const alertaAntigo = document.getElementById('alerta-carga-transito');
    		if (alertaAntigo) alertaAntigo.remove(); // Limpa apenas o dele, se houver
    
    		container.insertAdjacentHTML('afterbegin', alertaHtml); // Insere no topo sem apagar os outros
		}

    } catch (e) {
        console.error("Erro na busca de transferências:", e);
    }
}
		async function abrirListaRecebimentoCarga() {
    const minhaUnidadeId = currentUserData.unidade_id;
    const snap = await db.collection('transferencias_pendentes')
        .where('destino_id', '==', minhaUnidadeId)
        .where('status', '==', 'EM_TRANSITO')
        .get();

    if (snap.empty) {
        Swal.fire('Informação', 'Nenhuma carga em trânsito para sua unidade.', 'info');
        return;
    }

    let htmlLista = '<div style="text-align: left; max-height: 350px; overflow-y: auto; padding: 5px;">';
    
    snap.forEach(doc => {
        const tr = doc.data();
        
        // 1. Lógica do Número da Guia (TR-AAAA / Prefixo do ID)
        const ano = tr.timestamp_envio ? tr.timestamp_envio.toDate().getFullYear() : new Date().getFullYear();
        const guiaLegivel = `TR-${ano}/${doc.id.substring(0, 5).toUpperCase()}`;

        // 2. Cálculo do Volume Total - CORREÇÃO: Usando 'quantidade' conforme o banco
        const totalVolumes = tr.itens.reduce((acc, item) => acc + (Number(item.quantidade) || 0), 0);

        htmlLista += `
            <div class="result-vtr-card" onclick="iniciarRecebimentoCargaApp('${doc.id}')" 
                 style="margin-bottom: 12px; padding: 15px; border: 1px solid #eee; border-left: 6px solid #000; border-radius: 10px; cursor: pointer; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                    <span style="font-weight: 800; color: #000; font-size: 1.1em;">${guiaLegivel}</span>
                    <span style="font-size: 0.75em; background: #f0f0f0; padding: 2px 8px; border-radius: 4px; color: #666;">
                        <i class="far fa-calendar-alt"></i> ${tr.timestamp_envio?.toDate().toLocaleDateString('pt-BR')}
                    </span>
                </div>

                <div style="font-size: 0.85em; color: #444; line-height: 1.5;">
                    <div style="margin-bottom: 4px;">
                        <i class="fas fa-user-edit" style="width: 18px; color: #888;"></i> 
                        Origem: <b>${tr.origem_sigla || 'DLOG'}</b> (${tr.emitente})
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee;">
                        <span><i class="fas fa-boxes" style="color: #2c3e50;"></i> Itens: <b>${tr.itens.length}</b></span>
                        <span><i class="fas fa-layer-group" style="color: #2c3e50;"></i> Volume Total: <b>${totalVolumes}</b></span>
                    </div>
                </div>
            </div>`;
    });
    
    htmlLista += '</div>';

    Swal.fire({
        title: '<i class="fas fa-truck-loading"></i> Cargas Destinadas à Unidade',
        html: htmlLista,
        showConfirmButton: false,
        showCancelButton: true,
        cancelButtonText: 'Fechar',
        customClass: {
            title: 'swal-title-left'
        }
    });
}
		function iniciarRecebimentoCargaApp(transferenciaId) {
    Swal.close();
    
    const userUid = firebase.auth().currentUser.uid;
    const guerra = (currentUserData.nome_guerra || 'ND').toUpperCase();
    const posto = (currentUserData.posto || 'ND');
    const quadro = (currentUserData.quadro || 'ND');

    const url = `conferencia_app.html?transferenciaId=${transferenciaId}` +
                `&modo=recebimento_carga` +
                `&posto_grad=${encodeURIComponent(posto)}` +
                `&quadro_mil=${encodeURIComponent(quadro)}` +
                `&nome_guerra=${encodeURIComponent(guerra)}` +
                `&user_uid=${userUid}`;

    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (container && iframe) {
        iframe.src = url;
        container.style.display = 'block';
    }
}		
		
    </script>
</body>
</html>
