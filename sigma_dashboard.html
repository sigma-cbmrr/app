<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Gest√£o & Comando</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9; 
            color: #333; 
            margin: 0; 
            display: flex; 
            min-height: 100vh; 
            padding-top: 50px; 
            padding-bottom: 60px; 
            box-sizing: border-box; 
            overflow-x: hidden;
        }
        
        /* Header */
        .main-header { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 50px; 
            background-color: #800020; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000;
            display: flex; 
            align-items: center; 
            padding: 0 15px; 
            box-sizing: border-box; 
            gap: 10px;
        }
        .header-icon { 
            height: 40px; 
            width: auto;
        } 
        .header-title-desktop, .header-title-mobile { 
            font-weight: bold; 
            font-size: 1.1em; 
            line-height: 1.2;
        } 
        .text-white { 
            color: white; 
        } 
        .text-red { 
            color: #FF3B3B;
        } 
        .header-title-desktop { 
            display: none; 
        } 
        .header-title-mobile { 
            display: block;
        }
        /* 1. Sobrescreve a classe de a√ß√£o para garantir que seja APENAS um √≠cone */
        .btn-logout-header {
            /* Anula√ß√£o da Caixa */
            background: transparent !important; /* Garante fundo transparente, anulando o .btn-modern-action */
            border: none !important;      /* Remove bordas */
            box-shadow: none !important;  /* Remove sombras */
            padding: 0 !important;        /* Remove o padding que cria o tamanho da caixa */
            margin-left: auto !important; /* Mant√©m o alinhamento √† direita */
    
            /* Visibilidade do √çcone */
            color: white !important;      /* Cor branca para o √≠cone */
            font-size: 0;                 /* Define a fonte do bot√£o como zero para ocultar qualquer texto residual */
        }

        /* 2. For√ßa o √≠cone (i) a ter o tamanho correto e ser branco */
        .btn-logout-header i {
            color: white !important;
            font-size: 1.5em !important; /* Define o tamanho final do √≠cone (ajuste se necess√°rio) */
            padding: 5px; /* Adiciona uma √°rea de clique maior ao redor do √≠cone */
            display: inline-block; /* Garante que o √≠cone seja renderizado corretamente */
        }

        /* 3. Garante que n√£o haja fundo branco/estranho ao interagir */
        .btn-logout-header:hover,
        .btn-logout-header:active,
        .btn-logout-header:focus {
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
            color: white !important;
        }
        #menu-btn { 
            display: none; 
            background: none; 
            border: none; 
            color: white;
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 0 5px; 
        }
        .profile-badge { 
            background-color: #800020; /* Cor s√≥lida SIGMA (vermelho escuro) */
            color: white; /* Mant√©m o texto branco no fundo vermelho escuro */
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 0.8em; 
            margin-left: 0; /* Remove a margem horizontal desnecess√°ria na sidebar */
            border: 1px solid rgba(255,255,255,0.5); /* Borda mais vis√≠vel */
        }
        #sidebar-user-info .profile-badge {
            /* Garante que o badge tenha margem superior para espa√ßamento */
            margin-top: 5px; 
            margin-left: 0;
        }

        @media (min-width: 768px) { 
            .header-title-desktop { 
                display: block; 
                font-size: 1.2em;
            } 
            .header-title-mobile { 
                display: none; 
            } 
            #menu-btn { 
                display: none;
            } 
        }
        
        /* Sidebar */
        .sidebar { 
            width: 250px;
            background-color: #ffffff; 
            color: #333; 
            padding-top: 20px; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); 
            border-right: 1px solid #e0e0e0; 
            position: fixed;
            top: 50px; 
            left: 0; 
            height: calc(100% - 50px); 
            display: flex; 
            flex-direction: column; 
            z-index: 1100; 
            overflow-y: auto; 
            transition: left 0.3s ease;
        }
        .sidebar-header { 
            text-align: center; 
            padding: 10px 0 20px 0;
            border-bottom: 1px solid #eee; 
            margin-bottom: 10px; 
        } 
        .sidebar-header img { 
            width: 60px;
            height: auto; 
            margin-bottom: 5px; 
        } 
        #sidebar-user-info {
            /* Define o estilo principal do texto */
            font-size: 1.1em;
            font-weight: bold;
            color: #800020; /* Cor do SIGMA */
            margin: 0; /* Remove margens extras */
            line-height: 1.4;
            display: flex; /* Permite alinhar nome e badge lado a lado */
            flex-direction: column; /* Empilha Nome e Badge */
            align-items: center; /* Centraliza verticalmente o texto */
        }
        #sidebar-user-info #user-name {
            /* Estilo para o nome */
            display: block;
            margin-bottom: 5px; /* Espa√ßo entre nome e badge */
            font-size: 0.9em; /* Um pouco menor que o t√≠tulo */
            color: #333;
        }
        .sidebar a { 
            padding: 15px 20px; 
            text-decoration: none; 
            font-size: 1em;
            color: #555; 
            display: block; 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent; 
            cursor: pointer;
        } 
        .sidebar a:hover { 
            background-color: #fff5f5; 
            color: #800020;
        } 
        .sidebar a.active { 
            background-color: #ffecec; 
            color: #800020; 
            font-weight: bold;
            border-left: 4px solid #d90f23; 
        } 
        .menu-label { 
            padding: 15px 20px 5px;
            font-size: 0.85em; 
            color: #999; 
            text-transform: uppercase; 
            font-weight: bold; 
        }
        .sidebar-overlay { 
            display: none;
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1050;
        }

        /* Content */
        .content { 
            margin-left: 250px;
            flex-grow: 1; 
            padding: 20px; 
            box-sizing: border-box; 
            width: calc(100% - 250px); 
            padding-bottom: 80px;
        } 
        .view-section { 
            display: none; 
            animation: fadeIn 0.3s ease;
        } 
        .view-section.active-view { 
            display: block;
        }
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
            } 
            to { 
                opacity: 1;
            } 
        }

        /* Footer */
        .footer-central { 
            position: fixed;
            bottom: 0; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            padding: 5px 0 5px; 
            background-color: #f4f4f9; 
            color: #555; 
            font-size: 0.65em; 
            line-height: 1.3;
            z-index: 100; 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        } 
        .footer-central strong, .footer-autor { 
            display: block; 
            width: 100%; 
            text-align: center;
        } 
        .footer-central strong { 
            font-weight: bold; 
        } 
        .footer-autor { 
            margin-top: 10px; 
            color: #888; 
            font-size: 0.9em;
        }

        /* Cards e Grid */
        /* Cards e Grid */
.cards-grid { 
    display: flex;
/* flex-wrap: wrap;  */
    flex-wrap: wrap; 
    gap: 20px; 
    margin-bottom: 30px; 
} 
.sector-card { 
    background-color: white;
/* padding: 15px;  */
    padding: 15px; 
    min-height: 100px; /* ‚¨ÖÔ∏è AJUSTE: Altura m√≠nima aumentada para garantir alinhamento com cards de lista */
    border-radius: 8px;
/* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
/* A chave: For√ßa o item a ter 280px como largura base e permite que o flexbox o organize */
    flex: 0 0 220px;
/* max-width: 100%; */ 
    max-width: 100%;
/* /* Garante que n√£o ultrapasse a tela em mobile */ */
    cursor: pointer;
/* /* transition: transform 0.2s, box-shadow 0.2s;  */
    transition: transform 0.2s, box-shadow 0.2s; 
    display: flex; 
    flex-direction: column;
/* justify-content: space-between; */
    justify-content: space-between;
}
        /* Garante que o elemento principal dos Cards de Pend√™ncia/Estat√≠stica tenha altura para empurrar o rodap√© */
        .sector-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background-color: #fff5f5; 
        }
        .sector-card.status-alert { 
            border-left: 5px solid #d90f23;
        } 
        .sector-card.status-ok { 
            border-left: 5px solid #1b8a3e; 
        } 
        .sector-card.status-unit { 
            border-left: 5px solid #2c7399;
        } 
        .sector-card.status-posto { 
            border-left: 5px solid #8e44ad; 
        }
        .sector-card.active-card { 
            background-color: #ffecec;
            border: 1px solid #d90f23; 
            border-left: 5px solid #d90f23; 
        }
        .sector-card h3 { 
            margin-top: 0;
            font-size: 1.1em; 
            color: #333; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .sector-card .main-stat { 
            display: flex;
            align-items: center; 
            justify-content: space-between; 
            margin: 10px 0; 
        }
        .sector-card .count-value { 
            font-size: 2em;
            font-weight: bold; 
        }
        .sector-card.status-alert .count-value { 
            color: #d90f23;
        } 
        .sector-card.status-ok .count-value { 
            color: #1b8a3e; 
        }
        .sector-card .card-footer { 
            font-size: 0.75em;
            color: #777; 
            margin-top: 10px; 
            pt: 10px; 
            border-top: 1px solid #eee; 
            line-height: 1.4;
        }
        .sub-list-preview { 
            font-size: 0.85em; 
            color: #555; 
            list-style: none; 
            padding: 0; 
            margin: 0;
            max-height: 60px; 
            overflow: hidden; 
        }
        .sub-list-preview li { 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        /* Greeting Card */
        .greeting-card { 
            /* Estilos Visuais */
            background: linear-gradient(135deg, #800020 0%, #5a0017 100%);
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 10px rgba(128, 0, 32, 0.2); 
    
            /* Configura√ß√£o Flexbox */
            display: flex;
            flex-wrap: wrap; /* ‚úÖ ESSENCIAL: Permite que a foto e o bloco de info (.greeting-info) quebrem em telas pequenas. */
            align-items: center;
            gap: 20px; 
        }
        .greeting-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            flex-basis: auto;
            border: 3px solid rgba(255,255,255,0.3); 
            object-fit: cover; 
            background-color: white; 
        }
        .greeting-info { 
            display: flex;
            flex-wrap: wrap; /* Permite a quebra de linha em mobile */
            align-items: center; 
            flex-grow: 1; /* Ocupa o m√°ximo de espa√ßo poss√≠vel */
            gap: 15px;
            flex-basis: 0;
        }
        .greeting-text-wrapper {
            flex-grow: 1;
            margin-bottom: 10px;
            order: 0;
        }
        #btn-open-conf-modal {
            margin-left: auto; /* Empurra o bot√£o para a direita em desktop */
            justify-content: center !important; 
            text-align: center;
        }
        .greeting-title { 
            margin: 0; 
            font-size: 1.3em; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .greeting-date { 
            font-size: 0.85em; 
            opacity: 0.8; 
            margin-top: 3px; 
            display: block;
            font-style: italic;
        }
        .greeting-user { 
            font-size: 1.1em; 
            margin-top: 5px; 
            display: block; 
            font-weight: 500;
        }
        .greeting-title, .greeting-user { 
            white-space: nowrap; /* Impede quebras de linha dentro do texto */
            overflow: hidden;
            text-overflow: ellipsis; /* Adiciona "..." se o texto for muito longo */
            max-width: 100%; /* Garante que respeite o pai */
            display: block;
        }

        /* Card de Nova Confer√™ncia / Filtros */
        .op-card { 
            background: white;
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            padding: 25px; 
            margin-bottom: 25px; 
            border-left: 5px solid #ccc;
        }
        .op-card.action { 
            border-left-color: #1b8a3e;
        }
        .op-card.history { 
            border-left-color: #2c7399;
        }
        .op-card.resume { 
            border-left-color: #f57c00; 
            background-color: #fff3e0; 
            cursor: pointer; 
            transition: transform 0.2s;
            padding: 25px 35px 25px 25px; /* Adiciona 35px de padding na direita */
            position: relative;
        }
        .op-card.resume:hover { 
            transform: translateY(-2px);
        }
        
        .op-card-title { 
            color: #333;
            margin-top: 0; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 10px; 
            font-size: 1.2em; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .form-group { 
            margin-bottom: 15px;
        }
        .form-group label { 
            display: block; 
            font-weight: bold; 
            color: #555; 
            margin-bottom: 5px;
            font-size: 0.9em; 
        }
        .form-group select, .form-group input { 
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box;
            /* Garante que todos os inputs de formul√°rio herdem a fonte base */
            font-family: inherit; 
        }
        
        /* Regra espec√≠fica para inputs de data no Chrome/Edge/Firefox, for√ßando a fonte */
         input[type="date"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }
        .form-group select:focus, .form-group input:focus { 
            border-color: #800020;
            outline: none; 
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
        }
        .btn-start { 
            background: linear-gradient(135deg, #d90f23 0%, #800020 100%); 
            color: white; 
            border: none;
            width: 100%; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(217, 15, 35, 0.3);
        }
        .btn-start:focus { 
            outline: 3px solid rgba(128,0,32,0.4);
        }

        /* Admin Tables & Lists */
        .new-local-section { 
            background: #fff;
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            border-top: 3px solid #2c7399;
        }
        .admin-table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border-radius: 8px; 
            overflow: hidden; 
            margin-bottom: 20px;
        }
        .admin-table th, .admin-table td { 
            padding: 12px 15px; 
            text-align: left;
            border-bottom: 1px solid #eee; 
        }
        .admin-table th { 
            background-color: #f8f9fa; 
            font-weight: bold;
            color: #555; 
            text-transform: uppercase; 
            font-size: 0.85em; 
        }
        .role-badge { 
            padding: 3px 8px;
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold; 
            color: white; 
        }
        .role-admin { 
            background-color: #d90f23;
        } 
        .role-gestor { 
            background-color: #f57c00; 
        } 
        .role-operacional { 
            background-color: #1b8a3e;
        }
        
        /* Editor de Listas (Elementos) */
        .admin-container { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto;
            text-align: center; 
        }
        .lista-setores { 
            padding: 0; 
            list-style: none; 
            text-align: left;
        }
        .setor-item { 
            margin-bottom: 15px; 
            border: 1px solid #800020; 
            border-radius: 6px; 
            background: #fff;
        }
        .item-list-admin {}
        .setor-content-header-sticky {
            /* Tornar o cont√™iner do cabe√ßalho e formul√°rio sticky */
            position: sticky;
            top: 50px; /* Bate logo abaixo do main-header (50px) */
            z-index: 50;
            /* Garante que fique acima dos itens rolando */
            background-color: #fff;
            /* Fundo branco para cobrir o conte√∫do rolando */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            /* Sombra suave para destacar */
        }
        .setor-header-admin { 
            background-color: #800020; 
            color: white;
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            cursor: grab; 
            z-index: 51;
        }
        .setor-content-admin { 
            transition: max-height 0.4s ease-out;
            /* Removemos o max-height alto e o overflow: hidden */
            max-height: 1500px;
            /* Define uma altura m√°xima vis√≠vel */
            overflow-y: auto;
            /* PERMITE A ROLAGEM VERTICAL */
            padding: 10px 10px 10px;
        }
        #lista-setores-container {
             border: none !important;
             margin-top: 20px; 
        }
        .setor-content-admin.collapsed { 
            max-height: 0;
            padding: 0 !important; 
            overflow-y: hidden; /* Oculta a barra quando colapsado */
        }
        .item-conferencia-admin { 
            display: flex;
            justify-content: space-between; 
            align-items: flex-start; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
            cursor: move;
        }
        .add-item-form-setor { 
            padding: 10px 15px 5px; 
            background-color: #f8f8f8; 
            display: flex; 
            gap: 5px;
            margin-bottom: 0; 
        }
        .add-item-form-setor input, .add-item-form-setor select { 
            flex-grow: 1; 
            padding: 8px;
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        .tombamento-container-wrapper { 
            margin-top: 5px; 
            padding-left: 20px;
            background: #f9f9f9; 
            border-left: 3px solid #ccc; 
            width: 100%; 
            box-sizing: border-box;
        }
        .tombamento-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 0;
            border-bottom: 1px dotted #eee; 
        }
        .item-actions-admin { 
            display: flex; 
            gap: 5px;
        }
        .btn-remover { 
            background-color: #d90f23; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        } 
        .btn-edit-alt { 
            background-color: #7f8c8d; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        }
        .btn-add { 
            background-color: #800020; 
            color: white; 
            border: none; 
            padding: 8px 15px;
            border-radius: 4px; 
            cursor: pointer; 
        }
        .locais-list { 
            list-style: none; 
            padding: 0;
        }
        .local-item { 
            background: white; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 5px solid #800020;
        }
        .local-info strong { 
            display: block; 
            font-size: 1.1em; 
            color: #333;
        }

        /* CA Table */
        .ca-table-container { 
            overflow-x: auto;
            background-color: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            margin-top: 10px; 
            border-top: 3px solid #d90f23;
        } 
        .ca-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9em;
        } 
        .ca-table th, .ca-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
            vertical-align: top;
        } 
        .ca-table th { 
            background-color: #f8f8f8; 
            color: #800020; 
            font-weight: bold; 
            text-transform: uppercase;
        }
        .row-amarelo { 
            background-color: #fff9c4 !important; 
        } 
        .row-laranja { 
            background-color: #ffe0b2 !important;
        } 
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold;
        } 
        .badge-pendente { 
            background-color: #ffebee; 
            color: #d32f2f; 
        } 
        .badge-solucao { 
            background-color: #fff9c4; 
            color: #fbc02d; 
            border: 1px solid #fbc02d;
        } 
        .badge-cautela { 
            background-color: #ffe0b2; 
            color: #f57c00; 
            border: 1px solid #f57c00;
        }

        /* Modals - ESTILO PREMIUM */
        .modal-overlay { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 2000;
        } 
        .modal-content { 
            background: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            width: 90%;
            max-width: 500px; 
            position: relative; 
            text-align: left; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        } 
        .modal-content h2 { 
            margin-top: 0; 
            color: #800020; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px; 
            font-size: 1.4em; 
        } 
        .modal-content label { 
            display: block; 
            margin-top: 15px;
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #444; 
            font-size: 0.95em; 
        } 
        
        /* Inputs Premium no Modal */
        .modal-content input[type="text"], 
        .modal-content input[type="number"],
        .modal-content select, 
        .modal-content textarea { 
            width: 100%;
            padding: 12px; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 1em; 
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
            border-color: #800020;
            outline: none;
            box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
        }
        
        .modal-content textarea { 
            height: 100px;
            resize: vertical; 
        } 
        .modal-buttons { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px;
            margin-top: 10px; 
        } 
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px;
            background: none; 
            border: none; 
            font-size: 20px; 
            cursor: pointer; 
            color: #999; 
            transition: color 0.2s;
        }
        .close-btn:hover { 
            color: #d90f23;
        }

        /* Checkbox list in modal */
        .checklist-container { 
            max-height: 200px;
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 5px; 
            margin-bottom: 15px;
        }
        .checklist-item { 
            display: flex; 
            align-items: center; 
            padding: 5px; 
            border-bottom: 1px dotted #f0f0f0;
        }
        .checklist-item:hover { 
            background: #fafafa;
        }
        .checklist-item input { 
            width: auto; 
            margin-right: 10px; 
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-modern-action { 
            display: inline-flex;
            align-items: center; 
            gap: 8px; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            color: white; 
            font-size: 0.95em;
            transition: 0.2s; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .btn-modern-action:active { 
            transform: translateY(1px);
            box-shadow: none; 
        }
        .btn-create { 
            background-color: #2c7399; 
        } 
        .btn-create:hover { 
            background-color: #205b7a;
        }
        .btn-edit { 
            background-color: #f57c00; 
        } 
        .btn-delete { 
            background-color: #d90f23;
        } 
        .btn-sync { 
            background-color: #1b8a3e; 
        } 
        .btn-backup { 
            background: #5d6164;
        }
        .btn-filter-modern { 
            background-color: #2c7399; 
            color: white; 
            border: none; 
            padding: 11px 25px;
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        

        /* APP CONTAINER (IFRAME) */
        #app-runner-container { 
            display: none;
            position: fixed; 
            top: 50px; 
            left: 250px; 
            width: calc(100% - 250px); 
            height: calc(100vh - 50px); 
            background: white; 
            z-index: 500; 
            overflow: hidden;
        }
        #app-iframe { 
            width: 100%; 
            height: 100%; 
            border: none;
        }

        /* History List Specifics */
        .history-list { 
            list-style: none;
            padding: 0; 
            margin: 0; 
        }
        .history-item { 
            border-bottom: 1px solid #eee;
            padding: 15px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background 0.2s;
        }
        .history-item:hover { 
            background-color: #fafafa; 
            padding-left: 5px; 
            padding-right: 5px;
        }
        .history-item:last-child { 
            border-bottom: none;
        }
        .hist-info strong { 
            display: block; 
            color: #333; 
            font-size: 1.05em;
        }
        .hist-info small { 
            color: #777; 
            font-size: 0.9em;
        }
        .hist-status { 
            font-size: 0.8em; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: bold;
            margin-left: 5px; 
            text-transform: uppercase; 
        }
        .status-ok { 
            background-color: #e8f5e9; 
            color: #2e7d32;
            border: 1px solid #c8e6c9; 
        }
        .status-alert { 
            background-color: #ffebee; 
            color: #c62828;
            border: 1px solid #ffcdd2; 
        }
        .btn-reprint { 
            background: white; 
            border: 1px solid #ddd;
            padding: 8px 12px; 
            border-radius: 6px; 
            color: #555; 
            cursor: pointer; 
            font-size: 0.9em; 
            display: flex; 
            align-items: center; 
            gap: 5px;
        }
        .btn-reprint:hover { 
            border-color: #800020; 
            color: #800020; 
            background-color: #fff5f5;
        }

        /* Filtros Premium */
        .modern-filter-card { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #e0e0e0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px; 
            align-items: flex-end; 
        }
        .filter-item { 
            flex: 1; 
            min-width: 200px;
        }
        .filter-item label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: #555;
            font-size: 0.9em; 
        }
        .filter-input { 
            width: 100%; 
            padding: 10px 12px;
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 0.95em; 
            box-sizing: border-box;
        }
        .dashboard-columns {
    display: flex;
    flex-direction: column; /* Em mobile, os blocos ficam empilhados (Mobile-First) */
    gap: 25px; 
}
    /* Regra para garantir o alinhamento vertical centralizado do √≠cone ao bloco de texto */
.unit-header .unit-flex-title {
    display: flex;
    align-items: center; /* CENTRALIZA O √çCONE VERTICALMENTE COM O TEXTO QUEBRADO */
    gap: 8px; /* Espa√ßamento entre o √≠cone e o texto */
    width: 100%; /* Opcional, para garantir que o H3 preencha a largura */
}

/* Garante que o texto se comporte como um bloco para quebrar corretamente */
.unit-header .unit-flex-title span {
    flex-grow: 1; 
    line-height: 1.3; /* Melhora a leitura do texto quebrado */
}    
        
        /* Mobile */
        @media (max-width: 600px) { 
            .greeting-card {
                align-items: flex-start; /* Alinha o topo da foto com o topo do texto */
            }
            /* O bloco .greeting-info deve ocupar toda a largura abaixo da foto */
            .greeting-info {
                flex-basis: auto; /* Ocupa apenas o espa√ßo necess√°rio ao lado da foto */
                flex-grow: 1;
                margin-top: 0;
        
                /* Define como o TEXTO e o BOT√ÉO se comportar√£o internamente */
                flex-direction: row; /* Mant√©m os filhos (texto e bot√£o) na mesma linha, se poss√≠vel */
                flex-wrap: wrap; /* CR√çTICO: Permite que APENAS o bot√£o quebre */
                align-items: flex-start;
                gap: 10px;
            }

            /* O wrapper de texto volta a ocupar 100% da linha do .greeting-info */
            .greeting-text-wrapper {
                flex-basis: 100%; /* ‚úÖ NOVO: For√ßa o texto a ocupar 100% da largura DISPON√çVEL (ao lado da foto) */
                flex-grow: 1;
                margin-bottom: 0;
            }

            /* O bot√£o √© for√ßado a quebrar e ocupar 100% da largura */
            #btn-open-conf-modal {
                flex-basis: 100%; /* For√ßa a quebra e 100% da largura da √°rea de info */
                margin-top: 15px; 
                margin-left: 0; 
                width: 100%;
                order: 1; /* Garante que o bot√£o venha depois do texto */
            }
            greeting-avatar {
                flex-basis: auto;
            }
           
            #menu-btn { 
                display: block;
            }
            .sidebar { 
                left: -260px;
                width: 260px;
                border-right: 1px solid #ddd; 
            } 
            .sidebar.mobile-active { 
                left: 0;
            } 
            .content { 
                margin-left: 0;
                width: 100%; 
                padding-top: 15px; 
            } 
            #app-runner-container { 
        left: 0;
/*width: 100%;  */
        width: 100%; 
        z-index: 500; 
    }
    .modern-filter-card { 
        flex-direction: column;
/*align-items: stretch;  */
        align-items: stretch; 
        gap: 10px; 
    }
    .btn-filter-modern { 
        width: 100%;
/*} */
    }
    .filter-input { 
        max-width: 100%;
/*width: 100%; */
        width: 100%;
    }
    .filter-item { 
        width: 100%;
/*min-width: 0; */
        min-width: 0;
    }
    .admin-container {
        padding: 10px;
/*margin-top: 20px; */
        margin-top: 20px;
    }
    .admin-table, .admin-table thead, .admin-table tbody, .admin-table th, .admin-table td, .admin-table tr {
        display: block;
/*/* For√ßa os elementos da tabela a se comportarem como blocos */ */
    }
    .admin-table thead tr {
        position: absolute;
/*/* Esconde o cabe√ßalho original */ */
        top: -9999px;
/*left: -9999px; */
        left: -9999px;
    }
    .admin-table tr {
        border: 1px solid #ccc;
/*margin-bottom: 10px; */
        margin-bottom: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .admin-table td {
        border: none;
/*border-bottom: 1px solid #eee; */
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 50%; /* Espa√ßo para o "cabe√ßalho" embutido */
        text-align: right;
/*font-size: 0.9em; */
        font-size: 0.9em;
    }
    /* Adiciona o "cabe√ßalho" como um pseudo-elemento */
    .admin-table td:before {
        content: attr(data-label);
/*position: absolute; */
        position: absolute;
        left: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
        color: #800020;
/*} */
    }
    /* A√ß√µes (bot√µes) - For√ßa a esquerda */
    .admin-table td:last-child {
        text-align: left;
/*} */
    }
    /* A√ß√µes Globais (Salvar, Backup, Importar, +Setor) */
    .global-actions {
        /* Transforma a barra de a√ß√µes em empilhamento */
        display: flex;
/*flex-direction: column; */
        flex-direction: column;
        gap: 10px; /* Adiciona espa√ßamento entre os bot√µes empilhados */
    }
    /* Gest√£o de Usu√°rios/Unidades/Postos - Grade de Formul√°rio (Cria√ß√£o) */
    .new-local-section > div[style*="grid"] {
        /* Desativa o grid no celular e empilha */
        display: 
/*block !important; */
        block !important;
    }
    .new-local-section > div[style*="flex"] {
        /* Desativa o flex (para o 'gap' das a√ß√µes) e empilha */
        display: block !important;
/*} */
    }
    .new-local-section .form-group {
        margin-bottom: 10px;
/*} */
    }
    .new-local-section .btn-modern-action, .new-local-section .btn-create {
        width: 100%;
/*/* Bot√µes de a√ß√£o em largura total */ */
        margin-top: 10px;
/*} */
    }

    /* Cards de Unidades/Postos - For√ßa para 100% de largura */
    /* */
    .sector-card {
        /* CORRE√á√ÉO: Subtrai 50px (25px de padding esquerdo e 25px de padding direito do .op-card) */
        flex: 0 0 calc(100% - 50px) !important;
        max-width: calc(100% - 50px) !important;
        margin-left: 25px !important;  /* Centraliza o card visualmente */
        margin-right: 25px !important;
        
        /* Remove o max-width: 100% que estava sendo usado anteriormente */
    }
    /* üí° CORRE√á√ÉO DE OVERFLOW: Remove o gap horizontal que causa o transbordamento */
    /* Localize e substitua o bloco que come√ßa na linha 272 */
    .cards-grid {
        /* Mant√©m o gap vertical (20px), elimina o horizontal (0) */
        gap: 20px 0 !important;
    margin-left: 0 !important; /* CORRE√á√ÉO: Remove a margem negativa que causava o desalinhamento */
        margin-right: 0 !important;
/* Move a grid 25px para a direita */
    }

    /* For√ßa o formul√°rio de adicionar setor a empilhar tamb√©m */
    .add-setor-form {
         flex-direction: column;
/*gap: 10px !important; */
        gap: 10px !important;
        margin-left: 0 !important; /* Remove o auto-margin para preencher a largura */
    }
    /* Formul√°rio de Adicionar Item dentro do Setor */
    .add-item-form-setor {
        flex-wrap: wrap;
/*} */
    }
    .add-item-form-setor input, .add-item-form-setor select, .add-item-form-setor button {
        flex-grow: 1;
/*/* Permite que os campos cres√ßam e se ajustem */ */
        width: 100%;
/*box-sizing: border-box; */
        box-sizing: border-box;
    }
    .add-item-form-setor button {
        flex-grow: 0;
/*width: 48%; /* Exemplo: Dois bot√µes por linha */ */
        width: 48%;
    }
    /* Itens do Editor de Lista */
    .item-conferencia-admin {
        flex-direction: column;
/*/* Empilha o item e os bot√µes de a√ß√£o */ */
        align-items: flex-start;
/*padding: 10px; */
        padding: 10px;
    }
    .item-actions-admin {
        margin-top: 10px;
/*align-self: flex-end; /* Alinha as a√ß√µes √† direita */ */
        align-self: flex-end;
    }
    /* V√≠nculos de Tombamento */
    .tombamento-container-wrapper {
        padding-left: 10px;
/*/* Reduz o padding */ */
        margin-top: 10px;
/*} */
    }
    .tombamento-list li {
        flex-wrap: wrap;
/*padding: 5px 0; */
        padding: 5px 0;
    }
    .tombamento-list input {
        flex-grow: 1;
/*} */
    }
}
        @media (min-width: 769px) { 
            .sidebar-overlay { 
                display: none !important;
            }
    
            .dashboard-columns {
                flex-direction: row; 
                /* üí° CORRE√á√ÉO: Usamos stretch para que os dois blocos (op-card) 
                ocupem 100% da altura do bloco mais alto, igualando o tamanho. */
                align-items: stretch; 
                gap: 20px;
            }
            .dashboard-columns .op-card {
                flex: 1; 
            }
        }
            .restricted-admin-only { 
                display: none;
            }
        /* Estilo espec√≠fico para o bot√£o de descarte do card de resumo */
.op-card.resume {
    position: relative; /* Necess√°rio para posicionar o bot√£o absoluto */
}
.btn-resume-close {
    position: absolute;
    top: 5px; 
    right: 5px; 
    background: none;
    border: none;
    color: #d90f23; 
    font-size: 1.4em; 
    cursor: pointer;
    padding: 5px;
    opacity: 0.9; 
    transition: color 0.2s, opacity 0.2s;
}
.btn-resume-close:hover {
    color: #FF3B3B; 
    opacity: 1;
}
    </style>
</head>
<body>
    <div id="mobile-overlay" class="sidebar-overlay" onclick="closeMenuMobile()"></div>

   <header class="main-header">
    <button id="menu-btn" onclick="toggleMenuMobile()"><i class="fas fa-bars"></i></button>

    <img src="cbmrr.png" alt="Logo CBM-RR" class="header-icon" 
         style="margin-right: -10px;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/000000/fff?text=CBM'">
    
    <div class="header-title-desktop">
        <span class="text-white"> CORPO DE BOMBEIROS MILITAR </span>
        <span class="text-red">RORAIMA</span>
    </div>

    <div class="header-title-mobile">
        <span class="text-white">CBM</span><span class="text-red">RR</span>
    </div>
    
    <img src="logo_sigma.png" alt="Logo SIGMA" class="header-icon" 
         style="opacity: 0;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=S'">

    <div id="dashboard-greeting" style="display:none; margin-left: 20px; font-size: 0.9em; font-style: italic;">
        Bem-vindo(a)! Preencha a confer√™ncia para hoje.
    </div>
    <button onclick="logout()" class="btn-modern-action btn-logout-header" style="margin-left: auto;">
        <i class="fas fa-sign-out-alt"></i> 
    </button>
</header>
    
    <div class="sidebar" id="main-sidebar">
        <div class="sidebar-header">
            <img src="logo_sigma.png" alt="Logo SIGMA" onerror="this.onerror=null; this.src='https://placehold.co/50x50/ffffff/800020/fff?text=S'">
            <div id="sidebar-user-info">
            <span id="user-name"></span>
            <span id="user-role-display" class="profile-badge">Carregando...</span>
        </div>
        </div>
        <div class="menu-label">Operacional</div>
        <a onclick="switchView('dashboard')" id="link-dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard & Servi√ßo</a>
        <a onclick="switchView('my-history')" id="link-my-history"><i class="fas fa-history"></i> Minhas Confer√™ncias</a>
                
        <div class="menu-label restricted-admin-only" id="sidebar-rotulo-admin">Administra√ß√£o</div>
        <a onclick="switchView('global-history')" id="link-global-history"><i class="fas fa-folder-open"></i> Hist√≥rico da Unidade</a>
        <a onclick="switchView('unidades')" id="link-unidades" class="restricted-admin-only"><i class="fas fa-shield-alt"></i> Unidades</a>
        <a onclick="switchView('postos')" id="link-postos" class="restricted-admin-only"><i class="fas fa-map-signs"></i> Postos</a>
        <a onclick="switchView('usuarios')" id="link-usuarios" class="restricted-admin-only"><i class="fas fa-users"></i> Usu√°rios</a>
        <a onclick="switchView('listas')" id="link-listas" class="restricted-admin-only"><i class="fas fa-clipboard-list"></i> Editor de Listas</a>
    </div>

    <div class="content">
        
       <div id="view-dashboard" class="view-section active-view">
    
    <div class="greeting-card">
        <img id="greeting-photo" src="https://placehold.co/70x70/ffffff/800020?text=U" class="greeting-avatar">
        
        <div class="greeting-info">
            <div class="greeting-text-wrapper"> 
                <h2 id="greeting-text" class="greeting-title">Carregando...</h2>
                <span id="greeting-name" class="greeting-user">...</span>
                <span id="current-date" class="greeting-date">...</span>
            </div>
        </div>
        
        <button id="btn-open-conf-modal" class="btn-modern-action" style="background-color: #d90f23;" onclick="openNewConferenceModal()">
            <i class="fas fa-play-circle"></i> Nova Confer√™ncia
        </button>
    </div>

    <div id="resume-container"></div>
    
    <div id="dashboard-content-by-role">
        <div id="admin-gestor-cards-container"></div>
        <div id="operacional-cards-container"></div>
    </div>
    
    <div id="ca-table-wrapper" class="ca-table-container" style="display: none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="table-title" style="margin:0; color:#800020;">Detalhes</h2>
            <button onclick="fecharTabela()" class="btn-modern-action btn-delete">Fechar</button>
        </div>
        <table class="ca-table">
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Status</th>
                    <th>Altera√ß√£o</th>
                    <th>Conferente/Data</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="ca-list-body"></tbody>
        </table>
        <div id="no-issues-msg" style="display:none; padding:20px; text-align:center; color:green;">
            ‚úÖ Tudo OK.
        </div>
    </div>
</div>
    <div id="view-my-history" class="view-section">
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-history"></i> Minhas Confer√™ncias</h2>
            <div class="modern-filter-card">
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                    <input type="date" id="my-hist-start" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Final</label>
                    <input type="date" id="my-hist-end" class="filter-input">
                </div>
                <div class="filter-item" style="flex: 0;">
                    <button class="btn-filter-modern" onclick="loadMyHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>
            <ul id="my-history-list" class="history-list"></ul>
        </div>
    </div>

    <div id="view-global-history" class="view-section">
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-folder-open"></i> Hist√≥rico da Unidade (Gest√£o)</h2>
            <div class="modern-filter-card">
                <div class="filter-item">
                    <label><i class="fas fa-user"></i> Conferente</label>
                    <select id="glob-hist-user" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                    <input type="date" id="glob-hist-start" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Final</label>
                    <input type="date" id="glob-hist-end" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="fas fa-map-marker-alt"></i> Local</label>
                    <select id="glob-hist-local" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item" style="flex: 0;">
                    <button class="btn-filter-modern" onclick="loadGlobalHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>
            <ul id="global-history-list" class="history-list"></ul>
        </div>
    </div>

    <div id="view-usuarios" class="view-section">
        <h1>Gest√£o de Usu√°rios</h1>
        <div class="new-local-section">
            <h3>Cadastrar Novo Militar</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="form-group"><label>Nome Guerra</label><input type="text" id="new-user-guerra"></div>
                <div class="form-group"><label>Posto/Grad</label><input type="text" id="new-user-posto"></div>
                <div class="form-group"><label>Nome Completo</label><input type="text" id="new-user-completo"></div>
                <div class="form-group"><label>Email (Login)</label><input type="email" id="new-user-email"></div>
                <div class="form-group">
                    <label>Perfil</label>
                    <select id="new-user-role">
                        <option value="operacional">Operacional</option>
                        <option value="gestor">Gestor de Unidade</option>
                        <option value="admin">Administrador Geral</option>
                    </select>
                </div>
                
                <div class="form-group"><label>Unidade</label><select id="new-user-unit"><option value="">Carregando...</option></select></div>
            </div>
            <button class="btn-modern-action btn-create" onclick="criarUsuario()" style="margin-top: 10px;">Salvar Usu√°rio</button>
        </div>
        
        <h3>Usu√°rios Cadastrados</h3>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Militar</th>
                    <th>Login</th>
                    <th>Perfil</th>
                    <th>Unidade</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="users-table-body"></tbody>
        </table>
    </div>

    <div id="view-unidades" class="view-section">
        <h1>Gest√£o de Unidades</h1>
        <div class="new-local-section">
            <h3>Criar Nova Unidade</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome da Unidade (Ex: 1¬™ CIA, CBS)</label>
                    <input type="text" id="new-unit-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarUnidade()">Adicionar</button>
            </div>
        </div>
        <h3>Unidades Existentes</h3>
        <div id="units-cards-container" class="cards-grid"></div>
    </div>
  
    <div id="view-postos" class="view-section">
        <h1>Gest√£o de Postos</h1>
        <div class="new-local-section">
            <h3>Criar Novo Posto</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome do Posto (Ex: ALFA, BRAVO)</label>
                    <input type="text" id="new-posto-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarPosto()">Adicionar</button>
            </div>
        </div>
        <h3>Postos Existentes</h3>
        <div id="postos-cards-container" class="cards-grid"></div>
    </div>

    <div id="view-listas" class="view-section">
        <h1>Editor de Listas</h1>
        <div class="new-local-section">
            <h3>Criar Lista</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <select id="novo-local-posto" class="filter-input" style="flex:1;"></select>
                <input type="text" id="novo-local-nome" placeholder="Nome Lista" class="filter-input" style="flex:2;">
                <select id="novo-local-unidade" class="filter-input" style="flex:1;"><option value="">Associar a Unidade...</option></select>
                <button class="btn-modern-action btn-create" onclick="criarNovoLocal()">Criar</button>
            </div>
        </div>
        <ul id="lista-locais-container" class="locais-list"></ul>
    </div>

    <div id="view-editor" class="view-section">
        <div class="admin-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button onclick="switchView('listas')" class="btn-modern-action btn-edit">Voltar</button>
                <h1 class="page-title" id="editor-title" style="font-size:1.2em; margin:0;">Editando...</h1>
            </div>
            <div id="loading-message-admin">Carregando...</div>
            <div id="main-admin-content" style="display:none;">
                <div class="global-actions">
                    <button class="btn-modern-action btn-sync" onclick="salvarDados()">Salvar</button>
                    <button class="btn-modern-action btn-backup" onclick="fazerBackupLocal()">Backup</button>
                    <input type="file" id="import-json" style="display: none;" onchange="importarBackupLocal(event)">
                    <button class="btn-modern-action btn-create" onclick="document.getElementById('import-json').click()">Importar</button>
              
                    <div class="add-setor-form" style="margin-left:auto; display:flex; gap:5px;">
                        <input type="text" id="input-setor-nome" placeholder="Nome Setor" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                        <button class="btn-add" onclick="adicionarSetor(document.getElementById('input-setor-nome').value)">+ Setor</button>
                    </div>
                </div>
                <ul id="lista-setores-container" class="lista-setores"></ul>
            </div>
        </div>
    </div>
</div>

    <div id="app-runner-container"><iframe id="app-iframe" src=""></iframe></div>

    <div id="modal-gestao-ca" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-gestao-ca').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Item</h2>
            <p id="gestao-item-nome" style="color:#800020; font-weight:bold; margin-bottom:20px; border-bottom:1px dashed #ccc; padding-bottom:10px;"></p>
            
            <input type="hidden" id="gestao-doc-id">
            <input type="hidden" id="gestao-item-index">
            <input type="hidden" id="gestao-item-id-lista">
            <input type="hidden" id="gestao-item-max-qtd">
            
            <label>A√ß√£o a realizar</label>
            <select id="gestao-status">
                <option value="Solucionado">Solucionado (Apenas dar baixa)</option>
                <option value="Em solu√ß√£o">Em solu√ß√£o (Manter alerta)</option>
                <option value="Cautelado">Cautelado (Material saiu)</option>
                <option value="Remover">Remover da Lista (Baixar estoque)</option>
            </select>
            
            <div id="div-gestao-qtd" style="display:none;">
                <label style="color:#d90f23;">Quantidade a Remover do Estoque:</label>
                <input type="number" id="gestao-qtd" min="1" value="1">
                <small id="gestao-qtd-info" style="color:#666; font-size:0.85em;"></small>
            </div>
            
            <label>Observa√ß√£o da Gest√£o (Obrigat√≥rio)</label>
            <textarea id="gestao-obs" placeholder="Descreva o que foi feito (ex: Material consertado; Enviado para manuten√ß√£o; etc)"></textarea>
            
            <div class="modal-buttons">
                <button class="btn-modern-action btn-backup" onclick="document.getElementById('modal-gestao-ca').style.display='none'">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarGestaoCa()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-unit-manager" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-unit-manager').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Unidade</h2>
            <label>Nome da Unidade</label>
            <input type="text" id="edit-unit-name-input">
            <input type="hidden" id="edit-unit-original-name">
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas:</label>
            <div id="unit-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirUnidade()">Excluir Unidade</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUnidade()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="modal-posto-manager" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-posto-manager').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Posto</h2>
            <label>Nome do Posto</label>
            <input type="text" id="edit-posto-name-input">
            <input type="hidden" id="edit-posto-original-name">
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas a este Posto:</label>
            <div id="posto-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirPosto()">Excluir Posto</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesPosto()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="modal-edicao" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="fecharModal()"><i class="fas fa-times"></i></button>
            <h2>Editar Item</h2>
            <input type="hidden" id="edit-setor-id">
            <input type="hidden" id="edit-item-original-id">
            <label>Nome:</label>
            <input type="text" id="edit-item-nome">
            <label>Mover para Setor:</label>
            <select id="edit-item-setor"></select>
            <label>Quantidade:</label>
            <input type="number" id="edit-item-qtd" min="1">
            <label>Tipo:</label>
            <select id="edit-item-tipo" disabled style="background-color: #eee;">
                <option value="single">Item √önico</option>
                <option value="multi">Item com Tombamento</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-remover" onclick="fecharModal()">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarEdicaoItem()">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-user-manager" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-user-manager').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Militar</h2>
            
            <input type="hidden" id="edit-user-doc-id">
            
            <label>Nome de Guerra</label>
            <input type="text" id="edit-user-guerra">

            <label>Posto/Gradua√ß√£o</label>
            <input type="text" id="edit-user-posto">

            <label>Nome Completo</label>
            <input type="text" id="edit-user-completo">

            <label>E-mail (Login) - *Somente Leitura*</label>
            <input type="email" id="edit-user-email" disabled style="background-color: #eee;">

            <label>Perfil de Acesso</label>
            <select id="edit-user-role">
                <option value="operacional">Operacional</option>
                <option value="gestor">Gestor de Unidade</option>
                <option value="admin">Administrador Geral</option>
            </select>

            <label>Unidade Associada</label>
            <select id="edit-user-unit"><option value="">Carregando...</option></select>
            
            <div id="user-permissions-fields" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; display: none;">
                <label class="section-label" style="font-weight: bold;">Permiss√µes de Gestor</label>
                <p style="font-size: 0.8em; margin: 5px 0 10px; color: #666;">Essas permiss√µes s√≥ s√£o aplic√°veis a usu√°rios com a Role 'gestor'.</p>

                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <label><input type="checkbox" id="perm-view-cards"> Visualizar Cards de Pend√™ncia C/A</label>
                    <label><input type="checkbox" id="perm-view-history"> Acesso ao Hist√≥rico da Unidade</label>
                    <label><input type="checkbox" id="perm-manage-posts"> Gerenciar V√≠nculos de Postos</label>
                    <label><input type="checkbox" id="perm-manage-users"> Gerenciar Usu√°rios da Unidade</label>
                    <label><input type="checkbox" id="perm-manage-lists"> Gerenciar Listas da Unidade</label>
                </div>
            </div>
            
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirUsuario()">Excluir Militar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUsuario()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    <div id="modal-nova-conferencia" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <button class="close-btn" onclick="document.getElementById('modal-nova-conferencia').style.display='none'"><i class="fas fa-times"></i></button>
        <div class="op-card action" style="border: none; box-shadow: none; padding: 0;">
            <h2 class="op-card-title"><i class="fas fa-clipboard-list"></i> Nova Confer√™ncia</h2>
            <div class="form-group">
                <label>1. Escolha o Setor / Posto</label>
                <select id="dash-select-setor" onchange="filtrarListasDashboard()">
                    <option value="" disabled selected>Carregando setores...</option>
                </select>
            </div>
            <div class="form-group">
                <label>2. Escolha a Viatura / Lista</label>
                <select id="dash-select-lista" disabled onchange="focarBotaoIniciar()">
                    <option value="" disabled selected>Selecione um setor acima</option>
                </select>
            </div>
            <button id="btn-start-dash" class="btn-start" onclick="iniciarConferenciaDashboard()">INICIAR AGORA</button>
        </div>
    </div>
</div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        
        function openNewConferenceModal() {
        document.getElementById('modal-nova-conferencia').style.display = 'flex';
        }
        // Constantes Globais
        const COLECAO_RESULTADOS = 'resultados_conferencias';
        const COLECAO_LISTAS = 'listas_conferencia';

        // Vari√°veis Globais
        let currentUserData = null;
        let allLists = [];
        let dadosConferencia = []; // Para o editor
        let currentEditingId = null;

        // --- 1. AUTH & PERMISS√ïES ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection('usuarios').doc(user.uid).get();
                    if (doc.exists) {
                        currentUserData = doc.data();
                        setupUIBasedOnRole();
                    } else {
                        alert("Usu√°rio sem registro no banco."); 
                        window.location.href = 'index.html';
                    }
                } catch (e) { 
                    console.error(e); 
                }
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        function setupUIBasedOnRole() {
¬† ¬† const role = currentUserData.role || 'operacional';
¬† ¬† const unit = currentUserData.unidade || 'N/D';
// --- CORRE√á√ÉO DE SEGURAN√áA NA LINHA 301 ---
¬† ¬† const roleDisplay = document.getElementById('user-role-display');
// Verifica se o elemento existe antes de tentar definir o texto
¬† ¬† if (roleDisplay) {¬†
¬† ¬† ¬† ¬† roleDisplay.textContent = `${role.toUpperCase()} - ${unit}`;
}
¬† ¬† // ------------------------------------------

¬† ¬† atualizarSaudacao(currentUserData);
// --- 1. Definindo as Permiss√µes Reais de Acesso ---
¬† ¬† const p = currentUserData.permissoes || {};
// Objeto de Permiss√µes
¬† ¬† const isGestorOuAdmin = (role === 'gestor' || role === 'admin');
¬† ¬† const canViewAdminTools = role === 'admin';
¬† ¬† const canViewDashboardCards = role === 'admin' ||
¬† ¬† (isGestorOuAdmin && p.canViewDashboardCards);
¬† ¬† const canViewUnitHistory = role === 'admin' || (isGestorOuAdmin && p.canViewUnitHistory);
¬† ¬† const canManageUnits = role === 'admin';
// Assume que Gerenciamento de Unidades √© Admin-Only
¬† ¬† const canManagePosts = role === 'admin' ||
(isGestorOuAdmin && p.canManagePosts);
¬† ¬† const canManageUnitUsers = role === 'admin' || (isGestorOuAdmin && p.canManageUnitUsers);
¬† ¬† const canManageUnitLists = role === 'admin' ||
(isGestorOuAdmin && p.canManageUnitLists);
// --- 2. Aplica√ß√£o das Restri√ß√µes na UI (Corrigida e Segura) ---
¬† ¬†¬†
¬† ¬† // Reseta visibilidade dos links de Admin.
¬† ¬† document.querySelectorAll('.restricted-admin-only').forEach(el => {
¬† ¬† ¬† ¬† if(el) el.style.display = 'block';
¬† ¬† });
// Oculta o R√≥tulo e Links de Admin se for Operacional
¬† ¬† if (role === 'operacional') {
        renderOperacionalCards();
 } else {
        // Para Admin e Gestor
        renderAdminGestorCards(canViewDashboardCards);
        // ‚úÖ CORRE√á√ÉO: Removido carregarConferenciasHoje() para evitar TypeError: Cannot set properties of null
    }

¬† ¬† // --- 2.1 Ajuste Fino dos Links de Gest√£o (para Gestores e Admin) ---
¬† ¬†¬†
¬† ¬† if (!canManageUnits) {¬†
¬† ¬† ¬† ¬† const linkUnidades = document.getElementById('link-unidades');
¬† ¬† ¬† ¬† if(linkUnidades) linkUnidades.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† if (!canManagePosts) {¬†
¬† ¬† ¬† ¬† const linkPostos = document.getElementById('link-postos');
¬† ¬† ¬† ¬† if(linkPostos) linkPostos.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† if (!canManageUnitUsers) {¬†
¬† ¬† ¬† ¬† const linkUsuarios = document.getElementById('link-usuarios');
¬† ¬† ¬† ¬† if(linkUsuarios) linkUsuarios.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† if (!canManageUnitLists) {¬†
¬† ¬† ¬† ¬† const linkListas = document.getElementById('link-listas');
¬† ¬† ¬† ¬† if(linkListas) linkListas.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† // Oculta o Hist√≥rico Global se a permiss√£o n√£o estiver marcada
¬† ¬† const globalHistoryLink = document.getElementById('link-global-history');
¬† ¬† if (!canViewUnitHistory && globalHistoryLink) {
¬† ¬† ¬† ¬† globalHistoryLink.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† // Ocultar R√≥tulo Admin se n√£o sobrou nenhum link
¬† ¬† const adminLinks = ['link-unidades', 'link-postos', 'link-usuarios', 'link-listas'];
¬† ¬† const anyAdminLinkVisible = adminLinks.some(id => {
¬† ¬† ¬† ¬† const el = document.getElementById(id);
¬† ¬† ¬† ¬† return el && el.style.display !== 'none';
¬† ¬† });
¬† ¬† const rotuloAdmin = document.getElementById('sidebar-rotulo-admin');
¬† ¬† if (!anyAdminLinkVisible && rotuloAdmin) {
¬† ¬† ¬† ¬† rotuloAdmin.style.display = 'none';
¬† ¬† }

    // --- 3. Chamadas de Dados Comuns (Manter) ---
    carregarListasParaNovaConferencia(); // Preenche o modal "Iniciar Confer√™ncia"
    verificarConferenciaAtiva(); // Renderiza o card de "Continuar Confer√™ncia"
    
¬† ¬† // ===================================
¬† ¬† // SOLU√á√ÉO PARA INICIAR O MENU FECHADO
¬† ¬† // ===================================
¬† ¬† closeMenuMobile();
// --- Trava do Bot√£o Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o bot√£o Voltar do navegador
        history.pushState(null, null, location.href);
    }
    // ----------------------------------------------

¬† ¬† // Garante que a vis√£o seja o dashboard ao logar
¬† ¬† switchView('dashboard');
}
            // --- NOVO: Cards Espec√≠ficos para Operacional ---
function renderOperacionalCards() {
    const container = document.getElementById('operacional-cards-container');
    if (!container) return;
    
    // Esconde o container de Admin/Gestor se existir
    const adminContainer = document.getElementById('admin-gestor-cards-container');
    if(adminContainer) adminContainer.style.display = 'none';

    container.innerHTML = `
        
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-calendar-day"></i> Confer√™ncias Realizadas Hoje (Minhas)</h2>
            <ul id="today-list" class="history-list">
                <li style="text-align:center; color:#999; padding:20px;">Carregando...</li>
            </ul>
        </div>

        <div class="op-card history" style="margin-top: 25px;">
            <h2 class="op-card-title" style="margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> Dashboard Operacional</h2>
            <div class="cards-grid">
                
                <div class="sector-card status-ok" onclick="switchView('my-history')">
                    <h3>Minhas Confer√™ncias</h3>
                    <div class="main-stat">
                        <span class="count-value" id="op-conf-count">0</span>
                        <i class="fas fa-history fa-2x" style="color:#1b8a3e;"></i>
                    </div>
                    <div class="card-footer">
                        Clique para ver o hist√≥rico completo.
                    </div>
                </div>

                <div class="sector-card status-unit" onclick="alert('Implementa√ß√£o futura: Minhas Cautelas Ativas')">
                    <h3>Minhas Cautelas Ativas</h3>
                    <div class="main-stat">
                        <span class="count-value">0</span>
                        <i class="fas fa-shield-alt fa-2x" style="color:#2c7399;"></i>
                    </div>
                    <div class="card-footer">
                        Itens que est√£o sob sua cautela.
                    </div>
                </div>

                <div class="sector-card status-posto" onclick="alert('Implementa√ß√£o futura: Cautelas Recebidas')">
                    <h3>Cautelas Recebidas</h3>
                    <div class="main-stat">
                        <span class="count-value">0</span>
                        <i class="fas fa-box-open fa-2x" style="color:#8e44ad;"></i>
                    </div>
                    <div class="card-footer">
                        Itens pendentes de recebimento/transfer√™ncia.
                    </div>
                </div>
                
            </div>
        </div>
    `;
    
    // [NOVO] Adicionar l√≥gica para atualizar a contagem de confer√™ncias hoje no card
    updateOperacionalCards();
    container.style.display = 'block';
}
// [NOVO] Atualiza a contagem do Card "Minhas Confer√™ncias"
async function updateOperacionalCards() {
    const ul = document.getElementById('today-list');
    const countEl = document.getElementById('op-conf-count');
    
    try {
        // --- 1. CONTAGEM TOTAL (NOVO) ---
        // Busca TODAS as confer√™ncias do usu√°rio (sem filtro de data)
        const snapTotal = await db.collection(COLECAO_RESULTADOS)
            .where('conferente', '==', currentUserData.nome_militar_completo)
            .get();
            
        const totalConferences = snapTotal.size; // ‚úÖ Captura o tamanho total da cole√ß√£o
        if (countEl) countEl.textContent = totalConferences; // Atualiza o card com o total
        
        // --- 2. CONTAGEM E LISTAGEM DO DIA (EXISTENTE) ---
        // Reutilizamos o snapTotal para filtrar APENAS os documentos de hoje, 
        // evitando uma segunda requisi√ß√£o grande ao Firestore.
        
        const hojeStr = new Date().toLocaleDateString('pt-BR');
        let countToday = 0; // Contagem das confer√™ncias de hoje
        let html = '';
        
        snapTotal.forEach(d => {
            const dt = d.data().timestamp.toDate();
            // Filtro de data para listar apenas as de hoje
            if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                html += criarItemHistoricoHTML(d.data());
                countToday++; // Contagem de hoje
            }
        });
        
        // Atualiza a lista de hoje
        ul.innerHTML = html ||
        '<li style="padding:15px; text-align:center; color:#999;">Nenhuma confer√™ncia hoje.</li>';
        
    } catch(e) { 
        console.error("Erro ao carregar dados operacionais:", e);
        if(countEl) countEl.textContent = 'Erro';
        ul.innerHTML = 'Erro.';
    }
}
            // --- NOVO: Cards Espec√≠ficos para Admin/Gestor ---
// --- NOVO: Cards Espec√≠ficos para Admin/Gestor ---
function renderAdminGestorCards(canViewDashboardCards) {
    const container = document.getElementById('admin-gestor-cards-container');
    if (!container) return;
    const opContainer = document.getElementById('operacional-cards-container');
    if(opContainer) opContainer.style.display = 'none';
    if (canViewDashboardCards) {
        container.innerHTML = `
            <div id="dash-cards-restricted" class="op-card history" style="padding-top: 15px;">
                <h2 class="op-card-title" style="font-size: 1.2em; margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Pend√™ncias da Unidade
                </h2>
                <div id="loading-message-dashboard">Carregando dados...</div>
                <div id="cards-container" class="cards-grid">
                    </div>
            </div>
        `;
            loadCaaData(); 
            container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
} 
¬† ¬† closeMenuMobile();¬†

    // --- Trava do Bot√£o Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o bot√£o Voltar do navegador
        history.pushState(null, null, location.href); 
    }
    // ----------------------------------------------

¬† ¬† // Garante que a vis√£o seja o dashboard ao logar
¬† ¬† switchView('dashboard');
        
        function atualizarSaudacao(user) {
            const now = new Date();
            const hour = now.getHours();
            let saudacao = "Bom dia";
            if (hour >= 12 && hour < 18) saudacao = "Boa tarde";
            else if (hour >= 18) saudacao = "Boa noite";
            
            const opcoesData = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let dataStr = now.toLocaleDateString('pt-BR', opcoesData);
            dataStr = dataStr.charAt(0).toUpperCase() + dataStr.slice(1);

            document.getElementById('greeting-text').textContent = saudacao + ",";
            document.getElementById('greeting-name').textContent = user.nome_militar_completo || user.nome_guerra;
            document.getElementById('current-date').textContent = dataStr;
            if(user.foto_url) document.getElementById('greeting-photo').src = user.foto_url;
        }

        // --- 2. VERIFICA√á√ÉO DE RESUME ---
        // --- 2. VERIFICA√á√ÉO DE RESUME ---
function verificarConferenciaAtiva() {
    const activeConf = localStorage.getItem('sigma_active_conf');
    const container = document.getElementById('resume-container');
    container.innerHTML = '';
    if (activeConf) {
        try {
            const confData = JSON.parse(activeConf);
            if(confData.user === currentUserData.nome_guerra) {
                container.innerHTML = `
                    <div class="op-card resume">
                        <button class="btn-resume-close" onclick="event.stopPropagation(); descartarConferenciaAtiva()">
                            <i class="fas fa-times"></i>
                        </button>
                        <div onclick="retomarConferencia('${confData.url}')" style="cursor: pointer;">
                            <h2 class="op-card-title" style="border:none; margin:0; color:#e65100;">
                                <i class="fas fa-play-circle"></i> Continuar: ${confData.nomeLista}
                            </h2>
                            <p style="margin:5px 0 0 30px; color:#666; font-size:0.9em;">
                                Clique para retomar de onde parou...
                            </p>
                        </div>
                    </div>`;
            }
        } catch(e) {}
    }
}

        function retomarConferencia(url) {
            const iframe = document.getElementById('app-iframe');
            const container = document.getElementById('app-runner-container');
            iframe.src = url;
            container.style.display = 'block';
        }
        // --- FUN√á√ÉO PARA DESCARTAR CONFER√äNCIA ATIVA ---
function descartarConferenciaAtiva() {
    const activeConf = localStorage.getItem('sigma_active_conf');
if (!activeConf) return; // N√£o h√° nada para descartar

    try {
        const confData = JSON.parse(activeConf);
        
        // CORRE√á√ÉO: Padroniza o nome de guerra lido do sigma_active_conf
        const userForDraft = (confData.user || 'ND').toUpperCase();
        
if (confirm("Tem certeza que deseja descartar esta confer√™ncia em andamento? Ela n√£o poder√° ser retomada!")) {
            // 1. Constr√≥i a chave do rascunho para limpeza (usando o nome padronizado)
            const draftKey = `sigma_draft_${confData.id}_${userForDraft}`;
// 2. Limpa o rascunho de progresso
            localStorage.removeItem(draftKey);
// 3. Limpa o card de resumo
            localStorage.removeItem('sigma_active_conf');
// 4. Atualiza UI
            verificarConferenciaAtiva(); 
            alert("Confer√™ncia e rascunho descartados.");
}
    } catch(e) {
        console.error("Erro ao descartar conf:", e);
        // Limpa o card de resumo (apenas para corrigir o loop visual)
        localStorage.removeItem('sigma_active_conf');
        verificarConferenciaAtiva();
    }
}

        // --- 3. DASHBOARD HIER√ÅRQUICO ---
        async function loadCaaData() {
            const container = document.getElementById('cards-container');
            container.innerHTML = 'Carregando...';
            const loading = document.getElementById('loading-message-dashboard');
            loading.style.display = 'block';
            
            try {
                const rotasDoc = await db.collection('config_geral').doc('rotas').get();
                const rotas = rotasDoc.data() || {};
                const listToUnitMap = {};
                
                // Objeto para mapear o ID √öNICO da ROTA/LISTA ao nome da Unidade
                Object.keys(rotas).forEach(key => {
                    // key √© o ID da lista (ex: "alfa_permanencia")
                    if (!key.toLowerCase().includes('bravo 5') && rotas[key].ativo !== false) {
                        listToUnitMap[key] = rotas[key].unidade || 'GERAL';
                    }
                });
                
                const snap = await db.collection(COLECAO_RESULTADOS).limit(100).get();
                
                // ALTERA√á√ÉO CR√çTICA: 'map' agora usar√° o LISTA_ID como chave, n√£o o NOME do local.
                const map = {}; 
                const docs = [];
                snap.forEach(d => docs.push({id:d.id, ...d.data()}));
                
                // Ordena√ß√£o por tempo (mais recente primeiro)
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                docs.forEach(d => {
                    const listaId = d.lista_id; // Usamos o ID √∫nico do resultado
                    
                    // Condi√ß√£o crucial: S√≥ processa se a lista existir no mapa filtrado (rotas)
                    if (!rotas[listaId]) return; 

                    // Filtro de seguran√ßa (para Gestores)
                    const listUnit = rotas[listaId].unidade || 'GERAL';
                    if (currentUserData.role === 'gestor' && listUnit !== currentUserData.unidade) return;

                    // CORRE√á√ÉO: Usamos o listaId como chave para garantir unicidade.
                    // A primeira a ser encontrada (a mais recente) √© a que prevalece.
                    if (!map[listaId]) {
                        map[listaId] = { 
                            docId: d.id, 
                            local: d.local, 
                            conferente: d.conferente, 
                            date: d.timestamp.toDate().toLocaleString(), 
                            items: d.itensCaa || [] 
                        };
                    }
                });
                
                // Passamos o novo mapa baseado em ID para renderizar os cards
                renderCards(map); 
            } catch (e) { 
                console.error(e); 
                container.innerHTML = 'Erro ao carregar.';
            } finally { 
                loading.style.display = 'none';
            }
        }
        
       
        async function renderCards(map) {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';
    const keys = Object.keys(map);
    
    // 1. CARREGAR ROTAS PARA MAPEAMENTO DE UNIDADE
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    if (keys.length === 0) { 
        container.innerHTML = '<p style="padding:20px;">Nenhuma pend√™ncia encontrada.</p>';
        return;
    }

    // 2. AGRUPAR CARDS POR UNIDADE
    const groupedCards = {};
    keys.forEach(listaId => {
        const d = map[listaId];
        // Busca a Unidade associada a esta lista_id na cole√ß√£o 'rotas'
        const unit = rotas[listaId]?.unidade || 'GERAL'; 
        
        if (!groupedCards[unit]) {
            groupedCards[unit] = [];
        }
        groupedCards[unit].push(d);
    });

    // 3. RENDERIZAR AGRUPADO POR UNIDADE (Restaura o agrupamento e o empilhamento)
    const sortedUnits = Object.keys(groupedCards).sort();
sortedUnits.forEach(unit => {
        const cardsList = groupedCards[unit];
        
        // --- Cabe√ßalho da Unidade ---
       const unitHeader = document.createElement('h3');
        unitHeader.className = 'unit-header';
        
        // Restaura as regras inline necess√°rias (removendo as que causavam o erro de JS)
        unitHeader.style.cssText = 'display: block; width: 100%; color: #800020; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; box-sizing: border-box; font-size: 1.2em;'; 
        
        // NOVO HTML: Usa a estrutura Flexbox para o alinhamento vertical
        unitHeader.innerHTML = `
            <div class="unit-flex-title">
                <i class="fas fa-building"></i>
                <span>${unit}</span>
            </div>
        `;
        container.appendChild(unitHeader); 
        
        // --- Container dos Cards da Unidade ---
        // Aqui n√£o precisamos criar um novo grid, apenas adicionamos os cards ao container principal (container).
        cardsList.forEach(d => {
            const items = d.items || [];
            const count = items.filter(i => i.statusAdmin !== 'Solucionado').length; 
            
            const div = document.createElement('div');
            // O CSS para .sector-card (flex: 0 0 280px) permite que ele se organize lado a lado
            div.className = `sector-card ${count === 0 ? 'status-ok' : 'status-alert'}`;
            div.innerHTML = `
                <h3>${d.local}</h3>
                <div class="main-stat">
                    <span class="count-value">${count === 0 ? 'OK' : count}</span>
                </div>
                <div class="card-footer">
                    <strong>${d.conferente}</strong><br>${d.date}
                </div>
            `;
            div.onclick = () => mostrarTabela(d);
            container.appendChild(div); // Adiciona o card ao container principal (que √© um flexbox)
        });
    });
    
    if (container.children.length === 0) {
        container.innerHTML = '<p style="padding:20px;">Nenhuma pend√™ncia encontrada para sua unidade ou permiss√£o.</p>';
    }
}
        // --- 4. NOVA CONFER√äNCIA ---
        async function carregarListasParaNovaConferencia() {
            try {
                const doc = await db.collection('config_geral').doc('rotas').get();
                const rotas = doc.data();
                allLists = []; 
                const setores = new Set();
                
                Object.entries(rotas).forEach(([id, info]) => {
                    if (info.ativo !== false && id !== 'ABT-17' && id !== 'ABT-18' && id.indexOf('bravo 5') === -1) {
                        allLists.push({ id: id, nome: info.nome, setor: info.posto });
                        setores.add(info.posto);
                    }
                });
                
                const sel = document.getElementById('dash-select-setor');
                sel.innerHTML = '<option value="" disabled selected>Selecione o Setor...</option>';
                
                Array.from(setores).sort().forEach(s => {
                    const opt = document.createElement('option'); 
                    opt.value = s; 
                    opt.textContent = s; 
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        function filtrarListasDashboard() {
            const setor = document.getElementById('dash-select-setor').value;
            const selLista = document.getElementById('dash-select-lista');
            selLista.innerHTML = '<option value="" disabled selected>Selecione a Lista...</option>'; 
            selLista.disabled = false;
            
            const fil = allLists.filter(l => l.setor === setor).sort((a,b)=>a.nome.localeCompare(b.nome));
            fil.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l.id; 
                o.textContent = l.nome; 
                selLista.appendChild(o); 
            });
            selLista.focus();
        }

        function focarBotaoIniciar() { 
            document.getElementById('btn-start-dash').focus();
        }

        function iniciarConferenciaDashboard() {
            const listaId = document.getElementById('dash-select-lista').value;
            const listaSelect = document.getElementById('dash-select-lista');
            const nomeLista = listaSelect.options[listaSelect.selectedIndex].text;
            
            if(!listaId) return alert("Selecione uma lista.");
            
            // --- CORRE√á√ÉO: Padroniza o nome do usu√°rio para a chave do rascunho ---
            // Define o nome de guerra em MAI√öSCULAS para consist√™ncia.
            const userForDraft = (currentUserData.nome_guerra || 'ND').toUpperCase();
            
            // Constr√≥i a URL com o user padronizado (para leitura no app)
            const url = `conferencia_app.html?id=${listaId}&posto_grad=${encodeURIComponent(currentUserData.posto)}&quadro_mil=${encodeURIComponent(currentUserData.quadro)}&nome_guerra=${encodeURIComponent(userForDraft)}`;
            
            // Salva para resume
            localStorage.setItem('sigma_active_conf', JSON.stringify({
                id: listaId, 
                nomeLista: nomeLista, 
                user: userForDraft, // <-- CHAVE PADRONIZADA
                url: url
            }));
            verificarConferenciaAtiva();
            document.getElementById('modal-nova-conferencia').style.display = 'none';
            
            // --- L√ìGICA DE ABERTURA DO IFRAME (RE-INSERIDA) ---
            const container = document.getElementById('app-runner-container');
            const iframe = document.getElementById('app-iframe');
            iframe.src = url; 
            container.style.display = 'block';
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'SIGMA_FINISHED') {
                document.getElementById('app-runner-container').style.display = 'none';
                document.getElementById('app-iframe').src = "";
                
                localStorage.removeItem('sigma_active_conf');
    
                verificarConferenciaAtiva();

                loadCaaData();
                carregarConferenciasHoje();
                alert("Confer√™ncia salva!");
            }
        });
        
        // --- 5. HIST√ìRICOS ---
        async function carregarConferenciasHoje() {
            const ul = document.getElementById('today-list');
            ul.innerHTML = '<li>Carregando...</li>';
            try {
                const snap = await db.collection(COLECAO_RESULTADOS).where('conferente', '==', currentUserData.nome_militar_completo).limit(20).get();
                const hojeStr = new Date().toLocaleDateString('pt-BR');
                let docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
                
                let html = '';
                docs.forEach(d => {
                    const dt = d.timestamp.toDate();
                    if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                        html += criarItemHistoricoHTML(d);
                    }
                });
                
                ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nenhuma confer√™ncia hoje.</li>';
            } catch(e){ 
                console.error(e); 
                ul.innerHTML = 'Erro.';
            }
        }

        async function loadMyHistory() {
    const ul = document.getElementById('my-history-list');
    ul.innerHTML = '<li>Buscando...</li>';
    
    // 1. Cria objetos Date dos campos de input, garantindo o in√≠cio e fim do dia
    const startDateInput = document.getElementById('my-hist-start').value;
    const endDateInput = document.getElementById('my-hist-end').value;

    if (!startDateInput || !endDateInput) {
        ul.innerHTML = '<li>Selecione as datas para filtrar.</li>';
        return;
    }

    // 2. Cria Timestamps para filtro do Firestore
    // dI: Come√ßo do dia (00:00:00)
    const dI = new Date(startDateInput + 'T00:00:00'); 
    // dF: Final do dia (23:59:59), adicionamos um segundo extra para garantir a inclus√£o
    const dF = new Date(endDateInput + 'T23:59:59'); 

    // Converte para Timestamps do Firebase
    const startTimestamp = firebase.firestore.Timestamp.fromDate(dI);
    const endTimestamp = firebase.firestore.Timestamp.fromDate(dF);

    try {
        // 3. Executa a consulta no Firestore com o filtro de data (query otimizada)
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('conferente', '==', currentUserData.nome_militar_completo)
            .where('timestamp', '>=', startTimestamp) // Data de in√≠cio
            .where('timestamp', '<=', endTimestamp)   // Data de fim
            .orderBy('timestamp', 'desc') // Ordena (necess√°rio ao usar where em timestamp)
            .limit(100)
            .get();
            
        let docs = [];
        snap.forEach(doc => docs.push(doc.data()));

        let html = '';
        docs.forEach(d => {
            html += criarItemHistoricoHTML(d);
        });
        
        ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nada encontrado no per√≠odo selecionado.</li>';
        
    } catch(e){ 
        console.error("Erro no loadMyHistory:", e);
        ul.innerHTML='<li>Erro ao carregar hist√≥rico.</li>';
    }
}

    async function loadGlobalHistory() {
    const ul = document.getElementById('global-history-list');
    ul.innerHTML = '<li>Buscando...</li>';
    
    // Captura o valor dos filtros
    const dI = new Date(document.getElementById('glob-hist-start').value + 'T00:00:00');
    const dF = new Date(document.getElementById('glob-hist-end').value + 'T23:59:59');
    const localFilter = document.getElementById('glob-hist-local').value;
    const conferenteFilter = document.getElementById('glob-hist-user').value; // Valor do Conferente

    try {
        // 1. Inicia a consulta com os filtros de data (obrigat√≥rio para orderBy)
        let queryRef = db.collection(COLECAO_RESULTADOS)
            .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(dI))
            .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(dF))
            .orderBy('timestamp', 'desc');

        // 2. CORRE√á√ÉO: Aplica o filtro 'where' se um Conferente espec√≠fico for selecionado
        if (conferenteFilter) {
            queryRef = queryRef.where('conferente', '==', conferenteFilter);
        }

        const snap = await queryRef.limit(100).get();
        
        // Carrega o mapeamento de Unidades (necess√°rio para o filtro de Gestor)
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const listToUnitMap = {};
        Object.keys(rotas).forEach(key => listToUnitMap[rotas[key].nome] = rotas[key].unidade || 'GERAL');

        let docs = [];
        snap.forEach(d => docs.push(d.data()));

        let html = '';
        docs.forEach(d => {
            const localNome = d.local.split(' - ')[1] || d.local;
            const unit = listToUnitMap[localNome] || 'GERAL';

            // Filtro de seguran√ßa (Gestor)
            if(currentUserData.role === 'gestor' && unit !== currentUserData.unidade) return; 
            
            // Filtro Local: s√≥ aplica na mem√≥ria se for necess√°rio
            if(!localFilter || localNome === localFilter) {
                html += criarItemHistoricoHTML(d);
            }
        });

        ul.innerHTML = html || '<li>Nada encontrado.</li>';
    } catch(e){ 
        console.error("Erro ao carregar hist√≥rico global:", e);
        ul.innerHTML='Erro ao carregar hist√≥rico.';
    }
}
        function criarItemHistoricoHTML(data) {
            const dataHora = data.timestamp.toDate().toLocaleString('pt-BR');
            const temAlteracao = (data.itensRelatorio && data.itensRelatorio.some(i => i.status !== 'S/A')) || (!data.itensRelatorio && data.totalCaa > 0);
            
            return `<li class="history-item"><div class="hist-info"><strong>${data.local}</strong><small>${data.conferente} ‚Ä¢ ${dataHora}</small></div><div style="display:flex;align-items:center;"><span class="hist-status ${temAlteracao?'status-alert':'status-ok'}">${temAlteracao?'C/A':'S/A'}</span><button class="btn-reprint" onclick='reimprimirPDF(${JSON.stringify(data)})'><i class="fas fa-file-pdf"></i></button></div></li>`;
        }

        // --- 6. GEST√ÉO DE UNIDADES (ADMIN) ---
        async function carregarUnidadesVisuais() {
    const container = document.getElementById('units-cards-container');
    container.innerHTML = 'Carregando...';
    
    // --- Vari√°veis de Restri√ß√£o ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // -----------------------------
    
    try {
        const unitsDoc = await db.collection('config_geral').doc('unidades').get();
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const unidades = unitsDoc.data().lista || [];
        const rotas = rotasDoc.data() || {};

        container.innerHTML = '';
        unidades.forEach(u => {
            const listsInUnit = Object.values(rotas).filter(r => r.unidade === u).map(r => r.nome);
            const card = document.createElement('div');
            card.className = 'sector-card status-unit';
            card.innerHTML = `<h3>${u}</h3><div class="card-footer"><strong>Cont√©m:</strong><ul class="sub-list-preview">${listsInUnit.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
            card.onclick = () => abrirGestaoUnidade(u, rotas);
            container.appendChild(card);
        });

        // --- NOVO: FILTRAGEM DOS LOCAIS PARA O SELECT DO HIST√ìRICO GLOBAL ---
        const sel = document.getElementById('glob-hist-local');
        // Garante que o elemento existe e reseta com a op√ß√£o "Todos"
        if(sel) sel.innerHTML = '<option value="">Todos</option>'; 
        
        if(sel) {
            // 1. Mapeia todas as rotas (viaturas/listas) ativas
            let locaisFiltrados = Object.values(rotas)
                .filter(r => r.ativo !== false) 
                // 2. Aplica a restri√ß√£o: Se for gestor, s√≥ mostra as rotas da sua unidade.
                .filter(r => !isGestor || r.unidade === unidadeGestor) 
                .map(r => r.nome); 

            // 3. Remove duplicatas e ordena
            const locaisUnicos = [...new Set(locaisFiltrados)].sort();
            
            locaisUnicos.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l; 
                o.text = l; 
                sel.appendChild(o); 
            });
        }
    } catch(e){ 
        console.error("Erro ao carregar unidades visuais:", e);
        container.innerHTML='Erro ao carregar dados.';
    }
}
        function abrirGestaoUnidade(unitName, allRotas) {
            document.getElementById('edit-unit-original-name').value = unitName;
            document.getElementById('edit-unit-name-input').value = unitName;
            const checklist = document.getElementById('unit-lists-checklist');
            checklist.innerHTML = '';
            
            Object.entries(allRotas).forEach(([id, r]) => {
                if(r.ativo === false) return;
                const div = document.createElement('div');
                div.className = 'checklist-item';
                const isChecked = (r.unidade === unitName) ? 'checked' : '';
                
                div.innerHTML = `<input type="checkbox" id="chk-${id}" ${isChecked} value="${id}"> <label for="chk-${id}" style="margin:0;font-weight:normal;">${r.nome} (${r.posto})</label>`;
                checklist.appendChild(div);
            });
            document.getElementById('modal-unit-manager').style.display = 'flex';
        }

        async function salvarAlteracoesUnidade() {
            const oldName = document.getElementById('edit-unit-original-name').value;
            const newName = document.getElementById('edit-unit-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome inv√°lido");
            
            try {
                const unitsRef = db.collection('config_geral').doc('unidades');
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#unit-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    if (chk.checked) {
                        rotasData[id].unidade = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: newName });
                    } else if (rotasData[id].unidade === oldName) {
                        rotasData[id].unidade = null; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: null });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!"); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirUnidade() {
            const name = document.getElementById('edit-unit-original-name').value;
            if(!confirm(`Excluir a unidade ${name}? As listas perder√£o o v√≠nculo.`)) return;
            
            try {
                await db.collection('config_geral').doc('unidades').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const s = await rotasRef.get(); 
                const d = s.data();
                
                Object.keys(d).forEach(k => { 
                    if(d[k].unidade === name) d[k].unidade = null; 
                });
                
                await rotasRef.set(d);
                alert("Exclu√≠do."); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e){ 
                alert("Erro");
            }
        }

        // --- 6.5 GEST√ÉO DE POSTOS (NOVO!) ---
        async function carregarPostosVisuais() {
            const container = document.getElementById('postos-cards-container');
            if(!container) return;
            container.innerHTML = 'Carregando...';
            
            try {
                const postosDoc = await db.collection('config_geral').doc('postos').get();
                const rotasDoc = await db.collection('config_geral').doc('rotas').get();
                const postos = postosDoc.exists ? (postosDoc.data().lista || []) : [];
                const rotas = rotasDoc.data() || {};

                container.innerHTML = '';
                postos.sort().forEach(p => {
                    const listsInPosto = Object.values(rotas).filter(r => r.posto === p).map(r => r.nome);
                    const card = document.createElement('div');
                    card.className = 'sector-card status-posto';
                   
                    card.innerHTML = `<h3>${p}</h3><div class="card-footer"><strong>Cont√©m:</strong><ul class="sub-list-preview">${listsInPosto.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
                    card.onclick = () => abrirGestaoPosto(p, rotas);
                    container.appendChild(card);
                });
            } catch(e){ 
                container.innerHTML='Erro'; 
            }
        }

        function criarPosto() {
            const nome = document.getElementById('new-posto-name').value.trim().toUpperCase();
            if(!nome) return alert("Digite o nome.");
            
            db.collection('config_geral').doc('postos').set({ lista: firebase.firestore.FieldValue.arrayUnion(nome) }, { merge: true })
            .then(() => { 
                alert("Posto criado!"); 
                carregarPostosVisuais(); 
            })
            .catch(e => alert("Erro: " + e.message));
        }

        function abrirGestaoPosto(postoName, allRotas) {
            document.getElementById('edit-posto-original-name').value = postoName;
            document.getElementById('edit-posto-name-input').value = postoName;
            
            const checklist = document.getElementById('posto-lists-checklist');
            checklist.innerHTML = '';
            
            Object.entries(allRotas).forEach(([id, r]) => {
                if(r.ativo === false) return;
                const div = document.createElement('div');
                div.className = 'checklist-item';
                const isChecked = (r.posto === postoName) ? 'checked' : '';
                
                div.innerHTML = `<input type="checkbox" id="chk-p-${id}" ${isChecked} value="${id}"> <label for="chk-${id}" style="margin:0;font-weight:normal;">${r.nome}</label>`;
                checklist.appendChild(div);
            });
            document.getElementById('modal-posto-manager').style.display = 'flex';
        }

        async function salvarAlteracoesPosto() {
            const oldName = document.getElementById('edit-posto-original-name').value;
            const newName = document.getElementById('edit-posto-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome inv√°lido");

            try {
                // 1. Atualizar lista de postos
                const postosRef = db.collection('config_geral').doc('postos');
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                // 2. Atualizar v√≠nculos das rotas
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#posto-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    // Simplifica√ß√£o: Checkbox marcado = define posto.
                    if (chk.checked) {
                        rotasData[id].posto = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ posto: newName });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!");
                document.getElementById('modal-posto-manager').style.display = 'none';
                carregarPostosVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirPosto() {
            const name = document.getElementById('edit-posto-original-name').value;
            if(!confirm(`Excluir o posto ${name}?`)) return;
            
            try {
                await db.collection('config_geral').doc('postos').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                alert("Exclu√≠do."); 
                document.getElementById('modal-posto-manager').style.display = 'none'; 
                carregarPostosVisuais();
            } catch(e){ 
                alert("Erro"); 
            }
        }

        // --- FUN√á√ïES DE FORMATA√á√ÉO DE TEXTO (NECESS√ÅRIAS PARA O PDF) ---

function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    // Adicionando a fun√ß√£o formatarDataSimples do outro arquivo
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('pt-BR');
}

const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    // L√≥gica para incluir a resposta do admin no topo (Linhas 127-128 do app)
    if (adminStatus) linhas.push(`‚ö†Ô∏è [${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
    
    const separator = ' | + NOVA: ';
    // L√≥gica para separar as observa√ß√µes concatenadas (Linhas 128-134 do app)
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
            const match = p.match(regex);
            // Se estiver assinada (formato mais antigo/incompleto)
            if (match) linhas.push(`‚Ä¢ Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            // Se for apenas texto (mais novo) ou texto quebrado do hist√≥rico
            else linhas.push(`‚Ä¢ Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
        const match = p.match(regex);
        // Se for a primeira observa√ß√£o completa (novo padr√£o)
        if (match) linhas.push(`‚Ä¢ Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        // Se for um texto simples sem assinatura
        else linhas.push(`‚Ä¢ Por: ${autorAtual} em ${dataAtual}: "${p}"`);
    }
    return linhas;
};

// Fun√ß√£o wrapper apenas para manter a consist√™ncia com o app (n√£o usada no PDF)
const gerarHtmlVisual = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = gerarLinhasFormatadas(textoBruto, autorAtual, dataAtual, adminStatus, adminObs);
    let html = '<ul class="lista-pendencias">';
    linhas.forEach(l => { 
        if (l.includes('(Admin):')) { 
            const parts = l.split('): ');
            html += `<li><span class="texto-admin">‚ö†Ô∏è ${parts[0]}):</span> Resp: ${parts[1]}</li>`; 
        } else { 
            html += `<li class="linha-obs">${l}</li>`; 
        } 
    });
    html += '</ul>';
    return html;
};

// --- PDF GENERATOR (FUN√á√ÉO ATUALIZADA) ---
function reimprimirPDF(data) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const MARGIN = 14, PG_W = 210, LOGO_S = 15;

        // MANT√âM A L√ìGICA DE BUSCA DE IMAGEM DO DASHBOARD
        // Busca a imagem j√° carregada no DOM para desenhar no PDF
        const logoDraw = (domId, x) => { 
            // Utilizamos uma consulta que verifica se o src cont√©m o domId
            const el = document.querySelector(`img[src*="${domId}"]`);
            if(el) { 
                try{
                    const c=document.createElement('canvas');
                    c.width=160;
                    c.height=160;
                    c.getContext('2d').drawImage(el,0,0,160,160);
                    // Adiciona a imagem ao PDF
                    doc.addImage(c.toDataURL('image/png'),'PNG',x,10,LOGO_S,LOGO_S);
                }catch(e){
                    // Em caso de falha no canvas (como CORS), o processo continua
                    console.warn(`Falha ao desenhar imagem ${domId}`);
                } 
            } else {
                 console.warn(`Elemento img[src*="${domId}"] n√£o encontrado no DOM. O logo n√£o ser√° exibido.`);
            }
        };
        
        // --- CHAMADAS PARA DESENHAR AS LOGOS ---
        // 1. Logo CBM-RR (Esquerda)
        logoDraw('cbmrr.png', MARGIN);
        // 2. Logo SIGMA (Direita)
        logoDraw('logo_sigma.png', PG_W-MARGIN-LOGO_S);
        
        // CABE√áALHO
        doc.setFontSize(10);
        doc.setTextColor(51); 
        doc.setFont('helvetica','bold');
        doc.text('GOVERNO DE RORAIMA', PG_W/2, 15, {align:'center'}); 
        doc.setTextColor(217,15,35);
        doc.text('CORPO DE BOMBEIROS MILITAR DE RORAIMA', PG_W/2, 20, {align:'center'}); 
        doc.setTextColor(51); 
        doc.setFont('helvetica','italic');
        doc.text('"Amaz√¥nia: patrim√¥nio dos brasileiros"', PG_W/2, 25, {align:'center'});
        doc.setFontSize(14); 
        doc.setTextColor(0);
        doc.setFont('helvetica','bold'); 
        doc.text("RELAT√ìRIO DE CONFER√äNCIA", PG_W/2, 35, {align:'center'});

        // INFORMA√á√ïES DE BASE
        doc.setFillColor(240, 240, 240);
        doc.setDrawColor(200, 200, 200); 
        doc.roundedRect(MARGIN, 40, PG_W - (MARGIN*2), 25, 2, 2, 'FD');
        
        doc.setFontSize(10); 
        doc.setTextColor(50);
        let y = 46;
        const X_LABEL = MARGIN + 5; 
        const X_VAL = MARGIN + 30;
        
        const dataTimestamp = data.timestamp ?
        new Date(data.timestamp.seconds * 1000) : new Date();
        const dataHoraStr = dataTimestamp.toLocaleString('pt-BR');
        
        doc.setFont('helvetica','bold'); 
        doc.text('Local:', X_LABEL, y); 
        doc.setFont('helvetica','normal');
        doc.text(data.local || '', X_VAL, y); 
        y+=6; 
        doc.setFont('helvetica','bold'); 
        doc.text('Conferente:', X_LABEL, y); 
        doc.setFont('helvetica','normal'); 
        doc.text(data.conferente || '', X_VAL, y); 
        y+=6; 
        doc.setFont('helvetica','bold');
        doc.text('Data/Hora:', X_LABEL, y); 
        doc.setFont('helvetica','normal'); 
        doc.text(dataHoraStr, X_VAL, y); 
        
        // TOTALIZADOR
        doc.setFont('helvetica','bold');
        doc.setTextColor(128, 0, 32);
        doc.text(`TOTAL: ${data.totalItensConferidos || 0} | C/A: ${data.totalCaa || 0}`, PG_W - MARGIN - 5, 46, {align:'right'});

        // TABELA DE ITENS
        let tableBody = [];
        const RED_FILL = [217, 15, 35]; 
        const GREEN_FILL = [27, 138, 62]; 
        const SECTOR_BG = [60, 60, 60];
        let listaParaImprimir = [];
        
        if (data.itensRelatorio && data.itensRelatorio.length > 0) listaParaImprimir = data.itensRelatorio;
        else if (data.itensCaa && data.itensCaa.length > 0) listaParaImprimir = data.itensCaa;
        else tableBody.push([{ content: 'CONFER√äNCIA REALIZADA SEM ALTERA√á√ïES (REGISTRO LEGADO)', colSpan: 4, styles: { halign: 'center', fillColor: GREEN_FILL, textColor: 255, fontStyle: 'bold', cellPadding: 5 } }]);
        
        if (listaParaImprimir.length > 0) {
            let currentSector = null;
            listaParaImprimir.forEach(item => {
                // L√≥gica de Agrupamento por Setor
                let setorItem = item.setor || "ITENS GERAIS";
                if(setorItem !== currentSector) {
                    tableBody.push([{ content: setorItem.toUpperCase(), colSpan: 4, styles: { fillColor: SECTOR_BG, textColor: 255, fontStyle: 'bold', halign: 'left' } }]);
                    currentSector = setorItem;
                }

                // L√≥gica de Formata√ß√£o de Observa√ß√µes
                let finalObs = item.obs || '-';
                
                // ADICIONADO: Vari√°veis de contexto para a formata√ß√£o
                const dataConf = dataTimestamp.toLocaleDateString('pt-BR');
                const conf = data.conferente; 
                
                // 1. Usa a fun√ß√£o padr√£o para obter o array de linhas formatadas
                let linhasFormatadas = [];
                if (finalObs !== '-') {
                    linhasFormatadas = gerarLinhasFormatadas(
                        finalObs, 
                        conf, 
                        dataConf,
                        item.statusAdmin, 
                        item.adminObs
                    );
                }
                
                // 2. Transforma o array de linhas em uma string separada por quebra de linha
                // O prefixo '‚Ä¢' j√° est√° incluso na fun√ß√£o gerarLinhasFormatadas para observa√ß√µes.
                finalObs = linhasFormatadas.map(l => {
                    // Substitui o prefixo de admin (ex: "‚ö†Ô∏è [SOLUCIONADO] (Admin):") para um formato de relat√≥rio mais limpo
                    if(l.includes('(Admin):')) {
                        return l.replace('‚ö†Ô∏è ', 'RESPOSTA DA GEST√ÉO: ');
                    }
                    return l;
                }).join('\n');
                
                if (finalObs.trim() === '') finalObs = '-'; // Volta para '-' se ficar vazio.

                // FIM DA L√ìGICA DE FORMATA√á√ÉO DE OBSERVA√á√ïES
                
                let bgStatus = GREEN_FILL;
                if (item.status === 'C/A' || item.status === 'KEEP') bgStatus = RED_FILL;
                
                // Adiciona a linha √† tabela
                tableBody.push([ 
                    item.nomeCompleto || 'Item', 
                    { content: `QTD: ${item.quantidade || 1}`, styles: { halign: 'center', valign: 'middle' } }, 
                    { content: item.status || 'S/A', styles: { fillColor: bgStatus, textColor: 255, fontStyle: 'bold', halign: 'center', valign: 'middle' } }, 
                    { content: finalObs, styles: { halign: 'left', valign: 'middle' } } 
                ]);
            });
        }
        
        // Configura√ß√£o e Gera√ß√£o da Tabela
        doc.autoTable({ 
            startY: 70, 
            head: [['Item', 'Quantidade', 'Status', 'Observa√ß√£o']], 
            body: tableBody, 
            theme: 'striped', 
            styles: { fontSize: 8, valign: 'middle', textColor: 51, cellPadding: 1.5 }, 
            columnStyles: { 
                0:{cellWidth:80, halign:'left'}, 
                1:{cellWidth:20,halign:'center'}, 
                2:{cellWidth:20,halign:'center'}, 
                3:{cellWidth:'auto',halign:'left'} 
            }, 
            headStyles: { fillColor: [128, 0, 32], textColor: 255, fontStyle: 'bold', halign: 'center' } 
        });

        // Rodap√© com Pagina√ß√£o
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8); 
            doc.setTextColor(100);
            doc.text('SIGMA - Sistema Integrado de Gest√£o de Materiais', MARGIN, doc.internal.pageSize.height-10);
            doc.text(`P√°g. ${i} de ${totalPages}`, PG_W-MARGIN, doc.internal.pageSize.height-10, {align:'right'});
        }
        
        // Nome do Arquivo
        const nomeArquivo = `Relatorio_${(data.local||'Conf').replace(/[^a-zA-Z0-9]/g,'')}_${dataTimestamp.toISOString().split('T')[0]}.pdf`;
        doc.save(nomeArquivo);
        
    } catch(e) { 
        console.error(e);
        alert("Erro ao gerar PDF: " + e.message);
    }
}
        // --- OUTROS E FUN√á√ïES GLOBAIS (UI) ---
        
        function sairDoSistema() { 
            auth.signOut().then(() => { 
                sessionStorage.clear(); 
                window.location.href = 'index.html'; 
            });
        }
        function logout() {
            sairDoSistema();
        }
        
        function switchView(v) {
        // Esconde todas as se√ß√µes de visualiza√ß√£o
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
// Mostra a se√ß√£o desejada
    const viewElement = document.getElementById(`view-${v}`);
if (viewElement) {
        viewElement.style.display = 'block';
} else {
        console.error(`View n√£o encontrada: view-${v}`);
        return;
}
    
    // Remove a classe 'active' de todos os links e adiciona ao link clicado
    document.querySelectorAll('#main-sidebar a').forEach(el => el.classList.remove('active'));
const activeLink = document.getElementById(`link-${v}`);
    if (activeLink) {
        activeLink.classList.add('active');
}

    // --- A√á√ïES ESPEC√çFICAS POR VIEW ---
    if (v === 'unidades') {
        carregarUnidadesVisuais();
// Carrega os cards de Unidades/Rotas (Vis√£o Admin)
    }
    
    if (v === 'postos') {
        carregarPostosVisuais();
// Carrega os cards de Postos (Vis√£o Admin)
    }

    if (v === 'usuarios') {
        listarUsuarios();
// Carrega a tabela de usu√°rios (Vis√£o Admin/Gestor)
        carregarUnidadesSelect();
// Carrega o select de Unidades para o modal de cadastro/edi√ß√£o
    }
    
    if (v === 'listas') {
        carregarListaLocaisAdmin();
// Carrega a lista de Viaturas/Locais (Vis√£o Admin/Gestor)
    }

    if(v === 'global-history') {
        // Inicializa o filtro de data (√∫ltimos 30 dias)
        document.getElementById('glob-hist-start').valueAsDate = new Date(new Date().setDate(new Date().getDate()-30));
        document.getElementById('glob-hist-end').valueAsDate = new Date();
        
        
        // Carrega as op√ß√µes de Local (Viatura) e Filtra por Unidade do Gestor
        carregarUnidadesVisuais();
        // NOVO: Carrega as op√ß√µes de Conferente (Usu√°rio) e Filtra por Unidade do Gestor
        carregarUsuariosFiltro();
        // Carrega o hist√≥rico com os filtros iniciais
        loadGlobalHistory();
    }

    if(v === 'my-history') {
        // 1. Calcular a data de 30 dias atr√°s
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 30); // Subtrai 30 dias
        document.getElementById('my-hist-start').valueAsDate = startDate;
        document.getElementById('my-hist-end').valueAsDate = endDate;
        loadMyHistory();
    }

    // === SOLU√á√ÉO: FECHA O MENU AP√ìS SELE√á√ÉO NO MOBILE ===
    if (window.innerWidth <= 768) {
        history.pushState(null, null, location.href);
        closeMenuMobile();
    }
    // ===================================================
}
        function toggleMenuMobile() { 
            const s = document.getElementById('main-sidebar');
            if(s.classList.contains('mobile-active')) { 
                s.classList.remove('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='none'; 
            } else { 
                s.classList.add('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='block'; 
            } 
        }
        function closeMenuMobile() { 
    // Obt√©m o elemento sidebar
    const s = document.getElementById('main-sidebar');

    // Remove explicitamente a classe 'mobile-active' (fecha o menu),
    // independentemente do estado atual.
    if(s.classList.contains('mobile-active')) { 
        s.classList.remove('mobile-active'); 
        document.getElementById('mobile-overlay').style.display='none';
    } 
    // Remove a chamada a toggleMenuMobile()
}
        
        // --- FUN√á√ïES DO MODAL GEST√ÉO C/A ---
        function mostrarTabela(data) {
    const wrapper = document.getElementById('ca-table-wrapper'), tbody = document.getElementById('ca-list-body');
    document.getElementById('table-title').textContent = `Detalhes: ${data.local}`; 
    tbody.innerHTML = '';
    
    // Garante array
    const items = data.items || [];
    const itemsToShow = items.filter(i => i.statusAdmin !== 'Solucionado');
    
    if (itemsToShow.length === 0) { 
        wrapper.querySelector('table').style.display = 'none';
        document.getElementById('no-issues-msg').style.display = 'block';
    } else {
        wrapper.querySelector('table').style.display = 'table';
        document.getElementById('no-issues-msg').style.display = 'none';
        
        itemsToShow.forEach(i => {
            const tr = tbody.insertRow();
            
            // 1. Formata o hist√≥rico de observa√ß√µes usando a fun√ß√£o padronizada (HTML)
            const obsHtmlFormatada = gerarHtmlVisual(
                i.obs || '', 
                data.conferente, // Nome do conferente original (fallback)
                data.date, // Data da confer√™ncia original (fallback)
                i.statusAdmin, 
                i.adminObs
            );

            // 2. Define a classe do badge para o status de gest√£o
            const statusAdmin = i.statusAdmin || 'Pendente';
            // Garante que o status do Firebase (Ex: Em solu√ß√£o, Cautelado) seja min√∫sculo e com tra√ßo (Ex: em-solucao)
            const badgeClass = 'badge-' + statusAdmin.toLowerCase().replace(' ', '-');
            
            // INJE√á√ÉO DO DOC_ID DO PAI NO ITEM FILHO
            const itemComDocId = { ...i, docId: data.docId }; 
            
            tr.innerHTML = `
                <td><strong>${i.nomeCompleto}</strong></td>
                <td><span class="status-badge ${badgeClass}">${statusAdmin}</span></td>
                <td>${obsHtmlFormatada}</td>
                <td><small>${data.conferente}<br>${data.date}</small></td>
            `;
            
            const td = tr.insertCell(); 
            // Passa o item enriquecido para o modal de gest√£o
            td.innerHTML = `<button class="btn-modern-action btn-create" onclick='abrirModalGestao(${JSON.stringify(itemComDocId)})'>Gerenciar</button>`;
        });
    }
    wrapper.style.display = 'block';
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
        function fecharTabela(){ 
            document.getElementById('ca-table-wrapper').style.display='none';
        }
        
        function abrirModalGestao(i){
            document.getElementById('gestao-item-nome').textContent = i.nomeCompleto;
            document.getElementById('gestao-doc-id').value = i.docId; 
            document.getElementById('gestao-item-index').value = i.originalIndex;
            document.getElementById('gestao-item-id-lista').value = i.id; 
            document.getElementById('gestao-item-max-qtd').value = i.quantidade || 1;
            
            document.getElementById('gestao-status').value = i.statusAdmin || 'Solucionado';
            document.getElementById('gestao-obs').value = '';
            document.getElementById('gestao-qtd').value = '1';
            toggleGestaoQtd();

            document.getElementById('modal-gestao-ca').style.display = 'flex';
        }

        function fecharModalGestao(){ 
            document.getElementById('modal-gestao-ca').style.display='none';
        }

        function toggleGestaoQtd(){
            const isRemover = document.getElementById('gestao-status').value === 'Remover';
            document.getElementById('div-gestao-qtd').style.display = isRemover ? 'block' : 'none';
            if(isRemover) {
                const max = document.getElementById('gestao-item-max-qtd').value;
                document.getElementById('gestao-qtd').max = max;
                document.getElementById('gestao-qtd-info').textContent = `Estoque atual: ${max}`;
            }
        }

        document.getElementById('gestao-status').onchange = toggleGestaoQtd;
        
        async function salvarGestaoCa(){
    // [1] RECUPERA√á√ÉO DE DADOS DO MODAL
    const docId = document.getElementById('gestao-doc-id').value;
    const itemId = document.getElementById('gestao-item-id-lista').value;
    const status = document.getElementById('gestao-status').value;
    const obsRaw = document.getElementById('gestao-obs').value.trim();
    const qtdRemover = parseInt(document.getElementById('gestao-qtd').value);
    
    // [2] VALIDA√á√ÉO B√ÅSICA
    if(!obsRaw) return alert("Digite uma observa√ß√£o.");

    try {
        // [3] RECUPERA√á√ÉO DE METADADOS DO GESTOR E DATA/HORA
        const nomeGestor = `${currentUserData.posto} ${currentUserData.quadro} ${currentUserData.nome_guerra}`;
        // Usamos toLocaleString para um carimbo de hist√≥rico mais preciso e completo
        const dataHoraStr = new Date().toLocaleString('pt-BR');
        
        // Texto que ser√° carimbado na linha do HIST√ìRICO (item.obs)
        const carimboTextoHistorico = `[A√á√ÉO GESTOR: ${status.toUpperCase()}] ${obsRaw}` + 
                                    (status === 'Remover' ? ` (Removido ${qtdRemover} do estoque)` : '');

        // A linha completa a ser adicionada no hist√≥rico linear (formato padronizado)
        const novaLinhaObs = `"${carimboTextoHistorico}" (Por: ${nomeGestor} em ${dataHoraStr})`;
        
        // Texto para exibi√ß√£o no campo adminObs (mantemos o carimbo simples, pois a exibi√ß√£o √© feita via gerarHtmlVisual)
        const obsFinalDisplay = obsRaw; 


        // [4] BUSCA DO DOCUMENTO PAI NO FIREBASE
        const ref = db.collection(COLECAO_RESULTADOS).doc(docId);
        const snap = await ref.get();
        if(!snap.exists) return alert("Erro: Confer√™ncia n√£o encontrada.");
        
        const resData = snap.data();
        const items = resData.itensCaa || [];
        
        // [5] BUSCA INTELIGENTE DO ITEM (Pelo ID)
        let targetIndex = -1;
        targetIndex = items.findIndex(i => i.id === itemId);
        
        if (targetIndex === -1) {
            const nomeAlvo = document.getElementById('gestao-item-nome').textContent;
            targetIndex = items.findIndex(i => i.nomeCompleto === nomeAlvo);
        }

        if (targetIndex === -1) return alert("Erro: Item n√£o encontrado na lista de pend√™ncias. Algu√©m pode ter modificado antes.");
        
        // [6] ATUALIZA√á√ÉO DOS CAMPOS DO ITEM
        const itemParaAtualizar = items[targetIndex];

        // *** CORRE√á√ÉO CRUCIAL: Atualiza o campo de hist√≥rico linear (item.obs) ***
        let obsAtualizada = itemParaAtualizar.obs || '';
        if (obsAtualizada.trim() !== '') {
            obsAtualizada += ' | + NOVA: ';
        }
        obsAtualizada += novaLinhaObs;
        itemParaAtualizar.obs = obsAtualizada; // SALVA A NOVA LINHA NO HIST√ìRICO LINEAR

        // Atualiza campos espec√≠ficos do Administrador (para uso no Dashboard)
        itemParaAtualizar.statusAdmin = (status === 'Remover' ? 'Solucionado' : status);¬†
        itemParaAtualizar.adminObs = obsFinalDisplay; 
        
        
        // [7] SALVA AS MUDAN√áAS NO FIREBASE
        await ref.update({ itensCaa: items });
        
        
        // [8] ATUALIZA√á√ÉO NA LISTA MESTRE (L√ìGICA DO ESTOQUE, SE NECESS√ÅRIO)
        if(status === 'Remover' || status === 'Solucionado') {
            const listaId = resData.lista_id;
            if(listaId) {
                const listRef = db.collection(COLECAO_LISTAS).doc(listaId);
                const listSnap = await listRef.get();
                
                if(listSnap.exists) {
                    let listaData = listSnap.data().list;
                    let updated = false;

                    for(let s of listaData) {
                        for(let i = s.itens.length - 1; i >= 0; i--) {
                            const item = s.itens[i];
                            if(item.tipo === 'single' && item.id === itemId) {
                                if(status === 'Remover') {
                                    item.quantidadeEsperada -= qtdRemover;
                                    delete item.pendencia;¬†
                                    if(item.quantidadeEsperada <= 0) s.itens.splice(i, 1);
                                } else {
                                    // Adiciona a a√ß√£o do gestor no hist√≥rico da lista mestra tamb√©m!
                                    // Isso √© CRUCIAL para que a pr√≥xima confer√™ncia carregue o hist√≥rico!
                                    if(item.pendencia && item.pendencia.obs) {
                                         item.pendencia.obs = obsAtualizada;
                                    }
                                    delete item.pendencia; // Pend√™ncia resolvida, campo limpo na lista mestra
                                }
                                updated = true;
                            }
                            else if(item.tipo === 'multi' && item.tombamentos) {
                                const tIndex = item.tombamentos.findIndex(t => `${item.id}-${t.tomb}` === itemId);
                                if(tIndex > -1) {
                                    if(status === 'Remover') {
                                        item.tombamentos.splice(tIndex, 1);
                                        item.quantidadeEsperada = item.tombamentos.length;
                                        if(item.tombamentos.length === 0) s.itens.splice(i, 1);
                                    } else {
                                        // Adiciona a a√ß√£o do gestor no hist√≥rico da lista mestra tamb√©m!
                                        if(item.tombamentos[tIndex].pendencia && item.tombamentos[tIndex].pendencia.obs) {
                                            item.tombamentos[tIndex].pendencia.obs = obsAtualizada;
                                        }
                                        delete item.tombamentos[tIndex].pendencia;
                                    }
                                    updated = true;
                                }
                            }
                        }
                    }
                    if(updated) await listRef.update({ list: listaData });
                }
            }
        }

        // [9] FINALIZA√á√ÉO
        alert("Salvo com sucesso!");
        fecharModalGestao();
        fecharTabela();
        loadCaaData();¬†
    } catch(e) {¬†
        console.error(e);¬†
        alert("Erro ao salvar: " + e.message);
    }
}
        // --- FUN√á√ïES DE EDITOR (MOVIDAS PARA O ESCOPO GLOBAL) ---
        function abrirEditor(id, nome, unidadeLista) { 
    
    // --- NOVA VERIFICA√á√ÉO DE PERMISS√ÉO DE UNIDADE ---
    // Verifica se o usu√°rio √© um Gestor E se a Unidade da Lista 
    // √© diferente da Unidade do usu√°rio logado.
    if (currentUserData.role === 'gestor' && unidadeLista !== currentUserData.unidade) {
        alert("Acesso negado. Voc√™ s√≥ pode editar listas da sua unidade.");
        return; // Impede que o editor seja aberto
    }
    // --------------------------------------------------

    currentEditingId = id;
    const editorTitleEl = document.getElementById('editor-title');
    if(editorTitleEl) {
        editorTitleEl.textContent = `Editando: ${nome}`; 
    }
    
    switchView('editor'); 
    carregarDadosGerenciador(); 
}
        function voltarParaLocais() { 
            currentEditingId = null;
            switchView('listas'); 
        }
        
        async function carregarDadosGerenciador(){ 
            if(!currentEditingId) return;
            try{ 
                document.getElementById('loading-message-admin').style.display = 'block';
                document.getElementById('main-admin-content').style.display = 'none';
                const d=await db.collection(COLECAO_LISTAS).doc(currentEditingId).get(); 
                dadosConferencia=d.exists?(d.data().list||[]):[]; 
                renderizarLista(); 
                document.getElementById('loading-message-admin').style.display = 'none';
                document.getElementById('main-admin-content').style.display = 'block';
            }catch(e){
                console.error(e);
                alert("Erro ao carregar lista.");
            } 
        }
        async function salvarDados(a=true){ 
            if(!currentEditingId) return;
            try{ 
                await db.collection(COLECAO_LISTAS).doc(currentEditingId).update({ list:dadosConferencia, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }); 
                if(a)alert("Salvo!"); 
            }catch(e){
                alert("Erro ao salvar");
            } 
        }
        function gerarNovoId(){ 
            return Date.now().toString().slice(-6)+Math.floor(Math.random()*100).toString().padStart(2,'0');
        }
        function adicionarSetor(n){ 
            n=n.trim().toUpperCase(); 
            if(!n)return; 
            dadosConferencia.push({id:gerarNovoId(), nome:n, itens:[]}); 
            document.getElementById('input-setor-nome').value=''; 
            salvarDados(false); 
            renderizarLista();
        }
        function removerSetor(id){ 
            if(confirm("Remover setor?")) { 
                dadosConferencia=dadosConferencia.filter(x=>x.id!==id); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        
        // ATEN√á√ÉO: Esta √© a fun√ß√£o que voc√™ deve modificar no sigma_dashboard.html
        function adicionarItemPorSetor(sid) { 
            const n = document.getElementById('input-item-nome-'+sid).value.trim().toUpperCase();
            const q = parseInt(document.getElementById('input-item-qtd-'+sid).value); 
            const t = document.getElementById('select-item-tipo-'+sid).value; 
            
            if(!n || q < 1) return;
            
            // 1. CAPTURAR O SCROLL POSITION ANTES DA RECONSTRU√á√ÉO DO DOM
            // O elemento que rola √© o pai da lista de setores, ou o cont√™iner principal do editor.
            const scrollContainer = document.querySelector('.admin-container'); 
            let scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            const s = dadosConferencia.find(x => x.id === sid);
            const novo = {id: sid+'-'+gerarNovoId(), nome: n, quantidadeEsperada: q, tipo: t, tombamentos:[]};
            
            if(t === 'multi') for(let i = 0; i < q; i++) novo.tombamentos.push({tomb: 'NOVO-' + (i+1), status: 'pending', obs: ''}); 
            
            s.itens.push(novo);
            
            // OTIMIZA√á√ÉO: Limpar o campo de nome
            document.getElementById('input-item-nome-'+sid).value = '';

            salvarDados(false);
            
            // 2. RECONSTRUIR A LISTA
            renderizarLista(); 

            // 3. RESTAURAR O SCROLL POSITION AP√ìS A RECONSTRU√á√ÉO
            if (scrollContainer && scrollTop > 0) {
                // Usamos um pequeno timeout para garantir que o DOM foi totalmente renderizado
                setTimeout(() => {
                    scrollContainer.scrollTop = scrollTop;
                }, 50);
            }
        }
        function removerItem(sid,iid){ 
            if(confirm("Remover item?")){ 
                const s=dadosConferencia.find(x=>x.id===sid); 
                s.itens=s.itens.filter(i=>i.id!==iid); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function encontrarItemPorId(id) { 
            for (const setor of dadosConferencia) { 
                const item = setor.itens.find(i => i.id === id);
                if (item) return item; 
            } 
            return null; 
        }
        function adicionarTombamento(itemId, inputElement) { 
            const tombamento = inputElement.value.trim().toUpperCase();
            if (!tombamento) return; 
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                if (item.tombamentos.some(t => t.tomb === tombamento)) return alert("Duplicado!");
                item.tombamentos.push({ tomb: tombamento, status: "pending", obs: "" }); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function removerTombamento(itemId, tombamento) { 
            if (!confirm("Remover tombamento?")) return;
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                item.tombamentos = item.tombamentos.filter(t => t.tomb !== tombamento); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function editarTombamento(itemId, tombamentoAtual, inputElement) { 
            const novoTombamento = inputElement.value.trim().toUpperCase();
            if (!novoTombamento || novoTombamento === tombamentoAtual) return; 
            const item = encontrarItemPorId(itemId);
            if (item) { 
                const tomb = item.tombamentos.find(t => t.tomb === tombamentoAtual); 
                if (tomb) { 
                    tomb.tomb = novoTombamento; 
                    salvarDados(false);
                } 
            } 
        }
        function updateOrdens() { 
            const novosDados = [];
            document.querySelectorAll('.setor-item').forEach(sNode => { 
                const sId = sNode.getAttribute('data-id'); 
                const sOriginal = dadosConferencia.find(x => x.id === sId); 
                const novosItens = []; 
                sNode.querySelectorAll('.item-conferencia-admin').forEach(iNode => { 
                    const iId = iNode.querySelector('.btn-edit-alt').getAttribute('onclick').split("'")[3]; 
                    const itemObj = encontrarItemPorId(iId); 
                    if(itemObj) novosItens.push(itemObj); 
                }); 
                sOriginal.itens = novosItens; 
                novosDados.push(sOriginal); 
            });
            dadosConferencia = novosDados; 
        }
        function abrirModalEdicao(sid, iid){ 
            const s=dadosConferencia.find(x=>x.id===sid); 
            const i=s.itens.find(x=>x.id===iid); 
            document.getElementById('edit-setor-id').value=sid; 
            document.getElementById('edit-item-original-id').value=iid;
            document.getElementById('edit-item-nome').value=i.nome; 
            document.getElementById('edit-item-qtd').value=i.quantidadeEsperada; 
            document.getElementById('edit-item-qtd').disabled=(i.tipo==='multi'); 
            document.getElementById('edit-item-tipo').value=i.tipo; 
            const sl=document.getElementById('edit-item-setor'); 
            sl.innerHTML=''; 
            dadosConferencia.forEach(d=>{
                const o=document.createElement('option'); 
                o.value=d.id; 
                o.text=d.nome; 
                if(d.id===sid)o.selected=true; 
                sl.appendChild(o);
            }); 
            document.getElementById('modal-edicao').style.display='flex';
        }
        function salvarEdicaoItem(){ 
            const osid=document.getElementById('edit-setor-id').value; 
            const iid=document.getElementById('edit-item-original-id').value; 
            const n=document.getElementById('edit-item-nome').value.trim().toUpperCase(); 
            const nsid=document.getElementById('edit-item-setor').value; 
            const q=parseInt(document.getElementById('edit-item-qtd').value);
            
            const os=dadosConferencia.find(x=>x.id===osid); 
            const ns=dadosConferencia.find(x=>x.id===nsid); 
            const i=os.itens.find(x=>x.id===iid); 
            i.nome=n; 
            if(i.tipo==='single')i.quantidadeEsperada=q; 
            
            if(osid!==nsid){ 
                os.itens=os.itens.filter(x=>x.id!==iid); 
                i.id=nsid+'-'+gerarNovoId(); 
                ns.itens.push(i); 
            } 
            salvarDados(false); 
            renderizarLista(); 
            fecharModal();
        }
        function fecharModal(){
            document.getElementById('modal-edicao').style.display='none';
        }
        function fazerBackupLocal(){ 
            const b=new Blob([JSON.stringify(dadosConferencia,null,2)],{type:"application/json"});
            const u=URL.createObjectURL(b); 
            const a=document.createElement('a'); 
            a.href=u; 
            a.download='backup.json'; 
            a.click(); 
        }
        function importarBackupLocal(e){ 
            const f=e.target.files[0]; 
            if(!f)return;
            const r=new FileReader(); 
            r.onload=function(ev){
                if(confirm("Substituir?")){
                    try{
                        dadosConferencia=JSON.parse(ev.target.result);
                        salvarDados();
                        renderizarLista();
                    }catch(err){
                        alert("Erro JSON");
                    }
                }
            }; 
            r.readAsText(f); 
        }
        
        // Admin Helpers
        async function carregarUnidadesSelect(selectId = 'new-user-unit') {
            
            // 1. Define todos os elementos SELECT conhecidos para Unidades
            const selCadastro = document.getElementById('new-user-unit'); // Cadastro de novo usu√°rio
            const selEdicao = document.getElementById('edit-user-unit'); // Edi√ß√£o de usu√°rio (novo modal)
            const selLista = document.getElementById('novo-local-unidade'); // Cria√ß√£o de lista
        
            try {
                const doc = await db.collection('config_geral').doc('unidades').get();
                const unidades = doc.exists ? doc.data().lista : [];
                let html = '<option value="">Selecione...</option>';
                unidades.forEach(u => html += `<option value="${u}">${u}</option>`);
                
                // 2. Preenche TODOS os selects de unidade existentes
                if(selCadastro) selCadastro.innerHTML = html;
                if(selEdicao) selEdicao.innerHTML = html;
                if(selLista) selLista.innerHTML = html;
            
            } catch(e) {
                console.error("Erro ao carregar unidades:", e);
            }
        }
        
        async function criarUsuario() {
            const email = document.getElementById('new-user-email').value;
            const guerra = document.getElementById('new-user-guerra').value;
            const posto = document.getElementById('new-user-posto').value;
            const completo = document.getElementById('new-user-completo').value;
            const role = document.getElementById('new-user-role').value;
            const unit = document.getElementById('new-user-unit').value;
            
            if(!email || !guerra || !unit) return alert("Preencha os campos.");
            
            try {
                await db.collection('usuarios').add({ email, nome_guerra: guerra, posto, nome_militar_completo: completo, role, unidade: unit });
                alert("Usu√°rio registrado! (Crie o login no Auth)"); 
                listarUsuarios();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function listarUsuarios() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
    
    // --- NOVO: FILTRO DE UNIDADE PARA O GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    
    let userQuery = db.collection('usuarios'); // Cole√ß√£o correta
    
    if (isGestor) {
        // Se for Gestor, filtre a query para buscar usu√°rios APENAS na sua unidade
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }
    // ---------------------------------------------

    try {
        // Executa a query (filtrada ou total)
        const snap = await userQuery.get();
        tbody.innerHTML = '';
        
        if (snap.empty) {
            tbody.innerHTML = '<tr><td colspan="5">Nenhum militar encontrado nesta unidade.</td></tr>';
            return;
        }

        snap.forEach(doc => {
            const u = doc.data();
            const docId = doc.id; 
            const tr = document.createElement('tr');
            
            // O usu√°rio Administrador n√£o deve poder editar a si mesmo
            const isCurrentUser = firebase.auth().currentUser.uid === docId;
            
            // Renderiza√ß√£o da linha
            tr.innerHTML = `<td>${u.posto} ${u.nome_guerra}</td><td>${u.email || 'N/D'}</td><td><span class="role-badge role-${u.role}">${u.role}</span></td><td>${u.unidade}</td><td><button class="btn-modern-action btn-edit" style="padding:4px 8px; font-size:0.8em;" onclick="abrirGestaoUsuario('${docId}')" ${isCurrentUser ? 'disabled' : ''}>Editar</button></td>`;
            tbody.appendChild(tr);
        });
    } catch(e) {
        console.error("Erro ao listar usu√°rios:", e);
        tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar lista de usu√°rios.</td></tr>';
    }
}
        
        async function abrirGestaoUsuario(docId) {
            try {
                const doc = await db.collection('usuarios').doc(docId).get();
                if (!doc.exists) return alert("Usu√°rio n√£o encontrado.");
                
                const u = doc.data();
                const permissoes = u.permissoes || {}; // Inicializa o objeto de permiss√µes
                
                // Preenche o campo de unidades
                await carregarUnidadesSelect('edit-user-unit');

                document.getElementById('edit-user-doc-id').value = docId;
                document.getElementById('edit-user-guerra').value = u.nome_guerra || '';
                document.getElementById('edit-user-posto').value = u.posto || '';
                document.getElementById('edit-user-completo').value = u.nome_militar_completo || '';
                document.getElementById('edit-user-email').value = u.email || 'N/D';
                document.getElementById('edit-user-role').value = u.role || 'operacional';
                document.getElementById('edit-user-unit').value = u.unidade || '';

                // --- NOVA L√ìGICA DE PERMISS√ïES ---
                const roleSelect = document.getElementById('edit-user-role');
                const permFields = document.getElementById('user-permissions-fields');
                
                // Mostra o bloco de permiss√µes apenas se a role for 'gestor' ou 'admin'
                permFields.style.display = (u.role === 'gestor' || u.role === 'admin') ? 'block' : 'none';

                // Preenche os checkboxes com base nos dados do Firestore (se existir)
                document.getElementById('perm-view-cards').checked = permissoes.canViewDashboardCards || false;
                document.getElementById('perm-view-history').checked = permissoes.canViewUnitHistory || false;
                document.getElementById('perm-manage-posts').checked = permissoes.canManagePosts || false;
                document.getElementById('perm-manage-users').checked = permissoes.canManageUnitUsers || false;
                document.getElementById('perm-manage-lists').checked = permissoes.canManageUnitLists || false;

                // Listener para mostrar/ocultar as permiss√µes ao mudar a Role
                roleSelect.onchange = function() {
                    permFields.style.display = (this.value === 'gestor' || this.value === 'admin') ? 'block' : 'none';
                };
                // ---------------------------------

                document.getElementById('modal-user-manager').style.display = 'flex';
            } catch(e) {
                console.error(e);
                alert("Erro ao abrir edi√ß√£o: " + e.message);
            }
        }
        
        async function salvarAlteracoesUsuario() {
            const docId = document.getElementById('edit-user-doc-id').value;
            const guerra = document.getElementById('edit-user-guerra').value.trim();
            const posto = document.getElementById('edit-user-posto').value.trim();
            const completo = document.getElementById('edit-user-completo').value.trim();
            const role = document.getElementById('edit-user-role').value;
            const unit = document.getElementById('edit-user-unit').value;
            
            if (!guerra || !posto || !unit) return alert("Nome de Guerra, Posto e Unidade s√£o obrigat√≥rios.");

            // --- NOVA L√ìGICA DE SALVAMENTO DE PERMISS√ïES ---
            const novasPermissoes = {
                canViewDashboardCards: document.getElementById('perm-view-cards').checked,
                canViewUnitHistory: document.getElementById('perm-view-history').checked,
                canManagePosts: document.getElementById('perm-manage-posts').checked,
                canManageUnitUsers: document.getElementById('perm-manage-users').checked,
                canManageUnitLists: document.getElementById('perm-manage-lists').checked,
            };
            
            // O objeto de atualiza√ß√£o
            const updateData = {
                nome_guerra: guerra,
                posto: posto,
                nome_militar_completo: completo,
                role: role,
                unidade: unit,
                permissoes: novasPermissoes // SALVA O NOVO OBJETO
            };
            // ---------------------------------------------
            
            try {
                await db.collection('usuarios').doc(docId).update(updateData);
                
                alert("Dados do militar atualizados com sucesso!");
                document.getElementById('modal-user-manager').style.display = 'none';
                listarUsuarios();
            } catch(e) {
                alert("Erro ao salvar altera√ß√µes: " + e.message);
            }
        }
        async function carregarUsuariosFiltro() {
    const select = document.getElementById('glob-hist-user');
    if (!select) return;

    select.innerHTML = '<option value="">Todos</option>';
    
    // Filtro de seguran√ßa: Gestor s√≥ v√™ usu√°rios da pr√≥pria unidade. Admin v√™ todos.
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;

    let userQuery = db.collection('usuarios');
    
    if (isGestor) {
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }

    try {
        const snap = await userQuery.get();
        let users = [];
        snap.forEach(doc => {
            const u = doc.data();
            // Usamos o nome completo, pois √© o que est√° salvo nos resultados (linha 1082)
            if (u.nome_militar_completo) {
                users.push(u.nome_militar_completo);
            }
        });

        users.sort().forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

    } catch (e) {
        console.error("Erro ao carregar filtro de usu√°rios:", e);
    }
}
        async function excluirUsuario() {
            const docId = document.getElementById('edit-user-doc-id').value;
            const guerra = document.getElementById('edit-user-guerra').value;

            if(!confirm(`Tem certeza que deseja EXCLUIR o militar ${guerra}? O login associado (Auth) DEVE ser removido manualmente.`)) return;
            
            try {
                await db.collection('usuarios').doc(docId).delete();
                alert(`Militar ${guerra} exclu√≠do com sucesso do Firestore!`);
                document.getElementById('modal-user-manager').style.display = 'none';
                listarUsuarios();
            } catch(e) {
                alert("Erro ao excluir: " + e.message);
            }
        }

        async function carregarPostosEditor() {
             const sel = document.getElementById('novo-local-posto');
             if(!sel) return;
             
             try {
                const doc = await db.collection('config_geral').doc('postos').get();
                const lista = doc.exists ? doc.data().lista : [];
                let h = ''; 
                lista.forEach(p => h+=`<option value="${p}">${p}</option>`); 
                sel.innerHTML = h;
             } catch(e){}
        }

        async function criarNovoLocal() {
            const posto = document.getElementById('novo-local-posto').value;
            const nome = document.getElementById('novo-local-nome').value.trim().toUpperCase();
            const unidade = document.getElementById('novo-local-unidade').value;
            if(!posto || !nome || !unidade) return alert("Preencha Posto, Nome e Unidade.");
            
            // Constr√≥i o ID √∫nico e o nome completo
            const id = `${posto.toLowerCase()}_${nome.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            const localCompleto = `${posto} - ${nome}`; // Nome que aparecer√° no Card/Relat√≥rio
            
            try {
                // 1. Salva a lista (Viaturas)
                await db.collection(COLECAO_LISTAS).doc(id).set({ nome_local: nome, posto: posto, list: [], unidade: unidade, updatedAt: firebase.firestore.Timestamp.now() });

                // 2. Salva a rota
                await db.collection('config_geral').doc('rotas').set({ [id]: { nome: nome, posto: posto, unidade: unidade, ativo: true } }, { merge: true });

                // --- NOVO: Cria o registro inicial para o Dashboard ---
                // Este registro garante que o Card de Pend√™ncias apare√ßa imediatamente com status OK.
                await db.collection(COLECAO_RESULTADOS).add({
                    local: localCompleto,
                    lista_id: id,
                    conferente: "Sistema (Inicializa√ß√£o)",
                    unidade: unidade,
                    posto: posto,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    // Dados para garantir que o card seja renderizado com 0 pend√™ncias
                    itensRelatorio: [], 
                    itensCaa: [],
                    totalCaa: 0,
                    totalItensConferidos: 0,
                    statusAdmin: 'OK'
                });
                // ----------------------------------------------------

                alert("Lista Criada e Card Inicializado!"); 
                carregarListaLocaisAdmin();
                // Chama loadCaaData() para atualizar o Dashboard com o novo Card
                loadCaaData(); 
                
            } catch(e) { 
                alert("Erro ao criar lista: " + e.message); 
            }
        }
        
        async function excluirLocalAdmin(listaId, listaNome) {
    if (!confirm(`TEM CERTEZA? Excluir a lista: ${listaNome} (ID: ${listaId})?`)) {
        return;
    }

    try {
        // --- 1. REMOVER REGISTROS DE PEND√äNCIA (CARDS) ---
        const resultadosSnap = await db.collection(COLECAO_RESULTADOS)
            .where('lista_id', '==', listaId)
            .get();

        const batch = db.batch();
        resultadosSnap.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
        // ----------------------------------------------------

        // 2. Remova o item da cole√ß√£o principal de listas (o conte√∫do em si)
        await db.collection(COLECAO_LISTAS).doc(listaId).delete();

        // 3. Remova a refer√™ncia da rota na configura√ß√£o geral, inativando-a
        const rotasRef = db.collection('config_geral').doc('rotas');
        const rotasSnap = await rotasRef.get();
        const rotasData = rotasSnap.data();

        if (rotasData && rotasData[listaId]) {
            // Marca como inativo em vez de deletar para manter o hist√≥rico de dados antigos
            rotasData[listaId].ativo = false;
            await rotasRef.set(rotasData); 
        }

        alert(`Lista "${listaNome}" exclu√≠da/inativada e Cards de Pend√™ncia removidos com sucesso!`);
        
        carregarListaLocaisAdmin();
        loadCaaData(); // Atualiza o Dashboard
    } catch (e) {
        console.error("Erro ao excluir lista:", e);
        alert("Erro ao excluir lista: " + e.message);
    }
}
        
        async function carregarListaLocaisAdmin() {
    const ul = document.getElementById('lista-locais-container');
    const doc = await db.collection('config_geral').doc('rotas').get();
    const rotas = doc.data();
    ul.innerHTML = '';
    
    // --- FILTRO DE SEGURAN√áA PARA GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // ----------------------------------------
    
    // Objeto para mapear o ID da lista para o nome do local
    const listaNomes = {};

    // Mapeia as rotas e carrega os nomes
    Object.entries(rotas).forEach(([id, info]) => {
        if(info.ativo === false) return;

        // CONDI√á√ÉO DE FILTRAGEM: Se for gestor, s√≥ mostra se a unidade da rota for igual √† unidade do gestor.
        if (isGestor && info.unidade !== unidadeGestor) {
            return;
        }
        
        listaNomes[id] = info.nome;
        
        const li = document.createElement('li');
        li.className = 'local-item';
        
        const safeName = info.nome.replace(/'/g, "\\'");
        const safeId = id.replace(/'/g, "\\'");
        // NOVO: Passando o nome da unidade para uso no abrirEditor
        const safeUnit = info.unidade.replace(/'/g, "\\'") || 'Geral'; 
        
        // --- CHAMADA CORRIGIDA: INCLUINDO A UNIDADE NO ABRIR EDITOR ---
        li.innerHTML = `
            <div class="local-info">
                <strong>${info.nome}</strong>
                <span>${info.posto} | Unidade: ${info.unidade||'Geral'}</span>
            </div>
            <div style="display:flex; gap: 10px;">
                <button class="btn-modern-action btn-edit" onclick="abrirEditor('${safeId}', '${safeName}', '${safeUnit}')">
                    Editar
                </button>
                <button class="btn-modern-action btn-delete" onclick="excluirLocalAdmin('${safeId}', '${safeName}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        ul.appendChild(li);
    });
}
        
        function renderizarLista() { 
            const container = document.getElementById('lista-setores-container');
            container.innerHTML = '';
            dadosConferencia.forEach(setor => {
            const setorLi = document.createElement('li'); 
            setorLi.className = 'setor-item'; 
            setorLi.setAttribute('data-id', setor.id);
            const addItemFormHtml = `<div class="add-item-form-setor">
            <input type="text" id="input-item-nome-${setor.id}" placeholder="Item" class="filter-input" style="flex-grow:1;">
            <input type="number" id="input-item-qtd-${setor.id}" value="1" class="filter-input" style="width:50px; flex-grow:0;">
            <select id="select-item-tipo-${setor.id}" class="filter-input" style="flex-grow:1;">
            <option value="single">√önico</option>
            <option value="multi">Tombamento</option>
            </select>
            <button class="btn-add" onclick="adicionarItemPorSetor('${setor.id}')">+</button>
            </div>`;
                let itensHtml = '';
                setor.itens.forEach(item => {
                    let tombamentosHtml = '';
                    if (item.tipo === 'multi' && item.tombamentos) {
                        const tombamentosList = item.tombamentos.map(tomb => `<li><div style="display:flex; align-items:center; width:100%;"><span style="margin-right:10px; font-size:0.85em; font-weight:bold; color:#555;">TB:</span><input type="text" value="${tomb.tomb}" onblur="editarTombamento('${item.id}', '${tomb.tomb}', this)" style="padding:4px; font-size:0.85em; border:1px solid #ddd; border-radius:4px;"></div><button class="btn-remover" onclick="removerTombamento('${item.id}', '${tomb.tomb}')" style="padding:2px 8px; margin-left:10px;"><i class="fas fa-trash" style="font-size:0.8em;"></i></button></li>`).join('');
                        tombamentosHtml = `<div class="tombamento-container-wrapper"><div class="tombamento-section"><h4>Tombamentos (${item.tombamentos.length})</h4><ul class="tombamento-list">${tombamentosList}</ul><div class="add-tombamento-form"><input type="text" id="tomb-input-${item.id}" placeholder="Novo Tombamento"><button class="btn-add" onclick="adicionarTombamento('${item.id}', document.getElementById('tomb-input-${item.id}'))"><i class="fas fa-plus"></i></button></div></div></div>`;
                    }
                    itensHtml += `<li class="item-conferencia-admin"><div style="width:100%"><div style="display:flex;justify-content:space-between;"><div><strong>${item.nome}</strong><small> Qtd: ${item.quantidadeEsperada}</small></div><div class="item-actions-admin"><button class="btn-edit-alt" onclick="abrirModalEdicao('${setor.id}','${item.id}')"><i class="fas fa-edit"></i></button><button class="btn-remover" onclick="removerItem('${setor.id}','${item.id}')"><i class="fas fa-trash"></i></button></div></div>${item.tipo === 'multi' ? tombamentosHtml : ''}</div></li>`;
                });
                
                // ... (c√≥digo dentro do loop forEach) ...
                setorLi.innerHTML = `
    <div class="setor-content-header-sticky" onclick="this.nextElementSibling.classList.toggle('collapsed')">
        <div class="setor-header-admin">
            <span>${setor.nome}</span>
            <button class="btn-remover" onclick="event.stopPropagation();removerSetor('${setor.id}')">X</button>
        </div>
        ${addItemFormHtml}
    </div>
    <div class="setor-content-admin">
        <ul class="lista-setores item-list-admin" data-setor-id="${setor.id}">${itensHtml}</ul>
    </div>
`;
                container.appendChild(setorLi);
            });
            // Inicializa√ß√£o do Sortable para SETORES (na vari√°vel 'container')
            new Sortable(container, { 
                animation: 150, 
                handle: '.setor-header-admin', 
                onEnd: () => { 
                    updateOrdens(); // <-- NOVO: Atualiza a ordem dos setores e itens no array global
                    salvarDados(false); 
                } 
            });
            document.querySelectorAll('.item-list-admin').forEach(el => { 
                new Sortable(el, { 
                    group: 'items', 
                    animation: 150, 
                    // === OP√á√ïES DE AUTOSCROLL AQUI ===
        
                    scroll: true,             // 1. Ativa a rolagem autom√°tica
                    scrollSensitivity: 80,    // 2. Dist√¢ncia (em pixels) da borda para acionar o scroll
                    scrollSpeed: 20,          // 3. Velocidade da rolagem (quanto maior, mais r√°pido)
                    bubbleScroll: true,
                    // Define o elemento que deve rolar. 
                    // No seu caso, o elemento pai de `el` √© o .setor-content-admin
                
                    onEnd: () => { 
                        updateOrdens(); 
                        salvarDados(false); 
                    } 
                }); 
            });
        }
        window.addEventListener('popstate', function (event) {
            // 1. Reinsere o estado no hist√≥rico para neutralizar a navega√ß√£o de "Voltar"
            history.pushState(null, null, location.href);

            // 2. Verifica se o usu√°rio realmente quer sair
            if (confirm('Aten√ß√£o! Voc√™ est√° prestes a sair do sistema. Deseja realmente sair?')) {
                // Limpa o listener popstate para que a sa√≠da seja limpa
                window.removeEventListener('popstate', arguments.callee);
                
                // Redireciona para o logout
                logout(); 
            }
        });
    </script>
</body>
</html>
