<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Painel Administrativo</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; display: flex; min-height: 100vh; padding-top: 50px; padding-bottom: 60px; box-sizing: border-box; overflow-x: hidden; }
        .main-header { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background-color: #800020; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 100; display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; gap: 10px; }
        .header-icon { height: 40px; width: auto; } .header-title-desktop, .header-title-mobile { font-weight: bold; font-size: 1.1em; line-height: 1.2; } .text-white { color: white; } .text-red { color: #FF3B3B; } .header-title-desktop { display: none; } .header-title-mobile { display: block; } 
        #menu-btn { display: none; background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0 5px; }
        
        /* Bot√£o Nova Confer√™ncia no Header */
        .btn-header-action { margin-left: auto; background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85em; transition: all 0.2s; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .btn-header-action:hover { background-color: white; color: #800020; }

        @media (min-width: 768px) { .header-title-desktop { display: block; font-size: 1.2em; } .header-title-mobile { display: none; } #menu-btn { display: none; } }
        .footer-central { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 5px 0 5px; background-color: #f4f4f9; color: #555; font-size: 0.65em; line-height: 1.3; z-index: 100; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); } .footer-central strong, .footer-autor { display: block; width: 100%; text-align: center; } .footer-central strong { font-weight: bold; } .footer-autor { margin-top: 10px; color: #888; font-size: 0.9em; }
        
        /* --- SIDEBAR (Mobile Retr√°til) --- */
        .sidebar { width: 250px; background-color: #ffffff; color: #333; padding-top: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); border-right: 1px solid #e0e0e0; position: fixed; top: 50px; left: 0; height: calc(100% - 50px); display: flex; flex-direction: column; z-index: 110; overflow-y: auto; transition: left 0.3s ease; } 
        .sidebar-header { text-align: center; padding: 10px 0 20px 0; border-bottom: 1px solid #eee; margin-bottom: 10px; } .sidebar-header img { width: 50px; height: auto; margin-bottom: 5px; } .sidebar-header h2 { font-size: 1.1em; margin: 0; color: #800020; } 
        .sidebar a { padding: 15px 20px; text-decoration: none; font-size: 1em; color: #555; display: block; transition: all 0.3s ease; border-left: 4px solid transparent; cursor: pointer; } .sidebar a:hover { background-color: #fff5f5; color: #800020; } .sidebar a.active { background-color: #ffecec; color: #800020; font-weight: bold; border-left: 4px solid #d90f23; } .menu-label { padding: 15px 20px 5px; font-size: 0.85em; color: #999; text-transform: uppercase; font-weight: bold; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 105; }

        /* --- CONTENT --- */
        .content { margin-left: 250px; flex-grow: 1; padding: 20px; box-sizing: border-box; width: calc(100% - 250px); padding-bottom: 80px; } .view-section { display: none; } .view-section.active-view { display: block; }

        /* --- CARDS DASHBOARD --- */
        .cards-grid { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; } 
        .sector-card { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 100%; max-width: 280px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; justify-content: space-between; }
        .sector-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); background-color: #fff5f5; }
        .sector-card.status-alert { border-left: 5px solid #d90f23; } .sector-card.status-ok { border-left: 5px solid #1b8a3e; }
        .sector-card.active-card { background-color: #ffecec; border: 1px solid #d90f23; border-left: 5px solid #d90f23; }
        .sector-card h3 { margin-top: 0; font-size: 1.1em; color: #333; margin-bottom: 5px; font-weight: bold; }
        .sector-card .main-stat { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; }
        .sector-card .count-value { font-size: 2em; font-weight: bold; }
        .sector-card.status-alert .count-value { color: #d90f23; } .sector-card.status-ok .count-value { color: #1b8a3e; }
        .sector-card .label-stat { font-size: 0.85em; color: #666; font-weight: bold; text-transform: uppercase; }
        .sector-card .card-footer { font-size: 0.75em; color: #777; margin-top: 10px; pt: 10px; border-top: 1px solid #eee; line-height: 1.4; }

        /* --- LISTA LOCAIS --- */
        .locais-list { list-style: none; padding: 0; }
        .local-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #800020; }
        .local-info strong { display: block; font-size: 1.1em; color: #333; }
        .local-info span { color: #666; font-size: 0.9em; }
        .local-actions { display: flex; gap: 10px; flex-wrap: wrap;}

        /* --- FORMUL√ÅRIOS ESTILIZADOS --- */
        .new-local-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 3px solid #1b8a3e; }
        .form-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 250px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: bold; color: #555; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; height: 42px; }
        .form-group input:focus, .form-group select:focus { border-color: #800020; outline: none; }
        .btn-create-row { height: 42px; padding: 0 25px; font-size: 1em; margin-bottom: 1px; }

        /* --- VIEW SETORES --- */
        .setores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .setor-manager-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; border-top: 4px solid #2c7399; }
        .setor-manager-header { background: #f8f9fa; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .setor-manager-header h3 { margin: 0; font-size: 1.1em; color: #2c7399; }
        .setor-listas-ul { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        .setor-lista-li { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .setor-lista-li:last-child { border-bottom: none; }
        .setor-lista-li:hover { background-color: #f0f8ff; }
        .badge-count { background: #eee; color: #555; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }

        /* --- BOT√ïES MODERNOS --- */
        .btn-modern-action { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: bold; cursor: pointer; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: all 0.3s ease; text-transform: uppercase; }
        .btn-modern-action:hover { transform: translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
        .btn-sync { background: linear-gradient(135deg, #1b8a3e 0%, #145a2d 100%); } 
        .btn-backup { background: linear-gradient(135deg, #5d6164 0%, #343a40 100%); }
        .btn-import { background: linear-gradient(135deg, #2c7399 0%, #02548b 100%); }
        .btn-create { background: linear-gradient(135deg, #800020 0%, #5a0017 100%); }
        .btn-edit-list { background-color: #0277bd; color: white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size: 0.85em;}
        .btn-print { background-color: #555; color: white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size: 0.85em;}
        .btn-move-list { background-color: #f57c00; color: white; border:none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .btn-remover-setor { background:none; border:none; color:#d90f23; cursor:pointer; }
        .btn-add-simple { background-color: #800020; color: white; border: none; padding: 0 20px; height: 42px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.2em; }

        /* --- TABLE (C/A) --- */
        .ca-table-container { overflow-x: auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-top: 10px; border-top: 3px solid #d90f23; } 
        .ca-table { width: 100%; border-collapse: collapse; font-size: 0.9em; } .ca-table th, .ca-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: top; } .ca-table th { background-color: #f8f8f8; color: #800020; font-weight: bold; text-transform: uppercase; }
        .row-amarelo { background-color: #fff9c4 !important; } .row-laranja { background-color: #ffe0b2 !important; } 
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; } .badge-pendente { background-color: #ffebee; color: #d32f2f; } .badge-solucao { background-color: #fff9c4; color: #fbc02d; border: 1px solid #fbc02d; } .badge-cautela { background-color: #ffe0b2; color: #f57c00; border: 1px solid #f57c00; }
        
        /* --- TEXTO FORMATADO --- */
        .obs-list { list-style: none; padding: 0; margin: 0; }
        .obs-list li { margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px dotted #eee; }
        .obs-list li:last-child { border-bottom: none; }
        .texto-hist { color: #666; font-style: italic; font-size: 0.9em; }
        .texto-atual { color: #d90f23; font-weight: bold; }
        
        /* --- ADMIN EDITOR --- */
        .admin-container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px; margin: 0 auto 20px auto; box-sizing: border-box; text-align: center; } .logo-admin { display: block; margin: 0 auto 15px auto; max-width: 80px; height: auto; } h1.page-title { color: #d90f23; margin-bottom: 15px; font-size: 1.8em; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; text-align: center; } .global-actions { display: flex; gap: 15px; margin-bottom: 25px; justify-content: flex-start; flex-wrap: wrap; padding: 15px; background-color: #fafafa; border-radius: 8px; border: 1px solid #eee; } 
        .btn-add { background-color: #800020; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; } .lista-setores { padding: 0; list-style: none; text-align: left; } .setor-item { margin-bottom: 15px; border: 1px solid #800020; border-radius: 6px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); background: #fff; } .setor-header-admin { background-color: #800020; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; cursor: grab; } .setor-content-admin { transition: max-height 0.4s ease-out; overflow: hidden; max-height: 2000px; padding: 10px; } .setor-content-admin.collapsed { max-height: 0; padding: 0 !important; } .item-conferencia-admin { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #eee; cursor: move; } .add-setor-form, .add-item-form-setor { display: flex; gap: 5px; margin-bottom: 10px; } .add-setor-form input, .add-item-form-setor input, .add-item-form-setor select { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; } .btn-remover { background-color: #d90f23; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;} .btn-edit-alt { background-color: #7f8c8d; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;} .item-actions-admin { display: flex; gap: 5px; } .tombamento-container-wrapper { margin-top: 5px; padding-left: 20px; background: #f9f9f9; border-left: 3px solid #ccc; width: 100%; box-sizing: border-box; } .tombamento-list { list-style: none; padding: 0; margin: 0; } .tombamento-list li { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dotted #eee; } .tombamento-section { padding: 10px; } .tombamento-section h4 { margin: 0 0 10px 0; font-size: 0.9em; color: #555; border-bottom: 1px dotted #ccc; } .add-tombamento-form { display: flex; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0; } .add-tombamento-form input { padding: 6px; font-size: 0.9em; flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; }
        
        /* --- MODAIS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; } .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; position: relative; text-align: left; } .modal-content h2 { margin-top: 0; color: #800020; border-bottom: 1px solid #eee; padding-bottom: 10px; } .modal-content label { display: block; margin-top: 15px; font-weight: bold; color: #555; } .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; } .modal-content textarea { height: 80px; resize: vertical; } .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; } .close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 20px; cursor: pointer; color: #d90f23; }

        /* --- MOBILE RESPONSIVE MENU --- */
        @media (max-width: 768px) { 
            #menu-btn { display: block; }
            .sidebar { left: -260px; width: 260px; border-right: 1px solid #ddd; } 
            .sidebar.mobile-active { left: 0; } 
            .sidebar a { display: block; width: 100%; text-align: left; float: none; border-bottom: 1px solid #eee; } 
            .sidebar-header, .menu-label { display: block; }
            .content { margin-left: 0; width: 100%; padding-top: 15px; }
            .form-row { flex-direction: column; align-items: stretch; }
            .btn-create-row, .btn-add-simple { width: 100%; }
            .btn-header-text { display: none; } /* Esconde texto do bot√£o header no mobile */
        }
        @media (min-width: 769px) { .sidebar-overlay { display: none !important; } }
    </style>
</head>
<body>
    <div id="mobile-overlay" class="sidebar-overlay" onclick="closeMenuMobile()"></div>

    <header class="main-header">
        <button id="menu-btn" onclick="toggleMenuMobile()"><i class="fas fa-bars"></i></button>
        <img src="cbmrr.png" alt="CBM-RR" class="header-icon" onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=CBM'">
        <div class="header-title-desktop"><span class="text-white">CORPO DE BOMBEIROS MILITAR </span><span class="text-red">RORAIMA</span></div>
        <div class="header-title-mobile"><span class="text-white">CBM</span><span class="text-red">RR</span></div>
        
        <a href="index.html" target="_blank" class="btn-header-action" title="Iniciar Nova Confer√™ncia">
            <i class="fas fa-plus-circle"></i> <span class="btn-header-text">Nova Confer√™ncia</span>
        </a>
    </header>
    
    <div class="sidebar" id="main-sidebar">
        <div class="sidebar-header"><img src="cci.png" alt="Logo CCI" onerror="this.onerror=null; this.src='https://placehold.co/50x50/ffffff/800020/fff?text=S'"><h2>SIGMA Admin</h2></div>
        <div class="menu-label">Principal</div>
        <a onclick="switchView('dashboard')" id="link-dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard C/A</a>
        
        <div class="menu-label">Gerenciamento</div>
        <a onclick="switchView('locais')" id="link-locais"><i class="fas fa-list"></i> Listas</a>
        <a onclick="switchView('setores')" id="link-setores"><i class="fas fa-map-marker-alt"></i> Setores</a>
    </div>

    <div class="content">
        <div id="view-dashboard" class="view-section active-view">
            <h1>Dashboard - Confer√™ncias</h1>
            <div id="loading-message-dashboard">Carregando status...</div>
            <div id="cards-container" class="cards-grid"></div>

            <div id="ca-table-wrapper" class="ca-table-container" style="display: none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h2 id="table-title" style="margin:0; color:#800020;">Detalhes das Altera√ß√µes</h2><button onclick="fecharTabela()" class="btn-action btn-edit-alt" style="padding:5px 10px;">Fechar</button></div>
                <table class="ca-table">
                    <thead><tr><th>Material</th><th>Status</th><th>Altera√ß√£o</th><th>Conferente/Data</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="ca-list-body"></tbody>
                </table>
                <div id="no-issues-msg" style="display:none; padding:20px; text-align:center; color:green;">‚úÖ Nenhuma altera√ß√£o pendente nesta confer√™ncia.</div>
            </div>
        </div>
        
        <div id="view-locais" class="view-section">
            <h1>Gerenciar Listas</h1>
            
            <div class="new-local-section">
                <h3><i class="fas fa-plus-circle"></i> Criar Nova Lista de Confer√™ncia</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Selecione o Setor (Posto)</label>
                        <select id="novo-local-posto">
                            <option disabled selected>Carregando setores...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nome da Lista (Ex: VIATURA ABT-18)</label>
                        <input type="text" id="novo-local-nome" placeholder="Digite o nome...">
                    </div>
                    <button class="btn-modern-action btn-create btn-create-row" onclick="criarNovoLocal()">CRIAR LISTA</button>
                </div>
            </div>

            <h3>Listas Cadastradas</h3>
            <p id="loading-locais">Carregando...</p>
            <ul id="lista-locais-container" class="locais-list"></ul>
        </div>

        <div id="view-setores" class="view-section">
            <h1>Gerenciar Setores</h1>
            
            <div class="new-local-section">
                <h3><i class="fas fa-plus"></i> Adicionar Novo Setor</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome do Setor / Posto</label>
                        <input type="text" id="novo-posto-input" placeholder="Nome do Setor (ex: ALFA, ALMOXARIFADO)">
                    </div>
                    <button class="btn-add-simple" onclick="adicionarPosto()">+</button>
                </div>
            </div>

            <div id="setores-grid-container" class="setores-grid"></div>
        </div>

        <div id="view-editor" class="view-section">
            <div class="admin-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button onclick="voltarParaLocais()" class="btn-edit-alt">‚Üê Voltar</button>
                    <span style="font-size:0.9em; color:#888;" id="editor-id-display">ID: ...</span>
                </div>
                <h1 class="page-title" id="editor-title">Editando Lista üè¢</h1>
                <p id="loading-message-admin">Carregando...</p>
                
                <div id="main-admin-content" style="display: none;">
                    <div class="global-actions">
                        <button class="btn-modern-action btn-sync" onclick="salvarDados()">
                            <i class="fas fa-cloud-upload-alt"></i> Salvar e Sincronizar
                        </button>
                        <button class="btn-modern-action btn-backup" onclick="fazerBackupLocal()">
                            <i class="fas fa-download"></i> Backup
                        </button>
                        <input type="file" id="import-json" style="display: none;" onchange="importarBackupLocal(event)">
                        <button class="btn-modern-action btn-import" onclick="document.getElementById('import-json').click()">
                            <i class="fas fa-file-upload"></i> Importar
                        </button>
                    </div>
                    <div class="add-setor-form"><input type="text" id="input-setor-nome" placeholder="Nome Setor"><button class="btn-add" onclick="adicionarSetor(document.getElementById('input-setor-nome').value)">+ Setor</button></div>
                    <ul id="lista-setores-container" class="lista-setores"></ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer-central"><strong>GOVERNO DE RORAIMA</strong><strong>CORPO DE BOMBEIROS MILITAR DE RORAIMA</strong><em>‚ÄúAmaz√¥nia: patrim√¥nio dos brasileiros‚Äù</em><br><span class="footer-autor">Elaborado por: 3¬∫ SGT QPCBM JHONATH</span></div>

    <div id="modal-gestao-ca" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="fecharModalGestao()"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Altera√ß√£o</h2>
            <p style="font-size:0.9em; color:#666;">Item: <strong id="gestao-item-nome">...</strong></p>
            <input type="hidden" id="gestao-doc-id">
            <input type="hidden" id="gestao-item-index">
            <input type="hidden" id="gestao-item-id-lista">
            <input type="hidden" id="gestao-item-max-qtd">
            
            <label for="gestao-status">A√ß√£o / Status:</label>
            <select id="gestao-status" onchange="toggleGestaoQtd()">
                <option value="Solucionado">Solucionado (Finalizar)</option>
                <option value="Em solu√ß√£o">Em solu√ß√£o (Marcar Amarelo)</option>
                <option value="Cautelado">Cautelado (Marcar Laranja)</option>
                <option value="Remover">Remover da Confer√™ncia (Admin)</option>
            </select>
            <div id="div-gestao-qtd" style="display:none;">
                <label for="gestao-qtd" style="color:#d90f23;">Quantidade a Remover:</label>
                <input type="number" id="gestao-qtd" min="1" value="1">
                <small style="color:#888; display:block; margin-top:2px;"></small>
            </div>
            <label for="gestao-obs">Descri√ß√£o do que foi feito:</label>
            <textarea id="gestao-obs" placeholder="Descreva a solu√ß√£o..."></textarea>
            <div class="modal-buttons">
                <button class="btn-modern-action btn-backup" onclick="fecharModalGestao()">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarGestaoCa()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-edicao" class="modal-overlay"><div class="modal-content"><button class="close-btn" onclick="fecharModal()"><i class="fas fa-times"></i></button><h2>Editar Item</h2><input type="hidden" id="edit-setor-id"><input type="hidden" id="edit-item-original-id"><label for="edit-item-nome">Nome:</label><input type="text" id="edit-item-nome"><label for="edit-item-setor">Mover para Setor:</label><select id="edit-item-setor"></select><label for="edit-item-qtd">Quantidade:</label><input type="number" id="edit-item-qtd" min="1"><label for="edit-item-tipo">Tipo:</label><select id="edit-item-tipo" disabled style="background-color: #eee;"><option value="single">Item √önico</option><option value="multi">Item com Tombamento</option></select><div class="modal-buttons"><button class="btn-action btn-remover" onclick="fecharModal()">Cancelar</button><button class="btn-action btn-sync" onclick="salvarEdicaoItem()">Salvar</button></div></div></div>

    <div id="modal-mover-lista" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-mover-lista').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Mover Lista de Setor</h2>
            <p style="font-size:0.9em;">Movendo a lista: <strong id="mover-lista-nome">...</strong></p>
            <input type="hidden" id="mover-lista-id">
            <label>Selecione o Novo Setor:</label>
            <select id="mover-lista-select-setor"></select>
            <div class="modal-buttons">
                <button class="btn-modern-action btn-backup" onclick="document.getElementById('modal-mover-lista').style.display='none'">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="confirmarMoverLista()">Mover</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const COLECAO_RESULTADOS = 'resultados_conferencias';
        const COLECAO_LISTAS = 'listas_conferencia'; 
        const DOC_CONFIG_ROTAS = db.collection('config_geral').doc('rotas');
        const DOC_CONFIG_POSTOS = db.collection('config_geral').doc('postos'); 
        
        let dadosConferencia = [];
        let currentEditingId = null; 

        // --- NAVEGA√á√ÉO ---
        function toggleMenuMobile() { const s=document.getElementById('main-sidebar'); const o=document.getElementById('mobile-overlay'); if(s.classList.contains('mobile-active')){closeMenuMobile();}else{s.classList.add('mobile-active');o.style.display='block';} }
        function closeMenuMobile() { document.getElementById('main-sidebar').classList.remove('mobile-active'); document.getElementById('mobile-overlay').style.display='none'; }
        function switchView(v) { 
            closeMenuMobile(); 
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active-view')); 
            document.querySelectorAll('.sidebar a').forEach(e=>e.classList.remove('active')); 
            
            if(v==='dashboard'){ 
                document.getElementById('view-dashboard').classList.add('active-view'); document.getElementById('link-dashboard').classList.add('active'); loadCaaData(); 
            } else if (v === 'locais') {
                document.getElementById('view-locais').classList.add('active-view'); document.getElementById('link-locais').classList.add('active'); carregarListaLocais(); carregarPostos(); 
            } else if (v === 'setores') {
                document.getElementById('view-setores').classList.add('active-view'); document.getElementById('link-setores').classList.add('active'); carregarVisaoSetores();
            } else if (v === 'editor') {
                document.getElementById('view-editor').classList.add('active-view'); document.getElementById('link-locais').classList.add('active');
            }
        }

        // --- DASHBOARD (CARREGAMENTO ROBUSTO) ---
        async function loadCaaData() {
            const loading = document.getElementById('loading-message-dashboard');
            const cards = document.getElementById('cards-container');
            loading.style.display = 'block'; loading.innerHTML = 'Conectando...'; cards.innerHTML = '';
            try {
                const snap = await db.collection(COLECAO_RESULTADOS).orderBy('timestamp', 'desc').limit(50).get();
                if (snap.empty) { loading.style.display = 'none'; cards.innerHTML = '<p style="padding:20px;">Nenhuma confer√™ncia.</p>'; return; }
                const map = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    const loc = d.local || 'Desconhecido';
                    if (loc === 'ABT-17' || loc === 'ABT-18' || loc === 'PERMAN√äNCIA - BRAVO 5') return; 
                    if (!map[loc]) {
                        let dataFormatada = 'N/D';
                        if (d.timestamp && d.timestamp.toDate) dataFormatada = d.timestamp.toDate().toLocaleString('pt-BR');
                        map[loc] = { docId: doc.id, local: loc, conferente: d.conferente || 'Desconhecido', date: dataFormatada, items: [] };
                        if (Array.isArray(d.itensCaa)) { d.itensCaa.forEach((i, idx) => { if (i.statusAdmin !== 'Solucionado') map[loc].items.push({ ...i, docId: doc.id, originalIndex: idx }); }); }
                    }
                });
                loading.style.display='none'; renderCards(map);
            } catch(e) { 
                console.error(e); loading.style.display = 'block'; loading.innerHTML = `<span style="color:red;">Erro ao carregar dados.</span>`;
            }
        }
        function renderCards(map) {
            const container = document.getElementById('cards-container');
            const sortedKeys = Object.keys(map).sort();
            if(sortedKeys.length === 0) { container.innerHTML = '<p style="padding:20px;">Tudo OK (Filtros aplicados).</p>'; return; }
            sortedKeys.forEach(key => {
                const d = map[key];
                const count = d.items.length;
                const div = document.createElement('div');
                div.className = `sector-card ${count===0?'status-ok':'status-alert'}`;
                div.innerHTML = `<h3>${d.local}</h3><div class="main-stat"><span class="count-value">${count===0?'S/A':count}</span></div><div class="card-footer"><strong>${d.conferente}</strong><br>${d.date}</div>`;
                div.onclick = () => { document.querySelectorAll('.sector-card').forEach(x => x.classList.remove('active-card')); div.classList.add('active-card'); mostrarTabela(d); };
                container.appendChild(div);
            });
        }
        
        // --- FORMATA√á√ÉO DE TEXTO (QUEBRA LINHA POR BULLET) ---
        const formatarTextoDashboard = (textoBruto) => {
            let html = '<ul class="obs-list">';
            let partes = [];
            if (textoBruto.includes(' | + NOVA: ')) { partes = textoBruto.split(' | + NOVA: '); } 
            else if (textoBruto.indexOf('‚Ä¢') !== -1) { partes = textoBruto.split('‚Ä¢').map(s => s.trim()).filter(s => s.length > 0); } 
            else { partes = [textoBruto]; }
            partes.forEach(parte => {
                parte = parte.trim(); if(parte.length === 0) return;
                const regexAssinatura = /^(?:Por:|‚Ä¢\s*Por:)\s*(.*?) em (.*?): "(.*?)"$/i;
                const regexAntigo = /^"(.*)" \(Por: (.*) em (.*)\)$/i;
                const matchAssinatura = parte.match(regexAssinatura);
                const matchAntigo = parte.match(regexAntigo);
                if (matchAssinatura) html += `<li class="texto-hist">Por: ${matchAssinatura[1]} em ${matchAssinatura[2]}: "${matchAssinatura[3]}"</li>`;
                else if (matchAntigo) html += `<li class="texto-hist">Por: ${matchAntigo[2]} em ${matchAntigo[3]}: "${matchAntigo[1]}"</li>`;
                else html += `<li class="texto-atual">${parte.replace(/^‚Ä¢\s*/, '')}</li>`;
            });
            html += '</ul>'; return html;
        };

        function mostrarTabela(data) {
            const wrapper = document.getElementById('ca-table-wrapper'), tbody = document.getElementById('ca-list-body');
            document.getElementById('table-title').textContent = `Detalhes: ${data.local}`;
            tbody.innerHTML = '';
            if (data.items.length === 0) { wrapper.querySelector('table').style.display = 'none'; document.getElementById('no-issues-msg').style.display = 'block'; } else {
                wrapper.querySelector('table').style.display = 'table'; document.getElementById('no-issues-msg').style.display = 'none';
                data.items.forEach(i => {
                    const tr = tbody.insertRow();
                    if(i.statusAdmin==='Em solu√ß√£o') tr.classList.add('row-amarelo');
                    if(i.statusAdmin==='Cautelado') tr.classList.add('row-laranja');
                    const obsFormatada = formatarTextoDashboard(i.obs || '-');
                    let adminHtml = '';
                    if(i.statusAdmin && i.statusAdmin !== 'Pendente' && i.statusAdmin !== 'Solucionado') {
                         const corFundo = i.statusAdmin === 'Em solu√ß√£o' ? '#fff9c4' : '#ffe0b2'; 
                         const corBorda = i.statusAdmin === 'Em solu√ß√£o' ? '#fbc02d' : '#f57c00';
                         adminHtml = `<div style="margin-bottom:5px; padding:6px; background-color:${corFundo}; border-left:4px solid ${corBorda}; border-radius:4px; font-size:0.85em; color:#444;"><strong>‚ö†Ô∏è ${i.statusAdmin} (Admin):</strong> ${i.adminObs || ''}</div>`;
                    }
                    tr.innerHTML = `<td><strong>${i.nomeCompleto}</strong></td><td><span class="status-badge">${i.statusAdmin||'Pendente'}</span></td><td>${adminHtml}${obsFormatada}</td><td><small>${data.conferente}<br>${data.date}</small></td>`;
                    const td = tr.insertCell(); td.innerHTML = `<button class="btn-modern-action btn-edit-list" onclick='abrirModalGestao(${JSON.stringify(i)})' style="font-size:0.8em; padding:5px 10px;"><i class="fas fa-cog"></i> Gerenciar</button>`;
                });
            }
            wrapper.style.display = 'block'; wrapper.scrollIntoView({behavior:'smooth', block:'start'});
        }
        function fecharTabela(){ document.getElementById('ca-table-wrapper').style.display='none'; document.querySelectorAll('.sector-card').forEach(c=>c.classList.remove('active-card')); }

        // --- GEST√ÉO STATUS (COM REFRESH) ---
        function abrirModalGestao(i){ 
            document.getElementById('gestao-item-nome').textContent=i.nomeCompleto; document.getElementById('gestao-doc-id').value=i.docId; document.getElementById('gestao-item-index').value=i.originalIndex; document.getElementById('gestao-item-id-lista').value=i.id; document.getElementById('gestao-status').value=i.statusAdmin||'Solucionado'; document.getElementById('gestao-obs').value=''; document.getElementById('gestao-qtd').value='1'; 
            const maxQtd = (i.quantidade !== undefined) ? i.quantidade : 1; 
            document.getElementById('gestao-item-max-qtd').value = maxQtd;
            document.querySelector('#div-gestao-qtd small').innerHTML = `Estoque Atual: <strong>${maxQtd}</strong><br>Nota: Se a quantidade zerar, o item ser√° exclu√≠do da lista.`;
            document.getElementById('gestao-qtd').max = maxQtd;
            toggleGestaoQtd(); document.getElementById('modal-gestao-ca').style.display='flex'; 
        }
        function fecharModalGestao(){ document.getElementById('modal-gestao-ca').style.display='none'; }
        function toggleGestaoQtd(){ document.getElementById('div-gestao-qtd').style.display=(document.getElementById('gestao-status').value==='Remover'?'block':'none'); }
        
        async function salvarGestaoCa(){
            const docId=document.getElementById('gestao-doc-id').value, idx=parseInt(document.getElementById('gestao-item-index').value), itemId=document.getElementById('gestao-item-id-lista').value, status=document.getElementById('gestao-status').value, obs=document.getElementById('gestao-obs').value.trim(), qtd=parseInt(document.getElementById('gestao-qtd').value);
            const maxQtd = parseInt(document.getElementById('gestao-item-max-qtd').value);

            if(!obs) return alert("Descreva a a√ß√£o.");
            if(status === 'Remover') {
                if(qtd > maxQtd) return alert(`Erro: Quantidade maior que estoque.`);
                if(qtd <= 0) return alert("Qtd deve ser > 0.");
            }
            const btn = document.querySelector('#modal-gestao-ca .btn-sync'); btn.textContent = "Salvando..."; btn.disabled = true;
            try {
                const ref=db.collection(COLECAO_RESULTADOS).doc(docId); const snap=await ref.get(); const resData=snap.data(); const items=resData.itensCaa;
                items[idx].statusAdmin=(status==='Remover'?'Solucionado':status); items[idx].adminObs = obs; 
                await ref.update({itensCaa:items});

                const listaIdAlvo = resData.lista_id;
                if(listaIdAlvo) {
                    const listRef = db.collection(COLECAO_LISTAS).doc(listaIdAlvo); const listSnap = await listRef.get();
                    if(listSnap.exists) {
                        let lista = listSnap.data().list; let updated = false;
                        for (let sIndex = 0; sIndex < lista.length; sIndex++) {
                            const s = lista[sIndex];
                            for (let iIndex = s.itens.length - 1; iIndex >= 0; iIndex--) {
                                const i = s.itens[iIndex];
                                if(i.id === itemId && i.tipo === 'single') {
                                    if(status === 'Remover') { if (qtd === i.quantidadeEsperada) { s.itens.splice(iIndex, 1); } else { i.quantidadeEsperada -= qtd; delete i.pendencia; } } else if(status === 'Solucionado') { delete i.pendencia; } else { if(!i.pendencia) i.pendencia={}; i.pendencia.statusAdmin=status; i.pendencia.adminObs=obs; } updated=true;
                                }
                                if(i.tipo === 'multi' && i.tombamentos) {
                                    const tIdx = i.tombamentos.findIndex(t => `${i.id}-${t.tomb}` === itemId);
                                    if(tIdx > -1) {
                                        if(status === 'Remover') { i.tombamentos.splice(tIdx, 1); i.quantidadeEsperada = i.tombamentos.length; if (i.tombamentos.length === 0) { s.itens.splice(iIndex, 1); } } else if(status === 'Solucionado') { delete i.tombamentos[tIdx].pendencia; } else { if(!i.tombamentos[tIdx].pendencia) i.tombamentos[tIdx].pendencia={}; i.tombamentos[tIdx].pendencia.statusAdmin=status; i.tombamentos[tIdx].pendencia.adminObs=obs; } updated=true;
                                    }
                                }
                            }
                        }
                        if(updated) await listRef.update({list:lista});
                    }
                }
                alert("Atualizado!"); fecharModalGestao(); fecharTabela(); loadCaaData();
            } catch(e){ console.error(e); alert("Erro ao salvar."); } finally { btn.textContent = "Confirmar"; btn.disabled = false; }
        }

        // --- OUTRAS FUN√á√ïES (SETORES, LISTAS, EDITOR) ---
        async function carregarPostos() {
            const select = document.getElementById('novo-local-posto');
            try {
                const doc = await DOC_CONFIG_POSTOS.get();
                let lista = doc.exists ? (doc.data().lista || []) : ['ALFA', 'BRAVO'];
                select.innerHTML = '<option value="" disabled selected>Selecione um Setor</option>';
                lista.sort().forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.textContent = p; select.appendChild(opt); });
            } catch (e) { console.error(e); }
        }
        async function adicionarPosto() {
            const novo = document.getElementById('novo-posto-input').value.trim().toUpperCase();
            if(!novo) return alert("Digite o nome do setor.");
            try { await DOC_CONFIG_POSTOS.set({ lista: firebase.firestore.FieldValue.arrayUnion(novo) }, { merge: true }); alert("Setor adicionado!"); document.getElementById('novo-posto-input').value=''; carregarVisaoSetores(); carregarPostos(); } catch (e) { alert("Erro: " + e.message); }
        }
        async function removerPosto(nomePosto) {
            if(!confirm(`Tem certeza que deseja remover o setor ${nomePosto}?`)) return;
            try { await DOC_CONFIG_POSTOS.update({ lista: firebase.firestore.FieldValue.arrayRemove(nomePosto) }); alert("Setor removido!"); carregarVisaoSetores(); } catch (e) { alert("Erro: " + e.message); }
        }
        async function carregarVisaoSetores() {
            const container = document.getElementById('setores-grid-container'); container.innerHTML = '<p>Carregando...</p>';
            try {
                const docPostos = await DOC_CONFIG_POSTOS.get(); const setores = docPostos.exists ? (docPostos.data().lista || []) : [];
                const docRotas = await DOC_CONFIG_ROTAS.get(); const rotas = docRotas.exists ? docRotas.data() : {};
                container.innerHTML = ''; const listasPorSetor = {}; setores.forEach(s => listasPorSetor[s] = []);
                Object.entries(rotas).forEach(([id, info]) => { if(info.ativo !== false) { if(listasPorSetor[info.posto]) { listasPorSetor[info.posto].push({ id: id, nome: info.nome }); } else { if(!listasPorSetor['SEM SETOR']) listasPorSetor['SEM SETOR'] = []; listasPorSetor['SEM SETOR'].push({ id: id, nome: info.nome }); } } });
                Object.keys(listasPorSetor).sort().forEach(nomeSetor => {
                    const listas = listasPorSetor[nomeSetor]; const card = document.createElement('div'); card.className = 'setor-manager-card';
                    let htmlListas = ''; listas.forEach(l => { htmlListas += `<li class="setor-lista-li"><span>${l.nome}</span><button class="btn-move-list" onclick="abrirModalMover('${l.id}', '${l.nome}')" title="Mover"><i class="fas fa-exchange-alt"></i></button></li>`; });
                    if(listas.length === 0) htmlListas = '<li class="setor-lista-li" style="color:#999;">Nenhuma lista neste setor.</li>';
                    const btnRemove = nomeSetor !== 'SEM SETOR' ? `<button class="btn-remover-setor" onclick="removerPosto('${nomeSetor}')"><i class="fas fa-trash"></i></button>` : '';
                    card.innerHTML = `<div class="setor-manager-header"><div><h3>${nomeSetor}</h3><span class="badge-count">${listas.length} listas</span></div>${btnRemove}</div><ul class="setor-listas-ul">${htmlListas}</ul>`;
                    container.appendChild(card);
                });
            } catch (e) { console.error(e); container.innerHTML = 'Erro ao carregar.'; }
        }
        async function abrirModalMover(id, nome) {
            document.getElementById('mover-lista-id').value = id; document.getElementById('mover-lista-nome').textContent = nome;
            const select = document.getElementById('mover-lista-select-setor'); select.innerHTML = '<option>Carregando...</option>';
            try {
                const doc = await DOC_CONFIG_POSTOS.get(); const lista = doc.exists ? (doc.data().lista || []) : []; select.innerHTML = '';
                lista.sort().forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.textContent = p; select.appendChild(opt); });
                document.getElementById('modal-mover-lista').style.display = 'flex';
            } catch(e) { alert("Erro ao carregar."); }
        }
        async function confirmarMoverLista() {
            const id = document.getElementById('mover-lista-id').value; const novoSetor = document.getElementById('mover-lista-select-setor').value; if(!novoSetor) return alert("Selecione um setor.");
            try {
                const docRotas = await DOC_CONFIG_ROTAS.get(); if(!docRotas.exists) throw new Error("Config rotas n√£o existe.");
                const data = docRotas.data();
                if(data[id]) { data[id].posto = novoSetor; await DOC_CONFIG_ROTAS.set(data); await db.collection(COLECAO_LISTAS).doc(id).update({ posto: novoSetor }).catch(err => console.log("Ok.")); alert("Movido!"); document.getElementById('modal-mover-lista').style.display = 'none'; carregarVisaoSetores(); }
            } catch(e) { alert("Erro: " + e.message); }
        }
        async function carregarListaLocais() {
            const ul = document.getElementById('lista-locais-container'); ul.innerHTML = 'Carregando...';
            try {
                const doc = await DOC_CONFIG_ROTAS.get(); ul.innerHTML = '';
                if (doc.exists) {
                    Object.entries(doc.data()).forEach(([id, info]) => {
                        if(info.ativo === false) return; 
                        if (id === 'ABT-17' || id === 'ABT-18' || id.includes('perman√™ncia - bravo 5')) return; 
                        const li = document.createElement('li'); li.className = 'local-item';
                        li.innerHTML = `<div class="local-info"><strong>${info.posto} - ${info.nome}</strong><span>ID: ${id}</span></div><div class="local-actions"><button class="btn-edit-list" onclick="abrirEditor('${id}', '${info.nome}')"><i class="fas fa-edit"></i> Editar Estoque</button><button class="btn-print" onclick="imprimirUltimaConferencia('${id}', '${info.nome}')"><i class="fas fa-print"></i> √öltima Conf.</button></div>`;
                        ul.appendChild(li);
                    });
                }
            } catch (e) { ul.innerHTML = 'Erro.'; }
        }
        async function imprimirUltimaConferencia(listaId, nomeLocal) {
            try {
                const snapshot = await db.collection(COLECAO_RESULTADOS).where('lista_id', '==', listaId).orderBy('timestamp', 'desc').limit(1).get();
                if (snapshot.empty) return alert("Nenhuma confer√™ncia encontrada.");
                const data = snapshot.docs[0].data();
                const dataHora = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('pt-BR') : 'N/D';
                const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
                doc.setFontSize(12); doc.text('RELAT√ìRIO DE √öLTIMA CONFER√äNCIA', 105, 20, { align: 'center' });
                doc.setFontSize(10); doc.text(`Local: ${nomeLocal}`, 14, 30); doc.text(`Conferente: ${data.conferente}`, 14, 36); doc.text(`Data: ${dataHora}`, 14, 42);
                let tableBody = [];
                if (data.itensCaa && data.itensCaa.length > 0) { data.itensCaa.forEach(item => { let obs = item.obs || '-'; tableBody.push([item.nomeCompleto, item.quantidade, item.status || 'C/A', obs]); }); } else { tableBody.push(['-', '-', 'SEM ALTERA√á√ïES', 'Tudo conforme o padr√£o.']); }
                doc.autoTable({ startY: 50, head: [['Item', 'Qtd', 'Status', 'Observa√ß√£o']], body: tableBody, styles: { fontSize: 8 }, columnStyles: { 0: { cellWidth: 60 }, 3: { cellWidth: 'auto' } } });
                doc.save(`Relatorio_${nomeLocal}.pdf`);
            } catch (e) { console.error(e); alert("Erro ao gerar PDF."); }
        }
        async function criarNovoLocal() {
            const posto = document.getElementById('novo-local-posto').value; const nome = document.getElementById('novo-local-nome').value.trim().toUpperCase(); if(!posto || !nome) return alert("Preencha tudo.");
            const id = `${posto.toLowerCase()}_${nome.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            if(!confirm(`Criar id: ${id}?`)) return;
            try { await db.collection(COLECAO_LISTAS).doc(id).set({ nome_local: nome, posto: posto, list: [], updatedAt: firebase.firestore.Timestamp.now() }); await DOC_CONFIG_ROTAS.set({ [id]: { nome: nome, posto: posto, ativo: true } }, { merge: true }); alert("Sucesso!"); carregarListaLocais(); } catch(e) { alert("Erro: " + e.message); }
        }
        
        // --- EDITOR ---
        function abrirEditor(id, nome) { currentEditingId = id; document.getElementById('editor-title').textContent = `Editando: ${nome}`; document.getElementById('editor-id-display').textContent = `ID: ${id}`; switchView('editor'); carregarDadosGerenciador(); }
        function voltarParaLocais() { currentEditingId = null; switchView('locais'); }
        async function carregarDadosGerenciador(){ if(!currentEditingId) return; try{ const d=await db.collection(COLECAO_LISTAS).doc(currentEditingId).get(); dadosConferencia=d.exists?(d.data().list||[]):[]; renderizarLista(); document.getElementById('main-admin-content').style.display='block'; document.getElementById('loading-message-admin').style.display='none'; }catch(e){console.error(e);} }
        async function salvarDados(a=true){ if(!currentEditingId) return; try{ await db.collection(COLECAO_LISTAS).doc(currentEditingId).update({ list:dadosConferencia, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }); if(a)alert("Salvo!"); }catch(e){alert("Erro ao salvar");} }
        function gerarNovoId(){ return Date.now().toString().slice(-6)+Math.floor(Math.random()*100).toString().padStart(2,'0'); }
        function renderizarLista() { 
            const container = document.getElementById('lista-setores-container'); container.innerHTML = '';
            dadosConferencia.forEach(setor => {
                const setorLi = document.createElement('li'); setorLi.className = 'setor-item'; setorLi.setAttribute('data-id', setor.id);
                const addItemFormHtml = `<div class="add-item-form-setor"><input type="text" id="input-item-nome-${setor.id}" placeholder="Item"><input type="number" id="input-item-qtd-${setor.id}" value="1" style="width:50px"><select id="select-item-tipo-${setor.id}"><option value="single">√önico</option><option value="multi">Tombamento</option></select><button class="btn-add" onclick="adicionarItemPorSetor('${setor.id}')">+</button></div>`;
                let itensHtml = '';
                setor.itens.forEach(item => {
                    let tombamentosHtml = '';
                    if (item.tipo === 'multi' && item.tombamentos) {
                        const tombamentosList = item.tombamentos.map(tomb => `<li><div style="display:flex; align-items:center; width:100%;"><span style="margin-right:10px; font-size:0.85em; font-weight:bold; color:#555;">TB:</span><input type="text" value="${tomb.tomb}" onblur="editarTombamento('${item.id}', '${tomb.tomb}', this)" style="padding:4px; font-size:0.85em; border:1px solid #ddd; border-radius:4px;"></div><button class="btn-action btn-remover" onclick="removerTombamento('${item.id}', '${tomb.tomb}')" style="padding:2px 8px; margin-left:10px;"><i class="fas fa-trash" style="font-size:0.8em;"></i></button></li>`).join('');
                        tombamentosHtml = `<div class="tombamento-container-wrapper"><div class="tombamento-section"><h4>Tombamentos (${item.tombamentos.length})</h4><ul class="tombamento-list">${tombamentosList}</ul><div class="add-tombamento-form"><input type="text" id="tomb-input-${item.id}" placeholder="Novo Tombamento"><button class="btn-add" onclick="adicionarTombamento('${item.id}', document.getElementById('tomb-input-${item.id}'))"><i class="fas fa-plus"></i></button></div></div></div>`;
                    }
                    itensHtml += `<li class="item-conferencia-admin"><div style="width:100%"><div style="display:flex;justify-content:space-between;"><div><strong>${item.nome}</strong><small> Qtd: ${item.quantidadeEsperada}</small></div><div class="item-actions-admin"><button class="btn-action btn-edit-alt" onclick="abrirModalEdicao('${setor.id}','${item.id}')"><i class="fas fa-edit"></i></button><button class="btn-action btn-remover" onclick="removerItem('${setor.id}','${item.id}')"><i class="fas fa-trash"></i></button></div></div>${item.tipo === 'multi' ? tombamentosHtml : ''}</div></li>`;
                });
                setorLi.innerHTML = `<div class="setor-header-admin" onclick="this.nextElementSibling.classList.toggle('collapsed')"><span>${setor.nome}</span><button class="btn-action btn-remover" onclick="event.stopPropagation();removerSetor('${setor.id}')">X</button></div><div class="setor-content-admin">${addItemFormHtml}<ul class="lista-setores item-list-admin" data-setor-id="${setor.id}">${itensHtml}</ul></div>`;
                container.appendChild(setorLi);
            });
            new Sortable(container, { animation: 150, handle: '.setor-header-admin', onEnd: () => salvarDados(false) });
            document.querySelectorAll('.item-list-admin').forEach(el => { new Sortable(el, { group: 'items', animation: 150, onEnd: () => { updateOrdens(); salvarDados(false); } }); });
        }
        function adicionarSetor(n){ n=n.trim().toUpperCase(); if(!n)return; dadosConferencia.push({id:gerarNovoId(), nome:n, itens:[]}); document.getElementById('input-setor-nome').value=''; salvarDados(false); renderizarLista(); }
        function removerSetor(id){ if(confirm("Remover?")) { dadosConferencia=dadosConferencia.filter(x=>x.id!==id); salvarDados(false); renderizarLista(); } }
        function adicionarItemPorSetor(sid){ const n=document.getElementById('input-item-nome-'+sid).value.trim().toUpperCase(); const q=parseInt(document.getElementById('input-item-qtd-'+sid).value); const t=document.getElementById('select-item-tipo-'+sid).value; if(!n||q<1)return; const s=dadosConferencia.find(x=>x.id===sid); const novo={id:sid+'-'+gerarNovoId(), nome:n, quantidadeEsperada:q, tipo:t, tombamentos:[]}; if(t==='multi')for(let i=0;i<q;i++)novo.tombamentos.push({tomb:'NOVO-'+(i+1),status:'pending',obs:''}); s.itens.push(novo); salvarDados(false); renderizarLista(); document.getElementById('input-item-nome-'+sid).value=''; }
        function removerItem(sid,iid){ if(confirm("Remover?")){ const s=dadosConferencia.find(x=>x.id===sid); s.itens=s.itens.filter(i=>i.id!==iid); salvarDados(false); renderizarLista(); } }
        function encontrarItemPorId(id) { for (const setor of dadosConferencia) { const item = setor.itens.find(i => i.id === id); if (item) return item; } return null; }
        function adicionarTombamento(itemId, inputElement) { const tombamento = inputElement.value.trim().toUpperCase(); if (!tombamento) return; const item = encontrarItemPorId(itemId); if (item) { if (item.tombamentos.some(t => t.tomb === tombamento)) return alert("Duplicado!"); item.tombamentos.push({ tomb: tombamento, status: "pending", obs: "" }); item.quantidadeEsperada = item.tombamentos.length; salvarDados(false); renderizarLista(); } }
        function removerTombamento(itemId, tombamento) { if (!confirm("Remover tombamento?")) return; const item = encontrarItemPorId(itemId); if (item) { item.tombamentos = item.tombamentos.filter(t => t.tomb !== tombamento); item.quantidadeEsperada = item.tombamentos.length; salvarDados(false); renderizarLista(); } }
        function editarTombamento(itemId, tombamentoAtual, inputElement) { const novoTombamento = inputElement.value.trim().toUpperCase(); if (!novoTombamento || novoTombamento === tombamentoAtual) return; const item = encontrarItemPorId(itemId); if (item) { const tomb = item.tombamentos.find(t => t.tomb === tombamentoAtual); if (tomb) { tomb.tomb = novoTombamento; salvarDados(false); } } }
        function updateOrdens() { const novosDados = []; document.querySelectorAll('.setor-item').forEach(sNode => { const sId = sNode.getAttribute('data-id'); const sOriginal = dadosConferencia.find(x => x.id === sId); const novosItens = []; sNode.querySelectorAll('.item-conferencia-admin').forEach(iNode => { const iId = iNode.querySelector('.btn-edit-alt').getAttribute('onclick').split("'")[3]; const itemObj = encontrarItemPorId(iId); if(itemObj) novosItens.push(itemObj); }); sOriginal.itens = novosItens; novosDados.push(sOriginal); }); dadosConferencia = novosDados; }
        function abrirModalEdicao(sid, iid){ const s=dadosConferencia.find(x=>x.id===sid); const i=s.itens.find(x=>x.id===iid); document.getElementById('edit-setor-id').value=sid; document.getElementById('edit-item-original-id').value=iid; document.getElementById('edit-item-nome').value=i.nome; document.getElementById('edit-item-qtd').value=i.quantidadeEsperada; document.getElementById('edit-item-qtd').disabled=(i.tipo==='multi'); document.getElementById('edit-item-tipo').value=i.tipo; const sl=document.getElementById('edit-item-setor'); sl.innerHTML=''; dadosConferencia.forEach(d=>{const o=document.createElement('option'); o.value=d.id; o.text=d.nome; if(d.id===sid)o.selected=true; sl.appendChild(o);}); document.getElementById('modal-edicao').style.display='flex'; }
        function salvarEdicaoItem(){ const osid=document.getElementById('edit-setor-id').value; const iid=document.getElementById('edit-item-original-id').value; const n=document.getElementById('edit-item-nome').value.trim().toUpperCase(); const nsid=document.getElementById('edit-item-setor').value; const q=parseInt(document.getElementById('edit-item-qtd').value); const os=dadosConferencia.find(x=>x.id===osid); const ns=dadosConferencia.find(x=>x.id===nsid); const i=os.itens.find(x=>x.id===iid); i.nome=n; if(i.tipo==='single')i.quantidadeEsperada=q; if(osid!==nsid){ os.itens=os.itens.filter(x=>x.id!==iid); i.id=nsid+'-'+gerarNovoId(); ns.itens.push(i); } salvarDados(false); renderizarLista(); fecharModal(); }
        function fecharModal(){document.getElementById('modal-edicao').style.display='none';}
        function fazerBackupLocal(){ const b=new Blob([JSON.stringify(dadosConferencia,null,2)],{type:"application/json"}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='backup.json'; a.click(); }
        function importarBackupLocal(e){ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(ev){if(confirm("Substituir?")){try{dadosConferencia=JSON.parse(ev.target.result);salvarDados();renderizarLista();}catch(err){alert("Erro JSON");}}}; r.readAsText(f); }
        
        document.addEventListener('DOMContentLoaded', () => { loadCaaData(); });
    </script>
</body>
</html>
