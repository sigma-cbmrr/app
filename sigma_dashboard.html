<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - GestÃ£o & Comando</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="sigma-comum.css">
    <style>
Â  Â  Â  Â  /* --- ESTILOS GERAIS --- */
Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f4f4f9;Â 
Â  Â  Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  min-height: 100vh;Â 
Â  Â  Â  Â  Â  Â  padding-top: 50px;Â 
Â  Â  Â  Â  Â  Â  padding-bottom: 60px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  overflow-x: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Header */
Â  Â  Â  Â  .main-header {Â 
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;Â 
Â  Â  Â  Â  Â  Â  left: 0;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  height: 50px;Â 
Â  Â  Â  Â  Â  Â  background-color: #800020;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);Â 
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  padding: 0 15px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-icon {Â 
Â  Â  Â  Â  Â  Â  height: 40px;Â 
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .header-title-desktop, .header-title-mobile {Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.1em;Â 
Â  Â  Â  Â  Â  Â  line-height: 1.2;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .text-white {Â 
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .text-red {Â 
Â  Â  Â  Â  Â  Â  color: #FF3B3B;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .header-title-desktop {Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .header-title-mobile {Â 
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* 1. Sobrescreve a classe de aÃ§Ã£o para garantir que seja APENAS um Ã­cone */
Â  Â  Â  Â  .btn-logout-header {
Â  Â  Â  Â  Â  Â  /* AnulaÃ§Ã£o da Caixa */
Â  Â  Â  Â  Â  Â  background: transparent !important; /* Garante fundo transparente, anulando o .btn-modern-action */
Â  Â  Â  Â  Â  Â  border: none !important;Â  Â  Â  /* Remove bordas */
Â  Â  Â  Â  Â  Â  box-shadow: none !important;Â  /* Remove sombras */
Â  Â  Â  Â  Â  Â  padding: 0 !important;Â  Â  Â  Â  /* Remove o padding que cria o tamanho da caixa */
Â  Â  Â  Â  Â  Â  margin-left: auto !important; /* MantÃ©m o alinhamento Ã  direita */
Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Visibilidade do Ãcone */
Â  Â  Â  Â  Â  Â  color: white !important;Â  Â  Â  /* Cor branca para o Ã­cone */
Â  Â  Â  Â  Â  Â  font-size: 0;Â  Â  Â  Â  Â  Â  Â  Â  Â /* Define a fonte do botÃ£o como zero para ocultar qualquer texto residual */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* 2. ForÃ§a o Ã­cone (i) a ter o tamanho correto e ser branco */
Â  Â  Â  Â  .btn-logout-header i {
Â  Â  Â  Â  Â  Â  color: white !important;
Â  Â  Â  Â  Â  Â  font-size: 1.5em !important; /* Define o tamanho final do Ã­cone (ajuste se necessÃ¡rio) */
Â  Â  Â  Â  Â  Â  padding: 5px; /* Adiciona uma Ã¡rea de clique maior ao redor do Ã­cone */
Â  Â  Â  Â  Â  Â  display: inline-block; /* Garante que o Ã­cone seja renderizado corretamente */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* 3. Garante que nÃ£o haja fundo branco/estranho ao interagir */
Â  Â  Â  Â  .btn-logout-header:hover,
Â  Â  Â  Â  .btn-logout-header:active,
Â  Â  Â  Â  .btn-logout-header:focus {
Â  Â  Â  Â  Â  Â  background: transparent !important;
Â  Â  Â  Â  Â  Â  box-shadow: none !important;
Â  Â  Â  Â  Â  Â  outline: none !important;
Â  Â  Â  Â  Â  Â  color: white !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  #menu-btn {Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  background: none;Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 1.5em;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  padding: 0 5px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-dial-mobile {
Â  Â  Â  Â  Â  Â  display: none !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .profile-badge {Â 
Â  Â  Â  Â  Â  Â  background-color: #800020; /* Cor sÃ³lida SIGMA (vermelho escuro) */
Â  Â  Â  Â  Â  Â  color: white; /* MantÃ©m o texto branco no fundo vermelho escuro */
Â  Â  Â  Â  Â  Â  padding: 4px 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 15px;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.8em;Â 
Â  Â  Â  Â  Â  Â  margin-left: 0; /* Remove a margem horizontal desnecessÃ¡ria na sidebar */
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.5); /* Borda mais visÃ­vel */
Â  Â  Â  Â  }
Â  Â  Â  Â  #sidebar-user-info .profile-badge {
Â  Â  Â  Â  Â  Â  /* Garante que o badge tenha margem superior para espaÃ§amento */
Â  Â  Â  Â  Â  Â  margin-top: 5px;Â 
Â  Â  Â  Â  Â  Â  margin-left: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  @media (min-width: 768px) {Â 
Â  Â  Â  Â  Â  Â  .header-title-desktop {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  .header-title-mobile {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  #menu-btn {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Sidebar */
Â  Â  Â  Â  .sidebar {Â 
Â  Â  Â  Â  Â  Â  width: 250px;
Â  Â  Â  Â  Â  Â  background-color: #ffffff;Â 
Â  Â  Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  Â  Â  padding-top: 20px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);Â 
Â  Â  Â  Â  Â  Â  border-right: 1px solid #e0e0e0;Â 
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 50px;Â 
Â  Â  Â  Â  Â  Â  left: 0;Â 
Â  Â  Â  Â  Â  Â  height: calc(100% - 50px);Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  Â  Â  z-index: 1100;Â 
Â  Â  Â  Â  Â  Â  overflow-y: auto;Â 
Â  Â  Â  Â  Â  Â  transition: left 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sidebar-header {Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  padding: 10px 0 20px 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .sidebar-header img {Â 
Â  Â  Â  Â  Â  Â  width: 60px;
Â  Â  Â  Â  Â  Â  height: auto;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  #sidebar-user-info {
Â  Â  Â  Â  Â  Â  /* Define o estilo principal do texto */
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: #800020; /* Cor do SIGMA */
Â  Â  Â  Â  Â  Â  margin: 0; /* Remove margens extras */
Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  Â  Â  display: flex; /* Permite alinhar nome e badge lado a lado */
Â  Â  Â  Â  Â  Â  flex-direction: column; /* Empilha Nome e Badge */
Â  Â  Â  Â  Â  Â  align-items: center; /* Centraliza verticalmente o texto */
Â  Â  Â  Â  }
Â  Â  Â  Â  #sidebar-user-info #user-name {
Â  Â  Â  Â  Â  Â  /* Estilo para o nome */
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px; /* EspaÃ§o entre nome e badge */
Â  Â  Â  Â  Â  Â  font-size: 0.9em; /* Um pouco menor que o tÃ­tulo */
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sidebar a {Â 
Â  Â  Â  Â  Â  Â  padding: 15px 20px;Â 
Â  Â  Â  Â  Â  Â  text-decoration: none;Â 
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  color: #555;Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;Â 
Â  Â  Â  Â  Â  Â  border-left: 4px solid transparent;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .sidebar a:hover {Â 
Â  Â  Â  Â  Â  Â  background-color: #fff5f5;Â 
Â  Â  Â  Â  Â  Â  color: #800020;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .sidebar a.active {Â 
Â  Â  Â  Â  Â  Â  background-color: #ffecec;Â 
Â  Â  Â  Â  Â  Â  color: #800020;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  border-left: 4px solid #d90f23;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .menu-label {Â 
Â  Â  Â  Â  Â  Â  padding: 15px 20px 5px;
Â  Â  Â  Â  Â  Â  font-size: 0.85em;Â 
Â  Â  Â  Â  Â  Â  color: #999;Â 
Â  Â  Â  Â  Â  Â  text-transform: uppercase;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sidebar-overlay {Â 
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: fixed;Â 
Â  Â  Â  Â  Â  Â  top: 0;Â 
Â  Â  Â  Â  Â  Â  left: 0;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.5);Â 
Â  Â  Â  Â  Â  Â  z-index: 1050;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Container da lista (AcordeÃ£o) */
.inventory-accordion-container {
Â  Â  margin-top: 15px;
}

/* CabeÃ§alho do Setor (Item do AcordeÃ£o) */
.accordion-header {
Â  Â  background-color: #f8f8f8;
Â  Â  color: #333;
Â  Â  padding: 12px 15px;
Â  Â  margin-top: 10px;
Â  Â  cursor: pointer;
Â  Â  border: 1px solid #ddd;
Â  Â  border-radius: 6px;
Â  Â  font-weight: bold;
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  transition: background-color 0.2s, box-shadow 0.2s;
Â  Â  font-size: 1em;
}

.accordion-header:hover {
Â  Â  background-color: #fff5f5;
Â  Â  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.accordion-header i.fa-chevron-down {
Â  Â  transition: transform 0.3s;
}

/* RotaÃ§Ã£o do Ã­cone quando ativo */
.accordion-header.active i.fa-chevron-down {
Â  Â  transform: rotate(180deg);
}

/* Corpo do ConteÃºdo (Itens) */
.accordion-content {
Â  Â  padding: 15px 0 5px;
Â  Â  border-left: 3px solid #800020;
Â  Â  margin-bottom: 20px;
Â  Â  /* Usado para a animaÃ§Ã£o de esconder/mostrar */
Â  Â  max-height: 0;
Â  Â  overflow: hidden;
Â  Â  transition: max-height 0.4s ease-out;
}

/* Grid de cards de itens */
.items-card-grid {
Â  Â  display: grid;
Â  Â  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
Â  Â  gap: 15px;
Â  Â  padding: 0 10px 0 10px; /* Adiciona padding interno */
}

/* Estilo do Card do Item */
.item-selection-card {
Â  Â  background-color: #fff;
Â  Â  border: 1px solid #eee;
Â  Â  border-radius: 6px;
Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
Â  Â  padding: 15px;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  justify-content: space-between;
Â  Â  transition: border-color 0.2s;
}

.item-selection-card.selected {
Â  Â  border-color: #1b8a3e; /* Verde quando selecionado */
Â  Â  background-color: #f6fff6;
Â  Â  box-shadow: 0 0 5px rgba(27, 138, 62, 0.3);
}

.item-card-title {
Â  Â  font-size: 1em;
Â  Â  font-weight: bold;
Â  Â  color: #800020;
Â  Â  margin: 0 0 10px 0;
}

/* Estilo do controle de quantidade para itens 'single' */
.qtd-control-wrapper {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 10px;
Â  Â  margin-top: 5px;
}

.qtd-control-wrapper label {
Â  Â  font-weight: normal;
Â  Â  font-size: 0.9em;
Â  Â  color: #555;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  flex-grow: 1;
}

.qtd-control-wrapper input[type="number"] {
Â  Â  width: 60px;
Â  Â  text-align: center;
Â  Â  padding: 5px;
Â  Â  border-radius: 4px;
Â  Â  font-size: 1em;
}

/* Estilo para as Tags/BotÃµes de Tombamento */
.tombamento-tag-list {
Â  Â  display: flex;
Â  Â  flex-wrap: wrap;
Â  Â  gap: 8px;
Â  Â  margin-top: 10px;
}

.tombamento-tag {
Â  Â  background-color: #efefef;
Â  Â  border: 1px solid #ccc;
Â  Â  padding: 6px 8px;
Â  Â  border-radius: 15px;
Â  Â  font-size: 0.8em;
Â  Â  cursor: pointer;
Â  Â  transition: background-color 0.2s, border-color 0.2s;
Â  Â  display: flex;
Â  Â  align-items: center;
}

.tombamento-tag input[type="checkbox"] {
Â  Â  margin-right: 5px;
Â  Â  cursor: pointer;
}

.tombamento-tag.selected {
Â  Â  background-color: #d9ffdb;
Â  Â  border-color: #1b8a3e;
Â  Â  font-weight: bold;
}

Â  Â  Â  Â  /* Content */
Â  Â  Â  Â  .content {Â 
Â  Â  Â  Â  Â  Â  margin-left: 250px;
Â  Â  Â  Â  Â  Â  flex-grow: 1;Â 
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  width: calc(100% - 250px);Â 
Â  Â  Â  Â  Â  Â  padding-bottom: 80px;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .view-section {Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  animation: fadeIn 0.3s ease;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .view-section.active-view {Â 
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes fadeIn {Â 
Â  Â  Â  Â  Â  Â  from {Â 
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  to {Â 
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Footer */
Â  Â  Â  Â  .footer-central {Â 
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 0;Â 
Â  Â  Â  Â  Â  Â  left: 0;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  padding: 5px 0 5px;Â 
Â  Â  Â  Â  Â  Â  background-color: #f4f4f9;Â 
Â  Â  Â  Â  Â  Â  color: #555;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.65em;Â 
Â  Â  Â  Â  Â  Â  line-height: 1.3;
Â  Â  Â  Â  Â  Â  z-index: 100;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .footer-central strong, .footer-autor {Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .footer-central strong {Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .footer-autor {Â 
Â  Â  Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  Â  Â  Â  Â  color: #888;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Cards e Grid */
Â  Â  Â  Â  /* Cards e Grid */
.cards-grid {Â 
Â  Â  display: flex;
/* flex-wrap: wrap;Â  */
Â  Â  flex-wrap: wrap;Â 
Â  Â  gap: 20px;Â 
Â  Â  margin-bottom: 30px;Â 
}Â 
.sector-card {Â 
Â  Â  background-color: white;
/* padding: 15px;Â  */
Â  Â  padding: 15px;Â 
Â  Â  min-height: 100px; /* â¬…ï¸ AJUSTE: Altura mÃ­nima aumentada para garantir alinhamento com cards de lista */
Â  Â  border-radius: 8px;
/* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
/* A chave: ForÃ§a o item a ter 280px como largura base e permite que o flexbox o organize */
Â  Â  flex: 0 0 220px;
/* max-width: 100%; */Â 
Â  Â  max-width: 100%;
/* /* Garante que nÃ£o ultrapasse a tela em mobile */ */
Â  Â  cursor: pointer;
/* /* transition: transform 0.2s, box-shadow 0.2s;Â  */
Â  Â  transition: transform 0.2s, box-shadow 0.2s;Â 
Â  Â  display: flex;Â 
Â  Â  flex-direction: column;
/* justify-content: space-between; */
Â  Â  justify-content: space-between;
}
Â  Â  Â  Â  /* Garante que o elemento principal dos Cards de PendÃªncia/EstatÃ­stica tenha altura para empurrar o rodapÃ© */
Â  Â  Â  Â  .sector-card:hover {Â 
Â  Â  Â  Â  Â  Â  transform: translateY(-5px);Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  background-color: #fff5f5;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector-card.status-alert {Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid #d90f23;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .sector-card.status-ok {Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid #1b8a3e;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .sector-card.status-unit {Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid #2c7399;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .sector-card.status-posto {Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid #8e44ad;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector-card.active-card {Â 
Â  Â  Â  Â  Â  Â  background-color: #ffecec;
Â  Â  Â  Â  Â  Â  border: 1px solid #d90f23;Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid #d90f23;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector-card h3 {Â 
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;Â 
Â  Â  Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector-card .main-stat {Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  margin: 10px 0;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector-card .count-value {Â 
Â  Â  Â  Â  Â  Â  font-size: 2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector-card.status-alert .count-value {Â 
Â  Â  Â  Â  Â  Â  color: #d90f23;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .sector-card.status-ok .count-value {Â 
Â  Â  Â  Â  Â  Â  color: #1b8a3e;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector-card .card-footer {Â 
Â  Â  Â  Â  Â  Â  font-size: 0.75em;
Â  Â  Â  Â  Â  Â  color: #777;Â 
Â  Â  Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  Â  Â  Â  Â  pt: 10px;Â 
Â  Â  Â  Â  Â  Â  border-top: 1px solid #eee;Â 
Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ==================================== */
/* NOVO: ESTILOS PARA CARDS DO MENU GESTÃƒO DE CAUTELAS */
/* Usa .sector-card + .menu-card para herdar a base de estilos */
/* ==================================== */

.menu-card {
Â  Â  /* Garante que o cartÃ£o ocupe no mÃ­nimo 250px, tornando o layout mais flexÃ­vel */
Â  Â  flex: 1 1 0;Â 
Â  Â  padding: 25px;Â 
Â  Â  text-align: center;
Â  Â  /* Remove a borda lateral de status que outros cards podem ter */
Â  Â  border-left: none !important;
}
@media (min-width: 900px) {
Â  Â  /* ForÃ§a o grid do menu de cautelas a ter 4 colunas de tamanho igual */
Â  Â  #cautelas-options-container {
Â  Â  Â  Â  /* Aumentamos a especificidade para garantir o layout de 4 colunas */
Â  Â  Â  Â  grid-template-columns: repeat(4, 1fr) !important;
Â  Â  Â  Â  gap: 15px;Â 
Â  Â  }
}

/* Ajusta o hover para ser visualmente mais forte e manter a cor institucional */
.menu-card:hover {
Â  Â  transform: translateY(-3px); /* Leve levantamento */
Â  Â  /* Usa a cor principal do sistema (#800020) na sombra */
Â  Â  box-shadow: 0 6px 15px rgba(128, 0, 32, 0.2);Â 
Â  Â  background-color: #fff8f8;
}

/* Estilo do Ãcone (a ser usado dentro do .menu-card) */
.menu-card .card-icon {
Â  Â  font-size: 3em;Â 
Â  Â  color: #800020; /* Cor Institucional */
Â  Â  margin-bottom: 10px;
Â  Â  display: block;
}

/* Estilo do TÃ­tulo dentro do Card de Menu */
.menu-card h3 {
Â  Â  font-size: 1.2em;
Â  Â  color: #333;
Â  Â  margin-top: 0;
Â  Â  margin-bottom: 5px;
}

/* Estilo da DescriÃ§Ã£o/ParÃ¡grafo */
.menu-card p {
Â  Â  font-size: 0.9em;
Â  Â  color: #666;
Â  Â  margin: 0;
}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .sub-list-preview {Â 
Â  Â  Â  Â  Â  Â  font-size: 0.85em;Â 
Â  Â  Â  Â  Â  Â  color: #555;Â 
Â  Â  Â  Â  Â  Â  list-style: none;Â 
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  max-height: 60px;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sub-list-preview li {Â 
Â  Â  Â  Â  Â  Â  white-space: nowrap;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-overflow: ellipsis;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Greeting Card */
Â  Â  Â  Â  .greeting-card {Â 
Â  Â  Â  Â  Â  Â  /* Estilos Visuais */
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #800020 0%, #5a0017 100%);
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 10px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 25px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(128, 0, 32, 0.2);Â 
Â  Â Â 
Â  Â  Â  Â  Â  Â  /* ConfiguraÃ§Ã£o Flexbox */
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap; /* âœ… ESSENCIAL: Permite que a foto e o bloco de info (.greeting-info) quebrem em telas pequenas. */
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 20px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .greeting-avatar {Â 
Â  Â  Â  Â  Â  Â  width: 50px;Â 
Â  Â  Â  Â  Â  Â  height: 50px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  flex-basis: auto;
Â  Â  Â  Â  Â  Â  border: 3px solid rgba(255,255,255,0.3);Â 
Â  Â  Â  Â  Â  Â  object-fit: cover;Â 
Â  Â  Â  Â  Â  Â  background-color: white;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .greeting-info {Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap; /* Permite a quebra de linha em mobile */
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  flex-grow: 1; /* Ocupa o mÃ¡ximo de espaÃ§o possÃ­vel */
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  flex-basis: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .greeting-text-wrapper {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  order: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  #btn-open-conf-modal {
Â  Â  Â  Â  Â  Â  margin-left: auto; /* Empurra o botÃ£o para a direita em desktop */
Â  Â  Â  Â  Â  Â  justify-content: center !important;Â 
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .greeting-title {Â 
Â  Â  Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.3em;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  line-height: 1.2;
Â  Â  Â  Â  }
Â  Â  Â  Â  .greeting-date {Â 
Â  Â  Â  Â  Â  Â  font-size: 0.85em;Â 
Â  Â  Â  Â  Â  Â  opacity: 0.8;Â 
Â  Â  Â  Â  Â  Â  margin-top: 3px;Â 
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }
Â  Â  Â  Â  .greeting-user {Â 
Â  Â  Â  Â  Â  Â  font-size: 1.1em;Â 
Â  Â  Â  Â  Â  Â  margin-top: 5px;Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  }
Â  Â  Â  Â  .greeting-title, .greeting-user {Â 
Â  Â  Â  Â  Â  Â  white-space: nowrap; /* Impede quebras de linha dentro do texto */
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-overflow: ellipsis; /* Adiciona "..." se o texto for muito longo */
Â  Â  Â  Â  Â  Â  max-width: 100%; /* Garante que respeite o pai */
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Card de Nova ConferÃªncia / Filtros */
Â  Â  Â  Â  .op-card {Â 
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  border-radius: 10px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.05);Â 
Â  Â  Â  Â  Â  Â  padding: 25px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 25px;Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid #ccc;
Â  Â  Â  Â  }
Â  Â  Â  Â  .op-card.action {Â 
Â  Â  Â  Â  Â  Â  border-left-color: #1b8a3e;
Â  Â  Â  Â  }
Â  Â  Â  Â  .op-card.history {Â 
Â  Â  Â  Â  Â  Â  border-left-color: #2c7399;
Â  Â  Â  Â  }
Â  Â  Â  Â  .op-card.resume {Â 
Â  Â  Â  Â  Â  Â  border-left-color: #f57c00;Â 
Â  Â  Â  Â  Â  Â  background-color: #fff3e0;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  transition: transform 0.2s;
Â  Â  Â  Â  Â  Â  padding: 25px 35px 25px 25px; /* Adiciona 35px de padding na direita */
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }
Â  Â  Â  Â  .op-card.resume:hover {Â 
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .op-card-title {Â 
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  Â  Â  margin-top: 0;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;Â 
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.2em;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group {
			display: flex;
    		flex-direction: column;
    		gap: 5px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group label {Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  color: #555;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  }
		.form-group input[type="text"],
		.form-group input[type="number"],
		.form-group select {
    		padding: 10px;
    		border: 1px solid #ccc;
    		border-radius: 6px;
    		font-size: 1em;
		}

		/* Estilo para inputs de checkbox/radio integrados */
		.form-group input[type="radio"],
		.form-group input[type="checkbox"] {
    		cursor: pointer;
    		accent-color: #800020; /* Cor Institucional */
		}

		/* Ãrea de Kit */
		#area-selecao-componentes {
   			transition: all 0.4s ease;
    		animation: fadeInSlide 0.3s ease-out;
		}

		@keyframes fadeInSlide {
    		from { opacity: 0; transform: translateY(-10px); }
    		to { opacity: 1; transform: translateY(0); }
		}
Â  Â  Â  Â  .form-group select, .form-group input {Â 
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  Â  Â  Â  border-radius: 5px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  /* Garante que todos os inputs de formulÃ¡rio herdem a fonte base */
Â  Â  Â  Â  Â  Â  font-family: inherit;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Regra especÃ­fica para inputs de data no Chrome/Edge/Firefox, forÃ§ando a fonte */
Â  Â  Â  Â  Â input[type="date"] {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group select:focus, .form-group input:focus {Â 
Â  Â  Â  Â  Â  Â  border-color: #800020;
Â  Â  Â  Â  Â  Â  outline: none;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-start {Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #d90f23 0%, #800020 100%);Â 
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.1em;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px rgba(217, 15, 35, 0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-start:focus {Â 
Â  Â  Â  Â  Â  Â  outline: 3px solid rgba(128,0,32,0.4);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Admin Tables & Lists */
Â  Â  Â  Â  .new-local-section {Â 
Â  Â  Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.1);Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;Â 
Â  Â  Â  Â  Â  Â  border-top: 3px solid #2c7399;
Â  Â  Â  Â  }
Â  Â  Â  Â  .admin-table {Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  border-collapse: collapse;Â 
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.05);Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .admin-table th, .admin-table td {Â 
Â  Â  Â  Â  Â  Â  padding: 12px 15px;Â 
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .admin-table th {Â 
Â  Â  Â  Â  Â  Â  background-color: #f8f9fa;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: #555;Â 
Â  Â  Â  Â  Â  Â  text-transform: uppercase;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.85em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .role-badge {Â 
Â  Â  Â  Â  Â  Â  padding: 3px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.8em;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .role-admin {Â 
Â  Â  Â  Â  Â  Â  background-color: #d90f23;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .role-gestor {Â 
Â  Â  Â  Â  Â  Â  background-color: #f57c00;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .role-operacional {Â 
Â  Â  Â  Â  Â  Â  background-color: #1b8a3e;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Editor de Listas (Elementos) */
Â  Â  Â  Â  .admin-container {Â 
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 10px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  max-width: 900px;Â 
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .lista-setores {Â 
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  list-style: none;Â 
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â  .setor-item {Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #800020;Â 
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  }
Â  Â  Â  Â  .item-list-admin {}
Â  Â  Â  Â  .setor-content-header-sticky {
Â  Â  Â  Â  Â  Â  /* Tornar o contÃªiner do cabeÃ§alho e formulÃ¡rio sticky */
Â  Â  Â  Â  Â  Â  position: sticky;
Â  Â  Â  Â  Â  Â  top: 50px; /* Bate logo abaixo do main-header (50px) */
Â  Â  Â  Â  Â  Â  z-index: 50;
Â  Â  Â  Â  Â  Â  /* Garante que fique acima dos itens rolando */
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  /* Fundo branco para cobrir o conteÃºdo rolando */
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  /* Sombra suave para destacar */
Â  Â  Â  Â  }
Â  Â  Â  Â  .setor-header-admin {Â 
Â  Â  Â  Â  Â  Â  background-color: #800020;Â 
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 10px 15px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  cursor: grab;Â 
Â  Â  Â  Â  Â  Â  z-index: 51;
Â  Â  Â  Â  }
Â  Â  Â  Â  .setor-content-admin {Â 
Â  Â  Â  Â  Â  Â  transition: max-height 0.4s ease-out;
Â  Â  Â  Â  Â  Â  /* Removemos o max-height alto e o overflow: hidden */
Â  Â  Â  Â  Â  Â  max-height: 1500px;
Â  Â  Â  Â  Â  Â  /* Define uma altura mÃ¡xima visÃ­vel */
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  /* PERMITE A ROLAGEM VERTICAL */
Â  Â  Â  Â  Â  Â  padding: 10px 10px 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #lista-setores-container {
Â  Â  Â  Â  Â  Â  Â border: none !important;
Â  Â  Â  Â  Â  Â  Â margin-top: 20px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .setor-content-admin.collapsed {Â 
Â  Â  Â  Â  Â  Â  max-height: 0;
Â  Â  Â  Â  Â  Â  padding: 0 !important;Â 
Â  Â  Â  Â  Â  Â  overflow-y: hidden; /* Oculta a barra quando colapsado */
Â  Â  Â  Â  }
Â  Â  Â  Â  .item-conferencia-admin {Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: flex-start;Â 
Â  Â  Â  Â  Â  Â  padding: 10px 0;Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;Â 
Â  Â  Â  Â  Â  Â  cursor: move;
Â  Â  Â  Â  }
Â  Â  Â  Â  .add-item-form-setor {Â 
Â  Â  Â  Â  Â  Â  padding: 10px 15px 5px;Â 
Â  Â  Â  Â  Â  Â  background-color: #f8f8f8;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  Â  Â  margin-bottom: 0;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .add-item-form-setor input, .add-item-form-setor select {Â 
Â  Â  Â  Â  Â  Â  flex-grow: 1;Â 
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .tombamento-container-wrapper {Â 
Â  Â  Â  Â  Â  Â  margin-top: 5px;Â 
Â  Â  Â  Â  Â  Â  padding-left: 20px;
Â  Â  Â  Â  Â  Â  background: #f9f9f9;Â 
Â  Â  Â  Â  Â  Â  border-left: 3px solid #ccc;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  .tombamento-list li {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  padding: 5px 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px dotted #eee;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .item-actions-admin {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-remover {Â 
Â  Â  Â  Â  Â  Â  background-color: #d90f23;Â 
Â  Â  Â  Â  Â  Â  color:white;Â 
Â  Â  Â  Â  Â  Â  border:none;Â 
Â  Â  Â  Â  Â  Â  padding:5px 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius:4px;
Â  Â  Â  Â  Â  Â  cursor:pointer;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .btn-edit-alt {Â 
Â  Â  Â  Â  Â  Â  background-color: #7f8c8d;Â 
Â  Â  Â  Â  Â  Â  color:white;Â 
Â  Â  Â  Â  Â  Â  border:none;Â 
Â  Â  Â  Â  Â  Â  padding:5px 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius:4px;
Â  Â  Â  Â  Â  Â  cursor:pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-add {Â 
Â  Â  Â  Â  Â  Â  background-color: #800020;Â 
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .locais-list {Â 
Â  Â  Â  Â  Â  Â  list-style: none;Â 
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .local-item {Â 
Â  Â  Â  Â  Â  Â  background: white;Â 
Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.05);Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid #800020;
Â  Â  Â  Â  }
Â  Â  Â  Â  .local-info strong {Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.1em;Â 
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* CA Table */
Â  Â  Â  Â  .ca-table-container {Â 
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  background-color: white;Â 
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);Â 
Â  Â  Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  Â  Â  Â  Â  border-top: 3px solid #d90f23;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .ca-table {Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  border-collapse: collapse;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .ca-table th, .ca-table td {Â 
Â  Â  Â  Â  Â  Â  padding: 12px 15px;Â 
Â  Â  Â  Â  Â  Â  text-align: left;Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #ddd;Â 
Â  Â  Â  Â  Â  Â  vertical-align: top;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .ca-table th {Â 
Â  Â  Â  Â  Â  Â  background-color: #f8f8f8;Â 
Â  Â  Â  Â  Â  Â  color: #800020;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-select-container {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-select-container input[type="text"] {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  transition: border-color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  Â .custom-select-container input[type="text"]:focus {
Â  Â  Â  Â  Â  Â  border-color: #800020;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .suggestions-box {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 100%; /* Posiciona logo abaixo do input */
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  z-index: 10; /* Garante que fique acima de outros elementos */
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  border: 1px solid #800020; /* Cor Institucional */
Â  Â  Â  Â  Â  Â  border-top: none;
Â  Â  Â  Â  Â  Â  border-radius: 0 0 5px 5px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  max-height: 200px; /* Limita a altura para rolagem */
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  display: none; /* Inicia oculto */
Â  Â  Â  Â  }

Â  Â  Â  Â  #cautela-suggestions-list {
Â  Â  Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  #cautela-suggestions-list li {
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 0.95em;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }

Â  Â  Â  Â  #cautela-suggestions-list li:last-child {
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  #cautela-suggestions-list li:hover {
Â  Â  Â  Â  Â  Â  background-color: #ffecec; /* Hover com cor institucional clara */
Â  Â  Â  Â  Â  Â  color: #800020;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  }
Â  Â  Â  Â  .row-amarelo {Â 
Â  Â  Â  Â  Â  Â  background-color: #fff9c4 !important;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .row-laranja {Â 
Â  Â  Â  Â  Â  Â  background-color: #ffe0b2 !important;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .status-badge {Â 
Â  Â  Â  Â  Â  Â  padding: 4px 8px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.8em;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .badge-pendente {Â 
Â  Â  Â  Â  Â  Â  background-color: #ffebee;Â 
Â  Â  Â  Â  Â  Â  color: #d32f2f;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .badge-solucao {Â 
Â  Â  Â  Â  Â  Â  background-color: #fff9c4;Â 
Â  Â  Â  Â  Â  Â  color: #fbc02d;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #fbc02d;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .badge-cautela {Â 
Â  Â  Â  Â  Â  Â  background-color: #ffe0b2;Â 
Â  Â  Â  Â  Â  Â  color: #f57c00;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #f57c00;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Modals - ESTILO PREMIUM */
Â  Â  Â  Â  .modal-overlay {Â 
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;Â 
Â  Â  Â  Â  Â  Â  left: 0;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.6);Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  z-index: 2000;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .modal-content {Â 
Â  Â  Â  Â  Â  Â  background: #fff;Â 
Â  Â  Â  Â  Â  Â  padding: 25px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px;Â 
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  max-width: 500px;Â 
Â  Â  Â  Â  Â  Â  position: relative;Â 
Â  Â  Â  Â  Â  Â  text-align: left;Â 
Â  Â  Â  Â  Â  Â  max-height: 90vh;Â 
Â  Â  Â  Â  Â  Â  overflow-y: auto;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .modal-content h2 {Â 
Â  Â  Â  Â  Â  Â  margin-top: 0;Â 
Â  Â  Â  Â  Â  Â  color: #800020;Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.4em;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .modal-content label {Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;Â 
Â  Â  Â  Â  Â  Â  font-weight: 600;Â 
Â  Â  Â  Â  Â  Â  color: #444;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.95em;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Inputs Premium no Modal */
Â  Â  Â  Â  .modal-content input[type="text"],Â 
Â  Â  Â  Â  .modal-content input[type="number"],
Â  Â  Â  Â  .modal-content select,Â 
Â  Â  Â  Â  .modal-content textarea {Â 
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 12px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  font-size: 1em;Â 
Â  Â  Â  Â  Â  Â  font-family: inherit;
Â  Â  Â  Â  Â  Â  transition: border-color 0.3s, box-shadow 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
Â  Â  Â  Â  Â  Â  border-color: #800020;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .modal-content textarea {Â 
Â  Â  Â  Â  Â  Â  height: 100px;
Â  Â  Â  Â  Â  Â  resize: vertical;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .modal-buttons {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: flex-end;Â 
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .close-btn {Â 
Â  Â  Â  Â  Â  Â  position: absolute;Â 
Â  Â  Â  Â  Â  Â  top: 15px;Â 
Â  Â  Â  Â  Â  Â  right: 15px;
Â  Â  Â  Â  Â  Â  background: none;Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  font-size: 20px;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  color: #999;Â 
Â  Â  Â  Â  Â  Â  transition: color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .close-btn:hover {Â 
Â  Â  Â  Â  Â  Â  color: #d90f23;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* --- ADICIONE ESTES ESTILOS AO BLOCO <style> DO sigma_dashboard.html.txt --- */

.modal-content button {Â 
Â  Â  padding: 10px 20px;Â 
Â  Â  margin-top: 20px;Â 
Â  Â  border: none;Â 
Â  Â  border-radius: 5px;Â 
Â  Â  cursor: pointer;Â 
Â  Â  transition: background-color 0.3s;Â 
Â  Â  font-weight: bold;Â 
}

.modal-btn-cancel {Â 
Â  Â  background-color: #ccc;Â 
Â  Â  color: #333;Â 
}

.modal-btn-cancel:hover {Â 
Â  Â  background-color: #bbb;Â 
}

.modal-actions {Â 
Â  Â  display: flex;Â 
Â  Â  justify-content: flex-end;Â 
Â  Â  gap: 10px; /* Adiciona espaÃ§amento entre os botÃµes */
}
/* --- ESTILOS PARA ABAS DE NAVEGAÃ‡ÃƒO (CORREÃ‡ÃƒO FINAL DE COR) --- */
.tab-navigation {
Â  Â  width: fit-content;Â 
Â  Â  margin: 0 auto;
Â  Â  display: flex;
Â  Â  border-bottom: 2px solid #ddd;Â 
Â  Â  margin-bottom: 0 !important;Â 
}

/* Regra base do botÃ£o */
.tab-button {
Â  Â  /* Removendo !important da cor base para que a regra :not(.active) funcione */
Â  Â  color: #000;Â 
Â  Â  background-color: transparent;
Â  Â Â 
Â  Â  border: 1px solid #ccc !important;
Â  Â  border-bottom: 2px solid #ddd !important;
Â  Â  border-radius: 8px 8px 0 0 !important;Â 
Â  Â  padding: 10px 18px !important;
Â  Â  font-weight: 600;
Â  Â  transition: all 0.3s ease;
Â  Â  cursor: pointer;
Â  Â  margin-bottom: -2px;Â 
}

/* ğŸ›‘ CORREÃ‡ÃƒO FINAL: ForÃ§a o texto para preto SÃ“ QUANDO NÃƒO ESTÃ ATIVO ğŸ›‘ */
/* Esta regra tem especificidade suficiente para anular a cor branca herdada */
.tab-navigation .tab-button:not(.active) {
Â  Â  color: #000 !important;
Â  Â  background-color: transparent !important;
}

.tab-button:hover:not(.active) {
Â  Â  background-color: #f0f0f0 !important;
Â  Â  color: #333 !important;Â 
}

.tab-button.active {
Â  Â  /* ESTILO ATIVO DESEJADO: BRANCO NO VINHO (#800020) */
Â  Â  background-color: #800020 !important;Â 
Â  Â  color: white !important; /* Texto branco */
Â  Â  border-color: #800020 !important;
Â  Â  border-bottom-color: #fff !important;Â 
Â  Â  box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
Â  Â  z-index: 10;Â 
}

.historico-tab-content {
Â  Â  background-color: #fff;
Â  Â  border: 1px solid #ddd;
Â  Â  border-top: 2px solid #800020; /* Borda da cor da aba ativa */
Â  Â  padding: 15px;
Â  Â  border-radius: 0 6px 6px 6px;
Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

/* Garante que o botÃ£o de Recebimento use o estilo btn-modern-action, se ele nÃ£o estiver pegando */
#btn-receber-cautela {
Â  Â  /* Exemplo: Se precisar de estilo de aÃ§Ã£o forte */
Â  Â  background-color: #1b8a3e; /* Verde Forte */
Â  Â  color: white;
}
#btn-receber-cautela:hover {
Â  Â  background-color: #14682f;
}

Â  Â  Â  Â  /* Checkbox list in modal */
Â  Â  Â  Â  .checklist-container {Â 
Â  Â  Â  Â  Â  Â  max-height: 200px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #eee;Â 
Â  Â  Â  Â  Â  Â  padding: 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  margin-top: 5px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .checklist-item {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  padding: 5px;Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px dotted #f0f0f0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .checklist-item:hover {Â 
Â  Â  Â  Â  Â  Â  background: #fafafa;
Â  Â  Â  Â  }
Â  Â  Â  Â  .checklist-item input {Â 
Â  Â  Â  Â  Â  Â  width: auto;Â 
Â  Â  Â  Â  Â  Â  margin-right: 10px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Buttons */
Â  Â  Â  Â  .btn-modern-action {
Â  Â  Â  Â  Â  Â  /* PROPRIEDADES DE LAYOUT ORIGINAIS (MANTIDAS) */
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â Â 
Â  Â  Â  Â  Â  Â  /* PROPRIEDADES DE ESTILO E COR (ATUALIZADAS) */
Â  Â  Â  Â  Â  Â  background-color: #800020; /* Vermelho Escuro (Cor principal do SIGMA) */
Â  Â  Â  Â  Â  Â  color: #ffffff !important; /* ForÃ§a a cor branca */
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 8px 15px; /* Tamanho ligeiramente menor para botÃ£o de 'Voltar' */
Â  Â  Â  Â  Â  Â  border-radius: 6px; /* Mantive o seu radius original */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  font-size: 0.9em; /* Tamanho reduzido para ser secundÃ¡rio */
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s, box-shadow 0.2s; /* Ajuste na transiÃ§Ã£o */
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Sombra mais destacada */
Â  Â  Â  Â  Â  Â  white-space: nowrap;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-modern-action:hover {
Â  Â  Â  Â  Â  Â  background-color: #a00030; /* Um pouco mais claro no hover */
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-modern-action:active {Â 
Â  Â  Â  Â  Â  Â  transform: translateY(1px);
Â  Â  Â  Â  Â  Â  box-shadow: none;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-create {
Â  Â  Â  Â  Â  Â  background-color: #2c7399; /* Seu Azul original */
Â  Â  Â  Â  Â  Â  color: #ffffff !important;Â 
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 10px 18px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-create:hover {
Â  Â  Â  Â  Â  Â  background-color: #205b7a;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-form-action {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin-top: 15px; /* Adiciona um espaÃ§o acima do botÃ£o no formulÃ¡rio */
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-secondary {
Â  Â  		background-color: #5d6d7e; /* Cinza grafite (mais escuro para dar contraste) */
Â  Â  		color: #ffffff !important;Â  /* ForÃ§a o texto a ser branco */
Â  Â  		border: none;
Â  Â  		padding: 8px 15px;
Â  Â  		border-radius: 5px;
Â  Â  		cursor: pointer;
Â  Â  		font-size: 0.9em;
Â  Â  		font-weight: bold;
Â  Â  		transition: background-color 0.2s, transform 0.1s;
Â  Â  		display: inline-flex;
Â  Â  		align-items: center;
Â  Â  		gap: 8px;
Â  Â  		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.btn-secondary:hover {
Â  Â  		background-color: #34495e; /* Tom mais escuro ao passar o mouse */
		}

		.btn-secondary:active {
Â  Â  		transform: scale(0.95); /* Efeito de clique */
		}
Â  Â  Â  Â  .btn-edit {Â 
Â  Â  Â  Â  Â  Â  background-color: #2c7399;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-edit:hover {
Â  Â  Â  Â  Â  Â  background-color: #205b7a; /* Um tom mais escuro para o hover */
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-delete {Â 
Â  Â  Â  Â  Â  Â  background-color: #d90f23;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .btn-sync {Â 
Â  Â  Â  Â  Â  Â  background-color: #1b8a3e;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  .btn-backup {Â 
Â  Â  Â  Â  Â  Â  background: #5d6164;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-filter-modern {Â 
Â  Â  Â  Â  Â  Â  background-color: #2c7399;Â 
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  padding: 11px 25px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 

Â  Â  Â  Â  /* APP CONTAINER (IFRAME) */
Â  Â  Â  Â  #app-runner-container {Â 
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: fixed;Â 
Â  Â  Â  Â  Â  Â  top: 50px;Â 
Â  Â  Â  Â  Â  Â  left: 250px;Â 
Â  Â  Â  Â  Â  Â  width: calc(100% - 250px);Â 
Â  Â  Â  Â  Â  Â  height: calc(100vh - 50px);Â 
Â  Â  Â  Â  Â  Â  background: white;Â 
Â  Â  Â  Â  Â  Â  z-index: 500;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  #app-iframe {Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* History List Specifics */
Â  Â  Â  Â  .history-list {Â 
Â  Â  Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .history-item {Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  Â  Â  padding: 15px 0;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  transition: background 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .history-item:hover {Â 
Â  Â  Â  Â  Â  Â  background-color: #fafafa;Â 
Â  Â  Â  Â  Â  Â  padding-left: 5px;Â 
Â  Â  Â  Â  Â  Â  padding-right: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .history-item:last-child {Â 
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .hist-info strong {Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.05em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .hist-info small {Â 
Â  Â  Â  Â  Â  Â  color: #777;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .hist-status {Â 
Â  Â  Â  Â  Â  Â  font-size: 0.8em;Â 
Â  Â  Â  Â  Â  Â  padding: 4px 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-left: 5px;Â 
Â  Â  Â  Â  Â  Â  text-transform: uppercase;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-ok {Â 
Â  Â  Â  Â  Â  Â  background-color: #e8f5e9;Â 
Â  Â  Â  Â  Â  Â  color: #2e7d32;
Â  Â  Â  Â  Â  Â  border: 1px solid #c8e6c9;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-alert {Â 
Â  Â  Â  Â  Â  Â  background-color: #ffebee;Â 
Â  Â  Â  Â  Â  Â  color: #c62828;
Â  Â  Â  Â  Â  Â  border: 1px solid #ffcdd2;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-reprint {Â 
Â  Â  Â  Â  Â  Â  background: white;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  color: #555;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-reprint:hover {Â 
Â  Â  Â  Â  Â  Â  border-color: #800020;Â 
Â  Â  Â  Â  Â  Â  color: #800020;Â 
Â  Â  Â  Â  Â  Â  background-color: #fff5f5;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Filtros Premium */
Â  Â  Â  Â  .modern-filter-card {Â 
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 10px;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #e0e0e0;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.05);Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  gap: 15px;Â 
Â  Â  Â  Â  Â  Â  align-items: flex-end;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .filter-item {Â 
Â  Â  Â  Â  Â  Â  flex: 1;Â 
Â  Â  Â  Â  Â  Â  min-width: 200px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .filter-item label {Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 6px;Â 
Â  Â  Â  Â  Â  Â  font-weight: 600;Â 
Â  Â  Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .filter-input {Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  padding: 10px 12px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.95em;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dashboard-columns {
Â  Â  display: flex;
Â  Â  flex-direction: column; /* Em mobile, os blocos ficam empilhados (Mobile-First) */
Â  Â  gap: 25px;Â 
}
Â  Â  /* Regra para garantir o alinhamento vertical centralizado do Ã­cone ao bloco de texto */
.unit-header .unit-flex-title {
Â  Â  display: flex;
Â  Â  align-items: center; /* CENTRALIZA O ÃCONE VERTICALMENTE COM O TEXTO QUEBRADO */
Â  Â  gap: 8px; /* EspaÃ§amento entre o Ã­cone e o texto */
Â  Â  width: 100%; /* Opcional, para garantir que o H3 preencha a largura */
}

/* Garante que o texto se comporte como um bloco para quebrar corretamente */
.unit-header .unit-flex-title span {
Â  Â  flex-grow: 1;Â 
Â  Â  line-height: 1.3; /* Melhora a leitura do texto quebrado */
}Â  Â Â 
Â  Â  Â  Â Â 
/* Mobile */
@media (max-width: 600px) {
Â  Â Â 
Â  Â  /* --- REORGANIZAÃ‡ÃƒO DO HEADER DE CAUTELAS (NOVO) --- */
Â  Â  .header-container {
Â  Â  Â  Â  flex-wrap: wrap;Â 
Â  Â  Â  Â  justify-content: flex-start !important;Â 
Â  Â  Â  Â  align-items: flex-start !important;
Â  Â  Â  Â  padding-left: 5px !important; /* Mantendo seu padding de seÃ§Ã£o */
Â  Â  Â  Â  padding-right: 5px !important;
Â  Â  }

Â  Â  /* O BotÃ£o <- VOLTAR (Linha 1, Alinhado Ã  Direita) */
Â  Â  #btn-back-cautelas {
Â  Â  Â  Â  order: 1;Â 
Â  Â  Â  Â  margin-left: auto;Â 
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  margin-top: 5px;Â 
Â  Â  Â  Â  margin-bottom: 5px;Â 
Â  Â  }

Â  Â  /* O TÃ­tulo (Linha 2, Ocupa 100%) */
Â  Â  .header-container h3 {
Â  Â  Â  Â  order: 2;Â 
Â  Â  Â  Â  flex-basis: 100%;Â 
Â  Â  Â  Â  margin-top: 0;
Â  Â  }
Â  Â Â 
Â  Â  /* --- INÃCIO DO GRADEAMENTO TABLE-TO-CARD PARA CAUTELAS --- */
Â  Â Â 
Â  Â  /* 1. Seletores abrangentes para transformar a tabela em bloco */
Â  Â  #cautelas-ativas-table,Â 
Â  Â  #cautelas-receive-table,
Â  Â  #cautelas-ativas-table thead,
Â  Â  #cautelas-receive-table thead,
Â  Â  #cautelas-ativas-table tbody,
Â  Â  #cautelas-receive-table tbody,
Â  Â  #cautelas-ativas-table th,
Â  Â  #cautelas-receive-table th,
Â  Â  #cautelas-ativas-table td,
Â  Â  #cautelas-receive-table td,
Â  Â  #cautelas-ativas-table tr,
Â  Â  #cautelas-receive-table tr {
Â  Â  Â  Â  display: block;
Â  Â  }
Â  Â  #cautelas-ativas-table .group-title-cell:before {
Â  Â  Â  Â  content: none !important;
Â  Â  }

Â  Â  /* 2. Esconde o cabeÃ§alho original da tabela */
Â  Â  #cautelas-ativas-table thead tr,Â 
Â  Â  #cautelas-receive-table thead tr {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: -9999px;
Â  Â  Â  Â  left: -9999px;
Â  Â  }

Â  Â  /* 3. Configura cada linha da tabela (<tr>) para ser um 'card' */
Â  Â  #cautelas-ativas-table tr,
Â  Â  #cautelas-receive-table tr {
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  cursor: pointer; /* MantÃ©m o cursor de clique */
Â  Â  }

Â  Â  /* 4. Estilo do cabeÃ§alho de grupo (para a linha com colspan) */
Â  Â  #cautelas-ativas-table tr.group-header {
Â  Â  Â  Â  display: table-row;Â 
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  box-shadow: none;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  }
Â  Â  #cautelas-ativas-table tr.group-header td {
Â  Â  Â  Â  display: table-cell;
Â  Â  Â  Â  padding: 0;
Â  Â  }
Â  Â  .group-header .group-title-cell {
Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  padding-left: 0 !important;
Â  Â  }

Â  Â  /* 5. Configura cada cÃ©lula (<td>) para ser uma linha do 'card' */
Â  Â  #cautelas-ativas-table td,
Â  Â  #cautelas-receive-table td {
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  padding-left: 50% !important;Â 
Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  white-space: normal;
Â  Â  Â  Â  font-size: 0.9em;
Â  Â  }

Â  Â  /* 6. Insere o cabeÃ§alho (data-label) antes do conteÃºdo da cÃ©lula */
Â  Â  #cautelas-ativas-table td:before,
Â  Â  #cautelas-receive-table td:before {
Â  Â  Â  Â  content: attr(data-label);
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  left: 10px;Â 
Â  Â  Â  Â  width: 45%;
Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  color: #800020;Â 
Â  Â  }
Â  Â  /* --- FIM DO GRADEAMENTO TABLE-TO-CARD --- */
Â  Â Â 
Â  Â Â 
Â  Â  /* O SEU CÃ“DIGO RESTANTE ABAIXO... */
Â  Â  .greeting-card {
Â  Â  Â  Â  align-items: flex-start;
Â  Â  }
Â  Â  .greeting-info {
Â  Â  Â  Â  flex-basis: auto;
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  flex-direction: row;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .greeting-text-wrapper {
Â  Â  Â  Â  flex-basis: 100%;
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  margin-bottom: 0;
Â  Â  }
Â  Â  #btn-open-conf-modal {
Â  Â  Â  Â  flex-basis: 100%;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  margin-left: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  order: 1;
Â  Â  }
Â  Â  .btn-dial-mobile {
Â  Â  Â  Â  display: inline-block !important;
Â  Â  }
Â  Â  greeting-avatar {
Â  Â  Â  Â  flex-basis: auto;
Â  Â  }
Â  Â  #menu-btn {
Â  Â  Â  Â  display: block;
Â  Â  }
Â  Â  .sidebar {
Â  Â  Â  Â  left: -260px;
Â  Â  Â  Â  width: 260px;
Â  Â  Â  Â  border-right: 1px solid #ddd;
Â  Â  }
Â  Â  .sidebar.mobile-active {
Â  Â  Â  Â  left: 0;
Â  Â  }
Â  Â  .content, .content-area {
Â  Â  Â  Â  margin-left: 0 !important;
Â  Â  Â  Â  width: 100% !important;
Â  Â  Â  Â  padding-top: 15px !important;
Â  Â  Â  Â  padding-left: 10px !important;
Â  Â  Â  Â  padding-right: 10px !important;
Â  Â  }
Â  Â  .view-section {
Â  Â  Â  Â  padding-left: 5px !important;
Â  Â  Â  Â  padding-right: 5px !important;
Â  Â  }
Â  Â  .header-container {
Â  Â  Â  Â  /* As regras de flexbox foram movidas para cima */
Â  Â  Â  Â  padding-left: 5px !important;
Â  Â  Â  Â  padding-right: 5px !important;
Â  Â  }
Â  Â  .menu-card {
Â  Â  Â  Â  margin-left: 0 !important;
Â  Â  Â  Â  margin-right: 0 !important;
Â  Â  }
Â  Â  body {
Â  Â  Â  Â  margin: 0 !important;
Â  Â  }
Â  Â  #app-runner-container {
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  z-index: 500;
Â  Â  }
Â  Â  .modern-filter-card {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: stretch;
Â  Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .btn-filter-modern {
Â  Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  .filter-input {
Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  .filter-item {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  min-width: 0;
Â  Â  }
Â  Â  .admin-container {
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  margin-top: 20px;
Â  Â  }
Â  Â  .admin-table, .admin-table thead, .admin-table tbody, .admin-table th, .admin-table td, .admin-table tr {
Â  Â  Â  Â  display: block;
Â  Â  }
Â  Â  .admin-table thead tr {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: -9999px;
Â  Â  Â  Â  left: -9999px;
Â  Â  }
Â  Â  .admin-table tr {
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
Â  Â  }
Â  Â  .admin-table td {
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  padding-left: 50%;
Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  font-size: 0.9em;
Â  Â  }
Â  Â  .admin-table td:before {
Â  Â  Â  Â  content: attr(data-label);
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  width: 45%;
Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #800020;
Â  Â  }
Â  Â  .admin-table td[data-label="AÃ§Ãµes:"],
Â  Â  .admin-table td:last-child {
Â  Â  Â  Â  text-align: right !important;
Â  Â  }
Â  Â  .global-actions {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .new-local-section > div[style*="grid"] {
Â  Â  Â  Â  display: block !important;
Â  Â  }
Â  Â  .new-local-section > div[style*="flex"] {
Â  Â  Â  Â  display: block !important;
Â  Â  }
Â  Â  .new-local-section .form-group {
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .new-local-section .btn-modern-action, .new-local-section .btn-create {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  }
Â  Â  .sector-card {
Â  Â  Â  Â  margin-left: 0 !important;
Â  Â  Â  Â  margin-right: 0 !important;
Â  Â  Â  Â  flex: 1 1 100% !important;
Â  Â  Â  Â  max-width: 100% !important;
Â  Â  }
Â  Â  .cards-grid {
Â  Â  Â  Â  gap: 20px 0 !important;
Â  Â  Â  Â  margin-left: 0 !important;
Â  Â  Â  Â  margin-right: 0 !important;
Â  Â  }
Â  Â  .add-setor-form {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 10px !important;
Â  Â  Â  Â  margin-left: 0 !important;
Â  Â  }
Â  Â  .add-item-form-setor {
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  .add-item-form-setor input, .add-item-form-setor select, .add-item-form-setor button {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  .add-item-form-setor button {
Â  Â  Â  Â  flex-grow: 0;
Â  Â  Â  Â  width: 48%;
Â  Â  }
Â  Â  .item-conferencia-admin {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  padding: 10px;
Â  Â  }
Â  Â  .item-actions-admin {
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  align-self: flex-end;
Â  Â  }
Â  Â  .tombamento-container-wrapper {
Â  Â  Â  Â  padding-left: 10px;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  }
Â  Â  .tombamento-list li {
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  padding: 5px 0;
Â  Â  }
Â  Â  .tombamento-list input {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  }
Â  Â  .form-grid-2-columns {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  }
	.tabs-cadastro {
        flex-wrap: wrap;
    }
}
Â  Â  Â  Â  @media (min-width: 769px) {Â 
Â  Â  Â  Â  Â  Â  .sidebar-overlay {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: none !important;
Â  Â  Â  Â  Â  Â  }
Â  Â Â 
Â  Â  Â  Â  Â  Â  .dashboard-columns {
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row;Â 
Â  Â  Â  Â  Â  Â  Â  Â  /* ğŸ’¡ CORREÃ‡ÃƒO: Usamos stretch para que os dois blocos (op-card)Â 
Â  Â  Â  Â  Â  Â  Â  Â  ocupem 100% da altura do bloco mais alto, igualando o tamanho. */
Â  Â  Â  Â  Â  Â  Â  Â  align-items: stretch;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .dashboard-columns .op-card {
Â  Â  Â  Â  Â  Â  Â  Â  flex: 1;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .restricted-admin-only {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  /* Estilo especÃ­fico para o botÃ£o de descarte do card de resumo */
.op-card.resume {
Â  Â  position: relative; /* NecessÃ¡rio para posicionar o botÃ£o absoluto */
}
.btn-resume-close {
Â  Â  position: absolute;
Â  Â  top: 5px;Â 
Â  Â  right: 5px;Â 
Â  Â  background: none;
Â  Â  border: none;
Â  Â  color: #d90f23;Â 
Â  Â  font-size: 1.4em;Â 
Â  Â  cursor: pointer;
Â  Â  padding: 5px;
Â  Â  opacity: 0.9;Â 
Â  Â  transition: color 0.2s, opacity 0.2s;
}
.btn-resume-close:hover {
Â  Â  color: #FF3B3B;Â 
Â  Â  opacity: 1;
}
Â  Â  Â  Â  /* ==================================== */
/* ESTILOS ESPECÃFICOS DO FORMULÃRIO DE CAUTELAS */
/* ==================================== */

/* Layout de 2 colunas para campos principais no desktop */
.form-grid-2-columns {
Â  Â  display: grid;
Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  gap: 20px; /* EspaÃ§amento entre os campos */
}

/* Estilo geral para o grupo de campo */
.form-group {
Â  Â  margin-bottom: 15px;
}

.form-group label {
Â  Â  display: block;
Â  Â  font-weight: bold;
Â  Â  margin-bottom: 5px;
Â  Â  color: #444;
}

/* Estilo para todos os inputs, selects e textareas */
.form-group input, .form-group select, .form-group textarea {
Â  Â  width: 100%;
Â  Â  padding: 10px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 5px;
Â  Â  box-sizing: border-box; /* CRÃTICO: Garante que padding e border nÃ£o estourem a largura */
Â  Â  font-size: 1em;
}

/* Ãrea de Listagem/SeleÃ§Ã£o de Itens */
#itens-custodia-list {
Â  Â  max-height: 300px;
Â  Â  overflow-y: auto;
Â  Â  border: 1px solid #ddd;
Â  Â  padding: 10px;
Â  Â  border-radius: 5px;
Â  Â  margin-bottom: 15px;
}
	/* Estilos especÃ­ficos para a tabela do Almoxarifado */
#almox-table th {
Â  Â  background-color: #800020;
Â  Â  color: white;
}

#almox-body tr:hover {
Â  Â  background-color: #fff5f5;
}

/* Badge de estoque disponÃ­vel */
.stock-badge {
Â  Â  padding: 5px 10px;
Â  Â  border-radius: 20px;
Â  Â  font-weight: bold;
Â  Â  font-size: 0.9em;
}

/* Efeito de destaque para a linha de distribuiÃ§Ã£o (Detalhes) */
.distribuicao-row {
Â  Â  background-color: #f9f9f9;
Â  Â  border-left: 4px solid #2c7399;
}
		.btn-link-detalhe {
Â  Â  background: none;
Â  Â  border: none;
Â  Â  color: #2c7399;
Â  Â  text-decoration: underline;
Â  Â  font-weight: bold;
Â  Â  cursor: pointer;
Â  Â  padding: 2px 5px;
}
.btn-link-detalhe:hover {
Â  Â  color: #800020;
Â  Â  background-color: #f0f0f0;
Â  Â  border-radius: 4px;
}
	/* ESTILOS PARA O MODAL DE CADASTRO GLOBAL */

/* Container das abas */
.tabs-cadastro {
    border-bottom: 2px solid #eee;
    padding-bottom: 0;
}
		/* BotÃµes das abas */
.btn-tab {
    padding: 10px 20px;
    border: none;
    background: #f1f1f1;
    cursor: pointer;
    font-weight: bold;
    color: #666;
    border-radius: 8px 8px 0 0;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.btn-tab:hover {
    background: #e9e9e9;
    color: #800020;
}

.btn-tab.active {
    background: #fff;
    color: #800020;
    border-bottom: 3px solid #800020;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
}

Â  Â  </style>
</head>
<body>
    <div id="mobile-overlay" class="sidebar-overlay" onclick="closeMenuMobile()"></div>

   <header class="main-header">
    <button id="menu-btn" onclick="toggleMenuMobile()"><i class="fas fa-bars"></i></button>

    <img src="cbmrr.png" alt="Logo CBM-RR" class="header-icon" 
         style="margin-right: -10px;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/000000/fff?text=CBM'">
    
    <div class="header-title-desktop">
        <span class="text-white"> CORPO DE BOMBEIROS MILITAR </span>
        <span class="text-red">RORAIMA</span>
    </div>

    <div class="header-title-mobile">
        <span class="text-white">CBM</span><span class="text-red">RR</span>
    </div>
    
    <img src="logo_sigma.png" alt="Logo SIGMA" class="header-icon" 
         style="opacity: 0;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=S'">

    <div id="dashboard-greeting" style="display:none; margin-left: 20px; font-size: 0.9em; font-style: italic;">
        Bem-vindo(a)! Preencha a conferÃªncia para hoje.
    </div>
    <button onclick="logout()" class="btn-modern-action btn-logout-header" style="margin-left: auto;">
        <i class="fas fa-sign-out-alt"></i> 
    </button>
</header>
    
    <div class="sidebar" id="main-sidebar">
        <div class="sidebar-header">
            <img src="logo_sigma.png" alt="Logo SIGMA" onerror="this.onerror=null; this.src='https://placehold.co/50x50/ffffff/800020/fff?text=S'">
            <div id="sidebar-user-info">
            <span id="user-name"></span>
            <span id="user-role-display" class="profile-badge">Carregando...</span>
        </div>
        </div>
        <div class="menu-label">Operacional</div>
        <a onclick="switchView('dashboard')" id="link-dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard & ServiÃ§o</a>
        <a onclick="switchView('my-history')" id="link-my-history"><i class="fas fa-history"></i> Minhas ConferÃªncias</a>
        <a onclick="switchView('cautelas')" id="link-cautelas" class="restricted-admin-only"><i class="fas fa-boxes"></i> GestÃ£o de Cautelas</a>
        
        <div class="menu-label restricted-admin-only" id="sidebar-rotulo-admin">AdministraÃ§Ã£o</div>
		<a onclick="switchView('almoxarifado')" id="link-almoxarifado" class="restricted-admin-only">
    		<i class="fas fa-warehouse"></i> Almoxarifado Central
		</a>
        <a onclick="switchView('global-history')" id="link-global-history"><i class="fas fa-folder-open"></i> HistÃ³rico da Unidade</a>
        <a onclick="switchView('unidades')" id="link-unidades" class="restricted-admin-only"><i class="fas fa-shield-alt"></i> Unidades</a>
        <a onclick="switchView('postos')" id="link-postos" class="restricted-admin-only"><i class="fas fa-map-signs"></i> Postos</a>
        <a onclick="switchView('usuarios')" id="link-usuarios" class="restricted-admin-only"><i class="fas fa-users"></i> UsuÃ¡rios</a>
        <a onclick="switchView('listas')" id="link-listas" class="restricted-admin-only"><i class="fas fa-clipboard-list"></i> Editor de Listas</a>
    </div>
    <div id="content-area" class="main-content-wrapper">
        </div>

    <div class="content">
        
        <div id="view-dashboard" class="view-section active-view">
            <div class="greeting-card">
                <img id="greeting-photo" src="https://placehold.co/70x70/ffffff/800020?text=U" class="greeting-avatar">
                <div class="greeting-info">
                    <div class="greeting-text-wrapper"> 
                        <h2 id="greeting-text" class="greeting-title">Carregando...</h2>
                        <span id="greeting-name" class="greeting-user">...</span>
                        <span id="current-date" class="greeting-date">...</span>
                    </div>
                </div>
        
                <button id="btn-open-conf-modal" class="btn-modern-action" style="background-color: #d90f23;" onclick="openNewConferenceModal()">
                    <i class="fas fa-play-circle"></i> Nova ConferÃªncia
                </button>
            </div>

            <div id="resume-container"></div>
            <div id="dashboard-content-by-role">
                <div id="admin-gestor-cards-container"></div>
                <div id="operacional-cards-container"></div>
            </div>
    
            <div id="ca-table-wrapper" class="ca-table-container" style="display: none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="table-title" style="margin:0; color:#800020;">Detalhes</h2>
                    <button onclick="fecharTabela()" class="btn-modern-action btn-delete">Fechar</button>
                </div>
                <table class="ca-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Status</th>
                            <th>AlteraÃ§Ã£o</th>
                            <th>AÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody id="ca-list-body"></tbody>
                </table>
                <div id="no-issues-msg" style="display:none; padding:20px; text-align:center; color:green;">
                    âœ… Tudo OK.
                </div>
            </div>
        </div>
        
        <div id="view-my-history" class="view-section">
            <div class="op-card history">
                <h2 class="op-card-title"><i class="fas fa-history"></i> Minhas ConferÃªncias</h2>
                <div class="modern-filter-card">
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                        <input type="date" id="my-hist-start" class="filter-input">
                    </div>
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Final</label>
                        <input type="date" id="my-hist-end" class="filter-input">
                    </div>
                    <div class="filter-item" style="flex: 0;">
                        <button class="btn-filter-modern" onclick="loadMyHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
                <ul id="my-history-list" class="history-list"></ul>
            </div>
        </div>

    <div id="view-global-history" class="view-section">
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-folder-open"></i> HistÃ³rico da Unidade (GestÃ£o)</h2>
            <div class="modern-filter-card">
                <div class="filter-item">
                    <label><i class="fas fa-user"></i> Conferente</label>
                    <select id="glob-hist-user" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                    <input type="date" id="glob-hist-start" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Final</label>
                    <input type="date" id="glob-hist-end" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="fas fa-map-marker-alt"></i> Local</label>
                    <select id="glob-hist-local" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item" style="flex: 0;">
                    <button class="btn-filter-modern" onclick="loadGlobalHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>
            <ul id="global-history-list" class="history-list"></ul>
        </div>
    </div>

    <div id="view-usuarios" class="view-section">
    <h1>GestÃ£o de UsuÃ¡rios</h1>
    <div class="new-local-section">
        <h3>Cadastrar Novo Militar</h3>
        
        <div class="form-grid-2-columns" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            
            <div class="form-group"><label>Nome Civil Completo</label><input type="text" id="new-user-completo" placeholder="NOME COMPLETO"></div>
            <div class="form-group"><label>Nome de Guerra</label><input type="text" id="new-user-guerra" placeholder="EX: JHONATH"></div>
            
            <div class="form-group">
                <label>Posto / GraduaÃ§Ã£o</label>
                <select id="new-user-posto">
                    <option value="" disabled selected>Selecione o Posto</option>
                    <option value="CEL">CEL</option>
                    <option value="TEN CEL">TEN CEL</option>
                    <option value="MAJ">MAJ</option>
                    <option value="CAP">CAP</option>
                    <option value="1Âº TEN">1Âº TEN</option>
                    <option value="2Âº TEN">2Âº TEN</option>
                    <option value="ST">ST</option>
                    <option value="1Âº SGT">1Âº SGT</option>
                    <option value="2Âº SGT">2Âº SGT</option>
                    <option value="3Âº SGT">3Âº SGT</option>
                    <option value="CB">CB</option>
                    <option value="SD">SD</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Quadro</label>
                <select id="new-user-quadro" disabled>
                    <option value="" disabled selected>Selecione o Posto acima</option>
                </select>
            </div>
            
            <div class="form-group"><label>CPF</label><input type="text" id="new-user-cpf" placeholder="000.000.000-00" maxlength="14"></div>
            <div class="form-group"><label>MatrÃ­cula</label><input type="text" id="new-user-matricula" placeholder="0000000-000" maxlength="11"></div>
            <div class="form-group"><label>Telefone para Contato</label><input type="text" id="new-user-telefone" placeholder="(00) 00000-0000" maxlength="15"></div>
            
            <div class="form-group"><label>Email (Login)</label><input type="email" id="new-user-email" placeholder="email@cbm.rr.gov.br"></div>
            
            <div class="form-group">
                <label>Perfil</label>
                <select id="new-user-role">
                    <option value="operacional">Operacional</option>
                    <option value="gestor">Gestor de Unidade</option>
                    <option value="admin">Administrador Geral</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Unidade</label>
                <select id="new-user-unit"><option value="">Carregando...</option></select>
            </div>
        </div>
        
        <button class="btn-modern-action btn-create" onclick="criarUsuario()" style="margin-top: 10px;">Salvar UsuÃ¡rio</button>
    </div>
        
        <h3>UsuÃ¡rios Cadastrados</h3>
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="user-search-input"><i class="fas fa-search"></i> Filtrar por Nome de ExibiÃ§Ã£o:</label>
                <input type="text" id="user-search-input" placeholder="Digite o Nome de ExibiÃ§Ã£o (Posto Quadro Nome Guerra)" class="filter-input" oninput="filtrarUsuarios()">
            </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Militar</th>
                    <th>Telefone para Contato</th> 
                    <th>Perfil</th>
                    <th>Unidade</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="users-table-body"></tbody>
        </table>
    </div>

    <div id="view-unidades" class="view-section">
        <h1>GestÃ£o de Unidades</h1>
        <div class="new-local-section">
            <h3>Criar Nova Unidade</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome da Unidade (Ex: 1Âª CIA, CBS)</label>
                    <input type="text" id="new-unit-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarUnidade()">Adicionar</button>
            </div>
        </div>
        <h3>Unidades Existentes</h3>
        <div id="units-cards-container" class="cards-grid"></div>
    </div>
  
    <div id="view-postos" class="view-section">
        <h1>GestÃ£o de Postos</h1>
        <div class="new-local-section">
            <h3>Criar Novo Posto</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome do Posto (Ex: ALFA, BRAVO)</label>
                    <input type="text" id="new-posto-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarPosto()">Adicionar</button>
            </div>
        </div>
        <h3>Postos Existentes</h3>
        <div id="postos-cards-container" class="cards-grid"></div>
    </div>

    <div id="view-listas" class="view-section">
        <h1>Editor de Listas</h1>
        <div class="new-local-section">
        	<h3>Criar Lista</h3>
			<div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
    			<div class="form-group" style="flex: 1 1 200px;"> 
        			<label>Posto de ServiÃ§o</label>
        			<select id="novo-local-posto" class="filter-input">
            			<option value="" disabled selected>Carregando Postos...</option>
        			</select>
    			</div>

    			<div class="form-group" style="flex: 1 1 250px;">
        			<label>Nome do Novo Item</label>
        			<input type="text" id="novo-local-nome" placeholder="EX: RESGATE 01" class="filter-input">
    			</div>

    			<div class="form-group" style="flex: 1 1 200px;">
        			<label>Unidade de VÃ­nculo</label>
        			<select id="novo-local-unidade" class="filter-input">
            			<option value="" disabled selected>Carregando Unidades...</option>
        			</select>
    			</div>

    			<button class="btn-modern-action btn-create" onclick="criarNovoLocal()" style="height: 40px; margin-bottom: 5px;">CRIAR</button>

			</div>
        </div>
        <ul id="lista-locais-container" class="locais-list"></ul>
    </div>
	<div id="view-almoxarifado" class="view-section">
        <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <div>
                <h2 style="margin:0; color: #800020;"><i class="fas fa-warehouse"></i> Almoxarifado Central</h2>
                <small id="almox-breadcrumb" style="color: #888; font-weight: bold;">Almoxarifado > InventÃ¡rio Geral</small>
            </div>
            <div class="global-actions" style="display: flex; gap: 10px;">
                <button class="btn-modern-action btn-sync" onclick="sincronizarAlmoxarifado()">
                    <i class="fas fa-sync"></i> Sincronizar Saldos
                </button>
                <button class="btn-modern-action btn-create" onclick="imprimirInventario()">
                    <i class="fas fa-print"></i> RelatÃ³rio
                </button>
            </div>
        </div>

        <div class="modern-filter-card" style="margin-bottom: 20px;">
            <div class="filter-item">
                <label><i class="fas fa-search"></i> Pesquisar Material</label>
                <input type="text" id="almox-search" class="filter-input" placeholder="Ex: Mangueira, EPR, Lanterna..." oninput="filtrarAlmoxarifado()">
            </div>
            <div class="filter-item">
                <label><i class="fas fa-filter"></i> Categoria</label>
                <select id="almox-cat-filter" class="filter-input" onchange="filtrarAlmoxarifado()">
                    <option value="">Todas as Categorias</option>
                    <option value="Salvamento">Salvamento</option>
                    <option value="IncÃªndio">IncÃªndio</option>
                    <option value="APH">APH</option>
                    <option value="Equipamento">Equipamento</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
        </div>

        <div class="ca-table-container">
            <table class="ca-table" id="almox-table">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th style="text-align: center;">Total Geral</th>
                        <th style="text-align: center;">Em Uso</th>
                        <th style="text-align: center;">Pendente</th>
                        <th style="text-align: center;">DisponÃ­vel</th>
                        <th style="text-align: center;">AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody id="almox-body">
                    <tr>
                        <td colspan="6" style="text-align:center; padding:30px; color:#999;">
                            <i class="fas fa-info-circle"></i> Clique em "Sincronizar" para carregar o inventÃ¡rio pela primeira vez.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="view-editor" class="view-section">
        <div class="admin-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button onclick="switchView('listas')" class="btn-modern-action btn-edit">Voltar</button>
                <h1 class="page-title" id="editor-title" style="font-size:1.2em; margin:0;">Editando...</h1>
            </div>
            <div id="loading-message-admin">Carregando...</div>
                <div id="main-admin-content" style="display:none;">
                    <div class="global-actions">
                        <button class="btn-modern-action btn-sync" onclick="salvarDados()">Salvar</button>
                        <button class="btn-modern-action btn-backup" onclick="fazerBackupLocal()">Backup</button>
                        <button class="btn-modern-action btn-delete" onclick="limparCarimbosCautela()">Limpar Carimbos Cautela</button>
                        <input type="file" id="import-json" style="display: none;" onchange="importarBackupLocal(event)">
                        <button class="btn-modern-action btn-create" onclick="document.getElementById('import-json').click()">Importar</button>
              
                        <div class="add-setor-form" style="margin-left:auto; display:flex; gap:5px;">
                            <input type="text" id="input-setor-nome" placeholder="Nome Setor" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                            <button class="btn-add" onclick="adicionarSetor(document.getElementById('input-setor-nome').value)">+ Setor</button>
                        </div>
                    </div>
                    <ul id="lista-setores-container" class="lista-setores"></ul>
                </div>
            </div>
        </div>
        <div id="view-cautelas" class="view-section restricted-admin-only">
            <div class="header-container">
                <h2>GestÃ£o de Cautelas</h2>
                <p>Gerenciamento completo das cautelas de materiais do sistema SIGMA.</p>
            </div>

            <div id="cautelas-options-container" class="cards-grid"> 

                <div class="sector-card menu-card" onclick="loadNewCautelaForm()">
                    <i class="fas fa-file-contract card-icon"></i>
                    <h3>Nova Cautela</h3>
                    <p>Gerar um novo termo de cautela para um militar.</p>
                </div>

                <div class="sector-card menu-card" onclick="showCautelasDashboard('Cautelas Ativas')">
                    <i class="fas fa-clipboard-check card-icon"></i>
                    <h3>Cautelas Ativas</h3>
                    <p>Visualizar e gerenciar todas as cautelas em vigor.</p>
                </div>

                <div class="sector-card menu-card" onclick="showCautelasDashboard('Cautelas a Receber')">
                    <i class="fas fas fa-inbox card-icon"></i> <h3>Cautelas a Receber</h3>
                    <p>PendÃªncias de materiais a serem devolvidos/repassados.</p>
                </div>

                <div class="sector-card menu-card" onclick="showCautelasDashboard('HistÃ³rico')">
                    <i class="fas fa-history card-icon"></i>
                    <h3>HistÃ³rico de Cautelas</h3>
                    <p>Consultar todas as cautelas emitidas e finalizadas.</p>
                </div>

            </div>
    
            <div id="cautelas-content" class="main-content-area">
        </div>
</div>
    </div>
    
    <div id="app-runner-container"><iframe id="app-iframe" src=""></iframe></div>

    <div id="modal-gestao-ca" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-gestao-ca').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar PendÃªncia</h2>
            <p id="gestao-item-nome" style="color:#800020; font-weight:bold; margin-bottom:5px; padding-bottom:0;"></p>
            
            <input type="hidden" id="gestao-doc-id">
            <input type="hidden" id="gestao-item-id-lista">
            <input type="hidden" id="gestao-pendencia-id"> <input type="hidden" id="gestao-item-max-qtd">
            
            <label>AÃ§Ã£o do Gestor</label>
            <select id="gestao-status">
                <option value="Solucionado">Resolvido (Saneia este ID e move para histÃ³rico)</option>
                <option value="Em soluÃ§Ã£o">Em soluÃ§Ã£o (Informa o status mas mantÃ©m o alerta)</option>
                <option value="Cautelado">Passar para Cautela Administrativa</option>
            </select>
            
            <div id="div-gestao-qtd" style="display:none;">
                <label style="color:#d90f23;">Quantidade Afetada:</label>
                <input type="number" id="gestao-qtd" min="1" value="1">
                <small id="gestao-qtd-info" style="color:#666; font-size:0.85em;"></small>
            </div>
            
            <label>AnotaÃ§Ã£o TÃ©cnica / Despacho (ObrigatÃ³rio)</label>
            <textarea id="gestao-obs" style="min-height: 100px;" placeholder="Descreva a soluÃ§Ã£o ou o andamento da manutenÃ§Ã£o deste item especÃ­fico..."></textarea>
            
            <div class="modal-buttons">
                <button class="btn-modern-action btn-backup" onclick="document.getElementById('modal-gestao-ca').style.display='none'">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarGestaoCa()">Salvar AÃ§Ã£o</button>
            </div>
        </div>
    </div>
	<div id="modal-almox-transferencia" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px; border-top: 5px solid #1b8a3e;">
        <button class="close-btn" onclick="document.getElementById('modal-almox-transferencia').style.display='none'"><i class="fas fa-times"></i></button>
        <h2 id="almox-transf-titulo">Movimentar Material</h2>
        <p id="almox-transf-item-nome" style="font-weight: bold; color: #800020; margin-bottom: 20px;"></p>

        <div class="form-group">
            <label>Tipo de OperaÃ§Ã£o</label>
            <select id="almox-operacao-tipo" onchange="toggleAlmoxDestino()">
                <option value="ENTRADA">Entrada de Novo Estoque (Aumentar Total)</option>
                <option value="ENVIO">Enviar do Almoxarifado para Viatura</option>
                <option value="RECOLHIMENTO">Recolher da Viatura para Almoxarifado</option>
                <option value="BAIXA">Baixa Definitiva (InservÃ­vel/Perda)</option>
            </select>
        </div>

        <div id="div-almox-viatura" class="form-group" style="display:none;">
            <label>Viatura / Local Alvo</label>
            <select id="almox-viatura-alvo" class="filter-input"></select>
        </div>

        <div class="form-group">
            <label>Quantidade</label>
            <input type="number" id="almox-transf-qtd" min="1" value="1" class="filter-input">
        </div>

        <div class="form-group">
            <label>Justificativa / Nota Fiscal / OfÃ­cio</label>
            <textarea id="almox-transf-obs" placeholder="Ex: NF 123, Recebido do almoxarifado central, etc." style="height: 80px;"></textarea>
        </div>

        <div class="modal-buttons">
            <button class="btn-modern-action btn-backup" onclick="document.getElementById('modal-almox-transferencia').style.display='none'">Cancelar</button>
            <button class="btn-modern-action btn-sync" onclick="executarMovimentacaoAlmox()"><i class="fas fa-check"></i> Confirmar</button>
        </div>
    </div>
</div>
    <div id="modal-unit-manager" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-unit-manager').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Unidade</h2>
            <label>Nome da Unidade</label>
            <input type="text" id="edit-unit-name-input">
            <input type="hidden" id="edit-unit-original-name">
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas:</label>
            <div id="unit-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirUnidade()">Excluir Unidade</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUnidade()">Salvar AlteraÃ§Ãµes</button>
            </div>
        </div>
    </div>

    <div id="modal-posto-manager" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="document.getElementById('modal-posto-manager').style.display='none'"><i class="fas fa-times"></i></button>
        <h2>Gerenciar Posto</h2>
        <label>Nome do Posto</label>
        <input type="text" id="edit-posto-name-input">
        <input type="hidden" id="edit-posto-original-name">
                <div id="posto-preview-container" style="
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    background-color: #f9f9f9;
                    margin-bottom: 20px;
                ">
                <p style="margin: 0;">Listas Atualmente Vinculadas: **Carregando...**</p>
            </div>
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas a este Posto:</label>
            <div id="posto-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirPosto()">Excluir Posto</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesPosto()">Salvar AlteraÃ§Ãµes</button>
            </div>
        </div>
    </div>

    <div id="modal-edicao" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="fecharModal()"><i class="fas fa-times"></i></button>
            <h2>Editar Item</h2>
            <input type="hidden" id="edit-setor-id">
            <input type="hidden" id="edit-item-original-id">
            <label>Nome:</label>
            <input type="text" id="edit-item-nome">
            <label>Mover para Setor:</label>
            <select id="edit-item-setor"></select>
            <label>Quantidade:</label>
            <input type="number" id="edit-item-qtd" min="1">
            <label>Tipo:</label>
            <select id="edit-item-tipo" disabled style="background-color: #eee;">
                <option value="single">Item Ãšnico</option>
                <option value="multi">Item com Tombamento</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-remover" onclick="fecharModal()">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarEdicaoItem()">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-user-manager" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="document.getElementById('modal-user-manager').style.display='none'"><i class="fas fa-times"></i></button>
        <h2>Gerenciar Militar</h2>
        
        <input type="hidden" id="edit-user-doc-id">
        
        <div class="form-grid-2-columns" style="margin-bottom: 0;">
    <div>
        <label>Nome de Guerra</label>
        <input type="text" id="edit-user-guerra">
        
        <label>Posto/GraduaÃ§Ã£o</label>
        <select id="edit-user-posto">
            <option value="" disabled selected>Selecione o Posto</option>
            <option value="CEL">CEL</option>
            <option value="TEN CEL">TEN CEL</option>
            <option value="MAJ">MAJ</option>
            <option value="CAP">CAP</option>
            <option value="1Âº TEN">1Âº TEN</option>
            <option value="2Âº TEN">2Âº TEN</option>
            <option value="ST">ST</option>
            <option value="1Âº SGT">1Âº SGT</option>
            <option value="2Âº SGT">2Âº SGT</option>
            <option value="3Âº SGT">3Âº SGT</option>
            <option value="CB">CB</option>
            <option value="SD">SD</option>
        </select>
        
        <label>Quadro</label>
        <select id="edit-user-quadro" disabled>
            <option value="" disabled selected>Selecione...</option>
        </select>

        <label>Nome de ExibiÃ§Ã£o (Posto/Quadro/Guerra)</label>
        <input type="text" id="edit-user-display-name" disabled style="background-color: #eee;">
    </div>

    <div>
        <label>CPF (Apenas dÃ­gitos)</label>
        <input type="text" id="edit-user-cpf"> 
        
        <label>MatrÃ­cula (Apenas dÃ­gitos)</label>
        <input type="text" id="edit-user-matricula">
        
        <label>Telefone para Contato (DDD)</label>
        <input type="text" id="edit-user-telefone">
    </div>
</div>

<hr style="margin: 20px 0; border: 0; border-top: 1px dashed #eee;">

<label>Nome Civil Completo</label>
<input type="text" id="edit-user-completo">

        <label>E-mail (Login) - *Somente Leitura*</label>
        <input type="email" id="edit-user-email" disabled style="background-color: #eee;">

        <label>Perfil de Acesso</label>
        <select id="edit-user-role">
            <option value="operacional">Operacional</option>
            <option value="gestor">Gestor de Unidade</option>
            <option value="admin">Administrador Geral</option>
        </select>

        <label>Unidade Associada</label>
        <select id="edit-user-unit"><option value="">Carregando...</option></select>
        
        <div id="user-permissions-fields" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; display: none;">
            <label class="section-label" style="font-weight: bold;">PermissÃµes de Gestor</label>
            <p style="font-size: 0.8em; margin: 5px 0 10px; color: #666;">Essas permissÃµes sÃ³ sÃ£o aplicÃ¡veis a usuÃ¡rios com a Role 'gestor'.</p>

            <div style="display: flex; flex-direction: column; gap: 5px;">
                <label><input type="checkbox" id="perm-view-cards"> Visualizar Cards de PendÃªncia C/A</label>
                <label><input type="checkbox" id="perm-view-history"> Acesso ao HistÃ³rico da Unidade</label>
                <label><input type="checkbox" id="perm-manage-posts"> Gerenciar VÃ­nculos de Postos</label>
                <label><input type="checkbox" id="perm-manage-users"> Gerenciar UsuÃ¡rios da Unidade</label>
                <label><input type="checkbox" id="perm-manage-lists"> Gerenciar Listas da Unidade</label>
            </div>
        </div>
        
        <div class="modal-buttons" style="justify-content: space-between;">
            <button class="btn-modern-action btn-delete" onclick="excluirUsuario()">Excluir Militar</button>
            <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUsuario()">Salvar AlteraÃ§Ãµes</button>
        </div>
    </div>
</div>
    <div id="modal-nova-conferencia" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <button class="close-btn" onclick="document.getElementById('modal-nova-conferencia').style.display='none'"><i class="fas fa-times"></i></button>
        <div class="op-card action" style="border: none; box-shadow: none; padding: 0;">
            <h2 class="op-card-title"><i class="fas fa-clipboard-list"></i> Nova ConferÃªncia</h2>
            <div class="form-group">
                <label>1. Escolha o Setor / Posto</label>
                <select id="dash-select-setor" onchange="filtrarListasDashboard()">
                    <option value="" disabled selected>Carregando setores...</option>
                </select>
            </div>
            <div class="form-group">
                <label>2. Escolha a Viatura / Lista</label>
                <select id="dash-select-lista" disabled onchange="focarBotaoIniciar()">
                    <option value="" disabled selected>Selecione um setor acima</option>
                </select>
            </div>
            <button id="btn-start-dash" class="btn-start" onclick="iniciarConferenciaDashboard()">INICIAR AGORA</button>
        </div>
    </div>
        
</div>
    <div id="cautelaDetailsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #800020;"><i class="fas fa-clipboard-list"></i> Detalhes da Cautela <span id="modal-cautela-id"></span></h3>
        <button class="close-btn" onclick="document.getElementById('cautelaDetailsModal').style.display='none'" style="position:static; margin-left:15px;"><i class="fas fa-times"></i></button>
    </div>

    <div class="form-area" style="padding: 15px; border: none; box-shadow: none; background-color: #f9f9f9; margin-bottom: 15px; border-radius: 8px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div><label>Emitente:</label><span id="modal-emitente" class="info-value"></span></div>
            <div><label>DestinatÃ¡rio:</label><span id="modal-destinatario-original" class="info-value"></span></div>
            <div><label>Recebedor Atual:</label><span id="modal-destinatario-atual" class="info-value"></span></div>
            
            <div><label>Local de Origem:</label><span id="modal-local-origem" class="info-value"></span></div>
            <div><label>Data de EmissÃ£o:</label><span id="modal-data-emissao" class="info-value"></span></div>
            <div><label>Status:</label><span id="modal-status-text" class="info-value"></span></div>
        </div>
        
        <label>ObservaÃ§Ãµes da EmissÃ£o:</label>
        <div id="modal-obs-emissao" style="background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee; min-height: 40px; font-size: 0.9em; font-style: italic; margin-bottom: 15px;"></div>

        <label><i class="fas fa-stream"></i> HistÃ³rico de MovimentaÃ§Ãµes:</label>
        <div id="modal-historico-movimentacoes" style="background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee; max-height: 150px; overflow-y: auto; font-size: 0.85em;">
            <p style="color: #999; text-align: center;">Nenhuma movimentaÃ§Ã£o registrada.</p>
        </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px;">
        <h4 style="color: #800020; margin: 0;">Itens Cautelados:</h4>
        <button id="btn-reportar-problema" class="btn-modern-action" style="display:none; background-color: #f57c00; font-size: 0.75em; padding: 5px 10px;" onclick="iniciarFluxoSubstituicao()">
            <i class="fas fa-exclamation-triangle"></i> Substituir/Reportar
        </button>
    </div>

    <ul id="modal-itens-cautela" class="cautela-item-list" style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 0; list-style: none;"></ul>
    
    <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
        <button class="btn-modern-action" id="btn-receber-cautela" style="display: none; background-color: #1b8a3e;">
            <i class="fas fa-check-circle"></i> Iniciar Recebimento
        </button>
        
        <button class="btn-modern-action btn-delete" id="btn-devolver-cautela" style="display: none;">
            <i class="fas fa-undo"></i> Iniciar DevoluÃ§Ã£o
        </button>
        
        <button class="btn-modern-action btn-sync" id="btn-confirmar-devolucao" style="display: none;">
            <i class="fas fa-handshake"></i> Confirmar DevoluÃ§Ã£o
        </button>
        
        <button class="modal-btn-cancel" onclick="document.getElementById('cautelaDetailsModal').style.display='none'">Fechar</button>
    </div>
</div>
</div>
	<div id="modalReportarItem" class="modal-overlay" style="display:none; z-index: 30000;">
    <div class="modal-content" style="max-width: 600px;">
        <h3 style="color: #800020;"><i class="fas fa-exclamation-triangle"></i> Reportar Problemas nos Itens</h3>
        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Selecione os itens danificados e descreva o que houve com cada um:</p>
        
        <div id="lista-itens-reporte" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa;">
        </div>

        <div class="form-group" style="margin-top: 15px; text-align: left;">
            <label style="font-weight: bold; color: #800020; font-size: 0.9em;"><i class="fas fa-user-shield"></i> Enviar para anÃ¡lise do Gestor:</label>
            <select id="select-gestor-alvo" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #800020; background: #fff5f5; font-weight: bold; margin-top: 5px;">
                <option value="" disabled selected>Buscando gestores da unidade...</option>
            </select>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="btn-modern-action" style="background-color: #f57c00;" onclick="salvarRelatosMultiplos()">
                <i class="fas fa-paper-plane"></i> Enviar PendÃªncias ao Gestor
            </button>
            <button class="modal-btn-cancel" onclick="fecharModalReporte()">Cancelar</button>
        </div>
    </div>
</div>

<div id="modalDecisaoGestor" class="modal-overlay" style="display:none; z-index: 30005;">
    <div class="modal-content" style="max-width: 500px; border-top: 5px solid #f57c00;">
        <h3 style="color: #800020;"><i class="fas fa-gavel"></i> DecisÃ£o do Gestor</h3>
        <p id="info-item-decisao" style="background: #f9f9f9; padding: 10px; border-radius: 5px; font-size: 0.9em; text-align: left; border: 1px solid #eee;"></p>

        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <button class="btn-modern-action" style="background-color: #1b8a3e; justify-content: flex-start; padding: 15px; height: auto;" onclick="prepararSubstituicaoFisica()">
                <i class="fas fa-sync-alt"></i> 
                <div style="text-align: left; margin-left: 10px;">
                    <b>Substituir Material</b><br>
                    <small style="text-transform: none; font-weight: normal; opacity: 0.9;">Retira item novo do estoque e recebe o danificado.</small>
                </div>
            </button>

            <button class="btn-modern-action" style="background-color: #5d6d7e; justify-content: flex-start; padding: 15px; height: auto;" onclick="executarRecolhimentoApenas()">
                <i class="fas fa-arrow-down"></i> 
                <div style="text-align: left; margin-left: 10px;">
                    <b>Apenas Recolher (Baixa)</b><br>
                    <small style="text-transform: none; font-weight: normal; opacity: 0.9;">Recebe o item danificado e reduz a carga da cautela.</small>
                </div>
            </button>

            <button class="modal-btn-cancel" onclick="document.getElementById('modalDecisaoGestor').style.display='none'" style="margin-top: 10px;">Cancelar</button>
        </div>
    </div>
</div>

<div id="modalSeletorEstoque" class="modal-overlay" style="display:none; z-index: 30006;">
    <div class="modal-content" style="max-width: 600px; border-top: 5px solid #1b8a3e;">
        <h3 style="color: #1b8a3e;"><i class="fas fa-search-location"></i> Selecionar Item de ReposiÃ§Ã£o</h3>
        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
            Buscando itens do mesmo tipo disponÃ­veis em todas as suas listas.
        </p>

        <div id="listaEstoqueDisponivel" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; padding: 5px;">
            <div style="text-align: center; color: #999; padding: 20px;">
                Carregando estoque disponÃ­vel...
            </div>
        </div>

        <button class="modal-btn-cancel" onclick="document.getElementById('modalSeletorEstoque').style.display='none'" style="margin-top: 20px; width: 100%;">Fechar</button>
    </div>
</div>
	<div id="modal-detalhe-carimbos" class="modal-overlay" style="display:none; z-index: 30007;">
    <div class="modal-content" style="max-width: 500px; border-top: 5px solid #5d6d7e;">
        <button class="close-btn" onclick="document.getElementById('modal-detalhe-carimbos').style.display='none'"><i class="fas fa-times"></i></button>
        <h3 id="titulo-modal-carimbo" style="margin-bottom: 15px; color: #800020;">Detalhes do Item</h3>
        <div id="corpo-modal-carimbo" style="max-height: 400px; overflow-y: auto; padding: 5px;">
            </div>
        <div style="margin-top: 20px; text-align: right;">
            <button class="btn-secondary" onclick="document.getElementById('modal-detalhe-carimbos').style.display='none'">Fechar Janela</button>
        </div>
    </div>
</div>
	<div id="modal-cadastro-global" class="modal-overlay" style="display:none; z-index: 31000;">
    <div class="modal-content" style="max-width: 700px; border-top: 5px solid #800020;">
        <button class="close-btn" onclick="fecharModalCadastroGlobal()"><i class="fas fa-times"></i></button>
        
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
            <i class="fas fa-plus-square" style="font-size: 2em; color: #800020;"></i>
            <div>
                <h2 style="margin:0; color: #800020;">Novo Cadastro Global</h2>
                <small style="color: #666;">DefiniÃ§Ã£o de identidade e DNA logÃ­stico do material para toda a corporaÃ§Ã£o.</small>
            </div>
        </div>

        <div class="tabs-cadastro" style="display: flex; gap: 5px; margin-bottom: 20px;">
            <button class="btn-tab active" onclick="switchTabCadastro('identificacao')">1. IdentificaÃ§Ã£o</button>
            <button class="btn-tab" onclick="switchTabCadastro('logistica')">2. Regras LogÃ­sticas</button>
            <button class="btn-tab" onclick="switchTabCadastro('composicao')">3. ComposiÃ§Ã£o (Kit)</button>
        </div>

        <form id="form-cadastro-global">
            <div id="tab-identificacao" class="tab-content-cadastro">
                <div class="form-grid-2-columns">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Nome TÃ©cnico (PadrÃ£o Patrimonial/NF)</label>
                        <input type="text" id="cat-nome-tecnico" placeholder="Ex: Equipamento de ProteÃ§Ã£o RespiratÃ³ria AutÃ´nomo" required>
                    </div>
                    <div class="form-group">
                        <label>Sigla / Nome Comum</label>
                        <input type="text" id="cat-sigla" placeholder="Ex: EPRA">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="cat-categoria" required>
                            <option value="" disabled selected>Selecione...</option>
                            <option value="Combate a IncÃªndio">Combate a IncÃªndio</option>
                            <option value="Salvamento Terrestre">Salvamento Terrestre</option>
                            <option value="Salvamento em Altura">Salvamento em Altura</option>
                            <option value="Salvamento AquÃ¡tico">Salvamento AquÃ¡tico</option>
                            <option value="APH">APH (Atendimento PrÃ©-Hospitalar)</option>
                            <option value="Equipamentos Gerais">Equipamentos Gerais</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Marca Sugerida</label>
                        <input type="text" id="cat-marca" placeholder="Ex: Scott, MSA, DrÃ¤ger">
                    </div>
                    <div class="form-group">
                        <label>Modelo Sugerido</label>
                        <input type="text" id="cat-modelo" placeholder="Ex: Air-Pak 75i">
                    </div>
                </div>
            </div>

            <div id="tab-logistica" class="tab-content-cadastro" style="display:none;">
                <div class="form-grid-2-columns">
                    <div class="form-group">
                        <label>Tipo de Controle (DNA do Ativo)</label>
                        <div style="display: flex; gap: 15px; margin-top: 8px;">
                            <label style="font-weight: normal;"><input type="radio" name="cat-tipo" value="single" checked> Single (Quantidade)</label>
                            <label style="font-weight: normal;"><input type="radio" name="cat-tipo" value="multi"> Multi (Tombamento)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Unidade de Medida</label>
                        <select id="cat-unidade-medida">
                            <option value="Unidade">Unidade</option>
                            <option value="Par">Par</option>
                            <option value="Conjunto">Conjunto</option>
                            <option value="Rolo">Rolo</option>
                            <option value="Litro">Litro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Exige InspeÃ§Ã£o PeriÃ³dica?</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="checkbox" id="cat-has-inspecao" style="width: auto;">
                            <span>Sim, a cada <input type="number" id="cat-dias-inspecao" style="width: 60px; display: inline;" placeholder="365"> dias.</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Controlar Validade?</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="checkbox" id="cat-has-validade" style="width: auto;">
                            <span>Sim (Ex: Filtros, Medicamentos, Cordas)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-composicao" class="tab-content-cadastro" style="display:none;">
                <div class="form-group">
                    <label>Este item Ã© um AnfitriÃ£o de Kit?</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                        <input type="checkbox" id="cat-is-kit" style="width: auto;">
                        <span>Sim, ele permite acoplar outros componentes (Ex: Suporte de EPR).</span>
                    </div>
                </div>
                <div id="area-selecao-componentes" style="display:none; margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px dashed #ccc;">
                    <label>Defina os componentes padrÃ£o do Kit:</label>
                    <p style="font-size: 0.8em; color: #666; margin-bottom: 10px;">Estes itens serÃ£o sugeridos automaticamente ao movimentar este kit.</p>
                    <div id="lista-componentes-selecionados"></div>
                    <button type="button" class="btn-secondary" style="font-size: 0.8em;" disabled>+ Adicionar do CatÃ¡logo (Em breve)</button>
                </div>
            </div>
        </form>

        <div class="modal-buttons" style="margin-top: 30px;">
            <button type="button" class="btn-modern-action btn-backup" onclick="fecharModalCadastroGlobal()">Cancelar</button>
            <button type="button" class="btn-modern-action btn-sync" onclick="salvarCadastroGlobal()"><i class="fas fa-save"></i> Finalizar Cadastro Global</button>
        </div>
    </div>
</div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        
        function openNewConferenceModal() {
        document.getElementById('modal-nova-conferencia').style.display = 'flex';
        }
        // Constantes Globais
        const COLECAO_RESULTADOS = 'resultados_conferencias';
        const COLECAO_LISTAS = 'listas_conferencia';

        // VariÃ¡veis Globais
        let currentUserData = null;
        let allLists = [];
        let allUsersData = [];
        let allTargetUsers = [];
        let dadosConferencia = []; // Para o editor
        let currentEditingId = null;
        let conferente = '';
        let userCache = {};
		let cautelaItensSelecionados = [];
		let cautelaIdAtualParaReporte = '';
		let itensDaCautelaAtual = [];
		let pendenciaSendoResolvida = null
		let cachePendenciasCautela = [];

        // --- 1. AUTH & PERMISSÃ•ES ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection('usuarios').doc(user.uid).get();
                    if (doc.exists) {
                        currentUserData = doc.data();
                        conferente = currentUserData.nome_militar_completo;
                        setupUIBasedOnRole();
                    } else {
                        alert("UsuÃ¡rio sem registro no banco."); 
                        window.location.href = 'index.html';
                    }
                } catch (e) { 
                    console.error(e); 
                }
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        function setupUIBasedOnRole() {
Â  Â  const role = currentUserData.role || 'operacional';
Â  Â  const unit = currentUserData.unidade || 'N/D';
// --- CORREÃ‡ÃƒO DE SEGURANÃ‡A NA LINHA 301 ---
Â  Â  const roleDisplay = document.getElementById('user-role-display');
// Verifica se o elemento existe antes de tentar definir o texto
Â  Â  if (roleDisplay) {Â 
Â  Â  Â  Â  roleDisplay.textContent = `${role.toUpperCase()} - ${unit}`;
}
Â  Â  // ------------------------------------------

Â  Â  atualizarSaudacao(currentUserData);
// --- 1. Definindo as PermissÃµes Reais de Acesso ---
Â  Â  const p = currentUserData.permissoes || {};
// Objeto de PermissÃµes
Â  Â  const isGestorOuAdmin = (role === 'gestor' || role === 'admin');
Â  Â  const canViewAdminTools = role === 'admin';
Â  Â  const canViewDashboardCards = role === 'admin' ||
Â  Â  (isGestorOuAdmin && p.canViewDashboardCards);
Â  Â  const canViewUnitHistory = role === 'admin' || (isGestorOuAdmin && p.canViewUnitHistory);
Â  Â  const canManageUnits = role === 'admin';
// Assume que Gerenciamento de Unidades Ã© Admin-Only
Â  Â  const canManagePosts = role === 'admin' ||
(isGestorOuAdmin && p.canManagePosts);
Â  Â  const canManageUnitUsers = role === 'admin' || (isGestorOuAdmin && p.canManageUnitUsers);
Â  Â  const canManageUnitLists = role === 'admin' ||
(isGestorOuAdmin && p.canManageUnitLists);
// --- 2. AplicaÃ§Ã£o das RestriÃ§Ãµes na UI (Corrigida e Segura) ---
Â  Â Â 
Â  Â  // Reseta visibilidade dos links de Admin.
Â  Â  document.querySelectorAll('.restricted-admin-only').forEach(el => {
Â  Â  Â  Â  if(el) el.style.display = 'block';
Â  Â  });
// Oculta o RÃ³tulo e Links de Admin se for Operacional
Â  Â  if (role === 'operacional') {
        renderOperacionalCards();
 } else {
        // Para Admin e Gestor
        renderAdminGestorCards(canViewDashboardCards);
        // âœ… CORREÃ‡ÃƒO: Removido carregarConferenciasHoje() para evitar TypeError: Cannot set properties of null
    }

Â  Â  // --- 2.1 Ajuste Fino dos Links de GestÃ£o (para Gestores e Admin) ---
Â  Â Â 
Â  Â  if (!canManageUnits) {Â 
Â  Â  Â  Â  const linkUnidades = document.getElementById('link-unidades');
Â  Â  Â  Â  if(linkUnidades) linkUnidades.style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  if (!canManagePosts) {Â 
Â  Â  Â  Â  const linkPostos = document.getElementById('link-postos');
Â  Â  Â  Â  if(linkPostos) linkPostos.style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  if (!canManageUnitUsers) {Â 
Â  Â  Â  Â  const linkUsuarios = document.getElementById('link-usuarios');
Â  Â  Â  Â  if(linkUsuarios) linkUsuarios.style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  if (!canManageUnitLists) {Â 
Â  Â  Â  Â  const linkListas = document.getElementById('link-listas');
Â  Â  Â  Â  if(linkListas) linkListas.style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  // Oculta o HistÃ³rico Global se a permissÃ£o nÃ£o estiver marcada
Â  Â  const globalHistoryLink = document.getElementById('link-global-history');
Â  Â  if (!canViewUnitHistory && globalHistoryLink) {
Â  Â  Â  Â  globalHistoryLink.style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  // Ocultar RÃ³tulo Admin se nÃ£o sobrou nenhum link
Â  Â  const adminLinks = ['link-unidades', 'link-postos', 'link-usuarios', 'link-listas'];
Â  Â  const anyAdminLinkVisible = adminLinks.some(id => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  return el && el.style.display !== 'none';
Â  Â  });
Â  Â  const rotuloAdmin = document.getElementById('sidebar-rotulo-admin');
Â  Â  if (!anyAdminLinkVisible && rotuloAdmin) {
Â  Â  Â  Â  rotuloAdmin.style.display = 'none';
Â  Â  }

    // --- 3. Chamadas de Dados Comuns (Manter) ---
    carregarListasParaNovaConferencia(); // Preenche o modal "Iniciar ConferÃªncia"
    
Â  Â  // ===================================
Â  Â  // SOLUÃ‡ÃƒO PARA INICIAR O MENU FECHADO
Â  Â  // ===================================
Â  Â  closeMenuMobile();
// --- Trava do BotÃ£o Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o botÃ£o Voltar do navegador
        history.pushState(null, null, location.href);
    }
    // ----------------------------------------------

Â  Â  // Garante que a visÃ£o seja o dashboard ao logar
Â  Â  switchView('dashboard');
    setupMasksForModal();       
}
        /**
 * Adiciona listeners de formataÃ§Ã£o (mÃ¡scara) aos inputs do modal Gerenciar Militar.
 */
function setupMasksForModal() {
    const cpfInput = document.getElementById('edit-user-cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
        // Aplica a mÃ¡scara imediatamente para valores preenchidos na abertura do modal
        formatarCPF(cpfInput); 
    }
    
    const matriculaInput = document.getElementById('edit-user-matricula');
    if (matriculaInput) {
        matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
        formatarMatricula(matriculaInput);
    }
    
    const telefoneInput = document.getElementById('edit-user-telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));
        formatarTelefone(telefoneInput);
    }
}
            // --- NOVO: Cards EspecÃ­ficos para Operacional ---
function renderOperacionalCards() {
    const container = document.getElementById('operacional-cards-container');
    if (!container) return;
    
    // Esconde o container de Admin/Gestor se existir
    const adminContainer = document.getElementById('admin-gestor-cards-container');
    if(adminContainer) adminContainer.style.display = 'none';

    container.innerHTML = `
        
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-calendar-day"></i> ConferÃªncias Realizadas Hoje (Minhas)</h2>
            <ul id="today-list" class="history-list">
                <li style="text-align:center; color:#999; padding:20px;">Carregando...</li>
            </ul>
        </div>

    
        <div class="op-card history" style="margin-top: 25px;">
            <h2 class="op-card-title" style="margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> Dashboard Operacional</h2>
            <div class="cards-grid">
                
                <div class="sector-card status-ok" onclick="switchView('my-history')">
                    <h3>Minhas ConferÃªncias</h3>
    
                    <div class="main-stat">
                        <span class="count-value" id="op-conf-count">0</span>
                        <i class="fas fa-history fa-2x" style="color:#1b8a3e;"></i>
                    </div>
         
                    <div class="card-footer">
                        Clique para ver o histÃ³rico completo.
                    </div>
                </div>
                <div class="sector-card status-unit" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas Ativas');">
                    <h3>Minhas Cautelas Ativas</h3>
                    <div class="main-stat">
              
                    <span class="count-value" id="op-my-active-cautela-count">0</span>
                        <i class="fas fa-shield-alt fa-2x" style="color:#2c7399;"></i>
                </div>
                <div class="card-footer">
                    
                    Itens que estÃ£o sob sua cautela.
                </div>
            </div>

                <div class="sector-card status-posto" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas a Receber');">
                    <h3>Cautelas a Receber</h3>
                    <div class="main-stat">
            
                        <span class="count-value" id="op-cautela-receive-count">0</span>
                        <i class="fas fa-box-open fa-2x" style="color:#8e44ad;"></i>
                    </div>
                    <div class="card-footer">
                  
                        Itens pendentes de recebimento/transferÃªncia.
                    </div>
                </div>
                
            </div>
        </div>
    `;
    
    // [NOVO] Adicionar lÃ³gica para atualizar a contagem de conferÃªncias hoje no card
    updateOperacionalCards();
    container.style.display = 'block';
}
// [NOVO] Atualiza a contagem do Card "Minhas ConferÃªncias"
async function getCautelasAReceberCount() {
    if (!currentUserData) return 0;
    const militarUid = firebase.auth().currentUser.uid;

    try {
        // Cautelas NOVAS (Alvo Original)
        const snapNovas = await db.collection('cautelas_abertas')
            .where('destinatario_original_uid', '==', militarUid)
            .where('status', '==', 'ABERTA')
            .get();

        // DEVOLUÃ‡Ã•ES para conferir (DestinatÃ¡rio Atual)
        const snapDevolucoes = await db.collection('cautelas_abertas')
            .where('destinatario_uid', '==', militarUid)
            .where('status', '==', 'DEVOLUÃ‡ÃƒO')
            .get();

        // Usamos um Set para garantir que se uma cautela cair em ambos, conte apenas uma vez
        const totalIds = new Set();
        snapNovas.forEach(doc => totalIds.add(doc.id));
        snapDevolucoes.forEach(doc => totalIds.add(doc.id));

        return totalIds.size;
    } catch (e) {
        console.error("Erro ao contar cautelas:", e);
        return 0;
    }
}
       /**
 * Busca e retorna a contagem de cautelas ativas/recebidas do militar logado,
 * incluindo as que estÃ£o EM DEVOLUÃ‡ÃƒO (enviadas por ele).
 */
/**
 * Calcula a contagem total e desduplicada de cautelas ativas para o dashboard,
 * respeitando os filtros de perfil (Operacional, Gestor, Admin).
 */
async function countActiveCautelas() {
    if (!currentUserData || !currentUserData.nome_militar_completo) return 0;
    
    const role = currentUserData.role;
    const user = currentUserData;
    
    // Conjunto para garantir que cada Cautela ID seja contada apenas uma vez
    const countedIds = new Set();
    
    // --- 1. BUSCAS PARA OPERACIONAL / GESTOR (Regras Pessoais) ---
    if (role === 'operacional' || role === 'gestor') {
        
        // A. CUSTÃ“DIA ATIVA + RASTREIO DE DEVOLUÃ‡ÃƒO (RECEBIDA como destinatÃ¡rio OU DEVOLUÃ‡ÃƒO como reversor)
        // Usaremos duas queries separadas e depois desduplicaremos para garantir a contagem.
        
        // CUSTÃ“DIA ATIVA (RECEBIDA)
        const custodiaRecebida = await queryCautelas(['RECEBIDA'], role, user, 'destinatario', 'personal');
        custodiaRecebida.forEach(c => countedIds.add(c.cautela_id));
        
        // RASTREIO DE RESPONSABILIDADE (DEVOLUÃ‡ÃƒO como Reversor)
        const devolucaoRastreio = await queryCautelas(['DEVOLUÃ‡ÃƒO'], role, user, 'militar_completo_reversor', 'personal');
        devolucaoRastreio.forEach(c => countedIds.add(c.cautela_id));

        // B. RASTREIO PESSOAL (ABERTA, RECEBIDA, DEVOLUÃ‡ÃƒO como Emitente)
        const rastreioEmitente = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÃ‡ÃƒO'], role, user, 'emitente', 'personal');
        rastreioEmitente.forEach(c => countedIds.add(c.cautela_id));
    }
    
    // --- 2. BUSCAS PARA GESTOR / ADMIN (Regras Gerenciais de Monitoramento) ---
    if (role === 'gestor' || role === 'admin') {
        
        // MONITORAMENTO: ABERTA, RECEBIDA, DEVOLUÃ‡ÃƒO (Filtro por Unidade ou Global)
        const monitoramentoRaw = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÃ‡ÃƒO'], role, user, null, 'unit');

        // Adiciona todos os IDs de monitoramento no Set (ele cuida da desduplicaÃ§Ã£o)
        monitoramentoRaw.forEach(c => countedIds.add(c.cautela_id));
    }

    // O tamanho do Set Ã© a contagem total desduplicada de todas as cautelas ativas
    return countedIds.size;
}
// LocalizaÃ§Ã£o: Linha ~2792
async function updateOperacionalCards() {
    const ul = document.getElementById('today-list');
    const countEl = document.getElementById('op-conf-count');
    const cautelaReceiveCountEl = document.getElementById('op-cautela-receive-count');
    const myActiveCautelaCountEl = document.getElementById('op-my-active-cautela-count');
    
    // ğŸ›‘ VILÃƒO 1: ObtÃ©m o UID para todas as consultas relacionadas ao usuÃ¡rio logado
    const conferenteUid = firebase.auth().currentUser.uid;
    if (!conferenteUid || !ul || !countEl || !cautelaReceiveCountEl || !myActiveCautelaCountEl) {
        console.warn("Elemento de card operacional ou UID ausente. Pulando atualizaÃ§Ã£o.");
        return; 
    }
    
    try {
        // --- 1. CONSULTA DE TODAS AS CONFERÃŠNCIAS (SNAP TOTAL) ---
        // ğŸ›‘ CORREÃ‡ÃƒO CRÃTICA: Filtra por conferente_uid (imutÃ¡vel)
        const snapTotal = await db.collection(COLECAO_RESULTADOS)
            .where('conferente_uid', '==', conferenteUid) 
            .orderBy('timestamp', 'desc') // Ordena para pegar os mais recentes
            .get();

        const totalConferences = snapTotal.size; 
        countEl.textContent = totalConferences; 

        // --- 2. CONTAGEM DE CAUTELAS A RECEBER (NOVO) ---
        const totalCautelasAReceber = await getCautelasAReceberCount();
        cautelaReceiveCountEl.textContent = totalCautelasAReceber; 
        
        // --- 3. CONTAR MINHAS CAUTELAS ATIVAS (NOVO) ---
        const totalMyActiveCautelas = await countActiveCautelas();
        myActiveCautelaCountEl.textContent = totalMyActiveCautelas; 
        
        // --- 4. FILTRAGEM PARA CONFERÃŠNCIAS DE HOJE (DO SNAP TOTAL) ---
        const hojeStr = new Date().toLocaleDateString('pt-BR');
        let html = '';
        
        snapTotal.docs.forEach(doc => {
            const data = doc.data();
            const dt = data.timestamp.toDate();
            
            // Filtro de data local (apenas as que caem na data de hoje)
            if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                html += criarItemHistoricoHTML(data);
            }
        });
        
        // Atualiza a lista de hoje
        ul.innerHTML = html ||
        '<li style="padding:15px; text-align:center; color:#999;">Nenhuma conferÃªncia hoje.</li>';
        
    } catch(e) { 
        console.error("Erro ao carregar dados operacionais:", e);
        if(countEl) countEl.textContent = 'Erro';
        if(ul) ul.innerHTML = 'Erro.';
    }
}
        
            // --- NOVO: Cards EspecÃ­ficos para Admin/Gestor ---
// --- NOVO: Cards EspecÃ­ficos para Admin/Gestor ---
function renderAdminGestorCards(canViewDashboardCards) {
    const container = document.getElementById('admin-gestor-cards-container');
    if (!container) return;
    const opContainer = document.getElementById('operacional-cards-container');
    if(opContainer) opContainer.style.display = 'none';
    if (canViewDashboardCards) {
        container.innerHTML = `
            <div id="dash-cards-restricted" class="op-card history" style="padding-top: 15px;">
                <h2 class="op-card-title" style="font-size: 1.2em; margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> PendÃªncias da Unidade
                </h2>
                <div id="loading-message-dashboard">Carregando dados...</div>
                <div id="cards-container" class="cards-grid">
                    </div>
            </div>
        `;
            loadCaaData(); 
            container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
} 
Â  Â  closeMenuMobile();Â 

    // --- Trava do BotÃ£o Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o botÃ£o Voltar do navegador
        history.pushState(null, null, location.href); 
    }
    // ----------------------------------------------

Â  Â  // Garante que a visÃ£o seja o dashboard ao logar
Â  Â  switchView('dashboard');
        
        function atualizarSaudacao(user) {
            const now = new Date();
            const hour = now.getHours();
            let saudacao = "Bom dia";
            if (hour >= 12 && hour < 18) saudacao = "Boa tarde";
            else if (hour >= 18) saudacao = "Boa noite";
            
            const opcoesData = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let dataStr = now.toLocaleDateString('pt-BR', opcoesData);
            dataStr = dataStr.charAt(0).toUpperCase() + dataStr.slice(1);

            document.getElementById('greeting-text').textContent = saudacao + ",";
            document.getElementById('greeting-name').textContent = user.nome_militar_completo || user.nome_guerra;
            document.getElementById('current-date').textContent = dataStr;
            if(user.foto_url) document.getElementById('greeting-photo').src = user.foto_url;
        }
        

        // --- 3. DASHBOARD HIERÃRQUICO ---
        async function loadCaaData() {
    const container = document.getElementById('cards-container');
    if (!container) return;
    container.innerHTML = 'Carregando...';
    const loading = document.getElementById('loading-message-dashboard');
    loading.style.display = 'block';
    
    try {
        await loadCautelaPendencies(); 

        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        
        const snap = await db.collection(COLECAO_RESULTADOS).limit(100).get();
        const map = {}; 
        const docs = [];
        snap.forEach(d => docs.push({id:d.id, ...d.data()}));
        
        docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

        const filteredDocs = docs.filter(d => {
            const listaId = d.lista_id;
            if (!rotas[listaId]) return false;
            const listUnit = rotas[listaId].unidade || 'GERAL';
            if (currentUserData.role === 'gestor' && listUnit !== currentUserData.unidade) return false;
            return true;
        });

        await Promise.all(filteredDocs.map(async (d) => {
            const listaId = d.lista_id;
            if (!map[listaId]) {
                const docMestra = await db.collection(COLECAO_LISTAS).doc(listaId).get();
                let pendenciasReais = [];

                if (docMestra.exists) {
                    const dataMestra = docMestra.data().list || [];
                    
                    // Loop assÃ­ncrono para buscar observaÃ§Ãµes reais das cautelas
                    for (const setor of dataMestra) {
                        for (const it of (setor.itens || [])) {
                            
                            // 1. PENDÃŠNCIAS (Vermelhas)
                            if (it.pendencias_ids && it.pendencias_ids.length > 0) {
                                it.pendencias_ids.forEach(p => pendenciasReais.push({ 
                                    ...p, itemNome: it.nome, itemId: it.id, tipoRegistro: 'PENDENCIA' 
                                }));
                            }

                            // 2. FUNÃ‡ÃƒO AUXILIAR PARA BUSCAR OBSERVAÃ‡ÃƒO REAL NA COLEÃ‡ÃƒO 'cautelas_abertas'
                            const getObsReal = async (cautelaId) => {
                                try {
                                    const cDoc = await db.collection('cautelas_abertas').doc(String(cautelaId)).get();
                                    return cDoc.exists ? cDoc.data().observacoes_emissao : "Material em carga individual.";
                                } catch (err) { return "Material em carga individual."; }
                            };

                            // CAUTELAS - Itens SINGLE
                            if (it.tipo === 'single' && it.cautelas) {
                                for (const c of it.cautelas) {
                                    const obsReal = await getObsReal(c.id);
                                    pendenciasReais.push({
                                        id: c.id, itemNome: it.nome, itemId: it.id,
                                        quantidade: c.quantidade,
                                        autor_nome: c.emitente || "Sistema", 
                                        destinatario: c.destinatario || "Militar",
                                        descricao: obsReal, // <--- BUSCA CIRÃšRGICA NO BANCO
                                        status_gestao: 'CAUTELADO',
                                        tipoRegistro: 'CAUTELA'
                                    });
                                }
                            }

                            // CAUTELAS - Itens MULTI (Tombamentos)
                            if (it.tipo === 'multi' && it.tombamentos) {
                                for (const t of it.tombamentos) {
                                    if (t.pendencias_ids) {
                                        t.pendencias_ids.forEach(p => pendenciasReais.push({ ...p, itemNome: it.nome, tombamento: t.tomb, itemId: it.id, tipoRegistro: 'PENDENCIA' }));
                                    }
                                    if (t.cautela) {
                                        const obsReal = await getObsReal(t.cautela.id);
                                        pendenciasReais.push({
                                            id: t.cautela.id, itemNome: it.nome, tombamento: t.tomb, itemId: it.id,
                                            quantidade: 1,
                                            autor_nome: t.cautela.emitente || "Sistema",
                                            destinatario: t.cautela.destinatario || "Militar",
                                            descricao: obsReal, // <--- BUSCA CIRÃšRGICA NO BANCO
                                            status_gestao: 'CAUTELADO',
                                            tipoRegistro: 'CAUTELA'
                                        });
                                    }
                                }
                            }
                        }
                    }
                }

                map[listaId] = { 
                    docId: d.id, lista_id: listaId, local: d.local, 
                    conferente: d.conferente, date: d.timestamp.toDate().toLocaleString(), 
                    items: pendenciasReais 
                };
            }
        }));
        
        renderCards(map); 
    } catch (e) { 
        console.error("Erro ao carregar CAA Data:", e); 
        container.innerHTML = 'Erro ao carregar.';
    } finally { 
        loading.style.display = 'none';
    }
}
        
       
        async function renderCards(map) {
    const container = document.getElementById('cards-container');
    if (!container) return;
    container.innerHTML = '';
    const keys = Object.keys(map);
    
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    if (keys.length === 0) { 
        container.innerHTML = '<p style="padding:20px;">Nenhuma pendÃªncia encontrada.</p>';
        return;
    }

    const groupedCards = {};
    keys.forEach(listaId => {
        const d = map[listaId];
        const unit = rotas[listaId]?.unidade || 'GERAL'; 
        if (!groupedCards[unit]) groupedCards[unit] = [];
        groupedCards[unit].push(d);
    });

    const sortedUnits = Object.keys(groupedCards).sort();
    sortedUnits.forEach(unit => {
        const unitHeader = document.createElement('h3');
        unitHeader.className = 'unit-header';
        unitHeader.style.cssText = 'display: block; width: 100%; color: #800020; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; box-sizing: border-box; font-size: 1.2em;'; 
        unitHeader.innerHTML = `<div class="unit-flex-title"><i class="fas fa-building"></i> <span>${unit}</span></div>`;
        container.appendChild(unitHeader); 
        
        const cardsList = groupedCards[unit];
        cardsList.forEach(d => {
            const allItems = d.items || [];
            const countTotal = allItems.length;
            const temAlteracao = countTotal > 0;
            
            const div = document.createElement('div');
            div.className = `sector-card ${temAlteracao ? 'status-alert' : 'status-ok'}`;
            
            div.innerHTML = `
                <h3>${d.local}</h3>
                <div class="main-stat">
                    <span class="count-value" style="color: ${temAlteracao ? '#d90f23' : '#1b8a3e'}">
                        ${countTotal === 0 ? 'OK' : countTotal}
                    </span>
                    <i class="fas ${temAlteracao ? 'fa-exclamation-triangle' : 'fa-check-circle'}" 
                       style="color: ${temAlteracao ? '#d90f23' : '#1b8a3e'}; opacity:0.2; font-size: 1.5em;"></i>
                </div>
                <div class="card-footer">
                    <strong>Ãšltima Conf.: ${d.conferente}</strong><br>${d.date}
                </div>
            `;
            div.onclick = () => mostrarTabela(d);
            container.appendChild(div);
        });
    });
}
        // --- 4. NOVA CONFERÃŠNCIA ---
        async function carregarListasParaNovaConferencia() {
            try {
                const doc = await db.collection('config_geral').doc('rotas').get();
                const rotas = doc.data();
                allLists = []; 
                const setores = new Set();
                
                Object.entries(rotas).forEach(([id, info]) => {
                    if (info.ativo !== false && id !== 'ABT-17' && id !== 'ABT-18' && id.indexOf('bravo 5') === -1) {
                        allLists.push({ id: id, nome: info.nome, setor: info.posto });
                        setores.add(info.posto);
                    }
                });
                
                const sel = document.getElementById('dash-select-setor');
                sel.innerHTML = '<option value="" disabled selected>Selecione o Setor...</option>';
                
                Array.from(setores).sort().forEach(s => {
                    const opt = document.createElement('option'); 
                    opt.value = s; 
                    opt.textContent = s; 
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        function filtrarListasDashboard() {
            const setor = document.getElementById('dash-select-setor').value;
            const selLista = document.getElementById('dash-select-lista');
            selLista.innerHTML = '<option value="" disabled selected>Selecione a Lista...</option>'; 
            selLista.disabled = false;
            
            const fil = allLists.filter(l => l.setor === setor).sort((a,b)=>a.nome.localeCompare(b.nome));
            fil.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l.id; 
                o.textContent = l.nome; 
                selLista.appendChild(o); 
            });
            selLista.focus();
        }

        function focarBotaoIniciar() { 
            document.getElementById('btn-start-dash').focus();
        }

        // LocalizaÃ§Ã£o: Linha ~1353
function iniciarConferenciaDashboard() {
    const listaId = document.getElementById('dash-select-lista').value;
    const listaSelect = document.getElementById('dash-select-lista');
    const nomeLista = listaSelect.options[listaSelect.selectedIndex].text;
    
    if(!listaId) return alert("Selecione uma lista.");
    
    // --- VariÃ¡veis CrÃ­ticas (UID e Nome para Rascunho) ---
    // ğŸ›‘ NOVO: UID do militar logado
    const userUid = firebase.auth().currentUser.uid;
    // Define o nome de guerra em MAIÃšSCULAS para consistÃªncia na chave do rascunho.
    const userForDraft = (currentUserData.nome_guerra || 'ND').toUpperCase();
    
    // ConstrÃ³i a URL com o user padronizado (para leitura no app)
    // ğŸ›‘ ATUALIZAÃ‡ÃƒO DA URL: INCLUI user_uid
    const url = `conferencia_app.html?id=${listaId}&posto_grad=${encodeURIComponent(currentUserData.posto)}&quadro_mil=${encodeURIComponent(currentUserData.quadro)}&nome_guerra=${encodeURIComponent(userForDraft)}&user_uid=${userUid}`;
    
    // Salva para resume
    localStorage.setItem('sigma_active_conf', JSON.stringify({
        id: listaId, 
        nomeLista: nomeLista, 
        user: userForDraft, // Nome de guerra (CHAVE ANTIGA)
        user_uid: userUid, // ğŸ›‘ NOVO: CHAVE IMUTÃVEL
        url: url
    }));
    
    document.getElementById('modal-nova-conferencia').style.display = 'none';
    
    // --- LÃ“GICA DE ABERTURA DO IFRAME ---
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    iframe.src = url; 
    container.style.display = 'block';
}

window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'SIGMA_FINISHED') {
        // ğŸ›‘ LÃ³gica para fechar o iframe e liberar recursos
        document.getElementById('app-runner-container').style.display = 'none';
        
        // Garante que o iframe limpe a memÃ³ria
        const iframe = document.getElementById('app-iframe');
        if (iframe) iframe.src = "about:blank"; 
        

        // ğŸ›‘ Chamadas de atualizaÃ§Ã£o do Dashboard (Agora Null-Safe)
        if (typeof loadCaaData === 'function') loadCaaData();
        if (typeof carregarConferenciasHoje === 'function') carregarConferenciasHoje();
        if (typeof updateOperacionalCards === 'function') updateOperacionalCards();

        alert("ConferÃªncia salva!");
    }
});        
        // --- 5. HISTÃ“RICOS ---
        async function carregarConferenciasHoje() {
    // ğŸ›‘ CHAMA A FUNÃ‡ÃƒO UNIFICADA QUE JÃ ATUALIZA TODOS OS CARDS E A LISTA DE HOJE
    // Isso garante que a lÃ³gica de filtro UID/Data seja sempre a mesma.
    await updateOperacionalCards(); 
}
	async function loadMyHistory() {
    const ul = document.getElementById('my-history-list');
    const conferenteUid = firebase.auth().currentUser.uid;
    
    if (!ul || !conferenteUid) return;

    ul.innerHTML = '<li>Buscando...</li>';
    
    // 1. Cria objetos Date dos campos de input, garantindo o inÃ­cio e fim do dia
    const startDateInput = document.getElementById('my-hist-start').value;
    const endDateInput = document.getElementById('my-hist-end').value;

    if (!startDateInput || !endDateInput) {
        ul.innerHTML = '<li>Selecione as datas para filtrar.</li>';
        return;
    }

    // 2. Cria Timestamps para filtro do Firestore
    const dI = new Date(startDateInput + 'T00:00:00'); 
    const dF = new Date(endDateInput + 'T23:59:59'); 

    const startTimestamp = firebase.firestore.Timestamp.fromDate(dI);
    const endTimestamp = firebase.firestore.Timestamp.fromDate(dF);

    try {
        // ğŸ›‘ CORREÃ‡ÃƒO CRÃTICA: Filtra por conferente_uid
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('conferente_uid', '==', conferenteUid) 
            .where('timestamp', '>=', startTimestamp) // Data de inÃ­cio
            .where('timestamp', '<=', endTimestamp)    // Data de fim
            .orderBy('timestamp', 'desc') // Ordena (necessÃ¡rio ao usar where em timestamp)
            .limit(100)
            .get();
            
        let docs = [];
        snap.forEach(doc => docs.push(doc.data()));

        let html = '';
        docs.forEach(d => {
            html += criarItemHistoricoHTML(d);
        });
        
        ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nada encontrado no perÃ­odo selecionado.</li>';
        
    } catch(e){ 
        console.error("Erro no loadMyHistory:", e);
        ul.innerHTML='<li>Erro ao carregar histÃ³rico.</li>';
    }
}
	async function loadGlobalHistory() {
    const ul = document.getElementById('global-history-list');
    const localFilter = document.getElementById('glob-hist-local').value;
    const conferenteFilter = document.getElementById('glob-hist-user').value; // Valor do Conferente (Nome Completo)
    
    if (!ul) return;

    ul.innerHTML = '<li>Buscando...</li>';
    
    // Captura o valor dos filtros
    const dI = new Date(document.getElementById('glob-hist-start').value + 'T00:00:00');
    const dF = new Date(document.getElementById('glob-hist-end').value + 'T23:59:59');

    try {
        // 1. Inicia a consulta com os filtros de data (obrigatÃ³rio para orderBy)
        let queryRef = db.collection(COLECAO_RESULTADOS)
            .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(dI))
            .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(dF))
            .orderBy('timestamp', 'desc');

        // 2. CORREÃ‡ÃƒO: Aplica o filtro 'where' se um Conferente especÃ­fico for selecionado (Usa o nome, pois o filtro Ã© baseado no nome)
        if (conferenteFilter) {
            // Nota: Este filtro usarÃ¡ o nome completo, o que pode causar problemas se o militar for promovido *APÃ“S* a conferÃªncia.
            // Para relatÃ³rios globais, geralmente se aceita o nome exato da conferÃªncia.
            queryRef = queryRef.where('conferente', '==', conferenteFilter);
        }

        const snap = await queryRef.limit(100).get();
        
        // Carrega o mapeamento de Unidades (necessÃ¡rio para o filtro de Gestor)
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const listToUnitMap = {};
        Object.keys(rotas).forEach(key => listToUnitMap[rotas[key].nome] = rotas[key].unidade || 'GERAL');

        let docs = [];
        snap.forEach(d => docs.push(d.data()));

        let html = '';
        docs.forEach(d => {
            const localNome = d.local.split(' - ')[1] || d.local;
            const unit = listToUnitMap[localNome] || 'GERAL';

            // Filtro de seguranÃ§a (Gestor)
            if(currentUserData.role === 'gestor' && unit !== currentUserData.unidade) return; 
            
            // Filtro Local: sÃ³ aplica na memÃ³ria se for necessÃ¡rio
            if(!localFilter || localNome === localFilter) {
                html += criarItemHistoricoHTML(d);
            }
        });

        ul.innerHTML = html || '<li>Nada encontrado.</li>';
    } catch(e){ 
        console.error("Erro ao carregar histÃ³rico global:", e);
        ul.innerHTML='Erro ao carregar histÃ³rico.';
    }
}
       function criarItemHistoricoHTML(data) {
    const dataHora = data.timestamp.toDate().toLocaleString('pt-BR');
    const temAlteracao = (data.itensRelatorio && data.itensRelatorio.some(i => i.status !== 'S/A')) || (!data.itensRelatorio && data.totalCaa > 0);
    
    // Codificamos o objeto para evitar que aspas no texto (ex: observaÃ§Ãµes) quebrem o HTML
    const dataSegura = encodeURIComponent(JSON.stringify(data));

    return `<li class="history-item">
                <div class="hist-info">
                    <strong>${data.local}</strong>
                    <small>${data.conferente} â€¢ ${dataHora}</small>
                </div>
                <div style="display:flex;align-items:center;">
                    <span class="hist-status ${temAlteracao ? 'status-alert' : 'status-ok'}">${temAlteracao ? 'C/A' : 'S/A'}</span>
                    
                    <button class="btn-reprint" onclick="reimprimirPDF(JSON.parse(decodeURIComponent('${dataSegura}')))">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                </div>
            </li>`;
}
        // --- 6. GESTÃƒO DE UNIDADES (ADMIN) ---
        async function carregarUnidadesVisuais() {
    const container = document.getElementById('units-cards-container');
    container.innerHTML = 'Carregando...';
    
    // --- VariÃ¡veis de RestriÃ§Ã£o ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // -----------------------------
    
    try {
        const unitsDoc = await db.collection('config_geral').doc('unidades').get();
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const unidades = unitsDoc.data().lista || [];
        const rotas = rotasDoc.data() || {};

        container.innerHTML = '';
        unidades.forEach(u => {
            const listsInUnit = Object.values(rotas).filter(r => r.unidade === u).map(r => r.nome);
            const card = document.createElement('div');
            card.className = 'sector-card status-unit';
            card.innerHTML = `<h3>${u}</h3><div class="card-footer"><strong>ContÃ©m:</strong><ul class="sub-list-preview">${listsInUnit.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
            card.onclick = () => abrirGestaoUnidade(u, rotas);
            container.appendChild(card);
        });

        // --- NOVO: FILTRAGEM DOS LOCAIS PARA O SELECT DO HISTÃ“RICO GLOBAL ---
        const sel = document.getElementById('glob-hist-local');
        // Garante que o elemento existe e reseta com a opÃ§Ã£o "Todos"
        if(sel) sel.innerHTML = '<option value="">Todos</option>'; 
        
        if(sel) {
            // 1. Mapeia todas as rotas (viaturas/listas) ativas
            let locaisFiltrados = Object.values(rotas)
                .filter(r => r.ativo !== false) 
                // 2. Aplica a restriÃ§Ã£o: Se for gestor, sÃ³ mostra as rotas da sua unidade.
                .filter(r => !isGestor || r.unidade === unidadeGestor) 
                .map(r => r.nome); 

            // 3. Remove duplicatas e ordena
            const locaisUnicos = [...new Set(locaisFiltrados)].sort();
            
            locaisUnicos.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l; 
                o.text = l; 
                sel.appendChild(o); 
            });
        }
    } catch(e){ 
        console.error("Erro ao carregar unidades visuais:", e);
        container.innerHTML='Erro ao carregar dados.';
    }
}
        function abrirGestaoUnidade(unitName, allRotas) {
            document.getElementById('edit-unit-original-name').value = unitName;
            document.getElementById('edit-unit-name-input').value = unitName;
            const checklist = document.getElementById('unit-lists-checklist');
            checklist.innerHTML = '';
            
            Object.entries(allRotas).forEach(([id, r]) => {
                if(r.ativo === false) return;
                const div = document.createElement('div');
                div.className = 'checklist-item';
                const isChecked = (r.unidade === unitName) ? 'checked' : '';
                
                div.innerHTML = `<input type="checkbox" id="chk-${id}" ${isChecked} value="${id}"> <label for="chk-${id}" style="margin:0;font-weight:normal;">${r.nome} (${r.posto})</label>`;
                checklist.appendChild(div);
            });
            document.getElementById('modal-unit-manager').style.display = 'flex';
        }

        async function salvarAlteracoesUnidade() {
            const oldName = document.getElementById('edit-unit-original-name').value;
            const newName = document.getElementById('edit-unit-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome invÃ¡lido");
            
            try {
                const unitsRef = db.collection('config_geral').doc('unidades');
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#unit-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    if (chk.checked) {
                        rotasData[id].unidade = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: newName });
                    } else if (rotasData[id].unidade === oldName) {
                        rotasData[id].unidade = null; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: null });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!"); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirUnidade() {
            const name = document.getElementById('edit-unit-original-name').value;
            if(!confirm(`Excluir a unidade ${name}? As listas perderÃ£o o vÃ­nculo.`)) return;
            
            try {
                await db.collection('config_geral').doc('unidades').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const s = await rotasRef.get(); 
                const d = s.data();
                
                Object.keys(d).forEach(k => { 
                    if(d[k].unidade === name) d[k].unidade = null; 
                });
                
                await rotasRef.set(d);
                alert("ExcluÃ­do."); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e){ 
                alert("Erro");
            }
        }

        // --- 6.5 GESTÃƒO DE POSTOS (NOVO!) ---
        async function carregarPostosVisuais() {
            const container = document.getElementById('postos-cards-container');
            if(!container) return;
            container.innerHTML = 'Carregando...';
            
            try {
                const postosDoc = await db.collection('config_geral').doc('postos').get();
                const rotasDoc = await db.collection('config_geral').doc('rotas').get();
                const postos = postosDoc.exists ? (postosDoc.data().lista || []) : [];
                const rotas = rotasDoc.data() || {};

                container.innerHTML = '';
                postos.sort().forEach(p => {
                    const listsInPosto = Object.values(rotas).filter(r => r.posto === p).map(r => r.nome);
                    const card = document.createElement('div');
                    card.className = 'sector-card status-posto';
                   
                    card.innerHTML = `<h3>${p}</h3><div class="card-footer"><strong>ContÃ©m:</strong><ul class="sub-list-preview">${listsInPosto.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
                    card.onclick = () => abrirGestaoPosto(p, rotas);
                    container.appendChild(card);
                });
            } catch(e){ 
                container.innerHTML='Erro'; 
            }
        }

        function criarPosto() {
            const nome = document.getElementById('new-posto-name').value.trim().toUpperCase();
            if(!nome) return alert("Digite o nome.");
            
            db.collection('config_geral').doc('postos').set({ lista: firebase.firestore.FieldValue.arrayUnion(nome) }, { merge: true })
            .then(() => { 
                alert("Posto criado!"); 
                carregarPostosVisuais(); 
            })
            .catch(e => alert("Erro: " + e.message));
        }

       function abrirGestaoPosto(postoName, allRotas) {
    document.getElementById('edit-posto-original-name').value = postoName;
    document.getElementById('edit-posto-name-input').value = postoName;
    
    const checklist = document.getElementById('posto-lists-checklist');
    checklist.innerHTML = '';
    
    const previewContainer = document.getElementById('posto-preview-container'); 
    let listasAtualmenteVinculadas = [];
    
    // --- LÃ“GICA DE PERMISSÃƒO ---
    const isGestor = currentUserData && currentUserData.role === 'gestor';
    const gestorUnidade = currentUserData ? currentUserData.unidade : null;
    
    Object.entries(allRotas).forEach(([id, r]) => {
        if(r.ativo === false) return;
        
        // 1. LÃ“GICA DO PREVIEW: Coleta as listas jÃ¡ vinculadas
        const isChecked = (r.posto === postoName) ? 'checked' : '';
        if (isChecked) {
            // HTML NOVO: Nome da Lista em uma linha (com Ã­cone) e Unidade em outra linha (<small display: block;>)
            listasAtualmenteVinculadas.push(`
                <span style="display: block; font-size: 0.9em; margin-bottom: 5px; line-height: 1.3;">
                    <div style="display: flex; align-items: center; font-weight: bold; color: #333;">
                        <i class="fas fa-arrow-right" style="font-size: 0.7em; margin-right: 8px; color: #800020;"></i>
                        ${r.nome}
                    </div>
                    <small style="display: block; margin-left: 20px; font-weight: normal; color: #555;">
                        Unidade: <strong style="color: #555;">${r.unidade || 'GERAL'}</strong>
                    </small>
                </span>
            `);
        }
        
        // 2. FILTRO DE VISIBILIDADE PARA A CHECKLIST
        const isMinhaUnidade = r.unidade === gestorUnidade;
        
        if (isGestor && !isMinhaUnidade) {
            return; 
        }
        
        // 3. RENDERIZAÃ‡ÃƒO DA CHECKLIST
        const div = document.createElement('div');
        div.className = 'checklist-item';
        
        div.innerHTML = `
            <input type="checkbox" id="chk-p-${id}" ${isChecked} value="${id}"> 
            <label for="chk-p-${id}" style="margin:0;font-weight:normal;">
                ${r.nome} </label>`;
        
        checklist.appendChild(div);
    });
    
    // 4. INJEÃ‡ÃƒO DO PREVIEW NO HTML
    if (listasAtualmenteVinculadas.length > 0) {
        previewContainer.innerHTML = `
            <p style="margin: 0 0 5px 0; font-weight: bold; color: #800020;">Listas Atualmente Vinculadas (${listasAtualmenteVinculadas.length}):</p>
            ${listasAtualmenteVinculadas.join('')}
        `;
    } else {
        previewContainer.innerHTML = '<p style="margin: 0; color: #d39e00;">Nenhuma lista vinculada a este posto no momento.</p>';
    }
    
    document.getElementById('modal-posto-manager').style.display = 'flex';
}
        async function salvarAlteracoesPosto() {
            const oldName = document.getElementById('edit-posto-original-name').value;
            const newName = document.getElementById('edit-posto-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome invÃ¡lido");

            try {
                // 1. Atualizar lista de postos
                const postosRef = db.collection('config_geral').doc('postos');
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                // 2. Atualizar vÃ­nculos das rotas
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#posto-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    // SimplificaÃ§Ã£o: Checkbox marcado = define posto.
                    if (chk.checked) {
                        rotasData[id].posto = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ posto: newName });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!");
                document.getElementById('modal-posto-manager').style.display = 'none';
                carregarPostosVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirPosto() {
            const name = document.getElementById('edit-posto-original-name').value;
            if(!confirm(`Excluir o posto ${name}?`)) return;
            
            try {
                await db.collection('config_geral').doc('postos').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                alert("ExcluÃ­do."); 
                document.getElementById('modal-posto-manager').style.display = 'none'; 
                carregarPostosVisuais();
            } catch(e){ 
                alert("Erro"); 
            }
        }

        // --- FUNÃ‡Ã•ES DE FORMATAÃ‡ÃƒO DE TEXTO (NECESSÃRIAS PARA O PDF) ---

function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    // Adicionando a funÃ§Ã£o formatarDataSimples do outro arquivo
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('pt-BR');
}
	
// --- PDF GENERATOR (FUNÃ‡ÃƒO ATUALIZADA) ---
function reimprimirPDF(data) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const MARGIN = 14, PG_W = 210, LOGO_S = 15;

        const logoDraw = (domId, x) => { 
            const el = document.querySelector(`img[src*="${domId}"]`);
            if(el) { 
                try {
                    const c = document.createElement('canvas');
                    c.width = 160; c.height = 160;
                    c.getContext('2d').drawImage(el, 0, 0, 160, 160);
                    doc.addImage(c.toDataURL('image/png'), 'PNG', x, 10, LOGO_S, LOGO_S);
                } catch(e) { console.warn(`Logo erro: ${domId}`); } 
            }
        };
        
        logoDraw('cbmrr.png', MARGIN);
        logoDraw('logo_sigma.png', PG_W - MARGIN - LOGO_S);

        doc.setFontSize(10).setTextColor(51).setFont('helvetica', 'bold');
        doc.text('GOVERNO DE RORAIMA', PG_W/2, 15, {align:'center'}); 
        doc.setTextColor(217,15,35).text('CORPO DE BOMBEIROS MILITAR DE RORAIMA', PG_W/2, 20, {align:'center'}); 
        doc.setTextColor(51).setFont('helvetica', 'italic').text('"AmazÃ´nia: patrimÃ´nio dos brasileiros"', PG_W/2, 25, {align:'center'});
        doc.setFontSize(14).setTextColor(0).setFont('helvetica', 'bold').text("RELATÃ“RIO DE CONFERÃŠNCIA", PG_W/2, 35, {align:'center'});

        doc.setFillColor(240, 240, 240).setDrawColor(200, 200, 200).roundedRect(MARGIN, 40, PG_W - (MARGIN*2), 25, 2, 2, 'FD');
        
        const dataTimestamp = data.timestamp?.seconds ? new Date(data.timestamp.seconds * 1000) : new Date();
        
        doc.setFontSize(10).setTextColor(50).setFont('helvetica','bold').text('Local:', MARGIN + 5, 46); 
        doc.setFont('helvetica','normal').text(data.local || '', MARGIN + 35, 46); 
        doc.setFont('helvetica','bold').text('Conferente:', MARGIN + 5, 52); 
        doc.setFont('helvetica','normal').text(data.conferente || '', MARGIN + 35, 52); 
        doc.setFont('helvetica','bold').text('Data/Hora:', MARGIN + 5, 58); 
        doc.setFont('helvetica','normal').text(dataTimestamp.toLocaleString('pt-BR'), MARGIN + 35, 58); 
        
        doc.setFont('helvetica','bold').setTextColor(128, 0, 32).text(`TOTAL: ${data.totalItensConferidos || 0} | C/A: ${data.totalCaa || 0}`, PG_W - MARGIN - 5, 46, {align:'right'});

        let tableBody = [];
        const RED_FILL = [217, 15, 35], GREEN_FILL = [27, 138, 62], SECTOR_BG = [60, 60, 60];
        let listaParaImprimir = data.itensRelatorio || data.itensCaa || [];
        
        if (listaParaImprimir.length > 0) {
            let currentSector = null;
            listaParaImprimir.forEach(item => {
                let setorItem = item.setor || "ITENS GERAIS";
                if(setorItem !== currentSector) {
                    tableBody.push([{ content: setorItem.toUpperCase(), colSpan: 4, styles: { fillColor: SECTOR_BG, textColor: 255, fontStyle: 'bold', halign: 'left' } }]);
                    currentSector = setorItem;
                }

                let finalObs = '-';
                
                if (item.pendencias_ids && Array.isArray(item.pendencias_ids) && item.pendencias_ids.length > 0) {
                    finalObs = item.pendencias_ids.map(p => {
                        const autor = p.autor_nome || 'NÃ£o identificado';
                        const dataP = p.data_criacao || '';
                        const desc = p.descricao || '';
                        const qtd = String(p.quantidade || 0).padStart(2, '0');
                        // FormataÃ§Ã£o solicitada: Bullet + CabeÃ§alho + Quantidade + DescriÃ§Ã£o
                        return `\u2022 Por ${autor} em ${dataP}:\n  ${qtd}un - ${desc}`;
                    }).join('\n\n'); // EspaÃ§amento extra entre pendÃªncias diferentes
                } 
                else if (item.obs && item.obs !== "") {
                    finalObs = item.obs;
                }

                let bgStatus = (item.status === 'C/A') ? RED_FILL : GREEN_FILL;

                tableBody.push([ 
                    item.nomeCompleto || 'Item', 
                    { content: `QTD: ${item.quantidade || 0}`, styles: { halign: 'center' } }, 
                    { content: item.status || 'S/A', styles: { fillColor: bgStatus, textColor: 255, fontStyle: 'bold', halign: 'center' } }, 
                    { content: finalObs, styles: { halign: 'left', fontSize: 7 } } // Reduzi levemente a fonte da obs para caber o novo layout
                ]);
            });
        }
        
        doc.autoTable({ 
            startY: 70, 
            head: [['Material', 'Quantidade', 'Status', 'ObservaÃ§Ã£o']], 
            body: tableBody, 
            theme: 'striped', 
            styles: { fontSize: 8, valign: 'middle', textColor: 51, cellPadding: 2 }, 
            columnStyles: { 0:{cellWidth:70}, 1:{cellWidth:18}, 2:{cellWidth:18}, 3:{cellWidth:'auto'} }, 
            headStyles: { fillColor: [128, 0, 32], textColor: 255, fontStyle: 'bold', halign: 'center' } 
        });

        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8); doc.setTextColor(100);
            doc.text('SIGMA - Sistema Integrado de GestÃ£o de Materiais', MARGIN, doc.internal.pageSize.height-10);
            doc.text(`PÃ¡g. ${i} de ${totalPages}`, PG_W-MARGIN, doc.internal.pageSize.height-10, {align:'right'});
        }
        
        const dataIso = dataTimestamp.toISOString().split('T')[0];
        const nomeArquivo = `Relatorio_${(data.local||'Conf').replace(/[^a-zA-Z0-9]/g,'')}_${dataIso}.pdf`;
        doc.save(nomeArquivo);
        
    } catch(e) { 
        console.error("Erro PDF:", e);
        alert("Erro ao gerar PDF: " + e.message);
    }
}
		// --- OUTROS E FUNÃ‡Ã•ES GLOBAIS (UI) ---
        
        function sairDoSistema() { 
            auth.signOut().then(() => { 
                sessionStorage.clear(); 
                window.location.href = 'index.html'; 
            });
        }
        function logout() {
            sairDoSistema();
        }
        
        function switchView(v) {
    // Esconde todas as seÃ§Ãµes de visualizaÃ§Ã£o
    document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');

    // === INSERÃ‡ÃƒO NECESSÃRIA ===
    const appRunner = document.getElementById('app-runner-container');
    if (appRunner) { appRunner.style.display = 'none'; }

    // Mostra a seÃ§Ã£o desejada
    const viewElement = document.getElementById(`view-${v}`);
    if (viewElement) {
        viewElement.style.display = 'block';
    } else {
        console.error(`View nÃ£o encontrada: view-${v}`);
        return;
    }
    
    // Remove a classe 'active' de todos os links e adiciona ao link clicado
    document.querySelectorAll('#main-sidebar a').forEach(el => el.classList.remove('active'));
    const activeLink = document.getElementById(`link-${v}`);
    if (activeLink) {
        activeLink.classList.add('active');
    }

    // --- AÃ‡Ã•ES ESPECÃFICAS POR VIEW ---
    
    // âœ… INSERÃ‡ÃƒO CIRÃšRGICA: ALMOXARIFADO
    if (v === 'almoxarifado') {
        carregarAlmoxarifadoUI();
    }

    if (v === 'unidades') {
        carregarUnidadesVisuais();
    }
    
    if (v === 'postos') {
        carregarPostosVisuais();
    }

    if (v === 'usuarios') {
        listarUsuarios();
        carregarUnidadesSelect();
        setupCadastroMilitarLogic();
    }
    
    if (v === 'listas') {
        carregarPostosServicoSelect('novo-local-posto'); 
        carregarUnidadesSelect('novo-local-unidade'); 
        carregarListaLocaisAdmin(); 
    }

    if(v === 'global-history') {
        document.getElementById('glob-hist-start').valueAsDate = new Date(new Date().setDate(new Date().getDate()-30));
        document.getElementById('glob-hist-end').valueAsDate = new Date();
        carregarUnidadesVisuais();
        carregarUsuariosFiltro();
        loadGlobalHistory();
    }

    if(v === 'my-history') {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 30); 
        document.getElementById('my-hist-start').valueAsDate = startDate;
        document.getElementById('my-hist-end').valueAsDate = endDate;
        loadMyHistory();
    }

    // === SOLUÃ‡ÃƒO: FECHA O MENU APÃ“S SELEÃ‡ÃƒO NO MOBILE ===
    if (window.innerWidth <= 768) {
        history.pushState(null, null, location.href);
        closeMenuMobile();
    }
}
        function toggleMenuMobile() { 
            const s = document.getElementById('main-sidebar');
            if(s.classList.contains('mobile-active')) { 
                s.classList.remove('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='none'; 
            } else { 
                s.classList.add('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='block'; 
            } 
        }
        function closeMenuMobile() { 
    // ObtÃ©m o elemento sidebar
    const s = document.getElementById('main-sidebar');

    // Remove explicitamente a classe 'mobile-active' (fecha o menu),
    // independentemente do estado atual.
    if(s.classList.contains('mobile-active')) { 
        s.classList.remove('mobile-active'); 
        document.getElementById('mobile-overlay').style.display='none';
    } 
    // Remove a chamada a toggleMenuMobile()
}
        
        // --- FUNÃ‡Ã•ES DO MODAL GESTÃƒO C/A ---
        function mostrarTabela(data) {
    const wrapper = document.getElementById('ca-table-wrapper');
    const tbody = document.getElementById('ca-list-body');
    if (!wrapper || !tbody) return;

    // 1. UNIFICAÃ‡ÃƒO DO CABEÃ‡ALHO: InformaÃ§Ã£o de conferÃªncia movida para o tÃ­tulo
    document.getElementById('table-title').innerHTML = `
        <div style="display: flex; flex-direction: column; line-height: 1.2;">
            <span>Detalhes: ${data.local}</span>
            <span style="font-size: 0.55em; color: #666; font-weight: normal; margin-top: 4px;">
                <i class="fas fa-user-check"></i> Conferido por: <b>${data.conferente}</b> em ${data.date}
            </span>
        </div>
    `;
    
    tbody.innerHTML = '';

    const pendenciasReais = data.items || [];

    if (pendenciasReais.length === 0) {
        wrapper.querySelector('table').style.display = 'none';
        document.getElementById('no-issues-msg').style.display = 'block';
    } else {
        wrapper.querySelector('table').style.display = 'table';
        document.getElementById('no-issues-msg').style.display = 'none';

        pendenciasReais.forEach(p => {
            const tr = tbody.insertRow();
            
            // Ajuste de IdentificaÃ§Ã£o (Removido Ref: daqui)
            const identificadorFisico = p.tombamento 
                ? `<br><small style="color:#800020">Tomb: ${p.tombamento}</small>` 
                : `<br><small style="color:#d90f23; font-weight:bold;">Qtd em AlteraÃ§Ã£o: ${p.quantidade} un.</small>`;
            
            const statusG = p.status_gestao || 'PENDENTE';
            const badgeClass = p.tipoRegistro === 'CAUTELA' ? 'badge-cautela' : ('badge-' + statusG.toLowerCase().replace(/\s/g, '-'));

            let htmlAlteracao = '';
            if (p.tipoRegistro === 'CAUTELA') {
                // Link clicÃ¡vel para Detalhes da Cautela
                htmlAlteracao = `
                    <div style="font-size:0.9em;">
                        <b style="color:#f57c00;">Emitente:</b> ${p.autor_nome}<br>
                        <b style="color:#2c7399;">Detentor:</b> ${p.destinatario}<br>
                        <small><b>Obs:</b> ${p.descricao}</small><br>
                        <span style="color:#007bff; cursor:pointer; font-weight:bold; text-decoration:underline; font-size: 0.95em;" 
                              onclick="showCautelaDetails('${p.id}')">
                              <i class="fas fa-file-contract"></i> ${p.id}
                        </span>
                    </div>`;
            } else {
                // Data do relato inserida diretamente no fluxo
                const dataRelato = p.data_criacao || data.date.split(',')[0]; 
                htmlAlteracao = `
                    <div style="font-size:0.9em;">
                        <b>Relatado por ${p.autor_nome} em ${dataRelato}:</b><br>
                        ${p.descricao}
                    </div>`;
            }

            // TABELA LIMPA: Apenas 4 colunas (Material, Status, AlteraÃ§Ã£o, AÃ§Ã£o)
            tr.innerHTML = `
                <td><strong>${p.itemNome}</strong>${identificadorFisico}</td>
                <td><span class="status-badge ${badgeClass}">${statusG}</span></td>
                <td style="text-align:left;">${htmlAlteracao}</td>
            `;

            const tdAcao = tr.insertCell();
            if (p.tipoRegistro === 'PENDENCIA') {
                const btnData = {
                    docId: data.docId,
                    listaId: data.lista_id,
                    itemId: p.itemId,
                    pendenciaId: p.id,
                    nome: p.itemNome,
                    tombamento: p.tombamento || "",
                    descricao: p.descricao,
                    qtd: p.quantidade
                };
                tdAcao.innerHTML = `<button class="btn-modern-action btn-create" onclick='abrirModalGestaoID(${JSON.stringify(btnData)})'>Gerenciar</button>`;
            } else {
                tdAcao.innerHTML = `<small style="color:#999; font-style:italic;">Posse Pessoal</small>`;
            }
        });
    }
    wrapper.style.display = 'block';
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
		function abrirModalGestaoID(data) {
    // Preenche campos ocultos para saber o que estamos editando
    document.getElementById('gestao-item-nome').textContent = data.nome;
    document.getElementById('gestao-doc-id').value = data.docId;         // Ref em resultados
    document.getElementById('gestao-item-id-lista').value = data.itemId; // Ref na lista mestra
    
    // Novo campo oculto que vocÃª deve adicionar ao seu HTML: <input type="hidden" id="gestao-pendencia-id">
    const inputPendId = document.getElementById('gestao-pendencia-id');
    if(inputPendId) inputPendId.value = data.pendenciaId;

    // Mostra a descriÃ§Ã£o para o Gestor saber o que estÃ¡ tratando
    document.getElementById('gestao-obs').value = '';
    document.getElementById('gestao-obs').placeholder = `AÃ§Ã£o para: ${data.descricao}`;

    document.getElementById('modal-gestao-ca').style.display = 'flex';
}
        function fecharTabela(){ 
            document.getElementById('ca-table-wrapper').style.display='none';
        }
        
        function abrirModalGestao(i){
            document.getElementById('gestao-item-nome').textContent = i.nomeCompleto;
            document.getElementById('gestao-doc-id').value = i.docId; 
            document.getElementById('gestao-item-index').value = i.originalIndex;
            document.getElementById('gestao-item-id-lista').value = i.id; 
            document.getElementById('gestao-item-max-qtd').value = i.quantidade || 1;
            
            document.getElementById('gestao-status').value = i.statusAdmin || 'Solucionado';
            document.getElementById('gestao-obs').value = '';
            document.getElementById('gestao-qtd').value = '1';
            toggleGestaoQtd();

            document.getElementById('modal-gestao-ca').style.display = 'flex';
        }

        function fecharModalGestao(){ 
            document.getElementById('modal-gestao-ca').style.display='none';
        }

        function toggleGestaoQtd(){
            const isRemover = document.getElementById('gestao-status').value === 'Remover';
            document.getElementById('div-gestao-qtd').style.display = isRemover ? 'block' : 'none';
            if(isRemover) {
                const max = document.getElementById('gestao-item-max-qtd').value;
                document.getElementById('gestao-qtd').max = max;
                document.getElementById('gestao-qtd-info').textContent = `Estoque atual: ${max}`;
            }
        }

        document.getElementById('gestao-status').onchange = toggleGestaoQtd;
        
        async function salvarGestaoCa() {
    const docId = document.getElementById('gestao-doc-id').value;          // Doc em resultados_conferencias
    const itemId = document.getElementById('gestao-item-id-lista').value;  // ID do item
    const pendId = document.getElementById('gestao-pendencia-id').value;   // ID da pendÃªncia (NOVO)
    const statusAcao = document.getElementById('gestao-status').value;     // Solucionado, Em soluÃ§Ã£o, etc.
    const obsGestor = document.getElementById('gestao-obs').value.trim();

    if (!obsGestor) return alert("Descreva a aÃ§Ã£o tomada.");

    try {
        const nomeGestor = `${currentUserData.posto} ${currentUserData.nome_guerra}`;
        const dataHora = new Date().toLocaleString('pt-BR');

        // 1. Atualizar no Documento de Resultados (O que aparece no Dashboard)
        const resRef = db.collection('resultados_conferencias').doc(docId);
        const resSnap = await resRef.get();
        if (!resSnap.exists) throw new Error("Registro de conferÃªncia nÃ£o encontrado.");

        let resData = resSnap.data();
        let itensCaa = resData.itensCaa || [];

        // Localiza o item e o ID da pendÃªncia dentro dele
        const itemRes = itensCaa.find(i => i.id === itemId);
        if (itemRes && itemRes.pendencias_ids) {
            const pIdx = itemRes.pendencias_ids.findIndex(p => p.id === pendId);
            if (pIdx > -1) {
                if (statusAcao === 'Solucionado') {
                    itemRes.pendencias_ids.splice(pIdx, 1); // Remove se resolvido
                } else {
                    itemRes.pendencias_ids[pIdx].status_gestao = statusAcao.toUpperCase();
                    itemRes.pendencias_ids[pIdx].descricao += `\n[GESTÃƒO ${dataHora}]: ${obsGestor}`;
                }
            }
        }
        await resRef.update({ itensCaa });

        // 2. Atualizar na Lista Mestra (PersistÃªncia para a prÃ³xima conferÃªncia)
        const listaId = resData.lista_id;
        const listaRef = db.collection('listas_conferencia').doc(listaId);
        const listaSnap = await listaRef.get();
        
        if (listaSnap.exists) {
            let listaMestra = listaSnap.data().list;
            
            listaMestra = listaMestra.map(setor => ({
                ...setor,
                itens: setor.itens.map(mItem => {
                    const processar = (obj) => {
                        if (obj.pendencias_ids) {
                            const idx = obj.pendencias_ids.findIndex(p => p.id === pendId);
                            if (idx > -1) {
                                if (statusAcao === 'Solucionado') {
                                    // Move para histÃ³rico antes de deletar
                                    if(!obj.historico_vida) obj.historico_vida = [];
                                    obj.historico_vida.push({
                                        evento: "SOLUCAO_GESTOR",
                                        quem: nomeGestor,
                                        data: dataHora,
                                        detalhes: `ID ${pendId} resolvido pelo Gestor. Obs: ${obsGestor}`
                                    });
                                    obj.pendencias_ids.splice(idx, 1);
                                } else {
                                    obj.pendencias_ids[idx].status_gestao = statusAcao.toUpperCase();
                                }
                            }
                        }
                        return obj;
                    };

                    if (mItem.tipo === 'multi' && mItem.tombamentos) {
                        mItem.tombamentos = mItem.tombamentos.map(t => processar(t));
                    } else if (mItem.id === itemId) {
                        mItem = processar(mItem);
                    }
                    return mItem;
                })
            }));

            await listaRef.update({ list: listaMestra });
        }

        alert("AÃ§Ã£o de gestÃ£o registrada com sucesso!");
        fecharModalGestao();
        fecharTabela();
        loadCaaData(); // Recarrega os cards do dashboard

    } catch (e) {
        console.error(e);
        alert("Erro ao salvar aÃ§Ã£o do gestor: " + e.message);
    }
}
        // --- FUNÃ‡Ã•ES DE EDITOR (MOVIDAS PARA O ESCOPO GLOBAL) ---
        function abrirEditor(id, nome, unidadeLista) { 
    
    // --- NOVA VERIFICAÃ‡ÃƒO DE PERMISSÃƒO DE UNIDADE ---
    // Verifica se o usuÃ¡rio Ã© um Gestor E se a Unidade da Lista 
    // Ã© diferente da Unidade do usuÃ¡rio logado.
    if (currentUserData.role === 'gestor' && unidadeLista !== currentUserData.unidade) {
        alert("Acesso negado. VocÃª sÃ³ pode editar listas da sua unidade.");
        return; // Impede que o editor seja aberto
    }
    // --------------------------------------------------

    currentEditingId = id;
    const editorTitleEl = document.getElementById('editor-title');
    if(editorTitleEl) {
        editorTitleEl.textContent = `Editando: ${nome}`; 
    }
    
    switchView('editor'); 
    carregarDadosGerenciador(); 
}
        function voltarParaLocais() { 
            currentEditingId = null;
            switchView('listas'); 
        }
        
        async function carregarDadosGerenciador(){ 
            if(!currentEditingId) return;
            try{ 
                document.getElementById('loading-message-admin').style.display = 'block';
                document.getElementById('main-admin-content').style.display = 'none';
                const d=await db.collection(COLECAO_LISTAS).doc(currentEditingId).get(); 
                dadosConferencia=d.exists?(d.data().list||[]):[]; 
                renderizarLista(); 
                document.getElementById('loading-message-admin').style.display = 'none';
                document.getElementById('main-admin-content').style.display = 'block';
            }catch(e){
                console.error(e);
                alert("Erro ao carregar lista.");
            } 
        }
        async function salvarDados(a=true){ 
            if(!currentEditingId) return;
            try{ 
                await db.collection(COLECAO_LISTAS).doc(currentEditingId).update({ list:dadosConferencia, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }); 
                if(a)alert("Salvo!"); 
            }catch(e){
                alert("Erro ao salvar");
            } 
        }
        function gerarNovoId(){ 
            return Date.now().toString().slice(-6)+Math.floor(Math.random()*100).toString().padStart(2,'0');
        }
        function adicionarSetor(n){ 
            n=n.trim().toUpperCase(); 
            if(!n)return; 
            dadosConferencia.push({id:gerarNovoId(), nome:n, itens:[]}); 
            document.getElementById('input-setor-nome').value=''; 
            salvarDados(false); 
            renderizarLista();
        }
        function removerSetor(id){ 
            if(confirm("Remover setor?")) { 
                dadosConferencia=dadosConferencia.filter(x=>x.id!==id); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        
        // ATENÃ‡ÃƒO: Esta Ã© a funÃ§Ã£o que vocÃª deve modificar no sigma_dashboard.html
        function adicionarItemPorSetor(sid) { 
            const n = document.getElementById('input-item-nome-'+sid).value.trim().toUpperCase();
            const q = parseInt(document.getElementById('input-item-qtd-'+sid).value); 
            const t = document.getElementById('select-item-tipo-'+sid).value; 
            
            if(!n || q < 1) return;
            
            // 1. CAPTURAR O SCROLL POSITION ANTES DA RECONSTRUÃ‡ÃƒO DO DOM
            // O elemento que rola Ã© o pai da lista de setores, ou o contÃªiner principal do editor.
            const scrollContainer = document.querySelector('.admin-container'); 
            let scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            const s = dadosConferencia.find(x => x.id === sid);
            const novo = {id: sid+'-'+gerarNovoId(), nome: n, quantidadeEsperada: q, tipo: t, tombamentos:[]};
            
            if(t === 'multi') for(let i = 0; i < q; i++) novo.tombamentos.push({tomb: 'NOVO-' + (i+1), status: 'pending', obs: ''}); 
            
            s.itens.push(novo);
            
            // OTIMIZAÃ‡ÃƒO: Limpar o campo de nome
            document.getElementById('input-item-nome-'+sid).value = '';

            salvarDados(false);
            
            // 2. RECONSTRUIR A LISTA
            renderizarLista(); 

            // 3. RESTAURAR O SCROLL POSITION APÃ“S A RECONSTRUÃ‡ÃƒO
            if (scrollContainer && scrollTop > 0) {
                // Usamos um pequeno timeout para garantir que o DOM foi totalmente renderizado
                setTimeout(() => {
                    scrollContainer.scrollTop = scrollTop;
                }, 50);
            }
        }
        function removerItem(sid,iid){ 
            if(confirm("Remover item?")){ 
                const s=dadosConferencia.find(x=>x.id===sid); 
                s.itens=s.itens.filter(i=>i.id!==iid); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function encontrarItemPorId(id) { 
            for (const setor of dadosConferencia) { 
                const item = setor.itens.find(i => i.id === id);
                if (item) return item; 
            } 
            return null; 
        }
        function adicionarTombamento(itemId, inputElement) { 
            const tombamento = inputElement.value.trim().toUpperCase();
            if (!tombamento) return; 
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                if (item.tombamentos.some(t => t.tomb === tombamento)) return alert("Duplicado!");
                item.tombamentos.push({ tomb: tombamento, status: "pending", obs: "" }); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function removerTombamento(itemId, tombamento) { 
            if (!confirm("Remover tombamento?")) return;
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                item.tombamentos = item.tombamentos.filter(t => t.tomb !== tombamento); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function editarTombamento(itemId, tombamentoAtual, inputElement) { 
            const novoTombamento = inputElement.value.trim().toUpperCase();
            if (!novoTombamento || novoTombamento === tombamentoAtual) return; 
            const item = encontrarItemPorId(itemId);
            if (item) { 
                const tomb = item.tombamentos.find(t => t.tomb === tombamentoAtual); 
                if (tomb) { 
                    tomb.tomb = novoTombamento; 
                    salvarDados(false);
                } 
            } 
        }
        function updateOrdens() { 
            const novosDados = [];
            document.querySelectorAll('.setor-item').forEach(sNode => { 
                const sId = sNode.getAttribute('data-id'); 
                const sOriginal = dadosConferencia.find(x => x.id === sId); 
                const novosItens = []; 
                sNode.querySelectorAll('.item-conferencia-admin').forEach(iNode => { 
                    const iId = iNode.querySelector('.btn-edit-alt').getAttribute('onclick').split("'")[3]; 
                    const itemObj = encontrarItemPorId(iId); 
                    if(itemObj) novosItens.push(itemObj); 
                }); 
                sOriginal.itens = novosItens; 
                novosDados.push(sOriginal); 
            });
            dadosConferencia = novosDados; 
        }
        function abrirModalEdicao(sid, iid){ 
            const s=dadosConferencia.find(x=>x.id===sid); 
            const i=s.itens.find(x=>x.id===iid); 
            document.getElementById('edit-setor-id').value=sid; 
            document.getElementById('edit-item-original-id').value=iid;
            document.getElementById('edit-item-nome').value=i.nome; 
            document.getElementById('edit-item-qtd').value=i.quantidadeEsperada; 
            document.getElementById('edit-item-qtd').disabled=(i.tipo==='multi'); 
            document.getElementById('edit-item-tipo').value=i.tipo; 
            const sl=document.getElementById('edit-item-setor'); 
            sl.innerHTML=''; 
            dadosConferencia.forEach(d=>{
                const o=document.createElement('option'); 
                o.value=d.id; 
                o.text=d.nome; 
                if(d.id===sid)o.selected=true; 
                sl.appendChild(o);
            }); 
            document.getElementById('modal-edicao').style.display='flex';
        }
        function salvarEdicaoItem(){ 
            const osid=document.getElementById('edit-setor-id').value; 
            const iid=document.getElementById('edit-item-original-id').value; 
            const n=document.getElementById('edit-item-nome').value.trim().toUpperCase(); 
            const nsid=document.getElementById('edit-item-setor').value; 
            const q=parseInt(document.getElementById('edit-item-qtd').value);
            
            const os=dadosConferencia.find(x=>x.id===osid); 
            const ns=dadosConferencia.find(x=>x.id===nsid); 
            const i=os.itens.find(x=>x.id===iid); 
            i.nome=n; 
            if(i.tipo==='single')i.quantidadeEsperada=q; 
            
            if(osid!==nsid){ 
                os.itens=os.itens.filter(x=>x.id!==iid); 
                i.id=nsid+'-'+gerarNovoId(); 
                ns.itens.push(i); 
            } 
            salvarDados(false); 
            renderizarLista(); 
            fecharModal();
        }
        function fecharModal(){
            document.getElementById('modal-edicao').style.display='none';
        }
        function fazerBackupLocal(){ 
            const b=new Blob([JSON.stringify(dadosConferencia,null,2)],{type:"application/json"});
            const u=URL.createObjectURL(b); 
            const a=document.createElement('a'); 
            a.href=u; 
            a.download='backup.json'; 
            a.click(); 
        }
        function importarBackupLocal(e){ 
            const f=e.target.files[0]; 
            if(!f)return;
            const r=new FileReader(); 
            r.onload=function(ev){
                if(confirm("Substituir?")){
                    try{
                        dadosConferencia=JSON.parse(ev.target.result);
                        salvarDados();
                        renderizarLista();
                    }catch(err){
                        alert("Erro JSON");
                    }
                }
            }; 
            r.readAsText(f); 
        }
        function carregarCategoriasLista(elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;

    // Categorias que o administrador pode criar itens
    const categorias = [
        'POSTO DE SERVIÃ‡O', // A categoria que vocÃª mencionou
        'SETOR', 
        'VIATURAS',
        // Adicione outras categorias que vocÃª permite editar
    ];

    select.innerHTML = '<option value="" disabled selected>Selecione a Categoria</option>';
    categorias.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        select.appendChild(option);
    });
}

        
        async function criarUsuario() {
    const email = document.getElementById('new-user-email').value.trim();
    const guerra = document.getElementById('new-user-guerra').value.trim().toUpperCase();
    const posto = document.getElementById('new-user-posto').value;
    const quadro = document.getElementById('new-user-quadro').value; // Novo Campo
    const completo = document.getElementById('new-user-completo').value.trim().toUpperCase(); // Nome Civil Completo
    const role = document.getElementById('new-user-role').value;
    const unit = document.getElementById('new-user-unit').value;
    
    // NOVOS CAMPOS DE IDENTIFICAÃ‡ÃƒO E CONTATO (LIMPOS)
    const cpfRaw = document.getElementById('new-user-cpf').value.replace(/\D/g, '');
    const matriculaRaw = document.getElementById('new-user-matricula').value.replace(/\D/g, '');
    const telefoneRaw = document.getElementById('new-user-telefone').value.replace(/\D/g, '');

    if (!email || !guerra || !posto || !quadro || !unit || !completo || !cpfRaw || !telefoneRaw) {
        return alert("Preencha todos os campos obrigatÃ³rios: Email, Nome Guerra, Posto/Quadro, Nome Completo, CPF, Telefone e Unidade.");
    }
    
    // --- CÃLCULO DAS VARIÃVEIS AUXILIARES ---
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    // Novo Link WhatsApp (Formato web.whatsapp.com)
    const whatsappUrl = `https://web.whatsapp.com/send?phone=55${telefoneRaw}`;

    try {
        await db.collection('usuarios').add({ 
            email: email, 
            nome_guerra: guerra, 
            posto: posto,
            quadro: quadro,
            nome_completo: completo,
            nome_militar_completo: nomeMilitarCompleto, // Nome de ExibiÃ§Ã£o
            telefone_contato: document.getElementById('new-user-telefone').value, // Salva o telefone FORMATADO
            whatsapp_url: whatsappUrl, // Link WhatsApp atualizado
            cpf: cpfRaw,
            matricula: matriculaRaw,
            
            role: role, 
            unidade: unit 
        });
        alert("UsuÃ¡rio registrado! (Lembre-se de criar o login no Firebase Authentication)"); 
        
        // Limpar os campos apÃ³s o cadastro
        document.getElementById('new-user-email').value = '';
        document.getElementById('new-user-guerra').value = '';
        document.getElementById('new-user-completo').value = '';
        document.getElementById('new-user-cpf').value = '';
        document.getElementById('new-user-matricula').value = '';
        document.getElementById('new-user-telefone').value = '';
        document.getElementById('new-user-posto').value = ''; // Limpa o select
        document.getElementById('new-user-quadro').value = ''; // Limpa o select
        
        listarUsuarios();
    } catch(e) { 
        alert("Erro ao salvar usuÃ¡rio: " + e.message);
    }
}

        async function listarUsuarios() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
    
    // --- NOVO: FILTRO DE UNIDADE PARA O GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    
    let userQuery = db.collection('usuarios'); // ColeÃ§Ã£o correta
    
    if (isGestor) {
        // Se for Gestor, filtre a query para buscar usuÃ¡rios APENAS na sua unidade
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }
    // ---------------------------------------------

    try {
        // Executa a query (filtrada ou total)
        const snap = await userQuery.get();
        
        // 1. POPULA A VARIÃVEL GLOBAL allUsersData
        allUsersData = [];
        snap.forEach(doc => {
            // Salva o ID do documento junto com os dados para uso no modal e filtro
            allUsersData.push({ id: doc.id, ...doc.data() }); 
        });
        
        // 2. VERIFICA SE HÃ DADOS
        if (allUsersData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Nenhum militar encontrado nesta unidade.</td></tr>';
            return;
        }

        // 3. INICIA A RENDERIZAÃ‡ÃƒO/FILTRAGEM
        // Chama a funÃ§Ã£o de filtragem (que faz a renderizaÃ§Ã£o real)
        filtrarUsuarios();
        
    } catch(e) {
        console.error("Erro ao listar usuÃ¡rios:", e);
        tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar lista de usuÃ¡rios.</td></tr>';
    }
}
        
        async function abrirGestaoUsuario(docId) {
    try {
        const doc = await db.collection('usuarios').doc(docId).get();
        if (!doc.exists) return alert("UsuÃ¡rio nÃ£o encontrado.");
        
        const u = doc.data();
        const permissoes = u.permissoes || {};
        
        // Preenche o campo de unidades
        await carregarUnidadesSelect('edit-user-unit');
        
        document.getElementById('edit-user-doc-id').value = docId;
        document.getElementById('edit-user-guerra').value = u.nome_guerra || '';
        document.getElementById('edit-user-posto').value = u.posto || ''; // Preenche o Posto
        document.getElementById('edit-user-completo').value = u.nome_completo || ''; 
        document.getElementById('edit-user-email').value = u.email || 'N/D';
        document.getElementById('edit-user-role').value = u.role || 'operacional';
        document.getElementById('edit-user-unit').value = u.unidade || '';

        // Campos de IdentificaÃ§Ã£o Pessoal
        document.getElementById('edit-user-cpf').value = u.cpf || '';
        document.getElementById('edit-user-matricula').value = u.matricula || '';
        document.getElementById('edit-user-telefone').value = u.telefone_contato || '';
        
        // Campo Quadro Ã© tratado abaixo, mas guarda o valor para prÃ©-seleÃ§Ã£o
        const quadroSalvo = u.quadro || ''; 

        // CAMPO NOME DE EXIBIÃ‡ÃƒO (SINTÃ‰TICO - SOMENTE LEITURA)
        document.getElementById('edit-user-display-name').value = u.nome_militar_completo || 'N/D';

        // --- INTEGRAÃ‡ÃƒO DA LÃ“GICA DE SELEÃ‡ÃƒO (NOVO BLOCO) ---
        
        // 1. Anexa o Listener de MudanÃ§a ao Posto/GraduaÃ§Ã£o
        const postoSelect = document.getElementById('edit-user-posto');
        postoSelect.onchange = atualizarQuadroModal; // Chama a funÃ§Ã£o de dependÃªncia

        // 2. Dispara a lÃ³gica uma vez para carregar as opÃ§Ãµes de Quadro
        // Isso preencherÃ¡ o #edit-user-quadro com as opÃ§Ãµes corretas para o posto salvo.
        atualizarQuadroModal();

        // 3. PrÃ©-seleciona o Quadro salvo (sÃ³ funciona apÃ³s a chamada acima)
        document.getElementById('edit-user-quadro').value = quadroSalvo;

        // --- LÃ“GICA DE PERMISSÃ•ES (Mantida) ---
        const roleSelect = document.getElementById('edit-user-role');
        const permFields = document.getElementById('user-permissions-fields');
        
        permFields.style.display = (u.role === 'gestor' || u.role === 'admin') ? 'block' : 'none';
        
        document.getElementById('perm-view-cards').checked = permissoes.canViewDashboardCards || false;
        document.getElementById('perm-view-history').checked = permissoes.canViewUnitHistory || false;
        document.getElementById('perm-manage-posts').checked = permissoes.canManagePosts || false;
        document.getElementById('perm-manage-users').checked = permissoes.canManageUnitUsers || false;
        document.getElementById('perm-manage-lists').checked = permissoes.canManageUnitLists || false;

        roleSelect.onchange = function() {
            permFields.style.display = (this.value === 'gestor' || this.value === 'admin') ? 'block' : 'none';
        };

        document.getElementById('modal-user-manager').style.display = 'flex';
    } catch(e) {
        console.error(e);
        alert("Erro ao abrir ediÃ§Ã£o: " + e.message);
    }
}
        
        async function salvarAlteracoesUsuario() {
    const docId = document.getElementById('edit-user-doc-id').value;
    const guerra = document.getElementById('edit-user-guerra').value.trim();
    const posto = document.getElementById('edit-user-posto').value.trim();
    const quadro = document.getElementById('edit-user-quadro').value.trim(); // Lendo do novo SELECT editÃ¡vel
    const completo = document.getElementById('edit-user-completo').value.trim(); 
    const role = document.getElementById('edit-user-role').value;
    const unit = document.getElementById('edit-user-unit').value;
    
    // CAMPOS DE IDENTIFICAÃ‡ÃƒO AGORA EDITÃVEIS
    const cpf = document.getElementById('edit-user-cpf').value.trim();
    const matricula = document.getElementById('edit-user-matricula').value.trim();
    const telefone = document.getElementById('edit-user-telefone').value.trim();

    if (!guerra || !posto || !quadro || !unit || !completo) return alert("Preencha Nome de Guerra, Posto, Quadro, Unidade e Nome Civil Completo.");
    if (posto === "" || quadro === "") return alert("Selecione o Posto/GraduaÃ§Ã£o e o Quadro.");

    // --- RECALCULAÃ‡ÃƒO DA VARIÃVEL SINTÃ‰TICA (NOME DE EXIBIÃ‡ÃƒO) ---
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    
    // --- LÃ“GICA DE SALVAMENTO DE PERMISSÃ•ES (Mantida) ---
    const novasPermissoes = {
        canViewDashboardCards: document.getElementById('perm-view-cards').checked,
        canViewUnitHistory: document.getElementById('perm-view-history').checked,
        canManagePosts: document.getElementById('perm-manage-posts').checked,
        canManageUnitUsers: document.getElementById('perm-manage-users').checked,
        canManageUnitLists: document.getElementById('perm-manage-lists').checked,
    };
    
    // O objeto de atualizaÃ§Ã£o
    const updateData = {
        nome_guerra: guerra,
        posto: posto,
        quadro: quadro,                         
        nome_militar_completo: nomeMilitarCompleto, 
        nome_completo: completo,             
        
        cpf: cpf,
        matricula: matricula,
        telefone_contato: telefone,
        whatsapp_url: `https://web.whatsapp.com/send?phone=55${telefone.replace(/\D/g, '')}`,
        
        role: role,
        unidade: unit,
        permissoes: novasPermissoes,
    };
    
    try {
        await db.collection('usuarios').doc(docId).update(updateData);
        alert("Dados do militar atualizados com sucesso!");
        document.getElementById('modal-user-manager').style.display = 'none';
        listarUsuarios();
    } catch(e) {
        alert("Erro ao salvar alteraÃ§Ãµes: " + e.message);
    }
}
        async function carregarUsuariosFiltro() {
    const select = document.getElementById('glob-hist-user');
    if (!select) return;

    select.innerHTML = '<option value="">Todos</option>';
    
    // Filtro de seguranÃ§a: Gestor sÃ³ vÃª usuÃ¡rios da prÃ³pria unidade. Admin vÃª todos.
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;

    let userQuery = db.collection('usuarios');
    
    if (isGestor) {
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }

    try {
        const snap = await userQuery.get();
        let users = [];
        snap.forEach(doc => {
            const u = doc.data();
            // Usamos o nome completo, pois Ã© o que estÃ¡ salvo nos resultados (linha 1082)
            if (u.nome_militar_completo) {
                users.push(u.nome_militar_completo);
            }
        });

        users.sort().forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

    } catch (e) {
        console.error("Erro ao carregar filtro de usuÃ¡rios:", e);
    }
}

        async function excluirUsuario() {
            const docId = document.getElementById('edit-user-doc-id').value;
            const guerra = document.getElementById('edit-user-guerra').value;

            if(!confirm(`Tem certeza que deseja EXCLUIR o militar ${guerra}? O login associado (Auth) DEVE ser removido manualmente.`)) return;
            
            try {
                await db.collection('usuarios').doc(docId).delete();
                alert(`Militar ${guerra} excluÃ­do com sucesso do Firestore!`);
                document.getElementById('modal-user-manager').style.display = 'none';
                listarUsuarios();
            } catch(e) {
                alert("Erro ao excluir: " + e.message);
            }
        }

        async function carregarPostosEditor() {
             const sel = document.getElementById('novo-local-posto');
             if(!sel) return;
             
             try {
                const doc = await db.collection('config_geral').doc('postos').get();
                const lista = doc.exists ? doc.data().lista : [];
                let h = ''; 
                lista.forEach(p => h+=`<option value="${p}">${p}</option>`); 
                sel.innerHTML = h;
             } catch(e){}
        }

        async function criarNovoLocal() {
            const posto = document.getElementById('novo-local-posto').value;
            const nome = document.getElementById('novo-local-nome').value.trim().toUpperCase();
            const unidade = document.getElementById('novo-local-unidade').value;
            if(!posto || !nome || !unidade) return alert("Preencha Posto, Nome e Unidade.");
            
            // ConstrÃ³i o ID Ãºnico e o nome completo
            const id = `${posto.toLowerCase()}_${nome.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            const localCompleto = `${posto} - ${nome}`; // Nome que aparecerÃ¡ no Card/RelatÃ³rio
            
            try {
                // 1. Salva a lista (Viaturas)
                await db.collection(COLECAO_LISTAS).doc(id).set({ nome_local: nome, posto: posto, list: [], unidade: unidade, updatedAt: firebase.firestore.Timestamp.now() });

                // 2. Salva a rota
                await db.collection('config_geral').doc('rotas').set({ [id]: { nome: nome, posto: posto, unidade: unidade, ativo: true } }, { merge: true });

                // --- NOVO: Cria o registro inicial para o Dashboard ---
                // Este registro garante que o Card de PendÃªncias apareÃ§a imediatamente com status OK.
                await db.collection(COLECAO_RESULTADOS).add({
                    local: localCompleto,
                    lista_id: id,
                    conferente: "Sistema (InicializaÃ§Ã£o)",
                    unidade: unidade,
                    posto: posto,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    // Dados para garantir que o card seja renderizado com 0 pendÃªncias
                    itensRelatorio: [], 
                    itensCaa: [],
                    totalCaa: 0,
                    totalItensConferidos: 0,
                    statusAdmin: 'OK'
                });
                // ----------------------------------------------------

                alert("Lista Criada e Card Inicializado!"); 
                carregarListaLocaisAdmin();
                // Chama loadCaaData() para atualizar o Dashboard com o novo Card
                loadCaaData(); 
                
            } catch(e) { 
                alert("Erro ao criar lista: " + e.message); 
            }
        }
        
        async function excluirLocalAdmin(listaId, listaNome) {
    if (!confirm(`TEM CERTEZA? Excluir a lista: ${listaNome} (ID: ${listaId})?`)) {
        return;
    }

    try {
        // --- 1. REMOVER REGISTROS DE PENDÃŠNCIA (CARDS) ---
        const resultadosSnap = await db.collection(COLECAO_RESULTADOS)
            .where('lista_id', '==', listaId)
            .get();

        const batch = db.batch();
        resultadosSnap.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
        // ----------------------------------------------------

        // 2. Remova o item da coleÃ§Ã£o principal de listas (o conteÃºdo em si)
        await db.collection(COLECAO_LISTAS).doc(listaId).delete();

        // 3. Remova a referÃªncia da rota na configuraÃ§Ã£o geral, inativando-a
        const rotasRef = db.collection('config_geral').doc('rotas');
        const rotasSnap = await rotasRef.get();
        const rotasData = rotasSnap.data();

        if (rotasData && rotasData[listaId]) {
            // Marca como inativo em vez de deletar para manter o histÃ³rico de dados antigos
            rotasData[listaId].ativo = false;
            await rotasRef.set(rotasData); 
        }

        alert(`Lista "${listaNome}" excluÃ­da/inativada e Cards de PendÃªncia removidos com sucesso!`);
        
        carregarListaLocaisAdmin();
        loadCaaData(); // Atualiza o Dashboard
    } catch (e) {
        console.error("Erro ao excluir lista:", e);
        alert("Erro ao excluir lista: " + e.message);
    }
}
        
        async function carregarListaLocaisAdmin() {
    const ul = document.getElementById('lista-locais-container');
    const doc = await db.collection('config_geral').doc('rotas').get();
    const rotas = doc.data();
    ul.innerHTML = '';
    
    // --- FILTRO DE SEGURANÃ‡A PARA GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // ----------------------------------------
    
    // Objeto para mapear o ID da lista para o nome do local
    const listaNomes = {};

    // Mapeia as rotas e carrega os nomes
    Object.entries(rotas).forEach(([id, info]) => {
        if(info.ativo === false) return;

        // CONDIÃ‡ÃƒO DE FILTRAGEM: Se for gestor, sÃ³ mostra se a unidade da rota for igual Ã  unidade do gestor.
        if (isGestor && info.unidade !== unidadeGestor) {
            return;
        }
        
        listaNomes[id] = info.nome;
        
        const li = document.createElement('li');
        li.className = 'local-item';
        
        const safeName = info.nome.replace(/'/g, "\\'");
        const safeId = id.replace(/'/g, "\\'");
        // NOVO: Passando o nome da unidade para uso no abrirEditor
        const safeUnit = info.unidade.replace(/'/g, "\\'") || 'Geral'; 
        
        // --- CHAMADA CORRIGIDA: INCLUINDO A UNIDADE NO ABRIR EDITOR ---
        li.innerHTML = `
            <div class="local-info">
                <strong>${info.nome}</strong>
                <span>${info.posto} | Unidade: ${info.unidade||'Geral'}</span>
            </div>
            <div style="display:flex; gap: 10px;">
                <button class="btn-modern-action btn-edit" onclick="abrirEditor('${safeId}', '${safeName}', '${safeUnit}')">
                    Editar
                </button>
                <button class="btn-modern-action btn-delete" onclick="excluirLocalAdmin('${safeId}', '${safeName}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        ul.appendChild(li);
    });
}
        
        function renderizarLista() { 
            const container = document.getElementById('lista-setores-container');
            container.innerHTML = '';
            dadosConferencia.forEach(setor => {
            const setorLi = document.createElement('li'); 
            setorLi.className = 'setor-item'; 
            setorLi.setAttribute('data-id', setor.id);
            const addItemFormHtml = `<div class="add-item-form-setor">
            <input type="text" id="input-item-nome-${setor.id}" placeholder="Item" class="filter-input" style="flex-grow:1;">
            <input type="number" id="input-item-qtd-${setor.id}" value="1" class="filter-input" style="width:50px; flex-grow:0;">
            <select id="select-item-tipo-${setor.id}" class="filter-input" style="flex-grow:1;">
            <option value="single">Ãšnico</option>
            <option value="multi">Tombamento</option>
            </select>
            <button class="btn-add" onclick="adicionarItemPorSetor('${setor.id}')">+</button>
            </div>`;
                let itensHtml = '';
                setor.itens.forEach(item => {
                    let tombamentosHtml = '';
                    if (item.tipo === 'multi' && item.tombamentos) {
                        const tombamentosList = item.tombamentos.map(tomb => `<li><div style="display:flex; align-items:center; width:100%;"><span style="margin-right:10px; font-size:0.85em; font-weight:bold; color:#555;">TB:</span><input type="text" value="${tomb.tomb}" onblur="editarTombamento('${item.id}', '${tomb.tomb}', this)" style="padding:4px; font-size:0.85em; border:1px solid #ddd; border-radius:4px;"></div><button class="btn-remover" onclick="removerTombamento('${item.id}', '${tomb.tomb}')" style="padding:2px 8px; margin-left:10px;"><i class="fas fa-trash" style="font-size:0.8em;"></i></button></li>`).join('');
                        tombamentosHtml = `<div class="tombamento-container-wrapper"><div class="tombamento-section"><h4>Tombamentos (${item.tombamentos.length})</h4><ul class="tombamento-list">${tombamentosList}</ul><div class="add-tombamento-form"><input type="text" id="tomb-input-${item.id}" placeholder="Novo Tombamento"><button class="btn-add" onclick="adicionarTombamento('${item.id}', document.getElementById('tomb-input-${item.id}'))"><i class="fas fa-plus"></i></button></div></div></div>`;
                    }
                    itensHtml += `<li class="item-conferencia-admin"><div style="width:100%"><div style="display:flex;justify-content:space-between;"><div><strong>${item.nome}</strong><small> Qtd: ${item.quantidadeEsperada}</small></div><div class="item-actions-admin"><button class="btn-edit-alt" onclick="abrirModalEdicao('${setor.id}','${item.id}')"><i class="fas fa-edit"></i></button><button class="btn-remover" onclick="removerItem('${setor.id}','${item.id}')"><i class="fas fa-trash"></i></button></div></div>${item.tipo === 'multi' ? tombamentosHtml : ''}</div></li>`;
                });
                
                // ... (cÃ³digo dentro do loop forEach) ...
                setorLi.innerHTML = `
    <div class="setor-content-header-sticky" onclick="this.nextElementSibling.classList.toggle('collapsed')">
        <div class="setor-header-admin">
            <span>${setor.nome}</span>
            <button class="btn-remover" onclick="event.stopPropagation();removerSetor('${setor.id}')">X</button>
        </div>
        ${addItemFormHtml}
    </div>
    <div class="setor-content-admin">
        <ul class="lista-setores item-list-admin" data-setor-id="${setor.id}">${itensHtml}</ul>
    </div>
`;
                container.appendChild(setorLi);
            });
            // InicializaÃ§Ã£o do Sortable para SETORES (na variÃ¡vel 'container')
            new Sortable(container, { 
                animation: 150, 
                handle: '.setor-header-admin', 
                onEnd: () => { 
                    updateOrdens(); // <-- NOVO: Atualiza a ordem dos setores e itens no array global
                    salvarDados(false); 
                } 
            });
            document.querySelectorAll('.item-list-admin').forEach(el => { 
                new Sortable(el, { 
                    group: 'items', 
                    animation: 150, 
                    // === OPÃ‡Ã•ES DE AUTOSCROLL AQUI ===
        
                    scroll: true,             // 1. Ativa a rolagem automÃ¡tica
                    scrollSensitivity: 80,    // 2. DistÃ¢ncia (em pixels) da borda para acionar o scroll
                    scrollSpeed: 20,          // 3. Velocidade da rolagem (quanto maior, mais rÃ¡pido)
                    bubbleScroll: true,
                    // Define o elemento que deve rolar. 
                    // No seu caso, o elemento pai de `el` Ã© o .setor-content-admin
                
                    onEnd: () => { 
                        updateOrdens(); 
                        salvarDados(false); 
                    } 
                }); 
            });
        }
        /**
 * ====================================
 * FUNÃ‡Ã•ES DE GESTÃƒO DE CAUTELAS
 * INSERIR ESTE BLOCO ANTES DE 'window.addEventListener('popstate'...'
 * ====================================
 */

/**
 * FunÃ§Ã£o que retorna o HTML do formulÃ¡rio de Nova Cautela (Passo 1/2).
 */
function getNovaCautelaFormHTML() {
    return `
        <div class="op-card" id="form-nova-cautela">
            <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3><i class="fas fa-file-contract"></i> Nova Cautela (Passo 1/2)</h3>
                <button class="btn-modern-action" onclick="showMainMenu()">
                    <i class="fas fa-arrow-left"></i> Voltar ao Menu
                </button>
            </div>
        
            <div class="form-grid-2-columns">
                <div class="form-group">
                    <label for="cautela-destinatario">DestinatÃ¡rio da Cautela (Quem irÃ¡ receber):</label>
                    
                    <div class="custom-select-container">
                        <input type="hidden" id="cautela-destinatario-uid">
                        <input type="text" id="cautela-destinatario" placeholder="Digite o nome, posto ou matrÃ­cula do usuÃ¡rio" required autocomplete="off">
                        <div id="cautela-suggestions-box" class="suggestions-box">
                            <ul id="cautela-suggestions-list">
                                </ul>
                        </div>
                    </div>
       
                </div>
                
                <div class="form-group">
                    <label for="cautela-local-origem">Local de Origem (Sua CustÃ³dia):</label>
                    <select id="cautela-local-origem" required onchange="loadCustodiaItens()">
                        <option value="" disabled selected>Selecione um local...</option>
                    </select>
                </div>
            </div>
        
            <h4 style="margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #800020;">
                <i class="fas fa-clipboard-list"></i> SeleÃ§Ã£o de Materiais
            </h4>
            
            <div id="itens-custodia-list">
                <p class="placeholder-message" style="text-align: center; color: #999;">
                    Por favor, selecione um Local de Origem para listar os itens sob sua custÃ³dia.
                </p>
            </div>
        
            <div class="form-group" style="margin-top: 20px;">
                <label for="cautela-obs">ObservaÃ§Ãµes da Cautela (Opcional):</label>
                <textarea id="cautela-obs" rows="3" placeholder="Adicione detalhes, instruÃ§Ãµes ou a razÃ£o da cautela."></textarea>
            </div>
            
            <button class="btn-create btn-form-action" onclick="iniciarCautelaProcesso()" id="btn-iniciar-cautela" disabled>
                <i class="fas fa-paper-plane"></i> Enviar Cautela (0 itens)
            </button>
        </div>
    `;
}

/**
 * Carrega o formulÃ¡rio de Nova Cautela, escondendo o menu de botÃµes.
 * Chamado pelo botÃ£o "Nova Cautela".
 */
function loadNewCautelaForm() {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');

    if (menuContainer) {
        menuContainer.style.display = 'none';
    }

    if (contentArea) {
        contentArea.innerHTML = getNovaCautelaFormHTML();
        contentArea.style.display = 'block'; 
        
        // --- INSERÃ‡ÃƒO NECESSÃRIA PARA O AUTOCOMPLETE FUNCIONAR ---
        // Ativa os ouvintes de evento para o campo de destinatÃ¡rio imediatamente apÃ³s criar o HTML
        if (typeof setupCautelaDestinatarioListener === 'function') {
            setupCautelaDestinatarioListener();
        }
        // -------------------------------------------------------
        
        // CORREÃ‡ÃƒO DE UI: Adicionar um pequeno atraso para garantir que o DOM esteja pronto 
        setTimeout(() => {
            const obsField = document.getElementById('cautela-obs');
            if (obsField) {
                 // ForÃ§a remoÃ§Ã£o de qualquer bloqueio de leitura
                obsField.removeAttribute('readonly'); 
                obsField.removeAttribute('disabled');
            }
        }, 50);

        loadCustodiaLocais(); 
        loadUsersForSearch();
    }
}
/**
 * Volta para o Menu Principal de Cautelas (os 4 botÃµes).
 * Chamado pelo botÃ£o "Voltar ao Menu" no formulÃ¡rio e no dashboard.
 */
function showMainMenu() {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');

    // 1. Limpa e esconde a Ã¡rea de conteÃºdo (formulÃ¡rio ou dashboard)
    if (contentArea) {
        contentArea.innerHTML = '';
        contentArea.style.display = 'none';
    }

    // 2. Exibe o menu de 4 botÃµes novamente (usando grid para layout responsivo)
    if (menuContainer) {
        menuContainer.style.display = 'grid'; 
    }
}
    function showCautelasDashboard(type) {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');
    if (menuContainer) menuContainer.style.display = 'none';// [cite: 1107]

    if (contentArea) { // [cite: 1109]
        let htmlContent = '';

        if (type === 'Cautelas Ativas') { // [cite: 11.20, 1121]
            htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-clipboard-check"></i> Cautelas Ativas </h3>
                        <button id="btn-back-cautelas" class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Lista de materiais sob sua cautela. Clique em uma linha para ver os detalhes.
                    </p>

                    <div id="loading-cautelas" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando cautelas...
                    </div>

                    <table class="ca-table" id="cautelas-ativas-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>DestinatÃ¡rio</th>
                                <th>EmissÃ£o</th>
                                <th>Local Origem</th>
                                <th>Itens</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="cautelas-ativas-body">
                        </tbody>
                    </table>
                </div>
            `;
            
            // Chamar a funÃ§Ã£o de carregamento logo apÃ³s injetar o HTML
            setTimeout(() => loadActiveCautelas(), 50);// [cite: 1129]

        } else if (type === 'Cautelas a Receber') { // [cite: 1130]
            // NOVO BLOCO: Cautelas a Receber
            htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-inbox"></i> Cautelas a Receber (AÃ§Ã£o Imediata)</h3>
                        <button id="btn-back-cautelas" class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Cautelas emitidas por terceiros que precisam ser confirmadas por vocÃª. 
                    </p>

                    <div id="loading-receive" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando cautelas...
                    </div>

                    <table class="ca-table" id="cautelas-receive-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                               <th>Emitente</th>
                                <th>EmissÃ£o</th>
                                <th>Local Origem</th>
                                <th>Itens</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="cautelas-receive-body"> 
                        </tbody>
                    </table>
                </div>
            `;
            // Chamar a nova funÃ§Ã£o de carregamento logo apÃ³s injetar o HTML
            setTimeout(() => loadCautionsToReceive(), 50);// [cite: 1137, 1138]

        } else if (type === 'HistÃ³rico') { // [cite: 1139]
            // ğŸ›‘ NOVO: Mostra a view HistÃ³rico e carrega os dados
            htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-archive"></i> HistÃ³rico de Cautelas</h3> 
                        <button class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar ao Menu
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Visualize as cautelas finalizadas de acordo com o seu papel na transaÃ§Ã£o. 

                    <div id="historico-abas-operacional" class="tab-navigation" style="display: flex; gap: 5px; margin-bottom: 15px;">
                        <button class="btn-modern-action tab-button active" data-tab="minhas" onclick="loadHistorico('minhas')">
                            Minhas (Dest. Original)
                        </button>
                        <button class="btn-modern-action tab-button" data-tab="devolucao" onclick="loadHistorico('devolucao')">
                            DevoluÃ§Ã£o (Recebidas) 
                        </button>
                        <button class="btn-modern-action tab-button" data-tab="emitidas" onclick="loadHistorico('emitidas')">
                            Emitidas por Mim 
                        </button>
                    </div>
                    
                    <div id="historico-content-container">
                        <div id="loading-historico" style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando histÃ³rico...
                        </div>
                    </div>
                    
                </div>
            `;
            // Chamar a funÃ§Ã£o de carregamento principal (que dispara a aba 'minhas' por padrÃ£o)
            setTimeout(() => loadHistorico('minhas'), 50); // [cite: 1149]

        } else {
            // â¬…ï¸ Adicione este bloco para erros/valores inesperados
            console.warn("View de Cautelas desconhecida:", type); // Corrigido 'view' para 'type'
        }
        
        contentArea.innerHTML = htmlContent; // [cite: 1151]
        contentArea.style.display = 'block';
    }
}
    async function loadUsersForSearch() {
    // 1. BUSCA IRRESTRITA E EXCLUSÃƒO DO PRÃ“PRIO USUÃRIO
    let userQuery = db.collection('usuarios'); 
    const militarLogadoCompleto = currentUserData.nome_militar_completo;

    try {
        const usersSnapshot = await userQuery.get();
        // Zera o array global antes de popular
        allTargetUsers = []; 
        
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            const nomeCompleto = user.nome_militar_completo; 
            
            // Excluir o prÃ³prio usuÃ¡rio logado
            if (nomeCompleto && nomeCompleto !== militarLogadoCompleto) {
                // Salva o objeto completo no array (com ID e nome)
                allTargetUsers.push({
                    id: doc.id, // ğŸ›‘ CRÃTICO: Este Ã© o UID
                    nome: nomeCompleto
                });
            }
        });
        
        // 2. CONFIGURA LISTENERS APÃ“S CARREGAR DADOS
        setupCautelaDestinatarioListener();

    } catch (error) {
        console.error("Erro ao carregar usuÃ¡rios para a busca:", error);
    }
}
		
      function setupCautelaDestinatarioListener() {
    // ReferÃªncias dos elementos
    const input = document.getElementById('cautela-destinatario');
    const suggestionsBox = document.getElementById('cautela-suggestions-box');
    const suggestionsList = document.getElementById('cautela-suggestions-list');
    const uidInput = document.getElementById('cautela-destinatario-uid');

    if (!input || !suggestionsBox || !suggestionsList || !uidInput) {
        console.error("Elementos do Autocomplete de Cautela nÃ£o encontrados. NÃ£o Ã© possÃ­vel configurar o listener.");
        return;
    }

    // ğŸ›‘ 0. CORREÃ‡ÃƒO CRÃTICA DO BLUR/CLICK (MOUSEDOWN)
    // Previne que o campo perca o foco (blur) quando o usuÃ¡rio clica na lista.
    suggestionsBox.addEventListener('mousedown', (event) => {
        if (event.target.closest('li')) {
            event.preventDefault(); // Impede o 'blur' do input, permitindo que o 'click' seja processado.
            // console.log("MOUSEDOWN - BLUR do input temporariamente prevenido.");
        }
    });

    // 1. LISTENER DE DIGITAÃ‡ÃƒO (Filtra e Renderiza)
    input.addEventListener('input', () => {
        const searchTerm = input.value.trim(); // NÃ£o converte para UPPERCASE aqui para usar na RegExp
        suggestionsList.innerHTML = '';
        
        // Limpa o UID e a cor do border ao digitar qualquer coisa nova
        uidInput.value = ''; 
        input.style.borderColor = '#ccc'; 

        if (searchTerm.length < 3) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const searchTermUpper = searchTerm.toUpperCase(); // Termo em caixa alta para a busca
        
        const filteredUsers = allTargetUsers.filter(user => 
            user.nome.toUpperCase().includes(searchTermUpper)
        ).sort((a, b) => a.nome.localeCompare(b.nome));

        if (filteredUsers.length > 0) {
            
            // ğŸ›‘ CRIA A EXPRESSÃƒO REGULAR PARA O DESTAQUE
            // 'gi' = global (todas as ocorrÃªncias) e case-insensitive (ignora caixa alta/baixa)
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            
            let html = '';
            filteredUsers.forEach(user => {
                const fullUserName = user.nome; 
                const safeName = fullUserName.replace(/'/g, "&#39;"); 

                // ğŸ›‘ CORREÃ‡ÃƒO: Usa a regex para substituir a ocorrÃªncia do termo de busca
                // pelo termo envolvido em tags <strong>.
                const highlightedName = fullUserName.replace(regex, '<strong>$1</strong>');
                
                // O layout visual anterior (separando posto/quadro) foi removido
                // para simplificar e garantir que o destaque funcione em qualquer parte do nome.
                
                html += `<li data-user-name="${safeName}" data-uid="${user.id}">
                             <span style="color: #800020;">${highlightedName}</span>
                         </li>`;
            });
            
            suggestionsList.innerHTML = html;
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    // 2. LISTENER DE SELEÃ‡ÃƒO (Preenche o Input e Esconde a Lista)
    suggestionsList.addEventListener('click', (event) => {
        const listItem = event.target.closest('li'); 

        if (listItem) {
            const selectedNameRaw = listItem.getAttribute('data-user-name');
            const selectedUid = listItem.getAttribute('data-uid');
            const selectedName = selectedNameRaw ? selectedNameRaw.replace(/&#39;/g, "'") : '';

            // console.log("SELEÃ‡ÃƒO CLIQUE - Capturado. UID:", selectedUid, " Nome:", selectedName);

            if (selectedName && selectedUid) {
                
                // Preenche os valores
                input.value = selectedName; 
                uidInput.value = selectedUid;
                input.style.borderColor = '#1b8a3e';
                suggestionsBox.style.display = 'none';
                
                // ForÃ§a o foco de volta para o input (complemento do mousedown)
                input.focus(); 
                
                // Dispara o change para revalidaÃ§Ã£o
                input.dispatchEvent(new Event('change'));
                
            } else {
                console.warn("Falha na Captura do Item da Lista: UID ou Nome ausente.");
                uidInput.value = '';
                input.style.borderColor = 'red';
            }
        }
    });

    // 3. LÃ“GICA DE VALIDAÃ‡ÃƒO NO BLUR (Perda de Foco)
    input.addEventListener('blur', () => {
        
        setTimeout(() => {
            suggestionsBox.style.display = 'none';
            
            const finalName = input.value.trim();
            
            // console.log("BLUR VALIDATION - Final Name:", finalName, " UID:", uidInput.value);

            if (finalName.length > 0 && !uidInput.value) {
                
                const isNameValid = allTargetUsers.some(user => user.nome.trim() === finalName);

                if (!isNameValid) {
                    input.value = ''; 
                    input.style.borderColor = 'red';
                    uidInput.value = ''; 
                    // console.warn("BLUR - InvÃ¡lido/NÃ£o selecionado. Campo Limpo.");
                } else {
                    // Fallback
                    const validUser = allTargetUsers.find(user => user.nome.trim() === finalName);
                    if (validUser) {
                        uidInput.value = validUser.id; 
                        input.style.borderColor = '#1b8a3e';
                        // console.log("BLUR - UID preenchido por fallback de nome vÃ¡lido.");
                    } else {
                        input.value = '';
                        input.style.borderColor = 'red';
                        uidInput.value = '';
                    }
                }
            } else if (finalName.length === 0) {
                // Campo vazio, garantir que o UID esteja vazio e resetar a cor
                uidInput.value = '';
                input.style.borderColor = '#ccc';
                // console.log("BLUR - Campo Vazio. Resetado.");
            }
            
        }, 100); 
    });

    // 4. Garante que a caixa reapareÃ§a ao focar se houver texto
    input.addEventListener('focus', () => {
        if (input.value.length >= 3) {
            input.dispatchEvent(new Event('input')); 
        }
    });
}
		
async function loadCustodiaLocais() {
    const selectLocal = document.getElementById('cautela-local-origem');
    const militarUid = firebase.auth().currentUser.uid;

    if (!selectLocal || !militarUid) {
        const fallbackNome = currentUserData.nome_militar_completo || 'UsuÃ¡rio Desconhecido';
        selectLocal.innerHTML = `<option value="" disabled selected>Erro: UsuÃ¡rio (${fallbackNome}) nÃ£o identificado.</option>`;
        return;
    }
    
    selectLocal.disabled = true;
    selectLocal.innerHTML = '<option value="" disabled selected>Carregando locais...</option>';
    
    try {
        // Busca na coleÃ§Ã£o 'custodia_atual' as listas onde o militar logado Ã© o conferente
        const custodyRef = db.collection('custodia_atual');
        const resultsSnapshot = await custodyRef
            .where('conferente_uid', '==', militarUid)
            .get();
        
        // Usamos um Map para garantir que nÃ£o haja duplicidade de IDs de lista
        const locaisMap = new Map();
        
        resultsSnapshot.forEach(doc => {
            const data = doc.data();
            const idRealDaLista = data.lista_id; // "alfa_abt17"
            const nomeExibicao = data.local_nome; // "ALFA - ABT-17"

            if (idRealDaLista && nomeExibicao) {
                locaisMap.set(idRealDaLista, nomeExibicao);
            }
        });
        
        let optionsHtml = '<option value="" disabled selected>Selecione um local...</option>';
        
        if (locaisMap.size === 0) {
            optionsHtml = '<option value="" disabled selected>Nenhum local sob sua custÃ³dia.</option>';
        } else {
            // Converte o Map em Array e ordena pelo Nome legÃ­vel
            const listaOrdenada = Array.from(locaisMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
            
            listaOrdenada.forEach(([id, nome]) => {
                // ğŸ›‘ CORREÃ‡ÃƒO: O 'value' agora Ã© o ID (alfa_abt17) e o texto Ã© o Nome (ALFA - ABT-17)
                optionsHtml += `<option value="${id}">${nome}</option>`;
            });
        }
        
        selectLocal.innerHTML = optionsHtml;
        selectLocal.disabled = false;
        
    } catch (error) {
        console.error("Erro ao carregar locais sob custÃ³dia:", error);
        selectLocal.disabled = false;
        selectLocal.innerHTML = '<option value="" disabled selected>Erro ao carregar locais.</option>';
    }
}
		async function loadCustodiaItens() {
    const selectLocal = document.getElementById('cautela-local-origem');
    const listaId = selectLocal.value; 
    
    const itemListContainer = document.getElementById('itens-custodia-list');
    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    
    itemListContainer.innerHTML = '<p class="placeholder-message" style="text-align: center; color: #800020;">Buscando materiais...</p>';
    if (btnIniciar) btnIniciar.disabled = true;

    if (!listaId) {
        itemListContainer.innerHTML = '<p class="placeholder-message" style="text-align: center; color: #999;">Por favor, selecione um Local de Origem.</p>';
        return;
    }
    
    try {
        const listaDoc = await db.collection('listas_conferencia').doc(listaId).get();
        
        if (!listaDoc.exists) {
            itemListContainer.innerHTML = `<p style="color:red; text-align:center;">Erro: Documento da lista (${listaId}) nÃ£o encontrado.</p>`;
            return;
        }

        const listaMestra = listaDoc.data().list || [];
        let htmlContent = '<div class="inventory-accordion-container">';
        let totalGeralDisponivel = 0;
        let isFirst = true;

        listaMestra.forEach(setor => {
            const setorItems = (setor.itens || []);

            // ğŸ›‘ CÃLCULO UNIFICADO DE DISPONIBILIDADE (Igual ao App de ConferÃªncia)
            const setorTotal = setorItems.reduce((acc, item) => {
                if (item.tipo === 'single') {
                    const esperado = Number(item.quantidadeEsperada || item.quantidade) || 0;
                    const cautelado = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                    // â¬‡ï¸ NOVA LÃ“GICA: Abate tambÃ©m pendÃªncias de conferÃªncia nÃ£o resolvidas
                    const pendente = (item.pendencias_ids || []).reduce((sum, p) => sum + (Number(p.quantidade) || 0), 0);
                    
                    const saldo = esperado - cautelado - pendente;
                    return acc + (saldo > 0 ? saldo : 0);
                } else if (item.tipo === 'multi') {
                    // â¬‡ï¸ NOVA LÃ“GICA: SÃ³ conta se nÃ£o tiver cautela E nÃ£o tiver pendÃªncias de conferÃªncia no tombamento
                    return acc + (item.tombamentos || []).filter(t => !t.cautela && (!t.pendencias_ids || t.pendencias_ids.length === 0)).length;
                }
                return acc;
            }, 0);

            if (setorTotal <= 0) return;
            totalGeralDisponivel += setorTotal;

            const contentId = `content-${setor.id}`;
            htmlContent += `
                <div class="${isFirst ? 'accordion-header active' : 'accordion-header'}" onclick="toggleAccordion(this, '${contentId}')">
                    <span>${setor.nome} (${setorTotal} disponÃ­veis)</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" id="${contentId}" style="${isFirst ? 'max-height: 1500px;' : ''}">
                    <div class="items-card-grid">`;

            setorItems.forEach(item => {
                if (item.tipo === 'single') {
                    const totalEsperado = Number(item.quantidadeEsperada || item.quantidade) || 0;
                    const totalCautelado = (item.cautelas || []).reduce((sum, c) => sum + (Number(c.quantidade) || 0), 0);
                    // â¬‡ï¸ Abatimento de pendÃªncias para o saldo individual do card
                    const totalPendente = (item.pendencias_ids || []).reduce((sum, p) => sum + (Number(p.quantidade) || 0), 0);
                    
                    const saldoDisponivel = totalEsperado - totalCautelado - totalPendente;

                    if (saldoDisponivel > 0) {
                        htmlContent += `
                            <div class="item-selection-card" data-item-id="${item.id}">
                                <h4 class="item-card-title"><i class="fas fa-boxes"></i> ${item.nome}</h4>
                                <div class="qtd-control-wrapper">
                                    <label>
                                        <input type="checkbox" name="cautela-item-base" 
                                               data-id="${item.id}" data-nome="${item.nome}" data-tipo="single" data-max-qtd="${saldoDisponivel}"
                                               onchange="toggleItemQuantity(this); updateCautelaItemCount();"> Selecionar
                                    </label>
                                    <input type="number" class="input-qtd-cautela" data-item-id="${item.id}" 
                                           min="1" max="${saldoDisponivel}" value="1" disabled style="width: 60px;">
                                </div>
                                <small style="color:#a00030; font-weight: bold;">DisponÃ­vel: ${saldoDisponivel} de ${totalEsperado}</small>
                            </div>`;
                    }
                } else if (item.tipo === 'multi' && item.tombamentos?.length > 0) {
                    // â¬‡ï¸ Filtra tombamentos que possuem pendÃªncias ativas (carimbos vermelhos)
                    const tags = (item.tombamentos || []).map(t => {
                        const isC = !!t.cautela;
                        const hasP = (t.pendencias_ids && t.pendencias_ids.length > 0);
                        const bloqueado = isC || hasP;
                        const motivoBloqueio = isC ? 'Cautelado' : (hasP ? 'Com PendÃªncia' : 'Livre');

                        return `
                            <div class="tombamento-tag ${bloqueado ? 'cautelado' : ''}" title="${motivoBloqueio}">
                                <input type="checkbox" name="cautela-item-multi" 
                                       data-id="${item.id}-${t.tomb}" data-id-base="${item.id}" data-tombamento="${t.tomb}" 
                                       data-nome="${item.nome}" data-tipo="multi" 
                                       onchange="updateCautelaItemCount();" ${bloqueado ? 'disabled' : ''}>
                                ${t.tomb} ${bloqueado ? `<i class="fas fa-lock" style="color: ${hasP ? '#d90f23' : '#800020'};"></i>` : ''}
                            </div>`;
                    }).join('');

                    // SÃ³ renderiza o card se houver algum tombamento nÃ£o bloqueado
                    if (tags.includes('type="checkbox"')) {
                        htmlContent += `
                            <div class="item-selection-card">
                                <h4 class="item-card-title"><i class="fas fa-shield-alt"></i> ${item.nome}</h4>
                                <div class="tombamento-tag-list">${tags}</div>
                            </div>`;
                    }
                }
            });
            htmlContent += '</div></div>';
            isFirst = false;
        });

        if (totalGeralDisponivel === 0) {
            itemListContainer.innerHTML = '<p style="color:green; padding:20px; text-align:center;">âœ… Nenhum material disponÃ­vel para cautela (itens com pendÃªncia ou cautelados).</p>';
        } else {
            itemListContainer.innerHTML = htmlContent + '</div>';
            document.querySelectorAll('.input-qtd-cautela').forEach(el => {
                el.addEventListener('input', updateCautelaItemCount);
            });
            updateCautelaItemCount();
        }

    } catch (error) {
        console.error("Erro ao carregar itens:", error);
        itemListContainer.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar materiais.</p>';
    }
}
        
function updateCardClass(card) {
    if (!card) return;
    const isMulti = card.getAttribute('data-tipo') === 'multi';
    let isChecked = false;

    if (isMulti) {
        // Para itens multi, verifica se pelo menos um tombamento estÃ¡ checado
        const checkedTombamentos = card.querySelectorAll('input[name="cautela-item-multi"]:checked');
        isChecked = checkedTombamentos.length > 0;

        // Atualiza a classe de cada tag individualmente
        card.querySelectorAll('.tombamento-tag input[type="checkbox"]').forEach(chk => {
            if (chk.checked) {
                chk.closest('.tombamento-tag').classList.add('selected');
            } else {
                chk.closest('.tombamento-tag').classList.remove('selected');
            }
        });
        
    } else {
        // Para itens single, verifica o checkbox principal
        const mainCheckbox = card.querySelector('input[name="cautela-item-base"]');
        isChecked = mainCheckbox && mainCheckbox.checked;
    }
    
    if (isChecked) {
        card.classList.add('selected');
    } else {
        card.classList.remove('selected');
    }
}

/**
 * LÃ³gica do AcordeÃ£o: Mostra ou esconde o conteÃºdo do setor.
 * @param {HTMLElement} header - O cabeÃ§alho clicado.
 * @param {string} contentId - O ID do conteÃºdo a ser expandido/colapsado.
 */
function toggleAccordion(header, contentId) {
    const content = document.getElementById(contentId);
    
    // 1. Alterna a classe 'active' no cabeÃ§alho
    header.classList.toggle('active');
    
    // 2. Controla o max-height para animaÃ§Ã£o de acordeÃ£o
    if (content.style.maxHeight !== '0px' && content.style.maxHeight !== '') {
        content.style.maxHeight = '0px';
    } else {
        // Define uma altura suficientemente grande para conter o conteÃºdo
        content.style.maxHeight = content.scrollHeight + 50 + 'px'; 
    }
}

/**
 * Atualiza o texto do botÃ£o de iniciar cautela com a contagem de itens selecionados.
 */
function updateCautelaItemCount() {
    let selectedCount = 0;
    // REINICIALIZA O ARRAY GLOBAL (Garante que a funÃ§Ã£o de envio veja os dados novos)
    cautelaItensSelecionados = []; 
    
    // 1. Processar itens com Tombamento (tipo 'multi')
    document.querySelectorAll('input[name="cautela-item-multi"]:checked').forEach(chk => {
        const idBase = chk.getAttribute('data-id-base');
        const tombamento = chk.getAttribute('data-tombamento');
        const nomeCompleto = chk.getAttribute('data-nome') || "";

        // Remove "(Tomb: ...)" do nome se ele jÃ¡ existir, para nÃ£o salvar duplicado
        const nomeLimpo = nomeCompleto.replace(/\s\(Tomb:\s[^\)]+\)/i, '').trim();

        if (idBase && tombamento) {
            cautelaItensSelecionados.push({
                id: `${idBase}-${tombamento}`, 
                id_base: idBase,
                nome: nomeLimpo,
                tombamento: tombamento,
                quantidade: 1,
                tipo: 'multi'
            });
            selectedCount++;
        }
    });
    
    // 2. Processar itens Ãšnicos (tipo 'single')
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        const card = chk.closest('.item-selection-card');
        if (!card) return;
        
        const inputQtd = card.querySelector('.input-qtd-cautela');
        const id = chk.getAttribute('data-id');
        const nome = chk.getAttribute('data-nome');

        let qtd = 1;
        if (inputQtd && !inputQtd.disabled) {
            qtd = parseInt(inputQtd.value) || 0;
            const max = parseInt(inputQtd.getAttribute('max')) || 0;
            
            if (qtd > max) {
                alert(`A quantidade mÃ¡xima disponÃ­vel para ${nome} Ã© ${max}.`);
                inputQtd.value = max;
                qtd = max;
            }
            
            if (qtd < 1) {
                chk.checked = false;
                inputQtd.disabled = true;
                return; 
            }
        }

        if (id) {
            cautelaItensSelecionados.push({
                id: id,
                id_base: id,
                nome: nome,
                quantidade: qtd,
                tipo: 'single'
            });
            selectedCount += qtd;
        }
    });

    // 3. Atualizar Interface do BotÃ£o
    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    if (btnIniciar) {
        btnIniciar.innerHTML = `<i class="fas fa-paper-plane"></i> Enviar Cautela (${selectedCount} itens)`;
        // O botÃ£o sÃ³ habilita se houver itens no array global
        btnIniciar.disabled = (selectedCount <= 0);
    }
}
        function toggleItemQuantity(checkbox) {
    // ğŸ›‘ CORREÃ‡ÃƒO: Usar .item-selection-card como elemento pai mais prÃ³ximo ğŸ›‘
    const card = checkbox.closest('.item-selection-card'); 
    if (!card) return; // Se o card nÃ£o for encontrado (seguranÃ§a)

    const inputQtd = card.querySelector('.input-qtd-cautela');

    if (inputQtd) {
        inputQtd.disabled = !checkbox.checked;
        
        // Garante que o valor seja pelo menos 1 quando marcado
        if (checkbox.checked) {
             if (parseInt(inputQtd.value) < 1 || isNaN(parseInt(inputQtd.value))) {
                 inputQtd.value = 1;
             }
        } else {
             // Se desmarcado, reseta o valor para o mÃ¡ximo (ou outro valor de reset)
             inputQtd.value = inputQtd.getAttribute('max');
        }
    }
}
        async function getListaIdFromLocalName(localNomeCompleto) {
    // Busca o documento 'rotas' onde estÃ¡ o mapeamento dos nomes de local para os IDs.
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    for (const [id, info] of Object.entries(rotas)) {
        // Recria o nome completo para comparaÃ§Ã£o (Ex: "ALFA - PERMANÃŠNCIA")
        const nomeCompletoRota = `${info.posto} - ${info.nome}`;
        if (nomeCompletoRota === localNomeCompleto) {
            return id;
        }
    }
    return null; // Retorna null se nÃ£o encontrar o mapeamento
}


/**
 * Coleta todos os dados dos itens selecionados (incluindo as quantidades dos inputs number).
 */
function getSelectedCautelaItemsData() {
    const itens = [];
    
    // 1. Coleta itens com Tombamento (tipo 'multi')
    document.querySelectorAll('input[name="cautela-item-multi"]:checked').forEach(chk => {
        // Captura direta dos atributos que definimos no loadCustodiaItens
        const idBase = chk.getAttribute('data-id-base');
        const tombamentoReal = chk.getAttribute('data-tombamento');
        const nomeOriginal = chk.getAttribute('data-nome') || "";
        
        // Limpa o nome para nÃ£o salvar o texto "(Tomb: ...)" dentro do campo nome no banco
        const nomeLimpo = nomeOriginal.replace(/\s\(Tomb:\s[^\)]+\)/i, '').trim();

        if (idBase && tombamentoReal) {
            itens.push({
                id: `${idBase}-${tombamentoReal}`, // ID composto para controle
                id_base: idBase,                   // ID do documento na lista mestra
                tombamento: tombamentoReal,        // O nÃºmero do tombamento
                nome: nomeLimpo,
                quantidade: 1,                     // Multi Ã© sempre 1 por linha
                tipo: 'multi'
            });
        }
    });

    // 2. Coleta itens Ãšnicos (tipo 'single')
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        const card = chk.closest('.item-selection-card');
        if (!card) return; 

        const inputQtd = card.querySelector('.input-qtd-cautela');
        const idBase = chk.getAttribute('data-id');
        const nome = chk.getAttribute('data-nome');
        const maxPermitido = parseInt(chk.getAttribute('data-max-qtd')) || 0;
        
        let qtd = parseInt(inputQtd.value) || 0;
        
        // ValidaÃ§Ã£o de seguranÃ§a para garantir que a quantidade Ã© real e permitida
        if (qtd > 0 && qtd <= maxPermitido) {
            itens.push({
                id: idBase,       // Para single, o ID Ãºnico Ã© o prÃ³prio ID base
                id_base: idBase,
                nome: nome,
                quantidade: qtd,
                tipo: 'single'
            });
        }
    });

    return itens;
}
        // LocalizaÃ§Ã£o: Aproximadamente linha 1197
// A funÃ§Ã£o iniciarCautelaProcesso original no sigma_dashboard.txt serÃ¡ modificada.

async function iniciarCautelaProcesso() {
    const localId = document.getElementById('cautela-local-origem').value;
    const destinatarioUid = document.getElementById('cautela-destinatario-uid').value;
    const destinatarioNome = document.getElementById('cautela-destinatario').value;
    const obsEmissao = document.getElementById('cautela-obs')?.value || "";
    
    if (!localId || !destinatarioUid || cautelaItensSelecionados.length === 0) {
        alert("Preencha todos os campos e selecione ao menos um item.");
        return;
    }

    const btn = document.getElementById('btn-iniciar-cautela');
    btn.disabled = true; btn.textContent = "Processando...";

    try {
        // --- ğŸ›‘ BUSCA CIRÃšRGICA NA ROTA PARA NOME AMIGÃVEL ---
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const rotaInfo = rotas[localId];
        
        // Monta o nome amigÃ¡vel no padrÃ£o "POSTO - NOME"
        const nomeAmigavelLocal = rotaInfo ? `${rotaInfo.posto} - ${rotaInfo.nome}` : "Local N/D";
        const unidadeOrigem = rotaInfo ? rotaInfo.unidade : "";
        // ----------------------------------------------------

        const cautelaId = "CAUTELA-" + Math.floor(10000000 + Math.random() * 90000000);
        const emitenteNome = `${currentUserData.posto} ${currentUserData.quadro} ${currentUserData.nome_guerra}`;
        const dataAtual = new Date().toLocaleString('pt-BR');

        const novaCautela = {
            cautela_id: cautelaId,
            emitente_uid: firebase.auth().currentUser.uid,
            emitente: emitenteNome,
            destinatario_original_uid: destinatarioUid,
            destinatario_original_nome: destinatarioNome,
            destinatario_uid: destinatarioUid, // Define destinatÃ¡rio atual inicial
            local_origem_id: localId,
            local_origem: nomeAmigavelLocal, // â¬…ï¸ AGORA SALVA O NOME AMIGÃVEL VIA ROTA
            unidade_origem: unidadeOrigem,   // â¬…ï¸ SALVA A UNIDADE PARA GESTÃƒO
            status: 'ABERTA',
            timestamp_emissao: firebase.firestore.FieldValue.serverTimestamp(),
            observacoes_emissao: obsEmissao,
            itens: cautelaItensSelecionados
        };

        const listaRef = db.collection('listas_conferencia').doc(localId);

        await db.runTransaction(async (transaction) => {
            const listaDoc = await transaction.get(listaRef);
            if (!listaDoc.exists) throw new Error("Lista nÃ£o encontrada.");

            let list = listaDoc.data().list;

            list = list.map(setor => ({
                ...setor,
                itens: setor.itens.map(mItem => {
                    const selecoes = cautelaItensSelecionados.filter(c => c.id_base === mItem.id);
                    
                    if (selecoes.length > 0) {
                        if (!mItem.historico_vida) mItem.historico_vida = [];
                        
                        selecoes.forEach(sel => {
                            const carimbo = {
                                id: cautelaId,
                                destinatario: destinatarioNome,
                                data: dataAtual,
                                quantidade: Number(sel.quantidade) || 1
                            };

                            mItem.historico_vida.push({
                                evento: "SAIDA_CAUTELA", id_doc: cautelaId, quem: emitenteNome, data: dataAtual,
                                detalhes: `SaÃ­da de ${carimbo.quantidade}un para ${destinatarioNome}`
                            });

                            if (mItem.tipo === 'multi' && sel.tombamento) {
                                mItem.tombamentos = mItem.tombamentos.map(t => {
                                    if (t.tomb === sel.tombamento) t.cautela = carimbo;
                                    return t;
                                });
                            } else {
                                if (!mItem.cautelas) mItem.cautelas = [];
                                mItem.cautelas.push(carimbo);
                            }
                        });
                    }
                    return mItem;
                })
            }));

            transaction.set(db.collection('cautelas_abertas').doc(cautelaId), novaCautela);
            transaction.update(listaRef, { list });
        });

        alert(`âœ… Cautela ${cautelaId} enviada com sucesso!`);
        location.reload();

    } catch (e) {
        console.error(e);
        alert("Erro ao emitir cautela: " + e.message);
        btn.disabled = false;
        btn.textContent = "Enviar Cautela";
    }
}
		
function findItemInList(lista, itemIdBase) {
    for (const setor of lista) {
        for (const item of setor.itens) {
            if (item.id === itemIdBase) {
                return item;
            }
        }
    }
    return null;
}
        /**
 * FunÃ§Ã£o robusta para encontrar o objeto item base (mItem) na lista mestra
 * dado um tombamento especÃ­fico dentro de seu array de tombamentos.
 * @param {Array} lista - O array listaMestra.
 * @param {string} tombamentoReal - O valor do tombamento a ser procurado (Ex: '511.524').
 * @returns {object|null} O objeto mItem ou null.
 */
function findItemByTombamento(lista, tombamentoReal) {
    for (const setor of lista) {
        for (const item of setor.itens) {
            if (item.tipo === 'multi' && item.tombamentos) {
                // Verifica se algum dos tombamentos possui o valor real
                const foundTomb = item.tombamentos.find(tomb => tomb.tomb === tombamentoReal);
                if (foundTomb) {
                    return item; // Retorna o mItem (item base) que contÃ©m o tombamento
                }
            }
        }
    }
    return null;
}
        /**
 * Busca e exibe as cautelas ativas.
 * Exibe todas as cautelas da unidade para Gestores/Admin,
 * e apenas as emitidas para/pelo usuÃ¡rio logado para Operacionais.
 */
// LocalizaÃ§Ã£o: FunÃ§Ã£o loadActiveCautelas (aprox. linha 1132)

async function loadActiveCautelas() {
    const tbody = document.getElementById('cautelas-ativas-body');
    const loading = document.getElementById('loading-cautelas');
    const table = document.getElementById('cautelas-ativas-table');
    if (!tbody || !loading || !table) return;
    const role = currentUserData.role || 'operacional';

    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        const user = currentUserData;
        
        // Estrutura para os subgrupos
        const grupos = {
            custodiaAtiva: { title: 'CustÃ³dia Ativa (Itens sob sua responsabilidade)', data: [] },
            rastreioPessoal: { title: 'Meus Envios em TrÃ¢nsito (Acompanhamento)', data: [] },
            monitoramento: { title: 'Monitoramento Gerencial/Global', data: [] },
        };
        
        const renderedIds = new Set();
        
        // --- 1. CONFIGURAÃ‡ÃƒO E EXECUÃ‡ÃƒO DAS BUSCAS ---

        // A. Pessoal: CustÃ³dia Ativa (RECEBIDA como destinatÃ¡rio)
        if (role === 'operacional' || role === 'gestor') {
            const militarCompleto = currentUserData.nome_militar_completo;
        
            // --- 1. GRUPO CUSTÃ“DIA ATIVA (APENAS POSSE ATIVA) ---
            
            // A. CUSTÃ“DIA ATIVA: RECEBIDA (DestinatÃ¡rio)
            // Somente itens que estÃ£o sob POSSE ATIVA.
            grupos.custodiaAtiva.data = await queryCautelas(['RECEBIDA'], role, user, 'destinatario', 'personal');
            grupos.custodiaAtiva.data.forEach(c => renderedIds.add(c.cautela_id));
            
            // --- 2. GRUPO RASTREIO PESSOAL (REMETENTE E REVERSOR) ---

            // B. RASTREIO PESSOAL - PARTE 1: Emitente (ABERTA, RECEBIDA, DEVOLUÃ‡ÃƒO)
            // Rastreamento para itens que ele EMITIU.
            const rastreioEmitente = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÃ‡ÃƒO'], role, user, 'emitente', 'personal');

            // C. RASTREIO PESSOAL - PARTE 2: Reversor (DEVOLUÃ‡ÃƒO)
            // Rastreamento para itens que ele DEVOLVEU (e precisa acompanhar o retorno).
            const rastreioReversor = await queryCautelas(['DEVOLUÃ‡ÃƒO'], role, user, 'militar_completo_reversor', 'personal');
            
            // Concatena as duas listas de rastreio
            let rastreioRaw = [...rastreioEmitente, ...rastreioReversor];

            // ğŸ›‘ CORREÃ‡ÃƒO: Desduplica o array rastreioRaw internamente, usando Map ğŸ›‘
            const uniqueRastreio = new Map();
            rastreioRaw.forEach(c => uniqueRastreio.set(c.cautela_id, c));
            const rastreioDesduplicado = Array.from(uniqueRastreio.values());
            
            // Remove itens que jÃ¡ estÃ£o na CustÃ³dia Ativa (filtro contra o outro grupo)
            grupos.rastreioPessoal.data = rastreioDesduplicado.filter(c => !renderedIds.has(c.cautela_id));
            grupos.rastreioPessoal.data.forEach(c => renderedIds.add(c.cautela_id));
        }
        
        // C. Gerencial/Admin: Monitoramento da Unidade/Global
        if (role === 'gestor' || role === 'admin') {
            
            if (role === 'gestor') {
                // ğŸ›‘ CORREÃ‡ÃƒO CRÃTICA PARA GESTOR (Evitar duplo 'in') ğŸ›‘
                const unitListIds = await getUnitListIds();
                let monitoramentoRaw = [];
                const statuses = ['ABERTA', 'RECEBIDA', 'DEVOLUÃ‡ÃƒO'];
                
                grupos.monitoramento.title = 'Monitoramento da Unidade (Material sob sua gestÃ£o)';
                
                // Verifica se hÃ¡ IDs de lista e se estamos dentro do limite de 10 do 'in'
                if (unitListIds.length > 0 && unitListIds.length <= 10) {
                    
                    // 1. Executa a consulta APENAS com o filtro 'local_origem_id' ('in')
                    let queryRef = db.collection('cautelas_abertas')
                        .where('local_origem_id', 'in', unitListIds)
                        .orderBy('timestamp_emissao', 'desc');

                    const snapshot = await queryRef.get();
                    snapshot.forEach(doc => {
                        const cautela = { id: doc.id, ...doc.data() };
                        
                        // 2. Filtra por status ABERTA, RECEBIDA, DEVOLUÃ‡ÃƒO na MEMÃ“RIA
                        if (statuses.includes(cautela.status)) {
                            monitoramentoRaw.push(cautela);
                        }
                    });
                    
                } else if (unitListIds.length > 10) {
                     console.error("ALERTA: Gestor tem mais de 10 Listas. Filtro de unidade estÃ¡ incompleto.");
                } else {
                     // Nenhum ID de lista, Monitoramento vazio.
                }

                grupos.monitoramento.data = monitoramentoRaw;
                
            } else { // role === 'admin'
                grupos.monitoramento.title = 'Monitoramento Global (ADMIN)';
                // Admin pode usar o 'in' para status, pois nÃ£o usa o 'in' para local_origem_id
                grupos.monitoramento.data = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLUÃ‡ÃƒO'], role, user, null, 'unit');
            }
            
            // Remove itens que jÃ¡ foram vistos nos grupos pessoais (APÃ“S A BUSCA)
            grupos.monitoramento.data = grupos.monitoramento.data.filter(c => !renderedIds.has(c.cautela_id));
        }
        
        // --- 2. CONSOLIDAÃ‡ÃƒO E RENDERIZAÃ‡ÃƒO NA TABELA ---
        let htmlContent = '';
        const allGroups = [grupos.custodiaAtiva, grupos.rastreioPessoal, grupos.monitoramento];
        let totalCautelas = 0;

        allGroups.forEach(group => {
            if (group.data.length > 0) {
                totalCautelas += group.data.length;
                
                // Adiciona o cabeÃ§alho do subgrupo (usando colspan para mesclar a linha)
                htmlContent += `
                    <tr class="group-header">
                        <td colspan="6" class="group-title-cell" data-label="">
                            <i class="fas fa-folder-open"></i> <strong>${group.title}</strong> (${group.data.length})
                        </td>
                    </tr>
                `;

                // Renderiza as linhas de dados (usando a nova funÃ§Ã£o auxiliar)
                group.data.forEach(cautela => {
                    htmlContent += renderCautelaRow(cautela); 
                });
            }
        });

        // --- 3. EXIBIÃ‡ÃƒO FINAL ---
        if (totalCautelas === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:20px;">Nenhuma cautela ativa encontrada sob sua responsabilidade.</td></tr>`;
        } else {
            tbody.innerHTML = htmlContent;
        }

        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas ativas:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
       
        async function loadCautionsToReceive() {
    const tbody = document.getElementById('cautelas-receive-body');
    const loading = document.getElementById('loading-receive');
    const table = document.getElementById('cautelas-receive-table');
    
    // ConfiguraÃ§Ãµes de exibiÃ§Ã£o inicial
    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        const role = currentUserData.role || 'operacional';
        const user = currentUserData;
        
        // Statuses de AÃ§Ã£o Pessoal: ABERTA e DEVOLUÃ‡ÃƒO
        const statusesToReceive = ['ABERTA', 'DEVOLUÃ‡ÃƒO'];
        
        // Busca: Filtra pelo 'destinatario' e usa escopo 'personal' para TODOS os perfis (Operacional, Gestor, Admin).
        // Isso implementa a regra de que esta aba Ã© APENAS para AÃ‡ÃƒO PESSOAL.
        const cautionsToReceive = await queryCautelas(
            statusesToReceive, 
            role, 
            user, 
            'destinatario',    
            'personal'         
        );

        // --- RENDERIZAÃ‡ÃƒO ---
        
        if (cautionsToReceive.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#1b8a3e; padding:20px;">âœ… Nenhuma cautela pendente de recebimento.</td></tr>`;
        } else {
            let htmlContent = '';
            cautionsToReceive.forEach(cautela => {
                htmlContent += renderCautelaRow(cautela); 
            });
            tbody.innerHTML = htmlContent;
        }

        // --- FINALIZAÃ‡ÃƒO DA EXIBIÃ‡ÃƒO ---
        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas a receber:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
        async function showCautelaDetails(cautelaId) {
    const modal = document.getElementById('cautelaDetailsModal');
    const btnReceber = document.getElementById('btn-receber-cautela');
    const btnDevolver = document.getElementById('btn-devolver-cautela');
    const btnConfirmarDevolucao = document.getElementById('btn-confirmar-devolucao');
    const btnSubstituir = document.getElementById('btn-reportar-problema');
    
    document.getElementById('modal-cautela-id').textContent = cautelaId;
    modal.style.display = 'flex';
    
    [btnReceber, btnDevolver, btnConfirmarDevolucao, btnSubstituir].forEach(b => { if(b) b.style.display = 'none'; });

    try {
        const docRef = db.collection('cautelas_abertas').doc(cautelaId);
        const doc = await docRef.get();
        if (!doc.exists) return alert("Erro: Cautela nÃ£o encontrada.");

        let cautela = doc.data(); 
        const currentStatus = cautela.status || 'N/D';
        const meuUid = firebase.auth().currentUser.uid;

        // --- LÃ“GICA DE PENDÃŠNCIAS PARA BLOQUEIO VISUAL ---
        const pendencias = cautela.pendencias_ativas || [];
        const temPendencia = pendencias.length > 0;

        let donoProvisorioNome = "Aguardando DevoluÃ§Ã£o";
        let destaqueRecebedor = ""; 
        
        if (currentStatus === 'RECEBIDA' && cautela.local_origem_id) {
            const custodyDoc = await db.collection('custodia_atual').doc(cautela.local_origem_id).get();
            if (custodyDoc.exists) {
                donoProvisorioNome = custodyDoc.data().conferente_completo || "Dono nÃ£o identificado";
                if (meuUid !== cautela.destinatario_uid) {
                    destaqueRecebedor = `<span style="background-color: #fff5f5; color: #800020; padding: 4px 10px; border-radius: 6px; border: 1.5px solid #800020; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-hand-holding"></i> ${donoProvisorioNome}
                                         </span>`;
                }
            }
        }

        const getUpdatedName = async (uid, fallbackName) => {
             if (uid) {
                const userData = await getUserInfoByUid(uid);
                return userData ? userData.nome_militar_completo : fallbackName || 'N/D';
            }
            return fallbackName || 'N/D';
        };

        document.getElementById('modal-emitente').textContent = await getUpdatedName(cautela.emitente_uid, cautela.emitente);
        document.getElementById('modal-destinatario-original').textContent = await getUpdatedName(cautela.destinatario_original_uid, cautela.destinatario_original_nome);
        document.getElementById('modal-destinatario-atual').innerHTML = destaqueRecebedor || donoProvisorioNome;
        document.getElementById('modal-local-origem').textContent = cautela.local_origem || 'N/D';
        document.getElementById('modal-data-emissao').textContent = cautela.timestamp_emissao ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        document.getElementById('modal-obs-emissao').textContent = cautela.observacoes_emissao || 'Nenhuma observaÃ§Ã£o.';
        
        const statusTextElement = document.getElementById('modal-status-text');
        if (statusTextElement) {
            statusTextElement.textContent = currentStatus;
            let color = (currentStatus === 'ABERTA') ? "#f57c00" : (currentStatus === 'RECEBIDA') ? "#2e7d32" : "#c62828";
            statusTextElement.style.cssText = `background: ${color}; color: white; padding: 2px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85em; text-transform: uppercase;`;
        }

        const histContainer = document.getElementById('modal-historico-movimentacoes');
        if (cautela.historico_movimentacoes && cautela.historico_movimentacoes.length > 0) {
            histContainer.innerHTML = cautela.historico_movimentacoes.map(h => `
                <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                    <strong style="color:#800020;">${h.data || ''}:</strong> 
                    <div style="white-space: pre-line; font-size: 0.95em; color: #333; margin-top: 5px;">
                        ${h.descricao || h.mensagem || h.detalhes || ''}
                    </div>
                    <small style="color:#666; font-style:italic; display: block; margin-top: 5px;">
                        Por: ${h.militar || h.autor || h.quem || 'N/D'}
                    </small>
                </div>
            `).join('');
        } else {
            histContainer.innerHTML = '<p style="color: #999; text-align: center; margin: 5px 0;">Nenhuma movimentaÃ§Ã£o registrada.</p>';
        }

        const itensList = document.getElementById('modal-itens-cautela');
        itensList.innerHTML = '';
        if (cautela.itens) {
            cautela.itens.forEach((item, idx) => {
                const li = document.createElement('li');
                li.style.cssText = `display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-bottom:1px solid #eee; background-color: ${idx % 2 !== 0 ? '#f2f2f2' : 'transparent'}; font-size: 0.9em;`;
                
                // ğŸ›‘ LÃ“GICA DO ÃCONE DE ALERTA NO ITEM ğŸ›‘
                const pDoItem = pendencias.find(p => p.item_index === idx);
                let htmlAlerta = "";
                if (pDoItem) {
                    htmlAlerta = `<i class="fas fa-exclamation-triangle" style="color: #f57c00; margin-left: 8px; cursor: help;" title="Aguardando AnÃ¡lise: ${pDoItem.motivo}"></i>`;
                }

                const temTombamentoReal = item.tombamento && item.tombamento !== "" && item.tombamento !== item.nome;
                const qtdExibicao = item.quantidade !== undefined ? item.quantidade : 1;
                const rotulo = temTombamentoReal 
                    ? `<b style="color: #800020;">Tomb.:</b> ${item.tombamento}` 
                    : `<b style="color: #800020;">QTD:</b> ${qtdExibicao}UN`;
                
                li.innerHTML = `<span>${idx + 1}. ${item.nome}${htmlAlerta}</span> <span>${rotulo}</span>`;
                itensList.appendChild(li);
            });
        }

        // --- BLOQUEIO VISUAL DO BOTÃƒO DE DEVOLUÃ‡ÃƒO ---
        if (currentStatus === 'ABERTA' && cautela.destinatario_original_uid === meuUid) {
            if (btnReceber) { btnReceber.style.display = 'block'; btnReceber.onclick = () => iniciarRecebimentoCautela(cautelaId); }
        } 
        else if (currentStatus === 'RECEBIDA' && (cautela.destinatario_uid === meuUid || cautela.destinatario_original_uid === meuUid)) {
            if (btnDevolver) { 
                btnDevolver.style.display = 'block'; 
                if (temPendencia) {
                    // Estado Desativado/Bloqueado
                    btnDevolver.disabled = true;
                    btnDevolver.style.opacity = "0.5";
                    btnDevolver.style.cursor = "not-allowed";
                    btnDevolver.title = "A devoluÃ§Ã£o estÃ¡ bloqueada porque existem itens com problemas aguardando anÃ¡lise do Gestor.";
                    btnDevolver.innerHTML = `<i class="fas fa-lock"></i> DevoluÃ§Ã£o Bloqueada`;
                } else {
                    // Estado Normal
                    btnDevolver.disabled = false;
                    btnDevolver.style.opacity = "1";
                    btnDevolver.style.cursor = "pointer";
                    btnDevolver.title = "";
                    btnDevolver.innerHTML = `<i class="fas fa-undo"></i> Iniciar DevoluÃ§Ã£o`;
                    btnDevolver.onclick = () => iniciarDevolucaoCautela(cautelaId, donoProvisorioNome); 
                }
            }
            if (btnSubstituir) { btnSubstituir.style.display = 'block'; }
        }
        else if (currentStatus === 'DEVOLUÃ‡ÃƒO' && cautela.destinatario_uid === meuUid) {
            if (btnConfirmarDevolucao) { btnConfirmarDevolucao.style.display = 'block'; btnConfirmarDevolucao.onclick = () => iniciarConferenciaDevolucao(cautelaId, currentUserData.nome_militar_completo); }
        }

    } catch (e) {
        console.error("Erro no modal:", e);
    }
}
		// FunÃ§Ã£o para mostrar/esconder campo de quantidade no modal de reporte
function fecharModalReporte() {
    document.getElementById('modalReportarItem').style.display = 'none';
    showCautelaDetails(cautelaIdAtualParaReporte); // Reabre o detalhe ao cancelar
}

async function iniciarFluxoSubstituicao() {
    const cautelaId = document.getElementById('modal-cautela-id').textContent;
    cautelaIdAtualParaReporte = cautelaId;

    try {
        const doc = await db.collection('cautelas_abertas').doc(cautelaId).get();
        if (!doc.exists) return alert("Erro: Cautela nÃ£o encontrada.");

        const data = doc.data();
        itensDaCautelaAtual = data.itens || [];
        const pendenciasAtivas = data.pendencias_ativas || [];
        const indicesBloqueados = pendenciasAtivas.map(p => p.item_index);

        let unidadeAlvo = data.unidade_destino || "";
        if (!unidadeAlvo && data.local_origem_id) {
            const rotasDoc = await db.collection('config_geral').doc('rotas').get();
            const rotas = rotasDoc.data() || {};
            if (rotas[data.local_origem_id]) unidadeAlvo = rotas[data.local_origem_id].unidade;
        }
        if (!unidadeAlvo) unidadeAlvo = currentUserData.unidade;

        const container = document.getElementById('lista-itens-reporte');
        
        // --- CORREÃ‡ÃƒO CIRÃšRGICA INICIA AQUI ---
        container.innerHTML = itensDaCautelaAtual.map((item, index) => {
            const estaBloqueado = indicesBloqueados.includes(index);
            const corFundo = estaBloqueado ? '#fff5f5' : '#fff';
            const corTexto = estaBloqueado ? '#999' : '#000';
            
            // 1. Identifica se Ã© MULTI (tem tombamento real e diferente do nome)
            const ehMulti = item.tombamento && item.tombamento !== "" && item.tombamento !== item.nome;

            // 2. Monta o texto de exibiÃ§Ã£o do nome (Sem repetir se for single)
            const textoExibicao = ehMulti 
                ? `${item.nome} <span style="color:#800020;">[Tomb: ${item.tombamento}]</span>` 
                : `${item.nome} (Qtd: ${item.quantidade} un)`;

            return `
            <div style="margin-bottom: 10px; padding: 10px; border: 1px solid ${estaBloqueado ? '#ffcccc' : '#ddd'}; background: ${corFundo}; border-radius:6px; opacity: ${estaBloqueado ? '0.8' : '1'};">
                <label style="display: flex; align-items: center; cursor: ${estaBloqueado ? 'not-allowed' : 'pointer'}; font-weight: bold; color: ${corTexto};">
                    <input type="checkbox" class="check-item-reporte" data-index="${index}" 
                           ${estaBloqueado ? 'disabled' : ''} 
                           style="margin-right: 10px;" onchange="toggleObsInput(${index})">
                    ${textoExibicao}
                    ${estaBloqueado ? '<span style="margin-left:auto; color:#d90f23; font-size:0.7em;"><i class="fas fa-clock"></i> EM ANÃLISE</span>' : ''}
                </label>
                <div id="div-obs-${index}" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee;">
                    ${!ehMulti ? `
                        <label style="font-size: 0.8em; color:#d90f23; font-weight:bold;">QUANTIDADE COM PROBLEMA:</label>
                        <input type="number" id="qtd-obs-${index}" value="1" min="1" max="${item.quantidade}" 
                               style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius:4px; box-sizing: border-box;">
                    ` : `<input type="hidden" id="qtd-obs-${index}" value="1">`}
                    
                    <label style="font-size: 0.8em; font-weight:bold;">MOTIVO DO RELATO:</label>
                    <textarea id="text-obs-${index}" placeholder="Descreva o que houve..." 
                              style="width: 100%; height: 50px; font-size: 0.85em; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                </div>
            </div>
        `}).join('');
        // --- FIM DA CORREÃ‡ÃƒO ---

        const selectGestor = document.getElementById('select-gestor-alvo');
        selectGestor.innerHTML = '<option value="" disabled selected>Buscando gestores...</option>';
        const gestoresSnap = await db.collection('usuarios').where('unidade', '==', unidadeAlvo).get();
        let options = '<option value="" disabled selected>Selecione o Gestor...</option>';
        let encontrouAlguem = false;

        gestoresSnap.forEach(gDoc => {
            const gData = gDoc.data();
            if (gData.role === 'gestor' || gData.role === 'admin') {
                options += `<option value="${gDoc.id}">${gData.nome_militar_completo}</option>`;
                encontrouAlguem = true;
            }
        });

        if (!encontrouAlguem) {
            const adminsGerais = await db.collection('usuarios').where('role', '==', 'admin').get();
            adminsGerais.forEach(aDoc => {
                options += `<option value="${aDoc.id}">${aDoc.data().nome_militar_completo} (Admin Geral)</option>`;
                encontrouAlguem = true;
            });
        }
        selectGestor.innerHTML = encontrouAlguem ? options : '<option value="" disabled selected>Nenhum gestor disponÃ­vel</option>';
        document.getElementById('cautelaDetailsModal').style.display = 'none';
        document.getElementById('modalReportarItem').style.display = 'flex';

    } catch (e) { 
        console.error("Erro:", e);
        alert("Erro ao carregar dados.");
    }
}

function toggleObsInput(index) {
    const div = document.getElementById(`div-obs-${index}`);
    const isChecked = document.querySelector(`.check-item-reporte[data-index="${index}"]`).checked;
    div.style.display = isChecked ? 'block' : 'none';
}

async function salvarRelatosMultiplos() {
    const checks = document.querySelectorAll('.check-item-reporte:checked');
    const gestorUid = document.getElementById('select-gestor-alvo').value;
    
    if (checks.length === 0) return alert("Selecione pelo menos um item com problema.");
    if (!gestorUid) return alert("Por favor, selecione o Gestor que receberÃ¡ este relato.");

    const selectG = document.getElementById('select-gestor-alvo');
    const nomeGestorAlvo = selectG.options[selectG.selectedIndex].text;

    let pendencias = [];
    let logsParaAdicionar = [];
    const dataAtual = new Date();
    const dataFormatada = dataAtual.toLocaleString('pt-BR');

    for (let check of checks) {
        const idx = check.getAttribute('data-index');
        const item = itensDaCautelaAtual[idx];
        const motivo = document.getElementById(`text-obs-${idx}`).value;
        const qtd = parseInt(document.getElementById(`qtd-obs-${idx}`).value) || 1;

        if (!motivo.trim()) {
            alert(`Descreva o problema do item: ${item.nome}`);
            return;
        }

        pendencias.push({
            item_nome: item.nome,
            item_tombamento: item.tombamento || null,
            item_id_base: item.id_base || item.id,
            item_index: parseInt(idx),
            quantidade: qtd,
            motivo: motivo,
            status: "PENDENTE",
            timestamp: dataAtual,
            solicitante_nome: currentUserData.nome_militar_completo,
            gestor_alvo_uid: gestorUid,
            gestor_alvo_nome: nomeGestorAlvo
        });

        logsParaAdicionar.push({
            data: dataFormatada,
            descricao: `âš ï¸ PENDÃŠNCIA ENVIADA: ${qtd}un de ${item.nome} (${item.tombamento || 'S/T'}) para anÃ¡lise de ${nomeGestorAlvo}. Motivo: ${motivo}`,
            militar: currentUserData.nome_militar_completo
        });
    }

    try {
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaIdAtualParaReporte);
        
        await cautelaRef.update({
            pendencias_ativas: firebase.firestore.FieldValue.arrayUnion(...pendencias),
            historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(...logsParaAdicionar)
        });

        alert(`Relato enviado com sucesso para ${nomeGestorAlvo}!`);
        document.getElementById('modalReportarItem').style.display = 'none';
        showCautelaDetails(cautelaIdAtualParaReporte);

    } catch (e) {
        console.error("Erro ao salvar:", e);
        alert("Erro ao processar envio.");
    }
}
		
function iniciarRecebimentoCautela(cautelaId) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. ConstrÃ³i a URL para a cautela. (Usa 'cautelaId')
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}`;

    // 4. ğŸ›‘ LÃ“GICA DE ABERTURA DO IFRAME (REPLICADA DA CONFERÃŠNCIA NORMAL) ğŸ›‘
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CRÃTICO: Componentes de execuÃ§Ã£o (app-runner-container ou app-iframe) nÃ£o encontrados.");
        alert("Erro ao iniciar a conferÃªncia. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a Ã¡rea principal do dashboard (content-area) e a sidebar para dar foco total ao app
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}
        function iniciarConferenciaDevolucao(cautelaId, destinatario) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    // ğŸ›‘ CORREÃ‡ÃƒO AQUI: Alterando de 'posto_graduacao' para 'posto' (ou similar)
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. ConstrÃ³i a URL CRÃTICA com o modo de devoluÃ§Ã£o final
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}&modo=devolucao_final&destinatarioDevolucao=${encodeURIComponent(destinatario)}`;

    // 4. LÃ“GICA DE ABERTURA DO IFRAME (INLINE)
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CRÃTICO: Componentes de execuÃ§Ã£o (app-runner-container ou app-iframe) nÃ£o encontrados.");
        alert("Erro ao iniciar a conferÃªncia. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a Ã¡rea principal do dashboard (content-area) e a sidebar
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar'); 
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}

// LocalizaÃ§Ã£o: Linha ~1594
function handleIframeMessage(event) {
    // Garante que a mensagem veio do seu domÃ­nio (Importante por seguranÃ§a)
    if (event.origin !== window.location.origin) return;

    if (event.data && event.data.type === 'SIGMA_FINISHED') {
        alert('âœ… OperaÃ§Ã£o finalizada com sucesso. Voltando ao Dashboard.');

        // 1. Oculta o container do Iframe
        const container = document.getElementById('app-runner-container');
        if (container) {
            container.style.display = 'none';
            // Limpa a URL do iframe para liberar recursos
            document.getElementById('app-iframe').src = 'about:blank';
        }
        
        // 2. Mostra a Ã¡rea principal do dashboard e a sidebar
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.style.display = 'block';
        }
        const sidebar = document.getElementById('sidebar') || document.getElementById('main-sidebar');
        if (sidebar) {
            sidebar.style.display = 'block';
        }
        
        // 3. Recarrega a lista mais relevante (Cautelas a Receber e Ativas)
        // Isso garante que o item CONCLUÃDA suma da lista A RECEBER/ATIVAS.
        
        // ğŸ›‘ CORREÃ‡ÃƒO DE REFERÃŠNCIA ğŸ›‘
        // A funÃ§Ã£o correta Ã© loadActiveCautelas (com 't' e 'l').
        loadCautionsToReceive(); // Atualiza a lista A RECEBER (item sumiu)
        loadActiveCautelas();    // Atualiza a lista ATIVAS (item sumiu/mudou)
        
        // ForÃ§a a atualizaÃ§Ã£o dos cards (contadores) e da lista "ConferÃªncias de Hoje"
        if (typeof updateOperacionalCards === 'function') {
            updateOperacionalCards();
        }
        
        // Volta para a view de Cautelas Ativas apÃ³s o sucesso, se o usuÃ¡rio nÃ£o estava no Dashboard.
        // Isto Ã© mais seguro do que tentar recarregar a aba 'HistÃ³rico' que estava ativa.
        switchView('cautelas'); 
        showCautelasDashboard('Cautelas Ativas'); 
    }
}        /**
 * Busca cautelas com status ABERTA e RECEBIDA para Gestores (filtradas por Unidade).
 * @param {string} unidade - A unidade do Gestor.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForGestor(unidade) {
    // Consulta 1: ABERTAS na Unidade
    const queryAberta = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'ABERTA');

    // Consulta 2: RECEBIDAS na Unidade
    const queryRecebida = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}

/**
 * Busca todas as cautelas com status ABERTA e RECEBIDA para Admin.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForAdmin() {
    // Consulta 1: Todas ABERTAS
    const queryAberta = db.collection('cautelas_abertas')
        .where('status', '==', 'ABERTA');

    // Consulta 2: Todas RECEBIDAS
    const queryRecebida = db.collection('cautelas_abertas')
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}

async function loadHistoricalCautelas() {
    const loading = document.getElementById('loading-historico');
    const historicoContentContainer = document.getElementById('historico-content-container'); 
    const abasOperacional = document.getElementById('historico-abas-operacional'); 
    
    const role = currentUserData.role || 'operacional';
    const user = currentUserData;
    
    if (historicoContentContainer) historicoContentContainer.innerHTML = ''; 
    loading.style.display = 'block';

    try {
        if (role === 'operacional') {
            
            if (abasOperacional) {
                abasOperacional.style.setProperty('display', 'flex', 'important');
            }
            
            const abasHtml = `
                <div id="content-minhas" class="historico-tab-content active-tab" style="display:block;"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>  <-- NOVO: Adiciona loading na aba inicial
                <div id="content-devolucao" class="historico-tab-content"></div>
                <div id="content-emitidas" class="historico-tab-content"></div>
            `;
            historicoContentContainer.innerHTML = abasHtml;
            
            loadHistorico('minhas'); 
            
        } else {
            
            if (abasOperacional) {
                abasOperacional.style.setProperty('display', 'none', 'important');
            }
            
            const snapGeral = await queryCautelas(['CONCLUÃDA'], role, user, null, 'unit');
            
            let titulo = (role === 'admin') ? 'HistÃ³rico Global (ADMIN)' : 'HistÃ³rico da Unidade (GESTOR)';
            
            if (snapGeral.length > 0) {
                
                let tableHtml = `
                    <div class="op-card" style="padding:15px; margin-bottom:0;">
                        <h4 style="margin-top:0; color:#800020; border-bottom:1px solid #eee; padding-bottom:5px;">
                            <i class="fas fa-archive"></i> ${titulo} (${snapGeral.length} registros)
                        </h4>
                        <table class="ca-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Dest. Original</th>
                                    <th>Emitente</th>
                                    <th>Local Origem</th>
                                    <th>Data ConclusÃ£o</th>
                                    <th>Itens</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                snapGeral.forEach(cautela => {
                    const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
                    const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
                    
                    tableHtml += `
                        <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                            <td data-label="ID"><strong>${cautela.cautela_id}</strong></td>
                            <td data-label="Dest. Original">${cautela.destinatario_original || 'N/A'}</td>
                            <td data-label="Emitente">${cautela.emitente}</td>
                            <td data-label="Local Origem">${cautela.local_origem || 'N/D'}</td>
                            <td data-label="ConclusÃ£o">${dataFinal}</td>
                            <td data-label="Itens">${itensCount} itens</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                historicoContentContainer.innerHTML = tableHtml;

            } else {
                historicoContentContainer.innerHTML = `<div class="op-card" style="padding:20px; text-align:center; color:#999;">Nenhuma cautela concluÃ­da encontrada para ${role}.</div>`;
            }
        }

    } catch (e) {
        console.error("Erro ao carregar histÃ³rico de cautelas:", e);
        historicoContentContainer.innerHTML = `<div class="op-card" style="padding:20px; text-align:center; color:red;">Erro ao carregar dados: ${e.message}</div>`;
    } finally {
        loading.style.display = 'none'; 
    }
}
        function renderHistoricalGroup(title, cautelas, groupId) {
    // Retorna string vazia se nÃ£o houver dados
    if (cautelas.length === 0) {
        return ''; 
    }
    
    // ConstrÃ³i a estrutura do grupo (que pode ser uma aba ou uma seÃ§Ã£o)
    let html = `
        <div class="historical-group" id="${groupId}">
            <h4 class="group-title-historical"><i class="fas fa-history"></i> ${title} (${cautelas.length})</h4>
            <div class="table-responsive-container">
            <table class="cautelas-table" id="${groupId}-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Emitente</th>
                        <th>Dest. Atual</th>
                        <th>Data ConclusÃ£o</th>
                        <th>Itens</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Adiciona as linhas da tabela
    cautelas.forEach(cautela => {
        // Reutiliza a funÃ§Ã£o de renderizaÃ§Ã£o de linha que jÃ¡ estÃ¡ ajustada
        html += renderCautelaRow(cautela); 
    });
    
    html += `
                </tbody>
            </table>
            </div>
        </div>
    `;
    return html;
}
        // LocalizaÃ§Ã£o: Aproximadamente linha 6310

async function getLastConferente(localOrigem) {
    if (!localOrigem) return "N/D";
    
    try {
        // 1. Busca o resultado de conferÃªncia mais recente para o local de origem.
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('local', '==', localOrigem)
            .orderBy('timestamp', 'desc')
            .limit(1)
            .get();
            
        if (!snap.empty) {
            const lastResult = snap.docs[0].data();
            
            // ğŸ›‘ 2. VERIFICA O UID (CHAVE IMUTÃVEL)
            const conferenteUid = lastResult.conferente_uid; 
            
            if (conferenteUid) {
                // 3. SE TEM UID, FAZ O LOOKUP PARA OBTER O NOME ATUALIZADO
                const userData = await getUserInfoByUid(conferenteUid);
                
                if (userData && userData.nome_militar_completo) {
                    // Retorna o nome atualizado do militar
                    return userData.nome_militar_completo;
                }
            }
            
            // 4. FALLBACK: Se nÃ£o tem UID ou lookup falhou, retorna o nome estÃ¡tico
            // (Isso lida com registros legados).
            return lastResult.conferente || "N/D (Sem UID ou Cadastro)";
        }
        
        return "N/D (Nenhum histÃ³rico recente)";
    } catch (e) {
        console.error("Erro ao buscar Ãºltimo conferente (UID Lookup):", e);
        return "N/D (Erro de consulta)";
    }
}
            async function iniciarDevolucaoCautela(cautelaId, ultimoConferenteNome) {
    const btnDevolver = document.getElementById('btn-devolver-cautela');
    
    // 1. CONFIRMAÃ‡ÃƒO INICIAL COM O USUÃRIO
    const confirmacaoUsuario = confirm(`A CAUTELA SERÃ ENVIADA PARA DEVOLUÃ‡ÃƒO A "${ultimoConferenteNome}". CONFIRMA?`);
    if (!confirmacaoUsuario) return; // Cancela se o usuÃ¡rio clicar em "Cancelar"

    // Esconde o modal e desativa o botÃ£o apÃ³s a confirmaÃ§Ã£o
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    if (btnDevolver) btnDevolver.disabled = true;

    try {
        const militarCompleto = currentUserData.nome_militar_completo;
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaId);

        // Busca o UID do UsuÃ¡rio C (o novo recebedor)
        const ucUid = await findUidByName(ultimoConferenteNome);

        if (!ucUid) {
            throw new Error(`NÃ£o foi possÃ­vel localizar o ID de sistema para: ${ultimoConferenteNome}.`);
        }

        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);
            
            if (!cautelaDoc.exists) throw new Error("Documento nÃ£o localizado.");
            
            const data = cautelaDoc.data();

            // --- ğŸ›‘ TRAVA DE SEGURANÃ‡A: ITENS EM ANÃLISE ğŸ›‘ ---
            const pendencias = data.pendencias_ativas || [];
            if (pendencias.length > 0) {
                const listaItens = pendencias.map(p => p.itemNome).join(', ');
                throw new Error(`BLOQUEIO: Existem itens em anÃ¡lise pelo Gestor: (${listaItens}).\n\nResolva as pendÃªncias antes de devolver.`);
            }

            if (data.status !== 'RECEBIDA') {
                throw new Error("A cautela nÃ£o estÃ¡ em sua posse confirmada para ser devolvida.");
            }

            // --- ğŸ“ PREPARAÃ‡ÃƒO DO LOG DE MOVIMENTAÃ‡ÃƒO ---
            const novoLog = {
    			data: new Date().toLocaleString('pt-BR'), // Grava como texto formatado, nÃ£o como objeto Timestamp
    			descricao: `DevoluÃ§Ã£o iniciada: Material enviado por ${militarCompleto} para conferÃªncia de retorno de ${ultimoConferenteNome}.`,
    			militar: militarCompleto, // Nome da chave corrigido para bater com o modal
   			 	tipo: "TRANSICAO_DEVOLUCAO"
			};
            
            // Se passar por todas as travas, executa a atualizaÃ§Ã£o
            transaction.update(cautelaRef, { 
                status: 'DEVOLUÃ‡ÃƒO', 
                timestamp_devolucao_iniciada: firebase.firestore.FieldValue.serverTimestamp(),
                
                reversor_uid: firebase.auth().currentUser.uid,
                militar_completo_reversor: militarCompleto,
                
                destinatario_uid: ucUid, 
                destinatario: ultimoConferenteNome,

                // Adiciona o log ao histÃ³rico da cautela
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion(novoLog)
            });
        });

        alert(`âœ… Cautela enviada para conferÃªncia de ${ultimoConferenteNome}.`);
        if (typeof loadActiveCautelas === 'function') loadActiveCautelas();
        if (typeof updateOperacionalCards === 'function') updateOperacionalCards();

    } catch (error) {
        console.error("Erro ao iniciar devoluÃ§Ã£o:", error);
        alert(`${error.message}`);
        if (btnDevolver) btnDevolver.disabled = false;
    }
}
        /**
 * Alterna a aba do HistÃ³rico e dispara o carregamento da funÃ§Ã£o correspondente.
 */
// LocalizaÃ§Ã£o: FunÃ§Ã£o loadHistorico (Aproximadamente linha 1504)

function loadHistorico(tabName) {
    const role = currentUserData.role || 'operacional';
    
    // ğŸ›‘ 1. SE FOR GESTOR/ADMIN, FORÃ‡AMOS A VISUALIZAÃ‡ÃƒO DA TABELA ÃšNICA ğŸ›‘
    // Isso garante que loadHistoricalCautelas rode e sobreescreva a estrutura de abas.
    if (role === 'gestor' || role === 'admin') {
        loadHistoricalCautelas();
        return; // Sai da funÃ§Ã£o apÃ³s iniciar a visualizaÃ§Ã£o Gerencial/Global
    }
    
    // 2. Para Operacional, continua a lÃ³gica de abas:
    
    // 2.1. Atualiza a UI das abas
    document.querySelectorAll('.tab-navigation .tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === tabName) {
            btn.classList.add('active');
        }
    });

    // 2.2. Oculta e mostra o conteÃºdo (containers internos)
    document.querySelectorAll('.historico-tab-content').forEach(content => {
        content.classList.remove('active-tab');
        content.style.display = 'none';
    });
    const targetContent = document.getElementById(`content-${tabName}`);
    if (targetContent) {
        targetContent.style.display = 'block';
        targetContent.classList.add('active-tab');
    }
    
    // 2.3. Dispara a funÃ§Ã£o de carregamento de dados (Operacional)
    if (tabName === 'minhas') {
        loadHistoricoMinhas();
    } else if (tabName === 'devolucao') {
        loadHistoricoDevolucao();
    } else if (tabName === 'emitidas') {
        loadHistoricoEmitidas();
    }
}
        // FunÃ§Ã£o auxiliar para renderizar a tabela, minimizando a repetiÃ§Ã£o
function renderHistoricoTable(containerId, cautelas) {
    const container = document.getElementById(containerId);
    const loading = document.getElementById('loading-historico');

    if (!container) return; 

    // Oculta loading e garante que o container esteja visÃ­vel
    if (loading) loading.style.display = 'none';

    if (cautelas.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px;">Nenhuma cautela encontrada neste histÃ³rico.</p>';
        return;
    }

    // Cria a estrutura da tabela
    let html = `
        <table class="ca-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Dest. Original</th>
                    <th>Emitente</th>
                    <th>Data Final</th>
                    <th>Itens</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
    `;

    cautelas.forEach(cautela => {
        const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
        const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        
        // Define o destinatÃ¡rio original de forma segura (para esta aba)
        const destOriginal = cautela.destinatario_original || 'N/A';
        const badgeText = 'CONCLUÃDA';
        const badgeClass = 'badge-solucao';

        html += `
            <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                <td><strong>${cautela.cautela_id}</strong></td>
                <td>${destOriginal}</td>
                <td>${cautela.emitente}</td>
                <td>${dataFinal}</td>
                <td>${itensCount} itens</td>
                <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

// -------------------------------------------------------------
// FUNÃ‡Ã•ES ESPECÃFICAS DE CARREGAMENTO POR ABA
// -------------------------------------------------------------

/**
 * Aba 1: MINHAS (DestinatÃ¡rio Original)
 * Filtro: destinatario_original == militarCompleto E status == CONCLUÃDA
 */
async function loadHistoricoMinhas() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('destinatario_original', '==', militarCompleto)
            .where('status', '==', 'CONCLUÃDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-minhas', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-minhas').innerHTML = `<p style="color:red;">Erro ao carregar histÃ³rico: ${e.message}</p>`;
    }
}

/**
 * Aba 2: DEVOLUÃ‡ÃƒO (Recebidas de volta, como Dono ProvisÃ³rio)
 * Filtro: receptor_final_completo == militarCompleto E status == CONCLUÃDA
 */
async function loadHistoricoDevolucao() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('receptor_final_completo', '==', militarCompleto) // Campo que registra o Dono ProvisÃ³rio
            .where('status', '==', 'CONCLUÃDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-devolucao', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-devolucao').innerHTML = `<p style="color:red;">Erro ao carregar histÃ³rico: ${e.message}</p>`;
    }
}

/**
 * Aba 3: EMITIDAS POR MIM
 * Filtro: emitente == militarCompleto E status == CONCLUÃDA
 */
async function loadHistoricoEmitidas() {
    const militarCompleto = currentUserData.nome_militar_completo;
    
    try {
        const snap = await db.collection('cautelas_abertas')
            .where('emitente', '==', militarCompleto)
            .where('status', '==', 'CONCLUÃDA')
            .orderBy('timestamp_conclusao', 'desc')
            .get();
        
        renderHistoricoTable('content-emitidas', snap.docs.map(doc => doc.data()));
    } catch (e) {
        document.getElementById('content-emitidas').innerHTML = `<p style="color:red;">Erro ao carregar histÃ³rico: ${e.message}</p>`;
    }
}
        function atualizarQuadroModal() {
    const postoSelect = document.getElementById('edit-user-posto');
    const quadroSelect = document.getElementById('edit-user-quadro');
    const posto = postoSelect.value;
    
    // Limpa o select do quadro e desabilita
    quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    quadroSelect.disabled = true;

    // Se o posto for vazio (ou a opÃ§Ã£o "Selecione"), sai
    if (!posto) return;

    // Mapeamento dos postos para a categoria (Oficiais, PraÃ§as, SD)
    let quadros = [];
    const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1Âº TEN', '2Âº TEN'];
    const pracas = ['ST', '1Âº SGT', '2Âº SGT', '3Âº SGT', 'CB'];

    if (oficiais.includes(posto)) {
        quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
    } else if (pracas.includes(posto)) {
        quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
    } else if (posto === 'SD') {
        // SD tem um quadro fixo e nÃ£o permite alteraÃ§Ã£o
        quadros = ['QPCBM'];
        quadroSelect.disabled = true;
    }

    if (quadros.length > 0) {
        quadroSelect.disabled = (posto === 'SD'); // Desabilita apenas se for SD
        
        // Preenche as opÃ§Ãµes do quadro
        quadros.forEach(quadro => {
            const option = document.createElement('option');
            option.value = quadro;
            option.textContent = quadro;
            quadroSelect.appendChild(option);
        });
        
        // Tenta prÃ©-selecionar a primeira opÃ§Ã£o se houver apenas uma (caso do SD)
        if(quadros.length === 1) {
            quadroSelect.value = quadros[0];
        }
    }
}
        function formatarCPF(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que nÃ£o for dÃ­gito
    value = value.substring(0, 11); // Limita a 11 dÃ­gitos

    if (value.length > 9) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
    } else if (value.length > 3) {
        value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{3})$/, '$1');
    }
    input.value = value;
}

function formatarMatricula(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que nÃ£o for dÃ­gito
    value = value.substring(0, 10); // Limita a 10 dÃ­gitos

    if (value.length > 7) {
        value = value.replace(/^(\d{7})(\d{3})$/, '$1-$2');
    }
    input.value = value;
}

function formatarTelefone(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que nÃ£o for dÃ­gito
    value = value.substring(0, 11); // Limita a 11 dÃ­gitos (DDD + 9 dÃ­gitos)

    if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
    } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{2})$/, '($1)');
    }
    input.value = value;
}
        function filtrarUsuarios() {
    const searchInput = document.getElementById('user-search-input');
    const searchTerm = searchInput.value.trim().toUpperCase();
    const tbody = document.getElementById('users-table-body');
    
    tbody.innerHTML = '';
    
    const filteredUsers = allUsersData.filter(u => {
        // Filtra pelo Nome de ExibiÃ§Ã£o completo
        const nomeExibicao = u.nome_militar_completo || '';
        return nomeExibicao.includes(searchTerm);
    });

    if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Nenhum usuÃ¡rio encontrado com o nome digitado.</td></tr>';
        return;
    }

    filteredUsers.forEach(u => {
        const docId = u.id; 
        const tr = document.createElement('tr');
        
        const isCurrentUser = firebase.auth().currentUser.uid === docId; 
        
        const telefone = u.telefone_contato || 'N/D';
        const whatsappUrl = u.whatsapp_url || '#';
        const rawTelefone = telefone.replace(/\D/g, '');
        const numeroSemDDD = (rawTelefone.length === 11) ? rawTelefone.substring(2) : rawTelefone; 

        const whatsappLink = `<a href="${whatsappUrl}" target="_blank" style="margin-left: 5px; color: #25D366;"><i class="fab fa-whatsapp"></i></a>`;
        const dialLink = (rawTelefone.length >= 8) ? 
            `<a href="tel:${numeroSemDDD}" class="btn-dial-mobile" style="margin-left: 5px; color: #2c7399;"><i class="fas fa-phone"></i></a>` : '';
        
        // CORREÃ‡ÃƒO AQUI: AdiÃ§Ã£o dos atributos data-label em cada cÃ©lula <td>
        tr.innerHTML = `
            <td data-label="Militar:">${u.nome_militar_completo}</td>
            <td data-label="Contato:">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span>${telefone}</span>
            ${whatsappLink}
            ${dialLink} 
        </div>
    </td>
            <td data-label="Perfil:"><span class="role-badge role-${u.role}">${u.role}</span></td>
            <td data-label="Unidade:">${u.unidade}</td>
            <td data-label="AÃ§Ãµes:"><button class="btn-modern-action btn-edit" style="padding:4px 8px; font-size:0.8em;" onclick="abrirGestaoUsuario('${docId}')" ${isCurrentUser ? 'disabled' : ''}>Editar</button></td>`;
        tbody.appendChild(tr);
    });
}
        function setupCadastroMilitarLogic() {
    // 1. MÃ¡scaras
    const cpfInput = document.getElementById('new-user-cpf');
    const matriculaInput = document.getElementById('new-user-matricula');
    const telefoneInput = document.getElementById('new-user-telefone');

    if (cpfInput) cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
    if (matriculaInput) matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
    if (telefoneInput) telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));

    // 2. LÃ³gica de DependÃªncia Posto/Quadro (Adaptada da funÃ§Ã£o atualizarQuadroModal)
    const postoSelect = document.getElementById('new-user-posto');
    const quadroSelect = document.getElementById('new-user-quadro');

    if (postoSelect && quadroSelect) {
        postoSelect.addEventListener('change', () => {
            // Replicar a lÃ³gica de atualizaÃ§Ã£o do Quadro (Posto->Quadro)
            atualizarQuadroCad(postoSelect, quadroSelect);
        });
    }
}

/**
 * LÃ³gica de dependÃªncia Posto/Quadro ADAPTADA para o novo formulÃ¡rio Cadastrar Militar.
 */
    function atualizarQuadroCad(postoSelect, quadroSelect) {
        const posto = postoSelect.value;
        quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
        quadroSelect.disabled = true;
        if (!posto) return;
        let quadros = [];
        const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1Âº TEN', '2Âº TEN'];
        const pracas = ['ST', '1Âº SGT', '2Âº SGT', '3Âº SGT', 'CB'];
        if (oficiais.includes(posto)) {
            quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
        } else if (pracas.includes(posto)) {
            quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
        } else if (posto === 'SD') {
            quadros = ['QPCBM'];
            quadroSelect.disabled = true;
        }
        if (quadros.length > 0) {
            quadroSelect.disabled = (posto === 'SD');
            quadros.forEach(quadro => {
                const option = document.createElement('option');
                option.value = quadro;
                option.textContent = quadro;
                quadroSelect.appendChild(option);
            });   
            if(quadros.length === 1) {
                quadroSelect.value = quadros[0];
            }
        }
    }
    async function carregarPostosServicoSelect(elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;

    select.innerHTML = '<option value="" disabled selected>Carregando Postos...</option>';

    try {
        // Usa a busca comprovadamente funcional
        const docRef = db.collection('config_geral').doc('postos');
        const doc = await docRef.get();

        // Usa a extraÃ§Ã£o segura de dados (Postos Visuais usa esta mesma lÃ³gica)
        if (doc.exists) {
            const postos = doc.data().lista || []; // Pega o array 'lista'
            
            select.innerHTML = '<option value="" disabled selected>Selecione o Posto de ServiÃ§o</option>';
            
            postos.sort().forEach(posto => {
                const option = document.createElement('option');
                option.value = posto;
                option.textContent = posto;
                select.appendChild(option);
            });
            
        } else {
            select.innerHTML = '<option value="" disabled selected>Lista de Postos nÃ£o encontrada.</option>';
        }

    } catch(e) {
        // Verifique o console (F12) se esta mensagem aparecer
        console.error("Erro CRÃTICO ao carregar Postos de ServiÃ§o:", e); 
        select.innerHTML = '<option value="" disabled selected>Erro ao carregar</option>';
    }
}
        async function carregarUnidadesSelect(elementId = 'new-user-unit') {
        const select = document.getElementById(elementId);
        if (!select) return;
        select.innerHTML = '<option value="">Carregando...</option>';
        try {
            // Busca o documento 'unidades' dentro de 'config_geral'
            const docRef = db.collection('config_geral').doc('unidades');
            const doc = await docRef.get();
            let unidades = [];
            // Usa a extraÃ§Ã£o segura de dados
            if (doc.exists) {
                unidades = doc.data().lista || []; // Pega o array 'lista'
            }

            // Preenche o dropdown
            select.innerHTML = '<option value="" disabled selected>Selecione a Unidade</option>';
            unidades.sort().forEach(unidade => {
                const option = document.createElement('option');
                option.value = unidade;
                option.textContent = unidade;
                select.appendChild(option);
            });

            // --- LÃ“GICA DE PERMISSÃƒO PARA GESTOR ---
            const isGestor = currentUserData && currentUserData.role === 'gestor';
            const gestorUnidade = currentUserData ? currentUserData.unidade : null;
        
            if (isGestor && gestorUnidade) {
                select.value = gestorUnidade;
                select.disabled = true;
                select.style.backgroundColor = '#f0f0f0';
            } else {
                select.disabled = false;
                select.style.backgroundColor = '';
            }

        } catch(e) {
            console.error("Erro CRÃTICO ao carregar unidades:", e);
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }
        //FUNÃ‡Ã•ES PARA MELHORIA DAS FILTRAGENS POR STATUS E PERFIL NO MENI GESTAO DE CAUTELAS
        async function getUnitListIds() {
    // 1. Obter a unidade do usuÃ¡rio logado
    const userUnidade = currentUserData.unidade || '';
    if (!userUnidade) {
        console.warn("Unidade do usuÃ¡rio nÃ£o definida. Retornando vazio.");
        return [];
    }

    // 2. Buscar no documento 'config_geral/rotas'
    try {
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const unitListIds = [];

        for (const [id, info] of Object.entries(rotas)) {
            // Se o nome da unidade na rota for igual Ã  unidade do usuÃ¡rio
            if (info.unidade === userUnidade && info.ativo !== false) { 
                unitListIds.push(id);
            }
        }
        return unitListIds;

    } catch (error) {
        console.error("Erro ao obter IDs de listas da unidade:", error);
        return [];
    }
}
        // LocalizaÃ§Ã£o: FunÃ§Ã£o queryCautelas (Aproximadamente linha 1600 do arquivo completo)

// A funÃ§Ã£o queryCautelas foi alterada para suportar a busca por UID em filtros pessoais.
async function queryCautelas(statusArray, role, user, field = null, type = 'personal') {
    let query = db.collection('cautelas_abertas');

    if (type === 'personal' || role === 'admin') {
        if (statusArray.length > 0) {
            query = query.where('status', 'in', statusArray);
        } else {
            return [];
        }
    }

    const militarCompleto = user.nome_militar_completo;
    const militarUid = firebase.auth().currentUser.uid;

    if (role === 'gestor' && type === 'unit') {
        const unitListIds = await getUnitListIds();
        if (unitListIds.length > 0 && unitListIds.length <= 10) {
            query = query.where('local_origem_id', 'in', unitListIds);
        } else {
            return [];
        }
    } else if (type === 'personal') {
        if (field === 'destinatario') {
            const [snapOriginal, snapAtual] = await Promise.all([
                db.collection('cautelas_abertas')
                    .where('destinatario_original_uid', '==', militarUid)
                    .where('status', 'in', statusArray)
                    .get(),
                db.collection('cautelas_abertas')
                    .where('destinatario_uid', '==', militarUid)
                    .where('status', 'in', statusArray)
                    .get()
            ]);

            let mapResult = new Map();
            snapOriginal.forEach(doc => mapResult.set(doc.id, { id: doc.id, ...doc.data() }));
            snapAtual.forEach(doc => mapResult.set(doc.id, { id: doc.id, ...doc.data() }));

            return Array.from(mapResult.values()).sort((a, b) => 
                (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0)
            );

        } else if (field === 'emitente') {
            query = query.where('emitente_uid', '==', militarUid);
        } else if (field === 'receptor_final_completo') {
            query = query.where('receptor_final_completo', '==', militarCompleto);
        } else if (field === 'destinatario_original') {
            query = query.where('destinatario_original', '==', militarCompleto);
        } else if (field === 'militar_completo_reversor') {
            query = query.where('militar_completo_reversor', '==', militarCompleto);
        }
    }

    try {
        const snapshot = await query.orderBy('timestamp_emissao', 'desc').get();
        let cautelas = [];
        snapshot.forEach(doc => {
            const cautela = { id: doc.id, ...doc.data() };
            if (role === 'gestor' && type === 'unit' && !statusArray.includes(cautela.status)) {
                return;
            }
            cautelas.push(cautela);
        });
        return cautelas;
    } catch (error) {
        console.error("Erro na consulta de cautelas:", error);
        throw error;
    }
}
    /**
 * Renderiza uma linha de tabela (<tr>) para a cautela, adicionando data-labels para responsividade mobile.
 */
function renderCautelaRow(cautela) {
    const clickAction = `showCautelaDetails('${cautela.cautela_id}')`;
    const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
    
    // ğŸ›‘ INDICADOR DE PENDÃŠNCIA NA LINHA
    const temPendencia = cautela.pendencias_ativas && cautela.pendencias_ativas.length > 0;
    const alertaCaa = temPendencia ? `<i class="fas fa-exclamation-circle" style="color: #f57c00;" title="Possui itens em anÃ¡lise"></i> ` : "";

    const dataEmissao = cautela.timestamp_emissao && typeof cautela.timestamp_emissao.toDate === 'function'
                        ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR')
                        : 'N/A';
                                
    const status = cautela.status || 'N/A';
    let badgeClass = 'badge-cautela';
    let badgeText = 'N/D'; 

    if (status === 'RECEBIDA') { badgeClass = 'badge-solucao'; badgeText = 'RECEBIDA'; } 
    else if (status === 'ABERTA') { badgeClass = 'badge-cautela'; badgeText = 'ABERTA'; } 
    else if (status === 'DEVOLUÃ‡ÃƒO') { badgeClass = 'badge-pendente'; badgeText = 'EM DEVOLUÃ‡ÃƒO'; } 
    else if (status === 'CONCLUÃDA') { badgeClass = 'badge-concluida'; badgeText = 'CONCLUÃDA'; }
    
    return `
        <tr onclick="${clickAction}" style="${temPendencia ? 'background-color: #fff9f0;' : ''}">
            <td data-label="ID"><strong>${cautela.cautela_id}</strong></td>
            <td data-label="DestinatÃ¡rio">${cautela.destinatario || cautela.destinatario_original_nome || 'Aguardando...'}</td>
            <td data-label="EmissÃ£o">${dataEmissao}</td>
            <td data-label="Origem">${cautela.local_origem}</td>
            <td data-label="Itens">${alertaCaa}${itensCount} itens</td>
            <td data-label="Status"><span class="status-badge ${badgeClass}">${badgeText}</span></td>
        </tr>
    `;
}
     // Adicionar esta funÃ§Ã£o no final do bloco de funÃ§Ãµes do Editor de Listas (sigma_dashboard.txt)

        async function limparCarimbosCautela() {
            if (!currentEditingId) return alert("Nenhuma lista em ediÃ§Ã£o.");

            if (!confirm("TEM CERTEZA? Isso irÃ¡ remover todos os registros de cautelas ativas (carimbos) para ESTA LISTA!")) {
                return;
            }

            try {
                // Percorre a lista local para remover os carimbos
                dadosConferencia = dadosConferencia.map(setor => ({
                    ...setor,
                    itens: setor.itens.map(item => {
                        if (item.tipo === 'single' && item.cautelas) {
                            delete item.cautelas; // Remove o array de cautelas
                        }
                        if (item.tipo === 'multi' && item.tombamentos) {
                            item.tombamentos = item.tombamentos.map(tomb => {
                                if (tomb.cautela) {
                                    delete tomb.cautela; // Remove o carimbo do tombamento
                                }
                                return tomb;
                            });
                        }
                        return item;
                    })
                }));

                // Salva o estado limpo de volta no Firestore
                await db.collection(COLECAO_LISTAS).doc(currentEditingId).update({ 
                    list: dadosConferencia, 
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                alert("Carimbos de cautela removidos e lista atualizada!");
                
                // Recarrega a lista para atualizar a visualizaÃ§Ã£o e garantir a consistÃªncia
                renderizarLista();
                
                // ğŸ›‘ CRÃTICO: Limpa os resultados C/A antigos que podem estar linkados.
                // A remoÃ§Ã£o dos carimbos remove a indisponibilidade, mas nÃ£o o alerta C/A em si.
                // Recomenda-se limpar manualmente os resultados da lista na coleÃ§Ã£o 'resultados_conferencias'
                // para garantir que o Dashboard esteja 100% zerado, mas nÃ£o podemos fazer isso automaticamente aqui
                // sem o ID da lista.
                
            } catch (e) {
                console.error("Erro ao limpar carimbos:", e);
                alert("Erro ao limpar carimbos: " + e.message);
            }
        }
        // LocalizaÃ§Ã£o: Aproximadamente linha 6445
async function getUserInfoByUid(uid) {
    if (userCache[uid]) {
        return userCache[uid];
    }
    
    try {
        // Tenta encontrar o documento onde o UID Ã© o ID do documento
        const doc = await db.collection('usuarios').doc(uid).get(); 
        
        if (doc.exists) {
            userCache[uid] = { id: doc.id, ...doc.data() };
            return userCache[uid];
        }

        return null;
        
    } catch (e) {
        console.warn(`Falha ao buscar militar pelo UID ${uid}: ${e.message}`);
        return null;
    }
}
        /**
 * Tenta encontrar o UID de um militar usando seu nome militar completo (Posto Quadro Nome Guerra).
 * Usado como fallback para cautelas legadas.
 * @param {string} nomeCompleto - O nome completo (Ex: '2Âº SGT QPCBM JHONATH').
 * @returns {string|null} O ID do documento (UID) se encontrado.
 */
async function findUidByName(nomeCompleto) {
    if (!nomeCompleto) return null;
    
    try {
        // Busca exata pelo nome de exibiÃ§Ã£o
        const snap = await db.collection('usuarios')
            .where('nome_militar_completo', '==', nomeCompleto.trim())
            .get();
            
        if (snap.empty) {
            console.warn(`Nenhum militar encontrado com o nome exato: ${nomeCompleto}`);
            return null;
        }

        if (snap.size > 1) {
            alert(`âš ï¸ AtenÃ§Ã£o: Foram encontrados ${snap.size} cadastros para "${nomeCompleto}". Verifique se hÃ¡ nomes duplicados no banco de dados.`);
        }

        // Retorna o UID do primeiro documento encontrado
        return snap.docs[0].id; 
    } catch (e) {
        console.error("Erro ao buscar UID por nome:", e);
        return null;
    }
}
		
      async function resetTotalItensLocal(listaId) {
    if (!confirm(`ATENÃ‡ÃƒO: Isso apagarÃ¡ TODOS os histÃ³ricos e cautelas registradas nos itens da lista [${listaId}]. Deseja continuar?`)) return;

    const listaRef = db.collection('listas_conferencia').doc(listaId);

    try {
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(listaRef);
            if (!doc.exists) throw new Error("Lista nÃ£o encontrada.");

            let listaMestra = doc.data().list || [];

            // Percorre setores e itens para resetar os campos
            const listaLimpa = listaMestra.map(setor => ({
                ...setor,
                itens: setor.itens.map(item => {
                    // 1. Limpa histÃ³rico de vida
                    item.historico_vida = [];
                    
                    // 2. Limpa cautelas de itens single (Abatimento de estoque)
                    if (item.tipo === 'single') {
                        item.cautelas = [];
                    }
                    
                    // 3. Limpa cautelas de itens multi (Tombamentos)
                    if (item.tipo === 'multi' && item.tombamentos) {
                        item.tombamentos = item.tombamentos.map(t => {
                            // Remove o objeto 'cautela' de dentro do tombamento
                            if (t.cautela) delete t.cautela;
                            // Reseta o status de conferÃªncia se necessÃ¡rio
                            t.status = 'pending';
                            return t;
                        });
                        // Limpa array auxiliar se existir
                        item.tombamentos_cautelados = [];
                    }
                    
                    return item;
                })
            }));

            // Atualiza o banco com a lista resetada
            transaction.update(listaRef, { list: listaLimpa });
        });

        alert("âœ… Limpeza concluÃ­da! A lista estÃ¡ como nova.");
        location.reload();

    } catch (e) {
        console.error("Erro no reset:", e);
        alert("Erro ao limpar: " + e.message);
    }
}
		async function estornarEResetarCautela(cautelaId) {
    if (!confirm("Deseja estornar esta cautela?")) return;

    // Ajustado conforme sua correÃ§Ã£o: "listas_conferencia"
    const nomeColecao = 'listas_conferencia';
    const idDocumentoLista = 'alfa_abt17'; 

    try {
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaId);
        const docCautela = await cautelaRef.get();
        
        if (!docCautela.exists) {
            alert("âŒ Cautela nÃ£o encontrada em 'cautelas_abertas'.");
            return;
        }
        
        const dadosCautela = docCautela.data();
        const listaRef = db.collection(nomeColecao).doc(idDocumentoLista);

        await db.runTransaction(async (transaction) => {
            const listaDoc = await transaction.get(listaRef);
            
            if (!listaDoc.exists) {
                throw new Error(`NÃ£o encontrei o documento em ${nomeColecao}/${idDocumentoLista}`);
            }
            
            let dadosMestra = listaDoc.data().list || [];

            // VARREDURA TOTAL:
            // Percorre toda a lista procurando por qualquer menÃ§Ã£o ao cautelaId,
            // corrigindo inclusive os itens que foram gravados de forma incompleta.
            dadosMestra.forEach(setor => {
                if (setor.itens) {
                    setor.itens.forEach(item => {
                        
                        // 1. Limpa itens MULTI (Tombamentos)
                        if (item.tipo === 'multi' && item.tombamentos) {
                            item.tombamentos.forEach(t => {
                                // Se o ID bater OU se o status estiver 'pending' mas deveria estar livre
                                if (t.cautela && (t.cautela.id === cautelaId || t.cautela.id_cautela === cautelaId)) {
                                    delete t.cautela;
                                    t.status = 'pending';
                                    t.status_conferencia = 'OK';
                                }
                                // Caso especial: se o tombamento estÃ¡ marcado no array de itens da cautela 
                                // mas o objeto cautela sumiu do banco (seu caso do 2Âº item)
                                const constaSaiuNaCautela = dadosCautela.itens.find(ic => ic.tombamento === t.tomb);
                                if (constaSaiuNaCautela) {
                                    if (t.cautela) delete t.cautela;
                                    t.status = 'pending';
                                    t.status_conferencia = 'OK';
                                }
                            });
                        }
                        
                        // 2. Limpa itens SINGLE
                        if (item.tipo === 'single' && item.cautelas) {
                            item.cautelas = item.cautelas.filter(c => c.id !== cautelaId && c.id_cautela !== cautelaId);
                        }

                        // 3. Limpa o HistÃ³rico de Vida do item
                        if (item.historico_vida) {
                            item.historico_vida = item.historico_vida.filter(h => h.id_doc !== cautelaId);
                        }
                    });
                }
            });

            // 4. Grava a lista atualizada e deleta o documento da cautela
            transaction.update(listaRef, { list: dadosMestra });
            transaction.delete(cautelaRef);
        });

        alert("âœ… Reset concluÃ­do com sucesso!");
        location.reload();

    } catch (error) {
        console.error("Erro no estorno:", error);
        alert("Erro: " + error.message);
    }
}

async function loadCautelaPendencies() {
    const container = document.getElementById('admin-gestor-cards-container');
    if (!container || !currentUserData) return;

    try {
        console.log("=== BUSCANDO PENDÃŠNCIAS DE CAUTELA ===");
        
        const unitListIds = await getUnitListIds();
        
        let query = db.collection('cautelas_abertas')
                      .where('status', 'in', ['ABERTA', 'RECEBIDA', 'DEVOLUÃ‡ÃƒO']);
        
        const snap = await query.get();
        let totalPendenciasTroca = 0;
        let cautelasComPendencia = [];

        snap.forEach(doc => {
            const data = doc.data();
            const pertenceAoSetor = currentUserData.role === 'admin' || unitListIds.includes(data.local_origem_id);

            if (pertenceAoSetor && data.pendencias_ativas && data.pendencias_ativas.length > 0) {
                
                // --- CORREÃ‡ÃƒO CIRÃšRGICA: INJETAR DADOS DO MILITAR EM CADA PENDÃŠNCIA ---
                const pendenciasComRastreabilidade = data.pendencias_ativas.map(p => {
    			// Chaves REAIS confirmadas no seu log:
    			const nomeReal = data.destinatario_original_nome || p.solicitante_nome || "Militar";
    			const uidReal = data.destinatario_uid || p.solicitante_uid || "";

   				 return {
        			...p,
        			gestor_alvo_nome: nomeReal, // Normaliza para o fluxo seguinte
        			gestor_alvo_uid: uidReal,
        			cautelaId: doc.id,
        			localId: data.local_origem_id,
        			itemNome: p.item_nome || p.itemNome || "Item"
    			};
			});

                if (pendenciasComRastreabilidade.length > 0) {
                    totalPendenciasTroca += pendenciasComRastreabilidade.length;
                    cautelasComPendencia.push({ 
                        id: doc.id, 
                        ...data, 
                        pendencias: pendenciasComRastreabilidade 
                    });
                    console.log(`Cautela ${doc.id}: ${data.destinatario} tem ${pendenciasComRastreabilidade.length} pendÃªncia(s).`);
                }
            }
        });

        // ATUALIZA O CACHE GLOBAL
        cachePendenciasCautela = cautelasComPendencia;
        console.log("Total de itens para troca localizados:", totalPendenciasTroca);

        const cardExistente = document.getElementById('card-pendencia-cautela-ativa');
        
        if (totalPendenciasTroca === 0) {
            if (cardExistente) cardExistente.remove();
            return;
        }

        // MONTAGEM DO CARD
        let cardHtml = `
            <div id="card-pendencia-cautela-ativa" class="sector-card status-alert" 
                 style="border-left: 5px solid #f57c00; background-color: #fff3e0; margin-bottom: 20px; flex: 1 1 100%; cursor: pointer; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                 onclick="abrirGestaoPendenciasCautela()">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: #e65100; margin: 0; font-size: 1.1em;"><i class="fas fa-exclamation-circle"></i> PendÃªncias de Cautelas Ativas</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">Existem itens aguardando substituiÃ§Ã£o ou recolhimento.</p>
                    </div>
                    <div class="count-value" style="color: #e65100; font-size: 2em; font-weight: bold;">${totalPendenciasTroca}</div>
                </div>
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(230, 81, 0, 0.2); color: #e65100; font-size: 0.8em; font-weight: bold; text-transform: uppercase;">
                    Clique para gerenciar
                </div>
            </div>
        `;

        if (cardExistente) {
            cardExistente.outerHTML = cardHtml;
        } else {
            container.insertAdjacentHTML('afterbegin', cardHtml);
        }

    } catch (e) {
        console.error("Erro ao carregar pendÃªncias de cautela:", e);
    }
}
async function abrirGestaoPendenciasCautela() {
    const cautelas = cachePendenciasCautela;
    const wrapper = document.getElementById('ca-table-wrapper');
    const tbody = document.getElementById('ca-list-body');
    if (!wrapper || !tbody) return;

    // 1. AJUSTE DO CABEÃ‡ALHO DA TABELA
    const thead = wrapper.querySelector('thead tr');
    if (thead) {
        thead.innerHTML = `
            <th>Material</th>
            <th>Cautela ID</th>
            <th>AlteraÃ§Ã£o</th>
            <th>Conferente/Data</th>
            <th>AÃ§Ã£o</th>
        `;
    }

    document.getElementById('table-title').innerHTML = `<i class="fas fa-exchange-alt"></i> SubstituiÃ§Ãµes Pendentes`;
    tbody.innerHTML = '';
    wrapper.querySelector('table').style.display = 'table';
    document.getElementById('no-issues-msg').style.display = 'none';

    cautelas.forEach(cautela => {
        cautela.pendencias.forEach(p => {
            const tr = tbody.insertRow();
            
            // Coluna Material
            const tdMaterial = tr.insertCell();
            tdMaterial.innerHTML = `
                <strong>${p.item_nome}</strong><br>
                <small style="color:#800020">Origem: ${cautela.local_origem || 'NÃ£o especificado'}</small>
            `;

            // Coluna Cautela ID
            const tdCautela = tr.insertCell();
            tdCautela.innerHTML = `<span class="status-badge badge-cautela" style="font-family: monospace; font-size: 0.95em;">${cautela.id}</span>`;

            // Coluna AlteraÃ§Ã£o (Single vs Multi)
            const tdAlteracao = tr.insertCell();
            tdAlteracao.style.textAlign = "left";
            
            const itemNome = (p.item_nome || "").trim().toUpperCase();
            const itemTomb = (p.item_tombamento || "S/T").trim().toUpperCase();
            const itemQtd = p.quantidade || 1;
            const ehItemSingle = !p.item_tombamento || itemTomb === "S/T" || itemTomb === itemNome;

            const labelIdentificador = ehItemSingle 
                ? `<b style="color:#666;">Qtd:</b> ${itemQtd} un.` 
                : `<b style="color:#666;">Tomb:</b> ${p.item_tombamento}`;

            tdAlteracao.innerHTML = `
                <div style="font-size:0.9em;">
                    <b style="color:#d90f23;">Motivo:</b> ${p.motivo}<br>
                    ${labelIdentificador}
                </div>
            `;

            // Coluna Solicitante e Data
            const tdMilitar = tr.insertCell();
            let dataFormatada = "Data indisponÃ­vel";
            if (p.timestamp) {
                const d = p.timestamp.seconds ? new Date(p.timestamp.seconds * 1000) : new Date(p.timestamp);
                if (!isNaN(d.getTime())) dataFormatada = d.toLocaleString('pt-BR');
            }
            tdMilitar.innerHTML = `<small><b>${p.solicitante_nome}</b><br>${dataFormatada}</small>`;

            // PreparaÃ§Ã£o dos dados (btnData)
            const idItemReal = p.id_item || "";
            const idBaseReal = p.id_base || "";
            const tombReal = p.item_tombamento || "";

            const btnData = encodeURIComponent(JSON.stringify({
                cautelaId: cautela.id,
                solicitacaoId: p.id_solicitacao,
                itemNome: p.item_nome,
                itemTomb: tombReal,
                localId: cautela.local_origem_id,
                motivo: p.motivo,
                uidItem: idItemReal || (idBaseReal ? `${idBaseReal}-${tombReal}` : ""),
                solicitante_nome: p.solicitante_nome || "Militar", 
                gestor_alvo_nome: p.solicitante_nome || "Militar",
                gestor_alvo_uid: p.solicitante_uid || "",
                quantidade: itemQtd
            }));

            const tdAcao = tr.insertCell();
            tdAcao.innerHTML = `
                <button class="btn-modern-action" style="background-color: #f57c00; padding: 5px 10px; cursor:pointer; display: flex; align-items: center; gap: 8px;" 
                    onclick="abrirDecisaoGestor('${btnData}')">
                    <i class="fas fa-tools"></i> Resolver
                </button>
            `;
        });
    });

    wrapper.style.display = 'block';
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function abrirDecisaoGestor(dataJson) {
    try {
        const data = JSON.parse(decodeURIComponent(dataJson));
        
        // 1. NORMALIZAÃ‡ÃƒO DE RASTREABILIDADE
        data.gestor_alvo_nome = data.solicitante_nome || data.gestor_alvo_nome || "Militar";
        data.gestor_alvo_uid = data.solicitante_uid || data.gestor_alvo_uid || "";
        data.itemNome = data.item_nome || data.itemNome || "Item sem nome";
        data.motivo = data.motivo || "Avaria relatada";

        // 2. CORREÃ‡ÃƒO DE IDS ESPECÃFICOS
        if (!data.uidItem || (data.uidItem && String(data.uidItem).includes('undefined'))) {
            const nomeUpper = data.itemNome.toUpperCase();
            if (nomeUpper.includes("PÃ‰ DE CABRA")) {
                data.uidItem = "56911524-65986249";
                data.id_base = "56911524-65986249";
            } else if (nomeUpper.includes("EPR SCOTT")) {
                data.uidItem = "56911524-64012364-" + (data.itemTomb || data.item_tombamento || "S/T");
                data.id_base = "56911524-64012364";
            }
        }

        data.quantidade = Number(data.quantidade || data.itemQtd || 1);
        pendenciaSendoResolvida = data; 

        // 3. PREPARAÃ‡ÃƒO DA INTERFACE DO MODAL
        const tombReal = data.itemTomb || data.item_tombamento || "";
        const ehItemSingle = !tombReal || tombReal === "S/T" || tombReal.trim().toUpperCase() === data.itemNome.trim().toUpperCase();
        
        const identificadorHtml = ehItemSingle 
            ? `<b>Quantidade relatada:</b> <span style="color:#d90f23; font-weight:bold;">${data.quantidade} un.</span>` 
            : `<b>Tombamento:</b> <span style="color:#800020; font-weight:bold;">${tombReal}</span>`;

        const infoBox = document.getElementById('info-item-decisao');
        if (infoBox) {
            infoBox.innerHTML = `
                <div style="line-height: 1.6; text-align: left; background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #ddd; border-left: 5px solid #800020;">
                    <b style="color: #800020; font-size: 1.1em; text-transform: uppercase;">${data.itemNome}</b><br>
                    <div style="margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px; font-size: 0.95em;">
                        ${identificadorHtml}<br>
                        <b>Relatado por:</b> <span style="color: #2c7399; font-weight: bold;">${data.gestor_alvo_nome}</span><br>
                        <b>Motivo:</b> <span style="color:#333;">${data.motivo}</span>
                    </div>
                </div>
            `;
        }

        const modal = document.getElementById('modalDecisaoGestor');
        if (modal) modal.style.display = 'flex';

    } catch (e) {
        console.error("Erro crÃ­tico ao abrir modal de decisÃ£o:", e);
        alert("Erro ao processar dados da pendÃªncia.");
    }
}
		async function executarRecolhimentoApenas() {
    if (!pendenciaSendoResolvida) return;
    
    const p = pendenciaSendoResolvida;
    const confirmacao = confirm(`Deseja confirmar o recolhimento de "${p.itemNome}"?\n\nO item sairÃ¡ da carga do militar e retornarÃ¡ ao estoque com carimbo de PENDÃŠNCIA.`);
    if (!confirmacao) return;

    try {
        const cautelaRef = db.collection('cautelas_abertas').doc(p.cautelaId);
        const listaRef = db.collection('listas_conferencia').doc(p.localId);

        const [docCautela, docLista] = await Promise.all([
            cautelaRef.get(),
            listaRef.get()
        ]);

        if (!docCautela.exists || !docLista.exists) return alert("Erro: Documentos nÃ£o localizados.");

        const dataCautela = docCautela.data();
        const dataRegistro = new Date().toLocaleString('pt-BR');
        const dataSimples = new Date().toLocaleDateString('pt-BR');
        const nomeLimpo = (p.itemNome || "").trim().toUpperCase();

        // Identifica o Gestor logado para o histÃ³rico (Posto + Nome de Guerra)
        let nomeGestorLogado = "Gestor";
        if (typeof currentUserData !== 'undefined' && currentUserData.nome_militar_completo) {
            nomeGestorLogado = currentUserData.nome_militar_completo;
        }

        // 1. ATUALIZAÃ‡ÃƒO DA CARGA DO MILITAR (CAUTELA) - CORREÃ‡ÃƒO CIRÃšRGICA DE QUANTIDADE
        const pendenciasRestantes = (dataCautela.pendencias_ativas || []).filter(item => 
            String(item.id_solicitacao) !== String(p.solicitacaoId)
        );

        const qtdBaixa = Number(p.quantidade) || 1;
        let novosItensCautela = [];

        // LÃ³gica para detectar se Ã© item de estoque (Single)
        const itemTombReal = (p.itemTomb || "S/T").trim().toUpperCase();
        const ehItemSingle = !p.itemTomb || itemTombReal === "S/T" || itemTombReal === nomeLimpo;

        if (!ehItemSingle) {
            // ITEM MULTI: Remove o objeto pelo tombamento especÃ­fico
            novosItensCautela = (dataCautela.itens || []).filter(it => it.tombamento !== p.itemTomb);
        } else {
            // ITEM SINGLE: Subtrai apenas a quantidade reportada, preservando o restante
            novosItensCautela = (dataCautela.itens || []).map(it => {
                const isMesmoItem = it.id === p.id_base || it.id === p.uidItem || it.nome.trim().toUpperCase() === nomeLimpo;

                if (isMesmoItem) {
                    const novaQtd = (Number(it.quantidade) || 0) - qtdBaixa;
                    return novaQtd > 0 ? { ...it, quantidade: novaQtd } : null;
                }
                return it;
            }).filter(it => it !== null);
        }

        // 2. ATUALIZAÃ‡ÃƒO DO ESTOQUE (LISTA MESTRA) - CONVERSÃƒO DE CARIMBOS
        const novaListaMestra = docLista.data().list.map(setor => ({
            ...setor,
            itens: (setor.itens || []).map(it => {
                if (it.nome.trim().toUpperCase() === nomeLimpo || it.id === p.id_base) {
                    
                    const novoIdPendencia = "PEND-" + Date.now();
                    const descricaoPadrao = `${p.motivo} (RECOLHIDO DE ${p.cautelaId})`;

                    // A. TRATA ITENS MULTI (Tombamentos)
                    if (it.tipo === 'multi' && it.tombamentos) {
                        it.tombamentos = it.tombamentos.map(t => {
                            if (t.tomb === p.itemTomb) {
                                delete t.cautela; // Remove carimbo LARANJA
                                t.status = 'pending'; 
                                
                                if (!t.pendencias_ids) t.pendencias_ids = [];
                                t.pendencias_ids.push({
                                    id: novoIdPendencia,
                                    quantidade: 1,
                                    descricao: descricaoPadrao,
                                    data_criacao: dataSimples,
                                    status_gestao: "PENDENTE",
                                    tipo: "PENDENCIA",
                                    autor_nome: p.gestor_alvo_nome || "Militar"
                                });
                            }
                            return t;
                        });
                    }

                    // B. TRATA ITENS SINGLE (ReduÃ§Ã£o de carimbo laranja no estoque)
                    if (it.tipo === 'single' && it.cautelas) {
                        it.cautelas = it.cautelas.map(c => {
                            if (c.id === p.cautelaId) {
                                const novaQtdC = (Number(c.quantidade) || 0) - qtdBaixa;
                                return novaQtdC > 0 ? { ...c, quantidade: novaQtdC } : null;
                            }
                            return c;
                        }).filter(c => c !== null);
                    }

                    // C. CARIMBO DE PENDÃŠNCIA GERAL (Vermelho)
                    if (!it.pendencias_ids) it.pendencias_ids = [];
                    it.pendencias_ids.push({
                        id: novoIdPendencia,
                        quantidade: qtdBaixa,
                        descricao: descricaoPadrao,
                        data_criacao: dataSimples,
                        status_gestao: "PENDENTE",
                        tipo: "PENDENCIA",
                        autor_nome: p.gestor_alvo_nome || "Militar"
                    });

                    // D. HISTÃ“RICO DE VIDA DO ITEM
                    if (!it.historico_vida) it.historico_vida = [];
                    it.historico_vida.push({
                        data: dataRegistro,
                        evento: "RECOLHIMENTO_AVARIA",
                        detalhes: `Recolhimento de ${qtdBaixa}un. Item saiu da carga de ${p.gestor_alvo_nome} e retornou como pendÃªncia.`,
                        quem: nomeGestorLogado
                    });
                }
                return it;
            })
        }));

        // --- PREPARAÃ‡ÃƒO DO TEXTO DO HISTÃ“RICO DA CAUTELA ---
        const prefixoDescricao = ehItemSingle ? `${qtdBaixa}un de ` : "Item ";

        const batch = db.batch();
        
        // Update Cautela com menÃ§Ã£o Ã  quantidade
        batch.update(cautelaRef, {
            itens: novosItensCautela,
            pendencias_ativas: pendenciasRestantes,
            historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion({
                data: dataRegistro,
                descricao: `ğŸ“¥Recolhimento: ${prefixoDescricao}${p.itemNome} removido da carga. Motivo: ${p.motivo}`,
                militar: nomeGestorLogado
            })
        });

        // Update Lista Mestra
        batch.update(listaRef, { 
            list: novaListaMestra, 
            updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
        });

        await batch.commit();
        alert(`âœ… Recolhimento concluÃ­do!\nSaldo atualizado na carga do militar.`);
        
        if (document.getElementById('modalDecisaoGestor')) document.getElementById('modalDecisaoGestor').style.display = 'none';
        if (typeof fecharTabela === 'function') fecharTabela(); 
        if (typeof loadCaaData === 'function') await loadCaaData(); 

    } catch (e) {
        console.error("Erro fatal no recolhimento:", e);
        alert("âŒ Erro ao processar recolhimento: " + e.message);
    }
}
		
// FUNÃ‡Ã•ES AUXILIARES PARA LIMPEZA DE CÃ“DIGO
function transformarEmAvariado(item, tomb, cautelaId, motivo, relator) {
    const { cautela, ...limpo } = item;
    
    // Gera o log para o item que quebrou
    const historicoAtualizado = gerarLogMovimentacao(item, "SUBSTITUIÃ‡ÃƒO_SAÃDA", 
        `Item retirado de carga devido Ã  avaria. SubstituÃ­do pelo novo tombamento. Motivo: ${motivo}`);

    return { 
        ...limpo, 
        situacao: "AVARIADO",
        id_cautela_origem: cautelaId,
        motivo_avaria: motivo,
        relatado_por: relator,
        data_avaria: new Date().toLocaleString('pt-BR'),
        historico_vida: historicoAtualizado 
    };
}

function injetarCautelaNoItem(item, tomb, dadosMilitar) {
    // Gera o log para o item bom que estÃ¡ entrando
    const historicoAtualizado = gerarLogMovimentacao(item, "SUBSTITUIÃ‡ÃƒO_ENTRADA", 
        `Item inserido na cautela ${dadosMilitar.id} em substituiÃ§Ã£o ao item avariado anterior.`);

    return { 
        ...item, 
        situacao: "DISPONÃVEL",
        status_cautela: "ABERTA",
        historico_vida: historicoAtualizado,
        cautela: {
            id: dadosMilitar.id,
            destinatario: dadosMilitar.destinatario,
            data: dadosMilitar.data,
            quantidade: 1
        }
    };
}
		function gerarLogMovimentacao(itemObj, evento, detalhes) {
    if (!itemObj.historico_vida) itemObj.historico_vida = [];
    
    itemObj.historico_vida.push({
        data: new Date().toLocaleString('pt-BR'),
        evento: evento,
        autor: `${userInfo.postoGraduacao} ${userInfo.nomeGuerra}`,
        detalhes: detalhes,
        timestamp: Date.now()
    });
    
    return itemObj.historico_vida;
}
		
		// FunÃ§Ã£o para abrir o modal e carregar itens de todas as listas do gestor
async function abrirSeletorGlobalSubstituicao() {
    if (!pendenciaSendoResolvida) return;
    const p = pendenciaSendoResolvida;
    const modal = document.getElementById('modalSeletorEstoque');
    const container = document.getElementById('listaEstoqueDisponivel');
    
    // Identifica o "DNA" (prefixo do UID) - Ex: de 'EPR-01-511527' para 'EPR-01'
    const partesId = p.uidItem.split('-');
    partesId.pop(); // Remove o sufixo (tombamento)
    const dnaBusca = partesId.join('-'); 

    container.innerHTML = `<div class="loader-p">Buscando ${p.itemNome} em todas as suas ftr/setores...</div>`;
    modal.style.display = 'block';

    try {
        // Busca TODAS as listas de conferÃªncia (JurisdiÃ§Ã£o do Gestor)
        const snapshot = await db.collection('listas_conferencia').get();
        let htmlAcumulado = '';
        let totalEncontrado = 0;

        snapshot.forEach(docLista => {
            const nomeLista = docLista.id.toUpperCase();
            const dados = docLista.data();

            if (dados.list) {
                dados.list.forEach(setor => {
                    setor.itens.forEach(item => {
                        
                        // FunÃ§Ã£o interna para validar e montar o HTML do card
                        const validarEExibir = (entidade, idReal) => {
                            // Verifica se o ID comeÃ§a com o DNA e se estÃ¡ DISPONÃVEL
                            if (idReal.startsWith(dnaBusca) && !entidade.cautela && entidade.situacao !== 'AVARIADO' && idReal !== p.uidItem) {
                                totalEncontrado++;
                                htmlAcumulado += `
                                    <div class="item-selecao-global" style="border: 1px solid #ddd; padding: 12px; margin-bottom: 8px; border-radius: 8px; background: white;">
                                        <div style="display:flex; justify-content:space-between; align-items:center;">
                                            <div>
                                                <small style="color: #666; font-weight: bold;">ORIGEM: ${nomeLista}</small><br>
                                                <b>Tombamento: ${entidade.tomb || entidade.tombamento}</b>
                                            </div>
                                            <button class="btn-resolver" style="width:auto; padding: 5px 15px;" 
                                                onclick="confirmarTrocaCruzada('${idReal}', '${docLista.id}', '${entidade.tomb || entidade.tombamento}')">
                                                Selecionar
                                            </button>
                                        </div>
                                    </div>`;
                            }
                        };

                        if (item.tipo === 'multi' && item.tombamentos) {
                            item.tombamentos.forEach(t => validarEExibir(t, `${item.id}-${t.tomb}`));
                        } else {
                            validarEExibir(item, item.id);
                        }
                    });
                });
            }
        });

        container.innerHTML = totalEncontrado > 0 ? htmlAcumulado : `<p style="text-align:center; padding:20px;">Nenhum item reserva do tipo <b>${p.itemNome}</b> disponÃ­vel em suas listas.</p>`;

    } catch (e) {
        console.error(e);
        container.innerHTML = "<p>Erro ao processar busca global.</p>";
    }
}
	async function confirmarTrocaCruzada(uidNovo, listaOrigemNovo, tombamentoNovo, cautelaId, localIdOrigem, idBaseOrigem, nomeItemOrigem, motivoMilitar, uidResponsavel, nomeResponsavel) {
    const dataFormatada = new Date().toLocaleString('pt-BR');
    const dataSimples = new Date().toLocaleDateString('pt-BR');
    const nomeLimpo = (nomeItemOrigem || "").trim().toUpperCase();
    const nomeMilitarRelator = nomeResponsavel || "Militar";
    const uidMilitarRelator = uidResponsavel || "";

    // ğŸ›‘ BUSCA O NOME REAL DO GESTOR LOGADO NO DASHBOARD
    let nomeGestorLogado = "Gestor";
    if (typeof currentUserData !== 'undefined' && currentUserData.nome_militar_completo) {
        nomeGestorLogado = currentUserData.nome_militar_completo;
    }

    try {
        const batch = db.batch();
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaId);
        const listaOrigemRef = db.collection('listas_conferencia').doc(localIdOrigem);

        // 1. ATUALIZAÃ‡ÃƒO DA CAUTELA (CARGA DO MILITAR)
        const docC = await cautelaRef.get();
        if (docC.exists) {
            const d = docC.data();
            const pAtivas = (d.pendencias_ativas || []).filter(pa => (pa.item_nome || "").trim().toUpperCase() !== nomeLimpo);
            
            // Identifica se o novo item Ã© multi ou single para formatar a descriÃ§Ã£o do histÃ³rico
            const ehMulti = tombamentoNovo && tombamentoNovo !== "" && tombamentoNovo !== nomeItemOrigem;
            const identificadorNovo = ehMulti ? `tombamento ${tombamentoNovo}` : `${uidNovo.split('-').pop()} unidades`;

            const itensC = (d.itens || []).map(it => {
                if (it.nome.trim().toUpperCase() === nomeLimpo) {
                    return { ...it, id: uidNovo, tombamento: tombamentoNovo || "" };
                }
                return it;
            });

            batch.update(cautelaRef, { 
                pendencias_ativas: pAtivas, 
                itens: itensC,
                historico_movimentacoes: firebase.firestore.FieldValue.arrayUnion({
                    data: dataFormatada,
                    // âœ… MUDANÃ‡A: "ğŸ”„SubstituiÃ§Ã£o:" e correÃ§Ã£o do texto de identificaÃ§Ã£o
                    descricao: `ğŸ”„SubstituiÃ§Ã£o: Item ${nomeItemOrigem} substituÃ­do por ${identificadorNovo}.`,
                    militar: nomeGestorLogado // âœ… MUDANÃ‡A: Agora aparece CAP QPCBM VIDO (ou quem estiver logado)
                })
            });
        }

        // 2. ATUALIZAÃ‡ÃƒO DO ESTOQUE (ITENS SINGLE E MULTI)
        const docL = await listaOrigemRef.get();
        if (docL.exists) {
            const listData = docL.data().list.map(setor => ({
                ...setor,
                itens: (setor.itens || []).map(it => {
                    if (it.id === idBaseOrigem || it.nome.trim().toUpperCase() === nomeLimpo) {
                        
                        let objetoCautelaParaMover = null;
                        const novoIdPendencia = "PEND-" + Date.now();
                        // Aqui mantivemos o padrÃ£o solicitado anteriormente para o carimbo vermelho
                        const descricaoPadrao = `${motivoMilitar} (IDENTIFICADO EM: ${cautelaId})`;

                        if (it.tipo === "multi" && it.tombamentos) {
                            it.tombamentos = it.tombamentos.map(t => {
                                if (t.cautela && t.cautela.id === cautelaId) {
                                    objetoCautelaParaMover = t.cautela; 
                                    delete t.cautela;
                                    if (!t.pendencias_ids) t.pendencias_ids = [];
                                    t.pendencias_ids.push({
                                        id: novoIdPendencia,
                                        quantidade: 1,
                                        descricao: descricaoPadrao,
                                        data_criacao: dataSimples,
                                        status_gestao: "PENDENTE",
                                        tipo: "PENDENCIA",
                                        autor_nome: nomeMilitarRelator
                                    });
                                }
                                return t;
                            }).map(t => {
                                if (t.tomb === tombamentoNovo) t.cautela = objetoCautelaParaMover; 
                                return t;
                            });
                        }

                        if (!it.pendencias_ids) it.pendencias_ids = [];
                        it.pendencias_ids.push({
                            id: novoIdPendencia,
                            quantidade: 1,
                            descricao: descricaoPadrao,
                            data_criacao: dataSimples,
                            status_gestao: "PENDENTE",
                            tipo: "PENDENCIA",
                            autor_nome: nomeMilitarRelator
                        });

                        if (!it.historico_vida) it.historico_vida = [];
                        it.historico_vida.push({
                            data: dataFormatada,
                            evento: "RETORNO_TROCA",
                            detalhes: `ğŸ”„SubstituiÃ§Ã£o efetuada por ${nomeGestorLogado}.`,
                            quem: nomeGestorLogado
                        });
                    }
                    return it;
                })
            }));
            batch.update(listaOrigemRef, { list: listData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        }

        await batch.commit();
        alert(`âœ… SubstituiÃ§Ã£o concluÃ­da!\nRegistrado por: ${nomeGestorLogado}`);
        location.reload();
    } catch (e) {
        console.error(e);
        alert("Erro: " + e.message);
    }
}
	async function prepararSubstituicaoFisica() {
    if (!pendenciaSendoResolvida) return;
    const p = pendenciaSendoResolvida;
    const modalSeletor = document.getElementById('modalSeletorEstoque');
    const container = document.getElementById('listaEstoqueDisponivel');

    document.getElementById('modalDecisaoGestor').style.display = 'none';
    modalSeletor.style.display = 'flex';
    container.innerHTML = `<div style="text-align:center; padding:30px;"><i class="fas fa-sync fa-spin"></i> Buscando itens compatÃ­veis no estoque...</div>`;

    try {
        const idReferencia = p.uidItem || p.idItem || p.id_base || "";
        const partes = idReferencia.split('-');
        let dnaBusca = partes.length > 2 ? partes.slice(0, 2).join('-') : idReferencia;
        
        const motivoMilitar = (p.motivo || "Avaria reportada").replace(/'/g, "\\'");
        const uidResponsavel = p.gestor_alvo_uid || ""; 
        const nomeResponsavel = (p.gestor_alvo_nome || "Militar").replace(/'/g, "\\'");
        const nomeEscapado = p.itemNome.replace(/'/g, "\\'");

        const snapshot = await db.collection('listas_conferencia').get();
        let htmlAcumulado = '';
        let totalEncontrado = 0;

        snapshot.forEach(docLista => {
            const dadosLista = docLista.data();
            const nomeLocal = dadosLista.nome_local || docLista.id.toUpperCase();

            if (dadosLista.list) {
                dadosLista.list.forEach(setor => {
                    setor.itens.forEach(item => {
                        if (item.id && item.id.startsWith(dnaBusca)) {
                            
                            // --- LÃ“GICA PARA ITEM SINGLE ---
                            if (item.tipo === 'single' || !item.tombamentos || item.tombamentos.length === 0) {
                                const qtdCautelada = (item.cautelas || []).reduce((acc, c) => acc + (Number(c.quantidade) || 0), 0);
                                const qtdPendente = (item.pendencias_ids || []).reduce((acc, pen) => acc + (Number(pen.quantidade) || 0), 0);
                                const saldoDisponivel = (Number(item.quantidadeEsperada) || 0) - qtdCautelada - qtdPendente;

                                if (saldoDisponivel > 0) {
                                    totalEncontrado++;
                                    const etiquetaLocal = docLista.id === p.localId ? `${nomeLocal} (ESTOQUE LOCAL)` : nomeLocal;
                                    
                                    htmlAcumulado += `
                                        <div class="item-selecao-global" style="border: 1px solid #ddd; padding: 15px; border-radius: 10px; background: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                            <div style="flex: 1;">
                                                <small style="color: #1b8a3e; font-weight: bold;"><i class="fas fa-map-marker-alt"></i> ${etiquetaLocal}</small><br>
                                                <b style="color: #333; font-size: 1.1em;">${item.nome}</b><br>
                                                <small style="color: #666;">Saldo disponÃ­vel: <b>${saldoDisponivel} un</b></small>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 15px;">
                                                <div style="display: flex; flex-direction: column; align-items: center;">
                                                    <label style="font-size: 0.7em; font-weight: bold; color: #555; margin-bottom: 4px; text-transform: uppercase;">Qtd</label>
                                                    <input type="number" id="qtd_subst_${item.id}_${docLista.id}" 
                                                        value="1" min="1" max="${saldoDisponivel}" 
                                                        style="width: 55px; padding: 8px; border: 1px solid #1b8a3e; border-radius: 5px; text-align: center; font-weight: bold;">
                                                </div>
                                                <button class="btn-resolver" style="height: 42px; padding: 0 20px; background: #1b8a3e; color:white; border:none; border-radius:5px; cursor:pointer; font-weight: bold;" 
                                                    onclick="confirmarTrocaCruzada('${item.id}', '${docLista.id}', '${item.nome}', '${p.cautelaId}', '${p.localId}', '${p.id_base || p.uidItem}', '${nomeEscapado}', '${motivoMilitar}', '${uidResponsavel}', '${nomeResponsavel}')">
                                                    Selecionar
                                                </button>
                                            </div>
                                        </div>`;
                                }
                            }
                            // --- LÃ“GICA PARA ITEM MULTI ---
                            else {
                                item.tombamentos.forEach(t => {
                                    const idCompleto = `${item.id}-${t.tomb}`;
                                    const temPendenciaAtiva = (t.pendencias_ids && t.pendencias_ids.length > 0);
                                    const disponivel = !t.cautela && !temPendenciaAtiva && t.situacao !== 'AVARIADO';
                                    
                                    if (disponivel && idCompleto !== idReferencia) {
                                        totalEncontrado++;
                                        const etiquetaLocal = docLista.id === p.localId ? `${nomeLocal} (RESERVA)` : nomeLocal;

                                        htmlAcumulado += `
                                            <div class="item-selecao-global" style="border: 1px solid #ddd; padding: 15px; border-radius: 10px; background: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                                <div>
                                                    <small style="color: #1b8a3e; font-weight: bold;"><i class="fas fa-map-marker-alt"></i> ${etiquetaLocal}</small><br>
                                                    <b style="color: #333;">Tombamento: ${t.tomb}</b><br>
                                                    <small style="color: #666;">${item.nome}</small>
                                                </div>
                                                <button class="btn-resolver" style="width:auto; padding: 10px 15px; background: #1b8a3e; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;" 
                                                    onclick="confirmarTrocaCruzada('${idCompleto}', '${docLista.id}', '${t.tomb}', '${p.cautelaId}', '${p.localId}', '${p.id_base || p.uidItem}', '${nomeEscapado}', '${motivoMilitar}', '${uidResponsavel}', '${nomeResponsavel}')">
                                                    Selecionar
                                                </button>
                                            </div>`;
                                    }
                                });
                            }
                        }
                    });
                });
            }
        });

        container.innerHTML = totalEncontrado > 0 ? htmlAcumulado : `<div style="text-align:center; padding:20px; color:#666;">Nenhum item compatÃ­vel livre encontrado.</div>`;

    } catch (e) {
        console.error("Erro na busca global:", e);
        container.innerHTML = `<div style="color:red; padding:20px; text-align:center;">Erro: ${e.message}</div>`;
    }
}
		async function sincronizarAlmoxarifado() {
    if(!confirm("Deseja recalcular o saldo global baseado em todas as listas da unidade?")) return;
    
    // Feedback visual de carregamento
    const tbody = document.getElementById('almox-body');
    if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;"><i class="fas fa-sync fa-spin"></i> Sincronizando dados das viaturas...</td></tr>';

    const almoxRef = db.collection('almoxarifado_central');
    
    try {
        const unitListIds = await getUnitListIds(); 
        const inventario = {};

        for (const listaId of unitListIds) {
            const doc = await db.collection('listas_conferencia').doc(listaId).get();
            if (!doc.exists) continue;
            
            const data = doc.data().list || [];
            data.forEach(setor => {
                setor.itens.forEach(item => {
                    const nome = item.nome.trim().toUpperCase();
                    if (!inventario[nome]) {
                        inventario[nome] = { total: 0, emCarga: 0, emAlteracao: 0, tipo: item.tipo };
                    }
                    
                    if (item.tipo === 'single') {
                        const esperado = Number(item.quantidadeEsperada || item.quantidade) || 0;
                        const cautelado = (item.cautelas || []).reduce((s, c) => s + (Number(c.quantidade) || 0), 0);
                        const pendente = (item.pendencias_ids || []).reduce((s, p) => s + (Number(p.quantidade) || 0), 0);
                        
                        inventario[nome].total += esperado;
                        inventario[nome].emCarga += (esperado - cautelado - pendente);
                        inventario[nome].emAlteracao += (cautelado + pendente);
                    } else {
                        const tombamentos = item.tombamentos || [];
                        inventario[nome].total += tombamentos.length;
                        inventario[nome].emCarga += tombamentos.filter(t => !t.cautela && (!t.pendencias_ids || t.pendencias_ids.length === 0)).length;
                        inventario[nome].emAlteracao += tombamentos.filter(t => t.cautela || (t.pendencias_ids && t.pendencias_ids.length > 0)).length;
                    }
                });
            });
        }

        const batch = db.batch();
        // Prefixo para garantir que uma unidade nÃ£o sobrescreva a outra no Firestore
        const prefixo = currentUserData.unidade.replace(/[^a-zA-Z0-9]/g, '_');

        for (const [nome, dados] of Object.entries(inventario)) {
            const safeNome = nome.replace(/[^a-zA-Z0-9]/g, '_');
            const docId = `${prefixo}_${safeNome}`;

            batch.set(almoxRef.doc(docId), {
                nome: nome,
                total: dados.total,
                emCarga: dados.emCarga,
                emAlteracao: dados.emAlteracao,
                unidade: currentUserData.unidade,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                // Nota: NÃƒO zeramos o 'disponivel' aqui para nÃ£o perder o que jÃ¡ foi guardado fisicamente
            }, { merge: true }); 
        }

        await batch.commit();
        alert("âœ… SincronizaÃ§Ã£o concluÃ­da! InventÃ¡rio das viaturas atualizado.");
        carregarAlmoxarifadoUI();

    } catch (e) {
        console.error("Erro na sincronizaÃ§Ã£o:", e);
        alert("Erro ao sincronizar. Verifique o console.");
        carregarAlmoxarifadoUI(); // Tenta recarregar a UI mesmo com erro
    }
}
	/**
 * Renderiza a interface da tabela de Almoxarifado.
 * Esta funÃ§Ã£o resolve o erro "is not defined" no console.
 */
async function carregarAlmoxarifadoUI() {
    const table = document.getElementById('almox-table');
    const thead = table ? table.querySelector('thead') : null;
    const tbody = document.getElementById('almox-body');
    const breadcrumb = document.getElementById('almox-breadcrumb');

    if (!tbody) return;

    // 1. Restaura o cabeÃ§alho original (caso venha da tela de detalhes)
    if (thead) {
        thead.innerHTML = `
            <tr>
                <th>Material</th>
                <th style="text-align: center;">Total Geral</th>
                <th style="text-align: center;">Em Uso</th>
                <th style="text-align: center;">Pendente</th>
                <th style="text-align: center;">DisponÃ­vel</th>
                <th style="text-align: center;">AÃ§Ãµes</th>
            </tr>`;
    }

    // 2. Reseta o breadcrumb para o estado inicial
    if (breadcrumb) {
        breadcrumb.innerHTML = `Almoxarifado > InventÃ¡rio Geral`;
    }

    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Carregando inventÃ¡rio...</td></tr>';

    try {
        // Busca apenas os itens da unidade do Gestor logado
        const snap = await db.collection('almoxarifado_central')
                             .where('unidade', '==', currentUserData.unidade)
                             .get();
        
        let html = '';
        if (snap.empty) {
            html = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">Nenhum item sincronizado nesta unidade. Clique em "Sincronizar Saldos".</td></tr>';
        } else {
            // Converte para array e ordena alfabeticamente
            const docs = [];
            snap.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));
            docs.sort((a, b) => a.nome.localeCompare(b.nome));

            docs.forEach(d => {
                const total = d.total || 0;
                const disponivel = d.disponivel || 0;
                
                // SemÃ¡foro de estoque para o campo DisponÃ­vel
                const statusColor = disponivel === 0 ? '#d90f23' : disponivel < (total * 0.2) ? '#f57c00' : '#1b8a3e';

                html += `
                    <tr>
                        <td data-label="Material">
                            <strong>${d.nome}</strong><br>
                            <small style="color:#888;">${d.tipo === 'multi' ? 'TOMBAMENTO' : 'QUANTIDADE'}</small>
                        </td>
                        <td style="text-align:center;" data-label="Total">${total}</td>
                        <td style="text-align:center;" data-label="Em Carga">${d.emCarga || 0}</td>
                        <td style="text-align:center;" data-label="Em AlteraÃ§Ã£o">${d.emAlteracao || 0}</td>
                        <td style="text-align:center; font-weight:bold; color:${statusColor}; background-color:#fcfcfc;" data-label="DisponÃ­vel">
                            ${disponivel}
                        </td>
                        <td style="text-align:center;" data-label="AÃ§Ãµes">
                            <div style="display:flex; gap:5px; justify-content:center;">
                                <button class="btn-modern-action btn-edit" title="Ver DistribuiÃ§Ã£o" onclick="verDetalhesItemAlmox('${d.id}')">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button class="btn-modern-action btn-sync" title="Movimentar" onclick="abrirModalTransferencia('${d.id}')">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        tbody.innerHTML = html;

    } catch (e) {
        console.error("Erro ao carregar UI do Almoxarifado:", e);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Erro ao carregar dados da unidade.</td></tr>';
    }
}
/**
 * Filtro de pesquisa em tempo real para o Almoxarifado.
 */
function filtrarAlmoxarifado() {
    const searchTerm = document.getElementById('almox-search').value.toUpperCase();
    const categoryTerm = document.getElementById('almox-cat-filter').value;
    const rows = document.querySelectorAll('#almox-body tr');

    rows.forEach(row => {
        const textMaterial = row.cells[0]?.textContent.toUpperCase() || "";
        // No futuro, se adicionarmos categoria aos itens, filtraremos aqui tambÃ©m
        const matchesSearch = textMaterial.includes(searchTerm);
        row.style.display = matchesSearch ? "" : "none";
    });
}
		/**
 * Abre o modal e configura as opÃ§Ãµes para movimentar o item selecionado.
 */
async function abrirModalTransferencia(docId) {
    const doc = await db.collection('almoxarifado_central').doc(docId).get();
    if (!doc.exists) return;
    const item = doc.data();

    document.getElementById('almox-transf-item-nome').textContent = item.nome;
    document.getElementById('almox-transf-item-nome').setAttribute('data-docid', docId);
    
    // Carrega as viaturas da unidade no select
    const unitListIds = await getUnitListIds();
    const selectViatura = document.getElementById('almox-viatura-alvo');
    selectViatura.innerHTML = '<option value="" disabled selected>Selecione a viatura...</option>';
    
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data();

    unitListIds.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = rotas[id].nome;
        selectViatura.appendChild(opt);
    });

    document.getElementById('modal-almox-transferencia').style.display = 'flex';
}

/**
 * FunÃ§Ã£o Mestra de MovimentaÃ§Ã£o: 
 * Altera o estoque central e a lista mestra da viatura simultaneamente.
 */
async function executarMovimentacaoAlmox() {
    const tipo = document.getElementById('almox-operacao-tipo').value;
    const docId = document.getElementById('almox-transf-item-nome').getAttribute('data-docid');
    const qtd = parseInt(document.getElementById('almox-transf-qtd').value);
    const localAlvoId = document.getElementById('almox-viatura-alvo').value;
    const obs = document.getElementById('almox-transf-obs').value.trim();

    if (!qtd || qtd < 1) return alert("Informe uma quantidade vÃ¡lida.");
    if ((tipo === 'ENVIO' || tipo === 'RECOLHIMENTO') && !localAlvoId) return alert("Selecione uma viatura.");
    if (!obs) return alert("Informe a justificativa da movimentaÃ§Ã£o.");

    try {
        const almoxRef = db.collection('almoxarifado_central').doc(docId);
        const logData = {
            data: new Date().toLocaleString('pt-BR'),
            evento: tipo,
            quantidade: qtd,
            quem: currentUserData.nome_militar_completo,
            detalhes: obs
        };

        await db.runTransaction(async (transaction) => {
            const almoxDoc = await transaction.get(almoxRef);
            const aData = almoxDoc.data();

            if (tipo === 'ENTRADA') {
                transaction.update(almoxRef, {
                    total: (aData.total || 0) + qtd,
                    disponivel: (aData.disponivel || 0) + qtd,
                    historico: firebase.firestore.FieldValue.arrayUnion(logData)
                });
            } 
            // Implementaremos ENVIO e RECOLHIMENTO no prÃ³ximo passo, 
            // pois eles exigem mexer na coleÃ§Ã£o 'listas_conferencia'
        });

        alert("OperaÃ§Ã£o realizada!");
        document.getElementById('modal-almox-transferencia').style.display = 'none';
        carregarAlmoxarifadoUI();

    } catch (e) {
        console.error(e);
        alert("Erro ao processar movimentaÃ§Ã£o.");
    }
}

async function verDetalhesItemAlmox(docId) {
    const table = document.getElementById('almox-table');
    const thead = table.querySelector('thead');
    const tbody = document.getElementById('almox-body');
    const breadcrumb = document.getElementById('almox-breadcrumb');
    
    try {
        const almoxDoc = await db.collection('almoxarifado_central').doc(docId).get();
        if (!almoxDoc.exists) return;
        const itemData = almoxDoc.data();
        const itemNome = itemData.nome;
        const ehMulti = itemData.tipo === 'multi';

        // VariÃ¡veis para o Totalizador Geral
        let acumTotal = 0;
        let acumDisp = 0;
        let acumCaut = 0;
        let acumPend = 0;

        // 1. UI: NavegaÃ§Ã£o e Breadcrumb
        if(breadcrumb) {
            breadcrumb.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-secondary" onclick="carregarAlmoxarifadoUI()" style="padding: 5px 12px; font-size: 0.8em;">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <span>Almoxarifado > Detalhes > <b>${itemNome}</b></span>
                </div>`;
        }

        // 2. CabeÃ§alhos DinÃ¢micos
        if (ehMulti) {
            thead.innerHTML = `<tr><th>Tombamento</th><th>Local Atual</th><th style="text-align:center;">Status</th><th style="text-align:center;">Detalhes</th></tr>`;
        } else {
            thead.innerHTML = `<tr><th>Local / Viatura</th><th style="text-align:center;">Total Carga</th><th style="text-align:center; color:#1b8a3e;">DisponÃ­vel</th><th style="text-align:center; color:#f57c00;">Cautelados</th><th style="text-align:center; color:#d90f23;">PendÃªncias</th><th style="text-align:center;">AÃ§Ã£o</th></tr>`;
        }

        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px;"><i class="fas fa-spinner fa-spin"></i> Mapeando ativos...</td></tr>`;

        const unitListIds = await getUnitListIds();
        let htmlRows = '';

        for (const listaId of unitListIds) {
            const doc = await db.collection('listas_conferencia').doc(listaId).get();
            if (!doc.exists) continue;
            const data = doc.data();
            const list = data.list || [];
            const localNome = `${data.posto} - ${data.nome_local}`;

            list.forEach(setor => {
                setor.itens.forEach(it => {
                    if (it.nome.trim().toUpperCase() === itemNome.trim().toUpperCase()) {
                        if (ehMulti) {
                            (it.tombamentos || []).forEach(t => {
                                acumTotal++; 
                                let statusTag = '<span class="status-badge badge-solucao">DISPONÃVEL</span>';
                                let acaoBotao = '-';
                                
                                if (t.cautela) {
                                    acumCaut++;
                                    statusTag = '<span class="status-badge badge-cautela">CAUTELADO</span>';
                                    const stringC = JSON.stringify([t.cautela]).replace(/"/g, '&quot;');
                                    // PadronizaÃ§Ã£o: Ãcone de Olhinho para Cautela
                                    acaoBotao = `<button class="btn-link-detalhe" title="Ver Cautela" onclick="mostrarCarimbos('Detalhe Tombamento ${t.tomb}', '${stringC}', 'cautela', '${listaId}', '${itemNome}')"><i class="fas fa-eye"></i></button>`;
                                } else if (t.pendencias_ids && t.pendencias_ids.length > 0) {
                                    acumPend++;
                                    statusTag = '<span class="status-badge badge-pendente">PENDENTE</span>';
                                    const stringP = JSON.stringify(t.pendencias_ids).replace(/"/g, '&quot;');
                                    // PadronizaÃ§Ã£o: Ãcone de Olhinho para PendÃªncia
                                    acaoBotao = `<button class="btn-link-detalhe" title="Ver PendÃªncia" onclick="mostrarCarimbos('Detalhe Tombamento ${t.tomb}', '${stringP}', 'pendencia', '${listaId}', '${itemNome}')"><i class="fas fa-eye"></i></button>`;
                                } else {
                                    acumDisp++;
                                }
                                htmlRows += `<tr><td><b>${t.tomb}</b></td><td>${localNome}</td><td style="text-align:center;">${statusTag}</td><td style="text-align:center;">${acaoBotao}</td></tr>`;
                            });
                        } else {
                            const total = Number(it.quantidadeEsperada || it.quantidade) || 0;
                            const nCautelas = (it.cautelas || []).reduce((s, v) => s + (Number(v.quantidade) || 0), 0);
                            const nPendencias = (it.pendencias_ids || []).reduce((s, v) => s + (Number(v.quantidade) || 0), 0);
                            const disponivel = total - nCautelas - nPendencias;

                            acumTotal += total;
                            acumDisp += disponivel;
                            acumCaut += nCautelas;
                            acumPend += nPendencias;

                            const stringCautelas = JSON.stringify(it.cautelas || []).replace(/"/g, '&quot;');
                            const stringPendencias = JSON.stringify(it.pendencias_ids || []).replace(/"/g, '&quot;');

                            if (total > 0) {
                                htmlRows += `
                                    <tr>
                                        <td><b>${localNome}</b></td>
                                        <td style="text-align:center;">${total}</td>
                                        <td style="text-align:center; font-weight:bold; color:#1b8a3e;">${disponivel}</td>
                                        <td style="text-align:center;">
                                            ${nCautelas > 0 ? `<button class="btn-link-detalhe" onclick="mostrarCarimbos('Cautelas em ${localNome}', '${stringCautelas}', 'cautela', '${listaId}', '${itemNome}')">${nCautelas}</button>` : '0'}
                                        </td>
                                        <td style="text-align:center;">
                                            ${nPendencias > 0 ? `<button class="btn-link-detalhe" onclick="mostrarCarimbos('PendÃªncias em ${localNome}', '${stringPendencias}', 'pendencia', '${listaId}', '${itemNome}')">${nPendencias}</button>` : '0'}
                                        </td>
                                        <td style="text-align:center;">
                                            <button class="btn-modern-action btn-edit" style="padding:4px 8px; font-size:0.7em;" onclick="abrirEditor('${listaId}', '${data.nome_local}', '${data.unidade}')">Abrir</button>
                                        </td>
                                    </tr>`;
                            }
                        }
                    }
                });
            });
        }

        // 3. Montagem da Linha de Totalizador Geral
        let rowTotalizador = "";
        if (ehMulti) {
            rowTotalizador = `
                <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #333;">
                    <td colspan="2">TOTALIZAÃ‡ÃƒO GERAL</td>
                    <td style="text-align:center; font-size: 0.85em;">
                        <span style="color:#1b8a3e;">DISP: ${acumDisp}</span> | 
                        <span style="color:#f57c00;">CAUT: ${acumCaut}</span> | 
                        <span style="color:#d90f23;">PEND: ${acumPend}</span>
                    </td>
                    <td style="text-align:center;">${acumTotal} Itens</td>
                </tr>`;
        } else {
            rowTotalizador = `
                <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #333;">
                    <td>TOTALIZAÃ‡ÃƒO GERAL</td>
                    <td style="text-align:center; font-size: 1.1em;">${acumTotal}</td>
                    <td style="text-align:center; color:#1b8a3e; font-size: 1.1em;">${acumDisp}</td>
                    <td style="text-align:center; color:#f57c00; font-size: 1.1em;">${acumCaut}</td>
                    <td style="text-align:center; color:#d90f23; font-size: 1.1em;">${acumPend}</td>
                    <td style="text-align:center;"><i class="fas fa-sigma"></i></td>
                </tr>`;
        }

        tbody.innerHTML = (htmlRows + rowTotalizador) || '<tr><td colspan="6" style="text-align:center; padding:20px;">Nenhum exemplar localizado.</td></tr>';
    } catch (e) { console.error(e); }
}
/**
 * FunÃ§Ã£o que renderiza os carimbos originais do Conferencia App dentro do modal
 */
function mostrarCarimbos(titulo, dataJson, tipo, listaId = null, nomeItemLimpo = "") {
    const dados = JSON.parse(dataJson);
    const modal = document.getElementById('modal-detalhe-carimbos');
    const corpo = document.getElementById('corpo-modal-carimbo');
    const h3 = document.getElementById('titulo-modal-carimbo');

    if (!modal || !corpo) return;

    h3.textContent = titulo;
    modal.querySelector('.modal-content').style.borderTop = tipo === 'cautela' ? '5px solid #f57c00' : '5px solid #d90f23';
    
    let html = '';
    dados.forEach(item => {
        if (tipo === 'cautela') {
            const cId = item.id;
            html += `
                <div style="border: 1px solid #eee; padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid #f57c00; background: #fffaf5;">
                    <div style="display:flex; justify-content:space-between; align-items: flex-start; margin-bottom:8px;">
                        <div>
                            <b style="font-size: 1.1em; color: #333;">${item.destinatario}</b><br>
                            <small style="color:#666;"><i class="far fa-calendar-alt"></i> Cautelado em: ${item.data || 'N/D'}</small>
                        </div>
                        <span class="badge-cautela" style="background:#f57c00; color:white; padding:4px 10px; border-radius:15px; font-weight:bold;">${item.quantidade || 1} un</span>
                    </div>
                    <div style="text-align: right; margin-top: 10px; border-top: 1px solid #ffe0b2; padding-top: 8px;">
                        <button class="btn-modern-action" style="font-size: 0.75em; padding: 5px 10px; background-color: #f57c00;" 
                                onclick="atalhoGestaoCautela('${cId}')">
                            <i class="fas fa-external-link-alt"></i> Ver Cautela
                        </button>
                    </div>
                </div>`;
        } else {
            // Pega o ID Ãºnico da pendÃªncia para a busca cirÃºrgica
            const pId = item.id || item.pendencia_id; 

            html += `
                <div style="border: 1px solid #eee; padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid #d90f23; background: #fff5f5;">
                    <div style="display:flex; justify-content:space-between; align-items: flex-start; margin-bottom:8px;">
                        <div>
                            <b style="font-size: 1.1em; color: #333;">Relatado por: ${item.autor_nome}</b><br>
                            <small style="color:#666;"><i class="far fa-calendar-alt"></i> ${item.data_criacao || 'N/D'}</small>
                        </div>
                        <span class="badge-pendente" style="background:#d90f23; color:white; padding:4px 10px; border-radius:15px; font-weight:bold;">${item.quantidade || 1} un</span>
                    </div>
                    <div style="font-size:0.95em; color: #555; margin:8px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ffdada;">
                        <i class="fas fa-comment-dots"></i> "${item.descricao}"
                    </div>
                    <div style="text-align: right; margin-top: 10px; border-top: 1px solid #ffdada; padding-top: 8px;">
                        <button class="btn-modern-action" style="font-size: 0.75em; padding: 5px 10px; background-color: #d90f23;" 
                                onclick="atalhoGestaoPendencia('${listaId}', '${nomeItemLimpo}', '${pId}')">
                            <i class="fas fa-wrench"></i> Resolver na Viatura
                        </button>
                    </div>
                </div>`;
        }
    });

    corpo.innerHTML = html || '<p style="text-align:center; color:#999;">Nenhum registro detalhado encontrado.</p>';
    modal.style.display = 'flex';
}
/**
 * ATALHO 1: Direciona para a aba de Cautelas e abre o detalhe da cautela
 */
function atalhoGestaoCautela(cId) {
    document.getElementById('modal-detalhe-carimbos').style.display = 'none';
    switchView('cautelas');
    setTimeout(() => {
        showCautelaDetails(cId);
    }, 300);
}

/**
 * ATALHO 2: Simula o clique exato no card de pendÃªncia do Dashboard.
 */
async function atalhoGestaoPendencia(listaId, itemNomeAlvo) {
    if(!listaId) return alert("Erro: ID da lista nÃ£o identificado.");
    
    document.getElementById('modal-detalhe-carimbos').style.display = 'none';
    switchView('dashboard');

    try {
        // 1. Busca a Ãºltima conferÃªncia (O CabeÃ§alho)
        const snap = await db.collection(COLECAO_RESULTADOS)
                             .where('lista_id', '==', listaId)
                             .orderBy('timestamp', 'desc')
                             .limit(1)
                             .get();

        if(!snap.empty) {
            const docReal = snap.docs[0];
            const d = docReal.data();
            
            // 2. Prepara o objeto exatamente como a sua funÃ§Ã£o mostrarTabela espera
            // Note que usamos d.timestamp.toDate().toLocaleString() para evitar o 'undefined'
            const objetoParaTabela = {
                id: docReal.id,
                lista_id: listaId,
                local: d.local || "Viatura",
                conferente: d.conferente,
                date: d.timestamp ? d.timestamp.toDate().toLocaleString('pt-BR') : 'Data N/D',
                items: [] // Vamos preencher abaixo
            };

            // 3. Busca a Lista Mestra para extrair as PendÃªncias/Cautelas Reais
            // Esse Ã© o segredo para nÃ£o aparecer "Tudo OK"
            const docMestra = await db.collection('listas_conferencia').doc(listaId).get();
            if (docMestra.exists) {
                const dataMestra = docMestra.data().list || [];
                const pendenciasReais = [];

                for (const setor of dataMestra) {
                    for (const it of (setor.itens || [])) {
                        // PendÃªncias Single
                        if (it.pendencias_ids) {
                            it.pendencias_ids.forEach(p => pendenciasReais.push({ ...p, itemNome: it.nome, itemId: it.id, tipoRegistro: 'PENDENCIA' }));
                        }
                        // Cautelas Single
                        if (it.cautelas) {
                            it.cautelas.forEach(c => pendenciasReais.push({ ...c, itemNome: it.nome, itemId: it.id, status_gestao: 'CAUTELADO', tipoRegistro: 'CAUTELA' }));
                        }
                        // Itens Multi (Tombamentos)
                        if (it.tipo === 'multi' && it.tombamentos) {
                            it.tombamentos.forEach(t => {
                                if (t.pendencias_ids) t.pendencias_ids.forEach(p => pendenciasReais.push({ ...p, itemNome: it.nome, tombamento: t.tomb, itemId: it.id, tipoRegistro: 'PENDENCIA' }));
                                if (t.cautela) pendenciasReais.push({ ...t.cautela, itemNome: it.nome, tombamento: t.tomb, itemId: it.id, status_gestao: 'CAUTELADO', tipoRegistro: 'CAUTELA' });
                            });
                        }
                    }
                }
                objetoParaTabela.items = pendenciasReais;
            }

            // 4. Agora sim, chama a funÃ§Ã£o com os dados completos e processados
            setTimeout(() => {
                mostrarTabela(objetoParaTabela);
                
                // 5. Aponta o item alvo
                setTimeout(() => {
                    destacarItemNaTabela(itemNomeAlvo);
                }, 600);
            }, 300);
        }
    } catch (e) {
        console.error("Erro no atalho:", e);
    }
}
/**
 * Localiza o item na tabela, com sistema de espera (polling) 
 * para garantir que a renderizaÃ§Ã£o terminou.
 */
function destacarItemNaTabela(nomeItem, pendenciaId) {
    let tentativas = 0;
    const alvoNome = nomeItem ? nomeItem.trim().toUpperCase() : null;

    const intervalBusca = setInterval(() => {
        const rows = document.querySelectorAll('#ca-list-body tr');
        let linhaEncontrada = null;

        rows.forEach(row => {
            if (linhaEncontrada) return; // Se jÃ¡ achou, ignora o resto

            // 1. PRIORIDADE MÃXIMA: Busca pelo ID da PendÃªncia em qualquer lugar da linha
            if (pendenciaId) {
                // Procura o ID no HTML da linha toda (botÃµes, inputs hidden, textos)
                if (row.innerHTML.includes(pendenciaId)) {
                    linhaEncontrada = row;
                }
            } 
            
            // 2. SEGUNDA PRIORIDADE: Busca por Nome + Texto "PENDENTE" 
            // Isso evita focar no item "CAUTELADO" se o objetivo Ã© resolver pendÃªncia
            if (!linhaEncontrada && alvoNome) {
                const textoLinha = row.innerText.toUpperCase();
                // Verifica se na mesma linha tem o Nome do Item E a palavra PENDENTE
                if (textoLinha.includes(alvoNome) && textoLinha.includes("PENDENTE")) {
                    linhaEncontrada = row;
                }
            }
        });

        if (linhaEncontrada) {
            clearInterval(intervalBusca);
            
            // Centraliza e destaca
            linhaEncontrada.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Estilo visual de impacto
            linhaEncontrada.style.backgroundColor = "#fff3cd";
            linhaEncontrada.style.outline = "3px solid #d90f23"; // Vermelho para pendÃªncia
            
            linhaEncontrada.animate([
                { transform: 'scale(1)', boxShadow: 'none' },
                { transform: 'scale(1.01)', boxShadow: '0 0 20px #d90f23' },
                { transform: 'scale(1)', boxShadow: 'none' }
            ], { duration: 400, iterations: 5 });

            setTimeout(() => {
                linhaEncontrada.style.backgroundColor = "";
                linhaEncontrada.style.outline = "none";
            }, 6000);

        } else if (tentativas >= 25) {
            clearInterval(intervalBusca);
            console.warn("Destaque: Falha ao localizar o item alvo.");
        }
        
        tentativas++;
    }, 200);
}
		function toggleAlmoxDestino() {
    const tipo = document.getElementById('almox-operacao-tipo').value;
    const divViatura = document.getElementById('div-almox-viatura');
    if(divViatura) divViatura.style.display = (tipo === 'ENVIO' || tipo === 'RECOLHIMENTO') ? 'block' : 'none';
}
		/**
 * Abre o modal de Cadastro Global e limpa o formulÃ¡rio
 */
function abrirModalCadastroGlobal() {
    const modal = document.getElementById('modal-cadastro-global');
    document.getElementById('form-cadastro-global').reset();
    switchTabCadastro('identificacao'); // Sempre inicia na primeira aba
    modal.style.display = 'flex';
}

/**
 * Fecha o modal
 */
function fecharModalCadastroGlobal() {
    document.getElementById('modal-cadastro-global').style.display = 'none';
}

/**
 * Alterna entre as abas do modal de cadastro
 */
function switchTabCadastro(tabId) {
    // 1. Remove classe ativa de todos os botÃµes e esconde conteÃºdos
    document.querySelectorAll('.btn-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content-cadastro').forEach(content => content.style.display = 'none');

    // 2. Ativa o botÃ£o clicado e mostra o conteÃºdo correspondente
    // Busca o botÃ£o pelo texto ou Ã­ndice (forma segura)
    const btns = document.querySelectorAll('.btn-tab');
    if(tabId === 'identificacao') {
        btns[0].classList.add('active');
        document.getElementById('tab-identificacao').style.display = 'block';
    } else if(tabId === 'logistica') {
        btns[1].classList.add('active');
        document.getElementById('tab-logistica').style.display = 'block';
    } else if(tabId === 'composicao') {
        btns[2].classList.add('active');
        document.getElementById('tab-composicao').style.display = 'block';
    }
}

/**
 * Listener para o Checkbox de Kit (Mostra/Esconde Ã¡rea de componentes)
 */
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'cat-is-kit') {
        const areaComponentes = document.getElementById('area-selecao-componentes');
        areaComponentes.style.display = e.target.checked ? 'block' : 'none';
    }
});
    </script>
</body>
</html>
