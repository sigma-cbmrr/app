<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Gest√£o & Comando</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="sigma-comum.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9; 
            color: #333; 
            margin: 0; 
            display: flex; 
            min-height: 100vh; 
            padding-top: 50px; 
            padding-bottom: 60px; 
   a         box-sizing: border-box; 
            overflow-x: hidden;
        }
        
        /* Header */
        .main-header { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 50px; 
            background-color: #800020; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000;
            display: flex; 
            align-items: center; 
            padding: 0 15px; 
            box-sizing: border-box; 
            gap: 10px;
        }
        .header-icon { 
            height: 40px; 
            width: auto;
        } 
        .header-title-desktop, .header-title-mobile { 
            font-weight: bold; 
            font-size: 1.1em; 
            line-height: 1.2;
        } 
        .text-white { 
            color: white; 
        } 
        .text-red { 
            color: #FF3B3B;
        } 
        .header-title-desktop { 
            display: none; 
        } 
        .header-title-mobile { 
            display: block;
        }
        /* 1. Sobrescreve a classe de a√ß√£o para garantir que seja APENAS um √≠cone */
        .btn-logout-header {
            /* Anula√ß√£o da Caixa */
            background: transparent !important; /* Garante fundo transparente, anulando o .btn-modern-action */
            border: none !important;      /* Remove bordas */
            box-shadow: none !important;  /* Remove sombras */
            padding: 0 !important;        /* Remove o padding que cria o tamanho da caixa */
            margin-left: auto !important; /* Mant√©m o alinhamento √† direita */
    
            /* Visibilidade do √çcone */
            color: white !important;      /* Cor branca para o √≠cone */
            font-size: 0;                 /* Define a fonte do bot√£o como zero para ocultar qualquer texto residual */
        }

        /* 2. For√ßa o √≠cone (i) a ter o tamanho correto e ser branco */
        .btn-logout-header i {
            color: white !important;
            font-size: 1.5em !important; /* Define o tamanho final do √≠cone (ajuste se necess√°rio) */
            padding: 5px; /* Adiciona uma √°rea de clique maior ao redor do √≠cone */
            display: inline-block; /* Garante que o √≠cone seja renderizado corretamente */
        }

        /* 3. Garante que n√£o haja fundo branco/estranho ao interagir */
        .btn-logout-header:hover,
        .btn-logout-header:active,
        .btn-logout-header:focus {
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
            color: white !important;
        }
        #menu-btn { 
            display: none; 
            background: none; 
            border: none; 
            color: white;
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 0 5px; 
        }
        .btn-dial-mobile {
            display: none !important;
        }
        .profile-badge { 
            background-color: #800020; /* Cor s√≥lida SIGMA (vermelho escuro) */
            color: white; /* Mant√©m o texto branco no fundo vermelho escuro */
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 0.8em; 
            margin-left: 0; /* Remove a margem horizontal desnecess√°ria na sidebar */
            border: 1px solid rgba(255,255,255,0.5); /* Borda mais vis√≠vel */
        }
        #sidebar-user-info .profile-badge {
            /* Garante que o badge tenha margem superior para espa√ßamento */
            margin-top: 5px; 
            margin-left: 0;
        }

        @media (min-width: 768px) { 
            .header-title-desktop { 
                display: block; 
                font-size: 1.2em;
            } 
            .header-title-mobile { 
                display: none; 
            } 
            #menu-btn { 
                display: none;
            } 
        }
        
        /* Sidebar */
        .sidebar { 
            width: 250px;
            background-color: #ffffff; 
            color: #333; 
            padding-top: 20px; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); 
            border-right: 1px solid #e0e0e0; 
            position: fixed;
            top: 50px; 
            left: 0; 
            height: calc(100% - 50px); 
            display: flex; 
            flex-direction: column; 
            z-index: 1100; 
            overflow-y: auto; 
            transition: left 0.3s ease;
        }
        .sidebar-header { 
            text-align: center; 
            padding: 10px 0 20px 0;
            border-bottom: 1px solid #eee; 
            margin-bottom: 10px; 
        } 
        .sidebar-header img { 
            width: 60px;
            height: auto; 
            margin-bottom: 5px; 
        } 
        #sidebar-user-info {
            /* Define o estilo principal do texto */
            font-size: 1.1em;
            font-weight: bold;
            color: #800020; /* Cor do SIGMA */
            margin: 0; /* Remove margens extras */
            line-height: 1.4;
            display: flex; /* Permite alinhar nome e badge lado a lado */
            flex-direction: column; /* Empilha Nome e Badge */
            align-items: center; /* Centraliza verticalmente o texto */
        }
        #sidebar-user-info #user-name {
            /* Estilo para o nome */
            display: block;
            margin-bottom: 5px; /* Espa√ßo entre nome e badge */
            font-size: 0.9em; /* Um pouco menor que o t√≠tulo */
            color: #333;
        }
        .sidebar a { 
            padding: 15px 20px; 
            text-decoration: none; 
            font-size: 1em;
            color: #555; 
            display: block; 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent; 
            cursor: pointer;
        } 
        .sidebar a:hover { 
            background-color: #fff5f5; 
            color: #800020;
        } 
        .sidebar a.active { 
            background-color: #ffecec; 
            color: #800020; 
            font-weight: bold;
            border-left: 4px solid #d90f23; 
        } 
        .menu-label { 
            padding: 15px 20px 5px;
            font-size: 0.85em; 
            color: #999; 
            text-transform: uppercase; 
            font-weight: bold; 
        }
        .sidebar-overlay { 
            display: none;
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1050;
        }
        /* Container da lista (Acorde√£o) */
.inventory-accordion-container {
    margin-top: 15px;
}

/* Cabe√ßalho do Setor (Item do Acorde√£o) */
.accordion-header {
    background-color: #f8f8f8;
    color: #333;
    padding: 12px 15px;
    margin-top: 10px;
    cursor: pointer;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s, box-shadow 0.2s;
    font-size: 1em;
}

.accordion-header:hover {
    background-color: #fff5f5;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.accordion-header i.fa-chevron-down {
    transition: transform 0.3s;
}

/* Rota√ß√£o do √≠cone quando ativo */
.accordion-header.active i.fa-chevron-down {
    transform: rotate(180deg);
}

/* Corpo do Conte√∫do (Itens) */
.accordion-content {
    padding: 15px 0 5px;
    border-left: 3px solid #800020;
    margin-bottom: 20px;
    /* Usado para a anima√ß√£o de esconder/mostrar */
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
}

/* Grid de cards de itens */
.items-card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    padding: 0 10px 0 10px; /* Adiciona padding interno */
}

/* Estilo do Card do Item */
.item-selection-card {
    background-color: #fff;
    border: 1px solid #eee;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    padding: 15px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: border-color 0.2s;
}

.item-selection-card.selected {
    border-color: #1b8a3e; /* Verde quando selecionado */
    background-color: #f6fff6;
    box-shadow: 0 0 5px rgba(27, 138, 62, 0.3);
}

.item-card-title {
    font-size: 1em;
    font-weight: bold;
    color: #800020;
    margin: 0 0 10px 0;
}

/* Estilo do controle de quantidade para itens 'single' */
.qtd-control-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 5px;
}

.qtd-control-wrapper label {
    font-weight: normal;
    font-size: 0.9em;
    color: #555;
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.qtd-control-wrapper input[type="number"] {
    width: 60px;
    text-align: center;
    padding: 5px;
    border-radius: 4px;
    font-size: 1em;
}

/* Estilo para as Tags/Bot√µes de Tombamento */
.tombamento-tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.tombamento-tag {
    background-color: #efefef;
    border: 1px solid #ccc;
    padding: 6px 8px;
    border-radius: 15px;
    font-size: 0.8em;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
    display: flex;
    align-items: center;
}

.tombamento-tag input[type="checkbox"] {
    margin-right: 5px;
    cursor: pointer;
}

.tombamento-tag.selected {
    background-color: #d9ffdb;
    border-color: #1b8a3e;
    font-weight: bold;
}

        /* Content */
        .content { 
            margin-left: 250px;
            flex-grow: 1; 
            padding: 20px; 
            box-sizing: border-box; 
            width: calc(100% - 250px); 
            padding-bottom: 80px;
        } 
        .view-section { 
            display: none; 
            animation: fadeIn 0.3s ease;
        } 
        .view-section.active-view { 
            display: block;
        }
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
            } 
            to { 
                opacity: 1;
            } 
        }

        /* Footer */
        .footer-central { 
            position: fixed;
            bottom: 0; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            padding: 5px 0 5px; 
            background-color: #f4f4f9; 
            color: #555; 
            font-size: 0.65em; 
            line-height: 1.3;
            z-index: 100; 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        } 
        .footer-central strong, .footer-autor { 
            display: block; 
            width: 100%; 
            text-align: center;
        } 
        .footer-central strong { 
            font-weight: bold; 
        } 
        .footer-autor { 
            margin-top: 10px; 
            color: #888; 
            font-size: 0.9em;
        }

        /* Cards e Grid */
        /* Cards e Grid */
.cards-grid { 
    display: flex;
/* flex-wrap: wrap;  */
    flex-wrap: wrap; 
    gap: 20px; 
    margin-bottom: 30px; 
} 
.sector-card { 
    background-color: white;
/* padding: 15px;  */
    padding: 15px; 
    min-height: 100px; /* ‚¨ÖÔ∏è AJUSTE: Altura m√≠nima aumentada para garantir alinhamento com cards de lista */
    border-radius: 8px;
/* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
/* A chave: For√ßa o item a ter 280px como largura base e permite que o flexbox o organize */
    flex: 0 0 220px;
/* max-width: 100%; */ 
    max-width: 100%;
/* /* Garante que n√£o ultrapasse a tela em mobile */ */
    cursor: pointer;
/* /* transition: transform 0.2s, box-shadow 0.2s;  */
    transition: transform 0.2s, box-shadow 0.2s; 
    display: flex; 
    flex-direction: column;
/* justify-content: space-between; */
    justify-content: space-between;
}
        /* Garante que o elemento principal dos Cards de Pend√™ncia/Estat√≠stica tenha altura para empurrar o rodap√© */
        .sector-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background-color: #fff5f5; 
        }
        .sector-card.status-alert { 
            border-left: 5px solid #d90f23;
        } 
        .sector-card.status-ok { 
            border-left: 5px solid #1b8a3e; 
        } 
        .sector-card.status-unit { 
            border-left: 5px solid #2c7399;
        } 
        .sector-card.status-posto { 
            border-left: 5px solid #8e44ad; 
        }
        .sector-card.active-card { 
            background-color: #ffecec;
            border: 1px solid #d90f23; 
            border-left: 5px solid #d90f23; 
        }
        .sector-card h3 { 
            margin-top: 0;
            font-size: 1.1em; 
            color: #333; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .sector-card .main-stat { 
            display: flex;
            align-items: center; 
            justify-content: space-between; 
            margin: 10px 0; 
        }
        .sector-card .count-value { 
            font-size: 2em;
            font-weight: bold; 
        }
        .sector-card.status-alert .count-value { 
            color: #d90f23;
        } 
        .sector-card.status-ok .count-value { 
            color: #1b8a3e; 
        }
        .sector-card .card-footer { 
            font-size: 0.75em;
            color: #777; 
            margin-top: 10px; 
            pt: 10px; 
            border-top: 1px solid #eee; 
            line-height: 1.4;
        }
        /* ==================================== */
/* NOVO: ESTILOS PARA CARDS DO MENU GEST√ÉO DE CAUTELAS */
/* Usa .sector-card + .menu-card para herdar a base de estilos */
/* ==================================== */

.menu-card {
    /* Garante que o cart√£o ocupe no m√≠nimo 250px, tornando o layout mais flex√≠vel */
    flex: 1 1 0; 
    padding: 25px; 
    text-align: center;
    /* Remove a borda lateral de status que outros cards podem ter */
    border-left: none !important;
}
@media (min-width: 900px) {
    /* For√ßa o grid do menu de cautelas a ter 4 colunas de tamanho igual */
    #cautelas-options-container {
        /* Aumentamos a especificidade para garantir o layout de 4 colunas */
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 15px; 
    }
}

/* Ajusta o hover para ser visualmente mais forte e manter a cor institucional */
.menu-card:hover {
    transform: translateY(-3px); /* Leve levantamento */
    /* Usa a cor principal do sistema (#800020) na sombra */
    box-shadow: 0 6px 15px rgba(128, 0, 32, 0.2); 
    background-color: #fff8f8;
}

/* Estilo do √çcone (a ser usado dentro do .menu-card) */
.menu-card .card-icon {
    font-size: 3em; 
    color: #800020; /* Cor Institucional */
    margin-bottom: 10px;
    display: block;
}

/* Estilo do T√≠tulo dentro do Card de Menu */
.menu-card h3 {
    font-size: 1.2em;
    color: #333;
    margin-top: 0;
    margin-bottom: 5px;
}

/* Estilo da Descri√ß√£o/Par√°grafo */
.menu-card p {
    font-size: 0.9em;
    color: #666;
    margin: 0;
}
        
        .sub-list-preview { 
            font-size: 0.85em; 
            color: #555; 
            list-style: none; 
            padding: 0; 
            margin: 0;
            max-height: 60px; 
            overflow: hidden; 
        }
        .sub-list-preview li { 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        /* Greeting Card */
        .greeting-card { 
            /* Estilos Visuais */
            background: linear-gradient(135deg, #800020 0%, #5a0017 100%);
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 10px rgba(128, 0, 32, 0.2); 
    
            /* Configura√ß√£o Flexbox */
            display: flex;
            flex-wrap: wrap; /* ‚úÖ ESSENCIAL: Permite que a foto e o bloco de info (.greeting-info) quebrem em telas pequenas. */
            align-items: center;
            gap: 20px; 
        }
        .greeting-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            flex-basis: auto;
            border: 3px solid rgba(255,255,255,0.3); 
            object-fit: cover; 
            background-color: white; 
        }
        .greeting-info { 
            display: flex;
            flex-wrap: wrap; /* Permite a quebra de linha em mobile */
            align-items: center; 
            flex-grow: 1; /* Ocupa o m√°ximo de espa√ßo poss√≠vel */
            gap: 15px;
            flex-basis: 0;
        }
        .greeting-text-wrapper {
            flex-grow: 1;
            margin-bottom: 10px;
            order: 0;
        }
        #btn-open-conf-modal {
            margin-left: auto; /* Empurra o bot√£o para a direita em desktop */
            justify-content: center !important; 
            text-align: center;
        }
        .greeting-title { 
            margin: 0; 
            font-size: 1.3em; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .greeting-date { 
            font-size: 0.85em; 
            opacity: 0.8; 
            margin-top: 3px; 
            display: block;
            font-style: italic;
        }
        .greeting-user { 
            font-size: 1.1em; 
            margin-top: 5px; 
            display: block; 
            font-weight: 500;
        }
        .greeting-title, .greeting-user { 
            white-space: nowrap; /* Impede quebras de linha dentro do texto */
            overflow: hidden;
            text-overflow: ellipsis; /* Adiciona "..." se o texto for muito longo */
            max-width: 100%; /* Garante que respeite o pai */
            display: block;
        }

        /* Card de Nova Confer√™ncia / Filtros */
        .op-card { 
            background: white;
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            padding: 25px; 
            margin-bottom: 25px; 
            border-left: 5px solid #ccc;
        }
        .op-card.action { 
            border-left-color: #1b8a3e;
        }
        .op-card.history { 
            border-left-color: #2c7399;
        }
        .op-card.resume { 
            border-left-color: #f57c00; 
            background-color: #fff3e0; 
            cursor: pointer; 
            transition: transform 0.2s;
            padding: 25px 35px 25px 25px; /* Adiciona 35px de padding na direita */
            position: relative;
        }
        .op-card.resume:hover { 
            transform: translateY(-2px);
        }
        
        .op-card-title { 
            color: #333;
            margin-top: 0; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 10px; 
            font-size: 1.2em; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .form-group { 
            margin-bottom: 15px;
        }
        .form-group label { 
            display: block; 
            font-weight: bold; 
            color: #555; 
            margin-bottom: 5px;
            font-size: 0.9em; 
        }
        .form-group select, .form-group input { 
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box;
            /* Garante que todos os inputs de formul√°rio herdem a fonte base */
            font-family: inherit; 
        }
        
        /* Regra espec√≠fica para inputs de data no Chrome/Edge/Firefox, for√ßando a fonte */
         input[type="date"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }
        .form-group select:focus, .form-group input:focus { 
            border-color: #800020;
            outline: none; 
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
        }
        .btn-start { 
            background: linear-gradient(135deg, #d90f23 0%, #800020 100%); 
            color: white; 
            border: none;
            width: 100%; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(217, 15, 35, 0.3);
        }
        .btn-start:focus { 
            outline: 3px solid rgba(128,0,32,0.4);
        }

        /* Admin Tables & Lists */
        .new-local-section { 
            background: #fff;
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            border-top: 3px solid #2c7399;
        }
        .admin-table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border-radius: 8px; 
            overflow: hidden; 
            margin-bottom: 20px;
        }
        .admin-table th, .admin-table td { 
            padding: 12px 15px; 
            text-align: center;
            border-bottom: 1px solid #eee; 
        }
        .admin-table th { 
            background-color: #f8f9fa; 
            font-weight: bold;
            color: #555; 
            text-transform: uppercase; 
            font-size: 0.85em;
        }
        .role-badge { 
            padding: 3px 8px;
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold; 
            color: white; 
        }
        .role-admin { 
            background-color: #d90f23;
        } 
        .role-gestor { 
            background-color: #f57c00; 
        } 
        .role-operacional { 
            background-color: #1b8a3e;
        }
        
        /* Editor de Listas (Elementos) */
        .admin-container { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto;
            text-align: center; 
        }
        .lista-setores { 
            padding: 0; 
            list-style: none; 
            text-align: left;
        }
        .setor-item { 
            margin-bottom: 15px; 
            border: 1px solid #800020; 
            border-radius: 6px; 
            background: #fff;
        }
        .item-list-admin {}
        .setor-content-header-sticky {
            /* Tornar o cont√™iner do cabe√ßalho e formul√°rio sticky */
            position: sticky;
            top: 50px; /* Bate logo abaixo do main-header (50px) */
            z-index: 50;
            /* Garante que fique acima dos itens rolando */
            background-color: #fff;
            /* Fundo branco para cobrir o conte√∫do rolando */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            /* Sombra suave para destacar */
        }
        .setor-header-admin { 
            background-color: #800020; 
            color: white;
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            cursor: grab; 
            z-index: 51;
        }
        .setor-content-admin { 
            transition: max-height 0.4s ease-out;
            /* Removemos o max-height alto e o overflow: hidden */
            max-height: 1500px;
            /* Define uma altura m√°xima vis√≠vel */
            overflow-y: auto;
            /* PERMITE A ROLAGEM VERTICAL */
            padding: 10px 10px 10px;
        }
        #lista-setores-container {
             border: none !important;
             margin-top: 20px; 
        }
        .setor-content-admin.collapsed { 
            max-height: 0;
            padding: 0 !important; 
            overflow-y: hidden; /* Oculta a barra quando colapsado */
        }
        .item-conferencia-admin { 
            display: flex;
            justify-content: space-between; 
            align-items: flex-start; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
            cursor: move;
        }
        .add-item-form-setor { 
            padding: 10px 15px 5px; 
            background-color: #f8f8f8; 
            display: flex; 
            gap: 5px;
            margin-bottom: 0; 
        }
        .add-item-form-setor input, .add-item-form-setor select { 
            flex-grow: 1; 
            padding: 8px;
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        .tombamento-container-wrapper { 
            margin-top: 5px; 
            padding-left: 20px;
            background: #f9f9f9; 
            border-left: 3px solid #ccc; 
            width: 100%; 
            box-sizing: border-box;
        }
        .tombamento-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 0;
            border-bottom: 1px dotted #eee; 
        }
        .item-actions-admin { 
            display: flex; 
            gap: 5px;
        }
        .btn-remover { 
            background-color: #d90f23; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        } 
        .btn-edit-alt { 
            background-color: #7f8c8d; 
            color:white; 
            border:none; 
            padding:5px 10px; 
            border-radius:4px;
            cursor:pointer;
        }
        .btn-add { 
            background-color: #800020; 
            color: white; 
            border: none; 
            padding: 8px 15px;
            border-radius: 4px; 
            cursor: pointer; 
        }
        .locais-list { 
            list-style: none; 
            padding: 0;
        }
        .local-item { 
            background: white; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 5px solid #800020;
        }
        .local-info strong { 
            display: block; 
            font-size: 1.1em; 
            color: #333;
        }

        /* CA Table */
        .ca-table-container { 
            overflow-x: auto;
            background-color: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            margin-top: 10px; 
            border-top: 3px solid #d90f23;
        } 
        .ca-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9em;
        } 
        .ca-table th, .ca-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
            vertical-align: top;
        } 
        .ca-table th { 
            background-color: #f8f8f8; 
            color: #800020; 
            font-weight: bold; 
            text-transform: uppercase;
        }
        .custom-select-container {
            position: relative;
        }
        .custom-select-container input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }
         .custom-select-container input[type="text"]:focus {
            border-color: #800020;
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
        }

        .suggestions-box {
            position: absolute;
            top: 100%; /* Posiciona logo abaixo do input */
            left: 0;
            right: 0;
            z-index: 10; /* Garante que fique acima de outros elementos */
            background-color: #fff;
            border: 1px solid #800020; /* Cor Institucional */
            border-top: none;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 200px; /* Limita a altura para rolagem */
            overflow-y: auto;
            display: none; /* Inicia oculto */
        }

        #cautela-suggestions-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #cautela-suggestions-list li {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.95em;
            color: #333;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        #cautela-suggestions-list li:last-child {
            border-bottom: none;
        }

        #cautela-suggestions-list li:hover {
            background-color: #ffecec; /* Hover com cor institucional clara */
            color: #800020;
            font-weight: 500;
        }
        .row-amarelo { 
            background-color: #fff9c4 !important; 
        } 
        .row-laranja { 
            background-color: #ffe0b2 !important;
        } 
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold;
        } 
        .badge-pendente { 
            background-color: #ffebee; 
            color: #d32f2f; 
        } 
        .badge-solucao { 
            background-color: #fff9c4; 
            color: #fbc02d; 
            border: 1px solid #fbc02d;
        } 
        .badge-cautela { 
            background-color: #ffe0b2; 
            color: #f57c00; 
            border: 1px solid #f57c00;
        }

        /* Modals - ESTILO PREMIUM */
        .modal-overlay { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 2000;
        } 
        .modal-content { 
            background: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            width: 90%;
            max-width: 500px; 
            position: relative; 
            text-align: left; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        } 
        .modal-content h2 { 
            margin-top: 0; 
            color: #800020; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px; 
            font-size: 1.4em; 
        } 
        .modal-content label { 
            display: block; 
            margin-top: 15px;
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #444; 
            font-size: 0.95em; 
        } 
        
        /* Inputs Premium no Modal */
        .modal-content input[type="text"], 
        .modal-content input[type="number"],
        .modal-content select, 
        .modal-content textarea { 
            width: 100%;
            padding: 12px; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 1em; 
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
            border-color: #800020;
            outline: none;
            box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
        }
        
        .modal-content textarea { 
            height: 100px;
            resize: vertical; 
        } 
        .modal-buttons { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px;
            margin-top: 10px; 
        } 
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px;
            background: none; 
            border: none; 
            font-size: 20px; 
            cursor: pointer; 
            color: #999; 
            transition: color 0.2s;
        }
        .close-btn:hover { 
            color: #d90f23;
        }
        /* --- ADICIONE ESTES ESTILOS AO BLOCO <style> DO sigma_dashboard.html.txt --- */

.modal-content button { 
    padding: 10px 20px; 
    margin-top: 20px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
    transition: background-color 0.3s; 
    font-weight: bold; 
}

.modal-btn-cancel { 
    background-color: #ccc; 
    color: #333; 
}

.modal-btn-cancel:hover { 
    background-color: #bbb; 
}

.modal-actions { 
    display: flex; 
    justify-content: flex-end; 
    gap: 10px; /* Adiciona espa√ßamento entre os bot√µes */
}
/* --- ESTILOS PARA ABAS DE NAVEGA√á√ÉO (CORRE√á√ÉO FINAL DE COR) --- */
.tab-navigation {
    width: fit-content; 
    margin: 0 auto;
    display: flex;
    border-bottom: 2px solid #ddd; 
    margin-bottom: 0 !important; 
}

/* Regra base do bot√£o */
.tab-button {
    /* Removendo !important da cor base para que a regra :not(.active) funcione */
    color: #000; 
    background-color: transparent;
    
    border: 1px solid #ccc !important;
    border-bottom: 2px solid #ddd !important;
    border-radius: 8px 8px 0 0 !important; 
    padding: 10px 18px !important;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: -2px; 
}

/* üõë CORRE√á√ÉO FINAL: For√ßa o texto para preto S√ì QUANDO N√ÉO EST√Å ATIVO üõë */
/* Esta regra tem especificidade suficiente para anular a cor branca herdada */
.tab-navigation .tab-button:not(.active) {
    color: #000 !important;
    background-color: transparent !important;
}

.tab-button:hover:not(.active) {
    background-color: #f0f0f0 !important;
    color: #333 !important; 
}

.tab-button.active {
    /* ESTILO ATIVO DESEJADO: BRANCO NO VINHO (#800020) */
    background-color: #800020 !important; 
    color: white !important; /* Texto branco */
    border-color: #800020 !important;
    border-bottom-color: #fff !important; 
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    z-index: 10; 
}

.historico-tab-content {
    background-color: #fff;
    border: 1px solid #ddd;
    border-top: 2px solid #800020; /* Borda da cor da aba ativa */
    padding: 15px;
    border-radius: 0 6px 6px 6px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

/* Garante que o bot√£o de Recebimento use o estilo btn-modern-action, se ele n√£o estiver pegando */
#btn-receber-cautela {
    /* Exemplo: Se precisar de estilo de a√ß√£o forte */
    background-color: #1b8a3e; /* Verde Forte */
    color: white;
}
#btn-receber-cautela:hover {
    background-color: #14682f;
}

        /* Checkbox list in modal */
        .checklist-container { 
            max-height: 200px;
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 5px; 
            margin-bottom: 15px;
        }
        .checklist-item { 
            display: flex; 
            align-items: center; 
            padding: 5px; 
            border-bottom: 1px dotted #f0f0f0;
        }
        .checklist-item:hover { 
            background: #fafafa;
        }
        .checklist-item input { 
            width: auto; 
            margin-right: 10px; 
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-modern-action {
            /* PROPRIEDADES DE LAYOUT ORIGINAIS (MANTIDAS) */
            display: inline-flex;
            align-items: center;
            gap: 8px;
    
            /* PROPRIEDADES DE ESTILO E COR (ATUALIZADAS) */
            background-color: #800020; /* Vermelho Escuro (Cor principal do SIGMA) */
            color: #ffffff !important; /* For√ßa a cor branca */
            border: none;
            padding: 8px 15px; /* Tamanho ligeiramente menor para bot√£o de 'Voltar' */
            border-radius: 6px; /* Mantive o seu radius original */
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em; /* Tamanho reduzido para ser secund√°rio */
            transition: background-color 0.2s, box-shadow 0.2s; /* Ajuste na transi√ß√£o */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Sombra mais destacada */
            white-space: nowrap; 
        }
        .btn-modern-action:hover {
            background-color: #a00030; /* Um pouco mais claro no hover */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .btn-modern-action:active { 
            transform: translateY(1px);
            box-shadow: none; 
        }
        .btn-create {
            background-color: #2c7399; /* Seu Azul original */
            color: #ffffff !important; 
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .btn-create:hover {
            background-color: #205b7a; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .btn-form-action {
            width: 100%;
            margin-top: 15px; /* Adiciona um espa√ßo acima do bot√£o no formul√°rio */
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .btn-edit { 
            background-color: #2c7399; 
        }
        .btn-edit:hover {
            background-color: #205b7a; /* Um tom mais escuro para o hover */
        }
        .btn-delete { 
            background-color: #d90f23;
        } 
        .btn-sync { 
            background-color: #1b8a3e; 
        } 
        .btn-backup { 
            background: #5d6164;
        }
        .btn-filter-modern { 
            background-color: #2c7399; 
            color: white; 
            border: none; 
            padding: 11px 25px;
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        

        /* APP CONTAINER (IFRAME) */
        #app-runner-container { 
            display: none;
            position: fixed; 
            top: 50px; 
            left: 250px; 
            width: calc(100% - 250px); 
            height: calc(100vh - 50px); 
            background: white; 
            z-index: 500; 
            overflow: hidden;
        }
        #app-iframe { 
            width: 100%; 
            height: 100%; 
            border: none;
        }

        /* History List Specifics */
        .history-list { 
            list-style: none;
            padding: 0; 
            margin: 0; 
        }
        .history-item { 
            border-bottom: 1px solid #eee;
            padding: 15px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background 0.2s;
        }
        .history-item:hover { 
            background-color: #fafafa; 
            padding-left: 5px; 
            padding-right: 5px;
        }
        .history-item:last-child { 
            border-bottom: none;
        }
        .hist-info strong { 
            display: block; 
            color: #333; 
            font-size: 1.05em;
        }
        .hist-info small { 
            color: #777; 
            font-size: 0.9em;
        }
        .hist-status { 
            font-size: 0.8em; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: bold;
            margin-left: 5px; 
            text-transform: uppercase; 
        }
        .status-ok { 
            background-color: #e8f5e9; 
            color: #2e7d32;
            border: 1px solid #c8e6c9; 
        }
        .status-alert { 
            background-color: #ffebee; 
            color: #c62828;
            border: 1px solid #ffcdd2; 
        }
        .btn-reprint { 
            background: white; 
            border: 1px solid #ddd;
            padding: 8px 12px; 
            border-radius: 6px; 
            color: #555; 
            cursor: pointer; 
            font-size: 0.9em; 
            display: flex; 
            align-items: center; 
            gap: 5px;
        }
        .btn-reprint:hover { 
            border-color: #800020; 
            color: #800020; 
            background-color: #fff5f5;
        }

        /* Filtros Premium */
        .modern-filter-card { 
            background-color: #fff;
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #e0e0e0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px; 
            align-items: flex-end; 
        }
        .filter-item { 
            flex: 1; 
            min-width: 200px;
        }
        .filter-item label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: #555;
            font-size: 0.9em; 
        }
        .filter-input { 
            width: 100%; 
            padding: 10px 12px;
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 0.95em; 
            box-sizing: border-box;
        }
        .dashboard-columns {
    display: flex;
    flex-direction: column; /* Em mobile, os blocos ficam empilhados (Mobile-First) */
    gap: 25px; 
}
    /* Regra para garantir o alinhamento vertical centralizado do √≠cone ao bloco de texto */
.unit-header .unit-flex-title {
    display: flex;
    align-items: center; /* CENTRALIZA O √çCONE VERTICALMENTE COM O TEXTO QUEBRADO */
    gap: 8px; /* Espa√ßamento entre o √≠cone e o texto */
    width: 100%; /* Opcional, para garantir que o H3 preencha a largura */
}

/* Garante que o texto se comporte como um bloco para quebrar corretamente */
.unit-header .unit-flex-title span {
    flex-grow: 1; 
    line-height: 1.3; /* Melhora a leitura do texto quebrado */
}    
        
        /* Mobile */
        @media (max-width: 600px) {
    
            /* --- REORGANIZA√á√ÉO DO HEADER DE CAUTELAS (NOVO) --- */
            .header-container {
                flex-wrap: wrap; 
                justify-content: flex-start !important; 
                align-items: flex-start !important;
                padding-left: 5px !important; /* Mantendo seu padding de se√ß√£o */
                padding-right: 5px !important;
            }

    /* O Bot√£o <- VOLTAR (Linha 1, Alinhado √† Direita) */
    #btn-back-cautelas {
        order: 1; 
        margin-left: auto; 
        flex-shrink: 0;
        margin-top: 5px; 
        margin-bottom: 5px; 
    }

    /* O T√≠tulo (Linha 2, Ocupa 100%) */
    .header-container h3 {
        order: 2; 
        flex-basis: 100%; 
        margin-top: 0;
    }
    
    /* --- IN√çCIO DO GRADEAMENTO TABLE-TO-CARD PARA CAUTELAS --- */

/* 1. Seletores abrangentes para transformar a tabela em bloco */
#cautelas-ativas-table, 
#cautelas-receive-table,
#historico-content-container .ca-table, /* <--- NOVO: Aplica a qualquer tabela dentro do Hist√≥rico */

#cautelas-ativas-table thead,
#cautelas-receive-table thead,
#historico-content-container .ca-table thead,

#cautelas-ativas-table tbody,
#cautelas-receive-table tbody,
#historico-content-container .ca-table tbody,

#cautelas-ativas-table th,
#cautelas-receive-table th,
#historico-content-container .ca-table th,

#cautelas-ativas-table td,
#cautelas-receive-table td,
#historico-content-container .ca-table td,

#cautelas-ativas-table tr,
#cautelas-receive-table tr,
#historico-content-container .ca-table tr { /* <--- FINALIZA O GRUPO */
    display: block;
}

/* 2. Esconde o cabe√ßalho original da tabela */
#cautelas-ativas-table thead tr, 
#cautelas-receive-table thead tr,
#historico-content-container .ca-table thead tr { /* <--- NOVO SELETOR */
    position: absolute;
    top: -9999px;
    left: -9999px;
}

/* 3. Configura cada linha da tabela (<tr>) para ser um 'card' */
#cautelas-ativas-table tr,
#cautelas-receive-table tr,
#historico-content-container .ca-table tr { /* <--- NOVO SELETOR */
    border: 1px solid #ccc;
    margin-bottom: 10px;
    border-radius: 6px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    padding: 10px;
    cursor: pointer;
}

/* 4. Estilo do cabe√ßalho de grupo (para a linha com colspan) */
/* Este √© o √∫nico trecho que n√£o precisa ser modificado, pois j√° usa .group-header */
/* ... */


/* 5. Configura cada c√©lula (<td>) para ser uma linha do 'card' */
#cautelas-ativas-table td,
#cautelas-receive-table td,
#historico-content-container .ca-table td { /* <--- NOVO SELETOR */
    border: none;
    border-bottom: 1px solid #eee;
    position: relative;
    padding-left: 50% !important; 
    text-align: right;
    white-space: normal;
    font-size: 0.9em;
}

/* 6. Insere o cabe√ßalho (data-label) antes do conte√∫do da c√©lula */
#cautelas-ativas-table td:before,
#cautelas-receive-table td:before,
#historico-content-container .ca-table td:before { /* <--- NOVO SELETOR */
    content: attr(data-label);
    position: absolute;
    left: 10px; 
    width: 45%;
    padding-right: 10px;
    white-space: nowrap;
    text-align: left;
    font-weight: bold; 
    color: #800020;
}
/* --- FIM DO GRADEAMENTO TABLE-TO-CARD --- */
    
    
            /* O SEU C√ìDIGO RESTANTE ABAIXO... */
            .greeting-card {
                align-items: flex-start;
            }
    .greeting-info {
        flex-basis: auto;
        flex-grow: 1;
        margin-top: 0;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 10px;
    }
    .greeting-text-wrapper {
        flex-basis: 100%;
        flex-grow: 1;
        margin-bottom: 0;
    }
    #btn-open-conf-modal {
        flex-basis: 100%;
        margin-top: 15px;
        margin-left: 0;
        width: 100%;
        order: 1;
    }
    .btn-dial-mobile {
        display: inline-block !important;
    }
    greeting-avatar {
        flex-basis: auto;
    }
    #menu-btn {
        display: block;
    }
    .sidebar {
        left: -260px;
        width: 260px;
        border-right: 1px solid #ddd;
    }
    .sidebar.mobile-active {
        left: 0;
    }
    .content, .content-area {
        margin-left: 0 !important;
        width: 100% !important;
        padding-top: 15px !important;
        padding-left: 10px !important;
        padding-right: 10px !important;
    }
    .view-section {
        padding-left: 5px !important;
        padding-right: 5px !important;
    }
    .header-container {
        /* As regras de flexbox foram movidas para cima */
        padding-left: 5px !important;
        padding-right: 5px !important;
    }
    .menu-card {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    body {
        margin: 0 !important;
    }
    #app-runner-container {
        left: 0;
        width: 100%;
        z-index: 500;
    }
    .modern-filter-card {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    .btn-filter-modern {
        width: 100%;
    }
    .filter-input {
        max-width: 100%;
        width: 100%;
    }
    .filter-item {
        width: 100%;
        min-width: 0;
    }
    .admin-container {
        padding: 10px;
        margin-top: 20px;
    }
    .admin-table, .admin-table thead, .admin-table tbody, .admin-table th, .admin-table td, .admin-table tr {
        display: block;
    }
    .admin-table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    .admin-table tr {
        border: 1px solid #ccc;
        margin-bottom: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .admin-table td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 50%;
        text-align: right;
        font-size: 0.9em;
    }
    .admin-table td:before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
        color: #800020;
    }
    .admin-table td[data-label="A√ß√µes:"],
    .admin-table td:last-child {
        text-align: right !important;
    }
    .global-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .new-local-section > div[style*="grid"] {
        display: block !important;
    }
    .new-local-section > div[style*="flex"] {
        display: block !important;
    }
    .new-local-section .form-group {
        margin-bottom: 10px;
    }
    .new-local-section .btn-modern-action, .new-local-section .btn-create {
        width: 100%;
        margin-top: 10px;
    }
    .sector-card {
        margin-left: 0 !important;
        margin-right: 0 !important;
        flex: 1 1 100% !important;
        max-width: 100% !important;
    }
    .cards-grid {
        gap: 20px 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    .add-setor-form {
        flex-direction: column;
        gap: 10px !important;
        margin-left: 0 !important;
    }
    .add-item-form-setor {
        flex-wrap: wrap;
    }
    .add-item-form-setor input, .add-item-form-setor select, .add-item-form-setor button {
        flex-grow: 1;
        width: 100%;
        box-sizing: border-box;
    }
    .add-item-form-setor button {
        flex-grow: 0;
        width: 48%;
    }
    .item-conferencia-admin {
        flex-direction: column;
        align-items: flex-start;
        padding: 10px;
    }
    .item-actions-admin {
        margin-top: 10px;
        align-self: flex-end;
    }
    .tombamento-container-wrapper {
        padding-left: 10px;
        margin-top: 10px;
    }
    .tombamento-list li {
        flex-wrap: wrap;
        padding: 5px 0;
    }
    .tombamento-list input {
        flex-grow: 1;
    }
    .form-grid-2-columns {
        grid-template-columns: 1fr;
    }
}
        @media (min-width: 769px) { 
            .sidebar-overlay { 
                display: none !important;
            }
    
            .dashboard-columns {
                flex-direction: row; 
                /* üí° CORRE√á√ÉO: Usamos stretch para que os dois blocos (op-card) 
                ocupem 100% da altura do bloco mais alto, igualando o tamanho. */
                align-items: stretch; 
                gap: 20px;
            }
            .dashboard-columns .op-card {
                flex: 1; 
            }
        }
            .restricted-admin-only { 
                display: none;
            }
        /* Estilo espec√≠fico para o bot√£o de descarte do card de resumo */
.op-card.resume {
    position: relative; /* Necess√°rio para posicionar o bot√£o absoluto */
}
.btn-resume-close {
    position: absolute;
    top: 5px; 
    right: 5px; 
    background: none;
    border: none;
    color: #d90f23; 
    font-size: 1.4em; 
    cursor: pointer;
    padding: 5px;
    opacity: 0.9; 
    transition: color 0.2s, opacity 0.2s;
}
.btn-resume-close:hover {
    color: #FF3B3B; 
    opacity: 1;
}
        /* ==================================== */
/* ESTILOS ESPEC√çFICOS DO FORMUL√ÅRIO DE CAUTELAS */
/* ==================================== */

/* Layout de 2 colunas para campos principais no desktop */
.form-grid-2-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px; /* Espa√ßamento entre os campos */
}

/* Estilo geral para o grupo de campo */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #444;
}

/* Estilo para todos os inputs, selects e textareas */
.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box; /* CR√çTICO: Garante que padding e border n√£o estourem a largura */
    font-size: 1em;
}

/* √Årea de Listagem/Sele√ß√£o de Itens */
#itens-custodia-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
}

    </style>
</head>
<body>
    <div id="mobile-overlay" class="sidebar-overlay" onclick="closeMenuMobile()"></div>

   <header class="main-header">
    <button id="menu-btn" onclick="toggleMenuMobile()"><i class="fas fa-bars"></i></button>

    <img src="cbmrr.png" alt="Logo CBM-RR" class="header-icon" 
         style="margin-right: -10px;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/000000/fff?text=CBM'">
    
    <div class="header-title-desktop">
        <span class="text-white"> CORPO DE BOMBEIROS MILITAR </span>
        <span class="text-red">RORAIMA</span>
    </div>

    <div class="header-title-mobile">
        <span class="text-white">CBM</span><span class="text-red">RR</span>
    </div>
    
    <img src="logo_sigma.png" alt="Logo SIGMA" class="header-icon" 
         style="opacity: 0;" 
         onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=S'">

    <div id="dashboard-greeting" style="display:none; margin-left: 20px; font-size: 0.9em; font-style: italic;">
        Bem-vindo(a)! Preencha a confer√™ncia para hoje.
    </div>
    <button onclick="logout()" class="btn-modern-action btn-logout-header" style="margin-left: auto;">
        <i class="fas fa-sign-out-alt"></i> 
    </button>
</header>
    
    <div class="sidebar" id="main-sidebar">
        <div class="sidebar-header">
            <img src="logo_sigma.png" alt="Logo SIGMA" onerror="this.onerror=null; this.src='https://placehold.co/50x50/ffffff/800020/fff?text=S'">
            <div id="sidebar-user-info">
            <span id="user-name"></span>
            <span id="user-role-display" class="profile-badge">Carregando...</span>
        </div>
        </div>
        <div class="menu-label">Operacional</div>
        <a onclick="switchView('dashboard')" id="link-dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard & Servi√ßo</a>
        <a onclick="switchView('my-history')" id="link-my-history"><i class="fas fa-history"></i> Minhas Confer√™ncias</a>
        <a onclick="switchView('cautelas')" id="link-cautelas" class="restricted-admin-only"><i class="fas fa-boxes"></i> Gest√£o de Cautelas</a>
        
        <div class="menu-label restricted-admin-only" id="sidebar-rotulo-admin">Administra√ß√£o</div>
        <a onclick="switchView('global-history')" id="link-global-history"><i class="fas fa-folder-open"></i> Hist√≥rico da Unidade</a>
        <a onclick="switchView('unidades')" id="link-unidades" class="restricted-admin-only"><i class="fas fa-shield-alt"></i> Unidades</a>
        <a onclick="switchView('postos')" id="link-postos" class="restricted-admin-only"><i class="fas fa-map-signs"></i> Postos</a>
        <a onclick="switchView('usuarios')" id="link-usuarios" class="restricted-admin-only"><i class="fas fa-users"></i> Usu√°rios</a>
        <a onclick="switchView('listas')" id="link-listas" class="restricted-admin-only"><i class="fas fa-clipboard-list"></i> Editor de Listas</a>
    </div>
    <div id="content-area" class="main-content-wrapper">
        </div>

    <div class="content">
        
        <div id="view-dashboard" class="view-section active-view">
            <div class="greeting-card">
                <img id="greeting-photo" src="https://placehold.co/70x70/ffffff/800020?text=U" class="greeting-avatar">
                <div class="greeting-info">
                    <div class="greeting-text-wrapper"> 
                        <h2 id="greeting-text" class="greeting-title">Carregando...</h2>
                        <span id="greeting-name" class="greeting-user">...</span>
                        <span id="current-date" class="greeting-date">...</span>
                    </div>
                </div>
        
                <button id="btn-open-conf-modal" class="btn-modern-action" style="background-color: #d90f23;" onclick="openNewConferenceModal()">
                    <i class="fas fa-play-circle"></i> Nova Confer√™ncia
                </button>
            </div>

            <div id="resume-container"></div>
            <div id="dashboard-content-by-role">
                <div id="admin-gestor-cards-container"></div>
                <div id="operacional-cards-container"></div>
            </div>
    
            <div id="ca-table-wrapper" class="ca-table-container" style="display: none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="table-title" style="margin:0; color:#800020;">Detalhes</h2>
                    <button onclick="fecharTabela()" class="btn-modern-action btn-delete">Fechar</button>
                </div>
                <table class="ca-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Status</th>
                            <th>Altera√ß√£o</th>
                            <th>Conferente/Data</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="ca-list-body"></tbody>
                </table>
                <div id="no-issues-msg" style="display:none; padding:20px; text-align:center; color:green;">
                    ‚úÖ Tudo OK.
                </div>
            </div>
        </div>
        
        <div id="view-my-history" class="view-section">
            <div class="op-card history">
                <h2 class="op-card-title"><i class="fas fa-history"></i> Minhas Confer√™ncias</h2>
                <div class="modern-filter-card">
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                        <input type="date" id="my-hist-start" class="filter-input">
                    </div>
                    <div class="filter-item">
                        <label><i class="far fa-calendar-alt"></i> Data Final</label>
                        <input type="date" id="my-hist-end" class="filter-input">
                    </div>
                    <div class="filter-item" style="flex: 0;">
                        <button class="btn-filter-modern" onclick="loadMyHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
                <ul id="my-history-list" class="history-list"></ul>
            </div>
        </div>

    <div id="view-global-history" class="view-section">
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-folder-open"></i> Hist√≥rico da Unidade (Gest√£o)</h2>
            <div class="modern-filter-card">
                <div class="filter-item">
                    <label><i class="fas fa-user"></i> Conferente</label>
                    <select id="glob-hist-user" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                    <input type="date" id="glob-hist-start" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="far fa-calendar-alt"></i> Data Final</label>
                    <input type="date" id="glob-hist-end" class="filter-input">
                </div>
                <div class="filter-item">
                    <label><i class="fas fa-map-marker-alt"></i> Local</label>
                    <select id="glob-hist-local" class="filter-input"><option value="">Todos</option></select>
                </div>
                <div class="filter-item" style="flex: 0;">
                    <button class="btn-filter-modern" onclick="loadGlobalHistory()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>
            <ul id="global-history-list" class="history-list"></ul>
        </div>
    </div>

    <div id="view-usuarios" class="view-section">
    <h1>Gest√£o de Usu√°rios</h1>
    <div class="new-local-section">
        <h3>Cadastrar Novo Militar</h3>
        
        <div class="form-grid-2-columns" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            
            <div class="form-group"><label>Nome Civil Completo</label><input type="text" id="new-user-completo" placeholder="NOME COMPLETO"></div>
            <div class="form-group"><label>Nome de Guerra</label><input type="text" id="new-user-guerra" placeholder="EX: JHONATH"></div>
            
            <div class="form-group">
                <label>Posto / Gradua√ß√£o</label>
                <select id="new-user-posto">
                    <option value="" disabled selected>Selecione o Posto</option>
                    <option value="CEL">CEL</option>
                    <option value="TEN CEL">TEN CEL</option>
                    <option value="MAJ">MAJ</option>
                    <option value="CAP">CAP</option>
                    <option value="1¬∫ TEN">1¬∫ TEN</option>
                    <option value="2¬∫ TEN">2¬∫ TEN</option>
                    <option value="ST">ST</option>
                    <option value="1¬∫ SGT">1¬∫ SGT</option>
                    <option value="2¬∫ SGT">2¬∫ SGT</option>
                    <option value="3¬∫ SGT">3¬∫ SGT</option>
                    <option value="CB">CB</option>
                    <option value="SD">SD</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Quadro</label>
                <select id="new-user-quadro" disabled>
                    <option value="" disabled selected>Selecione o Posto acima</option>
                </select>
            </div>
            
            <div class="form-group"><label>CPF</label><input type="text" id="new-user-cpf" placeholder="000.000.000-00" maxlength="14"></div>
            <div class="form-group"><label>Matr√≠cula</label><input type="text" id="new-user-matricula" placeholder="0000000-000" maxlength="11"></div>
            <div class="form-group"><label>Telefone para Contato</label><input type="text" id="new-user-telefone" placeholder="(00) 00000-0000" maxlength="15"></div>
            
            <div class="form-group"><label>Email (Login)</label><input type="email" id="new-user-email" placeholder="email@cbm.rr.gov.br"></div>
            
            <div class="form-group">
                <label>Perfil</label>
                <select id="new-user-role">
                    <option value="operacional">Operacional</option>
                    <option value="gestor">Gestor de Unidade</option>
                    <option value="admin">Administrador Geral</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Unidade</label>
                <select id="new-user-unit"><option value="">Carregando...</option></select>
            </div>
        </div>
        
        <button class="btn-modern-action btn-create" onclick="criarUsuario()" style="margin-top: 10px;">Salvar Usu√°rio</button>
    </div>
        
        <h3>Usu√°rios Cadastrados</h3>
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="user-search-input"><i class="fas fa-search"></i> Filtrar por Nome de Exibi√ß√£o:</label>
                <input type="text" id="user-search-input" placeholder="Digite o Nome de Exibi√ß√£o (Posto Quadro Nome Guerra)" class="filter-input" oninput="filtrarUsuarios()">
            </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Militar</th>
                    <th>Telefone para Contato</th> 
                    <th>Perfil</th>
                    <th>Unidade</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="users-table-body"></tbody>
        </table>
    </div>

    <div id="view-unidades" class="view-section">
        <h1>Gest√£o de Unidades</h1>
        <div class="new-local-section">
            <h3>Criar Nova Unidade</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome da Unidade (Ex: 1¬™ CIA, CBS)</label>
                    <input type="text" id="new-unit-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarUnidade()">Adicionar</button>
            </div>
        </div>
        <h3>Unidades Existentes</h3>
        <div id="units-cards-container" class="cards-grid"></div>
    </div>
  
    <div id="view-postos" class="view-section">
        <h1>Gest√£o de Postos</h1>
        <div class="new-local-section">
            <h3>Criar Novo Posto</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex-grow: 1; margin-bottom:0;">
                    <label>Nome do Posto (Ex: ALFA, BRAVO)</label>
                    <input type="text" id="new-posto-name">
                </div>
                <button class="btn-modern-action btn-create" onclick="criarPosto()">Adicionar</button>
            </div>
        </div>
        <h3>Postos Existentes</h3>
        <div id="postos-cards-container" class="cards-grid"></div>
    </div>

    <div id="view-listas" class="view-section">
        <h1>Editor de Listas</h1>
        <div class="new-local-section">
            <h3>Criar Lista</h3>

<div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
    
    <div class="form-group" style="flex: 1 1 200px;"> 
        <label>Posto de Servi√ßo</label>
        <select id="novo-local-posto" class="filter-input">
            <option value="" disabled selected>Carregando Postos...</option>
        </select>
    </div>

    <div class="form-group" style="flex: 1 1 250px;">
        <label>Nome do Novo Item</label>
        <input type="text" id="novo-local-nome" placeholder="EX: RESGATE 01" class="filter-input">
    </div>

    <div class="form-group" style="flex: 1 1 200px;">
        <label>Unidade de V√≠nculo</label>
        <select id="novo-local-unidade" class="filter-input">
            <option value="" disabled selected>Carregando Unidades...</option>
        </select>
    </div>

    <button class="btn-modern-action btn-create" onclick="criarNovoLocal()" style="height: 40px; margin-bottom: 5px;">CRIAR</button>

</div>
        </div>
        <ul id="lista-locais-container" class="locais-list"></ul>
    </div>

    <div id="view-editor" class="view-section">
        <div class="admin-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button onclick="switchView('listas')" class="btn-modern-action btn-edit">Voltar</button>
                <h1 class="page-title" id="editor-title" style="font-size:1.2em; margin:0;">Editando...</h1>
            </div>
            <div id="loading-message-admin">Carregando...</div>
                <div id="main-admin-content" style="display:none;">
                    <div class="global-actions">
                        <button class="btn-modern-action btn-sync" onclick="salvarDados()">Salvar</button>
                        <button class="btn-modern-action btn-backup" onclick="fazerBackupLocal()">Backup</button>
                        <input type="file" id="import-json" style="display: none;" onchange="importarBackupLocal(event)">
                        <button class="btn-modern-action btn-create" onclick="document.getElementById('import-json').click()">Importar</button>
              
                        <div class="add-setor-form" style="margin-left:auto; display:flex; gap:5px;">
                            <input type="text" id="input-setor-nome" placeholder="Nome Setor" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                            <button class="btn-add" onclick="adicionarSetor(document.getElementById('input-setor-nome').value)">+ Setor</button>
                        </div>
                    </div>
                    <ul id="lista-setores-container" class="lista-setores"></ul>
                </div>
            </div>
        </div>
        <div id="view-cautelas" class="view-section restricted-admin-only">
            <div class="header-container">
                <h2>Gest√£o de Cautelas</h2>
                <p>Gerenciamento completo das cautelas de materiais do sistema SIGMA.</p>
            </div>

            <div id="cautelas-options-container" class="cards-grid"> 

                <div class="sector-card menu-card" onclick="loadNewCautelaForm()">
                    <i class="fas fa-file-contract card-icon"></i>
                    <h3>Nova Cautela</h3>
                    <p>Gerar um novo termo de cautela para um militar.</p>
                </div>

                <div class="sector-card menu-card" onclick="showCautelasDashboard('Cautelas Ativas')">
                    <i class="fas fa-clipboard-check card-icon"></i>
                    <h3>Cautelas Ativas</h3>
                    <p>Visualizar e gerenciar todas as cautelas em vigor.</p>
                </div>

                <div class="sector-card menu-card" onclick="showCautelasDashboard('Cautelas a Receber')">
                    <i class="fas fas fa-inbox card-icon"></i> <h3>Cautelas a Receber</h3>
                    <p>Pend√™ncias de materiais a serem devolvidos/repassados.</p>
                </div>

                <div class="sector-card menu-card" onclick="showCautelasDashboard('Hist√≥rico')">
                    <i class="fas fa-history card-icon"></i>
                    <h3>Hist√≥rico de Cautelas</h3>
                    <p>Consultar todas as cautelas emitidas e finalizadas.</p>
                </div>

            </div>
    
            <div id="cautelas-content" class="main-content-area">
        </div>
</div>
    </div>
    
    <div id="app-runner-container"><iframe id="app-iframe" src=""></iframe></div>

    <div id="modal-gestao-ca" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-gestao-ca').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Item</h2>
            <p id="gestao-item-nome" style="color:#800020; font-weight:bold; margin-bottom:20px; border-bottom:1px dashed #ccc; padding-bottom:10px;"></p>
            
            <input type="hidden" id="gestao-doc-id">
            <input type="hidden" id="gestao-item-index">
            <input type="hidden" id="gestao-item-id-lista">
            <input type="hidden" id="gestao-item-max-qtd">
            
            <label>A√ß√£o a realizar</label>
            <select id="gestao-status">
                <option value="Solucionado">Solucionado (Apenas dar baixa)</option>
                <option value="Em solu√ß√£o">Em solu√ß√£o (Manter alerta)</option>
                <option value="Cautelado">Cautelado (Material saiu)</option>
                <option value="Remover">Remover da Lista (Baixar estoque)</option>
            </select>
            
            <div id="div-gestao-qtd" style="display:none;">
                <label style="color:#d90f23;">Quantidade a Remover do Estoque:</label>
                <input type="number" id="gestao-qtd" min="1" value="1">
                <small id="gestao-qtd-info" style="color:#666; font-size:0.85em;"></small>
            </div>
            
            <label>Observa√ß√£o da Gest√£o (Obrigat√≥rio)</label>
            <textarea id="gestao-obs" placeholder="Descreva o que foi feito (ex: Material consertado; Enviado para manuten√ß√£o; etc)"></textarea>
            
            <div class="modal-buttons">
                <button class="btn-modern-action btn-backup" onclick="document.getElementById('modal-gestao-ca').style.display='none'">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarGestaoCa()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-unit-manager" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('modal-unit-manager').style.display='none'"><i class="fas fa-times"></i></button>
            <h2>Gerenciar Unidade</h2>
            <label>Nome da Unidade</label>
            <input type="text" id="edit-unit-name-input">
            <input type="hidden" id="edit-unit-original-name">
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas:</label>
            <div id="unit-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirUnidade()">Excluir Unidade</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUnidade()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="modal-posto-manager" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="document.getElementById('modal-posto-manager').style.display='none'"><i class="fas fa-times"></i></button>
        <h2>Gerenciar Posto</h2>
        <label>Nome do Posto</label>
        <input type="text" id="edit-posto-name-input">
        <input type="hidden" id="edit-posto-original-name">
                <div id="posto-preview-container" style="
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    background-color: #f9f9f9;
                    margin-bottom: 20px;
                ">
                <p style="margin: 0;">Listas Atualmente Vinculadas: **Carregando...**</p>
            </div>
            
            <label style="margin-top:20px;">Vincular Viaturas/Listas a este Posto:</label>
            <div id="posto-lists-checklist" class="checklist-container">
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="btn-modern-action btn-delete" onclick="excluirPosto()">Excluir Posto</button>
                <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesPosto()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="modal-edicao" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="fecharModal()"><i class="fas fa-times"></i></button>
            <h2>Editar Item</h2>
            <input type="hidden" id="edit-setor-id">
            <input type="hidden" id="edit-item-original-id">
            <label>Nome:</label>
            <input type="text" id="edit-item-nome">
            <label>Mover para Setor:</label>
            <select id="edit-item-setor"></select>
            <label>Quantidade:</label>
            <input type="number" id="edit-item-qtd" min="1">
            <label>Tipo:</label>
            <select id="edit-item-tipo" disabled style="background-color: #eee;">
                <option value="single">Item √önico</option>
                <option value="multi">Item com Tombamento</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-remover" onclick="fecharModal()">Cancelar</button>
                <button class="btn-modern-action btn-sync" onclick="salvarEdicaoItem()">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-user-manager" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="document.getElementById('modal-user-manager').style.display='none'"><i class="fas fa-times"></i></button>
        <h2>Gerenciar Militar</h2>
        
        <input type="hidden" id="edit-user-doc-id">
        
        <div class="form-grid-2-columns" style="margin-bottom: 0;">
    <div>
        <label>Nome de Guerra</label>
        <input type="text" id="edit-user-guerra">
        
        <label>Posto/Gradua√ß√£o</label>
        <select id="edit-user-posto">
            <option value="" disabled selected>Selecione o Posto</option>
            <option value="CEL">CEL</option>
            <option value="TEN CEL">TEN CEL</option>
            <option value="MAJ">MAJ</option>
            <option value="CAP">CAP</option>
            <option value="1¬∫ TEN">1¬∫ TEN</option>
            <option value="2¬∫ TEN">2¬∫ TEN</option>
            <option value="ST">ST</option>
            <option value="1¬∫ SGT">1¬∫ SGT</option>
            <option value="2¬∫ SGT">2¬∫ SGT</option>
            <option value="3¬∫ SGT">3¬∫ SGT</option>
            <option value="CB">CB</option>
            <option value="SD">SD</option>
        </select>
        
        <label>Quadro</label>
        <select id="edit-user-quadro" disabled>
            <option value="" disabled selected>Selecione...</option>
        </select>

        <label>Nome de Exibi√ß√£o (Posto/Quadro/Guerra)</label>
        <input type="text" id="edit-user-display-name" disabled style="background-color: #eee;">
    </div>

    <div>
        <label>CPF (Apenas d√≠gitos)</label>
        <input type="text" id="edit-user-cpf"> 
        
        <label>Matr√≠cula (Apenas d√≠gitos)</label>
        <input type="text" id="edit-user-matricula">
        
        <label>Telefone para Contato (DDD)</label>
        <input type="text" id="edit-user-telefone">
    </div>
</div>

<hr style="margin: 20px 0; border: 0; border-top: 1px dashed #eee;">

<label>Nome Civil Completo</label>
<input type="text" id="edit-user-completo">

        <label>E-mail (Login) - *Somente Leitura*</label>
        <input type="email" id="edit-user-email" disabled style="background-color: #eee;">

        <label>Perfil de Acesso</label>
        <select id="edit-user-role">
            <option value="operacional">Operacional</option>
            <option value="gestor">Gestor de Unidade</option>
            <option value="admin">Administrador Geral</option>
        </select>

        <label>Unidade Associada</label>
        <select id="edit-user-unit"><option value="">Carregando...</option></select>
        
        <div id="user-permissions-fields" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; display: none;">
            <label class="section-label" style="font-weight: bold;">Permiss√µes de Gestor</label>
            <p style="font-size: 0.8em; margin: 5px 0 10px; color: #666;">Essas permiss√µes s√≥ s√£o aplic√°veis a usu√°rios com a Role 'gestor'.</p>

            <div style="display: flex; flex-direction: column; gap: 5px;">
                <label><input type="checkbox" id="perm-view-cards"> Visualizar Cards de Pend√™ncia C/A</label>
                <label><input type="checkbox" id="perm-view-history"> Acesso ao Hist√≥rico da Unidade</label>
                <label><input type="checkbox" id="perm-manage-posts"> Gerenciar V√≠nculos de Postos</label>
                <label><input type="checkbox" id="perm-manage-users"> Gerenciar Usu√°rios da Unidade</label>
                <label><input type="checkbox" id="perm-manage-lists"> Gerenciar Listas da Unidade</label>
            </div>
        </div>
        
        <div class="modal-buttons" style="justify-content: space-between;">
            <button class="btn-modern-action btn-delete" onclick="excluirUsuario()">Excluir Militar</button>
            <button class="btn-modern-action btn-sync" onclick="salvarAlteracoesUsuario()">Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>
    <div id="modal-nova-conferencia" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <button class="close-btn" onclick="document.getElementById('modal-nova-conferencia').style.display='none'"><i class="fas fa-times"></i></button>
        <div class="op-card action" style="border: none; box-shadow: none; padding: 0;">
            <h2 class="op-card-title"><i class="fas fa-clipboard-list"></i> Nova Confer√™ncia</h2>
            <div class="form-group">
                <label>1. Escolha o Setor / Posto</label>
                <select id="dash-select-setor" onchange="filtrarListasDashboard()">
                    <option value="" disabled selected>Carregando setores...</option>
                </select>
            </div>
            <div class="form-group">
                <label>2. Escolha a Viatura / Lista</label>
                <select id="dash-select-lista" disabled onchange="focarBotaoIniciar()">
                    <option value="" disabled selected>Selecione um setor acima</option>
                </select>
            </div>
            <button id="btn-start-dash" class="btn-start" onclick="iniciarConferenciaDashboard()">INICIAR AGORA</button>
        </div>
    </div>
        
</div>
    <div id="cautelaDetailsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #800020;"><i class="fas fa-clipboard-list"></i> Detalhes da Cautela <span id="modal-cautela-id"></span></h3>
            <span style="font-size: 1.2em; font-weight: bold; color: #d90f23;" id="modal-status"></span>
        </div>
    
        <div class="form-area" style="padding: 15px; border: none; box-shadow: none; background-color: #f9f9f9; margin-bottom: 15px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div><label>Emitente (Origem):</label><span id="modal-emitente" class="info-value"></span></div>
        <div><label>Destinat√°rio (Original):</label><span id="modal-destinatario-original" class="info-value"></span></div>
        <div><label>Recebedor:</label><span id="modal-destinatario-atual" class="info-value"></span></div>
        
        <div><label>Local de Origem:</label><span id="modal-local-origem" class="info-value"></span></div>
        <div><label>Data de Emiss√£o:</label><span id="modal-data-emissao" class="info-value"></span></div>
        <div><label>Status:</label><span id="modal-status-text" class="info-value"></span></div>
    </div>
    <label>Observa√ß√µes da Emiss√£o:</label>
    <div id="modal-obs-emissao" style="background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee; min-height: 50px;"></div>
    </div>
<span style="font-size: 1.2em; font-weight: bold; color: #d90f23;" id="modal-status"></span>
        
        <h4 style="color: #800020; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px;">Itens Cautelados:</h4>
        <ul id="modal-itens-cautela" class="cautela-item-list" style="max-height: 250px; overflow-y: auto; margin-top: 10px;">
            </ul>
        
        <div class="modal-actions">
            <button class="btn-modern-action" id="btn-receber-cautela" style="display: none;">
                <i class="fas fa-check-circle"></i> Iniciar Recebimento
            </button>
            
            <button class="btn-modern-action btn-delete" id="btn-devolver-cautela" style="display: none;">
                <i class="fas fa-undo"></i> Iniciar Devolu√ß√£o
            </button>
            
            <button class="btn-modern-action btn-sync" id="btn-confirmar-devolucao" style="display: none;">
                <i class="fas fa-handshake"></i> Confirmar Recebimento da Devolu√ß√£o
            </button>
            
            <button class="modal-btn-cancel" onclick="document.getElementById('cautelaDetailsModal').style.display='none'">Fechar</button>
        </div>
    </div>
</div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        
        function openNewConferenceModal() {
        document.getElementById('modal-nova-conferencia').style.display = 'flex';
        }
        // Constantes Globais
        const COLECAO_RESULTADOS = 'resultados_conferencias';
        const COLECAO_LISTAS = 'listas_conferencia';

        // Vari√°veis Globais
        let currentUserData = null;
        let allLists = [];
        let allUsersData = [];
        let allTargetUsers = [];
        let dadosConferencia = []; // Para o editor
        let currentEditingId = null;
        let conferente = '';

        // --- 1. AUTH & PERMISS√ïES ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection('usuarios').doc(user.uid).get();
                    if (doc.exists) {
                        currentUserData = doc.data();
                        conferente = currentUserData.nome_militar_completo;
                        setupUIBasedOnRole();
                    } else {
                        alert("Usu√°rio sem registro no banco."); 
                        window.location.href = 'index.html';
                    }
                } catch (e) { 
                    console.error(e); 
                }
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        function setupUIBasedOnRole() {
¬† ¬† const role = currentUserData.role || 'operacional';
¬† ¬† const unit = currentUserData.unidade || 'N/D';
// --- CORRE√á√ÉO DE SEGURAN√áA NA LINHA 301 ---
¬† ¬† const roleDisplay = document.getElementById('user-role-display');
// Verifica se o elemento existe antes de tentar definir o texto
¬† ¬† if (roleDisplay) {¬†
¬† ¬† ¬† ¬† roleDisplay.textContent = `${role.toUpperCase()} - ${unit}`;
}
¬† ¬† // ------------------------------------------

¬† ¬† atualizarSaudacao(currentUserData);
// --- 1. Definindo as Permiss√µes Reais de Acesso ---
¬† ¬† const p = currentUserData.permissoes || {};
// Objeto de Permiss√µes
¬† ¬† const isGestorOuAdmin = (role === 'gestor' || role === 'admin');
¬† ¬† const canViewAdminTools = role === 'admin';
¬† ¬† const canViewDashboardCards = role === 'admin' ||
¬† ¬† (isGestorOuAdmin && p.canViewDashboardCards);
¬† ¬† const canViewUnitHistory = role === 'admin' || (isGestorOuAdmin && p.canViewUnitHistory);
¬† ¬† const canManageUnits = role === 'admin';
// Assume que Gerenciamento de Unidades √© Admin-Only
¬† ¬† const canManagePosts = role === 'admin' ||
(isGestorOuAdmin && p.canManagePosts);
¬† ¬† const canManageUnitUsers = role === 'admin' || (isGestorOuAdmin && p.canManageUnitUsers);
¬† ¬† const canManageUnitLists = role === 'admin' ||
(isGestorOuAdmin && p.canManageUnitLists);
// --- 2. Aplica√ß√£o das Restri√ß√µes na UI (Corrigida e Segura) ---
¬† ¬†¬†
¬† ¬† // Reseta visibilidade dos links de Admin.
¬† ¬† document.querySelectorAll('.restricted-admin-only').forEach(el => {
¬† ¬† ¬† ¬† if(el) el.style.display = 'block';
¬† ¬† });
// Oculta o R√≥tulo e Links de Admin se for Operacional
¬† ¬† if (role === 'operacional') {
        renderOperacionalCards();
 } else {
        // Para Admin e Gestor
        renderAdminGestorCards(canViewDashboardCards);
        // ‚úÖ CORRE√á√ÉO: Removido carregarConferenciasHoje() para evitar TypeError: Cannot set properties of null
    }

¬† ¬† // --- 2.1 Ajuste Fino dos Links de Gest√£o (para Gestores e Admin) ---
¬† ¬†¬†
¬† ¬† if (!canManageUnits) {¬†
¬† ¬† ¬† ¬† const linkUnidades = document.getElementById('link-unidades');
¬† ¬† ¬† ¬† if(linkUnidades) linkUnidades.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† if (!canManagePosts) {¬†
¬† ¬† ¬† ¬† const linkPostos = document.getElementById('link-postos');
¬† ¬† ¬† ¬† if(linkPostos) linkPostos.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† if (!canManageUnitUsers) {¬†
¬† ¬† ¬† ¬† const linkUsuarios = document.getElementById('link-usuarios');
¬† ¬† ¬† ¬† if(linkUsuarios) linkUsuarios.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† if (!canManageUnitLists) {¬†
¬† ¬† ¬† ¬† const linkListas = document.getElementById('link-listas');
¬† ¬† ¬† ¬† if(linkListas) linkListas.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† // Oculta o Hist√≥rico Global se a permiss√£o n√£o estiver marcada
¬† ¬† const globalHistoryLink = document.getElementById('link-global-history');
¬† ¬† if (!canViewUnitHistory && globalHistoryLink) {
¬† ¬† ¬† ¬† globalHistoryLink.style.display = 'none';
¬† ¬† }
¬† ¬†¬†
¬† ¬† // Ocultar R√≥tulo Admin se n√£o sobrou nenhum link
¬† ¬† const adminLinks = ['link-unidades', 'link-postos', 'link-usuarios', 'link-listas'];
¬† ¬† const anyAdminLinkVisible = adminLinks.some(id => {
¬† ¬† ¬† ¬† const el = document.getElementById(id);
¬† ¬† ¬† ¬† return el && el.style.display !== 'none';
¬† ¬† });
¬† ¬† const rotuloAdmin = document.getElementById('sidebar-rotulo-admin');
¬† ¬† if (!anyAdminLinkVisible && rotuloAdmin) {
¬† ¬† ¬† ¬† rotuloAdmin.style.display = 'none';
¬† ¬† }

    // --- 3. Chamadas de Dados Comuns (Manter) ---
    carregarListasParaNovaConferencia(); // Preenche o modal "Iniciar Confer√™ncia"
    verificarConferenciaAtiva(); // Renderiza o card de "Continuar Confer√™ncia"
    
¬† ¬† // ===================================
¬† ¬† // SOLU√á√ÉO PARA INICIAR O MENU FECHADO
¬† ¬† // ===================================
¬† ¬† closeMenuMobile();
// --- Trava do Bot√£o Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o bot√£o Voltar do navegador
        history.pushState(null, null, location.href);
    }
    // ----------------------------------------------

¬† ¬† // Garante que a vis√£o seja o dashboard ao logar
¬† ¬† switchView('dashboard');
    setupMasksForModal();       
}
        /**
 * Adiciona listeners de formata√ß√£o (m√°scara) aos inputs do modal Gerenciar Militar.
 */
function setupMasksForModal() {
    const cpfInput = document.getElementById('edit-user-cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
        // Aplica a m√°scara imediatamente para valores preenchidos na abertura do modal
        formatarCPF(cpfInput); 
    }
    
    const matriculaInput = document.getElementById('edit-user-matricula');
    if (matriculaInput) {
        matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
        formatarMatricula(matriculaInput);
    }
    
    const telefoneInput = document.getElementById('edit-user-telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));
        formatarTelefone(telefoneInput);
    }
}
            // --- NOVO: Cards Espec√≠ficos para Operacional ---
function renderOperacionalCards() {
    const container = document.getElementById('operacional-cards-container');
    if (!container) return;
    
    // Esconde o container de Admin/Gestor se existir
    const adminContainer = document.getElementById('admin-gestor-cards-container');
    if(adminContainer) adminContainer.style.display = 'none';

    container.innerHTML = `
        
        <div class="op-card history">
            <h2 class="op-card-title"><i class="fas fa-calendar-day"></i> Confer√™ncias Realizadas Hoje (Minhas)</h2>
            <ul id="today-list" class="history-list">
                <li style="text-align:center; color:#999; padding:20px;">Carregando...</li>
            </ul>
        </div>

    
        <div class="op-card history" style="margin-top: 25px;">
            <h2 class="op-card-title" style="margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> Dashboard Operacional</h2>
            <div class="cards-grid">
                
                <div class="sector-card status-ok" onclick="switchView('my-history')">
                    <h3>Minhas Confer√™ncias</h3>
    
                    <div class="main-stat">
                        <span class="count-value" id="op-conf-count">0</span>
                        <i class="fas fa-history fa-2x" style="color:#1b8a3e;"></i>
                    </div>
         
                    <div class="card-footer">
                        Clique para ver o hist√≥rico completo.
                    </div>
                </div>
                <div class="sector-card status-unit" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas Ativas');">
                    <h3>Minhas Cautelas Ativas</h3>
                    <div class="main-stat">
              
                    <span class="count-value" id="op-my-active-cautela-count">0</span>
                        <i class="fas fa-shield-alt fa-2x" style="color:#2c7399;"></i>
                </div>
                <div class="card-footer">
                    
                    Itens que est√£o sob sua cautela.
                </div>
            </div>

                <div class="sector-card status-posto" onclick="switchView('cautelas'); showCautelasDashboard('Cautelas a Receber');">
                    <h3>Cautelas a Receber</h3>
                    <div class="main-stat">
            
                        <span class="count-value" id="op-cautela-receive-count">0</span>
                        <i class="fas fa-box-open fa-2x" style="color:#8e44ad;"></i>
                    </div>
                    <div class="card-footer">
                  
                        Itens pendentes de recebimento/transfer√™ncia.
                    </div>
                </div>
                
            </div>
        </div>
    `;
    
    // [NOVO] Adicionar l√≥gica para atualizar a contagem de confer√™ncias hoje no card
    updateOperacionalCards();
    container.style.display = 'block';
}
// [NOVO] Atualiza a contagem do Card "Minhas Confer√™ncias"
async function getCautelasAReceberCount() {
    if (!currentUserData || !currentUserData.nome_militar_completo) return 0;
    
    const militarCompleto = currentUserData.nome_militar_completo;

    try {
        // 1. Query ABERTAS (Fluxo normal)
        const snapAberta = await db.collection('cautelas_abertas')
            .where('destinatario', '==', militarCompleto)
            .where('status', '==', 'ABERTA')
            .get();
            
        // 2. Query DEVOLU√á√ÉO (Fluxo de retorno)
        const snapDevolucao = await db.collection('cautelas_abertas')
            .where('destinatario', '==', militarCompleto)
            .where('status', '==', 'DEVOLU√á√ÉO')
            .get();
            
        // Soma os resultados das duas consultas para o contador do card
        return snapAberta.size + snapDevolucao.size;
        
    } catch (e) {
        console.error("Erro ao contar cautelas a receber:", e);
        return 0;
    }
}
       /**
 * Busca e retorna a contagem de cautelas ativas/recebidas do militar logado,
 * incluindo as que est√£o EM DEVOLU√á√ÉO (enviadas por ele).
 */
/**
 * Calcula a contagem total e desduplicada de cautelas ativas para o dashboard,
 * respeitando os filtros de perfil (Operacional, Gestor, Admin).
 */
async function countActiveCautelas() {
    if (!currentUserData || !currentUserData.nome_militar_completo) return 0;
    
    const role = currentUserData.role;
    const user = currentUserData;
    
    // Conjunto para garantir que cada Cautela ID seja contada apenas uma vez
    const countedIds = new Set();
    
    // --- 1. BUSCAS PARA OPERACIONAL / GESTOR (Regras Pessoais) ---
    if (role === 'operacional' || role === 'gestor') {
        
        // A. CUST√ìDIA ATIVA + RASTREIO DE DEVOLU√á√ÉO (RECEBIDA como destinat√°rio OU DEVOLU√á√ÉO como reversor)
        // Usaremos duas queries separadas e depois desduplicaremos para garantir a contagem.
        
        // CUST√ìDIA ATIVA (RECEBIDA)
        const custodiaRecebida = await queryCautelas(['RECEBIDA'], role, user, 'destinatario', 'personal');
        custodiaRecebida.forEach(c => countedIds.add(c.cautela_id));
        
        // RASTREIO DE RESPONSABILIDADE (DEVOLU√á√ÉO como Reversor)
        const devolucaoRastreio = await queryCautelas(['DEVOLU√á√ÉO'], role, user, 'militar_completo_reversor', 'personal');
        devolucaoRastreio.forEach(c => countedIds.add(c.cautela_id));

        // B. RASTREIO PESSOAL (ABERTA, RECEBIDA, DEVOLU√á√ÉO como Emitente)
        const rastreioEmitente = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLU√á√ÉO'], role, user, 'emitente', 'personal');
        rastreioEmitente.forEach(c => countedIds.add(c.cautela_id));
    }
    
    // --- 2. BUSCAS PARA GESTOR / ADMIN (Regras Gerenciais de Monitoramento) ---
    if (role === 'gestor' || role === 'admin') {
        
        // MONITORAMENTO: ABERTA, RECEBIDA, DEVOLU√á√ÉO (Filtro por Unidade ou Global)
        const monitoramentoRaw = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLU√á√ÉO'], role, user, null, 'unit');

        // Adiciona todos os IDs de monitoramento no Set (ele cuida da desduplica√ß√£o)
        monitoramentoRaw.forEach(c => countedIds.add(c.cautela_id));
    }

    // O tamanho do Set √© a contagem total desduplicada de todas as cautelas ativas
    return countedIds.size;
}
async function updateOperacionalCards() {
    const ul = document.getElementById('today-list');
    const countEl = document.getElementById('op-conf-count');
    // üõë NOVO: Elemento do contador de Cautelas a Receber
    const cautelaReceiveCountEl = document.getElementById('op-cautela-receive-count');
    const myActiveCautelaCountEl = document.getElementById('op-my-active-cautela-count');
    
    try {
        // --- 1. CONTAGEM TOTAL DE CONFER√äNCIAS (EXISTENTE) ---
        const snapTotal = await db.collection(COLECAO_RESULTADOS)
            .where('conferente', '==', currentUserData.nome_militar_completo)
            .get();
        const totalConferences = snapTotal.size; 
        if (countEl) countEl.textContent = totalConferences;

        // --- 2. CONTAGEM DE CAUTELAS A RECEBER (NOVO) ---
        const totalCautelasAReceber = await getCautelasAReceberCount();
        if (cautelaReceiveCountEl) cautelaReceiveCountEl.textContent = totalCautelasAReceber; 
        // FIM NOVO
        
        // --- 3. CONTAR MINHAS CAUTELAS ATIVAS (NOVO) ---
        const totalMyActiveCautelas = await countActiveCautelas();
        if (myActiveCautelaCountEl) myActiveCautelaCountEl.textContent = totalMyActiveCautelas; 
        // FIM NOVO
        
        const hojeStr = new Date().toLocaleDateString('pt-BR');
        let countToday = 0; // Contagem das confer√™ncias de hoje
        let html = '';
        
        snapTotal.forEach(d => {
            const dt = d.data().timestamp.toDate();
            // Filtro de data para listar apenas as de hoje
            if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                html += criarItemHistoricoHTML(d.data());
                countToday++; // Contagem de hoje
            }
        });
        
        // Atualiza a lista de hoje
        ul.innerHTML = html ||
        '<li style="padding:15px; text-align:center; color:#999;">Nenhuma confer√™ncia hoje.</li>';
        
    } catch(e) { 
        console.error("Erro ao carregar dados operacionais:", e);
        if(countEl) countEl.textContent = 'Erro';
        ul.innerHTML = 'Erro.';
    }
}
        
            // --- NOVO: Cards Espec√≠ficos para Admin/Gestor ---
// --- NOVO: Cards Espec√≠ficos para Admin/Gestor ---
function renderAdminGestorCards(canViewDashboardCards) {
    const container = document.getElementById('admin-gestor-cards-container');
    if (!container) return;
    const opContainer = document.getElementById('operacional-cards-container');
    if(opContainer) opContainer.style.display = 'none';
    if (canViewDashboardCards) {
        container.innerHTML = `
            <div id="dash-cards-restricted" class="op-card history" style="padding-top: 15px;">
                <h2 class="op-card-title" style="font-size: 1.2em; margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Pend√™ncias da Unidade
                </h2>
                <div id="loading-message-dashboard">Carregando dados...</div>
                <div id="cards-container" class="cards-grid">
                    </div>
            </div>
        `;
            loadCaaData(); 
            container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
} 
¬† ¬† closeMenuMobile();¬†

    // --- Trava do Bot√£o Voltar (Mobile/Browser) ---
    if (window.innerWidth <= 768) {
        // Adiciona um estado para interceptar o bot√£o Voltar do navegador
        history.pushState(null, null, location.href); 
    }
    // ----------------------------------------------

¬† ¬† // Garante que a vis√£o seja o dashboard ao logar
¬† ¬† switchView('dashboard');
        
        function atualizarSaudacao(user) {
            const now = new Date();
            const hour = now.getHours();
            let saudacao = "Bom dia";
            if (hour >= 12 && hour < 18) saudacao = "Boa tarde";
            else if (hour >= 18) saudacao = "Boa noite";
            
            const opcoesData = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let dataStr = now.toLocaleDateString('pt-BR', opcoesData);
            dataStr = dataStr.charAt(0).toUpperCase() + dataStr.slice(1);

            document.getElementById('greeting-text').textContent = saudacao + ",";
            document.getElementById('greeting-name').textContent = user.nome_militar_completo || user.nome_guerra;
            document.getElementById('current-date').textContent = dataStr;
            if(user.foto_url) document.getElementById('greeting-photo').src = user.foto_url;
        }

        // --- 2. VERIFICA√á√ÉO DE RESUME ---
        // --- 2. VERIFICA√á√ÉO DE RESUME ---
function verificarConferenciaAtiva() {
    const activeConf = localStorage.getItem('sigma_active_conf');
    const container = document.getElementById('resume-container');
    container.innerHTML = '';
    if (activeConf) {
        try {
            const confData = JSON.parse(activeConf);
            if(confData.user === currentUserData.nome_guerra) {
                container.innerHTML = `
                    <div class="op-card resume">
                        <button class="btn-resume-close" onclick="event.stopPropagation(); descartarConferenciaAtiva()">
                            <i class="fas fa-times"></i>
                        </button>
                        <div onclick="retomarConferencia('${confData.url}')" style="cursor: pointer;">
                            <h2 class="op-card-title" style="border:none; margin:0; color:#e65100;">
                                <i class="fas fa-play-circle"></i> Continuar: ${confData.nomeLista}
                            </h2>
                            <p style="margin:5px 0 0 30px; color:#666; font-size:0.9em;">
                                Clique para retomar de onde parou...
                            </p>
                        </div>
                    </div>`;
            }
        } catch(e) {}
    }
}
        

        function retomarConferencia(url) {
            const iframe = document.getElementById('app-iframe');
            const container = document.getElementById('app-runner-container');
            iframe.src = url;
            container.style.display = 'block';
        }
        // --- FUN√á√ÉO PARA DESCARTAR CONFER√äNCIA ATIVA ---
function descartarConferenciaAtiva() {
    const activeConf = localStorage.getItem('sigma_active_conf');
if (!activeConf) return; // N√£o h√° nada para descartar

    try {
        const confData = JSON.parse(activeConf);
        
        // CORRE√á√ÉO: Padroniza o nome de guerra lido do sigma_active_conf
        const userForDraft = (confData.user || 'ND').toUpperCase();
        
if (confirm("Tem certeza que deseja descartar esta confer√™ncia em andamento? Ela n√£o poder√° ser retomada!")) {
            // 1. Constr√≥i a chave do rascunho para limpeza (usando o nome padronizado)
            const draftKey = `sigma_draft_${confData.id}_${userForDraft}`;
// 2. Limpa o rascunho de progresso
            localStorage.removeItem(draftKey);
// 3. Limpa o card de resumo
            localStorage.removeItem('sigma_active_conf');
// 4. Atualiza UI
            verificarConferenciaAtiva(); 
            alert("Confer√™ncia e rascunho descartados.");
}
    } catch(e) {
        console.error("Erro ao descartar conf:", e);
        // Limpa o card de resumo (apenas para corrigir o loop visual)
        localStorage.removeItem('sigma_active_conf');
        verificarConferenciaAtiva();
    }
}
        // --- 3. DASHBOARD HIER√ÅRQUICO ---
        async function loadCaaData() {
            const container = document.getElementById('cards-container');
            if (!container) return;
            container.innerHTML = 'Carregando...';
            const loading = document.getElementById('loading-message-dashboard');
            loading.style.display = 'block';
            
            try {
                const rotasDoc = await db.collection('config_geral').doc('rotas').get();
                const rotas = rotasDoc.data() || {};
                const listToUnitMap = {};
                
                // Objeto para mapear o ID √öNICO da ROTA/LISTA ao nome da Unidade
                Object.keys(rotas).forEach(key => {
                    // key √© o ID da lista (ex: "alfa_permanencia")
                    if (!key.toLowerCase().includes('bravo 5') && rotas[key].ativo !== false) {
                        listToUnitMap[key] = rotas[key].unidade || 'GERAL';
                    }
                });
                
                const snap = await db.collection(COLECAO_RESULTADOS).limit(100).get();
                
                // ALTERA√á√ÉO CR√çTICA: 'map' agora usar√° o LISTA_ID como chave, n√£o o NOME do local.
                const map = {}; 
                const docs = [];
                snap.forEach(d => docs.push({id:d.id, ...d.data()}));
                
                // Ordena√ß√£o por tempo (mais recente primeiro)
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                docs.forEach(d => {
                    const listaId = d.lista_id; // Usamos o ID √∫nico do resultado
                    
                    // Condi√ß√£o crucial: S√≥ processa se a lista existir no mapa filtrado (rotas)
                    if (!rotas[listaId]) return; 

                    // Filtro de seguran√ßa (para Gestores)
                    const listUnit = rotas[listaId].unidade || 'GERAL';
                    if (currentUserData.role === 'gestor' && listUnit !== currentUserData.unidade) return;

                    // CORRE√á√ÉO: Usamos o listaId como chave para garantir unicidade.
                    // A primeira a ser encontrada (a mais recente) √© a que prevalece.
                    if (!map[listaId]) {
                        map[listaId] = { 
                            docId: d.id, 
                            local: d.local, 
                            conferente: d.conferente, 
                            date: d.timestamp.toDate().toLocaleString(), 
                            items: d.itensCaa || [] 
                        };
                    }
                });
                
                // Passamos o novo mapa baseado em ID para renderizar os cards
                renderCards(map); 
            } catch (e) { 
                console.error(e); 
                container.innerHTML = 'Erro ao carregar.';
            } finally { 
                loading.style.display = 'none';
            }
        }
        
       
        async function renderCards(map) {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';
    const keys = Object.keys(map);
    
    // 1. CARREGAR ROTAS PARA MAPEAMENTO DE UNIDADE
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    if (keys.length === 0) { 
        container.innerHTML = '<p style="padding:20px;">Nenhuma pend√™ncia encontrada.</p>';
        return;
    }

    // 2. AGRUPAR CARDS POR UNIDADE
    const groupedCards = {};
    keys.forEach(listaId => {
        const d = map[listaId];
        // Busca a Unidade associada a esta lista_id na cole√ß√£o 'rotas'
        const unit = rotas[listaId]?.unidade || 'GERAL'; 
        
        if (!groupedCards[unit]) {
            groupedCards[unit] = [];
        }
        groupedCards[unit].push(d);
    });

    // 3. RENDERIZAR AGRUPADO POR UNIDADE (Restaura o agrupamento e o empilhamento)
    const sortedUnits = Object.keys(groupedCards).sort();
sortedUnits.forEach(unit => {
        const cardsList = groupedCards[unit];
        
        // --- Cabe√ßalho da Unidade ---
       const unitHeader = document.createElement('h3');
        unitHeader.className = 'unit-header';
        
        // Restaura as regras inline necess√°rias (removendo as que causavam o erro de JS)
        unitHeader.style.cssText = 'display: block; width: 100%; color: #800020; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; box-sizing: border-box; font-size: 1.2em;'; 
        
        // NOVO HTML: Usa a estrutura Flexbox para o alinhamento vertical
        unitHeader.innerHTML = `
            <div class="unit-flex-title">
                <i class="fas fa-building"></i>
                <span>${unit}</span>
            </div>
        `;
        container.appendChild(unitHeader); 
        
        // --- Container dos Cards da Unidade ---
        // Aqui n√£o precisamos criar um novo grid, apenas adicionamos os cards ao container principal (container).
        cardsList.forEach(d => {
            const items = d.items || [];
            const count = items.filter(i => i.statusAdmin !== 'Solucionado').length; 
            
            const div = document.createElement('div');
            // O CSS para .sector-card (flex: 0 0 280px) permite que ele se organize lado a lado
            div.className = `sector-card ${count === 0 ? 'status-ok' : 'status-alert'}`;
            div.innerHTML = `
                <h3>${d.local}</h3>
                <div class="main-stat">
                    <span class="count-value">${count === 0 ? 'OK' : count}</span>
                </div>
                <div class="card-footer">
                    <strong>${d.conferente}</strong><br>${d.date}
                </div>
            `;
            div.onclick = () => mostrarTabela(d);
            container.appendChild(div); // Adiciona o card ao container principal (que √© um flexbox)
        });
    });
    
    if (container.children.length === 0) {
        container.innerHTML = '<p style="padding:20px;">Nenhuma pend√™ncia encontrada para sua unidade ou permiss√£o.</p>';
    }
}
        // --- 4. NOVA CONFER√äNCIA ---
        async function carregarListasParaNovaConferencia() {
            try {
                const doc = await db.collection('config_geral').doc('rotas').get();
                const rotas = doc.data();
                allLists = []; 
                const setores = new Set();
                
                Object.entries(rotas).forEach(([id, info]) => {
                    if (info.ativo !== false && id !== 'ABT-17' && id !== 'ABT-18' && id.indexOf('bravo 5') === -1) {
                        allLists.push({ id: id, nome: info.nome, setor: info.posto });
                        setores.add(info.posto);
                    }
                });
                
                const sel = document.getElementById('dash-select-setor');
                sel.innerHTML = '<option value="" disabled selected>Selecione o Setor...</option>';
                
                Array.from(setores).sort().forEach(s => {
                    const opt = document.createElement('option'); 
                    opt.value = s; 
                    opt.textContent = s; 
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        function filtrarListasDashboard() {
            const setor = document.getElementById('dash-select-setor').value;
            const selLista = document.getElementById('dash-select-lista');
            selLista.innerHTML = '<option value="" disabled selected>Selecione a Lista...</option>'; 
            selLista.disabled = false;
            
            const fil = allLists.filter(l => l.setor === setor).sort((a,b)=>a.nome.localeCompare(b.nome));
            fil.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l.id; 
                o.textContent = l.nome; 
                selLista.appendChild(o); 
            });
            selLista.focus();
        }

        function focarBotaoIniciar() { 
            document.getElementById('btn-start-dash').focus();
        }

        function iniciarConferenciaDashboard() {
            const listaId = document.getElementById('dash-select-lista').value;
            const listaSelect = document.getElementById('dash-select-lista');
            const nomeLista = listaSelect.options[listaSelect.selectedIndex].text;
            
            if(!listaId) return alert("Selecione uma lista.");
            
            // --- CORRE√á√ÉO: Padroniza o nome do usu√°rio para a chave do rascunho ---
            // Define o nome de guerra em MAI√öSCULAS para consist√™ncia.
            const userForDraft = (currentUserData.nome_guerra || 'ND').toUpperCase();
            
            // Constr√≥i a URL com o user padronizado (para leitura no app)
            const url = `conferencia_app.html?id=${listaId}&posto_grad=${encodeURIComponent(currentUserData.posto)}&quadro_mil=${encodeURIComponent(currentUserData.quadro)}&nome_guerra=${encodeURIComponent(userForDraft)}`;
            
            // Salva para resume
            localStorage.setItem('sigma_active_conf', JSON.stringify({
                id: listaId, 
                nomeLista: nomeLista, 
                user: userForDraft, // <-- CHAVE PADRONIZADA
                url: url
            }));
            verificarConferenciaAtiva();
            document.getElementById('modal-nova-conferencia').style.display = 'none';
            
            // --- L√ìGICA DE ABERTURA DO IFRAME (RE-INSERIDA) ---
            const container = document.getElementById('app-runner-container');
            const iframe = document.getElementById('app-iframe');
            iframe.src = url; 
            container.style.display = 'block';
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'SIGMA_FINISHED') {
                document.getElementById('app-runner-container').style.display = 'none';
                document.getElementById('app-iframe').src = "";
                
                localStorage.removeItem('sigma_active_conf');
    
                verificarConferenciaAtiva();

                loadCaaData();
                carregarConferenciasHoje();
                alert("Confer√™ncia salva!");
            }
        });
        
        // --- 5. HIST√ìRICOS ---
        async function carregarConferenciasHoje() {
            const ul = document.getElementById('today-list');
            ul.innerHTML = '<li>Carregando...</li>';
            try {
                const snap = await db.collection(COLECAO_RESULTADOS).where('conferente', '==', currentUserData.nome_militar_completo).limit(20).get();
                const hojeStr = new Date().toLocaleDateString('pt-BR');
                let docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
                
                let html = '';
                docs.forEach(d => {
                    const dt = d.timestamp.toDate();
                    if(dt.toLocaleDateString('pt-BR') === hojeStr) {
                        html += criarItemHistoricoHTML(d);
                    }
                });
                
                ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nenhuma confer√™ncia hoje.</li>';
            } catch(e){ 
                console.error(e); 
                ul.innerHTML = 'Erro.';
            }
        }

        async function loadMyHistory() {
    const ul = document.getElementById('my-history-list');
    ul.innerHTML = '<li>Buscando...</li>';
    
    // 1. Cria objetos Date dos campos de input, garantindo o in√≠cio e fim do dia
    const startDateInput = document.getElementById('my-hist-start').value;
    const endDateInput = document.getElementById('my-hist-end').value;

    if (!startDateInput || !endDateInput) {
        ul.innerHTML = '<li>Selecione as datas para filtrar.</li>';
        return;
    }

    // 2. Cria Timestamps para filtro do Firestore
    // dI: Come√ßo do dia (00:00:00)
    const dI = new Date(startDateInput + 'T00:00:00'); 
    // dF: Final do dia (23:59:59), adicionamos um segundo extra para garantir a inclus√£o
    const dF = new Date(endDateInput + 'T23:59:59'); 

    // Converte para Timestamps do Firebase
    const startTimestamp = firebase.firestore.Timestamp.fromDate(dI);
    const endTimestamp = firebase.firestore.Timestamp.fromDate(dF);

    try {
        // 3. Executa a consulta no Firestore com o filtro de data (query otimizada)
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('conferente', '==', currentUserData.nome_militar_completo)
            .where('timestamp', '>=', startTimestamp) // Data de in√≠cio
            .where('timestamp', '<=', endTimestamp)   // Data de fim
            .orderBy('timestamp', 'desc') // Ordena (necess√°rio ao usar where em timestamp)
            .limit(100)
            .get();
            
        let docs = [];
        snap.forEach(doc => docs.push(doc.data()));

        let html = '';
        docs.forEach(d => {
            html += criarItemHistoricoHTML(d);
        });
        
        ul.innerHTML = html || '<li style="padding:15px; text-align:center; color:#999;">Nada encontrado no per√≠odo selecionado.</li>';
        
    } catch(e){ 
        console.error("Erro no loadMyHistory:", e);
        ul.innerHTML='<li>Erro ao carregar hist√≥rico.</li>';
    }
}

    async function loadGlobalHistory() {
    const ul = document.getElementById('global-history-list');
    ul.innerHTML = '<li>Buscando...</li>';
    
    // Captura o valor dos filtros
    const dI = new Date(document.getElementById('glob-hist-start').value + 'T00:00:00');
    const dF = new Date(document.getElementById('glob-hist-end').value + 'T23:59:59');
    const localFilter = document.getElementById('glob-hist-local').value;
    const conferenteFilter = document.getElementById('glob-hist-user').value; // Valor do Conferente

    try {
        // 1. Inicia a consulta com os filtros de data (obrigat√≥rio para orderBy)
        let queryRef = db.collection(COLECAO_RESULTADOS)
            .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(dI))
            .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(dF))
            .orderBy('timestamp', 'desc');

        // 2. CORRE√á√ÉO: Aplica o filtro 'where' se um Conferente espec√≠fico for selecionado
        if (conferenteFilter) {
            queryRef = queryRef.where('conferente', '==', conferenteFilter);
        }

        const snap = await queryRef.limit(100).get();
        
        // Carrega o mapeamento de Unidades (necess√°rio para o filtro de Gestor)
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const listToUnitMap = {};
        Object.keys(rotas).forEach(key => listToUnitMap[rotas[key].nome] = rotas[key].unidade || 'GERAL');

        let docs = [];
        snap.forEach(d => docs.push(d.data()));

        let html = '';
        docs.forEach(d => {
            const localNome = d.local.split(' - ')[1] || d.local;
            const unit = listToUnitMap[localNome] || 'GERAL';

            // Filtro de seguran√ßa (Gestor)
            if(currentUserData.role === 'gestor' && unit !== currentUserData.unidade) return; 
            
            // Filtro Local: s√≥ aplica na mem√≥ria se for necess√°rio
            if(!localFilter || localNome === localFilter) {
                html += criarItemHistoricoHTML(d);
            }
        });

        ul.innerHTML = html || '<li>Nada encontrado.</li>';
    } catch(e){ 
        console.error("Erro ao carregar hist√≥rico global:", e);
        ul.innerHTML='Erro ao carregar hist√≥rico.';
    }
}
        function criarItemHistoricoHTML(data) {
            const dataHora = data.timestamp.toDate().toLocaleString('pt-BR');
            const temAlteracao = (data.itensRelatorio && data.itensRelatorio.some(i => i.status !== 'S/A')) || (!data.itensRelatorio && data.totalCaa > 0);
            
            return `<li class="history-item"><div class="hist-info"><strong>${data.local}</strong><small>${data.conferente} ‚Ä¢ ${dataHora}</small></div><div style="display:flex;align-items:center;"><span class="hist-status ${temAlteracao?'status-alert':'status-ok'}">${temAlteracao?'C/A':'S/A'}</span><button class="btn-reprint" onclick='reimprimirPDF(${JSON.stringify(data)})'><i class="fas fa-file-pdf"></i></button></div></li>`;
        }

        // --- 6. GEST√ÉO DE UNIDADES (ADMIN) ---
        async function carregarUnidadesVisuais() {
    const container = document.getElementById('units-cards-container');
    container.innerHTML = 'Carregando...';
    
    // --- Vari√°veis de Restri√ß√£o ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // -----------------------------
    
    try {
        const unitsDoc = await db.collection('config_geral').doc('unidades').get();
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const unidades = unitsDoc.data().lista || [];
        const rotas = rotasDoc.data() || {};

        container.innerHTML = '';
        unidades.forEach(u => {
            const listsInUnit = Object.values(rotas).filter(r => r.unidade === u).map(r => r.nome);
            const card = document.createElement('div');
            card.className = 'sector-card status-unit';
            card.innerHTML = `<h3>${u}</h3><div class="card-footer"><strong>Cont√©m:</strong><ul class="sub-list-preview">${listsInUnit.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
            card.onclick = () => abrirGestaoUnidade(u, rotas);
            container.appendChild(card);
        });

        // --- NOVO: FILTRAGEM DOS LOCAIS PARA O SELECT DO HIST√ìRICO GLOBAL ---
        const sel = document.getElementById('glob-hist-local');
        // Garante que o elemento existe e reseta com a op√ß√£o "Todos"
        if(sel) sel.innerHTML = '<option value="">Todos</option>'; 
        
        if(sel) {
            // 1. Mapeia todas as rotas (viaturas/listas) ativas
            let locaisFiltrados = Object.values(rotas)
                .filter(r => r.ativo !== false) 
                // 2. Aplica a restri√ß√£o: Se for gestor, s√≥ mostra as rotas da sua unidade.
                .filter(r => !isGestor || r.unidade === unidadeGestor) 
                .map(r => r.nome); 

            // 3. Remove duplicatas e ordena
            const locaisUnicos = [...new Set(locaisFiltrados)].sort();
            
            locaisUnicos.forEach(l => { 
                const o = document.createElement('option'); 
                o.value = l; 
                o.text = l; 
                sel.appendChild(o); 
            });
        }
    } catch(e){ 
        console.error("Erro ao carregar unidades visuais:", e);
        container.innerHTML='Erro ao carregar dados.';
    }
}
        function abrirGestaoUnidade(unitName, allRotas) {
            document.getElementById('edit-unit-original-name').value = unitName;
            document.getElementById('edit-unit-name-input').value = unitName;
            const checklist = document.getElementById('unit-lists-checklist');
            checklist.innerHTML = '';
            
            Object.entries(allRotas).forEach(([id, r]) => {
                if(r.ativo === false) return;
                const div = document.createElement('div');
                div.className = 'checklist-item';
                const isChecked = (r.unidade === unitName) ? 'checked' : '';
                
                div.innerHTML = `<input type="checkbox" id="chk-${id}" ${isChecked} value="${id}"> <label for="chk-${id}" style="margin:0;font-weight:normal;">${r.nome} (${r.posto})</label>`;
                checklist.appendChild(div);
            });
            document.getElementById('modal-unit-manager').style.display = 'flex';
        }

        async function salvarAlteracoesUnidade() {
            const oldName = document.getElementById('edit-unit-original-name').value;
            const newName = document.getElementById('edit-unit-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome inv√°lido");
            
            try {
                const unitsRef = db.collection('config_geral').doc('unidades');
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await unitsRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#unit-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    if (chk.checked) {
                        rotasData[id].unidade = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: newName });
                    } else if (rotasData[id].unidade === oldName) {
                        rotasData[id].unidade = null; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ unidade: null });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!"); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirUnidade() {
            const name = document.getElementById('edit-unit-original-name').value;
            if(!confirm(`Excluir a unidade ${name}? As listas perder√£o o v√≠nculo.`)) return;
            
            try {
                await db.collection('config_geral').doc('unidades').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                
                const rotasRef = db.collection('config_geral').doc('rotas');
                const s = await rotasRef.get(); 
                const d = s.data();
                
                Object.keys(d).forEach(k => { 
                    if(d[k].unidade === name) d[k].unidade = null; 
                });
                
                await rotasRef.set(d);
                alert("Exclu√≠do."); 
                document.getElementById('modal-unit-manager').style.display = 'none'; 
                carregarUnidadesVisuais();
            } catch(e){ 
                alert("Erro");
            }
        }

        // --- 6.5 GEST√ÉO DE POSTOS (NOVO!) ---
        async function carregarPostosVisuais() {
            const container = document.getElementById('postos-cards-container');
            if(!container) return;
            container.innerHTML = 'Carregando...';
            
            try {
                const postosDoc = await db.collection('config_geral').doc('postos').get();
                const rotasDoc = await db.collection('config_geral').doc('rotas').get();
                const postos = postosDoc.exists ? (postosDoc.data().lista || []) : [];
                const rotas = rotasDoc.data() || {};

                container.innerHTML = '';
                postos.sort().forEach(p => {
                    const listsInPosto = Object.values(rotas).filter(r => r.posto === p).map(r => r.nome);
                    const card = document.createElement('div');
                    card.className = 'sector-card status-posto';
                   
                    card.innerHTML = `<h3>${p}</h3><div class="card-footer"><strong>Cont√©m:</strong><ul class="sub-list-preview">${listsInPosto.map(l=>`<li>${l}</li>`).join('')}</ul></div>`;
                    card.onclick = () => abrirGestaoPosto(p, rotas);
                    container.appendChild(card);
                });
            } catch(e){ 
                container.innerHTML='Erro'; 
            }
        }

        function criarPosto() {
            const nome = document.getElementById('new-posto-name').value.trim().toUpperCase();
            if(!nome) return alert("Digite o nome.");
            
            db.collection('config_geral').doc('postos').set({ lista: firebase.firestore.FieldValue.arrayUnion(nome) }, { merge: true })
            .then(() => { 
                alert("Posto criado!"); 
                carregarPostosVisuais(); 
            })
            .catch(e => alert("Erro: " + e.message));
        }

       function abrirGestaoPosto(postoName, allRotas) {
    document.getElementById('edit-posto-original-name').value = postoName;
    document.getElementById('edit-posto-name-input').value = postoName;
    
    const checklist = document.getElementById('posto-lists-checklist');
    checklist.innerHTML = '';
    
    const previewContainer = document.getElementById('posto-preview-container'); 
    let listasAtualmenteVinculadas = [];
    
    // --- L√ìGICA DE PERMISS√ÉO ---
    const isGestor = currentUserData && currentUserData.role === 'gestor';
    const gestorUnidade = currentUserData ? currentUserData.unidade : null;
    
    Object.entries(allRotas).forEach(([id, r]) => {
        if(r.ativo === false) return;
        
        // 1. L√ìGICA DO PREVIEW: Coleta as listas j√° vinculadas
        const isChecked = (r.posto === postoName) ? 'checked' : '';
        if (isChecked) {
            // HTML NOVO: Nome da Lista em uma linha (com √≠cone) e Unidade em outra linha (<small display: block;>)
            listasAtualmenteVinculadas.push(`
                <span style="display: block; font-size: 0.9em; margin-bottom: 5px; line-height: 1.3;">
                    <div style="display: flex; align-items: center; font-weight: bold; color: #333;">
                        <i class="fas fa-arrow-right" style="font-size: 0.7em; margin-right: 8px; color: #800020;"></i>
                        ${r.nome}
                    </div>
                    <small style="display: block; margin-left: 20px; font-weight: normal; color: #555;">
                        Unidade: <strong style="color: #555;">${r.unidade || 'GERAL'}</strong>
                    </small>
                </span>
            `);
        }
        
        // 2. FILTRO DE VISIBILIDADE PARA A CHECKLIST
        const isMinhaUnidade = r.unidade === gestorUnidade;
        
        if (isGestor && !isMinhaUnidade) {
            return; 
        }
        
        // 3. RENDERIZA√á√ÉO DA CHECKLIST
        const div = document.createElement('div');
        div.className = 'checklist-item';
        
        div.innerHTML = `
            <input type="checkbox" id="chk-p-${id}" ${isChecked} value="${id}"> 
            <label for="chk-p-${id}" style="margin:0;font-weight:normal;">
                ${r.nome} </label>`;
        
        checklist.appendChild(div);
    });
    
    // 4. INJE√á√ÉO DO PREVIEW NO HTML
    if (listasAtualmenteVinculadas.length > 0) {
        previewContainer.innerHTML = `
            <p style="margin: 0 0 5px 0; font-weight: bold; color: #800020;">Listas Atualmente Vinculadas (${listasAtualmenteVinculadas.length}):</p>
            ${listasAtualmenteVinculadas.join('')}
        `;
    } else {
        previewContainer.innerHTML = '<p style="margin: 0; color: #d39e00;">Nenhuma lista vinculada a este posto no momento.</p>';
    }
    
    document.getElementById('modal-posto-manager').style.display = 'flex';
}
        async function salvarAlteracoesPosto() {
            const oldName = document.getElementById('edit-posto-original-name').value;
            const newName = document.getElementById('edit-posto-name-input').value.trim().toUpperCase();
            if(!newName) return alert("Nome inv√°lido");

            try {
                // 1. Atualizar lista de postos
                const postosRef = db.collection('config_geral').doc('postos');
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayRemove(oldName) });
                await postosRef.update({ lista: firebase.firestore.FieldValue.arrayUnion(newName) });
                
                // 2. Atualizar v√≠nculos das rotas
                const rotasRef = db.collection('config_geral').doc('rotas');
                const rotasSnap = await rotasRef.get();
                const rotasData = rotasSnap.data();
                const checkboxes = document.querySelectorAll('#posto-lists-checklist input[type="checkbox"]');
                
                checkboxes.forEach(chk => {
                    const id = chk.value;
                    // Simplifica√ß√£o: Checkbox marcado = define posto.
                    if (chk.checked) {
                        rotasData[id].posto = newName; 
                        db.collection(COLECAO_LISTAS).doc(id).update({ posto: newName });
                    }
                });
                
                await rotasRef.set(rotasData);
                alert("Atualizado!");
                document.getElementById('modal-posto-manager').style.display = 'none';
                carregarPostosVisuais();
            } catch(e) { 
                alert("Erro: " + e.message);
            }
        }

        async function excluirPosto() {
            const name = document.getElementById('edit-posto-original-name').value;
            if(!confirm(`Excluir o posto ${name}?`)) return;
            
            try {
                await db.collection('config_geral').doc('postos').update({ lista: firebase.firestore.FieldValue.arrayRemove(name) });
                alert("Exclu√≠do."); 
                document.getElementById('modal-posto-manager').style.display = 'none'; 
                carregarPostosVisuais();
            } catch(e){ 
                alert("Erro"); 
            }
        }

        // --- FUN√á√ïES DE FORMATA√á√ÉO DE TEXTO (NECESS√ÅRIAS PARA O PDF) ---

function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    // Adicionando a fun√ß√£o formatarDataSimples do outro arquivo
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('pt-BR');
}
// --- FUN√á√ïES DE L√ìGICA DE HIST√ìRICO (IMPORTADAS DO APP) ---
function formatarDataSimples(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('pt-BR');
}

/**
 * Concatena uma nova entrada no hist√≥rico de pend√™ncias/observa√ß√µes,
 * garantindo que a entrada anterior seja assinada antes da nova ser anexada.
 */
const montarHistoricoLinear = (obsAnterior, novoTexto, autorAnterior, dataAnterior) => {
    const separator = ' | + NOVA: ';
    
    // Este bloco lida com a adi√ß√£o a uma cadeia de observa√ß√µes
    if (obsAnterior.includes(separator)) {
        let partes = obsAnterior.split(separator);
        let ultimaParte = partes.pop(); 
        let resto = partes.join(separator); 
        // Assina a √∫ltima parte n√£o assinada (o texto puro)
        let ultimaAssinada = `"${ultimaParte}" (Por: ${autorAnterior} em ${dataAnterior})`;
        return `${resto}${separator}${ultimaAssinada}${separator}${novoTexto}`;
    } else if (obsAnterior.trim() !== '') { 
        // Este bloco √© ativado na primeira adi√ß√£o. Assina a primeira entrada e anexa a segunda.
        // A obsAnterior j√° deve estar formatada como texto puro, mas a salvamos para seguran√ßa.
        let primeiraAssinada = `"${obsAnterior}" (Por: ${autorAnterior} em ${dataAnterior})`;
        return `${primeiraAssinada}${separator}${novoTexto}`;
    } else {
        // Se a observa√ß√£o anterior estava vazia, apenas retorna a nova linha (que ser√° assinada por outra fun√ß√£o).
        return novoTexto;
    }
};
// ----------------------------------------------------
const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = [];
    
    // 1. FORMATA√á√ÉO DA RESPOSTA DO GESTOR (ADMIN)
    if (adminStatus) {
        // Armazenamos o Status e a Observa√ß√£o separados para facilitar a formata√ß√£o no HTML
        const gestorLinha = `[${adminStatus}] (Admin): ${adminObs}`; 
        linhas.push(gestorLinha);
    }
    
    const separator = ' | + NOVA: ';
    
    // 2. FORMATA√á√ÉO DAS OBSERVA√á√ïES DO CONFERENTE (LINEAR HISTORY)
    if (textoBruto.includes(separator)) {
        const partes = textoBruto.split(separator);
        partes.forEach(p => {
            p = p.trim();
            const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
            const match = p.match(regex);
            
            // Verifica se √© a A√á√ÉO GESTOR j√° salva no hist√≥rico.
            if (match && match[1].includes('[A√á√ÉO GESTOR:')) {
                return; 
            }

            // Se for observa√ß√£o de Conferente:
            if (match) {
                // Formato padr√£o: Por: NOME em DATA: "OBS"
                linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
            } else {
                // Se for texto simples (fallback, n√£o deve acontecer com o padr√£o atual)
                linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
            }
        });
    } else {
        const p = textoBruto.trim();
        const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; 
        const match = p.match(regex);

        // Verifica se √© uma A√á√ÉO GESTOR na primeira linha 
        if (match && match[1].includes('[A√á√ÉO GESTOR:')) {
            return; // J√° tratado na se√ß√£o 1
        }
        
        // Se for a primeira observa√ß√£o de Conferente:
        if (match) {
            linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
        } else {
            linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
        }
    }
    return linhas;
};

// Fun√ß√£o wrapper apenas para manter a consist√™ncia com o app (n√£o usada no PDF)
const gerarHtmlVisual = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
    const linhas = gerarLinhasFormatadas(textoBruto, autorAtual, dataAtual, adminStatus, adminObs);
    let html = '<ul class="lista-pendencias">';
    
    linhas.forEach(l => { 
        if (l.includes('(Admin):')) { 
            // Formato de entrada: [STATUS] (Admin): Observa√ß√£o do Gestor
            const [carimboStatus, obsText] = l.split(':');
            const statusText = carimboStatus.match(/\[(.*?)\]/)[1]; // Ex: "EM SOLU√á√ÉO"
            
            let icon = '';
            let statusColor = '#f57c00'; // Amarelo/Laranja padr√£o para Em Solu√ß√£o
            let obsColor = '#555';

            // Mapeamento dos √çcones e Cores
            switch(statusText.toUpperCase().trim()) {
                case 'SOLUCIONADO':
                case 'REMOVER':
                    icon = '‚úÖÔ∏è';
                    statusColor = '#1b8a3e'; // Verde
                    break;
                case 'CAUTELADO':
                    icon = 'üîÉ';
                    statusColor = '#0d47a1'; // Azul
                    break;
                case 'EM SOLU√á√ÉO':
                default:
                    icon = '‚ö†Ô∏è';
                    break;
            }
            
            // Formatado como: **Gestor** <span style="color: StatusColor;">‚ö†Ô∏è *Status*: </span> Observa√ß√£o
            html += `<li>
                        <span style="color: #d90f23;"><b>Gestor</b></span>:
                        <span style="color: ${statusColor}; font-style: italic;">
                            ${icon} ${statusText}
                        </span>
                        : ${obsText.trim()}
                    </li>`; 
        } else { 
            // Formato Conferente: ‚Ä¢ **Por [Usu√°rio + Data]:**
            // Quebra a linha: Carimbo ("Por: NOME em DATA") e o Resto (": "OBS")
            const [carimbo, ...resto] = l.split(':');
            
            // Aplica BOLD no Carimbo: "Por: NOME em DATA"
            const carimboBold = carimbo.replace('Por:', '**Por**');
            
            html += `<li class="linha-obs">‚Ä¢ ${carimboBold}:${resto.join(':')}</li>`;
        } 
    });
    
    html += '</ul>';
    return html;
};

// --- PDF GENERATOR (FUN√á√ÉO ATUALIZADA) ---
function reimprimirPDF(data) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const MARGIN = 14, PG_W = 210, LOGO_S = 15;

        // MANT√âM A L√ìGICA DE BUSCA DE IMAGEM DO DASHBOARD
        // Busca a imagem j√° carregada no DOM para desenhar no PDF
        const logoDraw = (domId, x) => { 
            // Utilizamos uma consulta que verifica se o src cont√©m o domId
            const el = document.querySelector(`img[src*="${domId}"]`);
            if(el) { 
                try{
                    const c=document.createElement('canvas');
                    c.width=160;
                    c.height=160;
                    c.getContext('2d').drawImage(el,0,0,160,160);
                    // Adiciona a imagem ao PDF
                    doc.addImage(c.toDataURL('image/png'),'PNG',x,10,LOGO_S,LOGO_S);
                }catch(e){
                    // Em caso de falha no canvas (como CORS), o processo continua
                    console.warn(`Falha ao desenhar imagem ${domId}`);
                } 
            } else {
                 console.warn(`Elemento img[src*="${domId}"] n√£o encontrado no DOM. O logo n√£o ser√° exibido.`);
            }
        };
        
        // --- CHAMADAS PARA DESENHAR AS LOGOS ---
        // 1. Logo CBM-RR (Esquerda)
        logoDraw('cbmrr.png', MARGIN);
        // 2. Logo SIGMA (Direita)
        logoDraw('logo_sigma.png', PG_W-MARGIN-LOGO_S);
        
        // CABE√áALHO
        doc.setFontSize(10);
        doc.setTextColor(51); 
        doc.setFont('helvetica','bold');
        doc.text('GOVERNO DE RORAIMA', PG_W/2, 15, {align:'center'}); 
        doc.setTextColor(217,15,35);
        doc.text('CORPO DE BOMBEIROS MILITAR DE RORAIMA', PG_W/2, 20, {align:'center'}); 
        doc.setTextColor(51); 
        doc.setFont('helvetica','italic');
        doc.text('"Amaz√¥nia: patrim√¥nio dos brasileiros"', PG_W/2, 25, {align:'center'});
        doc.setFontSize(14); 
        doc.setTextColor(0);
        doc.setFont('helvetica','bold'); 
        doc.text("RELAT√ìRIO DE CONFER√äNCIA", PG_W/2, 35, {align:'center'});

        // INFORMA√á√ïES DE BASE
        doc.setFillColor(240, 240, 240);
        doc.setDrawColor(200, 200, 200); 
        doc.roundedRect(MARGIN, 40, PG_W - (MARGIN*2), 25, 2, 2, 'FD');
        
        doc.setFontSize(10); 
        doc.setTextColor(50);
        let y = 46;
        const X_LABEL = MARGIN + 5; 
        const X_VAL = MARGIN + 30;
        
        const dataTimestamp = data.timestamp ?
        new Date(data.timestamp.seconds * 1000) : new Date();
        const dataHoraStr = dataTimestamp.toLocaleString('pt-BR');
        
        doc.setFont('helvetica','bold'); 
        doc.text('Local:', X_LABEL, y); 
        doc.setFont('helvetica','normal');
        doc.text(data.local || '', X_VAL, y); 
        y+=6; 
        doc.setFont('helvetica','bold'); 
        doc.text('Conferente:', X_LABEL, y); 
        doc.setFont('helvetica','normal'); 
        doc.text(data.conferente || '', X_VAL, y); 
        y+=6; 
        doc.setFont('helvetica','bold');
        doc.text('Data/Hora:', X_LABEL, y); 
        doc.setFont('helvetica','normal'); 
        doc.text(dataHoraStr, X_VAL, y); 
        
        // TOTALIZADOR
        doc.setFont('helvetica','bold');
        doc.setTextColor(128, 0, 32);
        doc.text(`TOTAL: ${data.totalItensConferidos || 0} | C/A: ${data.totalCaa || 0}`, PG_W - MARGIN - 5, 46, {align:'right'});

        // TABELA DE ITENS
        let tableBody = [];
        const RED_FILL = [217, 15, 35]; 
        const GREEN_FILL = [27, 138, 62]; 
        const SECTOR_BG = [60, 60, 60];
        let listaParaImprimir = [];
        
        if (data.itensRelatorio && data.itensRelatorio.length > 0) listaParaImprimir = data.itensRelatorio;
        else if (data.itensCaa && data.itensCaa.length > 0) listaParaImprimir = data.itensCaa;
        else tableBody.push([{ content: 'CONFER√äNCIA REALIZADA SEM ALTERA√á√ïES (REGISTRO LEGADO)', colSpan: 4, styles: { halign: 'center', fillColor: GREEN_FILL, textColor: 255, fontStyle: 'bold', cellPadding: 5 } }]);
        
        if (listaParaImprimir.length > 0) {
            let currentSector = null;
            listaParaImprimir.forEach(item => {
                // L√≥gica de Agrupamento por Setor
                let setorItem = item.setor || "ITENS GERAIS";
                if(setorItem !== currentSector) {
                    tableBody.push([{ content: setorItem.toUpperCase(), colSpan: 4, styles: { fillColor: SECTOR_BG, textColor: 255, fontStyle: 'bold', halign: 'left' } }]);
                    currentSector = setorItem;
                }

                // L√≥gica de Formata√ß√£o de Observa√ß√µes
                let finalObs = item.obs || '-';
                
                // ADICIONADO: Vari√°veis de contexto para a formata√ß√£o
                const dataConf = dataTimestamp.toLocaleDateString('pt-BR');
                const conf = data.conferente; 
                
                // 1. Usa a fun√ß√£o padr√£o para obter o array de linhas formatadas
                let linhasFormatadas = [];
                if (finalObs !== '-') {
                    linhasFormatadas = gerarLinhasFormatadas(
                        finalObs, 
                        conf, 
                        dataConf,
                        item.statusAdmin, 
                        item.adminObs
                    );
                }
                
                // 2. Transforma o array de linhas em uma string separada por quebra de linha
                // O prefixo '‚Ä¢' j√° est√° incluso na fun√ß√£o gerarLinhasFormatadas para observa√ß√µes.
                finalObs = linhasFormatadas.map(l => {
                    // Substitui o prefixo de admin (ex: "‚ö†Ô∏è [SOLUCIONADO] (Admin):") para um formato de relat√≥rio mais limpo
                    if(l.includes('(Admin):')) {
                        return l.replace('‚ö†Ô∏è ', 'RESPOSTA DA GEST√ÉO: ');
                    }
                    return l;
                }).join('\n');
                
                if (finalObs.trim() === '') finalObs = '-'; // Volta para '-' se ficar vazio.

                // FIM DA L√ìGICA DE FORMATA√á√ÉO DE OBSERVA√á√ïES
                
                let bgStatus = GREEN_FILL;
                if (item.status === 'C/A' || item.status === 'KEEP') bgStatus = RED_FILL;
                
                // Adiciona a linha √† tabela
                tableBody.push([ 
                    item.nomeCompleto || 'Item', 
                    { content: `QTD: ${item.quantidade || 1}`, styles: { halign: 'center', valign: 'middle' } }, 
                    { content: item.status || 'S/A', styles: { fillColor: bgStatus, textColor: 255, fontStyle: 'bold', halign: 'center', valign: 'middle' } }, 
                    { content: finalObs, styles: { halign: 'left', valign: 'middle' } } 
                ]);
            });
        }
        
        // Configura√ß√£o e Gera√ß√£o da Tabela
        doc.autoTable({ 
            startY: 70, 
            head: [['Item', 'Quantidade', 'Status', 'Observa√ß√£o']], 
            body: tableBody, 
            theme: 'striped', 
            styles: { fontSize: 8, valign: 'middle', textColor: 51, cellPadding: 1.5 }, 
            columnStyles: { 
                0:{cellWidth:80, halign:'left'}, 
                1:{cellWidth:20,halign:'center'}, 
                2:{cellWidth:20,halign:'center'}, 
                3:{cellWidth:'auto',halign:'left'} 
            }, 
            headStyles: { fillColor: [128, 0, 32], textColor: 255, fontStyle: 'bold', halign: 'center' } 
        });

        // Rodap√© com Pagina√ß√£o
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8); 
            doc.setTextColor(100);
            doc.text('SIGMA - Sistema Integrado de Gest√£o de Materiais', MARGIN, doc.internal.pageSize.height-10);
            doc.text(`P√°g. ${i} de ${totalPages}`, PG_W-MARGIN, doc.internal.pageSize.height-10, {align:'right'});
        }
        
        // Nome do Arquivo
        const nomeArquivo = `Relatorio_${(data.local||'Conf').replace(/[^a-zA-Z0-9]/g,'')}_${dataTimestamp.toISOString().split('T')[0]}.pdf`;
        doc.save(nomeArquivo);
        
    } catch(e) { 
        console.error(e);
        alert("Erro ao gerar PDF: " + e.message);
    }
}
        // --- OUTROS E FUN√á√ïES GLOBAIS (UI) ---
        
        function sairDoSistema() { 
            auth.signOut().then(() => { 
                sessionStorage.clear(); 
                window.location.href = 'index.html'; 
            });
        }
        function logout() {
            sairDoSistema();
        }
        
        function switchView(v) {
        // Esconde todas as se√ß√µes de visualiza√ß√£o
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
// Mostra a se√ß√£o desejada
    const viewElement = document.getElementById(`view-${v}`);
if (viewElement) {
        viewElement.style.display = 'block';
} else {
        console.error(`View n√£o encontrada: view-${v}`);
        return;
}
    
    // Remove a classe 'active' de todos os links e adiciona ao link clicado
    document.querySelectorAll('#main-sidebar a').forEach(el => el.classList.remove('active'));
const activeLink = document.getElementById(`link-${v}`);
    if (activeLink) {
        activeLink.classList.add('active');
}

    // --- A√á√ïES ESPEC√çFICAS POR VIEW ---
    if (v === 'unidades') {
        carregarUnidadesVisuais();
// Carrega os cards de Unidades/Rotas (Vis√£o Admin)
    }
    
    if (v === 'postos') {
        carregarPostosVisuais();
// Carrega os cards de Postos (Vis√£o Admin)
    }

    if (v === 'usuarios') {
        listarUsuarios();
// Carrega a tabela de usu√°rios (Vis√£o Admin/Gestor)
        carregarUnidadesSelect();
// Carrega o select de Unidades para o modal de cadastro/edi√ß√£o
        setupCadastroMilitarLogic();
    }
    
    if (v === 'listas') {
    // 1. Carrega os Postos de Servi√ßo (Dropdown 1)
    carregarPostosServicoSelect('novo-local-posto'); 
    
    // 2. Carrega as unidades e aplica a l√≥gica de Gestor (Dropdown 2)
    carregarUnidadesSelect('novo-local-unidade'); 
    
    // 3. Carrega a lista de locais existente (se existir)
    carregarListaLocaisAdmin(); 
}

    if(v === 'global-history') {
        // Inicializa o filtro de data (√∫ltimos 30 dias)
        document.getElementById('glob-hist-start').valueAsDate = new Date(new Date().setDate(new Date().getDate()-30));
        document.getElementById('glob-hist-end').valueAsDate = new Date();
        
        
        // Carrega as op√ß√µes de Local (Viatura) e Filtra por Unidade do Gestor
        carregarUnidadesVisuais();
        // NOVO: Carrega as op√ß√µes de Conferente (Usu√°rio) e Filtra por Unidade do Gestor
        carregarUsuariosFiltro();
        // Carrega o hist√≥rico com os filtros iniciais
        loadGlobalHistory();
    }

    if(v === 'my-history') {
        // 1. Calcular a data de 30 dias atr√°s
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 30); // Subtrai 30 dias
        document.getElementById('my-hist-start').valueAsDate = startDate;
        document.getElementById('my-hist-end').valueAsDate = endDate;
        loadMyHistory();
    }

    // === SOLU√á√ÉO: FECHA O MENU AP√ìS SELE√á√ÉO NO MOBILE ===
    if (window.innerWidth <= 768) {
        history.pushState(null, null, location.href);
        closeMenuMobile();
    }
    // ===================================================
}
        function toggleMenuMobile() { 
            const s = document.getElementById('main-sidebar');
            if(s.classList.contains('mobile-active')) { 
                s.classList.remove('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='none'; 
            } else { 
                s.classList.add('mobile-active'); 
                document.getElementById('mobile-overlay').style.display='block'; 
            } 
        }
        function closeMenuMobile() { 
    // Obt√©m o elemento sidebar
    const s = document.getElementById('main-sidebar');

    // Remove explicitamente a classe 'mobile-active' (fecha o menu),
    // independentemente do estado atual.
    if(s.classList.contains('mobile-active')) { 
        s.classList.remove('mobile-active'); 
        document.getElementById('mobile-overlay').style.display='none';
    } 
    // Remove a chamada a toggleMenuMobile()
}
        
        // --- FUN√á√ïES DO MODAL GEST√ÉO C/A ---
        function mostrarTabela(data) {
    const wrapper = document.getElementById('ca-table-wrapper'), tbody = document.getElementById('ca-list-body');
    document.getElementById('table-title').textContent = `Detalhes: ${data.local}`; 
    tbody.innerHTML = '';
    
    // Garante array
    const items = data.items || [];
    const itemsToShow = items.filter(i => i.statusAdmin !== 'Solucionado');
    
    if (itemsToShow.length === 0) { 
        wrapper.querySelector('table').style.display = 'none';
        document.getElementById('no-issues-msg').style.display = 'block';
    } else {
        wrapper.querySelector('table').style.display = 'table';
        document.getElementById('no-issues-msg').style.display = 'none';
        
        itemsToShow.forEach(i => {
            const tr = tbody.insertRow();
            
            // 1. Formata o hist√≥rico de observa√ß√µes usando a fun√ß√£o padronizada (HTML)
            const obsHtmlFormatada = gerarHtmlVisual(
                i.obs || '', 
                data.conferente, // Nome do conferente original (fallback)
                data.date, // Data da confer√™ncia original (fallback)
                i.statusAdmin, 
                i.adminObs
            );

            // 2. Define a classe do badge para o status de gest√£o
            const statusAdmin = i.statusAdmin || 'Pendente';
            // Garante que o status do Firebase (Ex: Em solu√ß√£o, Cautelado) seja min√∫sculo e com tra√ßo (Ex: em-solucao)
            const badgeClass = 'badge-' + statusAdmin.toLowerCase().replace(' ', '-');
            
            // INJE√á√ÉO DO DOC_ID DO PAI NO ITEM FILHO
            const itemComDocId = { ...i, docId: data.docId }; 
            
            tr.innerHTML = `
                <td><strong>${i.nomeCompleto}</strong></td>
                <td><span class="status-badge ${badgeClass}">${statusAdmin}</span></td>
                <td>${obsHtmlFormatada}</td>
                <td><small>${data.conferente}<br>${data.date}</small></td>
            `;
            
            const td = tr.insertCell(); 
            // Passa o item enriquecido para o modal de gest√£o
            td.innerHTML = `<button class="btn-modern-action btn-create" onclick='abrirModalGestao(${JSON.stringify(itemComDocId)})'>Gerenciar</button>`;
        });
    }
    wrapper.style.display = 'block';
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
        function fecharTabela(){ 
            document.getElementById('ca-table-wrapper').style.display='none';
        }
        
        function abrirModalGestao(i){
            document.getElementById('gestao-item-nome').textContent = i.nomeCompleto;
            document.getElementById('gestao-doc-id').value = i.docId; 
            document.getElementById('gestao-item-index').value = i.originalIndex;
            document.getElementById('gestao-item-id-lista').value = i.id; 
            document.getElementById('gestao-item-max-qtd').value = i.quantidade || 1;
            
            document.getElementById('gestao-status').value = i.statusAdmin || 'Solucionado';
            document.getElementById('gestao-obs').value = '';
            document.getElementById('gestao-qtd').value = '1';
            toggleGestaoQtd();

            document.getElementById('modal-gestao-ca').style.display = 'flex';
        }

        function fecharModalGestao(){ 
            document.getElementById('modal-gestao-ca').style.display='none';
        }

        function toggleGestaoQtd(){
            const isRemover = document.getElementById('gestao-status').value === 'Remover';
            document.getElementById('div-gestao-qtd').style.display = isRemover ? 'block' : 'none';
            if(isRemover) {
                const max = document.getElementById('gestao-item-max-qtd').value;
                document.getElementById('gestao-qtd').max = max;
                document.getElementById('gestao-qtd-info').textContent = `Estoque atual: ${max}`;
            }
        }

        document.getElementById('gestao-status').onchange = toggleGestaoQtd;
        
        async function salvarGestaoCa(){
    // [1] RECUPERA√á√ÉO DE DADOS DO MODAL
    const docId = document.getElementById('gestao-doc-id').value;
    const itemId = document.getElementById('gestao-item-id-lista').value;
    const status = document.getElementById('gestao-status').value;
    const obsRaw = document.getElementById('gestao-obs').value.trim();
    const qtdRemover = parseInt(document.getElementById('gestao-qtd').value);
    
    // [2] VALIDA√á√ÉO B√ÅSICA
    if(!obsRaw) return alert("Digite uma observa√ß√£o.");

    try {
        // [3] RECUPERA√á√ÉO DE METADADOS DO GESTOR E DATA/HORA
        const nomeGestor = `${currentUserData.posto} ${currentUserData.quadro} ${currentUserData.nome_guerra}`;
        const dataHoraStr = new Date().toLocaleString('pt-BR');
        
        // Texto que ser√° carimbado na linha do HIST√ìRICO (item.obs)
        const carimboTextoHistorico = `[A√á√ÉO GESTOR: ${status.toUpperCase()}] ${obsRaw}` + 
                                    (status === 'Remover' ? ` (Removido ${qtdRemover} do estoque)` : '');

        // A linha completa a ser adicionada no hist√≥rico linear (formato padronizado)
        const novaLinhaObs = `"${carimboTextoHistorico}" (Por: ${nomeGestor} em ${dataHoraStr})`;
        
        // Texto para exibi√ß√£o no campo adminObs (apenas o raw)
        const obsFinalDisplay = obsRaw; 


        // [4] BUSCA DO DOCUMENTO PAI NO FIREBASE
        const ref = db.collection(COLECAO_RESULTADOS).doc(docId);
        const snap = await ref.get();
        if(!snap.exists) return alert("Erro: Confer√™ncia n√£o encontrada.");
        
        const resData = snap.data();
        const items = resData.itensCaa || [];
        
        // [5] BUSCA INTELIGENTE DO ITEM (Pelo ID)
        let targetIndex = -1;
        targetIndex = items.findIndex(i => i.id === itemId);
        
        if (targetIndex === -1) {
            const nomeAlvo = document.getElementById('gestao-item-nome').textContent;
            targetIndex = items.findIndex(i => i.nomeCompleto === nomeAlvo);
        }

        if (targetIndex === -1) return alert("Erro: Item n√£o encontrado na lista de pend√™ncias. Algu√©m pode ter modificado antes.");
        
        // [6] ATUALIZA√á√ÉO DOS CAMPOS DO ITEM
        const itemParaAtualizar = items[targetIndex];

        // *** CORRE√á√ÉO CRUCIAL 1: Atualiza o campo de hist√≥rico linear (item.obs) no resultados_conferencias ***
        let obsAtualizada = itemParaAtualizar.obs || '';
        if (obsAtualizada.trim() !== '') {
            obsAtualizada += ' | + NOVA: ';
        }
        obsAtualizada += novaLinhaObs;
        itemParaAtualizar.obs = obsAtualizada; // SALVA A NOVA LINHA NO HIST√ìRICO LINEAR

        // Atualiza campos espec√≠ficos do Administrador (para uso no Dashboard)
        itemParaAtualizar.statusAdmin = (status === 'Remover' ? 'Solucionado' : status);¬†
        itemParaAtualizar.adminObs = obsFinalDisplay; 
        
        
        // [7] SALVA AS MUDAN√áAS NO FIREBASE
        await ref.update({ itensCaa: items });
        
        
        // [8] ATUALIZA√á√ÉO NA LISTA MESTRE (L√ìGICA DO ESTOQUE E PERSIST√äNCIA DO CARIMBO)
        
        const listaId = resData.lista_id;
        if(listaId) {
            const listRef = db.collection(COLECAO_LISTAS).doc(listaId);
            const listSnap = await listRef.get();
            let updated = false;

            if(listSnap.exists) {
                let listaData = listSnap.data().list;
                
                const updateItemInMasterList = (item, isTombamento = false) => {
                    const isSolved = (status === 'Remover' || status === 'Solucionado');
                    const isManaged = (status === 'Em solu√ß√£o' || status === 'Cautelado');
                    
                    if (isSolved) {
                        // L√ìGICA DE SOLU√á√ÉO (Remove do estoque ou deleta pend√™ncia)
                        if (status === 'Remover') {
                            if (!isTombamento) item.quantidadeEsperada -= qtdRemover;
                            else item.tombamentos.splice(item.tombamentos.findIndex(t => t.tomb === itemId.split('-')[1]), 1);
                            
                            if (item.quantidadeEsperada <= 0 || isTombamento) { 
                                // O Splicing do tombamento foi feito na linha acima. 
                                // O splicing do item completo precisa de l√≥gica mais complexa, mas vamos manter o delete pendencia aqui.
                            }
                        }
                        
                        // Atualiza o hist√≥rico na lista Mestra antes de deletar a pend√™ncia
                        if(item.pendencia && item.pendencia.obs) item.pendencia.obs = obsAtualizada;
                        delete item.pendencia;
                        updated = true;
                        
                    } else if (isManaged) {
                        // L√ìGICA DE GEST√ÉO (ATUALIZA APENAS O CAMPO OBS PARA PERSIST√äNCIA)
                        if (item.pendencia) {
                            item.pendencia.obs = obsAtualizada; // Injeta o hist√≥rico completo na lista mestra
                            // item.pendencia.statusAdmin e adminObs N√ÉO S√ÉO SALVOS AQUI.
                            updated = true;
                        }
                    }
                    return updated;
                };

                for(let s of listaData) {
                    for(let i = s.itens.length - 1; i >= 0; i--) {
                        const item = s.itens[i];
                        if(item.tipo === 'single' && item.id === itemId) {
                            updateItemInMasterList(item);
                        }
                        else if(item.tipo === 'multi' && item.tombamentos) {
                            const tIndex = item.tombamentos.findIndex(t => `${item.id}-${t.tomb}` === itemId);
                            if(tIndex > -1) {
                                updateItemInMasterList(item.tombamentos[tIndex], true);
                            }
                        }
                    }
                }
                
                if(updated) await listRef.update({ list: listaData });
            }
        }

        // [9] FINALIZA√á√ÉO
        alert("Salvo com sucesso!");
        fecharModalGestao();
        fecharTabela();
        loadCaaData();¬†
    } catch(e) {¬†
        console.error(e);¬†
        alert("Erro ao salvar: " + e.message);
    }
}
        // --- FUN√á√ïES DE EDITOR (MOVIDAS PARA O ESCOPO GLOBAL) ---
        function abrirEditor(id, nome, unidadeLista) { 
    
    // --- NOVA VERIFICA√á√ÉO DE PERMISS√ÉO DE UNIDADE ---
    // Verifica se o usu√°rio √© um Gestor E se a Unidade da Lista 
    // √© diferente da Unidade do usu√°rio logado.
    if (currentUserData.role === 'gestor' && unidadeLista !== currentUserData.unidade) {
        alert("Acesso negado. Voc√™ s√≥ pode editar listas da sua unidade.");
        return; // Impede que o editor seja aberto
    }
    // --------------------------------------------------

    currentEditingId = id;
    const editorTitleEl = document.getElementById('editor-title');
    if(editorTitleEl) {
        editorTitleEl.textContent = `Editando: ${nome}`; 
    }
    
    switchView('editor'); 
    carregarDadosGerenciador(); 
}
        function voltarParaLocais() { 
            currentEditingId = null;
            switchView('listas'); 
        }
        
        async function carregarDadosGerenciador(){ 
            if(!currentEditingId) return;
            try{ 
                document.getElementById('loading-message-admin').style.display = 'block';
                document.getElementById('main-admin-content').style.display = 'none';
                const d=await db.collection(COLECAO_LISTAS).doc(currentEditingId).get(); 
                dadosConferencia=d.exists?(d.data().list||[]):[]; 
                renderizarLista(); 
                document.getElementById('loading-message-admin').style.display = 'none';
                document.getElementById('main-admin-content').style.display = 'block';
            }catch(e){
                console.error(e);
                alert("Erro ao carregar lista.");
            } 
        }
        async function salvarDados(a=true){ 
            if(!currentEditingId) return;
            try{ 
                await db.collection(COLECAO_LISTAS).doc(currentEditingId).update({ list:dadosConferencia, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }); 
                if(a)alert("Salvo!"); 
            }catch(e){
                alert("Erro ao salvar");
            } 
        }
        function gerarNovoId(){ 
            return Date.now().toString().slice(-6)+Math.floor(Math.random()*100).toString().padStart(2,'0');
        }
        function adicionarSetor(n){ 
            n=n.trim().toUpperCase(); 
            if(!n)return; 
            dadosConferencia.push({id:gerarNovoId(), nome:n, itens:[]}); 
            document.getElementById('input-setor-nome').value=''; 
            salvarDados(false); 
            renderizarLista();
        }
        function removerSetor(id){ 
            if(confirm("Remover setor?")) { 
                dadosConferencia=dadosConferencia.filter(x=>x.id!==id); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        
        // ATEN√á√ÉO: Esta √© a fun√ß√£o que voc√™ deve modificar no sigma_dashboard.html
        function adicionarItemPorSetor(sid) { 
            const n = document.getElementById('input-item-nome-'+sid).value.trim().toUpperCase();
            const q = parseInt(document.getElementById('input-item-qtd-'+sid).value); 
            const t = document.getElementById('select-item-tipo-'+sid).value; 
            
            if(!n || q < 1) return;
            
            // 1. CAPTURAR O SCROLL POSITION ANTES DA RECONSTRU√á√ÉO DO DOM
            // O elemento que rola √© o pai da lista de setores, ou o cont√™iner principal do editor.
            const scrollContainer = document.querySelector('.admin-container'); 
            let scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            const s = dadosConferencia.find(x => x.id === sid);
            const novo = {id: sid+'-'+gerarNovoId(), nome: n, quantidadeEsperada: q, tipo: t, tombamentos:[]};
            
            if(t === 'multi') for(let i = 0; i < q; i++) novo.tombamentos.push({tomb: 'NOVO-' + (i+1), status: 'pending', obs: ''}); 
            
            s.itens.push(novo);
            
            // OTIMIZA√á√ÉO: Limpar o campo de nome
            document.getElementById('input-item-nome-'+sid).value = '';

            salvarDados(false);
            
            // 2. RECONSTRUIR A LISTA
            renderizarLista(); 

            // 3. RESTAURAR O SCROLL POSITION AP√ìS A RECONSTRU√á√ÉO
            if (scrollContainer && scrollTop > 0) {
                // Usamos um pequeno timeout para garantir que o DOM foi totalmente renderizado
                setTimeout(() => {
                    scrollContainer.scrollTop = scrollTop;
                }, 50);
            }
        }
        function removerItem(sid,iid){ 
            if(confirm("Remover item?")){ 
                const s=dadosConferencia.find(x=>x.id===sid); 
                s.itens=s.itens.filter(i=>i.id!==iid); 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function encontrarItemPorId(id) { 
            for (const setor of dadosConferencia) { 
                const item = setor.itens.find(i => i.id === id);
                if (item) return item; 
            } 
            return null; 
        }
        function adicionarTombamento(itemId, inputElement) { 
            const tombamento = inputElement.value.trim().toUpperCase();
            if (!tombamento) return; 
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                if (item.tombamentos.some(t => t.tomb === tombamento)) return alert("Duplicado!");
                item.tombamentos.push({ tomb: tombamento, status: "pending", obs: "" }); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function removerTombamento(itemId, tombamento) { 
            if (!confirm("Remover tombamento?")) return;
            const item = encontrarItemPorId(itemId); 
            if (item) { 
                item.tombamentos = item.tombamentos.filter(t => t.tomb !== tombamento); 
                item.quantidadeEsperada = item.tombamentos.length; 
                salvarDados(false); 
                renderizarLista();
            } 
        }
        function editarTombamento(itemId, tombamentoAtual, inputElement) { 
            const novoTombamento = inputElement.value.trim().toUpperCase();
            if (!novoTombamento || novoTombamento === tombamentoAtual) return; 
            const item = encontrarItemPorId(itemId);
            if (item) { 
                const tomb = item.tombamentos.find(t => t.tomb === tombamentoAtual); 
                if (tomb) { 
                    tomb.tomb = novoTombamento; 
                    salvarDados(false);
                } 
            } 
        }
        function updateOrdens() { 
            const novosDados = [];
            document.querySelectorAll('.setor-item').forEach(sNode => { 
                const sId = sNode.getAttribute('data-id'); 
                const sOriginal = dadosConferencia.find(x => x.id === sId); 
                const novosItens = []; 
                sNode.querySelectorAll('.item-conferencia-admin').forEach(iNode => { 
                    const iId = iNode.querySelector('.btn-edit-alt').getAttribute('onclick').split("'")[3]; 
                    const itemObj = encontrarItemPorId(iId); 
                    if(itemObj) novosItens.push(itemObj); 
                }); 
                sOriginal.itens = novosItens; 
                novosDados.push(sOriginal); 
            });
            dadosConferencia = novosDados; 
        }
        function abrirModalEdicao(sid, iid){ 
            const s=dadosConferencia.find(x=>x.id===sid); 
            const i=s.itens.find(x=>x.id===iid); 
            document.getElementById('edit-setor-id').value=sid; 
            document.getElementById('edit-item-original-id').value=iid;
            document.getElementById('edit-item-nome').value=i.nome; 
            document.getElementById('edit-item-qtd').value=i.quantidadeEsperada; 
            document.getElementById('edit-item-qtd').disabled=(i.tipo==='multi'); 
            document.getElementById('edit-item-tipo').value=i.tipo; 
            const sl=document.getElementById('edit-item-setor'); 
            sl.innerHTML=''; 
            dadosConferencia.forEach(d=>{
                const o=document.createElement('option'); 
                o.value=d.id; 
                o.text=d.nome; 
                if(d.id===sid)o.selected=true; 
                sl.appendChild(o);
            }); 
            document.getElementById('modal-edicao').style.display='flex';
        }
        function salvarEdicaoItem(){ 
            const osid=document.getElementById('edit-setor-id').value; 
            const iid=document.getElementById('edit-item-original-id').value; 
            const n=document.getElementById('edit-item-nome').value.trim().toUpperCase(); 
            const nsid=document.getElementById('edit-item-setor').value; 
            const q=parseInt(document.getElementById('edit-item-qtd').value);
            
            const os=dadosConferencia.find(x=>x.id===osid); 
            const ns=dadosConferencia.find(x=>x.id===nsid); 
            const i=os.itens.find(x=>x.id===iid); 
            i.nome=n; 
            if(i.tipo==='single')i.quantidadeEsperada=q; 
            
            if(osid!==nsid){ 
                os.itens=os.itens.filter(x=>x.id!==iid); 
                i.id=nsid+'-'+gerarNovoId(); 
                ns.itens.push(i); 
            } 
            salvarDados(false); 
            renderizarLista(); 
            fecharModal();
        }
        function fecharModal(){
            document.getElementById('modal-edicao').style.display='none';
        }
        function fazerBackupLocal(){ 
            const b=new Blob([JSON.stringify(dadosConferencia,null,2)],{type:"application/json"});
            const u=URL.createObjectURL(b); 
            const a=document.createElement('a'); 
            a.href=u; 
            a.download='backup.json'; 
            a.click(); 
        }
        function importarBackupLocal(e){ 
            const f=e.target.files[0]; 
            if(!f)return;
            const r=new FileReader(); 
            r.onload=function(ev){
                if(confirm("Substituir?")){
                    try{
                        dadosConferencia=JSON.parse(ev.target.result);
                        salvarDados();
                        renderizarLista();
                    }catch(err){
                        alert("Erro JSON");
                    }
                }
            }; 
            r.readAsText(f); 
        }
        function carregarCategoriasLista(elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;

    // Categorias que o administrador pode criar itens
    const categorias = [
        'POSTO DE SERVI√áO', // A categoria que voc√™ mencionou
        'SETOR', 
        'VIATURAS',
        // Adicione outras categorias que voc√™ permite editar
    ];

    select.innerHTML = '<option value="" disabled selected>Selecione a Categoria</option>';
    categorias.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        select.appendChild(option);
    });
}

        
        async function criarUsuario() {
    const email = document.getElementById('new-user-email').value.trim();
    const guerra = document.getElementById('new-user-guerra').value.trim().toUpperCase();
    const posto = document.getElementById('new-user-posto').value;
    const quadro = document.getElementById('new-user-quadro').value; // Novo Campo
    const completo = document.getElementById('new-user-completo').value.trim().toUpperCase(); // Nome Civil Completo
    const role = document.getElementById('new-user-role').value;
    const unit = document.getElementById('new-user-unit').value;
    
    // NOVOS CAMPOS DE IDENTIFICA√á√ÉO E CONTATO (LIMPOS)
    const cpfRaw = document.getElementById('new-user-cpf').value.replace(/\D/g, '');
    const matriculaRaw = document.getElementById('new-user-matricula').value.replace(/\D/g, '');
    const telefoneRaw = document.getElementById('new-user-telefone').value.replace(/\D/g, '');

    if (!email || !guerra || !posto || !quadro || !unit || !completo || !cpfRaw || !telefoneRaw) {
        return alert("Preencha todos os campos obrigat√≥rios: Email, Nome Guerra, Posto/Quadro, Nome Completo, CPF, Telefone e Unidade.");
    }
    
    // --- C√ÅLCULO DAS VARI√ÅVEIS AUXILIARES ---
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    // Novo Link WhatsApp (Formato web.whatsapp.com)
    const whatsappUrl = `https://web.whatsapp.com/send?phone=55${telefoneRaw}`;

    try {
        await db.collection('usuarios').add({ 
            email: email, 
            nome_guerra: guerra, 
            posto: posto,
            quadro: quadro,
            nome_completo: completo,
            nome_militar_completo: nomeMilitarCompleto, // Nome de Exibi√ß√£o
            telefone_contato: document.getElementById('new-user-telefone').value, // Salva o telefone FORMATADO
            whatsapp_url: whatsappUrl, // Link WhatsApp atualizado
            cpf: cpfRaw,
            matricula: matriculaRaw,
            
            role: role, 
            unidade: unit 
        });
        alert("Usu√°rio registrado! (Lembre-se de criar o login no Firebase Authentication)"); 
        
        // Limpar os campos ap√≥s o cadastro
        document.getElementById('new-user-email').value = '';
        document.getElementById('new-user-guerra').value = '';
        document.getElementById('new-user-completo').value = '';
        document.getElementById('new-user-cpf').value = '';
        document.getElementById('new-user-matricula').value = '';
        document.getElementById('new-user-telefone').value = '';
        document.getElementById('new-user-posto').value = ''; // Limpa o select
        document.getElementById('new-user-quadro').value = ''; // Limpa o select
        
        listarUsuarios();
    } catch(e) { 
        alert("Erro ao salvar usu√°rio: " + e.message);
    }
}

        async function listarUsuarios() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
    
    // --- NOVO: FILTRO DE UNIDADE PARA O GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    
    let userQuery = db.collection('usuarios'); // Cole√ß√£o correta
    
    if (isGestor) {
        // Se for Gestor, filtre a query para buscar usu√°rios APENAS na sua unidade
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }
    // ---------------------------------------------

    try {
        // Executa a query (filtrada ou total)
        const snap = await userQuery.get();
        
        // 1. POPULA A VARI√ÅVEL GLOBAL allUsersData
        allUsersData = [];
        snap.forEach(doc => {
            // Salva o ID do documento junto com os dados para uso no modal e filtro
            allUsersData.push({ id: doc.id, ...doc.data() }); 
        });
        
        // 2. VERIFICA SE H√Å DADOS
        if (allUsersData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Nenhum militar encontrado nesta unidade.</td></tr>';
            return;
        }

        // 3. INICIA A RENDERIZA√á√ÉO/FILTRAGEM
        // Chama a fun√ß√£o de filtragem (que faz a renderiza√ß√£o real)
        filtrarUsuarios();
        
    } catch(e) {
        console.error("Erro ao listar usu√°rios:", e);
        tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar lista de usu√°rios.</td></tr>';
    }
}
        
        async function abrirGestaoUsuario(docId) {
    try {
        const doc = await db.collection('usuarios').doc(docId).get();
        if (!doc.exists) return alert("Usu√°rio n√£o encontrado.");
        
        const u = doc.data();
        const permissoes = u.permissoes || {};
        
        // Preenche o campo de unidades
        await carregarUnidadesSelect('edit-user-unit');
        
        document.getElementById('edit-user-doc-id').value = docId;
        document.getElementById('edit-user-guerra').value = u.nome_guerra || '';
        document.getElementById('edit-user-posto').value = u.posto || ''; // Preenche o Posto
        document.getElementById('edit-user-completo').value = u.nome_completo || ''; 
        document.getElementById('edit-user-email').value = u.email || 'N/D';
        document.getElementById('edit-user-role').value = u.role || 'operacional';
        document.getElementById('edit-user-unit').value = u.unidade || '';

        // Campos de Identifica√ß√£o Pessoal
        document.getElementById('edit-user-cpf').value = u.cpf || '';
        document.getElementById('edit-user-matricula').value = u.matricula || '';
        document.getElementById('edit-user-telefone').value = u.telefone_contato || '';
        
        // Campo Quadro √© tratado abaixo, mas guarda o valor para pr√©-sele√ß√£o
        const quadroSalvo = u.quadro || ''; 

        // CAMPO NOME DE EXIBI√á√ÉO (SINT√âTICO - SOMENTE LEITURA)
        document.getElementById('edit-user-display-name').value = u.nome_militar_completo || 'N/D';

        // --- INTEGRA√á√ÉO DA L√ìGICA DE SELE√á√ÉO (NOVO BLOCO) ---
        
        // 1. Anexa o Listener de Mudan√ßa ao Posto/Gradua√ß√£o
        const postoSelect = document.getElementById('edit-user-posto');
        postoSelect.onchange = atualizarQuadroModal; // Chama a fun√ß√£o de depend√™ncia

        // 2. Dispara a l√≥gica uma vez para carregar as op√ß√µes de Quadro
        // Isso preencher√° o #edit-user-quadro com as op√ß√µes corretas para o posto salvo.
        atualizarQuadroModal();

        // 3. Pr√©-seleciona o Quadro salvo (s√≥ funciona ap√≥s a chamada acima)
        document.getElementById('edit-user-quadro').value = quadroSalvo;

        // --- L√ìGICA DE PERMISS√ïES (Mantida) ---
        const roleSelect = document.getElementById('edit-user-role');
        const permFields = document.getElementById('user-permissions-fields');
        
        permFields.style.display = (u.role === 'gestor' || u.role === 'admin') ? 'block' : 'none';
        
        document.getElementById('perm-view-cards').checked = permissoes.canViewDashboardCards || false;
        document.getElementById('perm-view-history').checked = permissoes.canViewUnitHistory || false;
        document.getElementById('perm-manage-posts').checked = permissoes.canManagePosts || false;
        document.getElementById('perm-manage-users').checked = permissoes.canManageUnitUsers || false;
        document.getElementById('perm-manage-lists').checked = permissoes.canManageUnitLists || false;

        roleSelect.onchange = function() {
            permFields.style.display = (this.value === 'gestor' || this.value === 'admin') ? 'block' : 'none';
        };

        document.getElementById('modal-user-manager').style.display = 'flex';
    } catch(e) {
        console.error(e);
        alert("Erro ao abrir edi√ß√£o: " + e.message);
    }
}
        
        async function salvarAlteracoesUsuario() {
    const docId = document.getElementById('edit-user-doc-id').value;
    const guerra = document.getElementById('edit-user-guerra').value.trim();
    const posto = document.getElementById('edit-user-posto').value.trim();
    const quadro = document.getElementById('edit-user-quadro').value.trim(); // Lendo do novo SELECT edit√°vel
    const completo = document.getElementById('edit-user-completo').value.trim(); 
    const role = document.getElementById('edit-user-role').value;
    const unit = document.getElementById('edit-user-unit').value;
    
    // CAMPOS DE IDENTIFICA√á√ÉO AGORA EDIT√ÅVEIS
    const cpf = document.getElementById('edit-user-cpf').value.trim();
    const matricula = document.getElementById('edit-user-matricula').value.trim();
    const telefone = document.getElementById('edit-user-telefone').value.trim();

    if (!guerra || !posto || !quadro || !unit || !completo) return alert("Preencha Nome de Guerra, Posto, Quadro, Unidade e Nome Civil Completo.");
    if (posto === "" || quadro === "") return alert("Selecione o Posto/Gradua√ß√£o e o Quadro.");

    // --- RECALCULA√á√ÉO DA VARI√ÅVEL SINT√âTICA (NOME DE EXIBI√á√ÉO) ---
    const nomeMilitarCompleto = `${posto} ${quadro} ${guerra}`;
    
    // --- L√ìGICA DE SALVAMENTO DE PERMISS√ïES (Mantida) ---
    const novasPermissoes = {
        canViewDashboardCards: document.getElementById('perm-view-cards').checked,
        canViewUnitHistory: document.getElementById('perm-view-history').checked,
        canManagePosts: document.getElementById('perm-manage-posts').checked,
        canManageUnitUsers: document.getElementById('perm-manage-users').checked,
        canManageUnitLists: document.getElementById('perm-manage-lists').checked,
    };
    
    // O objeto de atualiza√ß√£o
    const updateData = {
        nome_guerra: guerra,
        posto: posto,
        quadro: quadro,                         
        nome_militar_completo: nomeMilitarCompleto, 
        nome_completo: completo,             
        
        cpf: cpf,
        matricula: matricula,
        telefone_contato: telefone,
        whatsapp_url: `https://web.whatsapp.com/send?phone=55${telefone.replace(/\D/g, '')}`,
        
        role: role,
        unidade: unit,
        permissoes: novasPermissoes,
    };
    
    try {
        await db.collection('usuarios').doc(docId).update(updateData);
        alert("Dados do militar atualizados com sucesso!");
        document.getElementById('modal-user-manager').style.display = 'none';
        listarUsuarios();
    } catch(e) {
        alert("Erro ao salvar altera√ß√µes: " + e.message);
    }
}
        async function carregarUsuariosFiltro() {
    const select = document.getElementById('glob-hist-user');
    if (!select) return;

    select.innerHTML = '<option value="">Todos</option>';
    
    // Filtro de seguran√ßa: Gestor s√≥ v√™ usu√°rios da pr√≥pria unidade. Admin v√™ todos.
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;

    let userQuery = db.collection('usuarios');
    
    if (isGestor) {
        userQuery = userQuery.where('unidade', '==', unidadeGestor);
    }

    try {
        const snap = await userQuery.get();
        let users = [];
        snap.forEach(doc => {
            const u = doc.data();
            // Usamos o nome completo, pois √© o que est√° salvo nos resultados (linha 1082)
            if (u.nome_militar_completo) {
                users.push(u.nome_militar_completo);
            }
        });

        users.sort().forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

    } catch (e) {
        console.error("Erro ao carregar filtro de usu√°rios:", e);
    }
}

        async function excluirUsuario() {
            const docId = document.getElementById('edit-user-doc-id').value;
            const guerra = document.getElementById('edit-user-guerra').value;

            if(!confirm(`Tem certeza que deseja EXCLUIR o militar ${guerra}? O login associado (Auth) DEVE ser removido manualmente.`)) return;
            
            try {
                await db.collection('usuarios').doc(docId).delete();
                alert(`Militar ${guerra} exclu√≠do com sucesso do Firestore!`);
                document.getElementById('modal-user-manager').style.display = 'none';
                listarUsuarios();
            } catch(e) {
                alert("Erro ao excluir: " + e.message);
            }
        }

        async function carregarPostosEditor() {
             const sel = document.getElementById('novo-local-posto');
             if(!sel) return;
             
             try {
                const doc = await db.collection('config_geral').doc('postos').get();
                const lista = doc.exists ? doc.data().lista : [];
                let h = ''; 
                lista.forEach(p => h+=`<option value="${p}">${p}</option>`); 
                sel.innerHTML = h;
             } catch(e){}
        }

        async function criarNovoLocal() {
            const posto = document.getElementById('novo-local-posto').value;
            const nome = document.getElementById('novo-local-nome').value.trim().toUpperCase();
            const unidade = document.getElementById('novo-local-unidade').value;
            if(!posto || !nome || !unidade) return alert("Preencha Posto, Nome e Unidade.");
            
            // Constr√≥i o ID √∫nico e o nome completo
            const id = `${posto.toLowerCase()}_${nome.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            const localCompleto = `${posto} - ${nome}`; // Nome que aparecer√° no Card/Relat√≥rio
            
            try {
                // 1. Salva a lista (Viaturas)
                await db.collection(COLECAO_LISTAS).doc(id).set({ nome_local: nome, posto: posto, list: [], unidade: unidade, updatedAt: firebase.firestore.Timestamp.now() });

                // 2. Salva a rota
                await db.collection('config_geral').doc('rotas').set({ [id]: { nome: nome, posto: posto, unidade: unidade, ativo: true } }, { merge: true });

                // --- NOVO: Cria o registro inicial para o Dashboard ---
                // Este registro garante que o Card de Pend√™ncias apare√ßa imediatamente com status OK.
                await db.collection(COLECAO_RESULTADOS).add({
                    local: localCompleto,
                    lista_id: id,
                    conferente: "Sistema (Inicializa√ß√£o)",
                    unidade: unidade,
                    posto: posto,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    // Dados para garantir que o card seja renderizado com 0 pend√™ncias
                    itensRelatorio: [], 
                    itensCaa: [],
                    totalCaa: 0,
                    totalItensConferidos: 0,
                    statusAdmin: 'OK'
                });
                // ----------------------------------------------------

                alert("Lista Criada e Card Inicializado!"); 
                carregarListaLocaisAdmin();
                // Chama loadCaaData() para atualizar o Dashboard com o novo Card
                loadCaaData(); 
                
            } catch(e) { 
                alert("Erro ao criar lista: " + e.message); 
            }
        }
        
        async function excluirLocalAdmin(listaId, listaNome) {
    if (!confirm(`TEM CERTEZA? Excluir a lista: ${listaNome} (ID: ${listaId})?`)) {
        return;
    }

    try {
        // --- 1. REMOVER REGISTROS DE PEND√äNCIA (CARDS) ---
        const resultadosSnap = await db.collection(COLECAO_RESULTADOS)
            .where('lista_id', '==', listaId)
            .get();

        const batch = db.batch();
        resultadosSnap.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
        // ----------------------------------------------------

        // 2. Remova o item da cole√ß√£o principal de listas (o conte√∫do em si)
        await db.collection(COLECAO_LISTAS).doc(listaId).delete();

        // 3. Remova a refer√™ncia da rota na configura√ß√£o geral, inativando-a
        const rotasRef = db.collection('config_geral').doc('rotas');
        const rotasSnap = await rotasRef.get();
        const rotasData = rotasSnap.data();

        if (rotasData && rotasData[listaId]) {
            // Marca como inativo em vez de deletar para manter o hist√≥rico de dados antigos
            rotasData[listaId].ativo = false;
            await rotasRef.set(rotasData); 
        }

        alert(`Lista "${listaNome}" exclu√≠da/inativada e Cards de Pend√™ncia removidos com sucesso!`);
        
        carregarListaLocaisAdmin();
        loadCaaData(); // Atualiza o Dashboard
    } catch (e) {
        console.error("Erro ao excluir lista:", e);
        alert("Erro ao excluir lista: " + e.message);
    }
}
        
        async function carregarListaLocaisAdmin() {
    const ul = document.getElementById('lista-locais-container');
    const doc = await db.collection('config_geral').doc('rotas').get();
    const rotas = doc.data();
    ul.innerHTML = '';
    
    // --- FILTRO DE SEGURAN√áA PARA GESTOR ---
    const isGestor = currentUserData.role === 'gestor';
    const unidadeGestor = currentUserData.unidade;
    // ----------------------------------------
    
    // Objeto para mapear o ID da lista para o nome do local
    const listaNomes = {};

    // Mapeia as rotas e carrega os nomes
    Object.entries(rotas).forEach(([id, info]) => {
        if(info.ativo === false) return;

        // CONDI√á√ÉO DE FILTRAGEM: Se for gestor, s√≥ mostra se a unidade da rota for igual √† unidade do gestor.
        if (isGestor && info.unidade !== unidadeGestor) {
            return;
        }
        
        listaNomes[id] = info.nome;
        
        const li = document.createElement('li');
        li.className = 'local-item';
        
        const safeName = info.nome.replace(/'/g, "\\'");
        const safeId = id.replace(/'/g, "\\'");
        // NOVO: Passando o nome da unidade para uso no abrirEditor
        const safeUnit = info.unidade.replace(/'/g, "\\'") || 'Geral'; 
        
        // --- CHAMADA CORRIGIDA: INCLUINDO A UNIDADE NO ABRIR EDITOR ---
        li.innerHTML = `
            <div class="local-info">
                <strong>${info.nome}</strong>
                <span>${info.posto} | Unidade: ${info.unidade||'Geral'}</span>
            </div>
            <div style="display:flex; gap: 10px;">
                <button class="btn-modern-action btn-edit" onclick="abrirEditor('${safeId}', '${safeName}', '${safeUnit}')">
                    Editar
                </button>
                <button class="btn-modern-action btn-delete" onclick="excluirLocalAdmin('${safeId}', '${safeName}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        ul.appendChild(li);
    });
}
        
        function renderizarLista() { 
            const container = document.getElementById('lista-setores-container');
            container.innerHTML = '';
            dadosConferencia.forEach(setor => {
            const setorLi = document.createElement('li'); 
            setorLi.className = 'setor-item'; 
            setorLi.setAttribute('data-id', setor.id);
            const addItemFormHtml = `<div class="add-item-form-setor">
            <input type="text" id="input-item-nome-${setor.id}" placeholder="Item" class="filter-input" style="flex-grow:1;">
            <input type="number" id="input-item-qtd-${setor.id}" value="1" class="filter-input" style="width:50px; flex-grow:0;">
            <select id="select-item-tipo-${setor.id}" class="filter-input" style="flex-grow:1;">
            <option value="single">√önico</option>
            <option value="multi">Tombamento</option>
            </select>
            <button class="btn-add" onclick="adicionarItemPorSetor('${setor.id}')">+</button>
            </div>`;
                let itensHtml = '';
                setor.itens.forEach(item => {
                    let tombamentosHtml = '';
                    if (item.tipo === 'multi' && item.tombamentos) {
                        const tombamentosList = item.tombamentos.map(tomb => `<li><div style="display:flex; align-items:center; width:100%;"><span style="margin-right:10px; font-size:0.85em; font-weight:bold; color:#555;">TB:</span><input type="text" value="${tomb.tomb}" onblur="editarTombamento('${item.id}', '${tomb.tomb}', this)" style="padding:4px; font-size:0.85em; border:1px solid #ddd; border-radius:4px;"></div><button class="btn-remover" onclick="removerTombamento('${item.id}', '${tomb.tomb}')" style="padding:2px 8px; margin-left:10px;"><i class="fas fa-trash" style="font-size:0.8em;"></i></button></li>`).join('');
                        tombamentosHtml = `<div class="tombamento-container-wrapper"><div class="tombamento-section"><h4>Tombamentos (${item.tombamentos.length})</h4><ul class="tombamento-list">${tombamentosList}</ul><div class="add-tombamento-form"><input type="text" id="tomb-input-${item.id}" placeholder="Novo Tombamento"><button class="btn-add" onclick="adicionarTombamento('${item.id}', document.getElementById('tomb-input-${item.id}'))"><i class="fas fa-plus"></i></button></div></div></div>`;
                    }
                    itensHtml += `<li class="item-conferencia-admin"><div style="width:100%"><div style="display:flex;justify-content:space-between;"><div><strong>${item.nome}</strong><small> Qtd: ${item.quantidadeEsperada}</small></div><div class="item-actions-admin"><button class="btn-edit-alt" onclick="abrirModalEdicao('${setor.id}','${item.id}')"><i class="fas fa-edit"></i></button><button class="btn-remover" onclick="removerItem('${setor.id}','${item.id}')"><i class="fas fa-trash"></i></button></div></div>${item.tipo === 'multi' ? tombamentosHtml : ''}</div></li>`;
                });
                
                // ... (c√≥digo dentro do loop forEach) ...
                setorLi.innerHTML = `
    <div class="setor-content-header-sticky" onclick="this.nextElementSibling.classList.toggle('collapsed')">
        <div class="setor-header-admin">
            <span>${setor.nome}</span>
            <button class="btn-remover" onclick="event.stopPropagation();removerSetor('${setor.id}')">X</button>
        </div>
        ${addItemFormHtml}
    </div>
    <div class="setor-content-admin">
        <ul class="lista-setores item-list-admin" data-setor-id="${setor.id}">${itensHtml}</ul>
    </div>
`;
                container.appendChild(setorLi);
            });
            // Inicializa√ß√£o do Sortable para SETORES (na vari√°vel 'container')
            new Sortable(container, { 
                animation: 150, 
                handle: '.setor-header-admin', 
                onEnd: () => { 
                    updateOrdens(); // <-- NOVO: Atualiza a ordem dos setores e itens no array global
                    salvarDados(false); 
                } 
            });
            document.querySelectorAll('.item-list-admin').forEach(el => { 
                new Sortable(el, { 
                    group: 'items', 
                    animation: 150, 
                    // === OP√á√ïES DE AUTOSCROLL AQUI ===
        
                    scroll: true,             // 1. Ativa a rolagem autom√°tica
                    scrollSensitivity: 80,    // 2. Dist√¢ncia (em pixels) da borda para acionar o scroll
                    scrollSpeed: 20,          // 3. Velocidade da rolagem (quanto maior, mais r√°pido)
                    bubbleScroll: true,
                    // Define o elemento que deve rolar. 
                    // No seu caso, o elemento pai de `el` √© o .setor-content-admin
                
                    onEnd: () => { 
                        updateOrdens(); 
                        salvarDados(false); 
                    } 
                }); 
            });
        }
        /**
 * ====================================
 * FUN√á√ïES DE GEST√ÉO DE CAUTELAS
 * INSERIR ESTE BLOCO ANTES DE 'window.addEventListener('popstate'...'
 * ====================================
 */

/**
 * Fun√ß√£o que retorna o HTML do formul√°rio de Nova Cautela (Passo 1/2).
 */
function getNovaCautelaFormHTML() {
    return `
        <div class="op-card" id="form-nova-cautela">
            <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3><i class="fas fa-file-contract"></i> Nova Cautela (Passo 1/2)</h3>
                <button class="btn-modern-action" onclick="showMainMenu()">
                    <i class="fas fa-arrow-left"></i> Voltar ao Menu
                </button>
            </div>
        
            <div class="form-grid-2-columns">
                <div class="form-group">
                    <label for="cautela-destinatario">Destinat√°rio da Cautela (Quem ir√° receber):</label>
                    
                    <div class="custom-select-container">
                        <input type="text" id="cautela-destinatario" placeholder="Digite o nome, posto ou matr√≠cula do usu√°rio" required autocomplete="off">
                        <div id="cautela-suggestions-box" class="suggestions-box">
                            <ul id="cautela-suggestions-list">
                                </ul>
                        </div>
                    </div>
       
                </div>
                
                <div class="form-group">
                    <label for="cautela-local-origem">Local de Origem (Sua Cust√≥dia):</label>
                    <select id="cautela-local-origem" required onchange="loadCustodiaItens()">
                        <option value="" disabled selected>Selecione um local...</option>
                    </select>
                </div>
            </div>
        
            <h4 style="margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #800020;">
                <i class="fas fa-clipboard-list"></i> Sele√ß√£o de Materiais
            </h4>
            
            <div id="itens-custodia-list">
                <p class="placeholder-message" style="text-align: center; color: #999;">
                    Por favor, selecione um Local de Origem para listar os itens sob sua cust√≥dia.
                </p>
            </div>
        
            <div class="form-group" style="margin-top: 20px;">
                <label for="cautela-obs">Observa√ß√µes da Cautela (Opcional):</label>
                <textarea id="cautela-obs" rows="3" placeholder="Adicione detalhes, instru√ß√µes ou a raz√£o da cautela."></textarea>
            </div>
            
            <button class="btn-create btn-form-action" onclick="iniciarCautelaProcesso()" id="btn-iniciar-cautela" disabled>
                <i class="fas fa-paper-plane"></i> Enviar Cautela (0 itens)
            </button>
        </div>
    `;
}

/**
 * Carrega o formul√°rio de Nova Cautela, escondendo o menu de bot√µes.
 * Chamado pelo bot√£o "Nova Cautela".
 */
function loadNewCautelaForm() {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');

    if (menuContainer) {
        menuContainer.style.display = 'none';
    }

    if (contentArea) {
        contentArea.innerHTML = getNovaCautelaFormHTML();
        contentArea.style.display = 'block'; 
        
        // CORRE√á√ÉO DE UI: Adicionar um pequeno atraso para garantir que o DOM esteja pronto 
        // e o campo de observa√ß√µes seja habilitado, caso alguma regra de estilo o tenha desativado.
        setTimeout(() => {
            const obsField = document.getElementById('cautela-obs');
            if (obsField) {
                 // For√ßa remo√ß√£o de qualquer bloqueio de leitura
                obsField.removeAttribute('readonly'); 
                obsField.removeAttribute('disabled');
            }
        }, 50);

        loadCustodiaLocais(); 
        loadUsersForSearch();
    }
}

/**
 * Volta para o Menu Principal de Cautelas (os 4 bot√µes).
 * Chamado pelo bot√£o "Voltar ao Menu" no formul√°rio e no dashboard.
 */
function showMainMenu() {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');

    // 1. Limpa e esconde a √°rea de conte√∫do (formul√°rio ou dashboard)
    if (contentArea) {
        contentArea.innerHTML = '';
        contentArea.style.display = 'none';
    }

    // 2. Exibe o menu de 4 bot√µes novamente (usando grid para layout responsivo)
    if (menuContainer) {
        menuContainer.style.display = 'grid'; 
    }
}
    function showCautelasDashboard(type) {
    const menuContainer = document.getElementById('cautelas-options-container');
    const contentArea = document.getElementById('cautelas-content');
    if (menuContainer) menuContainer.style.display = 'none';// [cite: 1107]

    if (contentArea) { // [cite: 1109]
        let htmlContent = '';

        if (type === 'Cautelas Ativas') { // [cite: 11.20, 1121]
            htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-clipboard-check"></i> Cautelas Ativas </h3>
                        <button id="btn-back-cautelas" class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Lista de materiais sob sua cautela. Clique em uma linha para ver os detalhes.
                    </p>

                    <div id="loading-cautelas" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando cautelas...
                    </div>

                    <table class="ca-table" id="cautelas-ativas-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Destinat√°rio</th>
                                <th>Emiss√£o</th>
                                <th>Local Origem</th>
                                <th>Itens</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="cautelas-ativas-body">
                        </tbody>
                    </table>
                </div>
            `;
            
            // Chamar a fun√ß√£o de carregamento logo ap√≥s injetar o HTML
            setTimeout(() => loadActiveCautelas(), 50);// [cite: 1129]

        } else if (type === 'Cautelas a Receber') { // [cite: 1130]
            // NOVO BLOCO: Cautelas a Receber
            htmlContent = `
                <div class="op-card">
                    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3><i class="fas fa-inbox"></i> Cautelas a Receber </h3>
                        <button id="btn-back-cautelas" class="btn-modern-action" onclick="showMainMenu()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Cautelas emitidas por terceiros que precisam ser confirmadas por voc√™. 
                    </p>

                    <div id="loading-receive" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando cautelas...
                    </div>

                    <table class="ca-table" id="cautelas-receive-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                               <th>Emitente</th>
                                <th>Emiss√£o</th>
                                <th>Local Origem</th>
                                <th>Itens</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="cautelas-receive-body"> 
                        </tbody>
                    </table>
                </div>
            `;
            // Chamar a nova fun√ß√£o de carregamento logo ap√≥s injetar o HTML
            setTimeout(() => loadCautionsToReceive(), 50);// [cite: 1137, 1138]

        } else if (type === 'Hist√≥rico') {
    htmlContent = `
        <div class="op-card">
            <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3><i class="fas fa-archive"></i> Hist√≥rico de Cautelas</h3> 
                
                <button id="btn-back-cautelas" class="btn-modern-action" onclick="showMainMenu()">
                    <i class="fas fa-arrow-left"></i> Voltar ao Menu
                </button>
            </div>
            
            <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                Filtre por Militar, N¬∫ Cautela ou Escopo de Responsabilidade.
            </p>

            <div class="modern-filter-card">
                
                <div class="filter-item">
                    <label for="hist-militar-input"><i class="fas fa-user-tag"></i> Militar (Nome/Posto)</label>
                    <div class="custom-select-container">
                        <input type="text" id="hist-militar-input" placeholder="Nome, Posto ou Matr√≠cula" class="filter-input" autocomplete="off" oninput="setupCautelaDestinatarioListener('hist-militar-input', 'hist-suggestions-list', 'hist-suggestions-box')">
                        <div id="hist-suggestions-box" class="suggestions-box">
                            <ul id="hist-suggestions-list"></ul>
                        </div>
                    </div>
                </div>

                <div class="filter-item" style="min-width: 150px; flex-grow: 0;">
                    <label for="hist-cautela-id"><i class="fas fa-barcode"></i> N¬∫ Cautela</label>
                    <input type="text" id="hist-cautela-id" placeholder="Ex: CAUTELA-000123" class="filter-input" style="text-transform: uppercase;">
                </div>

                <div class="filter-item" style="min-width: 200px;">
                    <label for="hist-scope-filter"><i class="fas fa-briefcase"></i> Papel na Cautela</label>
                    <select id="hist-scope-filter" class="filter-input" onchange="loadHistoricalCautelas()">
                        <option value="todos">Todos (Escopo Gerencial)</option>
                        <option value="emitidas">Emissor</option>
                        <option value="minhas">Destinat√°rio</option>
                        <option value="devolucao">Recebedor</option>
                    </select>
                </div>
                
                <div class="filter-item" style="min-width: 150px;">
                    <label><i class="far fa-calendar-alt"></i> Data Inicial</label>
                    <input type="date" id="hist-start-date" class="filter-input">
                </div>
                <div class="filter-item" style="min-width: 150px;">
                    <label><i class="far fa-calendar-alt"></i> Data Final</label>
                    <input type="date" id="hist-end-date" class="filter-input">
                </div>
                
                <div class="filter-item" style="flex: 0;">
                   <button class="btn-filter-modern" onclick="loadHistoricalCautelas()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
                
            </div>
            
            <div id="historico-content-container">
                <div id="loading-historico" style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...
                </div>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = htmlContent;
    contentArea.style.display = 'block';

    // A√ß√µes de carregamento (em timeout para o DOM ser injetado)
    setTimeout(() => {
        loadUsersForSearch('hist'); 
        loadHistoricalCautelas();
    }, 50);

        } else {
            // ‚¨ÖÔ∏è Adicione este bloco para erros/valores inesperados
            console.warn("View de Cautelas desconhecida:", type); // Corrigido 'view' para 'type'
        }
        
        contentArea.innerHTML = htmlContent; // [cite: 1151]
        contentArea.style.display = 'block';
    }
}
    async function loadUsersForSearch(targetView) {
    const militarLogadoCompleto = currentUserData.nome_militar_completo;
    
    // --- 1. DEFINI√á√ÉO DO ESCOPO DE BUSCA ---
    let userQuery = db.collection('usuarios');
    
    // üõë REMOVENDO RESTRI√á√ÉO DE UNIDADE PARA GESTOR NO HIST√ìRICO üõë
    // Se n√£o for Hist√≥rico (ou seja, se for Nova Cautela), a restri√ß√£o de unidade permanece.
    if (currentUserData.role === 'gestor' && targetView !== 'hist') {
        userQuery = userQuery.where('unidade', '==', currentUserData.unidade);
    }
    
    try {
        const usersSnapshot = await userQuery.get();
        allTargetUsers = [];
        
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            const nomeCompleto = user.nome_militar_completo; 

            // Excluir o pr√≥prio usu√°rio logado APENAS se n√£o for Hist√≥rico.
            const shouldExcludeSelf = (targetView !== 'hist'); 

            if (nomeCompleto && (!shouldExcludeSelf || nomeCompleto !== militarLogadoCompleto)) {
                allTargetUsers.push({
                    id: doc.id,
                    nome: nomeCompleto
                });
            }
        });

        // 2. CONFIGURA LISTENERS / ESTADO 
        if (targetView === 'hist') {
            setupCautelaDestinatarioListener('hist-militar-input', 'hist-suggestions-list', 'hist-suggestions-box', true);
            
            const militarInput = document.getElementById('hist-militar-input');
            const scopeSelect = document.getElementById('hist-scope-filter');

            if (currentUserData.role === 'operacional') {
                // Operacional: Preenche, desabilita e restringe o filtro de Escopo
                militarInput.value = militarLogadoCompleto;
                militarInput.disabled = true;
                militarInput.style.backgroundColor = '#f0f0f0';
                
                const todosOption = scopeSelect.querySelector('option[value="todos"]');
                if (todosOption) todosOption.disabled = true;
                
            } else {
                // Gestor/Admin: Busca livre
                militarInput.disabled = false;
                militarInput.style.backgroundColor = '';
                const todosOption = scopeSelect.querySelector('option[value="todos"]');
                if (todosOption) todosOption.disabled = false;
            }
        } else {
            // L√≥gica para Nova Cautela
            setupCautelaDestinatarioListener('cautela-destinatario', 'cautela-suggestions-list', 'cautela-suggestions-box');
        }

    } catch (error) {
        console.error("Erro ao carregar usu√°rios para a busca:", error);
    }
}
        // Localiza√ß√£o: Pr√≥ximo √† linha 1160

function setupCautelaDestinatarioListener(targetInputId, suggestionsListId, suggestionsBoxId, isHistorical = false) {
    const input = document.getElementById(targetInputId);
    const suggestionsBox = document.getElementById(suggestionsBoxId);
    const suggestionsList = document.getElementById(suggestionsListId);
    
    // SA√çDA DE SEGURAN√áA: Se algum elemento cr√≠tico n√£o for encontrado, encerra a fun√ß√£o.
    if (!input || !suggestionsBox || !suggestionsList) {
        // Isso pode ocorrer se o elemento ainda n√£o foi injetado (showCautelasDashboard)
        console.warn(`Elemento de autocompletar n√£o encontrado: Input ID ${targetInputId} n√£o existe.`);
        return; 
    }
    
    // 1. LISTENER DE DIGITA√á√ÉO (Filtra e Renderiza)
    input.addEventListener('input', () => {
        const searchTerm = input.value.trim().toUpperCase();
        suggestionsList.innerHTML = '';
        
        if (searchTerm.length < 3) {
            suggestionsBox.style.display = 'none';
            return;
        }

        // üõë CORRE√á√ÉO: allTargetUsers √© a base carregada em loadUsersForSearch (filtrada por Gestor) üõë
        const filteredUsers = allTargetUsers.filter(user => 
            user.nome.toUpperCase().includes(searchTerm)
        );

        if (filteredUsers.length > 0) {
            let html = '';
            filteredUsers.forEach(user => {
                // Adiciona o nome completo (value) e o ID (data-id) na lista
                html += `<li data-user-name="${user.nome}">${user.nome}</li>`;
            });
            
            suggestionsList.innerHTML = html;
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    });
    
    // 2. LISTENER DE SELE√á√ÉO (Preenche o Input e Esconde a Lista)
    suggestionsList.addEventListener('click', (event) => {
        if (event.target.tagName === 'LI') {
            const selectedName = event.target.getAttribute('data-user-name');
            input.value = selectedName;
            suggestionsBox.style.display = 'none';
            
            // Para Hist√≥rico, disparamos a busca principal ap√≥s a sele√ß√£o
            if (isHistorical) {
                loadHistoricalCautelas(); 
            } else {
                // Para Nova Cautela, atualiza a contagem/valida√ß√£o
                input.dispatchEvent(new Event('change')); 
            }
        }
    });

    // 3. Oculta a caixa quando o foco sai do input, mas com um pequeno atraso
    input.addEventListener('blur', () => {
        setTimeout(() => {
            suggestionsBox.style.display = 'none';
        }, 150);
    });
    
    // 4. Garante que a caixa reapare√ßa ao focar
    input.addEventListener('focus', () => {
        if (input.value.length >= 3) {
             suggestionsBox.style.display = 'block';
        }
    });
}
async function loadCustodiaLocais() {
    const selectLocal = document.getElementById('cautela-local-origem');
    
    // **CORRE√á√ÉO APLICADA:** Usamos a vari√°vel 'conferente' encontrada no seu c√≥digo.
    const currentUserId = conferente; 

    if (!selectLocal || !currentUserId) {
        console.warn("UID do usu√°rio (conferente) n√£o encontrado ou seletor de local ausente.");
        // Opcional: Desabilita o campo e mostra uma mensagem de erro
        selectLocal.innerHTML = '<option value="" disabled selected>Erro: Usu√°rio n√£o identificado.</option>';
        return;
    }
    
    selectLocal.disabled = true;
    selectLocal.innerHTML = '<option value="" disabled selected>Carregando locais...</option>';


    try {
        const currentUserId = conferente; // Nome completo do militar logado
        
        // üõë CORRE√á√ÉO: Consulta a cole√ß√£o de CONTROLE DE CUST√ìDIA ATUAL üõë
        const custodyRef = db.collection('custodia_atual');
        const resultsSnapshot = await custodyRef
            // Filtra EXCLUSIVAMENTE onde o conferente_completo √© o militar logado
            .where('conferente_completo', '==', currentUserId) 
            .get();

        const locaisDeCustodia = new Set();
        
        // Coleta os nomes de local_nome para preencher o dropdown
        resultsSnapshot.forEach(doc => {
            // O campo agora √© 'local_nome' e deve ser usado para preencher o Set
            locaisDeCustodia.add(doc.data().local_nome);
        });
        
        // Monta as op√ß√µes do SELECT.
        let optionsHtml = '<option value="" disabled selected>Selecione um local...</option>';
        if (locaisDeCustodia.size === 0) {
            optionsHtml = '<option value="" disabled selected>Nenhum local sob sua cust√≥dia.</option>';
        } else {
            locaisDeCustodia.forEach(local => {
                optionsHtml += `<option value="${local}">${local}</option>`;
            });
        }
        
        selectLocal.innerHTML = optionsHtml;
        selectLocal.disabled = false;
    } catch (error) {
        console.error("Erro ao carregar locais sob cust√≥dia:", error);
        selectLocal.disabled = false;
        selectLocal.innerHTML = '<option value="" disabled selected>Erro ao carregar locais.</option>';
    }
}
     // Localiza√ß√£o: Linha ~1132
async function loadCustodiaItens() {
    const selectLocal = document.getElementById('cautela-local-origem');
    const localNomeCompleto = selectLocal.value;
    const itemListContainer = document.getElementById('itens-custodia-list');
    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    
    itemListContainer.innerHTML = '<p class="placeholder-message" style="text-align: center; color: #800020;">Buscando materiais...</p>';
    btnIniciar.disabled = true;

    if (!localNomeCompleto) return;
    try {
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        
        let listaId = null;
        for (const [id, info] of Object.entries(rotas)) {
            const nomeCompletoRota = `${info.posto} - ${info.nome}`;
            if (nomeCompletoRota === localNomeCompleto) {
                listaId = id;
                break;
            }
        }
        
        if (!listaId) {
            itemListContainer.innerHTML = '<p class="placeholder-message" style="color:red;">Erro: ID da Lista n√£o encontrado para este Local.</p>';
            return;
        }

        const listaDoc = await db.collection('listas_conferencia').doc(listaId).get();
        if (!listaDoc.exists) {
            itemListContainer.innerHTML = '<p class="placeholder-message" style="color:red;">Lista Mestra de Materiais n√£o encontrada.</p>';
            return;
        }
        const listaMestra = listaDoc.data().list || [];

        let htmlContent = '<div class="inventory-accordion-container">';
        let totalItensDisponiveis = 0;
        let isFirstSetor = true; 

        listaMestra.forEach(setor => {
            // Os itens dispon√≠veis s√£o APENAS aqueles que est√£o em item.tombamentos (e n√£o em tombamentos_cautelados)
            const setorItems = (setor.itens || []).filter(i => 
                (i.tipo === 'single' && i.quantidadeEsperada > 0) || 
                (i.tipo === 'multi' && i.tombamentos && i.tombamentos.length > 0)
            );
            
            const setorTotal = setorItems.reduce((acc, item) => {
                if(item.tipo === 'single') return acc + item.quantidadeEsperada;
                if(item.tipo === 'multi') return acc + item.tombamentos.length;
                return acc;
            }, 0);
            
            totalItensDisponiveis += setorTotal;

            const contentId = `content-${setor.id}`;
            const headerClass = isFirstSetor ? 'accordion-header active' : 'accordion-header';
            const contentStyle = isFirstSetor ? 'max-height: 1500px;' : ''; 
            
            htmlContent += `
                <div class="${headerClass}" onclick="toggleAccordion(this, '${contentId}')">
                    <span>${setor.nome} (${setorTotal} dispon√≠veis)</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            `;
            
            htmlContent += `<div class="accordion-content" id="${contentId}" style="${contentStyle}">`;
            
            if (setorItems.length > 0) {
                htmlContent += '<div class="items-card-grid">';

                setorItems.forEach(item => {
                    const itemIdBase = item.id;
                    
                    if (item.tipo === 'single') {
                        const maxQtd = item.quantidadeEsperada;
                        htmlContent += `
                            <div class="item-selection-card" data-item-id="${itemIdBase}" data-tipo="single">
                                <h4 class="item-card-title"><i class="fas fa-boxes"></i> ${item.nome}</h4>
                                <div class="qtd-control-wrapper">
                                    <label>
                                        <input type="checkbox" name="cautela-item-base" 
                                               data-id="${itemIdBase}" data-nome="${item.nome}" data-tipo="single" 
                                               data-max-qtd="${maxQtd}"
                                               onchange="toggleItemQuantity(this); updateCardClass(this.closest('.item-selection-card'));">
                                        Selecionar
                                    </label>
                                    <input type="number" 
                                           class="input-qtd-cautela"
                                           data-item-id="${itemIdBase}"
                                           min="1" 
                                           max="${maxQtd}" 
                                           value="1"
                                           disabled 
                                           style="width: 60px;">
                                </div>
                                <small style="display: block; margin-top: 5px; color:#a00030;">Dispon√≠vel: ${maxQtd}</small>
                            </div>`;

                    } else if (item.tipo === 'multi' && item.tombamentos && item.tombamentos.length > 0) {
                        
                        // AGORA: O ARRAY item.tombamentos S√ì CONT√âM ITENS DISPON√çVEIS
                        const tombamentosDisponiveis = item.tombamentos; 
                        
                        // Renderiza√ß√£o das Tags de Tombamento
                        let tagsHtml = tombamentosDisponiveis.map(tomb => {
                            const itemIdTombado = `${itemIdBase}-${tomb.tomb}`;
                            return `
                                <div class="tombamento-tag" data-item-id="${itemIdTombado}">
                                    <input type="checkbox" name="cautela-item-multi" 
                                           data-id="${itemIdTombado}" 
                                           data-nome="${item.nome} (Tomb: ${tomb.tomb})" data-tipo="multi" 
                                           data-qtd="1"
                                           onchange="updateCardClass(this.closest('.item-selection-card'));">
                                    ${tomb.tomb}
                                </div>`;
                        }).join('');

                        htmlContent += `
                            <div class="item-selection-card" data-item-id="${itemIdBase}" data-tipo="multi">
                                <h4 class="item-card-title"><i class="fas fa-shield-alt"></i> ${item.nome} (${tombamentosDisponiveis.length} dispon√≠veis)</h4>
                                <small style="color:#555;">Selecione os tombamentos:</small>
                                <div class="tombamento-tag-list">${tagsHtml}</div>
                            </div>`;
                    }
                });
                
                htmlContent += '</div>';

            } else {
                 htmlContent += '<p style="padding:10px; color:#999;">Nenhum item dispon√≠vel para cautela neste setor.</p>';
            }

            htmlContent += '</div>';

            isFirstSetor = false;
        });
        
        htmlContent += '</div>';

        if (totalItensDisponiveis === 0) {
             itemListContainer.innerHTML = '<p class="placeholder-message" style="color:green; padding:20px;">‚úÖ Nenhum material dispon√≠vel para cautela neste local.</p>';
        } else {
             itemListContainer.innerHTML = htmlContent;
             document.querySelectorAll('input[name^="cautela-item"]').forEach(el => {
                 el.addEventListener('change', updateCautelaItemCount);
             });
             document.querySelectorAll('.input-qtd-cautela').forEach(el => {
                 el.addEventListener('input', updateCautelaItemCount);
                 el.addEventListener('change', updateCautelaItemCount);
             });
             updateCautelaItemCount();
        }

    } catch (error) {
        console.error("Erro ao carregar itens de cust√≥dia:", error);
        itemListContainer.innerHTML = '<p class="placeholder-message" style="color:red;">Erro ao carregar lista de materiais.</p>';
    }
}
        
function updateCardClass(card) {
    if (!card) return;
    const isMulti = card.getAttribute('data-tipo') === 'multi';
    let isChecked = false;

    if (isMulti) {
        // Para itens multi, verifica se pelo menos um tombamento est√° checado
        const checkedTombamentos = card.querySelectorAll('input[name="cautela-item-multi"]:checked');
        isChecked = checkedTombamentos.length > 0;

        // Atualiza a classe de cada tag individualmente
        card.querySelectorAll('.tombamento-tag input[type="checkbox"]').forEach(chk => {
            if (chk.checked) {
                chk.closest('.tombamento-tag').classList.add('selected');
            } else {
                chk.closest('.tombamento-tag').classList.remove('selected');
            }
        });
        
    } else {
        // Para itens single, verifica o checkbox principal
        const mainCheckbox = card.querySelector('input[name="cautela-item-base"]');
        isChecked = mainCheckbox && mainCheckbox.checked;
    }
    
    if (isChecked) {
        card.classList.add('selected');
    } else {
        card.classList.remove('selected');
    }
}

/**
 * L√≥gica do Acorde√£o: Mostra ou esconde o conte√∫do do setor.
 * @param {HTMLElement} header - O cabe√ßalho clicado.
 * @param {string} contentId - O ID do conte√∫do a ser expandido/colapsado.
 */
function toggleAccordion(header, contentId) {
    const content = document.getElementById(contentId);
    
    // 1. Alterna a classe 'active' no cabe√ßalho
    header.classList.toggle('active');
    
    // 2. Controla o max-height para anima√ß√£o de acorde√£o
    if (content.style.maxHeight !== '0px' && content.style.maxHeight !== '') {
        content.style.maxHeight = '0px';
    } else {
        // Define uma altura suficientemente grande para conter o conte√∫do
        content.style.maxHeight = content.scrollHeight + 50 + 'px'; 
    }
}

/**
 * Atualiza o texto do bot√£o de iniciar cautela com a contagem de itens selecionados.
 */
function updateCautelaItemCount() {
    let selectedCount = 0;
    
    // 1. Contagem de itens com Tombamento (tipo 'multi')
    selectedCount += document.querySelectorAll('input[name="cautela-item-multi"]:checked').length; 
    
    // 2. Contagem de itens √önicos (tipo 'single') - FIX DO SELETOR APLICADO AQUI
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        // üõë CORRE√á√ÉO: Usar o card como elemento pai üõë
        const card = chk.closest('.item-selection-card');
        if (!card) return;
        
        const inputQtd = card.querySelector('.input-qtd-cautela');

        let qtd = 0;
        if (inputQtd && !inputQtd.disabled) {
            qtd = parseInt(inputQtd.value) || 0;
            
            const max = parseInt(inputQtd.getAttribute('max')) || 0;
            
            // Valida√ß√£o simples de quantidade
            if (qtd > max) {
                alert(`A quantidade m√°xima dispon√≠vel √© ${max}.`);
                inputQtd.value = max;
                qtd = max;
            }
            if (qtd < 1) {
                // Se a quantidade for inv√°lida, desmarca o checkbox
                chk.checked = false;
                inputQtd.disabled = true;
                qtd = 0;
                // Re-executa a contagem para refletir a desmarca√ß√£o
                return updateCautelaItemCount(); 
            }
        }
        selectedCount += qtd;
    });

    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    
    btnIniciar.textContent = `‚ñ∂Ô∏è Enviar Cautela (${selectedCount} itens)`;
    // Habilita o bot√£o se a contagem for maior que zero
    btnIniciar.disabled = (selectedCount <= 0);
}
        function toggleItemQuantity(checkbox) {
    // üõë CORRE√á√ÉO: Usar .item-selection-card como elemento pai mais pr√≥ximo üõë
    const card = checkbox.closest('.item-selection-card'); 
    if (!card) return; // Se o card n√£o for encontrado (seguran√ßa)

    const inputQtd = card.querySelector('.input-qtd-cautela');

    if (inputQtd) {
        inputQtd.disabled = !checkbox.checked;
        
        // Garante que o valor seja pelo menos 1 quando marcado
        if (checkbox.checked) {
             if (parseInt(inputQtd.value) < 1 || isNaN(parseInt(inputQtd.value))) {
                 inputQtd.value = 1;
             }
        } else {
             // Se desmarcado, reseta o valor para o m√°ximo (ou outro valor de reset)
             inputQtd.value = inputQtd.getAttribute('max');
        }
    }
}
        async function getListaIdFromLocalName(localNomeCompleto) {
    // Busca o documento 'rotas' onde est√° o mapeamento dos nomes de local para os IDs.
    const rotasDoc = await db.collection('config_geral').doc('rotas').get();
    const rotas = rotasDoc.data() || {};

    for (const [id, info] of Object.entries(rotas)) {
        // Recria o nome completo para compara√ß√£o (Ex: "ALFA - PERMAN√äNCIA")
        const nomeCompletoRota = `${info.posto} - ${info.nome}`;
        if (nomeCompletoRota === localNomeCompleto) {
            return id;
        }
    }
    return null; // Retorna null se n√£o encontrar o mapeamento
}


/**
 * Coleta todos os dados dos itens selecionados (incluindo as quantidades dos inputs number).
 */
function getSelectedCautelaItemsData() {
    const itens = [];
    
    // 1. Coleta itens com Tombamento (tipo 'multi')
    document.querySelectorAll('input[name="cautela-item-multi"]:checked').forEach(chk => {
        const idCompleto = chk.getAttribute('data-id'); // Ex: ID_BASE-TOMBAMENTO (56911524-64012364-511.522)
        
        // Separa o ID Completo (que tem m√∫ltiplos h√≠fens, tornando o split complexo)
        // O valor real do tombamento √© a √öLTIMA parte do data-id (Ex: 511.522)
        const partesId = idCompleto.split('-');
        const tombamentoReal = partesId[partesId.length - 1]; 
        
        // O ID Base √© a parte anterior (Ex: 56911524-64012364)
        // Isso √© complexo e perigoso. Vamos usar o ID do item base do pr√≥prio input.
        
        // üõë Assumindo que o ID BASE (para a busca na lista mestra) √© o id_base do mItem na lista de confer√™ncia.
        // O ID BASE (ID do item que cont√©m o tombamento) √© o valor do data-id do item base antes do √∫ltimo split
        // Se o data-id for "ID_BASE-TOMB", o ID base √© tudo exceto o √∫ltimo.
        const idBaseParaBusca = partesId.slice(0, -1).join('-'); // Recomp√µe a string sem o √∫ltimo elemento.
        const nomeCompletoOriginal = chk.getAttribute('data-nome'); // Ex: EPR SCOTT 3M AIRPACK 75I COM V√ÅLVULA DE DEMANDA (Tomb: 511.522)
        // Usa regex para remover a parte do tombamento real que foi adicionada √† string nome
        const nomeLimpo = nomeCompletoOriginal.replace(/\s\(Tomb:\s[^\)]+\)/i, '').trim();
        
        itens.push({
            // üõë CR√çTICO: Usar o valor real do tombamento (511.522) üõë
            tombamento: tombamentoReal, 
            
            // Usado pelo loop de transa√ß√£o para encontrar o mItem
            id_base: idBaseParaBusca, 
            
            // Outros dados (mantidos)
            id_completo: idCompleto, // Mantido apenas para debug
            nome: nomeLimpo,
            quantidade: 1, // Sempre 1 para tombamento
            tipo: 'multi',
        });
    });

    // 2. Coleta itens √önicos (tipo 'single') - L√≥gica preservada
    document.querySelectorAll('input[name="cautela-item-base"]:checked').forEach(chk => {
        const card = chk.closest('.item-selection-card');
        if (!card) return; 

        const inputQtd = card.querySelector('.input-qtd-cautela');
        
        let qtd = parseInt(inputQtd.value) || 0;
        
        // Verifica se a quantidade √© v√°lida
        if (qtd > 0 && qtd <= parseInt(chk.getAttribute('data-max-qtd'))) {
            itens.push({
                id_completo: chk.getAttribute('data-id'), // ID base √© o ID completo para itens √∫nicos
                id_base: chk.getAttribute('data-id'), // Item base √© o pr√≥prio ID
                nome: chk.getAttribute('data-nome'),
                quantidade: qtd,
                tipo: 'single',
            });
        }
    });

    return itens;
}
        async function iniciarCautelaProcesso() {
    const btnIniciar = document.getElementById('btn-iniciar-cautela');
    btnIniciar.disabled = true;
    btnIniciar.textContent = 'Processando Transa√ß√£o...';

    const destinatarioInput = document.getElementById('cautela-destinatario').value.trim();
    const localOrigem = document.getElementById('cautela-local-origem').value;
    const obsRaw = document.getElementById('cautela-obs').value.trim();
    const itensParaCautela = getSelectedCautelaItemsData();
    const listaId = await getListaIdFromLocalName(localOrigem);

    if (!destinatarioInput || itensParaCautela.length === 0 || !listaId) {
        alert('Falha na valida√ß√£o dos dados. Verifique o destinat√°rio e a sele√ß√£o de itens.');
        updateCautelaItemCount(); 
        return;
    }

    try {
        await db.runTransaction(async (transaction) => {
            
            const configRef = db.collection('config_geral').doc('contadores');
            const listaMestraRef = db.collection('listas_conferencia').doc(listaId);
            
            const configDoc = await transaction.get(configRef);
            const listaMestraDoc = await transaction.get(listaMestraRef);
            
            if (!configDoc.exists) throw new Error("Documento de contadores n√£o encontrado!");
            if (!listaMestraDoc.exists) throw new Error("Lista Mestra de Confer√™ncia n√£o encontrada!");
            
            let novoContador = (configDoc.data().cautela_seq || 0) + 1;
            const cautelaIdSequencial = `CAUTELA-${String(novoContador).padStart(6, '0')}`;
            
            const militarCompleto = currentUserData.nome_militar_completo;
            const dataEmissaoFormatada = new Date().toLocaleDateString('pt-BR');
            
            let listaMestra = JSON.parse(JSON.stringify(listaMestraDoc.data().list));
            
            const totalItensMovimentados = itensParaCautela.reduce((sum, item) => {
                return sum + item.quantidade;
            }, 0); 

            
            // üõë L√ìGICA DE BAIXA ADMINISTRATIVA E CARIMBO üõë
            listaMestra.forEach(setor => {
                setor.itens = setor.itens.map(mItem => {
                    const cItemsSetor = itensParaCautela.filter(item => item.id_base === mItem.id);

                    if (cItemsSetor.length > 0) {
                        
                        cItemsSetor.forEach(cItem => {
                            let carimboTexto = '';
                            
                            if (cItem.tipo === 'single') {
                                // L√ìGICA 1: Item Sem Tombamento (single)
                                mItem.quantidadeEsperada -= cItem.quantidade; 
                                carimboTexto = `[CAUTELA-${cautelaIdSequencial}: EMITIDA] ${cItem.quantidade}UN`;
                                
                            } else if (cItem.tipo === 'multi' && mItem.tombamentos) {
                                // L√ìGICA 2: Item Com Tombamento (multi)
                                
                                mItem.tombamentos_cautelados = mItem.tombamentos_cautelados || [];
                                
                                const tombamentoSelecionado = cItem.tombamento;
                                const tombIndex = mItem.tombamentos.findIndex(tomb => tomb.tomb === tombamentoSelecionado);
                                
                                if (tombIndex !== -1) {
                                    // Move o objeto tombamento para o array de cautelados
                                    const tombamentoMovido = mItem.tombamentos.splice(tombIndex, 1)[0];
                                    
                                    tombamentoMovido.cautela_id = cautelaIdSequencial; 
                                    tombamentoMovido.destinatario = destinatarioInput;
                                    mItem.tombamentos_cautelados.push(tombamentoMovido);
                                    
                                    mItem.quantidadeEsperada = (mItem.tombamentos.length || 0) + (mItem.tombamentos_cautelados.length || 0);

                                    carimboTexto = `[CAUTELA-${cautelaIdSequencial}: EMITIDA] Tomb: ${tombamentoSelecionado}`;
                                }
                            }

                            // 3. Carimbo no Hist√≥rico Unificado (pendencia.obs)
                            if (carimboTexto) {
                                mItem.pendencia = mItem.pendencia || {};
                                mItem.pendencia.obs = mItem.pendencia.obs || '';
                                
                                mItem.pendencia.obs = montarHistoricoLinear(
                                    mItem.pendencia.obs, 
                                    `${carimboTexto} Dest: ${destinatarioInput}`,
                                    militarCompleto, 
                                    dataEmissaoFormatada
                                );
                                
                                mItem.pendencia.status = 'CAUTELADO';
                            }
                        }); 
                    }
                    return mItem;
                });
                return setor;
            });
            
            // Dados da Cautela Ativa (Documento a ser criado)
            const cautelaData = {
                cautela_id: cautelaIdSequencial,
                emitente: currentUserData.nome_militar_completo,
                destinatario: destinatarioInput,
                destinatario_original: destinatarioInput,
                local_origem: localOrigem,
                local_origem_id: listaId,
                observacoes_emissao: obsRaw,
                timestamp_emissao: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'ABERTA', 
                itens: itensParaCautela,
            };
            
            // 3. FASE DE ESCRITA
            transaction.update(configRef, { cautela_seq: novoContador });
            transaction.set(db.collection('cautelas_abertas').doc(cautelaIdSequencial), cautelaData);
            transaction.update(listaMestraRef, { list: listaMestra });

            // 4. Conclus√£o e Feedback
            alert(`‚úÖ Cautela ${cautelaIdSequencial} emitida com sucesso! Total de ${totalItensMovimentados} itens movimentados para ${destinatarioInput}.`);
        }); 

        showMainMenu(); 
        
    } catch (error) {
        console.error("Erro CR√çTICO no processo de Cautela:", error);
        alert(`Erro ao emitir cautela. Nenhum dado foi alterado. Erro: ${error.message}`);
        updateCautelaItemCount();
    }
}
        /**
 * Fun√ß√£o robusta para encontrar o objeto item (mItem) na lista mestra
 * dado seu ID base.
 * @param {Array} lista - O array listaMestra.
 * @param {string} itemIdBase - O ID base do item (Ex: 'setorID-64012364').
 * @returns {object|null} O objeto mItem ou null.
 */
function findItemInList(lista, itemIdBase) {
    for (const setor of lista) {
        for (const item of setor.itens) {
            if (item.id === itemIdBase) {
                return item;
            }
        }
    }
    return null;
}
        /**
 * Fun√ß√£o robusta para encontrar o objeto item base (mItem) na lista mestra
 * dado um tombamento espec√≠fico dentro de seu array de tombamentos.
 * @param {Array} lista - O array listaMestra.
 * @param {string} tombamentoReal - O valor do tombamento a ser procurado (Ex: '511.524').
 * @returns {object|null} O objeto mItem ou null.
 */
function findItemByTombamento(lista, tombamentoReal) {
    for (const setor of lista) {
        for (const item of setor.itens) {
            if (item.tipo === 'multi' && item.tombamentos) {
                // Verifica se algum dos tombamentos possui o valor real
                const foundTomb = item.tombamentos.find(tomb => tomb.tomb === tombamentoReal);
                if (foundTomb) {
                    return item; // Retorna o mItem (item base) que cont√©m o tombamento
                }
            }
        }
    }
    return null;
}
        /**
 * Busca e exibe as cautelas ativas.
 * Exibe todas as cautelas da unidade para Gestores/Admin,
 * e apenas as emitidas para/pelo usu√°rio logado para Operacionais.
 */
// Localiza√ß√£o: Fun√ß√£o loadActiveCautelas (aprox. linha 1132)

async function loadActiveCautelas() {
    const tbody = document.getElementById('cautelas-ativas-body');
    const loading = document.getElementById('loading-cautelas');
    const table = document.getElementById('cautelas-ativas-table');
    const role = currentUserData.role || 'operacional';

    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        const user = currentUserData;
        
        // Estrutura para os subgrupos
        const grupos = {
            custodiaAtiva: { title: 'Cust√≥dia Ativa (Itens sob sua responsabilidade)', data: [] },
            rastreioPessoal: { title: 'Meus Envios em Tr√¢nsito (Acompanhamento)', data: [] },
            monitoramento: { title: 'Monitoramento Gerencial/Global', data: [] },
        };
        
        const renderedIds = new Set();
        
        // --- 1. CONFIGURA√á√ÉO E EXECU√á√ÉO DAS BUSCAS ---

        // A. Pessoal: Cust√≥dia Ativa (RECEBIDA como destinat√°rio)
        if (role === 'operacional' || role === 'gestor') {
            const militarCompleto = currentUserData.nome_militar_completo;
        
            // --- 1. GRUPO CUST√ìDIA ATIVA (APENAS POSSE ATIVA) ---
            
            // A. CUST√ìDIA ATIVA: RECEBIDA (Destinat√°rio)
            // Somente itens que est√£o sob POSSE ATIVA.
            grupos.custodiaAtiva.data = await queryCautelas(['RECEBIDA'], role, user, 'destinatario', 'personal');
            grupos.custodiaAtiva.data.forEach(c => renderedIds.add(c.cautela_id));
            
            // --- 2. GRUPO RASTREIO PESSOAL (REMETENTE E REVERSOR) ---

            // B. RASTREIO PESSOAL - PARTE 1: Emitente (ABERTA, RECEBIDA, DEVOLU√á√ÉO)
            // Rastreamento para itens que ele EMITIU.
            const rastreioEmitente = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLU√á√ÉO'], role, user, 'emitente', 'personal');

            // C. RASTREIO PESSOAL - PARTE 2: Reversor (DEVOLU√á√ÉO)
            // Rastreamento para itens que ele DEVOLVEU (e precisa acompanhar o retorno).
            const rastreioReversor = await queryCautelas(['DEVOLU√á√ÉO'], role, user, 'militar_completo_reversor', 'personal');
            
            // Concatena as duas listas de rastreio
            let rastreioRaw = [...rastreioEmitente, ...rastreioReversor];

            // üõë CORRE√á√ÉO: Desduplica o array rastreioRaw internamente, usando Map üõë
            const uniqueRastreio = new Map();
            rastreioRaw.forEach(c => uniqueRastreio.set(c.cautela_id, c));
            const rastreioDesduplicado = Array.from(uniqueRastreio.values());
            
            // Remove itens que j√° est√£o na Cust√≥dia Ativa (filtro contra o outro grupo)
            grupos.rastreioPessoal.data = rastreioDesduplicado.filter(c => !renderedIds.has(c.cautela_id));
            grupos.rastreioPessoal.data.forEach(c => renderedIds.add(c.cautela_id));
        }
        
        // C. Gerencial/Admin: Monitoramento da Unidade/Global
        if (role === 'gestor' || role === 'admin') {
            
            if (role === 'gestor') {
                // üõë CORRE√á√ÉO CR√çTICA PARA GESTOR (Evitar duplo 'in') üõë
                const unitListIds = await getUnitListIds();
                let monitoramentoRaw = [];
                const statuses = ['ABERTA', 'RECEBIDA', 'DEVOLU√á√ÉO'];
                
                grupos.monitoramento.title = 'Monitoramento da Unidade (Material sob sua gest√£o)';
                
                // Verifica se h√° IDs de lista e se estamos dentro do limite de 10 do 'in'
                if (unitListIds.length > 0 && unitListIds.length <= 10) {
                    
                    // 1. Executa a consulta APENAS com o filtro 'local_origem_id' ('in')
                    let queryRef = db.collection('cautelas_abertas')
                        .where('local_origem_id', 'in', unitListIds)
                        .orderBy('timestamp_emissao', 'desc');

                    const snapshot = await queryRef.get();
                    snapshot.forEach(doc => {
                        const cautela = { id: doc.id, ...doc.data() };
                        
                        // 2. Filtra por status ABERTA, RECEBIDA, DEVOLU√á√ÉO na MEM√ìRIA
                        if (statuses.includes(cautela.status)) {
                            monitoramentoRaw.push(cautela);
                        }
                    });
                    
                } else if (unitListIds.length > 10) {
                     console.error("ALERTA: Gestor tem mais de 10 Listas. Filtro de unidade est√° incompleto.");
                } else {
                     // Nenhum ID de lista, Monitoramento vazio.
                }

                grupos.monitoramento.data = monitoramentoRaw;
                
            } else { // role === 'admin'
                grupos.monitoramento.title = 'Monitoramento Global (ADMIN)';
                // Admin pode usar o 'in' para status, pois n√£o usa o 'in' para local_origem_id
                grupos.monitoramento.data = await queryCautelas(['ABERTA', 'RECEBIDA', 'DEVOLU√á√ÉO'], role, user, null, 'unit');
            }
            
            // Remove itens que j√° foram vistos nos grupos pessoais (AP√ìS A BUSCA)
            grupos.monitoramento.data = grupos.monitoramento.data.filter(c => !renderedIds.has(c.cautela_id));
        }
        
        // --- 2. CONSOLIDA√á√ÉO E RENDERIZA√á√ÉO NA TABELA ---
        let htmlContent = '';
        const allGroups = [grupos.custodiaAtiva, grupos.rastreioPessoal, grupos.monitoramento];
        let totalCautelas = 0;

        allGroups.forEach(group => {
            if (group.data.length > 0) {
                totalCautelas += group.data.length;
                
                // Adiciona o cabe√ßalho do subgrupo (usando colspan para mesclar a linha)
                htmlContent += `
                    <tr class="group-header">
                        <td colspan="6" class="group-title-cell" data-label="">
                            <i class="fas fa-folder-open"></i> <strong>${group.title}</strong> (${group.data.length})
                        </td>
                    </tr>
                `;

                // Renderiza as linhas de dados (usando a nova fun√ß√£o auxiliar)
                group.data.forEach(cautela => {
                    htmlContent += renderCautelaRow(cautela); 
                });
            }
        });

        // --- 3. EXIBI√á√ÉO FINAL ---
        if (totalCautelas === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:20px;">Nenhuma cautela ativa encontrada sob sua responsabilidade.</td></tr>`;
        } else {
            tbody.innerHTML = htmlContent;
        }

        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas ativas:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
       
        async function loadCautionsToReceive() {
    const tbody = document.getElementById('cautelas-receive-body');
    const loading = document.getElementById('loading-receive');
    const table = document.getElementById('cautelas-receive-table');
    
    // Configura√ß√µes de exibi√ß√£o inicial
    tbody.innerHTML = '';
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        const role = currentUserData.role || 'operacional';
        const user = currentUserData;
        
        // Statuses de A√ß√£o Pessoal: ABERTA e DEVOLU√á√ÉO
        const statusesToReceive = ['ABERTA', 'DEVOLU√á√ÉO'];
        
        // Busca: Filtra pelo 'destinatario' e usa escopo 'personal' para TODOS os perfis (Operacional, Gestor, Admin).
        // Isso implementa a regra de que esta aba √© APENAS para A√á√ÉO PESSOAL.
        const cautionsToReceive = await queryCautelas(
            statusesToReceive, 
            role, 
            user, 
            'destinatario',    
            'personal'         
        );

        // --- RENDERIZA√á√ÉO ---
        
        if (cautionsToReceive.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#1b8a3e; padding:20px;">‚úÖ Nenhuma cautela pendente de recebimento.</td></tr>`;
        } else {
            let htmlContent = '';
            cautionsToReceive.forEach(cautela => {
                htmlContent += renderCautelaRow(cautela); 
            });
            tbody.innerHTML = htmlContent;
        }

        // --- FINALIZA√á√ÉO DA EXIBI√á√ÉO ---
        loading.style.display = 'none';
        table.style.display = 'table';
        
    } catch (e) {
        console.error("Erro ao carregar cautelas a receber:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Erro ao carregar dados: ${e.message}</td></tr>`;
        loading.style.display = 'none';
        table.style.display = 'table';
    }
}
        async function showCautelaDetails(cautelaId) {
    const modal = document.getElementById('cautelaDetailsModal');
    const btnReceber = document.getElementById('btn-receber-cautela'); // Para status ABERTA
    const btnDevolver = document.getElementById('btn-devolver-cautela'); // Para status RECEBIDA
    const btnConfirmarDevolucao = document.getElementById('btn-confirmar-devolucao'); // NOVO: Para status DEVOLU√á√ÉO
    
    // 1. Resetar modal e exibir
    document.getElementById('modal-cautela-id').textContent = cautelaId;
    document.getElementById('modal-status').textContent = 'Carregando...';
    modal.style.display = 'flex';
    btnReceber.style.display = 'none'; // Esconde o bot√£o normal de recebimento
    if (btnDevolver) btnDevolver.style.display = 'none'; // Esconde o bot√£o de devolu√ß√£o
    if (btnConfirmarDevolucao) btnConfirmarDevolucao.style.display = 'none'; // Esconde o novo bot√£o

    // Limpar conte√∫dos anteriores (Adicionado limpeza para os novos campos de rastreabilidade)
    if (document.getElementById('modal-destinatario-original')) document.getElementById('modal-destinatario-original').textContent = '';
    if (document.getElementById('modal-destinatario-atual')) document.getElementById('modal-destinatario-atual').textContent = '';
    if (document.getElementById('modal-ultimo-detentor')) document.getElementById('modal-ultimo-detentor').textContent = '';

    // Campos existentes
    document.getElementById('modal-emitente').textContent = '';
    document.getElementById('modal-local-origem').textContent = '';
    document.getElementById('modal-data-emissao').textContent = '';
    document.getElementById('modal-obs-emissao').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    document.getElementById('modal-itens-cautela').innerHTML = '<li style="text-align:center;">Carregando itens...</li>';

    try {
        // 2. Buscar dados da cautela no Firestore
        const docRef = db.collection('cautelas_abertas').doc(cautelaId);
        const doc = await docRef.get();
        
        if (!doc.exists) {
            alert(`Erro: Cautela ID ${cautelaId} n√£o encontrada.`);
            modal.style.display = 'none';
            return;
        }

        const cautela = doc.data();
        const dataEmissao = cautela.timestamp_emissao ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR') : 'N/D';

        // 3. Preencher Detalhes Principais - COM RASTREABILIDADE
        
        // üõë L√ìGICA DE RASTREABILIDADE (PONTO 2) üõë
        
        // A. Emitente (Origem da cautela - USUARIO A)
        document.getElementById('modal-emitente').textContent = cautela.emitente || 'N/D';
        
        // B. Destinat√°rio Original (Quem recebeu a cautela inicialmente - USUARIO B)
        // Este campo DEVE ser criado na fun√ß√£o de emiss√£o e NUNCA mais alterado.
        const destinatarioOriginal = cautela.destinatario_original || 'Necessita Campo "original"';
        if (document.getElementById('modal-destinatario-original')) {
             document.getElementById('modal-destinatario-original').textContent = destinatarioOriginal;
        }
        
        // C. Destinat√°rio Atual (Quem tem a posse/responsabilidade AGORA - USUARIO B ou Dono Provis√≥rio USUARIO C)
        if (document.getElementById('modal-destinatario-atual')) {
             document.getElementById('modal-destinatario-atual').textContent = cautela.destinatario || 'N/D';
        }
        
        // D. √öltimo Detentor (Quem enviou a devolu√ß√£o - USUARIO B, usando o campo militar_completo_reversor)
        // S√≥ faz sentido se o status for DEVOLU√á√ÉO.
        let ultimoDetentor = 'N/A';
        if (cautela.status === 'DEVOLU√á√ÉO') {
             ultimoDetentor = cautela.militar_completo_reversor || 'N√£o registrado';
        } else if (cautela.status === 'RECEBIDA' || cautela.status === 'ABERTA') {
             // Se n√£o est√° em devolu√ß√£o, o √∫ltimo detentor √© o pr√≥prio destinat√°rio.
             ultimoDetentor = cautela.destinatario;
        }
        if (document.getElementById('modal-ultimo-detentor')) {
             document.getElementById('modal-ultimo-detentor').textContent = ultimoDetentor;
        }


        // Informa√ß√µes de Borda (mantido)
        document.getElementById('modal-local-origem').textContent = cautela.local_origem || 'N/D';
        document.getElementById('modal-data-emissao').textContent = dataEmissao;
        document.getElementById('modal-obs-emissao').textContent = cautela.observacoes_emissao || 'Nenhuma observa√ß√£o no momento da emiss√£o.';
        
        // FIM DA L√ìGICA DE RASTREABILIDADE
        
        // 4. Preencher a Lista de Itens (mantido o seu c√≥digo)
        const itensList = document.getElementById('modal-itens-cautela');
        itensList.innerHTML = '';
        
        if (cautela.itens && cautela.itens.length > 0) {
            
            let itemCount = 1;
            cautela.itens.forEach(item => {
                const li = document.createElement('li');
                
                const nomeItem = item.nome || 'Item sem nome';
                
                // üõë CORRE√á√ÉO VISUAL DEFINITIVA: Exibe o tombamento real (item.tombamento) üõë
                const quantidadeOuTombamento = item.tombamento 
                    ? `(Tombamento: <strong>${item.tombamento}</strong>)` 
                    : `(Quantidade: <strong>${item.quantidade}</strong>)`;
                
                // Remove propriedades que causam confus√£o para garantir que o nome seja limpo no console
                delete item.id_completo;
                
                li.innerHTML = `
                    <span style="font-weight: 500;">${itemCount++}. ${nomeItem}</span> <span style="font-size: 0.9em; color: #555;">${quantidadeOuTombamento}</span>
                `;
                // ... (restante do estilo)
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                
                if (itemCount % 2 === 0) {
                    li.style.backgroundColor = '#e0e0e0'; 
                }

                itensList.appendChild(li);
            });
        } else {
            itensList.innerHTML = '<li style="text-align:center; color:red;">Nenhum item encontrado nesta cautela.</li>';
        }

        // 5. L√≥gica de A√ß√£o dos Bot√µes (mantida)
        const militarCompleto = currentUserData.nome_militar_completo;
        const modalStatusElement = document.getElementById('modal-status');
        
        
        // A. Cautelas ABERTAS (A RECEBER - Fluxo Normal)
        if (currentUserData.role === 'operacional' && cautela.destinatario === militarCompleto && cautela.status === 'ABERTA') {
            btnReceber.style.display = 'block';
            btnReceber.onclick = () => iniciarRecebimentoCautela(cautelaId); 
            modalStatusElement.textContent = `Status: ${cautela.status}`;
            
        // B. Cautelas EM DEVOLU√á√ÉO (A RECEBER - Novo Fluxo Dono Provis√≥rio)
        } else if (currentUserData.role === 'operacional' && cautela.destinatario === militarCompleto && cautela.status === 'DEVOLU√á√ÉO') {
            if (btnConfirmarDevolucao) {
                btnConfirmarDevolucao.style.display = 'block';
                btnConfirmarDevolucao.textContent = 'Confirmar Recebimento da Devolu√ß√£o';
                
                // NOVO ONCLICK: Inicia a confer√™ncia para o Dono Provis√≥rio (logado)
                btnConfirmarDevolucao.onclick = () => iniciarConferenciaDevolucao(cautelaId, cautela.destinatario);
            }
            // Exibir o status de DEVOLU√á√ÉO
            modalStatusElement.innerHTML = `Status: <span style="color:#d39e00; font-weight:bold;">DEVOLU√á√ÉO</span><br>Aguardando sua confer√™ncia.`;
            
        // C. Cautelas RECEBIDAS (A DEVOLVER - Fluxo Usu√°rio A)
        } else if (currentUserData.role === 'operacional' && cautela.destinatario === militarCompleto && cautela.status === 'RECEBIDA') {
            // Busca o destinat√°rio da devolu√ß√£o (√öltimo Conferente).
            const ultimoConferente = await getLastConferente(cautela.local_origem);
            
            if (btnDevolver) {
                btnDevolver.style.display = 'block';
                btnDevolver.textContent = 'INICIAR DEVOLU√á√ÉO';
                
                // Adiciona a informa√ß√£o de quem vai receber de volta no modal
                modalStatusElement.innerHTML = `Status: ${cautela.status}<br><span style="font-size:0.8em; color:#0d47a1;">Devolu√ß√£o p/: <strong>${ultimoConferente}</strong></span>`;

                // Configura o onclick para iniciar a transa√ß√£o de devolu√ß√£o (no Dashboard)
                btnDevolver.onclick = () => iniciarDevolucaoCautela(cautelaId, ultimoConferente); 
            }
        
        // D. Cautelas EM DEVOLU√á√ÉO (QUEM ENVIOU - Usu√°rio A que ainda rastreia)
        } else if (currentUserData.role === 'operacional' && cautela.militar_completo_reversor === militarCompleto && cautela.status === 'DEVOLU√á√ÉO') {
             // Este bloco √© para o Usu√°rio A ver a cautela que ele enviou, mas n√£o pode clicar
             // No modal, mostra para quem foi enviada.
             modalStatusElement.innerHTML = `Status: <span style="color:#d39e00; font-weight:bold;">EM TR√ÇNSITO</span><br><span style="font-size:0.8em; color:#0d47a1;">Aguardando recebimento por: <strong>${cautela.destinatario}</strong></span>`;

        // E. L√ìGICA PADR√ÉO (Outros Status / N√£o √© o destinat√°rio)
        } else {
            btnReceber.style.display = 'none';
            if (btnDevolver) btnDevolver.style.display = 'none';
            if (btnConfirmarDevolucao) btnConfirmarDevolucao.style.display = 'none';
            
            modalStatusElement.textContent = `Status: ${cautela.status}`;
        }
        
    // üõë CHAVE DE FECHAMENTO DO TRY üõë
    } catch (e) {
        console.error("Erro ao carregar detalhes da cautela:", e);
        // Garante que os campos de rastreabilidade sejam limpos se houver erro
        if (document.getElementById('modal-destinatario-original')) document.getElementById('modal-destinatario-original').textContent = 'ERRO';
        if (document.getElementById('modal-destinatario-atual')) document.getElementById('modal-destinatario-atual').textContent = 'ERRO';
        if (document.getElementById('modal-ultimo-detentor')) document.getElementById('modal-ultimo-detentor').textContent = 'ERRO';
        
        document.getElementById('modal-obs-emissao').textContent = 'Erro ao buscar observa√ß√µes.';
        document.getElementById('modal-itens-cautela').innerHTML = `<li style="text-align:center; color:red;">Erro ao buscar dados: ${e.message}</li>`;
        document.getElementById('modal-status').textContent = `Status: ERRO`;
    }
    // üõë CHAVE DE FECHAMENTO DA FUN√á√ÉO üõë
}

function iniciarRecebimentoCautela(cautelaId) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. Constr√≥i a URL para a cautela. (Usa 'cautelaId')
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}`;

    // 4. üõë L√ìGICA DE ABERTURA DO IFRAME (REPLICADA DA CONFER√äNCIA NORMAL) üõë
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CR√çTICO: Componentes de execu√ß√£o (app-runner-container ou app-iframe) n√£o encontrados.");
        alert("Erro ao iniciar a confer√™ncia. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a √°rea principal do dashboard (content-area) e a sidebar para dar foco total ao app
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}
        function iniciarConferenciaDevolucao(cautelaId, destinatario) {
    // 1. Fecha o modal de detalhes
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    
    // 2. Coleta e codifica os dados do militar
    // üõë CORRE√á√ÉO AQUI: Alterando de 'posto_graduacao' para 'posto' (ou similar)
    const pGradEncoded = currentUserData && currentUserData.posto ? encodeURIComponent(currentUserData.posto) : 'ND';
    
    const quadroEncoded = currentUserData && currentUserData.quadro ? encodeURIComponent(currentUserData.quadro) : 'ND';
    const nomeGuerraEncoded = currentUserData && currentUserData.nome_guerra ? encodeURIComponent(currentUserData.nome_guerra) : 'ND';

    // 3. Constr√≥i a URL CR√çTICA com o modo de devolu√ß√£o final
    const url = `conferencia_app.html?cautelaId=${cautelaId}&posto_grad=${pGradEncoded}&quadro_mil=${quadroEncoded}&nome_guerra=${nomeGuerraEncoded}&modo=devolucao_final&destinatarioDevolucao=${encodeURIComponent(destinatario)}`;

    // 4. L√ìGICA DE ABERTURA DO IFRAME (INLINE)
    const container = document.getElementById('app-runner-container');
    const iframe = document.getElementById('app-iframe');
    
    if (!container || !iframe) {
        console.error("Erro CR√çTICO: Componentes de execu√ß√£o (app-runner-container ou app-iframe) n√£o encontrados.");
        alert("Erro ao iniciar a confer√™ncia. Componentes de UI faltando.");
        return;
    }
    
    iframe.src = url;  
    container.style.display = 'block';
    
    // 5. Oculta a √°rea principal do dashboard (content-area) e a sidebar
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none'; 
    }
    const sidebar = document.getElementById('sidebar'); 
    if (sidebar) {
        sidebar.style.display = 'none'; 
    }

    // 6. Configura o listener para lidar com o retorno do app (ao finalizar)
    window.removeEventListener('message', handleIframeMessage); 
    window.addEventListener('message', handleIframeMessage); 
}

// Localiza√ß√£o: Linha ~1594
function handleIframeMessage(event) {
    // Garante que a mensagem veio do seu dom√≠nio (Importante por seguran√ßa)
    if (event.origin !== window.location.origin) return;

    if (event.data && event.data.type === 'SIGMA_FINISHED') {
        alert('‚úÖ Opera√ß√£o finalizada com sucesso. Voltando ao Dashboard.');

        // 1. Oculta o container do Iframe
        const container = document.getElementById('app-runner-container');
        if (container) {
            container.style.display = 'none';
            // Limpa a URL do iframe para liberar recursos
            document.getElementById('app-iframe').src = 'about:blank';
        }
        
        // 2. Mostra a √°rea principal do dashboard e a sidebar
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.style.display = 'block';
        }
        const sidebar = document.getElementById('sidebar') || document.getElementById('main-sidebar');
        if (sidebar) {
            sidebar.style.display = 'block';
        }
        
        // 3. Recarrega a lista mais relevante (Cautelas a Receber e Ativas)
        // Isso garante que o item CONCLU√çDA suma da lista A RECEBER/ATIVAS.
        
        // üõë CORRE√á√ÉO DE REFER√äNCIA üõë
        // A fun√ß√£o correta √© loadActiveCautelas (com 't' e 'l').
        loadCautionsToReceive(); // Atualiza a lista A RECEBER (item sumiu)
        loadActiveCautelas();    // Atualiza a lista ATIVAS (item sumiu/mudou)
        
        // For√ßa a atualiza√ß√£o dos cards (contadores) e da lista "Confer√™ncias de Hoje"
        if (typeof updateOperacionalCards === 'function') {
            updateOperacionalCards();
        }
        
        // Volta para a view de Cautelas Ativas ap√≥s o sucesso, se o usu√°rio n√£o estava no Dashboard.
        // Isto √© mais seguro do que tentar recarregar a aba 'Hist√≥rico' que estava ativa.
        switchView('cautelas'); 
        showCautelasDashboard('Cautelas Ativas'); 
    }
}        /**
 * Busca cautelas com status ABERTA e RECEBIDA para Gestores (filtradas por Unidade).
 * @param {string} unidade - A unidade do Gestor.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForGestor(unidade) {
    // Consulta 1: ABERTAS na Unidade
    const queryAberta = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'ABERTA');

    // Consulta 2: RECEBIDAS na Unidade
    const queryRecebida = db.collection('cautelas_abertas')
        .where('unidade_destino', '==', unidade)
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}

/**
 * Busca todas as cautelas com status ABERTA e RECEBIDA para Admin.
 * @returns {Array} Lista combinada de cautelas.
 */
async function getCautelasForAdmin() {
    // Consulta 1: Todas ABERTAS
    const queryAberta = db.collection('cautelas_abertas')
        .where('status', '==', 'ABERTA');

    // Consulta 2: Todas RECEBIDAS
    const queryRecebida = db.collection('cautelas_abertas')
        .where('status', '==', 'RECEBIDA');
        
    const [snapAberta, snapRecebida] = await Promise.all([
        queryAberta.get(),
        queryRecebida.get()
    ]);

    let cautelas = [...snapAberta.docs.map(doc => doc.data()), ...snapRecebida.docs.map(doc => doc.data())];
    
    // Ordena a lista combinada por timestamp_emissao (mais recente primeiro)
    cautelas.sort((a, b) => (b.timestamp_emissao?.toMillis() || 0) - (a.timestamp_emissao?.toMillis() || 0));

    return cautelas;
}

async function loadHistoricalCautelas() {
    const historicoContentContainer = document.getElementById('historico-content-container');
    const role = currentUserData.role || 'operacional';
    const user = currentUserData;
    
    // Inicia com loading
    if (historicoContentContainer) historicoContentContainer.innerHTML = '<div id="loading-historico" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Buscando hist√≥rico...</div>';
    
    // --- COLETA DOS FILTROS ---
    // 1. Filtro Militar: Preenchido pelo autocompletar, lido aqui
    const militarFiltro = document.getElementById('hist-militar-input')?.value.trim().toUpperCase() || '';
    // 2. Filtro Cautela ID
    const cautelaIdFiltro = document.getElementById('hist-cautela-id')?.value.trim().toUpperCase() || '';
    // 3. Filtro de Papel/Escopo
    const scopeFilter = document.getElementById('hist-scope-filter')?.value || 'todos';
    // 4. Filtros de Data
    const startDateInput = document.getElementById('hist-start-date')?.value;
    const endDateInput = document.getElementById('hist-end-date')?.value;

    let filterField = null; 
    let scopeType = ''; 
    let titulo = '';
    
    // --- 1. DEFINI√á√ÉO DO UNIVERSO DE BUSCA (FIREBASE) ---
    let snapGeral = [];

    if (role === 'operacional') {
        // Operacional: Busca SOMENTE as cautelas que ele pode ver (Restrito ao seu nome).
        scopeType = 'personal';
        
        // Define o campo de filtro prim√°rio do Operacional
        if (scopeFilter === 'minhas') {
            filterField = 'destinatario_original';
        } else if (scopeFilter === 'devolucao') {
            filterField = 'receptor_final_completo';
        } else if (scopeFilter === 'emitidas') {
            filterField = 'emitente';
        }
        
        // O Militar Filtro √© o pr√≥prio usu√°rio (Refor√ßa o filtro, mas n√£o muda o usu√°rio)
        snapGeral = await queryCautelas(['CONCLU√çDA'], role, user, filterField, scopeType);
        titulo = `Hist√≥rico Pessoal (${scopeFilter.charAt(0).toUpperCase() + scopeFilter.slice(1)})`;
        
    } else { // Gestor ou Admin
        // Gestor/Admin: Busca por Escopo Gerencial/Global
        scopeType = 'unit'; 
        titulo = (role === 'admin') ? 'Hist√≥rico Global (ADMIN)' : 'Hist√≥rico da Unidade (GESTOR)';
        
        // O queryCautelas usar√° o filtro de Unidade para o Gestor e Global para o Admin.
        snapGeral = await queryCautelas(['CONCLU√çDA'], role, user, null, scopeType); 
    }

    // --- 2. FILTROS COMBINADOS EM MEM√ìRIA (JAVASCRIPT) ---
    try {
        const cautelasFiltradas = snapGeral.filter(c => {
            const dataConclusao = c.timestamp_conclusao ? c.timestamp_conclusao.toDate() : null;
            
            // 1. Filtro N¬∫ Cautela
            if (cautelaIdFiltro && !c.cautela_id.includes(cautelaIdFiltro)) return false;

            // 2. Filtro Militar (Emitente OU Destinat√°rio OU Recebedor)
            // Aplica-se APENAS se o campo n√£o estiver vazio (Gestor/Admin)
            if (militarFiltro) {
                // Gestor/Admin: A busca √© livre, aplicamos a inclus√£o em todos os 3 campos
                const nomeMilitar = militarFiltro; // J√° est√° em UPPERCASE
                
                // Retorna verdadeiro se o militarFiltro estiver contido em qualquer um dos tr√™s pap√©is
                if (!c.emitente?.toUpperCase().includes(nomeMilitar) && 
                    !c.destinatario_original?.toUpperCase().includes(nomeMilitar) &&
                    !c.receptor_final_completo?.toUpperCase().includes(nomeMilitar)) {
                    return false;
                }
            }

            // 3. Filtro de PAPEL NA CAUTELA (Aplicado APENAS se o Papel for espec√≠fico e n√£o "Todos")
            if (scopeFilter !== 'todos' && role !== 'operacional') {
                const militarAlvo = militarFiltro; // Nome do militar buscado
                
                // Se o militar foi digitado, usamos o nome dele para o filtro. 
                // Se o militar N√ÉO foi digitado, o filtro j√° passou pelo passo 2.
                
                if (scopeFilter === 'emitidas' && c.emitente.toUpperCase() !== militarAlvo) return false;
                if (scopeFilter === 'minhas' && c.destinatario_original.toUpperCase() !== militarAlvo) return false;
                if (scopeFilter === 'devolucao' && c.receptor_final_completo?.toUpperCase() !== militarAlvo) return false;
            }


            // 4. Filtro Data (Opcional)
            if (startDateInput && dataConclusao && dataConclusao < new Date(startDateInput + 'T00:00:00')) return false;
            if (endDateInput && dataConclusao && dataConclusao > new Date(endDateInput + 'T23:59:59')) return false;

            return true;
        });

        await renderHistoricalTableFinal(historicoContentContainer, cautelasFiltradas, titulo);

    } catch (e) {
        console.error("Erro ao carregar hist√≥rico de cautelas:", e);
        historicoContentContainer.innerHTML = `<div class="op-card" style="padding:20px; text-align:center; color:red;">Erro ao carregar dados: ${e.message}</div>`;
    }
}


/**
 * Fun√ß√£o auxiliar que lida com a renderiza√ß√£o final da tabela.
 * (Fun√ß√£o auxiliar renderHistoricalTableFinal deve ser criada, ou o c√≥digo de renderiza√ß√£o deve ser copiado)
 */
async function renderHistoricalTableFinal(containerElement, cautelas, titulo) {
    
    // Limpa o container e remove o loading
    if (containerElement) containerElement.innerHTML = '';
    
    if (cautelas.length === 0) {
        containerElement.innerHTML = `<div class="op-card" style="padding:20px; text-align:center; color:#999;">Nenhuma cautela conclu√≠da encontrada neste escopo.</div>`;
        return;
    }
    
    // üõë Adicionando a classe 'historical-ca-table' para gradeamento
    let tableHtml = `
        <div class="op-card" style="padding:15px; margin-bottom:0;">
            <h4 style="margin-top:0; color:#800020; border-bottom:1px solid #eee; padding-bottom:5px;">
                <i class="fas fa-archive"></i> ${titulo} (${cautelas.length} registros)
            </h4>
            <table class="ca-table historical-ca-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Dest. Original</th>
                        <th>Emitente</th>
                        <th>Local Origem</th>
                        <th>Data Conclus√£o</th>
                        <th>Itens</th>
                    </tr>
                </thead>
                <tbody>
    `;

    cautelas.forEach(cautela => {
        const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
        const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        
        // üõë Adi√ß√£o dos atributos data-label em CADA C√âLULA üõë
        tableHtml += `
            <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                <td data-label="ID"><strong>${cautela.cautela_id}</strong></td>
                <td data-label="Destinat√°rio Original">${cautela.destinatario_original || 'N/A'}</td>
                <td data-label="Emitente">${cautela.emitente}</td>
                <td data-label="Local Origem">${cautela.local_origem || 'N/D'}</td>
                <td data-label="Data Conclus√£o">${dataFinal}</td>
                <td data-label="Itens">${itensCount} itens</td>
            </tr>
        `;
    });

    tableHtml += `
                </tbody>
            </table>
        </div>
    `;

    containerElement.innerHTML = tableHtml;
}

/**
 * Fun√ß√£o auxiliar que lida com a renderiza√ß√£o final da tabela.
 * (Substitui a l√≥gica de inje√ß√£o direta de HTML no final de loadHistoricalCautelas)
 */
async function renderHistoricalTableFinal(containerElement, cautelas, titulo) {
    
    // Limpa o container e remove o loading
    if (containerElement) containerElement.innerHTML = '';
    
    if (cautelas.length === 0) {
        containerElement.innerHTML = `<div class="op-card" style="padding:20px; text-align:center; color:#999;">Nenhuma cautela conclu√≠da encontrada neste escopo.</div>`;
        return;
    }

    let tableHtml = `
        <div class="op-card" style="padding:15px; margin-bottom:0;">
            <h4 style="margin-top:0; color:#800020; border-bottom:1px solid #eee; padding-bottom:5px;">
                <i class="fas fa-archive"></i> ${titulo} (${cautelas.length} registros)
            </h4>
            <table class="ca-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Dest. Original</th>
                        <th>Emitente</th>
                        <th>Local Origem</th>
                        <th>Data Conclus√£o</th>
                        <th>Itens</th>
                    </tr>
                </thead>
                <tbody>
    `;

    cautelas.forEach(cautela => {
        const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
        const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        
        tableHtml += `
            <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                <td data-label="ID"><strong>${cautela.cautela_id}</strong></td>
                <td data-label="Dest. Original">${cautela.destinatario_original || 'N/A'}</td>
                <td data-label="Emitente">${cautela.emitente}</td>
                <td data-label="Local Origem">${cautela.local_origem || 'N/D'}</td>
                <td data-label="Conclus√£o">${dataFinal}</td>
                <td data-label="Itens">${itensCount} itens</td>
            </tr>
        `;
    });

    tableHtml += `
                </tbody>
            </table>
        </div>
    `;

    containerElement.innerHTML = tableHtml;
}        
        function renderHistoricalGroup(title, cautelas, groupId) {
    // Retorna string vazia se n√£o houver dados
    if (cautelas.length === 0) {
        return ''; 
    }
    
    // Constr√≥i a estrutura do grupo (que pode ser uma aba ou uma se√ß√£o)
    let html = `
        <div class="historical-group" id="${groupId}">
            <h4 class="group-title-historical"><i class="fas fa-history"></i> ${title} (${cautelas.length})</h4>
            <div class="table-responsive-container">
            <table class="cautelas-table" id="${groupId}-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Emitente</th>
                        <th>Dest. Atual</th>
                        <th>Data Conclus√£o</th>
                        <th>Itens</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Adiciona as linhas da tabela
    cautelas.forEach(cautela => {
        // Reutiliza a fun√ß√£o de renderiza√ß√£o de linha que j√° est√° ajustada
        html += renderCautelaRow(cautela); 
    });
    
    html += `
                </tbody>
            </table>
            </div>
        </div>
    `;
    return html;
}
        async function getLastConferente(localOrigem) {
            if (!localOrigem) return "N/D";
    
    try {
        // Busca o resultado de confer√™ncia mais recente para o local de origem.
        const snap = await db.collection(COLECAO_RESULTADOS)
            .where('local', '==', localOrigem)
            .orderBy('timestamp', 'desc')
            .limit(1)
            .get();
            
        if (!snap.empty) {
            const lastResult = snap.docs[0].data();
            // Retorna o nome completo do conferente encontrado.
            return lastResult.conferente || "N/D";
        }
        
        return "N/D (Nenhum hist√≥rico recente)";
    } catch (e) {
        console.error("Erro ao buscar √∫ltimo conferente:", e);
        return "N/D (Erro de consulta)";
    }
}
            async function iniciarDevolucaoCautela(cautelaId, destinatario) {
    const btnDevolver = document.getElementById('btn-devolver-cautela');
    
    // 1. Oculta o modal e o bot√£o de devolu√ß√£o imediatamente para evitar cliques duplos.
    document.getElementById('cautelaDetailsModal').style.display = 'none'; 
    if (btnDevolver) btnDevolver.disabled = true;

    try {
        const militarCompleto = currentUserData.nome_militar_completo;
        const cautelaRef = db.collection('cautelas_abertas').doc(cautelaId);

        // üõë CR√çTICO: Executa a Transa√ß√£o no Firebase para mudar o status
        await db.runTransaction(async (transaction) => {
            const cautelaDoc = await transaction.get(cautelaRef);

            if (!cautelaDoc.exists || cautelaDoc.data().status !== 'RECEBIDA') {
                throw new Error("Cautela n√£o encontrada ou n√£o est√° no status 'RECEBIDA'.");
            }
            
            // 1. A√ß√£o: Mudar o status da cautela para DEVOLU√á√ÉO.
            transaction.update(cautelaRef, { 
                status: 'DEVOLU√á√ÉO', // Novo status de tr√¢nsito
                timestamp_devolucao_iniciada: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Quem est√° enviando/revertendo (Usu√°rio A)
                reversor: currentUserData.nome_guerra, 
                militar_completo_reversor: militarCompleto,
                
                // Quem √© o novo destinat√°rio/receptor da devolu√ß√£o (Dono Provis√≥rio)
                destinatario: destinatario // üõë ATUALIZA o campo DESTINATARIO para ser o Dono Provis√≥rio
            });
        }); // Fim da Transa√ß√£o

        // 2. Feedback para o Usu√°rio A e atualiza√ß√£o da UI
        alert(`‚úÖ Cautela enviada para devolu√ß√£o a ${destinatario}. Ela aparecer√° na lista 'Cautelas a Receber' dele.`);
        
        // Recarrega a lista de Cautelas Ativas para remover o item que acabou de ser devolvido.
        showCautelasDashboard('Cautelas Ativas'); 
        
    } catch (error) {
        console.error("Erro CR√çTICO ao iniciar devolu√ß√£o:", error);
        alert(`Erro ao iniciar devolu√ß√£o. Nenhum dado foi alterado. Erro: ${error.message}`);
        if (btnDevolver) btnDevolver.disabled = false;
    }
}
       
function renderHistoricoTable(containerId, cautelas) {
    const container = document.getElementById(containerId);
    const loading = document.getElementById('loading-historico');

    if (!container) return; 

    // Oculta loading e garante que o container esteja vis√≠vel
    if (loading) loading.style.display = 'none';

    if (cautelas.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px;">Nenhuma cautela encontrada neste hist√≥rico.</p>';
        return;
    }

    // Cria a estrutura da tabela
    let html = `
        <table class="ca-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Dest. Original</th>
                    <th>Emitente</th>
                    <th>Data Final</th>
                    <th>Itens</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
    `;

    cautelas.forEach(cautela => {
        const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
        const dataFinal = cautela.timestamp_conclusao ? cautela.timestamp_conclusao.toDate().toLocaleDateString('pt-BR') : 'N/D';
        
        // Define o destinat√°rio original de forma segura (para esta aba)
        const destOriginal = cautela.destinatario_original || 'N/A';
        const badgeText = 'CONCLU√çDA';
        const badgeClass = 'badge-solucao';

        html += `
            <tr onclick="showCautelaDetails('${cautela.cautela_id}')" style="cursor:pointer;">
                <td><strong>${cautela.cautela_id}</strong></td>
                <td>${destOriginal}</td>
                <td>${cautela.emitente}</td>
                <td>${dataFinal}</td>
                <td>${itensCount} itens</td>
                <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

        function atualizarQuadroModal() {
    const postoSelect = document.getElementById('edit-user-posto');
    const quadroSelect = document.getElementById('edit-user-quadro');
    const posto = postoSelect.value;
    
    // Limpa o select do quadro e desabilita
    quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    quadroSelect.disabled = true;

    // Se o posto for vazio (ou a op√ß√£o "Selecione"), sai
    if (!posto) return;

    // Mapeamento dos postos para a categoria (Oficiais, Pra√ßas, SD)
    let quadros = [];
    const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1¬∫ TEN', '2¬∫ TEN'];
    const pracas = ['ST', '1¬∫ SGT', '2¬∫ SGT', '3¬∫ SGT', 'CB'];

    if (oficiais.includes(posto)) {
        quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
    } else if (pracas.includes(posto)) {
        quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
    } else if (posto === 'SD') {
        // SD tem um quadro fixo e n√£o permite altera√ß√£o
        quadros = ['QPCBM'];
        quadroSelect.disabled = true;
    }

    if (quadros.length > 0) {
        quadroSelect.disabled = (posto === 'SD'); // Desabilita apenas se for SD
        
        // Preenche as op√ß√µes do quadro
        quadros.forEach(quadro => {
            const option = document.createElement('option');
            option.value = quadro;
            option.textContent = quadro;
            quadroSelect.appendChild(option);
        });
        
        // Tenta pr√©-selecionar a primeira op√ß√£o se houver apenas uma (caso do SD)
        if(quadros.length === 1) {
            quadroSelect.value = quadros[0];
        }
    }
}
        function formatarCPF(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que n√£o for d√≠gito
    value = value.substring(0, 11); // Limita a 11 d√≠gitos

    if (value.length > 9) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
    } else if (value.length > 3) {
        value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{3})$/, '$1');
    }
    input.value = value;
}

function formatarMatricula(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que n√£o for d√≠gito
    value = value.substring(0, 10); // Limita a 10 d√≠gitos

    if (value.length > 7) {
        value = value.replace(/^(\d{7})(\d{3})$/, '$1-$2');
    }
    input.value = value;
}

function formatarTelefone(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que n√£o for d√≠gito
    value = value.substring(0, 11); // Limita a 11 d√≠gitos (DDD + 9 d√≠gitos)

    if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
    } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{2})$/, '($1)');
    }
    input.value = value;
}
        function filtrarUsuarios() {
    const searchInput = document.getElementById('user-search-input');
    const searchTerm = searchInput.value.trim().toUpperCase();
    const tbody = document.getElementById('users-table-body');
    
    tbody.innerHTML = '';
    
    const filteredUsers = allUsersData.filter(u => {
        // Filtra pelo Nome de Exibi√ß√£o completo
        const nomeExibicao = u.nome_militar_completo || '';
        return nomeExibicao.includes(searchTerm);
    });

    if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Nenhum usu√°rio encontrado com o nome digitado.</td></tr>';
        return;
    }

    filteredUsers.forEach(u => {
        const docId = u.id; 
        const tr = document.createElement('tr');
        
        const isCurrentUser = firebase.auth().currentUser.uid === docId; 
        
        const telefone = u.telefone_contato || 'N/D';
        const whatsappUrl = u.whatsapp_url || '#';
        const rawTelefone = telefone.replace(/\D/g, '');
        const numeroSemDDD = (rawTelefone.length === 11) ? rawTelefone.substring(2) : rawTelefone; 

        const whatsappLink = `<a href="${whatsappUrl}" target="_blank" style="margin-left: 5px; color: #25D366;"><i class="fab fa-whatsapp"></i></a>`;
        const dialLink = (rawTelefone.length >= 8) ? 
            `<a href="tel:${numeroSemDDD}" class="btn-dial-mobile" style="margin-left: 5px; color: #2c7399;"><i class="fas fa-phone"></i></a>` : '';
        
        // CORRE√á√ÉO AQUI: Adi√ß√£o dos atributos data-label em cada c√©lula <td>
        tr.innerHTML = `
            <td data-label="Militar:">${u.nome_militar_completo}</td>
            <td data-label="Contato:">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span>${telefone}</span>
            ${whatsappLink}
            ${dialLink} 
        </div>
    </td>
            <td data-label="Perfil:"><span class="role-badge role-${u.role}">${u.role}</span></td>
            <td data-label="Unidade:">${u.unidade}</td>
            <td data-label="A√ß√µes:"><button class="btn-modern-action btn-edit" style="padding:4px 8px; font-size:0.8em;" onclick="abrirGestaoUsuario('${docId}')" ${isCurrentUser ? 'disabled' : ''}>Editar</button></td>`;
        tbody.appendChild(tr);
    });
}
        function setupCadastroMilitarLogic() {
    // 1. M√°scaras
    const cpfInput = document.getElementById('new-user-cpf');
    const matriculaInput = document.getElementById('new-user-matricula');
    const telefoneInput = document.getElementById('new-user-telefone');

    if (cpfInput) cpfInput.addEventListener('input', () => formatarCPF(cpfInput));
    if (matriculaInput) matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
    if (telefoneInput) telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));

    // 2. L√≥gica de Depend√™ncia Posto/Quadro (Adaptada da fun√ß√£o atualizarQuadroModal)
    const postoSelect = document.getElementById('new-user-posto');
    const quadroSelect = document.getElementById('new-user-quadro');

    if (postoSelect && quadroSelect) {
        postoSelect.addEventListener('change', () => {
            // Replicar a l√≥gica de atualiza√ß√£o do Quadro (Posto->Quadro)
            atualizarQuadroCad(postoSelect, quadroSelect);
        });
    }
}

/**
 * L√≥gica de depend√™ncia Posto/Quadro ADAPTADA para o novo formul√°rio Cadastrar Militar.
 */
    function atualizarQuadroCad(postoSelect, quadroSelect) {
        const posto = postoSelect.value;
        quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
        quadroSelect.disabled = true;
        if (!posto) return;
        let quadros = [];
        const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1¬∫ TEN', '2¬∫ TEN'];
        const pracas = ['ST', '1¬∫ SGT', '2¬∫ SGT', '3¬∫ SGT', 'CB'];
        if (oficiais.includes(posto)) {
            quadros = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
        } else if (pracas.includes(posto)) {
            quadros = ['QPCBM', 'QPSBM', 'QEPBM'];
        } else if (posto === 'SD') {
            quadros = ['QPCBM'];
            quadroSelect.disabled = true;
        }
        if (quadros.length > 0) {
            quadroSelect.disabled = (posto === 'SD');
            quadros.forEach(quadro => {
                const option = document.createElement('option');
                option.value = quadro;
                option.textContent = quadro;
                quadroSelect.appendChild(option);
            });   
            if(quadros.length === 1) {
                quadroSelect.value = quadros[0];
            }
        }
    }
    async function carregarPostosServicoSelect(elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;

    select.innerHTML = '<option value="" disabled selected>Carregando Postos...</option>';

    try {
        // Usa a busca comprovadamente funcional
        const docRef = db.collection('config_geral').doc('postos');
        const doc = await docRef.get();

        // Usa a extra√ß√£o segura de dados (Postos Visuais usa esta mesma l√≥gica)
        if (doc.exists) {
            const postos = doc.data().lista || []; // Pega o array 'lista'
            
            select.innerHTML = '<option value="" disabled selected>Selecione o Posto de Servi√ßo</option>';
            
            postos.sort().forEach(posto => {
                const option = document.createElement('option');
                option.value = posto;
                option.textContent = posto;
                select.appendChild(option);
            });
            
        } else {
            select.innerHTML = '<option value="" disabled selected>Lista de Postos n√£o encontrada.</option>';
        }

    } catch(e) {
        // Verifique o console (F12) se esta mensagem aparecer
        console.error("Erro CR√çTICO ao carregar Postos de Servi√ßo:", e); 
        select.innerHTML = '<option value="" disabled selected>Erro ao carregar</option>';
    }
}
        async function carregarUnidadesSelect(elementId = 'new-user-unit') {
        const select = document.getElementById(elementId);
        if (!select) return;
        select.innerHTML = '<option value="">Carregando...</option>';
        try {
            // Busca o documento 'unidades' dentro de 'config_geral'
            const docRef = db.collection('config_geral').doc('unidades');
            const doc = await docRef.get();
            let unidades = [];
            // Usa a extra√ß√£o segura de dados
            if (doc.exists) {
                unidades = doc.data().lista || []; // Pega o array 'lista'
            }

            // Preenche o dropdown
            select.innerHTML = '<option value="" disabled selected>Selecione a Unidade</option>';
            unidades.sort().forEach(unidade => {
                const option = document.createElement('option');
                option.value = unidade;
                option.textContent = unidade;
                select.appendChild(option);
            });

            // --- L√ìGICA DE PERMISS√ÉO PARA GESTOR ---
            const isGestor = currentUserData && currentUserData.role === 'gestor';
            const gestorUnidade = currentUserData ? currentUserData.unidade : null;
        
            if (isGestor && gestorUnidade) {
                select.value = gestorUnidade;
                select.disabled = true;
                select.style.backgroundColor = '#f0f0f0';
            } else {
                select.disabled = false;
                select.style.backgroundColor = '';
            }

        } catch(e) {
            console.error("Erro CR√çTICO ao carregar unidades:", e);
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }
        //FUN√á√ïES PARA MELHORIA DAS FILTRAGENS POR STATUS E PERFIL NO MENI GESTAO DE CAUTELAS
        async function getUnitListIds() {
    // 1. Obter a unidade do usu√°rio logado
    const userUnidade = currentUserData.unidade || '';
    if (!userUnidade) {
        console.warn("Unidade do usu√°rio n√£o definida. Retornando vazio.");
        return [];
    }

    // 2. Buscar no documento 'config_geral/rotas'
    try {
        const rotasDoc = await db.collection('config_geral').doc('rotas').get();
        const rotas = rotasDoc.data() || {};
        const unitListIds = [];

        for (const [id, info] of Object.entries(rotas)) {
            // Se o nome da unidade na rota for igual √† unidade do usu√°rio
            if (info.unidade === userUnidade && info.ativo !== false) { 
                unitListIds.push(id);
            }
        }
        return unitListIds;

    } catch (error) {
        console.error("Erro ao obter IDs de listas da unidade:", error);
        return [];
    }
}
        // Localiza√ß√£o: Fun√ß√£o queryCautelas (Aproximadamente linha 1600 do arquivo completo)

async function queryCautelas(statusArray, role, user, field = null, type = 'personal') {
    let query = db.collection('cautelas_abertas');

    // üõë 1. Filtro por Status (Regra Pessoal e Admin/Global)
    if (type === 'personal') {
        // Pessoal sempre usa o filtro de status 'in'
        if (statusArray.length > 0) {
            query = query.where('status', 'in', statusArray);
        } else {
            return [];
        }
    } else if (role === 'admin' && type === 'unit') {
        // Admin global tamb√©m usa o filtro de status 'in' (n√£o h√° conflito aqui)
        if (statusArray.length > 0) {
            query = query.where('status', 'in', statusArray);
        } else {
            return [];
        }
    }
    // NOTA: Para Gestor Monitoramento ('gestor' + 'unit'), o filtro de status √© MANUAL (na mem√≥ria)
    // para evitar o duplo 'in'.

    // 2. Filtros Espec√≠ficos por Perfil/Tipo
    const militarCompleto = user.nome_militar_completo;

    if (role === 'gestor' && type === 'unit') {
        // üõë CORRE√á√ÉO DUPLO 'IN' PARA GESTOR: Aplica somente o filtro de Unidade/Lista üõë
        const unitListIds = await getUnitListIds();
        
        if (unitListIds.length > 0 && unitListIds.length <= 10) {
            // Aplica o filtro de Unidade/Lista usando o √∫nico 'in' permitido.
            query = query.where('local_origem_id', 'in', unitListIds);
            
        } else {
            // Se o gestor n√£o tem listas ou excedeu o limite, retorna uma consulta vazia.
            return []; 
        }

    } else if (type === 'personal') {
        // Filtra por Destinat√°rio, Emitente, etc. (Regra j√° existente)
        if (field === 'destinatario') {
            query = query.where('destinatario', '==', militarCompleto);
        } else if (field === 'emitente') {
            query = query.where('emitente', '==', militarCompleto);
        } else if (field === 'receptor_final_completo') {
             query = query.where('receptor_final_completo', '==', militarCompleto);
        } else if (field === 'destinatario_original') {
             query = query.where('destinatario_original', '==', militarCompleto);
        } else if (field === 'militar_completo_reversor') {
            query = query.where('militar_completo_reversor', '==', militarCompleto);
        }
    }
    
    // 3. Execu√ß√£o e Ordena√ß√£o (Decrescente por data de emiss√£o)
    try {
        const snapshot = await query.orderBy('timestamp_emissao', 'desc').get();
        let cautelas = [];
        snapshot.forEach(doc => {
            const cautela = { id: doc.id, ...doc.data() };
            
            // üõë GESTOR MONITORAMENTO (UNIT): Filtra por status na MEM√ìRIA üõë
            if (role === 'gestor' && type === 'unit') {
                if (statusArray.includes(cautela.status)) {
                    cautelas.push(cautela);
                }
            } else {
                // Outros perfis (Admin, Pessoal) j√° aplicaram o filtro no Query.
                cautelas.push(cautela);
            }
        });
        return cautelas;
        
    } catch (error) {
        console.error("Erro na consulta de cautelas:", error);
        throw error;
    }
}
    /**
 * Renderiza uma linha de tabela (<tr>) para a cautela, adicionando data-labels para responsividade mobile.
 */
function renderCautelaRow(cautela) {
    const clickAction = `showCautelaDetails('${cautela.cautela_id}')`;

    const itensCount = cautela.itens ? cautela.itens.reduce((sum, item) => sum + item.quantidade, 0) : 0;
    
    const dataEmissao = cautela.timestamp_emissao && typeof cautela.timestamp_emissao.toDate === 'function'
                                ? cautela.timestamp_emissao.toDate().toLocaleDateString('pt-BR')
                                : 'N/A';
                                
    const status = cautela.status || 'N/A';
    let badgeClass = 'badge-cautela';
    let badgeText = 'N/D'; 

    if (status === 'RECEBIDA') {
        badgeClass = 'badge-solucao'; 
        badgeText = 'RECEBIDA';
    } else if (status === 'ABERTA') {
        badgeClass = 'badge-cautela';
        badgeText = 'ABERTA';
    } else if (status === 'DEVOLU√á√ÉO') {
        badgeClass = 'badge-pendente'; 
        badgeText = 'EM DEVOLU√á√ÉO';
    } else if (status === 'CONCLU√çDA') { 
        badgeClass = 'badge-concluida'; 
        badgeText = 'CONCLU√çDA';
    }
    
    return `
        <tr onclick="${clickAction}">
            <td data-label="ID"><strong>${cautela.cautela_id}</strong></td>
            <td data-label="Destinat√°rio">${cautela.destinatario}</td>
            <td data-label="Emiss√£o">${dataEmissao}</td>
            <td data-label="Origem">${cautela.local_origem}</td>
            <td data-label="Itens">${itensCount} itens</td>
            <td data-label="Status"><span class="status-badge ${badgeClass}">${badgeText}</span></td>
        </tr>
    `;
}
        
    </script>
</body>
</html>
