<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Conferência de Cautela</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: Arial, sans-serif;
            background-color: #f4f4f9; color: #333; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 90px; padding-top: 60px; box-sizing: border-box;
        }
        .container { background-color: #fff; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 95%; max-width: 700px; margin-bottom: 20px; text-align: center; box-sizing: border-box;
        }
        .loading-message { margin-top: 50px; font-size: 1.2em; color: #800020; font-weight: bold;
        } 
        h1 { color: #d90f23; margin-bottom: 3px; font-size: 1.6em; padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; }
        .subtitulo { font-size: 0.9em; color: #666;
            margin-bottom: 20px; font-weight: 600; text-transform: uppercase; }
        .user-info-display { font-size: 0.8em; color: #333;
            text-align: left; margin-top: -10px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee;
        }
        
        /* SETORES E ITENS (Mantendo o design do Conferência App) */
        .setor-header { background-color: #2c7399; /* Azul para diferenciar da Conferência Mestra */
            color: white; padding: 12px 15px; margin-top: 20px; border-radius: 6px; cursor: pointer; text-align: left; font-weight: bold; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;
        }
        .setor-info { display: flex; align-items: center; gap: 10px;
        }
        .setor-status { background-color: #d90f23; color: white; font-size: 0.9em; padding: 3px 8px;
            border-radius: 4px; min-width: 35px; text-align: center; transition: background-color 0.3s; } .setor-status.ok { background-color: #1b8a3e;
        }
        .setor-content { padding: 10px 0; max-height: 0; overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: #fff; border-left: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0;
        } .setor-content.expanded { max-height: 5000px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px;
        }
        .arrow { font-size: 1.2em; transition: transform 0.4s;
        }
        
        .item-conferencia { border: 1px solid #e0e0e0;
            border-left: 5px solid #ccc; border-radius: 6px; padding: 10px; margin: 10px; background-color: #fafafa; transition: border-left-color 0.3s ease, background-color 0.3s ease;
        }
        .item-conferencia.status-ok { border-left-color: #1b8a3e; background-color: #f0fff0;
        }
        .item-conferencia.status-alert { border-left-color: #d90f23; background-color: #fff0f0;
        }
        .item-conferencia.status-existing-alert { border-left-color: #ff9800; background-color: #fff8e1;
        }
        .item-conferencia.status-admin-response { border-left-color: #2196F3; background-color: #E3F2FD;
        } 
        
        .item-header { display: flex;
            flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap;
        }
        .item-label { font-weight: bold; color: #333; flex-grow: 1; margin-right: 10px; text-align: left;
            font-size: 0.95em; width: 100%; }
        .item-quantidade { font-size: 0.9em; color: #800020; font-weight: bold;
            flex-shrink: 0; margin-top: 5px; }
        .status-icon { font-weight: bold; font-size: 0; padding: 0;
            width: 18px; height: 18px; line-height: 18px; background-color: transparent; border: 1px dashed #aaa; display: inline-block; margin-right: 5px; vertical-align: middle;
        }
        .status-icon.ok { background-color: #1b8a3e; border: none; } .status-icon.ok:after { content: '✓';
            font-size: 12px; line-height: 18px; color: white; display: block; text-align: center;
        }
        .status-icon.alert { background-color: #d90f23; border: none; } .status-icon.alert:after { content: 'C/A';
            font-size: 10px; line-height: 18px; color: white; display: block; text-align: center;
        }
        
        /* BOTÕES DE CAUTELA (Adaptado de Conferência App) */
        .item-options { display: flex;
            justify-content: flex-end; margin-top: 5px; gap: 10px; padding-top: 5px; border-top: 1px solid #f0f0f0;
        }
        .action-button { padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s, color 0.2s, border-color 0.2s; background-color: #f0f0f0; color: #333;
        }
        .action-button.active.sa-ok { background-color: #1b8a3e; color: white; border-color: #1b8a3e;
        } .action-button.active.ca-alert { background-color: #d90f23; color: white; border-color: #d90f23; }
        
        .pendencia-alert-box { font-size: 0.85em;
            margin-top: 5px; display: block; text-align: left; border-left: 3px solid #d90f23; padding-left: 8px; background-color: #fff0f0; padding: 5px; transition: all 0.3s;
        }
        .pendencia-actions { display: flex;
            gap: 10px; justify-content: flex-end; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px;
        }
        .btn-manter, .btn-acrescentar { background-color: #e0e0e0; border: 1px solid #ccc; color: #333; font-size: 0.8em;
            padding: 5px 10px; cursor: pointer; border-radius: 4px; 
        }
        .tombamento-obs-container, .alteracao-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #d90f23;
            display: none; text-align: left; 
        }
        .tombamento-obs-container textarea, .alteracao-container textarea { width: 100%;
            padding: 8px; border-radius: 4px; border: 1px solid #d90f23; box-sizing: border-box; font-size: 0.85em; resize: vertical; min-height: 40px; margin-bottom: 5px;
        }
        .btn-salvar-alteracao { background-color: #800020; color: white; font-weight: bold; border: none;
            padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%; transition: background-color 0.3s; font-size: 0.85em;
        }
        
        #btn-finalizar { background-color: #2c7399; /* Azul para Devolução/Recebimento */
            color: white; font-weight: bold; border: none; padding: 15px 10px; border-radius: 6px; width: 100%; cursor: pointer; transition: background-color 0.3s ease;
            margin-top: 30px; font-size: 1.1em; box-shadow: 0 4px 8px rgba(44, 115, 153, 0.4);
        }
        #btn-finalizar:disabled { background-color: #999; cursor: not-allowed; box-shadow: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="sigma_utils.js"></script> 
</head>
<body>
    <div class="container">
        <h1 id="titulo-conferencia">Conferência de Cautela</h1>
        <p class="subtitulo" id="local-posto-info">Carregando Cautela...</p>
        <p id="militar-info" class="user-info-display">Carregando dados do destinatário...</p>
        <div id="loading-message" class="loading-message">Inicializando fluxo de cautela...</div>
        <div id="main-content" style="display: none;">
            
            <p style="text-align: center; color:#800020; font-weight:bold;" id="tipo-fluxo-info">
                A conferência atual registra o recebimento dos materiais da CAUTELA.
            </p>

            <button id="btn-finalizar" onclick="finalizarRecebimentoCautela()" disabled>
                <i class="fas fa-check-double"></i> FINALIZAR RECEBIMENTO (0/X ITENS)
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Variáveis globais do app (copiadas do conferencia_app.html.txt)
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const LISTA_ID = urlParams.get('id'); // ID da Lista de origem (opcional)
        const CAUTELA_ID = urlParams.get('cautelaId'); // ID da cautela (principal)
        const VIEW_TYPE = urlParams.get('view'); // Tipo de visualização: 'pdf', 'devolucao'
        const DEVOLUCAO_TYPE = urlParams.get('tipo'); // 'FINALIZADA' ou 'TRANSFERENCIA'
        const NOVO_DESTINATARIO = urlParams.get('novoDestinatario'); // Nome do novo destinatário
        
        const COLECAO_CAUTELAS = 'cautelas_abertas';
        const COLECAO_CAUTELAS_HIST = 'cautelas_historico';
        const COLECAO_LISTAS = 'listas_conferencia';
        
        let dadosConferencia = [];
        window.infoLocal = { nome: '', posto: '' }; 
        window.itemStatus = {};
        window.setorIds = [];
        let cautelaDadosCompletos = null; // Armazena o documento completo da cautela
        
        // --- HELPERS E CONFIGURAÇÃO DE RASCUNHO ---
        
        function getUrlParameter(n) { return (new URLSearchParams(window.location.search)).get(n) || ''; }
        window.userInfo = { postoGraduacao: getUrlParameter('posto_grad') || "ND", quadro: getUrlParameter('quadro_mil') || "ND", nomeGuerra: getUrlParameter('nome_guerra') || "ND" };
        
        // Esta função usa o getStorageKey do sigma_utils.js
        function getStorageKey() { 
            const lId = CAUTELA_ID; // Usamos o CAUTELA_ID como base do rascunho
            const uGuerra = userInfo.nomeGuerra;
            
            // Verifica se a função de utilidade foi carregada
            if (typeof getStorageKey === 'function') {
                return window.getStorageKey(lId, uGuerra);
            }
            return `sigma_draft_${lId}_${uGuerra.toUpperCase()}`;
        }
        
        // ==========================================
        // FUNÇÕES DE UTILIDADE E RENDERIZAÇÃO
        // ==========================================

        function formatarDataSimples(timestamp) {
            if (!timestamp) return "";
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR');
        }

        function updateHeaderInfo() { 
            const el = document.getElementById('militar-info');
            const role = (VIEW_TYPE === 'devolucao' ? 'Conferente Devolução' : 'Recebedor/Conferente');
            if(el) el.innerHTML = `<strong>${role}:</strong> ${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}<br><strong>Data/Hora:</strong> ${new Date().toLocaleString()}`; 
        }

        function updateOverallStatus() { 
            let total = 0, completed = 0;
            document.querySelectorAll('.setor').forEach(s => { 
                total += parseInt(s.dataset.totalItems || 0); 
                completed += parseInt(s.querySelector('.setor-status').dataset.completed || 0); 
            });
            const btn = document.getElementById('btn-finalizar'); 
            if(btn) {
                const action = (VIEW_TYPE === 'devolucao' ? 'DEVOLUÇÃO' : 'RECEBIMENTO');
                btn.textContent = `FINALIZAR ${action} (${completed}/${total} ITENS)`;
                if (total > 0 && completed >= total) {
                    btn.disabled = false;
                    btn.style.backgroundColor = '#1b8a3e'; 
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.backgroundColor = '#2c7399'; 
                    btn.style.cursor = 'not-allowed';
                }
            }
        }

        function updateSetorStatus(setorEl) { 
            const items = setorEl.querySelectorAll('.item-conferencia');
            let completed = 0, total = 0; 
            items.forEach(item => { 
                if (item.dataset.type === 'single') { 
                    total++; const s = window.itemStatus[item.dataset.id]?.status; 
                    if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                } else { 
                    const tombs = item.querySelectorAll('.tombamento-container'); 
                    tombs.forEach(t => { 
                        total++; const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                        if (s === 'S/A' || s === 'C/A' || s === 'KEEP') completed++;
                    }); 
                } 
            });
            setorEl.dataset.totalItems = total; 
            const st = setorEl.querySelector('.setor-status'); 
            st.dataset.completed = completed;
            if (completed === total && total > 0) { st.textContent = 'OK'; st.classList.add('ok');
            } 
            else { st.textContent = `${completed}/${total}`; st.classList.remove('ok');
            } 
        }

        function updateItemMainStatusDisplay(item) { 
            if (item.dataset.type === 'single') return;
            const tombs = item.querySelectorAll('.tombamento-container'); let conf = 0, alt = 0;
            tombs.forEach(t => { 
                const s = window.itemStatus[`${item.dataset.id}-${t.dataset.tomb}`]?.status; 
                if (s === 'S/A' || s === 'C/A' || s === 'KEEP') { conf++; if (s === 'C/A' || s === 'KEEP') alt++; } 
            });
            const icon = item.querySelector('.status-icon'); item.className = 'item-conferencia item-has-tombamentos'; icon.className = 'status-icon';
            if (conf === tombs.length) { 
                if (alt > 0) { icon.classList.add('alert');
                    item.classList.add('status-alert'); } 
                else { icon.classList.add('ok');
                    item.classList.add('status-ok'); } 
            } 
        }

        function toggleSetor(header) { 
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.arrow'); 
            if (content.classList.contains('expanded')) { content.classList.remove('expanded'); arrow.textContent = '►';
            } 
            else { document.querySelectorAll('.setor-content.expanded').forEach(c=>{c.classList.remove('expanded'); c.previousElementSibling.querySelector('.arrow').textContent='►';}); content.classList.add('expanded');
                arrow.textContent = '▼'; } 
        }

        function checkSetorCompletion(currentSetor, currentItemId) { 
            const total = parseInt(currentSetor.dataset.totalItems);
            const comp = parseInt(currentSetor.querySelector('.setor-status').dataset.completed); 
            if (comp >= total) { autoAdvanceSetor(currentSetor.dataset.id); } else { focusNextItem(currentItemId);
            }
        }

        function autoAdvanceSetor(sid) { 
            const s = document.querySelector(`.setor[data-id="${sid}"]`);
            if (s) toggleSetor(s.querySelector('.setor-header')); 
            const idx = window.setorIds.indexOf(sid); const nextId = window.setorIds[idx + 1];
            if (nextId) { 
                const next = document.querySelector(`.setor[data-id="${nextId}"]`);
                if (next) { const h = next.querySelector('.setor-header'); toggleSetor(h); next.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } 
            } 
        }
        
        // --- FUNÇÕES DE RASCUNHO ---
        function salvarRascunho() { 
            try { 
                localStorage.setItem(getStorageKey(), JSON.stringify({ timestamp: Date.now(), status: window.itemStatus }));
            } catch (e) {} 
        }
        
        // --- FUNÇÕES DE FORMATAÇÃO DE HISTÓRICO (COPIADAS) ---
        const gerarLinhasFormatadas = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            const linhas = [];
            if (adminStatus) linhas.push(`[${adminStatus.toUpperCase()}] (Admin): ${adminObs}`);
            const separator = ' | + NOVA: ';
            if (textoBruto.includes(separator)) {
                const partes = textoBruto.split(separator);
                partes.forEach(p => {
                    p = p.trim();
                    const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
                    if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
                    else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
                });
            } else {
                const p = textoBruto.trim();
                const regex = /^"(.*)" \(Por: (.*) em (.*)\)$/; const match = p.match(regex);
                if (match) linhas.push(`Por: ${match[2]} em ${match[3]}: "${match[1]}"`);
                else linhas.push(`Por: ${autorAtual} em ${dataAtual}: "${p}"`);
            }
            return linhas;
        };
        const gerarHtmlVisual = (textoBruto, autorAtual, dataAtual, adminStatus, adminObs) => {
            const linhas = gerarLinhasFormatadas(textoBruto, autorAtual, dataAtual, adminStatus, adminObs);
            let html = '<ul class="lista-pendencias">';
            linhas.forEach(l => { if (l.includes('(Admin):')) { const parts = l.split('): ');
                html += `<li><span class="texto-admin">⚠️ ${parts[0]}):</span> Resp: ${parts[1]}</li>`; } else { html += `<li class="linha-obs">• ${l}</li>`; } });
            html += '</ul>';
            return html;
        };
        const montarHistoricoLinear = (obsAnterior, novoTexto, autorAnterior, dataAnterior) => {
            const separator = ' | + NOVA: ';
            
            if (obsAnterior.includes(separator)) {
                let partes = obsAnterior.split(separator);
                let ultimaParte = partes.pop(); 
                let resto = partes.join(separator); 
                let ultimaAssinada = `"${ultimaParte}" (Por: ${autorAnterior} em ${dataAnterior})`;
                return `${resto}${separator}${ultimaAssinada}${separator}${novoTexto}`;
            } else { 
                return `${obsAnterior}${separator}${novoTexto}`; 
            }
        };
        
        // --- FUNÇÕES DE AÇÃO (COPIADAS) ---
        function setItemStatus(btn, status) { 
            const item = btn.closest('.item-conferencia');
            const setor = btn.closest('.setor'); 
            item.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
            item.querySelector('.descricao-salva').style.display='none'; item.querySelector('.alteracao-container').style.display='none'; 
            const pb=item.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if(status==='ok'){item.className='item-conferencia status-ok'; item.querySelector('.status-icon').className='status-icon ok';
                window.itemStatus[item.dataset.id]={status:'S/A',obs:''};} 
            else {item.className='item-conferencia status-alert'; item.querySelector('.status-icon').className='status-icon alert'; item.querySelector('.alteracao-container').style.display='block'; window.itemStatus[item.dataset.id]={status:'PENDING_CA',obs:''};
                item.querySelector('textarea').focus();} 
            salvarRascunho(); updateSetorStatus(setor); updateOverallStatus(); if(status==='ok')checkSetorCompletion(setor,item.dataset.id);
        }

        function setTombamentoStatus(btn, status) { 
            const tomb = btn.closest('.tombamento-container');
            const item = btn.closest('.item-conferencia'); const setor = btn.closest('.setor'); const uid=`${item.dataset.id}-${tomb.dataset.tomb}`; 
            tomb.querySelectorAll('.action-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
            tomb.querySelector('.tombamento-obs-container').style.display='none'; tomb.querySelector('.tombamento-descricao-salva').style.display='none'; 
            const pb=tomb.querySelector('.pendencia-alert-box'); if(pb)pb.style.display='none'; 
            if(status==='ok'){window.itemStatus[uid]={status:'S/A',obs:''};
                updateItemMainStatusDisplay(item);} 
            else {tomb.querySelector('.tombamento-obs-container').style.display='block'; window.itemStatus[uid]={status:'PENDING_CA',obs:''}; tomb.querySelector('textarea').focus();
                updateItemMainStatusDisplay(item);} 
            salvarRascunho(); updateSetorStatus(setor); updateOverallStatus(); if(status==='ok')checkSetorCompletion(setor,item.dataset.id);
        }
        
        function salvarItem(btn) { 
            const item=btn.closest('.item-conferencia');
            const obs=item.querySelector('textarea').value.trim(); 
            const hist=item.querySelector('.historico-fixo'); 
            let final=obs; 

            const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
            const now=formatarDataSimples(new Date()); 

            if(hist && hist.dataset.meta) {
                if(obs.length < 3) return alert("Digite a alteração.");
                const meta=JSON.parse(decodeURIComponent(hist.dataset.meta)); 
                final=montarHistoricoLinear(meta.obs, obs, meta.autor, meta.data);
            } else {
                if(obs.length < 3) return alert("Descreva a alteração em detalhes (mínimo 3 caracteres).");
                final = `"${obs}" (Por: ${conf} em ${now})`;
            } 

            window.itemStatus[item.dataset.id]={status:'C/A',obs:final}; 
            item.querySelector('.alteracao-container').style.display='none'; 

            const d=item.querySelector('.descricao-salva'); 
            d.innerHTML=gerarHtmlVisual(final, conf, now, null, null); 
            d.style.display='block'; 
            salvarRascunho(); 

            updateSetorStatus(btn.closest('.setor')); 
            updateOverallStatus(); 
            checkSetorCompletion(btn.closest('.setor'), item.dataset.id);
        }

        function salvarTombamento(btn) { 
            const tomb=btn.closest('.tombamento-container'); 
            const item=btn.closest('.item-conferencia');
            const obs=tomb.querySelector('textarea').value.trim(); 
            const hist=tomb.querySelector('.historico-fixo'); 
            let final=obs; 

            const conf=`${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
            const now=formatarDataSimples(new Date()); 

            if(hist && hist.dataset.meta) {
                if(obs.length < 3) return alert("Digite a alteração.");
                const meta=JSON.parse(decodeURIComponent(hist.dataset.meta));
                final=montarHistoricoLinear(meta.obs, obs, meta.autor, meta.data);
            } else {
                if(obs.length < 3) return alert("Descreva a alteração em detalhes (mínimo 3 caracteres).");
                final = `"${obs}" (Por: ${conf} em ${now})`;
            } 

            window.itemStatus[`${item.dataset.id}-${tomb.dataset.tomb}`]={status:'C/A',obs:final}; 
            tomb.querySelector('.tombamento-obs-container').style.display='none'; 

            const d=tomb.querySelector('.tombamento-descricao-salva');
            d.innerHTML=gerarHtmlVisual(final, conf, now, null, null); 
            d.style.display='block'; 
            salvarRascunho(); 

            updateItemMainStatusDisplay(item); 
            updateSetorStatus(btn.closest('.setor')); 
            updateOverallStatus(); 
            checkSetorCompletion(btn.closest('.setor'), item.dataset.id);
        }
        
        function restaurarRascunho() {
            const saved = localStorage.getItem(getStorageKey());
            if (!saved) return;
            try {
                const parsed = JSON.parse(saved);
                window.itemStatus = parsed.status; 
                
                // Adaptação da lógica de restauração visual (simplificada para o contexto)
                document.getElementById('loading-message').textContent = "Rascunho recuperado. Carregando UI...";

                Object.keys(window.itemStatus).forEach(uid => {
                    const st = window.itemStatus[uid]; 
                    let container;
                    let isTombamento = uid.includes('-');

                    if (isTombamento) {
                         const parts = uid.split('-');
                         const itemId = parts[0];
                         const tombId = parts[1];
                         const itemContainer = document.querySelector(`.item-conferencia[data-id="${itemId}"]`);
                         container = itemContainer ? itemContainer.querySelector(`.tombamento-container[data-tomb="${tombId}"]`) : null;
                    } else {
                        container = document.querySelector(`.item-conferencia[data-id="${uid}"]`);
                    }

                    if (container) {
                        const btnSA = container.querySelector('.sa-ok'), 
                              btnCA = container.querySelector('.ca-alert');
                        
                        if(btnSA) btnSA.classList.remove('active'); 
                        if(btnCA) btnCA.classList.remove('active');

                        const descEl = container.querySelector('.descricao-salva') || container.querySelector('.tombamento-descricao-salva');
                        
                        if (st.status === 'S/A' || st.status === 'KEEP' || st.status === 'C/A') { 
                            if(btnCA) btnCA.classList.add('active'); 
                            if(descEl && st.obs && st.obs.length > 0) {
                                const conf = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
                                const now = formatarDataSimples(new Date());
                                descEl.innerHTML = gerarHtmlVisual(st.obs, conf, now, null, null); 
                                descEl.style.display = 'block';
                            }
                        }
                        
                        if (isTombamento) {
                            updateItemMainStatusDisplay(container.closest('.item-conferencia'));
                        } else if (st.status === 'S/A') {
                            container.className = 'item-conferencia status-ok'; 
                            container.querySelector('.status-icon').className = 'status-icon ok';
                        } else if (st.status === 'C/A') {
                            container.className = 'item-conferencia status-alert'; 
                            container.querySelector('.status-icon').className = 'status-icon alert';
                        }
                    }
                });
                
                document.querySelectorAll('.setor').forEach(s => updateSetorStatus(s));
                updateOverallStatus();
            } catch (e) { console.error("Erro restore", e); }
        }
        
        function adaptarCautelaParaRender(cautelaData) {
            // Cria um setor único "ITENS CAUTELADOS"
            if (!cautelaData.itens || cautelaData.itens.length === 0) return [];
            
            const setorCautela = {
                id: cautelaData.cautela_id,
                nome: "ITENS CAUTELADOS",
                itens: cautelaData.itens.map(cItem => {
                    return {
                        id: cItem.id_completo || cItem.id_base, 
                        nome: cItem.nome, 
                        quantidadeEsperada: cItem.quantidade,
                        tipo: cItem.tipo, 
                        pendencia: cItem.pendencia || null
                    };
                })
            };
            return [setorCautela]; 
        }

        function renderizarConferencia() {
            const mainContent = document.getElementById('main-content');
            const antigos = mainContent.querySelectorAll('.setor'); antigos.forEach(el => el.remove());
            let htmlSetores = ''; const setorIds = []; dadosConferencia.forEach(s => setorIds.push(s.id));
            window.setorIds = setorIds;

            dadosConferencia.forEach((setor, index) => {
                const isFirstSetor = (index === 0); let htmlItens = ''; let totalItensNoSetor = 0;
                setor.itens.forEach(item => {
                    const montarPendenciaHtml = (uid, pendenciaObj) => {
                        if (!pendenciaObj) return '';
                        const obs = pendenciaObj.obs_conferencia || 'N/D'; 
                        const quem = pendenciaObj.recebedor_conf || 'Anônimo'; 
                        const dataPend = item.data_recebimento ? formatarDataSimples(item.data_recebimento) : '';
                        
                        const dadosHistorico = JSON.stringify({ obs: obs, autor: quem, data: dataPend }); 
                        const safeHistorico = encodeURIComponent(dadosHistorico);
                        
                        const htmlFormatado = `Status anterior: ${pendenciaObj.status_conferencia} ${obs ? `Obs: ${obs}` : ''}`;

                        return `<div class="pendencia-alert-box admin-reply">
                                    <p style="margin: 0; font-weight: bold; color: #2c7399;">Conferência Anterior (${pendenciaObj.status_conferencia}):</p>
                                    <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #555;">${obs}</p>
                                </div>`;
                    };
                    
                    let statusClass = '';
                    let pendenciaHtml = '';
                    
                    if (cautelaDadosCompletos && cautelaDadosCompletos.relatorio_recebimento) {
                         const rel = cautelaDadosCompletos.relatorio_recebimento.find(r => r.id_completo === item.id);
                         if (rel) {
                            pendenciaHtml = montarPendenciaHtml(item.id, rel);
                            statusClass = (rel.status_conferencia === 'C/A' ? 'status-alert' : 'status-ok');
                         }
                    }
                    
                    if (item.tipo === 'multi' && item.tombamentos) {
                        let htmlTombamentos = '';
                        if(item.quantidadeEsperada > 0) {
                            for(let i = 1; i <= item.quantidadeEsperada; i++) {
                                const uid = `${item.id}-${i}`;
                                htmlTombamentos += `<div class="tombamento-container" data-tomb="${i}" data-item-id="${item.id}">
                                                        <div class="tombamento-controls"><span>UNIDADE: ${i}</span>
                                                            <div class="tombamento-options">
                                                                <button class="action-button sa-ok" onclick="setTombamentoStatus(this, 'ok')">S/A</button>
                                                                <button class="action-button ca-alert" onclick="setTombamentoStatus(this, 'alert')">C/A</button>
                                                            </div>
                                                        </div>
                                                        <p class="tombamento-descricao-salva"></p>
                                                        <div class="tombamento-obs-container">
                                                            <label>Descreva a alteração:</label>
                                                            <textarea placeholder="Detalhe a alteração."></textarea>
                                                            <button type="button" class="btn-salvar-alteracao" onclick="salvarTombamento(this)">SALVAR OBSERVAÇÃO</button>
                                                        </div>
                                                    </div>`;
                                totalItensNoSetor++; window.itemStatus[uid] = { status: 'pending', obs: '' };
                            }
                        }
                        
                        htmlItens += `<div class="item-conferencia item-has-tombamentos" data-type="multi" data-total-tombamentos="${item.quantidadeEsperada}" data-status="pending" data-id="${item.id}">
                                            <div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span><span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span></div>
                                            ${pendenciaHtml}
                                            ${htmlTombamentos}
                                      </div>`;

                    } else {
                        // Item Single
                        const pendenciaHtml = montarPendenciaHtml(item.id, item.pendencia);
                        htmlItens += `<div class="item-conferencia ${statusClass}" data-type="single" data-status="pending" data-id="${item.id}">
                                            <div class="item-header"><span class="status-icon"></span><span class="item-label">${item.nome}</span><span class="item-quantidade">QTD: ${item.quantidadeEsperada}</span></div>
                                            <div class="item-options">
                                                <button class="action-button sa-ok" onclick="setItemStatus(this, 'ok')">S/A</button>
                                                <button class="action-button ca-alert" onclick="setItemStatus(this, 'alert')">C/A</button>
                                            </div>
                                            ${pendenciaHtml}
                                            <p class="descricao-salva"></p>
                                            <div class="alteracao-container">
                                                <label>Descreva a alteração:</label>
                                                <textarea data-id="${item.id}" placeholder="Descreva a alteração."></textarea>
                                                <button type="button" class="btn-salvar-alteracao" onclick="salvarItem(this)">SALVAR</button>
                                            </div>
                                      </div>`;
                        totalItensNoSetor++; window.itemStatus[item.id] = { status: 'pending', obs: '' };
                    }
                });
                const expandedClass = (index === 0) ? 'expanded' : ''; const arrowChar = (index === 0) ? '▼' : '►';
                htmlSetores += `<div class="setor" data-total-items="${totalItensNoSetor}" data-id="${setor.id}"><div class="setor-header" onclick="toggleSetor(this)"><div class="setor-info"><span>${setor.nome}</span><div class="setor-status" data-completed="0">0/${totalItensNoSetor}</div></div><span class="arrow">${arrowChar}</span></div><div class="setor-content ${expandedClass}">${htmlItens}</div></div>`;
            });
            mainContent.querySelector('#btn-finalizar').insertAdjacentHTML('beforebegin', htmlSetores);
            updateOverallStatus();
        }

        // --- FUNÇÃO DEDICADA DE GERAÇÃO DE PDF (PASSO 5) ---
        
        /**
         * Gera o PDF de Cautela com o mesmo layout da Conferência.
         */
        function imprimirPDF_Cautela(cautelaData) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const MARGIN = 14, PG_W = 210, LOGO_S = 15;
                
                const emitente = cautelaData.emitente;
                const destinatario = cautelaData.destinatario;
                const cautelaId = cautelaData.cautela_id;
                const dataTimestamp = cautelaData.data_recebimento ? cautelaData.data_recebimento.toDate() : cautelaData.timestamp_emissao.toDate();
                const dataHora = dataTimestamp.toLocaleString('pt-BR');
                const localOrigem = cautelaData.local_origem;
                const itensRelatorio = cautelaData.relatorio_recebimento || cautelaData.itens;
                
                const logoDraw = (domId, x) => { /* ... */ };

                // --- 1. CABEÇALHO ---
                // logoDraw('cbmrr.png', MARGIN);
                // logoDraw('logo_sigma.png', PG_W - MARGIN - LOGO_S);
                
                doc.setFontSize(10);
                doc.setTextColor(51); 
                doc.setFont('helvetica','bold');
                doc.text('GOVERNO DE RORAIMA', PG_W/2, 15, {align:'center'}); 
                doc.setTextColor(217,15,35);
                doc.text('CORPO DE BOMBEIROS MILITAR DE RORAIMA', PG_W/2, 20, {align:'center'}); 
                doc.setTextColor(51); 
                doc.setFont('helvetica','italic');
                doc.text('"Amazônia: patrimônio dos brasileiros"', PG_W/2, 25, {align:'center'});
                
                // TÍTULO ADAPTADO
                doc.setFontSize(14); 
                doc.setTextColor(0);
                doc.setFont('helvetica','bold'); 
                doc.text(`TERMO DE CAUTELA: ${cautelaId}`, PG_W/2, 35, {align:'center'}); // Título único
                

                // --- 2. INFORMAÇÕES DE BASE ---
                doc.setFillColor(240, 240, 240);
                doc.setDrawColor(200, 200, 200); 
                doc.roundedRect(MARGIN, 40, PG_W - (MARGIN*2), 30, 2, 2, 'FD'); 
                
                doc.setFontSize(10); 
                doc.setTextColor(50);
                let y = 46;
                const X_LABEL = MARGIN + 5; 
                const X_VAL = MARGIN + 40; 
                
                doc.setFont('helvetica','bold'); doc.text('Local Origem:', X_LABEL, y); doc.setFont('helvetica','normal'); doc.text(localOrigem || 'N/D', X_VAL, y); y+=6; 
                
                doc.setFont('helvetica','bold'); doc.text('Emitente:', X_LABEL, y); doc.setFont('helvetica','normal'); doc.text(emitente || 'N/D', X_VAL, y); y+=6; 
                
                doc.setFont('helvetica','bold'); doc.text('Destinatário:', X_LABEL, y); doc.setFont('helvetica','normal'); doc.text(destinatario || 'N/D', X_VAL, y); y+=6; 

                doc.setFont('helvetica','bold'); doc.text('Data/Hora Conf.:', X_LABEL, y); doc.setFont('helvetica','normal'); doc.text(dataHora, X_VAL, y); 
                
                // TOTALIZADOR 
                const totalCaa = itensRelatorio.filter(i => i.status_conferencia === 'C/A').length;
                doc.setFont('helvetica','bold');
                doc.setTextColor(128, 0, 32);
                doc.text(`ITENS CAUTELADOS: ${itensRelatorio.length} | C/A: ${totalCaa}`, PG_W - MARGIN - 5, 46, {align:'right'});


                // --- 3. TABELA DE ITENS (PADRÃO CONFERÊNCIA) ---
                let tableBody = [];
                const RED_FILL = [217, 15, 35]; 
                const GREEN_FILL = [27, 138, 62]; 
                const SECTOR_BG = [60, 60, 60];
                
                tableBody.push([{ content: 'MATERIAIS CAUTELADOS', colSpan: 4, styles: { fillColor: SECTOR_BG, textColor: 255, fontStyle: 'bold', halign: 'left' } 
                }]);
                
                itensRelatorio.forEach(item => {
                    let finalObs = item.obs_conferencia || '-';
                    let bgStatus = (item.status_conferencia === 'C/A') ? RED_FILL : GREEN_FILL;
                    let statusText = (item.status_conferencia === 'C/A') ? 'C/A' : 'S/A';

                    tableBody.push([ 
                        item.nomeCompleto || item.id_completo, 
                        { content: `QTD: ${item.quantidade || 1}`, styles: { halign: 'center', valign: 'middle' } }, 
                        { content: statusText, styles: { fillColor: bgStatus, textColor: 255, fontStyle: 'bold', halign: 'center', valign: 'middle' } }, 
                        { content: finalObs, styles: { halign: 'left', valign: 'middle' } } 
                    ]);
                });
                
                doc.autoTable({ 
                    startY: 75, 
                    head: [['Item', 'Quantidade', 'Status', 'Observação']], 
                    body: tableBody, 
                    theme: 'striped', 
                    styles: { fontSize: 8, valign: 'middle', textColor: 51, cellPadding: 1.5 }, 
                    columnStyles: { 
                        0:{cellWidth:80, halign:'left'}, 
                        1:{cellWidth:20,halign:'center'}, 
                        2:{cellWidth:20,halign:'center'}, 
                        3:{cellWidth:'auto',halign:'left'} 
                    }, 
                    headStyles: { fillColor: [128, 0, 32], textColor: 255, fontStyle: 'bold', halign: 'center' } 
                });

                // Rodapé
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8); 
                    doc.setTextColor(100);
                    doc.text('SIGMA - Sistema Integrado de Gestão de Materiais', MARGIN, doc.internal.pageSize.height-10);
                    doc.text(`Pág. ${i} de ${totalPages}`, PG_W-MARGIN, doc.internal.pageSize.height-10, {align:'right'});
                }
                
                const nomeArquivo = `Cautela_Termo_${cautelaId}.pdf`;
                doc.save(nomeArquivo);
                
            } catch(e) { 
                console.error("Erro ao gerar PDF da Cautela:", e);
                alert("Erro ao gerar PDF: " + e.message);
            }
        }

        async function carregarDadosCautela() {
            if (!CAUTELA_ID) { 
                document.getElementById('loading-message').innerHTML = "<span style='color:red'>Erro: ID da Cautela não encontrado.</span>";
                return;
            }
                
            document.getElementById('loading-message').textContent = `Conectando à Cautela ${CAUTELA_ID}...`;
            try {
                // Tenta buscar na coleção Ativa e depois na Histórico (para PDF/Histórico)
                const COLECAO_ALVO = (VIEW_TYPE === 'pdf' || VIEW_TYPE === 'devolucao') ? COLECAO_CAUTELAS : COLECAO_CAUTELAS;
                let doc = await db.collection(COLECAO_ALVO).doc(CAUTELA_ID).get();
                
                if (!doc.exists) {
                    doc = await db.collection(COLECAO_CAUTELAS_HIST).doc(CAUTELA_ID).get();
                }
                
                if (!doc.exists) throw new Error("Cautela Ativa não encontrada.");
                
                cautelaDadosCompletos = doc.data(); // Salva os dados completos
                const data = cautelaDadosCompletos;

                // 1. Adapta os dados para a estrutura de conferência
                dadosConferencia = adaptarCautelaParaRender(data);
                
                // 2. Atualiza Info do Título
                let nomeLocal, postoLocal, tipoInfo;

                if (VIEW_TYPE === 'devolucao') {
                    nomeLocal = `DEVOLUÇÃO: CAUTELA ${CAUTELA_ID}`;
                    postoLocal = `Emitente: ${data.destinatario} | Destino: ${data.local_origem}`;
                    tipoInfo = 'Você está conferindo os itens para DEVOLUÇÃO/ENCERRAMENTO ou TRANSFERÊNCIA da cautela.';
                    document.getElementById('btn-finalizar').onclick = finalizarDevolucaoTransferencia;
                } else {
                    nomeLocal = `RECEBIMENTO: CAUTELA ${CAUTELA_ID}`;
                    postoLocal = `Emitente: ${data.emitente} | Destinatário: ${data.destinatario}`;
                    tipoInfo = 'A conferência atual registra o recebimento dos materiais da CAUTELA.';
                    document.getElementById('btn-finalizar').onclick = finalizarRecebimentoCautela;
                }
                
                document.getElementById('local-posto-info').innerHTML = `<span style="color:#2c7399;font-weight:bold">${postoLocal}</span>`;
                document.getElementById('titulo-conferencia').textContent = nomeLocal;
                document.getElementById('tipo-fluxo-info').textContent = tipoInfo;
                document.title = nomeLocal;


                // 3. Renderiza e inicializa
                document.getElementById('loading-message').textContent = "Renderizando materiais...";
                renderizarConferencia(); 
                restaurarRascunho(); 
                updateHeaderInfo(); 
                updateOverallStatus();
                
                document.getElementById('loading-message').style.display='none'; 
                document.getElementById('main-content').style.display='block';
            } catch (e) { 
                document.getElementById('loading-message').innerHTML = "Erro: " + e.message;
            }
        }

        /**
         * Função principal que executa a transação de Recebimento (Ativação da Cautela).
         */
        async function finalizarRecebimentoCautela() {
            const btn = document.getElementById('btn-finalizar');
            btn.disabled = true;
            btn.textContent = 'Executando Transação...';
            
            const relatorioRecebimento = [];
            const recebedor = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
            
            // Lógica de coleta de relatorioRecebimento
            for (const setor of dadosConferencia) {
                for (const itemOriginal of setor.itens) {
                    
                    const processItem = (itemData) => {
                        const uid = itemData.id;
                        const statusFinal = window.itemStatus[uid] ? window.itemStatus[uid].status : 'pending';
                        
                        if (statusFinal === 'pending') return;

                        const finalObs = window.itemStatus[uid].obs || null;
                        const finalStatus = (statusFinal === 'KEEP' ? 'C/A' : statusFinal);
                        
                        relatorioRecebimento.push({
                            id_completo: uid,
                            nomeCompleto: itemData.nome,
                            quantidade: itemData.quantidadeEsperada || 1,
                            status_conferencia: finalStatus,
                            obs_conferencia: finalObs,
                            tipo: itemData.tipo,
                        });
                    };
                    processItem(itemOriginal);
                }
            }


            // 2. Execução da Transação no Firestore
            try {
                let cautelaDataSnapshot = null;
                
                await db.runTransaction(async (transaction) => {
                    
                    // --- A. REFERÊNCIAS E LEITURAS ---
                    const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
                    const cautelaDoc = await transaction.get(cautelaRef);
                    if (!cautelaDoc.exists) throw new Error("Cautela não encontrada na coleção ativa.");
                    
                    const dadosOriginaisCautela = cautelaDoc.data();
                    const listaMestraId = dadosOriginaisCautela.local_origem_id;
                    const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaMestraId); 
                    const listaMestraDoc = await transaction.get(listaMestraRef);
                    
                    if (!listaMestraDoc.exists) throw new Error("Lista Mestra de origem não encontrada.");
                    let listaMestraData = listaMestraDoc.data().list;
                    
                    // --- B. LÓGICA DA TRANSAÇÃO (ATUALIZAÇÃO DE CARIMBO NA LISTA MESTRA) ---
                    listaMestraData = listaMestraData.map(setor => ({
                        ...setor,
                        itens: setor.itens.map(mItem => {
                             relatorioRecebimento.forEach(relItem => {
                                 if (relItem.id_completo.includes(mItem.id_base || mItem.id)) {
                                    
                                     if (mItem.tipo === 'multi' && mItem.tombamentos) {
                                         mItem.tombamentos = mItem.tombamentos.map(tomb => {
                                             if (tomb.cautela && tomb.cautela.id === CAUTELA_ID) {
                                                tomb.cautela.status_conf = relItem.status_conferencia;
                                                tomb.cautela.data_ativacao = firebase.firestore.FieldValue.serverTimestamp();
                                             }
                                             return tomb;
                                         });

                                     } else if (mItem.tipo === 'single') {
                                         mItem.cautelas = mItem.cautelas.map(c => {
                                             if (c.id === CAUTELA_ID) {
                                                c.status_conf = relItem.status_conferencia;
                                                c.data_ativacao = firebase.firestore.FieldValue.serverTimestamp();
                                             }
                                             return c;
                                         });
                                     }
                                 }
                                 return mItem;
                             })
                            return mItem;
                        })
                    }));
                    

                    // 2. Marcar a cautela como ATIVA e registrar o relatório
                    const updateData = { 
                        status: 'ATIVA', 
                        data_recebimento: firebase.firestore.FieldValue.serverTimestamp(),
                        recebedor_conf: recebedor,
                        relatorio_recebimento: relatorioRecebimento, 
                        total_itens_conf: relatorioRecebimento.length,
                        total_ca_conf: relatorioRecebimento.filter(i => i.status_conferencia === 'C/A').length
                    };
                    
                    transaction.update(cautelaRef, updateData);
                    
                    // 3. Atualizar a Lista Mestra (aplicar a marcação de ATIVAÇÃO)
                    transaction.update(listaMestraRef, { list: listaMestraData });
                    
                    cautelaDataSnapshot = { ...dadosOriginaisCautela, ...updateData };

                });
                
                // --- PÓS-TRANSAÇÃO (UI) ---
                limparRascunho(); 
                
                if (cautelaDataSnapshot) { imprimirPDF_Cautela(cautelaDataSnapshot); }

                alert(`✅ Recebimento da Cautela ${CAUTELA_ID} finalizado e ATIVADO com sucesso!`);
                window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

            } catch (error) {
                console.error("Erro na Transação de Recebimento:", error);
                alert(`Erro ao finalizar recebimento. Erro: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'FINALIZAR RECEBIMENTO (Tente Novamente)';
            }
        }

        /**
         * Função que inicia o fluxo de Devolução/Transferência.
         * (PASSO 6 - LÓGICA DE TRANSAÇÃO)
         */
        async function finalizarDevolucaoTransferencia() {
            const btn = document.getElementById('btn-finalizar');
            btn.disabled = true;
            btn.textContent = 'Processando Devolução...';
            
            const recebedorDevolucao = `${userInfo.postoGraduacao} ${userInfo.quadro} ${userInfo.nomeGuerra}`;
            const tipo = DEVOLUCAO_TYPE; // FINALIZADA ou TRANSFERENCIA
            const novoDestinatario = NOVO_DESTINATARIO;
            
            if (tipo === 'TRANSFERENCIA' && !novoDestinatario) {
                alert("Militar de destino não especificado para transferência.");
                btn.disabled = false;
                btn.textContent = 'FINALIZAR DEVOLUÇÃO (Erro)';
                return;
            }
            
            try {
                // A conferência de devolução/transferência é tratada como S/A para devolver o item
                const relatorioDevolucao = dadosConferencia[0].itens.map(item => ({
                     id_completo: item.id,
                     nomeCompleto: item.nome,
                     quantidade: item.quantidadeEsperada || 1,
                     status_conferencia: window.itemStatus[item.id]?.status === 'C/A' ? 'C/A' : 'S/A',
                     obs_conferencia: window.itemStatus[item.id]?.obs || null,
                     tipo: item.tipo,
                }));
                
                let cautelaDataSnapshot = null; 
                
                await db.runTransaction(async (transaction) => {
                    const cautelaRef = db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID);
                    const cautelaDoc = await transaction.get(cautelaRef);

                    if (!cautelaDoc.exists) throw new Error("Cautela não encontrada na coleção ativa.");
                    const dadosOriginaisCautela = cautelaDoc.data();
                    
                    const listaMestraId = dadosOriginaisCautela.local_origem_id;
                    const listaMestraRef = db.collection(COLECAO_LISTAS).doc(listaMestraId);
                    const listaMestraDoc = await transaction.get(listaMestraRef);
                    let listaMestraData = listaMestraDoc.data().list;
                    
                    // --- 1. AJUSTE NA LISTA MESTRA ---
                    
                    listaMestraData = listaMestraData.map(setor => ({
                        ...setor,
                        itens: setor.itens.map(mItem => {
                            dadosOriginaisCautela.itens.forEach(cItem => {
                                if (cItem.id_completo.includes(mItem.id_base || mItem.id)) {
                                    
                                    if (mItem.tipo === 'multi' && mItem.tombamentos) {
                                        // ITEM MULTI
                                        mItem.tombamentos = mItem.tombamentos.map(tomb => {
                                            if (tomb.cautela && tomb.cautela.id === CAUTELA_ID) {
                                                if (tipo === 'FINALIZADA') {
                                                    delete tomb.cautela;
                                                } else if (tipo === 'TRANSFERENCIA') {
                                                    tomb.cautela.destinatario = novoDestinatario;
                                                    tomb.cautela.id_transferencia = CAUTELA_ID;
                                                }
                                            }
                                            return tomb;
                                        });

                                    } else if (mItem.tipo === 'single') {
                                        // ITEM SINGLE
                                        mItem.cautelas = mItem.cautelas.filter(c => {
                                            if (c.id === CAUTELA_ID) {
                                                if (tipo === 'FINALIZADA') {
                                                    mItem.quantidadeEsperada += cItem.quantidade;
                                                    return false; 
                                                } else if (tipo === 'TRANSFERENCIA') {
                                                    c.destinatario = novoDestinatario;
                                                    c.id_transferencia = CAUTELA_ID;
                                                }
                                            }
                                            return true; 
                                        });
                                    }
                                }
                                return mItem;
                            })
                            return mItem;
                        })
                    }));
                    
                    // 2. ATUALIZAÇÃO DO DOCUMENTO CAUTELA
                    if (tipo === 'FINALIZADA') {
                        // Devolução Finalizada: Mover para o Histórico e deletar o ativo
                        const historicoData = { 
                            ...dadosOriginaisCautela, 
                            status: 'DEVOLVIDA',
                            data_devolucao: firebase.firestore.FieldValue.serverTimestamp(),
                            conferente_devolucao: recebedorDevolucao,
                            relatorio_devolucao: relatorioDevolucao
                        };
                        transaction.set(db.collection(COLECAO_CAUTELAS_HIST).doc(CAUTELA_ID), historicoData);
                        transaction.delete(cautelaRef); 
                        cautelaDataSnapshot = historicoData;

                    } else if (tipo === 'TRANSFERENCIA') {
                        // Transferência: Apenas atualiza o destinatário e adiciona o log de transferência
                        const updateTransfer = {
                            destinatario: novoDestinatario,
                            data_transferencia: firebase.firestore.FieldValue.serverTimestamp(),
                            conferente_transferencia: recebedorDevolucao,
                            log_transferencia: firebase.firestore.FieldValue.arrayUnion({
                                de: dadosOriginaisCautela.destinatario,
                                para: novoDestinatario,
                                data: firebase.firestore.FieldValue.serverTimestamp()
                            })
                        };
                        transaction.update(cautelaRef, updateTransfer);
                        cautelaDataSnapshot = { ...dadosOriginaisCautela, ...updateTransfer };
                    }
                    
                    // 3. Atualizar a Lista Mestra
                    transaction.update(listaMestraRef, { list: listaMestraData });
                });
                
                // --- PÓS-TRANSAÇÃO (UI) ---
                limparRascunho(); 
                
                if (cautelaDataSnapshot) {
                     imprimirPDF_Cautela(cautelaDataSnapshot); 
                }

                alert(`✅ Fluxo ${tipo} concluído!`);
                window.parent.postMessage({ type: 'SIGMA_FINISHED' }, '*');

            } catch (error) {
                console.error("Erro na Transação de Devolução:", error);
                alert(`Erro ao finalizar a Devolução/Transferência. Erro: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'FINALIZAR DEVOLUÇÃO (Tente Novamente)';
            }
        }


        // --- LÓGICA DE VISUALIZAÇÃO DO PDF VIA URL ---
        async function checkUrlForPdfView() {
            const loading = document.getElementById('loading-message');
            
            if (VIEW_TYPE === 'pdf' && CAUTELA_ID) {
                loading.textContent = `Carregando dados para impressão da Cautela ${CAUTELA_ID}...`;
                try {
                    // Tenta buscar na coleção Ativa e depois na Histórico
                    let doc = await db.collection(COLECAO_CAUTELAS).doc(CAUTELA_ID).get();
                    if (!doc.exists) {
                         doc = await db.collection(COLECAO_CAUTELAS_HIST).doc(CAUTELA_ID).get();
                    }

                    if (!doc.exists) throw new Error("Cautela não encontrada.");
                    
                    imprimirPDF_Cautela(doc.data());
                    document.getElementById('loading-message').textContent = "PDF gerado. Feche esta janela.";
                    setTimeout(() => window.close(), 3000); 

                } catch (e) {
                    document.getElementById('loading-message').innerHTML = `Erro ao gerar PDF: ${e.message}`;
                }
            
            } else if (VIEW_TYPE === 'devolucao' && CAUTELA_ID) {
                 // --- MODO DEVOLUÇÃO/TRANSFERÊNCIA ---
                 document.getElementById('tipo-fluxo-info').textContent = `Conferência de Devolução/Transferência da Cautela ${CAUTELA_ID}.`;
                 document.getElementById('titulo-conferencia').textContent = "CONFERÊNCIA DE DEVOLUÇÃO";
                 document.getElementById('btn-finalizar').onclick = finalizarDevolucaoTransferencia;
                 
                 carregarDadosCautela(); 
            }
            else {
                // --- MODO RECEBIMENTO (Padrão) ---
                document.getElementById('btn-finalizar').onclick = finalizarRecebimentoCautela;
                carregarDadosCautela();
            }
        }


        // ==========================================
        // INICIALIZAÇÃO
        // ==========================================
        window.onload = checkUrlForPdfView;
    </script>
</body>
</html>
