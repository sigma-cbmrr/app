<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Login</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- ESTILOS GERAIS (Padrão SIGMA) --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f4f9; 
            color: #333; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            box-sizing: border-box; 
        }
        
        /* Header (Igual ao Operacional) */
        .main-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 50px; 
            background-color: #800020; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000; 
            display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; gap: 10px; 
        }
        .header-icon { height: 40px; width: auto; } 
        .header-title-desktop, .header-title-mobile { font-weight: bold; font-size: 1.1em; line-height: 1.2; } 
        .text-white { color: white; } .text-red { color: #FF3B3B; } 
        .header-title-desktop { display: none; } .header-title-mobile { display: block; }

        @media (min-width: 768px) { 
            .header-title-desktop { display: block; font-size: 1.2em; } 
            .header-title-mobile { display: none; } 
        }

        /* Footer (Igual ao Operacional) */
        .footer-central { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            text-align: center; padding: 5px 0 5px; 
            background-color: #f4f4f9; color: #555; 
            font-size: 0.65em; line-height: 1.3; 
            z-index: 100; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); 
        } 
        .footer-central strong, .footer-autor { display: block; width: 100%; text-align: center; } 
        .footer-central strong { font-weight: bold; } 
        .footer-autor { margin-top: 10px; color: #888; font-size: 0.9em; }

        /* --- ESTILOS ESPECÍFICOS DE LOGIN --- */
        .login-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            padding-top: 60px; /* Espaço do header */
            padding-bottom: 60px; /* Espaço do footer */
        }

        .login-card {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            border-top: 5px solid #800020;
        }

        .login-logo {
            width: 100px;
            height: auto;
            margin-bottom: 20px;
        }

        .login-card h2 {
            color: #800020;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .input-group {
            text-align: left;
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 0.9em;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            border-color: #800020;
            outline: none;
            box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #d90f23 0%, #800020 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn-login:hover {
            box-shadow: 0 5px 15px rgba(128, 0, 32, 0.3);
        }

        .btn-login:active {
            transform: scale(0.98);
        }

        .btn-login:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .recover-password {
            display: block;
            margin-top: 20px;
            color: #2c7399;
            text-decoration: none;
            font-size: 0.9em;
        }
        
        .recover-password:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <img src="cbmrr.png" alt="CBM-RR" class="header-icon" onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=CBM'">
        <div class="header-title-desktop"><span class="text-white">CORPO DE BOMBEIROS MILITAR </span><span class="text-red">RORAIMA</span></div>
        <div class="header-title-mobile"><span class="text-white">CBM</span><span class="text-red">RR</span></div>
    </header>

    <div class="login-wrapper">
        <div class="login-card">
            <img src="logo_sigma.png" alt="Logo SIGMA" class="login-logo" onerror="this.onerror=null; this.src='https://placehold.co/100x100/800020/ffffff?text=S'">
            <h2>Bem-vindo ao SIGMA</h2>
            <p>Sistema Integrado de Gestão de Materiais</p>

            <div class="input-group">
                <label for="email">Email Institucional</label>
                <input type="email" id="email" placeholder="exemplo@cbm.rr.gov.br" onkeydown="if(event.key === 'Enter') document.getElementById('password').focus()">
            </div>

            <div class="input-group">
                <label for="password">Senha</label>
                <input type="password" id="password" placeholder="Sua senha" onkeydown="if(event.key === 'Enter') login()">
            </div>

            <button id="btn-login" class="btn-login" onclick="login()">ENTRAR NO SISTEMA</button>
            
            </div>
    </div>

    <div class="footer-central"><strong>GOVERNO DE RORAIMA</strong><strong>CORPO DE BOMBEIROS MILITAR DE RORAIMA</strong><em>“Amazônia: patrimônio dos brasileiros”</em><br><span class="footer-autor">Elaborado por: 3º SGT QPCBM JHONATH</span></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // LÓGICA DE LOGIN COM VERIFICAÇÃO DE PERFIL
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');

            if (!email || !password) {
                alert("Por favor, preencha todos os campos.");
                return;
            }

            btn.textContent = "Verificando...";
            btn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    // Login Auth deu certo, agora verificamos o PERFIL no banco
                    const uid = userCredential.user.uid;
                    
                    try {
                        const doc = await db.collection('usuarios').doc(uid).get();
                        
                        if (doc.exists) {
                            const dados = doc.data();
                            const role = dados.role;

                            if (role === 'admin' || role === 'gestor') {
                                // Se for Admin ou Gestor -> Vai pro Dashboard
                                window.location.href = "sigma_dashboard.html";
                            } else {
                                // Se for Operacional ou qualquer outra coisa -> Vai pro Operacional
                                window.location.href = "operacional.html";
                            }
                        } else {
                            // Usuário existe no Auth mas não no Banco (Erro de cadastro)
                            console.error("UID não encontrado no Firestore:", uid);
                            alert("Erro: Seu usuário não possui perfil cadastrado no banco de dados. Contate o administrador.");
                            btn.textContent = "ENTRAR NO SISTEMA";
                            btn.disabled = false;
                            auth.signOut(); // Desloga do Auth para não ficar preso
                        }
                    } catch (error) {
                        console.error("Erro ao buscar perfil:", error);
                        alert("Erro de conexão ao verificar perfil. Verifique sua internet.");
                        btn.textContent = "ENTRAR NO SISTEMA";
                        btn.disabled = false;
                    }
                })
                .catch((error) => {
                    btn.textContent = "ENTRAR NO SISTEMA";
                    btn.disabled = false;
                    
                    let msg = "Erro ao fazer login.";
                    if (error.code === 'auth/wrong-password') msg = "Senha incorreta.";
                    if (error.code === 'auth/user-not-found') msg = "Usuário não encontrado.";
                    if (error.code === 'auth/invalid-email') msg = "Email inválido.";
                    
                    alert(msg);
                    console.error(error);
                });
        }
    </script>
</body>
</html>
