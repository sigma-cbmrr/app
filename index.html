<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Acesso</title>

<meta name="description" content="Sistema Integrado de Gestão de Materiais - Login e Acesso.">

<meta property="og:title" content="SIGMA - Login e Acesso">
<meta property="og:description" content="Sistema Integrado de Gestão de Materiais do CBM-RR.">
<meta property="og:url" content="https://sigma-cbmrr.github.io/app">
<meta property="og:type" content="website">
<meta property="og:image" content="https://sigma-cbmrr.github.io/app/logo_sigma.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="SIGMA - CBM-RR">
<meta name="twitter:description" content="Sistema Integrado de Gestão de Materiais do Corpo de Bombeiros Militar de Roraima.">
<meta name="twitter:image" content="https://sigma-cbmrr.github.io/app/logo_sigma.png">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
    body { font-family: 'Inter', 'Segoe UI', sans-serif; background: linear-gradient(135deg, #800020 0%, #2c3e50 100%); margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; display: flex !important; align-items: center !important; justify-content: center !important; }
    .main-header { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background-color: rgba(128, 0, 32, 0.95); backdrop-filter: blur(10px); box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3); z-index: 1000; display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .header-icon { height: 35px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
    .header-title-desktop, .header-title-mobile { font-weight: 800; font-size: 1.1em; line-height: 1.2; letter-spacing: -0.5px; }
    .text-white { color: #ffffff; } .text-red { color: #ff4d4d; }
    .header-title-desktop { display: none; } .header-title-mobile { display: block; }
    .v3-footer-minimal { position: fixed !important; bottom: 20px; right: 30px; text-align: right; color: rgba(255, 255, 255, 0.7); font-size: 0.7em; z-index: 5; pointer-events: none; }
    .v3-footer-minimal strong { color: #ffffff; display: block; letter-spacing: 1px; }
    @media (min-width: 768px) { .header-title-desktop { display: block; font-size: 1.25em; } .header-title-mobile { display: none; } }
    @media (max-width: 767px) { body { height: 100vh !important; width: 100vw !important; overflow: hidden !important; position: fixed; } .main-wrapper { padding: 15px !important; height: 100% !important; align-items: center !important; } .card-box { max-height: 85vh !important; overflow-y: auto !important; padding: 25px 20px !important; } .card-box::-webkit-scrollbar { width: 0; background: transparent; } .header-title-mobile { display: block; font-size: 1.1em; } .header-title-desktop { display: none; } .login-footer { bottom: 10px !important; font-size: 0.6em !important; } .v3-footer-minimal { bottom: 15px !important; right: 0 !important; width: 100% !important; text-align: center !important; color: rgba(255, 255, 255, 0.5) !important; font-size: 0.6em !important; } .v3-footer-minimal strong { color: rgba(255, 255, 255, 0.8) !important; } }
.footer-central { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 8px 0; background-color: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px); color: rgba(255,255,255,0.6); font-size: 0.65em; line-height: 1.4; z-index: 100; border-top: 1px solid rgba(255,255,255,0.1); }
.footer-central strong { font-weight: 700; color: #fff; display: block; } .footer-autor { margin-top: 4px; color: rgba(255,255,255,0.4); font-size: 0.9em; display: block; }
.card-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); padding: 40px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); width: 100%; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.main-wrapper { display: flex !important; align-items: center !important; justify-content: center !important; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; }
        .logo-img { width: 90px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 5px 15px rgba(128, 0, 32, 0.2)); }
.card-title { color: #1e293b; margin-bottom: 8px; font-size: 1.6em; font-weight: 800; letter-spacing: -1px; }
.card-subtitle { color: #64748b; margin-bottom: 30px; font-size: 0.95em; font-weight: 500; }
.input-group { text-align: left; margin-bottom: 20px; }
.input-group label { display: block; margin-bottom: 8px; color: #475569; font-weight: 700; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; }
.input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1em; box-sizing: border-box; transition: all 0.3s ease; background: #f8fafc; color: #1e293b; font-weight: 500; }
.input-group input:focus, .input-group select:focus { border-color: #800020; outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(128, 0, 32, 0.1); }
.input-group small { font-size: 0.75em; color: #94a3b8; margin-top: 6px; font-weight: 500; }
.btn-login { width: 100%; padding: 16px; background: linear-gradient(135deg, #800020 0%, #a00030 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 800; cursor: pointer; transition: all 0.3s; margin-top: 10px; letter-spacing: 1px; box-shadow: 0 10px 15px -3px rgba(128, 0, 32, 0.3); }
.btn-login:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(128, 0, 32, 0.4); background: linear-gradient(135deg, #a00030 0%, #c00040 100%); }
.btn-login:active { transform: scale(0.98); }
.btn-login:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; transform: none; }
.btn-google { width: 100%; padding: 12px; background-color: #ffffff; color: #475569; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1em; font-weight: 700; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
.btn-google:hover { background-color: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
.btn-google img { width: 20px; height: 20px; }
.separator { display: flex; align-items: center; text-align: center; margin: 25px 0; color: #94a3b8; font-size: 0.8em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.separator::before, .separator::after { content: ''; flex: 1; border-bottom: 2px solid #f1f5f9; }
.separator:not(:empty)::before { margin-right: 1.5em; } .separator:not(:empty)::after { margin-left: 1.5em; }
#register-card { display: none; border-top: 5px solid #2c7399; }
#register-card h2 { color: #2c7399; font-weight: 900; }
#app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; transition: opacity 0.5s ease; }
.loader-logo { width: 120px; height: 120px; margin-bottom: 20px; animation: pulse 2s infinite; }
.loader-title { font-size: 3em; font-weight: 900; color: #800020; margin: 0; letter-spacing: -2px; }
.loader-subtitle { font-size: 1.1em; color: #64748b; margin-top: 5px; margin-bottom: 30px; font-weight: 600; }
.loader-spinner { font-size: 2em; color: #800020; }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div id="app-loader">
    <div class="loader-content">
        <img src="logo_sigma.png" alt="Logo SIGMA" class="loader-logo" onerror="this.src='https://placehold.co/120x120/800020/ffffff?text=S'">
        <h1 class="loader-title">SIGMA</h1>
        <p class="loader-subtitle">Sistema Integrado de Gestão de Materiais</p>
        <div class="loader-spinner-container">
            <i class="fas fa-circle-notch fa-spin loader-spinner"></i>
        </div>
    </div>
</div>

<div id="auth-content-wrapper" style="display: none;">
    <div class="main-wrapper">
        
        <div id="login-card" class="card-box">
            <div class="card-header-v3">
                <img src="logo_sigma.png" alt="Logo SIGMA" class="logo-img" onerror="this.src='https://placehold.co/100x100/800020/ffffff?text=S'">
                <h2 class="card-title">SIGMA</h2>
                <p class="card-subtitle">Identifique-se para continuar</p>
            </div>

            <div class="input-group">
                <label for="cpf-login"><i class="fas fa-id-card"></i> CPF</label>
                <input type="text" id="cpf-login" placeholder="000.000.000-00" maxlength="14">
            </div>
    
            <div class="input-group">
                <label for="password"><i class="fas fa-lock"></i> Senha</label>
                <input type="password" id="password" placeholder="Sua senha de acesso" onkeydown="if(event.key === 'Enter') loginEmail()">
            </div>

            <button id="btn-login" class="btn-login" onclick="loginEmail()">ENTRAR NO SISTEMA</button>
            
            <div class="separator">OU ACESSE COM</div>

            <button id="btn-google" class="btn-google" onclick="loginGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Login via Google
            </button>
        </div>

        <div id="register-card" class="card-box" style="max-width: 500px;">
            <div class="card-header-v3">
                <img src="logo_sigma.png" alt="Logo SIGMA" class="logo-img">
                <h2>Primeiro Acesso</h2>
                <p class="card-subtitle">Complete seu perfil militar para liberação</p>
            </div>

            <div class="form-grid-v3">
                <div class="input-group">
                    <label>CPF</label>
                    <input type="text" id="reg-cpf" placeholder="000.000.000-00" maxlength="14">
                </div>

                <div class="input-group">
                    <label>Matrícula</label>
                    <input type="text" id="reg-matricula" placeholder="0000000-0" maxlength="11">
                </div>

                <div class="input-group full-width">
                    <label>Nome Completo</label>
                    <input type="text" id="reg-nome-completo" placeholder="NOME CIVIL COMPLETO" oninput="this.value = this.value.toUpperCase()">
                </div>

                <div class="input-group">
                    <label>Telefone (WhatsApp)</label>
                    <input type="text" id="reg-telefone" placeholder="(95) 90000-0000" maxlength="15">
                </div>

                <div class="input-group">
                    <label>Posto / Graduação</label>
                    <select id="reg-posto">
                        <option value="" disabled selected>Selecione...</option>
                        <option value="CEL">CEL</option><option value="TEN CEL">TEN CEL</option>
                        <option value="MAJ">MAJ</option><option value="CAP">CAP</option>
                        <option value="1º TEN">1º TEN</option><option value="2º TEN">2º TEN</option>
                        <option value="ST">ST</option><option value="1º SGT">1º SGT</option>
                        <option value="2º SGT">2º SGT</option><option value="3º SGT">3º SGT</option>
                        <option value="CB">CB</option><option value="SD">SD</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Quadro</label>
                    <select id="reg-quadro" disabled>
                        <option value="" selected>Defina o Posto</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Nome de Guerra</label>
                    <input type="text" id="reg-nome-guerra" placeholder="EX: JHONATH" oninput="this.value = this.value.toUpperCase()">
                </div>
            </div>

            <button id="btn-register" class="btn-login" onclick="salvarNovoUsuario()">CONCLUIR CADASTRO</button>
        </div>

    </div>

    <footer class="v3-footer-minimal">
        <p><strong>SIGMA</strong> - Sistema Integrado de Gestão de Materiais</p>
        <span>Versão 3.0 • 2026</span>
    </footer>
</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        
        auth.onAuthStateChanged(function(user) {
            const loader = document.getElementById('app-loader');
            const authWrapper = document.getElementById('auth-content-wrapper');
            const MINIMUM_LOAD_TIME = 2000;

           function hideLoader() {
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => { 
                        loader.style.display = 'none'; 
                        // Mostra o conteúdo com fade-in
                        if (authWrapper && !user) {
                            authWrapper.style.display = 'block';
                            authWrapper.style.opacity = '0';
                            setTimeout(() => authWrapper.style.opacity = '1', 50);
                        }
                    }, 500);
                }
            }

            if (user) {
                // Se logado, verifica redirecionamento antes de tirar o loader
                verificarRedirecionamento(user);
            } else {
                 hideLoader();
            }
        });
        const db = firebase.firestore();

        // Variáveis temporárias para cadastro
        let tempUid = null;
        let tempEmail = null;
        let tempPhoto = null;

        // --- 1. LÓGICA DE LOGIN ---
        
        function verificarRedirecionamento(user) {
            const uid = user.uid;
            db.collection('usuarios').doc(uid).get().then((doc) => {
                if (doc.exists) {
                    window.location.href = "/app/sigma_dashboard.html";
                } else {
                    // Se for novo, prepara a tela de registro e aí sim remove o loader
                    iniciarCadastro(user);
                    const loader = document.getElementById('app-loader');
                    if (loader) loader.style.display = 'none';
                    document.getElementById('auth-content-wrapper').style.display = 'block';
                }
            }).catch((error) => {
                console.error("Erro na verificação:", error);
                alert("Falha na comunicação com o servidor.");
                resetBotoes();
            });
        }

        function iniciarCadastro(user) {
            tempUid = user.uid;
            tempEmail = user.email;
            tempPhoto = user.photoURL || "";

            const loginCard = document.getElementById('login-card');
            const registerCard = document.getElementById('register-card');

            loginCard.style.display = 'none';
            registerCard.style.display = 'block';
            // Aplica a animação novamente ao trocar de card
            registerCard.style.animation = 'none';
            registerCard.offsetHeight; /* trigger reflow */
            registerCard.style.animation = null;
        }

        // --- 2. LOGIC DE CADASTRO ---

        function atualizarQuadro() {
            const posto = document.getElementById('reg-posto').value;
            const quadroSelect = document.getElementById('reg-quadro');
    
            quadroSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            quadroSelect.disabled = false;

            const oficiais = ['CEL', 'TEN CEL', 'MAJ', 'CAP', '1º TEN', '2º TEN'];
            const pracas = ['ST', '1º SGT', '2º SGT', '3º SGT', 'CB']; 

            let opcoes = [];
            if (oficiais.includes(posto)) {
                opcoes = ['QOCBM', 'QCOBM', 'QOSBM', 'QEOBM'];
            } else if (pracas.includes(posto)) {
                opcoes = ['QPCBM', 'QPSBM', 'QEPBM'];
            } else if (posto === 'SD') {
                opcoes = ['QPCBM'];
                quadroSelect.disabled = true;
            }

            opcoes.forEach(q => quadroSelect.add(new Option(q, q)));
            if(opcoes.length === 1) quadroSelect.value = opcoes[0];
        }
        
        function salvarNovoUsuario() {
            const cpfRaw = document.getElementById('reg-cpf').value.replace(/\D/g, '');
            const matriculaRaw = document.getElementById('reg-matricula').value.replace(/\D/g, '');
            const nomeCompleto = document.getElementById('reg-nome-completo').value.trim().toUpperCase();
            const telefoneRaw = document.getElementById('reg-telefone').value.replace(/\D/g, '');
            const posto = document.getElementById('reg-posto').value;
            const quadro = document.getElementById('reg-quadro').value;
            const nomeGuerra = document.getElementById('reg-nome-guerra').value.trim().toUpperCase();

            if (cpfRaw.length !== 11 || !nomeCompleto || telefoneRaw.length !== 11 || !posto || !quadro || !nomeGuerra) {
                 return alert("Por favor, preencha todos os campos obrigatórios corretamente.");
            }

            const btn = document.getElementById('btn-register');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> FINALIZANDO...';
            btn.disabled = true;

            const nomeMilitarCompleto = `${posto} ${quadro} ${nomeGuerra}`;

            db.collection('usuarios').doc(tempUid).set({
                uid: tempUid,
                email: tempEmail,
                foto_url: tempPhoto,
                cpf: cpfRaw,
                matricula: matriculaRaw,
                nome_completo: nomeCompleto, 
                telefone_contato: telefoneRaw,
                nome_guerra: nomeGuerra,
                posto: posto,
                quadro: quadro,
                nome_militar_completo: nomeMilitarCompleto,
                role: 'operacional', 
                unidade_id: 'NAO_ALOCADO', // Padrão V3 para novos usuários
                unidade: 'AGUARDANDO UNIDADE',
                criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                versao_app: '3.0'
            })
            .then(() => {
                window.location.href = "/app/sigma_dashboard.html"; 
            })
            .catch((error) => {
                alert("Erro ao salvar: " + error.message);
                btn.innerHTML = 'CONCLUIR CADASTRO';
                btn.disabled = false;
            });
        }
        // --- 3. HANDLERS DE BOTÕES ---

        function resetBotoes() {
            document.getElementById('btn-login').textContent = "ENTRAR";
            document.getElementById('btn-login').disabled = false;
            document.getElementById('btn-google').style.opacity = "1";
            document.getElementById('btn-google').disabled = false;
        }

        function loginEmail() {
            const cpfRaw = document.getElementById('cpf-login').value.replace(/\D/g, ''); 
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');

            if (cpfRaw.length !== 11 || !password) return alert("Informe CPF e Senha.");

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AUTENTICANDO...';
            btn.disabled = true;

            const emailTecnico = `${cpfRaw}@sigma.com.br`;

            auth.signInWithEmailAndPassword(emailTecnico, password)
                .then((userCredential) => {
                    verificarRedirecionamento(userCredential.user);
                })
                .catch((error) => {
                    resetBotoes();
                    alert("Acesso negado. Verifique suas credenciais.");
                });
        }

        function resetBotoes() {
            const btn = document.getElementById('btn-login');
            btn.innerHTML = 'ENTRAR NO SISTEMA';
            btn.disabled = false;
            document.getElementById('btn-google').disabled = false;
        }

        function loginGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            const btnG = document.getElementById('btn-google');
    
            btnG.style.opacity = "0.7";
            document.getElementById('btn-login').disabled = true;
    
            // 1. Executar o login DIRETAMENTE
            auth.signInWithPopup(provider) // REMOVEMOS auth.setPersistence e o .then()
                .then((result) => {
                    // O processo de login foi bem-sucedido
                    verificarRedirecionamento(result.user);
                })
                .catch((error) => {
                    console.error(error);
                    alert("Erro ao entrar com Google: " + error.message);
                    resetBotoes();
                });
        }
        function formatarCPF(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
            value = value.substring(0, 11); // Limita a 11 dígitos

            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
            } else if (value.length > 0) {
                value = value.replace(/^(\d{3})$/, '$1');
            }
            input.value = value;
        }

        function formatarMatricula(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
            value = value.substring(0, 10); // Limita a 10 dígitos

            if (value.length > 7) {
                value = value.replace(/^(\d{7})(\d{3})$/, '$1-$2');
            }
            input.value = value;
        }

        // --- ADICIONA LISTENERS APÓS O CARREGAMENTO DO DOM ---
       document.addEventListener('DOMContentLoaded', () => {
    
    // 1. Máscara para o CPF no campo de LOGIN
    const cpfLoginInput = document.getElementById('cpf-login');
    if (cpfLoginInput) {
        cpfLoginInput.addEventListener('input', () => formatarCPF(cpfLoginInput));
    }

    // 2. Máscara para o CPF no campo de REGISTRO (Primeiro Acesso)
    const cpfRegInput = document.getElementById('reg-cpf');
    if (cpfRegInput) {
        cpfRegInput.addEventListener('input', () => formatarCPF(cpfRegInput));
    }

    // 3. Adiciona o listener para a Matrícula
    const matriculaInput = document.getElementById('reg-matricula');
    if (matriculaInput) {
        matriculaInput.addEventListener('input', () => formatarMatricula(matriculaInput));
    }

    // 4. Adiciona o listener para o Telefone
    const telefoneInput = document.getElementById('reg-telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', () => formatarTelefone(telefoneInput));
    }

    // 5. Lógica do seletor de Posto/Quadro
    const postoSelect = document.getElementById('reg-posto');
    if (postoSelect) {
        // CORREÇÃO PARA MOBILE: Usa setTimeout para atrasar a manipulação
        // do DOM e permitir que o menu nativo feche completamente.
        postoSelect.addEventListener('change', () => {
            setTimeout(atualizarQuadro, 100); 
        });
    }
}); // <-- Fecha corretamente o addEventListener e a função anônima.

function formatarTelefone(input) {
    let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
    value = value.substring(0, 11); // Limita a 11 dígitos (DDD + 9 dígitos)

    if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
    } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
    } else if (value.length > 0) {
        value = value.replace(/^(\d{2})$/, '($1)');
    }
    input.value = value;
}
</script>
</body>
</html>
