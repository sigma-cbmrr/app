<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo_sigma.png" onerror="this.onerror=null; this.src='https://placehold.co/16x16/800020/ffffff?text=S'">
    <title>SIGMA - Login</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; display: flex; flex-direction: column; min-height: 100vh; box-sizing: border-box; }
        
        /* Header */
        .main-header { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background-color: #800020; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; gap: 10px; }
        .header-icon { height: 40px; width: auto; } 
        .header-title-desktop, .header-title-mobile { font-weight: bold; font-size: 1.1em; line-height: 1.2; } 
        .text-white { color: white; } .text-red { color: #FF3B3B; } 
        .header-title-desktop { display: none; } .header-title-mobile { display: block; }
        @media (min-width: 768px) { .header-title-desktop { display: block; font-size: 1.2em; } .header-title-mobile { display: none; } }

        /* Footer */
        .footer-central { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 5px 0 5px; background-color: #f4f4f9; color: #555; font-size: 0.65em; line-height: 1.3; z-index: 100; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); } 
        .footer-central strong, .footer-autor { display: block; width: 100%; text-align: center; } .footer-central strong { font-weight: bold; } .footer-autor { margin-top: 10px; color: #888; font-size: 0.9em; }

        /* Login Styles */
        .login-wrapper { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 20px; padding-top: 60px; padding-bottom: 60px; }
        .login-card { background-color: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border-top: 5px solid #800020; }
        .login-logo { width: 100px; height: auto; margin-bottom: 20px; }
        .login-card h2 { color: #800020; margin-bottom: 10px; font-size: 1.5em; }
        .login-card p { color: #666; margin-bottom: 30px; font-size: 0.9em; }
        .input-group { text-align: left; margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; font-size: 0.9em; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; box-sizing: border-box; transition: border-color 0.3s; }
        .input-group input:focus { border-color: #800020; outline: none; box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1); }
        
        .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, #d90f23 0%, #800020 100%); color: white; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 10px; }
        .btn-login:hover { box-shadow: 0 5px 15px rgba(128, 0, 32, 0.3); }
        .btn-login:active { transform: scale(0.98); }
        .btn-login:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* Botão Google */
        .btn-google { width: 100%; padding: 12px; background-color: #fff; color: #757575; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: background 0.2s; }
        .btn-google:hover { background-color: #f5f5f5; border-color: #ccc; }
        .btn-google img { width: 18px; height: 18px; }

        .separator { display: flex; align-items: center; text-align: center; margin: 20px 0; color: #aaa; font-size: 0.85em; }
        .separator::before, .separator::after { content: ''; flex: 1; border-bottom: 1px solid #eee; }
        .separator:not(:empty)::before { margin-right: .5em; }
        .separator:not(:empty)::after { margin-left: .5em; }
    </style>
</head>
<body>

    <header class="main-header">
        <img src="cbmrr.png" alt="CBM-RR" class="header-icon" onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/800020/fff?text=CBM'">
        <div class="header-title-desktop"><span class="text-white">CORPO DE BOMBEIROS MILITAR </span><span class="text-red">RORAIMA</span></div>
        <div class="header-title-mobile"><span class="text-white">CBM</span><span class="text-red">RR</span></div>
    </header>

    <div class="login-wrapper">
        <div class="login-card">
            <img src="logo_sigma.png" alt="Logo SIGMA" class="login-logo" onerror="this.onerror=null; this.src='https://placehold.co/100x100/800020/ffffff?text=S'">
            <h2>Bem-vindo ao SIGMA</h2>
            <p>Sistema Integrado de Gestão de Materiais</p>

            <div class="input-group">
                <label for="email">Email Institucional</label>
                <input type="email" id="email" placeholder="exemplo@cbm.rr.gov.br" onkeydown="if(event.key === 'Enter') document.getElementById('password').focus()">
            </div>

            <div class="input-group">
                <label for="password">Senha</label>
                <input type="password" id="password" placeholder="Sua senha" onkeydown="if(event.key === 'Enter') loginEmail()">
            </div>

            <button id="btn-login" class="btn-login" onclick="loginEmail()">ENTRAR</button>
            
            <div class="separator">OU</div>

            <button id="btn-google" class="btn-google" onclick="loginGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google G">
                Entrar com Google
            </button>
        </div>
    </div>

    <div class="footer-central"><strong>GOVERNO DE RORAIMA</strong><strong>CORPO DE BOMBEIROS MILITAR DE RORAIMA</strong><em>“Amazônia: patrimônio dos brasileiros”</em><br><span class="footer-autor">Elaborado por: 3º SGT QPCBM JHONATH</span></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCB0PH0UgghgsvH0BgPkG4AkKON6xSQ9mc", authDomain: "sigma-cbmrr.firebaseapp.com", projectId: "sigma-cbmrr", storageBucket: "sigma-cbmrr.firebasestorage.app", messagingSenderId: "378026276038", appId: "1:378026276038:web:620dd6ff57501b1a8313c7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- LÓGICA CENTRAL DE VERIFICAÇÃO ---
        async function verificarRedirecionamento(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    const dados = doc.data();
                    const role = dados.role; // ATENÇÃO: Verifique se no Firestore o campo é 'role' ou 'perfil'

                    if (role === 'admin' || role === 'gestor') {
                        window.location.href = "sigma_dashboard.html";
                    } else {
                        window.location.href = "operacional.html";
                    }
                } else {
                    // Usuário autenticado mas sem perfil no banco
                    alert("Erro: Seu usuário não possui cadastro no banco de dados do SIGMA. Contate o Administrador (Sgt Jhonath).");
                    auth.signOut();
                    resetBotoes();
                }
            } catch (error) {
                console.error("Erro ao buscar perfil:", error);
                alert("Erro de conexão ao verificar perfil.");
                resetBotoes();
            }
        }

        function resetBotoes() {
            document.getElementById('btn-login').textContent = "ENTRAR";
            document.getElementById('btn-login').disabled = false;
            document.getElementById('btn-google').disabled = false;
        }

        // --- LOGIN EMAIL/SENHA ---
        function loginEmail() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');

            if (!email || !password) return alert("Preencha todos os campos.");

            btn.textContent = "Verificando...";
            btn.disabled = true;
            document.getElementById('btn-google').disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    verificarRedirecionamento(userCredential.user.uid);
                })
                .catch((error) => {
                    resetBotoes();
                    let msg = "Erro ao fazer login.";
                    if (error.code === 'auth/wrong-password') msg = "Senha incorreta.";
                    if (error.code === 'auth/user-not-found') msg = "Usuário não encontrado.";
                    alert(msg);
                });
        }

        // --- LOGIN GOOGLE ---
        function loginGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            const btnG = document.getElementById('btn-google');
            
            btnG.style.opacity = "0.7";
            document.getElementById('btn-login').disabled = true;

            auth.signInWithPopup(provider)
                .then((result) => {
                    verificarRedirecionamento(result.user.uid);
                })
                .catch((error) => {
                    console.error(error);
                    alert("Erro ao entrar com Google: " + error.message);
                    resetBotoes();
                    btnG.style.opacity = "1";
                });
        }
    </script>
</body>
</html>
